<!-- Fed Monitor Widget Component (Modern Light Theme) -->
<link
  href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Noto+Sans+KR:wght@400;500;700&display=swap"
  rel="stylesheet">
<style>
  .fed-monitor-container {
    background: #ffffff;
    border: 1px solid #e2e8f0;
    border-radius: 16px;
    padding: 20px 24px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
    overflow: visible;
    position: relative;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: 'Noto Sans KR', sans-serif;
  }

  .fed-monitor-container:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025);
    border-color: #cbd5e1;
  }

  .fed-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
    border-bottom: 1px solid #f1f5f9;
    padding-bottom: 12px;
  }

  .fed-title {
    font-size: 16px;
    font-weight: 700;
    color: #1e293b;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .fed-title i {
    color: #3b82f6;
  }

  .status-chips {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .chip {
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
    background: #f1f5f9;
    color: #64748b;
    letter-spacing: 0.5px;
  }

  .chip-red {
    background: #fee2e2;
    color: #ef4444;
  }

  .chip-orange {
    background: #fef3c7;
    color: #d97706;
  }

  .chip-green {
    background: #dcfce7;
    color: #16a34a;
  }

  .live-indicator {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 4px 8px;
    background: #eff6ff;
    border-radius: 20px;
  }

  .live-dot {
    width: 6px;
    height: 6px;
    background: #3b82f6;
    border-radius: 50%;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {

    0%,
    100% {
      opacity: 1;
      transform: scale(1);
    }

    50% {
      opacity: 0.5;
      transform: scale(1.2);
    }
  }

  .live-text {
    font-size: 10px;
    font-weight: 700;
    color: #3b82f6;
    letter-spacing: 0.5px;
  }

  .rates-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
  }

  .rate-card {
    background: #f8fafc;
    border-radius: 12px;
    padding: 16px;
    transition: background 0.2s;
  }

  .rate-card:hover {
    background: #f1f5f9;
  }

  .rate-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }

  .rate-label {
    font-size: 13px;
    font-weight: 600;
    color: #64748b;
  }

  .rate-change {
    font-size: 12px;
    font-weight: 600;
  }

  .rate-value-container {
    display: flex;
    align-items: baseline;
    gap: 2px;
  }

  .rate-value {
    font-family: 'Orbitron', sans-serif;
    font-size: 32px;
    font-weight: 700;
    color: #0f172a;
    letter-spacing: -1px;
  }

  .rate-decimal {
    font-family: 'Orbitron', sans-serif;
    font-size: 20px;
    font-weight: 500;
    color: #475569;
  }

  .change-up {
    color: #16a34a;
  }

  .change-down {
    color: #ef4444;
  }

  .change-neutral {
    color: #94a3b8;
  }

  .status-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 16px;
    padding-top: 12px;
    border-top: 1px solid #f1f5f9;
    font-size: 11px;
    color: #94a3b8;
  }

  .status-message {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #cbd5e1;
  }

  .status-dot.active {
    background: #22c55e;
  }

  .update-time {
    font-family: 'Orbitron', sans-serif;
    color: #cbd5e1;
    font-size: 10px;
  }

  /* Mobile Optimization */
  @media (max-width: 480px) {
    .fed-monitor-container {
      padding: 16px;
    }

    .fed-header {
      margin-bottom: 12px;
      padding-bottom: 8px;
    }

    .fed-title {
      font-size: 14px;
    }

    .rates-grid {
      gap: 10px;
    }

    .rate-card {
      padding: 12px;
    }

    .rate-value {
      font-size: 24px;
    }

    .rate-decimal {
      font-size: 16px;
    }

    .chip {
      display: none;
    }

    /* Hide chips on mobile to save space */
    .live-indicator {
      display: flex;
    }

    /* Keep live indicator */
    #inversionBadge {
      display: inline-flex !important;
    }

    /* Keep important badges */
  }

  .loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
    border-radius: 16px;
  }

  .spinner {
    width: 24px;
    height: 24px;
    border: 3px solid #e2e8f0;
    border-top-color: #3b82f6;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }
</style>

<div class="fed-monitor-container" onclick="openFedDetail()" role="button" aria-label="Open FED rates detail">
  <!-- Loading State -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
  </div>

  <!-- Header -->
  <div class="fed-header">
    <div class="fed-title">
      <i class="fas fa-chart-line"></i>
      <span>FED RATES MONITOR</span>
    </div>
    <div class="status-chips">
      <div class="chip" id="spreadChip">SPREAD --</div>
      <div class="chip chip-red" id="inversionBadge" style="display:none;">INVERSION</div>
      <div class="chip chip-orange" id="bufferChip" style="display:none;">BUFFER</div>
      <div class="live-indicator">
        <div class="live-dot"></div>
        <div class="live-text">LIVE</div>
      </div>
    </div>
  </div>

  <!-- Rates Grid -->
  <div class="rates-grid" id="ratesGrid">
    <!-- IORB -->
    <div class="rate-card">
      <div class="rate-header">
        <div class="rate-label">IORB</div>
        <div class="rate-change" id="iorb-change">--</div>
      </div>
      <div class="rate-value-container">
        <span class="rate-value" id="iorb-value">--</span>
        <span class="rate-decimal" id="iorb-decimal">--</span>
      </div>
    </div>

    <!-- SOFR -->
    <div class="rate-card">
      <div class="rate-header">
        <div class="rate-label">SOFR</div>
        <div class="rate-change" id="sofr-change">--</div>
      </div>
      <div class="rate-value-container">
        <span class="rate-value" id="sofr-value">--</span>
        <span class="rate-decimal" id="sofr-decimal">--</span>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="status-bar">
    <div class="status-message">
      <div class="status-dot active"></div>
      <span id="statusText">System Normal</span>
    </div>
    <div class="update-time" id="updateTime">--:--</div>
  </div>
</div>

<script>
  // Configuration
  const API_KEY = (window.FRED_API_KEY || localStorage.getItem('FRED_API_KEY') || '6dda7dc3956a2c1d6ac939133de115f1');
  const DIRECT_URL = 'https://api.stlouisfed.org/fred/series/observations';
  const HOST = window.location.hostname || '';
  const IS_LOCAL = ['localhost', '127.0.0.1'].includes(HOST) || HOST.includes('127.0.0.1');
  const USER_PROXY = 'https://fed-proxy.etloveaui.workers.dev/';
  const DEV_PROXY_URL = USER_PROXY ? (USER_PROXY.replace(/\/$/, '') + (USER_PROXY.includes('fred/series/observations') ? '' : '/fred/series/observations')) : 'http://127.0.0.1:8787/fred/series/observations';
  const BASE_URL = IS_LOCAL ? DEV_PROXY_URL : DIRECT_URL;

  // Generic fetch with CORS fallbacks
  async function fetchJsonWithCorsFallback(fullUrl) {
    const proxies = [];
    if (!IS_LOCAL && USER_PROXY) {
      const u = USER_PROXY.replace(/\/$/, '');
      if (u.includes('http') && !u.endsWith('/fred/series/observations')) {
        proxies.push(u + '/' + fullUrl);
      } else {
        const qs = fullUrl.split('?')[1] || '';
        proxies.push(u + (u.endsWith('/fred/series/observations') ? '' : '/fred/series/observations') + (qs ? ('?' + qs) : ''));
      }
    }
    proxies.push('https://cors.isomorphic-git.org/' + fullUrl);
    proxies.push('https://api.allorigins.win/raw?url=' + encodeURIComponent(fullUrl));

    const candidates = (!IS_LOCAL && /(github\.io|vercel\.app|netlify\.app)$/.test(HOST))
      ? [...proxies]
      : [fullUrl, ...proxies];

    for (const u of candidates) {
      try {
        const res = await fetch(u, { cache: 'no-store' });
        if (res && res.ok) return await res.json();
      } catch (e) { }
    }
    throw new Error('All fetch attempts failed');
  }

  // Series IDs
  const SERIES = { IORB: 'IORB', SOFR: 'SOFR' };
  let ratesData = { IORB: { current: null, previous: null }, SOFR: { current: null, previous: null } };

  function isMonthEndBuffer(date = new Date()) {
    const d = new Date(date.getFullYear(), date.getMonth() + 1, 0);
    const day = date.getDate();
    const last = d.getDate();
    return (day >= last - 1) || (day <= 2);
  }

  async function fetchLatestPair(seriesId) {
    const endDate = new Date().toISOString().split('T')[0];
    const startDate = new Date(Date.now() - 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
    const direct = `${DIRECT_URL}?series_id=${seriesId}&api_key=${API_KEY}&file_type=json&observation_start=${startDate}&observation_end=${endDate}&sort_order=asc`;
    const data = await fetchJsonWithCorsFallback(direct);
    const obs = Array.isArray(data?.observations) ? data.observations : [];
    let current = null, previous = null;
    for (let i = obs.length - 1; i >= 0; i--) {
      const v = parseFloat(obs[i].value);
      if (Number.isFinite(v)) {
        if (current === null) current = v; else { previous = v; break; }
      }
    }
    if (current !== null && previous === null) previous = current;
    return { current, previous };
  }

  async function fetchRateData(seriesId) {
    try {
      const endDate = new Date().toISOString().split('T')[0];
      const startDate = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
      const url = `${DIRECT_URL}?series_id=${seriesId}&api_key=${API_KEY}&file_type=json&observation_start=${startDate}&observation_end=${endDate}&sort_order=desc&limit=2`;
      const data = await fetchJsonWithCorsFallback(url);
      let current = null, previous = null;
      if (data && Array.isArray(data.observations) && data.observations.length > 0) {
        const c = parseFloat(data.observations[0].value);
        const p = data.observations.length > 1 ? parseFloat(data.observations[1].value) : c;
        current = Number.isFinite(c) ? c : null;
        previous = Number.isFinite(p) ? p : current;
      }
      if (current == null || previous == null) return await fetchLatestPair(seriesId);
      return { current, previous };
    } catch (error) {
      try { return await fetchLatestPair(seriesId); } catch (e) { return { current: null, previous: null }; }
    }
  }

  function updateRateDisplay(rateType, data) {
    const elementPrefix = rateType.toLowerCase();
    if (Number.isFinite(data.current)) {
      const value = Math.floor(data.current).toString();
      const decimal = (data.current % 1).toFixed(2).substring(1);

      document.getElementById(`${elementPrefix}-value`).textContent = value;
      document.getElementById(`${elementPrefix}-decimal`).textContent = decimal;

      const changeElement = document.getElementById(`${elementPrefix}-change`);
      if (data.previous !== null) {
        const change = data.current - data.previous;
        const changeBp = (Math.abs(change) * 100).toFixed(0);
        const arrow = change > 0 ? '▲' : change < 0 ? '▼' : '-';
        const cls = change > 0 ? 'change-up' : change < 0 ? 'change-down' : 'change-neutral';
        changeElement.innerHTML = `<span class="${cls}">${arrow} ${changeBp}bp</span>`;
      }
    }
  }

  function updateStatus() {
    const { IORB, SOFR } = ratesData;
    if (!IORB.current || !SOFR.current) return;

    const spread = IORB.current - SOFR.current;
    const spreadBp = Math.round(spread * 100);
    const inBuffer = isMonthEndBuffer();

    // Spread Chip
    const spreadChip = document.getElementById('spreadChip');
    spreadChip.textContent = `SPREAD ${spreadBp}bp`;
    spreadChip.className = 'chip ' + (spreadBp < 0 ? 'chip-red' : spreadBp <= 5 ? 'chip-orange' : 'chip-green');

    // Inversion Badge
    document.getElementById('inversionBadge').style.display = spreadBp < 0 ? 'inline-flex' : 'none';

    // Buffer Chip
    const bufferChip = document.getElementById('bufferChip');
    if (inBuffer || spreadBp <= 5) {
      bufferChip.style.display = 'inline-flex';
      bufferChip.textContent = inBuffer ? 'M/E BUFFER' : 'NARROW';
    } else {
      bufferChip.style.display = 'none';
    }

    // Status Text
    const statusText = document.getElementById('statusText');
    if (spreadBp < 0) statusText.textContent = "Inversion Detected";
    else if (spreadBp <= 5) statusText.textContent = "Spread Narrowing";
    else statusText.textContent = "Market Normal";
  }

  function updateTimestamp() {
    const now = new Date();
    document.getElementById('updateTime').textContent = now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false });
  }

  async function initialize() {
    try {
      const [iorb, sofr] = await Promise.all([fetchRateData(SERIES.IORB), fetchRateData(SERIES.SOFR)]);
      ratesData.IORB = iorb;
      ratesData.SOFR = sofr;
      updateRateDisplay('IORB', iorb);
      updateRateDisplay('SOFR', sofr);
      updateStatus();
      updateTimestamp();
      document.getElementById('loadingOverlay').style.display = 'none';
    } catch (error) {
      console.error('Init error:', error);
      document.getElementById('loadingOverlay').style.display = 'none';
    }
  }

  (async () => { await initialize(); })();

  function openFedDetail() {
    const target = 'tools/fed/fed-rates-detail.html';
    try {
      if (window.top && typeof window.top.loadPage === 'function') { window.top.loadPage(target); return; }
      if (window.parent && typeof window.parent.loadPage === 'function') { window.parent.loadPage(target); return; }
    } catch (e) { }
    const base = (window.top && window.top.baseHref) || (window.baseHref) || '/';
    window.top ? window.top.location.assign(`${base}index.html?path=${target}`) : location.assign(`index.html?path=${target}`);
  }
</script>