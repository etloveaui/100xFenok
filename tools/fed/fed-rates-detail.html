<!DOCTYPE html>
<html lang="ko">
<head>
<!-- Fed Rates Detail Page -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
  :root { color-scheme: dark; }
  body { margin: 0; background: #0a0a0a; color: #e5e7eb; font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Ubuntu, Cantarell, 'Noto Sans KR', 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif; }
  .page { max-width: 1080px; margin: 0 auto; padding: 20px; }
  .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
  .title { font-family: 'Orbitron', monospace; font-size: 20px; font-weight: 800; letter-spacing: 2px; color: #22c55e; display: flex; align-items: center; gap: 12px; }
  .back { color: #9ca3af; font-size: 13px; cursor: pointer; border: 1px solid #1f2937; padding: 6px 10px; border-radius: 8px; background: #0b0b0b; }
  .back:hover { border-color: #374151; color: #d1d5db; }
  .live { display: flex; align-items: center; gap: 8px; }
  .live-dot { width: 8px; height: 8px; background: #ef4444; border-radius: 50%; animation: pulse 2s infinite; }
  .live-text { font-family: 'Orbitron', monospace; font-size: 11px; color: #ef4444; }
  @keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.6;transform:scale(1.2)} }

  .topbar { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px; }
  .update { font-family: 'Orbitron', monospace; font-size: 11px; color: #6b7280; letter-spacing: 1px; }

  .grid { display:grid; grid-template-columns: repeat(2,1fr); gap:16px; }
  @media (max-width: 860px) { .grid { grid-template-columns: 1fr; } }

  .card { background: #0b0b0b; border: 1px solid #1f2937; border-radius: 12px; padding: 14px; }
  .card:hover { border-color: #22c55e33; }
  .card-title { display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; }
  .label { font-family:'Orbitron',monospace; font-size:12px; color:#9ca3af; letter-spacing:1px; }
  .value { font-family:'Orbitron',monospace; font-size:34px; color:#22c55e; font-weight:800; letter-spacing:1px; text-shadow: 0 0 10px rgba(34, 197, 94, .4); display:flex; align-items:baseline; gap:2px; }
  .decimal { font-size:20px; color:#a7f3d0; }
  .change { margin-top:6px; font-family:'Orbitron',monospace; font-size:11px; }
  .change-up{color:#22c55e} .change-down{color:#ef4444} .change-neutral{color:#6b7280}
  .chart { height: 160px; margin-top: 10px; }
  .status-bar { display:flex; align-items:center; gap:10px; margin-top: 16px; padding-top: 12px; border-top:1px solid #1f2937; }
  .status-led{width:12px;height:12px;border-radius:50%;box-shadow:0 0 10px #22c55e;background:#22c55e}
  .status-yellow{background:#eab308;box-shadow:0 0 10px #eab308;animation: blink 1s infinite;}
  .status-red{background:#ef4444;box-shadow:0 0 10px #ef4444;animation: blink .6s infinite;}
  @keyframes blink {0%,100%{opacity:1} 50%{opacity:.3}}

  .section { background:#0b0b0b; border:1px solid #1f2937; border-radius:12px; padding:14px; margin-top:16px; }
  .section h3 { margin:0 0 8px; font-family:'Orbitron',monospace; font-size:13px; letter-spacing:1px; color:#93c5fd; }
  .note { font-size:12px; color:#9ca3af }
</style>
</head>
<body>

<div class="page">
  <div class="header">
    <div class="title">FED RATES DETAIL</div>
    <div class="live">
      <div class="live-dot"></div>
      <div class="live-text">LIVE</div>
    </div>
  </div>
  <div class="topbar">
    <div class="update" id="updateTime">UPDATE --:--</div>
  </div>

  <div class="grid">
    <!-- IORB -->
    <div class="card">
      <div class="card-title"><div class="label">IORB</div><div class="change" id="iorb-change">--</div></div>
      <div class="value"><span id="iorb-value">--</span><span class="decimal" id="iorb-decimal">--</span></div>
      <div class="chart">
        <svg id="iorb-chart" width="100%" height="160" viewBox="0 0 300 160"></svg>
      </div>
    </div>

    <!-- EFFR -->
    <div class="card">
      <div class="card-title"><div class="label">EFFR</div><div class="change" id="effr-change">--</div></div>
      <div class="value"><span id="effr-value">--</span><span class="decimal" id="effr-decimal">--</span></div>
      <div class="chart">
        <svg id="effr-chart" width="100%" height="160" viewBox="0 0 300 160"></svg>
      </div>
    </div>

    <!-- SOFR -->
    <div class="card">
      <div class="card-title"><div class="label">SOFR</div><div class="change" id="sofr-change">--</div></div>
      <div class="value"><span id="sofr-value">--</span><span class="decimal" id="sofr-decimal">--</span></div>
      <div class="chart">
        <svg id="sofr-chart" width="100%" height="160" viewBox="0 0 300 160"></svg>
      </div>
    </div>

    <!-- ON RRP -->
    <div class="card">
      <div class="card-title"><div class="label">ON RRP</div><div class="change" id="rrp-change">--</div></div>
      <div class="value" style="font-size:26px"><span id="rrp-value">--</span><span class="decimal" id="rrp-unit">B</span></div>
      <div class="chart">
        <svg id="rrp-chart" width="100%" height="160" viewBox="0 0 300 160"></svg>
      </div>
    </div>
  </div>

  <div class="section">
    <h3>상태 분석</h3>
    <div class="status-bar">
      <div class="status-led" id="statusLed"></div>
      <div class="note" id="statusText">ANALYZING</div>
    </div>
    <div class="note">규칙: 정상 순서 IORB &gt; EFFR &gt; SOFR, 스프레드(IORB−SOFR) 기준.</div>
  </div>

  <div class="section">
    <h3>설명</h3>
    <div class="note">데이터 출처: FRED API. 5분 주기로 자동 갱신됩니다.</div>
  </div>
</div>

<script>
  const API_KEY = '6dda7dc3956a2c1d6ac939133de115f1';
  const DIRECT_URL = 'https://api.stlouisfed.org/fred/series/observations';
  const IS_LOCAL = ['localhost','127.0.0.1'].includes(window.location.hostname);
  const DEV_PROXY_URL = ((window.FRED_PROXY_URL || localStorage.getItem('FRED_PROXY_URL') || 'http://127.0.0.1:8787') + '/fred/series/observations');
  const BASE_URL = IS_LOCAL ? DEV_PROXY_URL : DIRECT_URL;
  const SERIES = { IORB: 'IORB', EFFR: 'DFF', SOFR: 'SOFR', RRPONTSYD: 'RRPONTSYD' };

  const store = {
    IORB: { current: null, previous: null, series: [] },
    EFFR: { current: null, previous: null, series: [] },
    SOFR: { current: null, previous: null, series: [] },
    RRPONTSYD: { current: null, previous: null, series: [] }
  };

  function fmtRate(val){
    const v = Math.floor(val).toString();
    const d = (val % 1).toFixed(2).substring(1);
    return [v, d];
  }

  function drawSpark(svgId, values){
    const svg = document.getElementById(svgId);
    if (!svg || !values || values.length < 2) return;
    const w = 300, h = 160, p = 12;
    const min = Math.min(...values), max = Math.max(...values);
    const xr = (i)=> p + (w - 2*p) * (i/(values.length - 1));
    const yr = (v)=> h - p - (h - 2*p) * ((v - min) / Math.max(1e-9, (max - min)));
    let d = '';
    values.forEach((v, i)=>{ d += (i? ' L':'M') + xr(i) + ' ' + yr(v); });
    svg.innerHTML = `<path d="${d}" fill="none" stroke="#22c55e" stroke-width="2" />` +
      `<line x1="${p}" y1="${yr(values[values.length-1])}" x2="${w-p}" y2="${yr(values[values.length-1])}" stroke="#1f2937" stroke-dasharray="3,3" />`;
  }

  async function fetchSeries(seriesId, days=90){
    const end = new Date();
    const start = new Date(Date.now() - days*24*60*60*1000);
    const endDate = end.toISOString().split('T')[0];
    const startDate = start.toISOString().split('T')[0];
    const url = `${BASE_URL}?series_id=${seriesId}&api_key=${API_KEY}&file_type=json&observation_start=${startDate}&observation_end=${endDate}&sort_order=asc`;
    const res = await fetch(url);
    const json = await res.json();
    const obs = (json.observations||[]).map(o=> parseFloat(o.value)).filter(v=>!isNaN(v));
    const cur = obs.length? obs[obs.length-1] : null;
    const prev = obs.length>1? obs[obs.length-2] : cur;
    return { series: obs, current: cur, previous: prev };
  }

  // Fast path: fetch latest numeric and previous numeric (skip '.' etc.)
  async function fetchLatestPair(seriesId){
    const endDate = new Date().toISOString().split('T')[0];
    const startDate = new Date(Date.now() - 365*24*60*60*1000).toISOString().split('T')[0];
    // Ascending order, then scan from the end to find latest numeric values
    const url = `${BASE_URL}?series_id=${seriesId}&api_key=${API_KEY}&file_type=json&observation_start=${startDate}&observation_end=${endDate}&sort_order=asc`;
    const res = await fetch(url);
    const json = await res.json();
    const obs = Array.isArray(json?.observations) ? json.observations : [];
    let current = null, previous = null;
    for (let i = obs.length - 1; i >= 0; i--) {
      const v = parseFloat(obs[i].value);
      if (!isNaN(v)) {
        if (current === null) { current = v; }
        else { previous = v; break; }
      }
    }
    if (current !== null && previous === null) previous = current;
    return { current, previous };
  }

  // Widget-equivalent fetch (fallback)
  async function fetchRateData(seriesId) {
    try {
      const endDate = new Date().toISOString().split('T')[0];
      const startDate = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
      const url = `${BASE_URL}?series_id=${seriesId}&api_key=${API_KEY}&file_type=json&observation_start=${startDate}&observation_end=${endDate}&sort_order=desc&limit=2`;
      const response = await fetch(url);
      const data = await response.json();
      if (data.observations && data.observations.length > 0) {
        const current = parseFloat(data.observations[0].value);
        const previous = data.observations.length > 1 ? parseFloat(data.observations[1].value) : current;
        return { current: isNaN(current) ? null : current, previous: isNaN(previous) ? null : previous };
      }
      return { current: null, previous: null };
    } catch (err) {
      console.error('Fallback fetch error for', seriesId, err);
      return { current: null, previous: null };
    }
  }

  function setChange(elId, delta, isRRP=false){
    const arrow = delta > 0 ? '&uarr;' : delta < 0 ? '&darr;' : '&rarr;';
    const cls = delta > 0 ? 'change-up' : delta < 0 ? 'change-down' : 'change-neutral';
    const text = isRRP ? `${arrow} ${Math.abs(delta/1000).toFixed(1)}B` : `${arrow} ${(Math.abs(delta)*100).toFixed(0)}bp`;
    const el = document.getElementById(elId);
    if (el) el.innerHTML = `<span class="${cls}">${text}</span>`;
  }

  function analyze(){
    const { IORB, EFFR, SOFR } = store;
    if (!IORB.current || !EFFR.current || !SOFR.current) return { level:'yellow', text:'DATA PENDING' };
    const normal = IORB.current > EFFR.current && EFFR.current > SOFR.current;
    const spread = IORB.current - SOFR.current;
    if (normal && spread > 0.15) return { level:'green', text:'NORMAL' };
    if (normal && spread <= 0.15) return { level:'yellow', text:'CAUTION' };
    return { level:'red', text:'WARNING' };
  }

  function updateStatus(){
    const s = analyze();
    const led = document.getElementById('statusLed');
    const t = document.getElementById('statusText');
    if (led){ led.className = 'status-led'; if (s.level==='yellow') led.classList.add('status-yellow'); if (s.level==='red') led.classList.add('status-red'); }
    if (t) t.textContent = s.text;
  }

  function updateTime(){
    const now = new Date();
    const ts = now.toLocaleTimeString('ko-KR', {hour:'2-digit',minute:'2-digit',hour12:false});
    document.getElementById('updateTime').textContent = `UPDATE ${ts}`;
  }

  async function init(){
    try {
      console.log('[FED DETAIL] init start. BASE_URL=', BASE_URL);
      // 1) Quick values first
      const [lIorb, lEffr, lSofr, lRrp] = await Promise.all([
        fetchLatestPair(SERIES.IORB),
        fetchLatestPair(SERIES.EFFR),
        fetchLatestPair(SERIES.SOFR),
        fetchLatestPair(SERIES.RRPONTSYD)
      ]);

      Object.assign(store.IORB, lIorb);
      Object.assign(store.EFFR, lEffr);
      Object.assign(store.SOFR, lSofr);
      Object.assign(store.RRPONTSYD, lRrp);

      if (lIorb.current!=null){ const [v,d]=fmtRate(lIorb.current); document.getElementById('iorb-value').textContent=v; document.getElementById('iorb-decimal').textContent=d; setChange('iorb-change', lIorb.current-lIorb.previous); }
      if (lEffr.current!=null){ const [v,d]=fmtRate(lEffr.current); document.getElementById('effr-value').textContent=v; document.getElementById('effr-decimal').textContent=d; setChange('effr-change', lEffr.current-lEffr.previous); }
      if (lSofr.current!=null){ const [v,d]=fmtRate(lSofr.current); document.getElementById('sofr-value').textContent=v; document.getElementById('sofr-decimal').textContent=d; setChange('sofr-change', lSofr.current-lSofr.previous); }
      if (lRrp.current!=null){ const billions = lRrp.current/1000; document.getElementById('rrp-value').textContent = Math.floor(billions).toString(); document.getElementById('rrp-unit').textContent = `.${(billions%1).toFixed(1).substring(2)}B`; setChange('rrp-change', lRrp.current-lRrp.previous, true); }

      updateStatus();
      updateTime();

      // If any value is still null, try widget-style fallback just for numbers
      const needFallback = [
        { key: 'IORB', data: lIorb },
        { key: 'EFFR', data: lEffr },
        { key: 'SOFR', data: lSofr },
        { key: 'RRPONTSYD', data: lRrp }
      ].some(x => !x.data || x.data.current == null);

      if (needFallback) {
        console.log('[FED DETAIL] fallback using widget-style fetch');
        const [wIorb, wEffr, wSofr, wRrp] = await Promise.all([
          fetchRateData(SERIES.IORB),
          fetchRateData(SERIES.EFFR),
          fetchRateData(SERIES.SOFR),
          fetchRateData(SERIES.RRPONTSYD)
        ]);

        if (wIorb.current!=null){ const [v,d]=fmtRate(wIorb.current); document.getElementById('iorb-value').textContent=v; document.getElementById('iorb-decimal').textContent=d; setChange('iorb-change', wIorb.current-wIorb.previous); Object.assign(store.IORB, wIorb); }
        if (wEffr.current!=null){ const [v,d]=fmtRate(wEffr.current); document.getElementById('effr-value').textContent=v; document.getElementById('effr-decimal').textContent=d; setChange('effr-change', wEffr.current-wEffr.previous); Object.assign(store.EFFR, wEffr); }
        if (wSofr.current!=null){ const [v,d]=fmtRate(wSofr.current); document.getElementById('sofr-value').textContent=v; document.getElementById('sofr-decimal').textContent=d; setChange('sofr-change', wSofr.current-wSofr.previous); Object.assign(store.SOFR, wSofr); }
        if (wRrp.current!=null){ const billions = wRrp.current/1000; document.getElementById('rrp-value').textContent = Math.floor(billions).toString(); document.getElementById('rrp-unit').textContent = `.${(billions%1).toFixed(1).substring(2)}B`; setChange('rrp-change', wRrp.current-wRrp.previous, true); Object.assign(store.RRPONTSYD, wRrp); }

        updateStatus();
        updateTime();
      }

      // 2) Then fetch longer series for charts (can be parallel, no UI block)
      const [sIorb, sEffr, sSofr, sRrp] = await Promise.all([
        fetchSeries(SERIES.IORB, 365),
        fetchSeries(SERIES.EFFR, 365),
        fetchSeries(SERIES.SOFR, 365),
        fetchSeries(SERIES.RRPONTSYD, 365)
      ]);

      Object.assign(store.IORB, sIorb);
      Object.assign(store.EFFR, sEffr);
      Object.assign(store.SOFR, sSofr);
      Object.assign(store.RRPONTSYD, sRrp);

      if (sIorb.series.length) {
        drawSpark('iorb-chart', sIorb.series);
        if (store.IORB.current == null && sIorb.current != null) {
          const [v,d]=fmtRate(sIorb.current); document.getElementById('iorb-value').textContent=v; document.getElementById('iorb-decimal').textContent=d; setChange('iorb-change', sIorb.current - (sIorb.previous ?? sIorb.current));
        }
      }
      if (sEffr.series.length) {
        drawSpark('effr-chart', sEffr.series);
        if (store.EFFR.current == null && sEffr.current != null) {
          const [v,d]=fmtRate(sEffr.current); document.getElementById('effr-value').textContent=v; document.getElementById('effr-decimal').textContent=d; setChange('effr-change', sEffr.current - (sEffr.previous ?? sEffr.current));
        }
      }
      if (sSofr.series.length) {
        drawSpark('sofr-chart', sSofr.series);
        if (store.SOFR.current == null && sSofr.current != null) {
          const [v,d]=fmtRate(sSofr.current); document.getElementById('sofr-value').textContent=v; document.getElementById('sofr-decimal').textContent=d; setChange('sofr-change', sSofr.current - (sSofr.previous ?? sSofr.current));
        }
      }
      if (sRrp.series.length) {
        drawSpark('rrp-chart', sRrp.series.map(v=>v/1000));
        if (store.RRPONTSYD.current == null && sRrp.current != null) {
          const billions = sRrp.current/1000; document.getElementById('rrp-value').textContent = Math.floor(billions).toString(); document.getElementById('rrp-unit').textContent = `.${(billions%1).toFixed(1).substring(2)}B`; setChange('rrp-change', sRrp.current - (sRrp.previous ?? sRrp.current), true);
        }
      }

      console.log('[FED DETAIL] init done.');
    } catch (e) {
      console.error('[FED DETAIL] init error', e);
      const t = document.getElementById('statusText');
      if (t) t.textContent = 'ERROR: DATA FETCH FAILED';
    }
  }

  // Robust init triggers (in case of timing issues)
  let __fedDetailStarted = false;
  function startDetail() {
    if (__fedDetailStarted) return;
    __fedDetailStarted = true;
    init().catch(e=>console.error('[FED DETAIL] init failure', e));
  }
  document.addEventListener('DOMContentLoaded', startDetail);
  window.addEventListener('load', startDetail);
  setTimeout(startDetail, 200);
  setInterval(init, 5*60*1000);
</script>
 
</body>
</html>
