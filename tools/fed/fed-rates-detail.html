<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Fed Watch Dashboard | 100x FenoK</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background-color: #f8fafc;
    }

    .orbitron {
      font-family: 'Orbitron', sans-serif;
    }

    /* Premium Card Style from Daily Wrap */
    .card-shadow {
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .card-shadow:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    /* Tab Animation */
    .tab-btn {
      position: relative;
      transition: all 0.3s ease;
    }

    .tab-btn::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      width: 0;
      height: 2px;
      background-color: #2563eb;
      /* Blue-600 */
      transition: width 0.3s ease;
    }

    .tab-btn.active {
      color: #2563eb;
    }

    .tab-btn.active::after {
      width: 100%;
    }

    /* Chart Area */
    .chart-area {
      height: 100px;
    }

    /* Loading Spinner */
    .spinner {
      border: 3px solid #e5e7eb;
      border-top-color: #2563eb;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Custom Scrollbar for Tabs */
    .hide-scrollbar::-webkit-scrollbar {
      display: none;
    }

    .hide-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
  </style>
</head>

<body class="text-slate-800">

  <!-- Header Section -->
  <header class="bg-white border-b border-slate-200 sticky top-0 z-30">
    <div class="max-w-5xl mx-auto px-4 py-4 flex justify-between items-center">
      <div class="flex items-center gap-3">
        <div class="bg-blue-600 text-white p-2 rounded-lg shadow-sm">
          <i class="fas fa-landmark text-lg"></i>
        </div>
        <div>
          <h1 class="text-xl md:text-2xl font-bold orbitron text-slate-900 tracking-tight">FED WATCH</h1>
          <p class="text-xs text-slate-500 font-medium">Real-time Monetary Policy Monitor</p>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <div
          class="hidden md:flex items-center gap-2 bg-slate-100 px-3 py-1.5 rounded-full text-xs font-semibold text-slate-600">
          <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
          LIVE DATA
        </div>
        <div id="updateTime" class="text-xs orbitron text-slate-400">--:--</div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-5xl mx-auto px-4 py-8 pb-24">

    <!-- Tab Navigation -->
    <div class="flex space-x-8 border-b border-slate-200 mb-8 overflow-x-auto hide-scrollbar">
      <button onclick="switchTab('rates')"
        class="tab-btn active pb-3 text-sm font-bold text-slate-500 hover:text-slate-800 whitespace-nowrap">
        RATES & YIELDS
      </button>
      <button onclick="switchTab('liquidity')"
        class="tab-btn pb-3 text-sm font-bold text-slate-500 hover:text-slate-800 whitespace-nowrap">
        LIQUIDITY
      </button>
      <button onclick="switchTab('inflation')"
        class="tab-btn pb-3 text-sm font-bold text-slate-500 hover:text-slate-800 whitespace-nowrap">
        INFLATION
      </button>
    </div>

    <!-- Tab: RATES -->
    <div id="tab-rates" class="tab-content active space-y-6">

      <!-- Status Banner -->
      <div class="bg-white rounded-xl card-shadow p-5 border-l-4 border-blue-500 flex items-start gap-4">
        <div class="mt-1 text-blue-500">
          <i class="fas fa-info-circle text-xl"></i>
        </div>
        <div>
          <h3 class="font-bold text-slate-800 text-sm mb-1">MARKET STATUS</h3>
          <div class="flex items-center gap-2">
            <div id="statusLed" class="w-2.5 h-2.5 rounded-full bg-slate-300"></div>
            <p id="statusText" class="text-sm font-semibold orbitron text-slate-600">ANALYZING...</p>
          </div>
        </div>
      </div>

      <!-- Grid -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-5">

        <!-- IORB Card -->
        <div class="bg-white rounded-xl card-shadow p-6 relative overflow-hidden">
          <div class="flex justify-between items-start mb-2">
            <div>
              <h4 class="text-xs font-bold text-slate-400 tracking-wider">POLICY RATE</h4>
              <h3 class="text-lg font-bold text-slate-800">IORB</h3>
            </div>
            <div id="iorb-change" class="text-sm font-bold orbitron bg-slate-50 px-2 py-1 rounded">--</div>
          </div>
          <div class="flex items-baseline gap-1 mt-2">
            <span id="iorb-value" class="text-4xl font-bold orbitron text-slate-900">--</span>
            <span id="iorb-decimal" class="text-xl font-semibold orbitron text-slate-400">--</span>
            <span class="text-sm text-slate-400 ml-1">%</span>
          </div>
          <div class="chart-area mt-4">
            <svg id="iorb-chart" width="100%" height="100%" viewBox="0 0 300 100" preserveAspectRatio="none"></svg>
          </div>
        </div>

        <!-- EFFR Card -->
        <div class="bg-white rounded-xl card-shadow p-6 relative overflow-hidden">
          <div class="flex justify-between items-start mb-2">
            <div>
              <h4 class="text-xs font-bold text-slate-400 tracking-wider">EFFECTIVE RATE</h4>
              <h3 class="text-lg font-bold text-slate-800">EFFR</h3>
            </div>
            <div id="effr-change" class="text-sm font-bold orbitron bg-slate-50 px-2 py-1 rounded">--</div>
          </div>
          <div class="flex items-baseline gap-1 mt-2">
            <span id="effr-value" class="text-4xl font-bold orbitron text-slate-900">--</span>
            <span id="effr-decimal" class="text-xl font-semibold orbitron text-slate-400">--</span>
            <span class="text-sm text-slate-400 ml-1">%</span>
          </div>
          <div class="chart-area mt-4">
            <svg id="effr-chart" width="100%" height="100%" viewBox="0 0 300 100" preserveAspectRatio="none"></svg>
          </div>
        </div>

        <!-- SOFR Card -->
        <div class="bg-white rounded-xl card-shadow p-6 relative overflow-hidden">
          <div class="flex justify-between items-start mb-2">
            <div>
              <h4 class="text-xs font-bold text-slate-400 tracking-wider">SECURED RATE</h4>
              <h3 class="text-lg font-bold text-slate-800">SOFR</h3>
            </div>
            <div id="sofr-change" class="text-sm font-bold orbitron bg-slate-50 px-2 py-1 rounded">--</div>
          </div>
          <div class="flex items-baseline gap-1 mt-2">
            <span id="sofr-value" class="text-4xl font-bold orbitron text-slate-900">--</span>
            <span id="sofr-decimal" class="text-xl font-semibold orbitron text-slate-400">--</span>
            <span class="text-sm text-slate-400 ml-1">%</span>
          </div>
          <div class="chart-area mt-4">
            <svg id="sofr-chart" width="100%" height="100%" viewBox="0 0 300 100" preserveAspectRatio="none"></svg>
          </div>
        </div>

        <!-- ON RRP Card -->
        <div class="bg-white rounded-xl card-shadow p-6 relative overflow-hidden">
          <div class="flex justify-between items-start mb-2">
            <div>
              <h4 class="text-xs font-bold text-slate-400 tracking-wider">LIQUIDITY DRAIN</h4>
              <h3 class="text-lg font-bold text-slate-800">ON RRP</h3>
            </div>
            <div id="rrp-change" class="text-sm font-bold orbitron bg-slate-50 px-2 py-1 rounded">--</div>
          </div>
          <div class="flex items-baseline gap-1 mt-2">
            <span class="text-2xl font-bold text-slate-400 mr-1">$</span>
            <span id="rrp-value" class="text-4xl font-bold orbitron text-slate-900">--</span>
            <span id="rrp-unit" class="text-xl font-semibold orbitron text-slate-400">--</span>
          </div>
          <div class="chart-area mt-4">
            <svg id="rrp-chart" width="100%" height="100%" viewBox="0 0 300 100" preserveAspectRatio="none"></svg>
          </div>
        </div>

      </div>
    </div>

    <!-- Tab: LIQUIDITY (Placeholder) -->
    <div id="tab-liquidity" class="tab-content hidden">
      <div class="bg-white rounded-xl card-shadow p-12 text-center border border-dashed border-slate-300">
        <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-50 text-blue-500 rounded-full mb-4">
          <i class="fas fa-water text-2xl"></i>
        </div>
        <h3 class="text-lg font-bold text-slate-800">Liquidity Dashboard</h3>
        <p class="text-slate-500 mt-2 text-sm">TGA, Bank Reserves, and Net Liquidity tracking coming soon.</p>
      </div>
    </div>

    <!-- Tab: INFLATION (Placeholder) -->
    <div id="tab-inflation" class="tab-content hidden">
      <div class="bg-white rounded-xl card-shadow p-12 text-center border border-dashed border-slate-300">
        <div class="inline-flex items-center justify-center w-16 h-16 bg-red-50 text-red-500 rounded-full mb-4">
          <i class="fas fa-chart-line text-2xl"></i>
        </div>
        <h3 class="text-lg font-bold text-slate-800">Inflation Dashboard</h3>
        <p class="text-slate-500 mt-2 text-sm">CPI, PCE, and Breakeven Inflation rates coming soon.</p>
      </div>
    </div>

  </main>

  <!-- Logic Script -->
  <script>
    // --- Logic Ported from fed-monitor-widget.html ---
    const API_KEY = (window.FRED_API_KEY || localStorage.getItem('FRED_API_KEY') || '6dda7dc3956a2c1d6ac939133de115f1');
    const DIRECT_URL = 'https://api.stlouisfed.org/fred/series/observations';
    const HOST = window.location.hostname || '';
    const IS_LOCAL = ['localhost', '127.0.0.1'].includes(HOST) || HOST.includes('127.0.0.1');
    const USER_PROXY = 'https://fed-proxy.etloveaui.workers.dev/';

    async function fetchJsonWithCorsFallback(fullUrl) {
      const proxies = [];
      if (!IS_LOCAL && USER_PROXY) {
        const u = USER_PROXY.replace(/\/$/, '');
        if (u.includes('http') && !u.endsWith('/fred/series/observations')) {
          proxies.push(u + '/' + fullUrl);
        } else {
          const qs = fullUrl.split('?')[1] || '';
          proxies.push(u + (u.endsWith('/fred/series/observations') ? '' : '/fred/series/observations') + (qs ? ('?' + qs) : ''));
        }
      }
      proxies.push('https://cors.isomorphic-git.org/' + fullUrl);
      proxies.push('https://api.allorigins.win/raw?url=' + encodeURIComponent(fullUrl));
      proxies.push('https://thingproxy.freeboard.io/fetch/' + fullUrl);

      const candidates = (!IS_LOCAL && /(github\.io|vercel\.app|netlify\.app)$/.test(HOST))
        ? [...proxies]
        : [fullUrl, ...proxies];

      for (const u of candidates) {
        try {
          const res = await fetch(u, { cache: 'no-store' });
          if (res && res.ok) return await res.json();
        } catch (e) { /* try next */ }
      }
      throw new Error('All fetch attempts failed');
    }

    const SERIES = { IORB: 'IORB', EFFR: 'DFF', SOFR: 'SOFR', RRP: 'RRPONTSYD' };
    const store = { IORB: {}, EFFR: {}, SOFR: {}, RRP: {} };

    async function fetchLatestPair(seriesId) {
      const endDate = new Date().toISOString().split('T')[0];
      const startDate = new Date(Date.now() - 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
      const url = `${DIRECT_URL}?series_id=${seriesId}&api_key=${API_KEY}&file_type=json&observation_start=${startDate}&observation_end=${endDate}&sort_order=asc`;

      try {
        const data = await fetchJsonWithCorsFallback(url);
        const obs = Array.isArray(data?.observations) ? data.observations : [];
        const history = obs.map(o => parseFloat(o.value)).filter(v => Number.isFinite(v));

        let current = null, previous = null;
        if (history.length > 0) current = history[history.length - 1];
        if (history.length > 1) previous = history[history.length - 2];
        if (current !== null && previous === null) previous = current;

        return { current, previous, history };
      } catch (e) {
        return { current: null, previous: null, history: [] };
      }
    }

    function fmt(val) {
      if (val == null) return ['--', '--'];
      const v = Math.floor(val).toString();
      const d = (val % 1).toFixed(2).substring(1);
      return [v, d];
    }

    function updateCard(key, data, isRRP = false) {
      const prefix = key.toLowerCase();

      // Value
      if (isRRP) {
        if (data.current) {
          const billions = data.current / 1000; // Assuming data is in billions if raw is millions, but FRED RRP is usually Billions. Wait, RRPONTSYD is Billions.
          // Actually RRPONTSYD is Billions of Dollars. So raw 2000 = 2000B.
          // Let's check raw value magnitude. If > 1000, likely B.
          // Wait, RRPONTSYD unit is Billions of Dollars. So 2300 means $2.3T? No.
          // Let's assume raw value is Billions.
          const val = data.current;
          document.getElementById(`${prefix}-value`).textContent = Math.floor(val).toLocaleString();
          document.getElementById(`${prefix}-unit`).textContent = `.${(val % 1).toFixed(1).substring(2)}B`;
        }
      } else {
        const [v, d] = fmt(data.current);
        document.getElementById(`${prefix}-value`).textContent = v;
        document.getElementById(`${prefix}-decimal`).textContent = d;
      }

      // Change
      if (data.current != null && data.previous != null) {
        const delta = data.current - data.previous;
        const el = document.getElementById(`${prefix}-change`);
        const isUp = delta > 0;
        const isDown = delta < 0;

        el.className = `text-sm font-bold orbitron px-2 py-1 rounded ${isUp ? 'bg-green-100 text-green-700' : isDown ? 'bg-red-100 text-red-700' : 'bg-slate-100 text-slate-500'}`;

        const arrow = isUp ? '▲' : isDown ? '▼' : '-';
        const txt = isRRP
          ? `${arrow} ${Math.abs(delta).toFixed(1)}`
          : `${arrow} ${(Math.abs(delta) * 100).toFixed(0)}bp`;
        el.textContent = txt;
      }

      // Chart
      if (data.history.length > 0) {
        drawChart(`${prefix}-chart`, data.history);
      }
    }

    function drawChart(svgId, values) {
      const svg = document.getElementById(svgId);
      if (!svg || values.length < 2) return;

      const w = 300, h = 100;
      const min = Math.min(...values);
      const max = Math.max(...values);
      const range = max - min || 1;

      // Area Path
      let dArea = `M0,${h} `;
      const points = values.map((v, i) => {
        const x = (i / (values.length - 1)) * w;
        const y = h - ((v - min) / range) * (h - 20) - 10; // Padding
        dArea += `L${x},${y} `;
        return `${x},${y}`;
      });
      dArea += `L${w},${h} Z`;

      // Line Path
      const dLine = `M${points[0]} ` + points.slice(1).map(p => `L${p}`).join(' ');

      // Gradient ID
      const gradId = 'grad-' + svgId;

      svg.innerHTML = `
        <defs>
          <linearGradient id="${gradId}" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" style="stop-color:#2563eb;stop-opacity:0.2" />
            <stop offset="100%" style="stop-color:#2563eb;stop-opacity:0" />
          </linearGradient>
        </defs>
        <path d="${dArea}" fill="url(#${gradId})" />
        <path d="${dLine}" fill="none" stroke="#2563eb" stroke-width="2" vector-effect="non-scaling-stroke"/>
        <circle cx="${points[points.length - 1].split(',')[0]}" cy="${points[points.length - 1].split(',')[1]}" r="3" fill="#2563eb" stroke="white" stroke-width="2"/>
      `;
    }

    function updateStatus() {
      const { IORB, SOFR } = store;
      if (!IORB.current || !SOFR.current) return;

      const spread = IORB.current - SOFR.current;
      const spreadBp = Math.round(spread * 100);
      const led = document.getElementById('statusLed');
      const txt = document.getElementById('statusText');

      if (spreadBp < 0) {
        led.className = 'w-2.5 h-2.5 rounded-full bg-red-500 animate-pulse';
        txt.textContent = `WARNING: INVERSION (${spreadBp}bp)`;
        txt.className = 'text-sm font-bold orbitron text-red-600';
      } else if (spreadBp <= 5) {
        led.className = 'w-2.5 h-2.5 rounded-full bg-yellow-500';
        txt.textContent = `CAUTION: NARROW SPREAD (${spreadBp}bp)`;
        txt.className = 'text-sm font-bold orbitron text-yellow-600';
      } else {
        led.className = 'w-2.5 h-2.5 rounded-full bg-green-500';
        txt.textContent = `NORMAL: HEALTHY SPREAD (${spreadBp}bp)`;
        txt.className = 'text-sm font-bold orbitron text-green-600';
      }
    }

    async function init() {
      try {
        const [iorb, effr, sofr, rrp] = await Promise.all([
          fetchLatestPair(SERIES.IORB),
          fetchLatestPair(SERIES.EFFR),
          fetchLatestPair(SERIES.SOFR),
          fetchLatestPair(SERIES.RRP)
        ]);

        store.IORB = iorb;
        store.EFFR = effr;
        store.SOFR = sofr;
        store.RRP = rrp;

        updateCard('IORB', iorb);
        updateCard('EFFR', effr);
        updateCard('SOFR', sofr);
        updateCard('RRP', rrp, true);

        updateStatus();

        const now = new Date();
        document.getElementById('updateTime').textContent = `UPDATED ${now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })}`;

      } catch (e) {
        console.error('Init failed', e);
      }
    }

    window.switchTab = function (tabName) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

      const btn = Array.from(document.querySelectorAll('.tab-btn')).find(b => b.getAttribute('onclick').includes(tabName));
      if (btn) btn.classList.add('active');

      const content = document.getElementById(`tab-${tabName}`);
      if (content) {
        content.classList.remove('hidden');
        content.classList.add('active');
      }
    }

    init();
    setInterval(init, 300000);
  </script>
</body>

</html>