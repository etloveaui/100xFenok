<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Market Sentiment | 100x Market Radar</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --extreme-fear: #7c2d12;
      --fear: #dc2626;
      --neutral: #f59e0b;
      --greed: #16a34a;
      --extreme-greed: #15803d;
      --positive: #16a34a;
      --warning: #ea580c;
      --negative: #dc2626;
      --bg-page: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      --bg-card: #ffffff;
      --bg-muted: #f8fafc;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-page);
      min-height: 100vh;
      color: var(--text-primary);
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 24px; }

    /* Loading */
    .loading-overlay {
      position: fixed; inset: 0; background: rgba(255,255,255,0.9);
      display: flex; align-items: center; justify-content: center;
      z-index: 1000; transition: opacity 0.3s;
    }
    .loading-overlay.hidden { opacity: 0; pointer-events: none; }
    .loading-spinner {
      width: 48px; height: 48px; border: 4px solid #e2e8f0;
      border-top-color: #2563eb; border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Page Header */
    .page-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid #e2e8f0;
    }
    .header-left { display: flex; align-items: center; gap: 16px; }
    .back-btn {
      width: 40px; height: 40px; border: none; background: var(--bg-card);
      border-radius: 10px; cursor: pointer; font-size: 18px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.2s;
    }
    .back-btn:hover { transform: translateX(-2px); }
    .title-group h1 { font-size: 24px; font-weight: 700; }
    .title-group p { font-size: 14px; color: var(--text-secondary); margin-top: 4px; }
    .header-right { display: flex; align-items: center; gap: 16px; }
    .status-badge {
      display: flex; align-items: center; gap: 8px;
      padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 600;
    }
    .status-badge.fear { background: #fef2f2; color: var(--fear); }
    .status-badge.greed { background: #f0fdf4; color: var(--greed); }
    .status-badge.neutral { background: #fffbeb; color: var(--neutral); }
    .update-time { font-size: 12px; color: var(--text-muted); }

    /* Hero Section - LIGHT THEME */
    .sentiment-hero {
      background: var(--bg-card);
      border: 1px solid #e2e8f0;
      border-radius: 24px;
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.05);
    }
    .hero-header { display: flex; align-items: center; gap: 12px; margin-bottom: 24px; }
    .hero-icon { font-size: 32px; }
    .hero-label {
      font-size: 14px; font-weight: 600; color: var(--text-secondary);
      text-transform: uppercase; letter-spacing: 1px;
    }
    .signal-display { text-align: center; margin-bottom: 32px; }
    .signal-score-value {
      font-family: 'Orbitron', monospace; font-size: 72px;
      font-weight: 800; line-height: 1; margin-bottom: 8px;
    }
    .signal-score-value.fear { color: var(--fear); }
    .signal-score-value.greed { color: var(--greed); }
    .signal-score-value.neutral { color: var(--neutral); }
    .signal-label {
      font-size: 18px; font-weight: 600; color: var(--text-secondary);
      display: flex; align-items: center; justify-content: center; gap: 8px;
    }

    /* Segment Bar */
    .signal-gauge { margin-bottom: 32px; }
    .segment-bar {
      display: flex; height: 20px; border-radius: 10px;
      overflow: hidden; position: relative; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }
    .segment { transition: filter 0.3s ease; }
    .seg-extreme-fear { background: linear-gradient(90deg, #7c2d12 0%, #991b1b 100%); flex: 3; }
    .seg-fear { background: #fca5a5; flex: 4; }
    .seg-neutral { background: #fcd34d; flex: 2; }
    .seg-greed { background: #86efac; flex: 4; }
    .seg-extreme-greed { background: linear-gradient(90deg, #22c55e 0%, #15803d 100%); flex: 3; }
    .gauge-marker {
      position: absolute; top: 50%; transform: translate(-50%, -50%);
      width: 6px; height: 36px; background: #1e293b; border-radius: 3px;
      box-shadow: 0 0 8px rgba(0,0,0,0.3); transition: left 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .segment-labels {
      display: flex; justify-content: space-between; margin-top: 8px; padding: 0 4px;
    }
    .segment-labels span { font-size: 12px; color: var(--text-muted); font-weight: 500; }

    /* Mini Indicators - 6ê°œ */
    .mini-indicators { display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; }
    .mini-card {
      background: var(--bg-muted); border: 1px solid #e2e8f0;
      border-radius: 12px; padding: 16px; text-align: center;
    }
    .mini-label {
      font-size: 11px; color: var(--text-secondary); margin-bottom: 6px;
      text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;
    }
    .mini-value { font-family: 'Orbitron', monospace; font-size: 18px; font-weight: 700; }
    .mini-score { font-size: 12px; font-weight: 600; margin-top: 4px; }
    .mini-value.fear, .mini-score.fear { color: var(--fear); }
    .mini-value.neutral, .mini-score.neutral { color: var(--neutral); }
    .mini-value.greed, .mini-score.greed { color: var(--greed); }

    /* 100x Sentiment Signal Section - Option C+ Enhanced Gauge */
    .signal-section {
      background: var(--bg-card); border-radius: 20px; padding: 24px;
      margin-bottom: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.05);
      border: 1px solid #e2e8f0;
    }
    .signal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 12px; }
    .signal-title { display: flex; align-items: center; gap: 10px; font-size: 20px; font-weight: 700; }
    .signal-title .tm { font-size: 10px; vertical-align: super; color: var(--text-secondary); }

    /* Split Layout */
    .signal-split { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    @media (max-width: 768px) { .signal-split { grid-template-columns: 1fr; } }

    /* Enhanced Gauge Card - ì¤‘ë¦½ í° ë°°ê²½ */
    .gauge-card {
      border-radius: 16px; padding: 24px; text-align: center;
      background: white; border: 3px solid;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    }
    .gauge-card.fear { border-color: #ef4444; }
    .gauge-card.greed { border-color: #22c55e; }

    /* Card Header with Color Badge */
    .gauge-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .gauge-title-badge {
      font-size: 13px; font-weight: 700; padding: 6px 14px;
      border-radius: 20px; display: inline-flex; align-items: center; gap: 6px;
    }
    .gauge-card.fear .gauge-title-badge { background: #fef2f2; color: #b91c1c; border: 1px solid #fecaca; }
    .gauge-card.greed .gauge-title-badge { background: #f0fdf4; color: #15803d; border: 1px solid #bbf7d0; }
    .gauge-score-badge {
      font-size: 18px; font-weight: 800; padding: 8px 16px; border-radius: 12px;
    }
    .gauge-card.fear .gauge-score-badge { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; box-shadow: 0 4px 12px rgba(239,68,68,0.3); }
    .gauge-card.greed .gauge-score-badge { background: linear-gradient(135deg, #22c55e, #16a34a); color: white; box-shadow: 0 4px 12px rgba(34,197,94,0.3); }

    /* Enhanced Gauge */
    .gauge-wrapper { position: relative; width: 200px; height: 110px; margin: 0 auto 20px; }
    .gauge-bg {
      position: absolute; top: 0; left: 0; width: 200px; height: 100px;
      border-radius: 100px 100px 0 0; overflow: hidden;
      background: linear-gradient(90deg, #ef4444 0%, #f97316 25%, #eab308 50%, #84cc16 75%, #22c55e 100%);
      box-shadow: inset 0 2px 10px rgba(0,0,0,0.1);
    }
    .gauge-inner {
      position: absolute; top: 15px; left: 15px; width: 170px; height: 85px;
      border-radius: 85px 85px 0 0; background: white;
    }
    .gauge-needle {
      position: absolute; bottom: 0; left: 50%; width: 6px; height: 85px;
      background: linear-gradient(to top, #1e293b, #334155);
      transform-origin: bottom center; transform: rotate(var(--angle, 0deg));
      border-radius: 3px; transition: transform 0.5s ease;
      box-shadow: 0 0 8px rgba(0,0,0,0.3);
    }
    .gauge-needle::before {
      content: ''; position: absolute; top: 0; left: 50%; transform: translateX(-50%);
      border-left: 8px solid transparent; border-right: 8px solid transparent;
      border-bottom: 12px solid #1e293b;
    }
    .gauge-center {
      position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%);
      width: 24px; height: 24px; background: #1e293b; border-radius: 50%;
      border: 4px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    .gauge-labels { display: flex; justify-content: space-between; padding: 0 20px; font-size: 11px; font-weight: 700; margin-top: 8px; }
    .gauge-labels .fear-label { color: #ef4444; }
    .gauge-labels .neutral-label { color: #94a3b8; }
    .gauge-labels .greed-label { color: #22c55e; }
    .gauge-status { font-size: 14px; font-weight: 600; color: #475569; margin-top: 12px; }

    /* Condition Toggle */
    .condition-toggle {
      margin-top: 20px; padding: 12px 16px; background: #f8fafc; border: 1px solid #e2e8f0;
      border-radius: 12px; cursor: pointer; font-size: 13px; font-weight: 500;
      color: #64748b; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .condition-toggle:hover { background: #f1f5f9; border-color: #cbd5e1; }
    .condition-toggle .arrow { transition: transform 0.2s; }
    .condition-toggle.open .arrow { transform: rotate(180deg); }
    .condition-list { margin-top: 12px; text-align: left; display: none; }
    .condition-list.open { display: block; }
    .condition-item {
      display: flex; align-items: center; gap: 10px; padding: 10px 14px;
      border-radius: 10px; margin-bottom: 6px; background: #f8fafc;
      border: 1px solid #e2e8f0; font-size: 13px; transition: all 0.2s;
    }
    .condition-item.passed { background: #f0fdf4; border-color: #86efac; }
    .condition-icon { width: 22px; font-size: 14px; }
    .condition-label { flex: 1; color: #475569; font-weight: 500; }
    .condition-value { font-weight: 700; color: #64748b; padding: 2px 8px; background: white; border-radius: 6px; }
    .condition-item.passed .condition-value { color: #16a34a; background: #dcfce7; }

    /* Chart Section */
    .chart-section {
      background: var(--bg-card); border-radius: 20px; padding: 24px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.05); border: 1px solid #e2e8f0;
    }
    .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 16px; }
    .chart-header h3 { font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
    .chart-controls { display: flex; align-items: center; gap: 12px; }
    .period-tabs { display: flex; background: var(--bg-muted); border-radius: 8px; padding: 4px; }
    .period-tab {
      padding: 8px 16px; border: none; background: transparent; cursor: pointer;
      font-size: 13px; font-weight: 500; color: var(--text-secondary); border-radius: 6px; transition: all 0.2s;
    }
    .period-tab.active { background: var(--bg-card); color: var(--text-primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .chart-wrapper { height: 400px; position: relative; }

    /* Info Cards */
    .info-cards-section { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-top: 24px; }
    .info-card {
      background: var(--bg-card); border-radius: 16px; padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid #e2e8f0;
      border-left: 4px solid #2563eb;
    }
    .info-card-header { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
    .info-card-icon { font-size: 20px; }
    .info-card-title { font-size: 14px; font-weight: 600; color: var(--text-primary); }
    .info-card-content { font-size: 14px; color: var(--text-secondary); line-height: 1.6; }

    /* Responsive */
    @media (max-width: 899px) {
      .info-cards-section { grid-template-columns: 1fr; }
      .mini-indicators { grid-template-columns: repeat(3, 1fr); }
    }
    @media (max-width: 599px) {
      .container { padding: 16px; }
      .page-header { flex-direction: column; align-items: flex-start; gap: 16px; }
      .header-right { width: 100%; justify-content: space-between; }
      .sentiment-hero { padding: 20px; }
      .signal-score-value { font-size: 56px; }
      .mini-indicators { grid-template-columns: repeat(2, 1fr); }
      .chart-wrapper { height: 280px; }
      .chart-controls { width: 100%; justify-content: center; }
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
  </div>

  <div class="container">
    <!-- Page Header -->
    <header class="page-header">
      <div class="header-left">
        <button class="back-btn" onclick="history.back()">â†</button>
        <div class="title-group">
          <h1>Market Sentiment</h1>
          <p>Signal Score: VIX + MOVE + CNN + CFTC + Crypto + AAII</p>
        </div>
      </div>
      <div class="header-right">
        <div class="status-badge neutral" id="statusBadge">
          <span id="statusIcon">â¡ï¸</span>
          <span id="statusText">Loading...</span>
        </div>
        <span class="update-time" id="updateTime">Loading...</span>
      </div>
    </header>

    <!-- Hero Section - LIGHT THEME -->
    <section class="sentiment-hero">
      <div class="hero-header">
        <span class="hero-icon">ğŸ­</span>
        <span class="hero-label">Market Sentiment Signal</span>
      </div>
      <div class="signal-display">
        <div class="signal-score-value neutral" id="signalScoreValue">0</div>
        <div class="signal-label">
          <span id="signalLabelIcon">â¡ï¸</span>
          <span id="signalLabelText">Loading...</span>
        </div>
      </div>
      <div class="signal-gauge">
        <div class="segment-bar">
          <div class="segment seg-extreme-fear"></div>
          <div class="segment seg-fear"></div>
          <div class="segment seg-neutral"></div>
          <div class="segment seg-greed"></div>
          <div class="segment seg-extreme-greed"></div>
          <div class="gauge-marker" id="gaugeMarker" style="left: 50%;"></div>
        </div>
        <div class="segment-labels">
          <span>-8</span><span>-5</span><span>0</span><span>+5</span><span>+8</span>
        </div>
      </div>
      <!-- Mini Indicators - 6ê°œ ê°œë³„ ì§€í‘œ -->
      <div class="mini-indicators">
        <div class="mini-card">
          <div class="mini-label">VIX</div>
          <div class="mini-value neutral" id="miniVix">-</div>
          <div class="mini-score neutral" id="miniVixScore">0</div>
        </div>
        <div class="mini-card">
          <div class="mini-label">MOVE</div>
          <div class="mini-value neutral" id="miniMove">-</div>
          <div class="mini-score neutral" id="miniMoveScore">0</div>
        </div>
        <div class="mini-card">
          <div class="mini-label">CNN F&G</div>
          <div class="mini-value neutral" id="miniCnn">-</div>
          <div class="mini-score neutral" id="miniCnnScore">0</div>
        </div>
        <div class="mini-card">
          <div class="mini-label">CFTC</div>
          <div class="mini-value neutral" id="miniCftc">-</div>
          <div class="mini-score neutral" id="miniCftcScore">0</div>
        </div>
        <div class="mini-card">
          <div class="mini-label">Crypto F&G</div>
          <div class="mini-value neutral" id="miniCrypto">-</div>
          <div class="mini-score neutral" id="miniCryptoScore">0</div>
        </div>
        <div class="mini-card">
          <div class="mini-label">AAII</div>
          <div class="mini-value neutral" id="miniAaii">-</div>
          <div class="mini-score neutral" id="miniAaiiScore">0</div>
        </div>
      </div>
    </section>

    <!-- 100x Sentiment Signal Section - Option C+ Enhanced Gauge -->
    <section class="signal-section">
      <div class="signal-header">
        <div class="signal-title">
          <span style="font-size: 24px;">âš¡</span>
          100x Sentiment Signal<span class="tm">â„¢</span>
        </div>
      </div>

      <div class="signal-split">
        <!-- Fear Gauge -->
        <div class="gauge-card fear">
          <div class="gauge-header">
            <div class="gauge-title-badge"><span>ğŸ”´</span> FEAR CONDITIONS</div>
            <div class="gauge-score-badge" id="fearCount">0/5</div>
          </div>
          <div class="gauge-wrapper">
            <div class="gauge-bg"></div>
            <div class="gauge-inner"></div>
            <div class="gauge-needle" id="fearNeedle" style="--angle: -90deg;"></div>
            <div class="gauge-center"></div>
          </div>
          <div class="gauge-labels">
            <span class="fear-label">FEAR</span>
            <span class="neutral-label">NEUTRAL</span>
            <span class="greed-label">GREED</span>
          </div>
          <div class="gauge-status" id="fearStatus">ê³µí¬ ì¡°ê±´ ì¶©ì¡±: ë‚®ìŒ</div>
          <div class="condition-toggle" id="fearToggle">
            <span class="arrow">â–¼</span> ì„¸ë¶€ ì¡°ê±´ ë³´ê¸°
          </div>
          <div class="condition-list" id="fearConditions"></div>
        </div>

        <!-- Greed Gauge -->
        <div class="gauge-card greed">
          <div class="gauge-header">
            <div class="gauge-title-badge"><span>ğŸŸ¢</span> GREED CONDITIONS</div>
            <div class="gauge-score-badge" id="greedCount">0/5</div>
          </div>
          <div class="gauge-wrapper">
            <div class="gauge-bg"></div>
            <div class="gauge-inner"></div>
            <div class="gauge-needle" id="greedNeedle" style="--angle: -90deg;"></div>
            <div class="gauge-center"></div>
          </div>
          <div class="gauge-labels">
            <span class="fear-label">FEAR</span>
            <span class="neutral-label">NEUTRAL</span>
            <span class="greed-label">GREED</span>
          </div>
          <div class="gauge-status" id="greedStatus">íƒìš• ì¡°ê±´ ì¶©ì¡±: ë‚®ìŒ</div>
          <div class="condition-toggle" id="greedToggle">
            <span class="arrow">â–¼</span> ì„¸ë¶€ ì¡°ê±´ ë³´ê¸°
          </div>
          <div class="condition-list" id="greedConditions"></div>
        </div>
      </div>
    </section>

    <!-- Chart Section -->
    <section class="chart-section">
      <div class="chart-header">
        <h3>ğŸ“ˆ Signal Score Timeline</h3>
        <div class="chart-controls">
          <div class="period-tabs">
            <button class="period-tab active" data-period="365">1Y</button>
            <button class="period-tab" data-period="1095">3Y</button>
            <button class="period-tab" data-period="max">MAX</button>
          </div>
        </div>
      </div>
      <div class="chart-wrapper"><canvas id="signalChart"></canvas></div>
    </section>

    <!-- Info Cards -->
    <div class="info-cards-section">
      <div class="info-card">
        <div class="info-card-header"><span class="info-card-icon">ğŸ“Š</span><span class="info-card-title">Signal Scoreë€?</span></div>
        <div class="info-card-content">6ê°œ ì§€í‘œ(VIX, MOVE, CNN F&G, CFTC, Crypto F&G, AAII)ë¥¼ ì¢…í•©í•˜ì—¬ -8~+8 ì ìˆ˜ë¡œ ë³€í™˜í•œ ë³µí•© ì‹¬ë¦¬ ì§€í‘œì…ë‹ˆë‹¤.</div>
      </div>
      <div class="info-card">
        <div class="info-card-header"><span class="info-card-icon">ğŸ’¡</span><span class="info-card-title">ë°”ë‹¥ í™•ì¸ì´ë€?</span></div>
        <div class="info-card-content">ì—­ì‚¬ì  ë°”ë‹¥(2020 COVID, 2022 ì¹¨ì²´)ì—ì„œ ê³µí†µ ë°œìƒí•œ ì¡°ê±´ë“¤ì…ë‹ˆë‹¤. 3ê°œ+ ì¶©ì¡± ì‹œ ê°•ë ¥í•œ ë§¤ìˆ˜ ì‹ í˜¸ì…ë‹ˆë‹¤.</div>
      </div>
      <div class="info-card">
        <div class="info-card-header"><span class="info-card-icon">ğŸ¯</span><span class="info-card-title">í™œìš© ë°©ë²•</span></div>
        <div class="info-card-content">ê·¹ë„ ê³µí¬(-5 ì´í•˜)ì—ì„œ ë¶„í•  ë§¤ìˆ˜, ê·¹ë„ íƒìš•(+5 ì´ìƒ)ì—ì„œ ìµì ˆ/ë°©ì–´ì  ì „í™˜ì„ ê³ ë ¤í•˜ì„¸ìš”.</div>
      </div>
    </div>
  </div>

  <script type="module">
    import { DataFetcher } from '../shared/data-fetcher.js';
    import { DataManager } from '../shared/data-manager.js';
    import {
      calculateSignalScore, calculateScoreBreakdown, getSignalStatus,
      getStatusLabel, getStatusLabelEn, calculateMarkerPosition, getScoreCssClass,
      checkBottomConditions, formatCftcValue, formatValue
    } from '../shared/sentiment-calculator.js';

    // ============================================
    // Main App
    // ============================================
    let sentimentData = null;
    let signalChart = null;
    let currentPeriod = 365;

    async function init() {
      try {
        const result = await DataFetcher.fetch('sentiment');
        if (result.data) {
          sentimentData = result.data;
          console.log('[Sentiment] ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', sentimentData);

          updateHero();
          updateSignalCards();
          initChart();
          updateMeta();

          // ìºì‹œ ì €ì¥
          const cacheData = buildCacheData();
          DataManager.saveWidgetData('sentiment', cacheData);
        } else {
          console.error('[Sentiment] ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
        }
      } catch (e) {
        console.error('[Sentiment] ì´ˆê¸°í™” ì˜¤ë¥˜:', e);
      } finally {
        document.getElementById('loadingOverlay').classList.add('hidden');
      }
    }

    function buildCacheData() {
      const score = calculateSignalScore(sentimentData);
      const status = getSignalStatus(score);
      return {
        score, status,
        statusLabel: getStatusLabel(status),
        statusLabelEn: getStatusLabelEn(status),
        cssClass: getScoreCssClass(score),
        ...sentimentData,
        updated: sentimentData.updated
      };
    }

    // ============================================
    // Hero Section Update
    // ============================================
    function updateHero() {
      const score = calculateSignalScore(sentimentData);
      const breakdown = calculateScoreBreakdown(sentimentData);
      const status = getSignalStatus(score);
      const cssClass = getScoreCssClass(score);
      const markerPos = calculateMarkerPosition(score);

      // Score Display
      const scoreEl = document.getElementById('signalScoreValue');
      scoreEl.textContent = score >= 0 ? `+${score}` : score;
      scoreEl.className = `signal-score-value ${cssClass}`;

      // Label
      const icons = { fear: 'ğŸ“‰', neutral: 'â¡ï¸', greed: 'ğŸ“ˆ' };
      document.getElementById('signalLabelIcon').textContent = icons[cssClass];
      document.getElementById('signalLabelText').textContent = getStatusLabelEn(status);

      // Status Badge
      const badge = document.getElementById('statusBadge');
      badge.className = `status-badge ${cssClass}`;
      document.getElementById('statusIcon').textContent = icons[cssClass];
      document.getElementById('statusText').textContent = getStatusLabelEn(status);

      // Gauge Marker
      document.getElementById('gaugeMarker').style.left = `${markerPos}%`;

      // Mini Indicators - 6ê°œ ê°œë³„ ì§€í‘œ
      updateMiniCard('miniVix', 'miniVixScore', sentimentData.vix, breakdown.vix.score, 1);
      updateMiniCard('miniMove', 'miniMoveScore', sentimentData.move, breakdown.move.score, 1);
      updateMiniCard('miniCnn', 'miniCnnScore', sentimentData.cnn, breakdown.cnn.score, 0);
      updateMiniCard('miniCftc', 'miniCftcScore', formatCftcValue(sentimentData.cftc), breakdown.cftc.score, null);
      updateMiniCard('miniCrypto', 'miniCryptoScore', sentimentData.crypto, breakdown.crypto.score, 0);

      // AAII: Bull-Bear Spread
      const aaiiBullBear = sentimentData.aaii
        ? (sentimentData.aaii.bullish - sentimentData.aaii.bearish)
        : null;
      const aaiiScore = calculateAaiiScore(aaiiBullBear);
      updateMiniCard('miniAaii', 'miniAaiiScore', aaiiBullBear !== null ? `${aaiiBullBear > 0 ? '+' : ''}${aaiiBullBear.toFixed(0)}%` : 'N/A', aaiiScore, null);
    }

    function updateMiniCard(valueId, scoreId, value, score, decimals) {
      const valueEl = document.getElementById(valueId);
      const scoreEl = document.getElementById(scoreId);

      // ê°’ í‘œì‹œ
      if (decimals !== null && typeof value === 'number') {
        valueEl.textContent = value.toFixed(decimals);
      } else {
        valueEl.textContent = value ?? 'N/A';
      }

      // ìŠ¤ì½”ì–´ í‘œì‹œ
      const scorePrefix = score > 0 ? '+' : '';
      scoreEl.textContent = `${scorePrefix}${score}`;

      // ìƒ‰ìƒ í´ë˜ìŠ¤
      const cssClass = score < 0 ? 'fear' : score > 0 ? 'greed' : 'neutral';
      valueEl.className = `mini-value ${cssClass}`;
      scoreEl.className = `mini-score ${cssClass}`;
    }

    // AAII Bull-Bear Spread ì ìˆ˜ ê³„ì‚°
    function calculateAaiiScore(spread) {
      if (spread == null) return 0;
      if (spread <= -20) return -2;  // ê·¹ë„ ì•½ì„¸
      if (spread <= -10) return -1;  // ì•½ì„¸
      if (spread >= 20) return 2;    // ê·¹ë„ ê°•ì„¸
      if (spread >= 10) return 1;    // ê°•ì„¸
      return 0;                      // ì¤‘ë¦½
    }

    // ============================================
    // 100x Sentiment Signal Cards
    // ============================================
    const FEAR_SIGNALS = [
      { key: 'vix', label: 'VIX > 30', condition: (v) => v > 30, format: (v) => v?.toFixed(1) ?? 'N/A' },
      { key: 'cnn', label: 'CNN F&G < 25', condition: (v) => v < 25, format: (v) => v?.toFixed(0) ?? 'N/A' },
      { key: 'cftc', label: 'CFTC < -150K', condition: (v) => v < -150000, format: (v) => formatCftcValue(v) },
      { key: 'move', label: 'MOVE > 120', condition: (v) => v > 120, format: (v) => v?.toFixed(1) ?? 'N/A' },
      { key: 'crypto', label: 'Crypto F&G < 20', condition: (v) => v < 20, format: (v) => v?.toFixed(0) ?? 'N/A' }
    ];

    const GREED_SIGNALS = [
      { key: 'vix', label: 'VIX < 12', condition: (v) => v < 12, format: (v) => v?.toFixed(1) ?? 'N/A' },
      { key: 'cnn', label: 'CNN F&G > 85', condition: (v) => v > 85, format: (v) => v?.toFixed(0) ?? 'N/A' },
      { key: 'cftc', label: 'CFTC > +150K', condition: (v) => v > 150000, format: (v) => formatCftcValue(v) },
      { key: 'move', label: 'MOVE < 60', condition: (v) => v < 60, format: (v) => v?.toFixed(1) ?? 'N/A' },
      { key: 'crypto', label: 'Crypto F&G > 70', condition: (v) => v > 70, format: (v) => v?.toFixed(0) ?? 'N/A' }
    ];

    function updateSignalCards() {
      const data = {
        vix: sentimentData.vix,
        cnn: sentimentData.cnn,
        cftc: sentimentData.cftc,
        move: sentimentData.move,
        crypto: sentimentData.crypto
      };

      // Fear Card
      let fearCount = 0;
      const fearHtml = FEAR_SIGNALS.map(sig => {
        const value = data[sig.key];
        const passed = value != null && sig.condition(value);
        if (passed) fearCount++;
        return `
          <div class="condition-item ${passed ? 'passed' : ''}">
            <span class="condition-icon">${passed ? 'âœ…' : 'â³'}</span>
            <span class="condition-label">${sig.label}</span>
            <span class="condition-value">${sig.format(value)}</span>
          </div>
        `;
      }).join('');
      document.getElementById('fearConditions').innerHTML = fearHtml;
      document.getElementById('fearCount').textContent = `${fearCount}/5`;

      // Fear Gauge Needle: 0/5 = 0deg (ì¤‘ë¦½), 5/5 = -90deg (ì™¼ìª½/ê³µí¬)
      // ì¡°ê±´ ì¶©ì¡± ë§ì„ìˆ˜ë¡ ì™¼ìª½(ê³µí¬)ìœ¼ë¡œ ì´ë™
      document.getElementById('fearNeedle').style.setProperty('--angle', `${-(fearCount / 5) * 90}deg`);

      // Fear Status Text
      const fearStatusText = fearCount === 0 ? 'ì—†ìŒ' : fearCount <= 2 ? 'ë‚®ìŒ' : fearCount <= 3 ? 'ë³´í†µ' : 'ë†’ìŒ';
      document.getElementById('fearStatus').textContent = `ê³µí¬ ì¡°ê±´ ì¶©ì¡±: ${fearStatusText}`;

      // Greed Card
      let greedCount = 0;
      const greedHtml = GREED_SIGNALS.map(sig => {
        const value = data[sig.key];
        const passed = value != null && sig.condition(value);
        if (passed) greedCount++;
        return `
          <div class="condition-item ${passed ? 'passed' : ''}">
            <span class="condition-icon">${passed ? 'âœ…' : 'â³'}</span>
            <span class="condition-label">${sig.label}</span>
            <span class="condition-value">${sig.format(value)}</span>
          </div>
        `;
      }).join('');
      document.getElementById('greedConditions').innerHTML = greedHtml;
      document.getElementById('greedCount').textContent = `${greedCount}/5`;

      // Greed Gauge Needle: 0/5 = 0deg (ì¤‘ë¦½), 5/5 = +90deg (ì˜¤ë¥¸ìª½/íƒìš•)
      // ì¡°ê±´ ì¶©ì¡± ë§ì„ìˆ˜ë¡ ì˜¤ë¥¸ìª½(íƒìš•)ìœ¼ë¡œ ì´ë™
      document.getElementById('greedNeedle').style.setProperty('--angle', `${(greedCount / 5) * 90}deg`);

      // Greed Status Text
      const greedStatusText = greedCount === 0 ? 'ì—†ìŒ' : greedCount <= 2 ? 'ë‚®ìŒ' : greedCount <= 3 ? 'ë³´í†µ' : 'ë†’ìŒ';
      document.getElementById('greedStatus').textContent = `íƒìš• ì¡°ê±´ ì¶©ì¡±: ${greedStatusText}`;

      // Setup toggles
      setupConditionToggles();
    }

    function setupConditionToggles() {
      const fearToggle = document.getElementById('fearToggle');
      const greedToggle = document.getElementById('greedToggle');
      const fearConditions = document.getElementById('fearConditions');
      const greedConditions = document.getElementById('greedConditions');

      fearToggle.onclick = () => {
        fearToggle.classList.toggle('open');
        fearConditions.classList.toggle('open');
      };

      greedToggle.onclick = () => {
        greedToggle.classList.toggle('open');
        greedConditions.classList.toggle('open');
      };
    }

    // ============================================
    // Chart
    // ============================================
    function initChart() {
      const ctx = document.getElementById('signalChart').getContext('2d');
      const history = sentimentData.history;

      if (!history || !history.vix || history.vix.length === 0) {
        console.warn('[Sentiment] íˆìŠ¤í† ë¦¬ ë°ì´í„° ì—†ìŒ');
        return;
      }

      const dates = [];
      const scores = [];

      // VIX ë°ì´í„° ê¸°ì¤€ìœ¼ë¡œ ë‚ ì§œ ì¶”ì¶œ
      const startIdx = currentPeriod === 9999 ? 0 : Math.max(0, history.vix.length - currentPeriod);

      for (let i = startIdx; i < history.vix.length; i++) {
        const date = history.vix[i].date;
        const vixVal = history.vix[i].value;  // value í•„ë“œ ì‚¬ìš©

        // ê°™ì€ ë‚ ì§œì˜ ë‹¤ë¥¸ ì§€í‘œ ì°¾ê¸°
        const moveVal = findValueByDate(history.move, date, 'value');
        const cftcVal = findValueByDate(history.cftc, date, 'net');
        const cnnVal = findValueByDate(history.cnn, date, 'score');  // score í•„ë“œ!
        const cryptoVal = findValueByDate(history.crypto, date, 'value');

        if (vixVal != null) {
          const score = calculateSignalScore({
            vix: vixVal,
            move: moveVal,
            cftc: cftcVal,
            cnn: cnnVal,
            crypto: cryptoVal
          });
          dates.push(date);
          scores.push(score);
        }
      }

      const config = {
        type: 'line',
        data: {
          labels: dates,
          datasets: [{
            label: 'Signal Score',
            data: scores,
            borderColor: '#2563eb',
            borderWidth: 2,
            backgroundColor: (context) => {
              const value = context.raw;
              return value < 0 ? 'rgba(239, 68, 68, 0.1)' : 'rgba(34, 197, 94, 0.1)';
            },
            fill: true,
            tension: 0.3,
            pointRadius: 0,
            pointHoverRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { intersect: false, mode: 'index' },
          scales: {
            x: {
              type: 'time',
              time: { unit: 'month', displayFormats: { month: 'MMM yy' } },
              grid: { display: false }
            },
            y: {
              min: -8, max: 8,
              grid: { color: 'rgba(0,0,0,0.05)' }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(15, 23, 42, 0.9)',
              padding: 12, cornerRadius: 8,
              callbacks: { label: (ctx) => `Signal Score: ${ctx.parsed.y}` }
            },
            annotation: {
              annotations: {
                zeroLine: { type: 'line', yMin: 0, yMax: 0, borderColor: '#f59e0b', borderWidth: 2, borderDash: [5, 5] },
                extremeFearZone: { type: 'box', yMin: -8, yMax: -5, backgroundColor: 'rgba(124, 45, 18, 0.08)', borderWidth: 0 },
                extremeGreedZone: { type: 'box', yMin: 5, yMax: 8, backgroundColor: 'rgba(21, 128, 61, 0.08)', borderWidth: 0 }
              }
            }
          }
        }
      };

      if (signalChart) signalChart.destroy();
      signalChart = new Chart(ctx, config);

      // Period tabs
      document.querySelectorAll('.period-tab').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.period-tab').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          const period = btn.dataset.period;
          currentPeriod = period === 'max' ? 9999 : parseInt(period);
          initChart();
        });
      });
    }

    function findValueByDate(arr, date, field = 'value') {
      if (!Array.isArray(arr)) return null;
      const item = arr.find(d => d.date === date);
      if (item) return item[field] ?? null;
      return null;
    }

    // ============================================
    // Meta Update
    // ============================================
    function updateMeta() {
      const now = new Date();
      const pad = n => n.toString().padStart(2, '0');
      document.getElementById('updateTime').textContent =
        `Updated: ${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}`;
    }

    // Initialize
    init();
  </script>
</body>
</html>
