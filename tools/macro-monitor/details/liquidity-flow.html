<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Liquidity Flow Monitor | 100xFenok</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1/dist/chartjs-plugin-annotation.min.js"></script>

  <!-- Constants & DataManager ES Module import -->
  <script type="module">
    import { DataManager } from '../shared/data-manager.js';
    import { THRESHOLDS, COLORS } from '../shared/constants.js';
    import { getRecessionAnnotations } from '../shared/chart-annotations.js';
    window.DataManager = DataManager;
    window.THRESHOLDS = THRESHOLDS;
    window.COLORS = COLORS;
    window.getRecessionAnnotations = getRecessionAnnotations;
  </script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      color: #1e293b;
      min-height: 100vh;
      display: flex; justify-content: center;
    }
    .container { width: 100%; max-width: 1000px; padding: 32px 20px; }

    /* ===== Header ===== */
    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
    .header-left { display: flex; align-items: center; gap: 16px; }
    .back-btn { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: #fff; border: 1px solid #cbd5e1; border-radius: 12px; color: #64748b; cursor: pointer; transition: all 0.2s ease; }
    .back-btn:hover { background: #f1f5f9; color: #0f172a; transform: translateY(-1px); }
    .title-group h1 { font-family: 'Orbitron', sans-serif; font-size: 22px; font-weight: 700; color: #0f172a; margin-bottom: 4px; }
    .title-group p { font-size: 13px; color: #64748b; font-weight: 500; }

    .header-right { text-align: right; }
    .status-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
    .status-dot { width: 8px; height: 8px; background: #166534; border-radius: 50%; animation: pulse 2s infinite; }
    .update-time { display: block; margin-top: 6px; font-family: 'Orbitron', sans-serif; font-size: 11px; color: #94a3b8; }

    /* ===== Signal Matrix (3ê°œ ì§€í‘œ) ===== */
    .signal-matrix {
      background: #ffffff;
      border-radius: 24px;
      border: 1px solid #e2e8f0;
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05);
      padding: 24px;
      margin-bottom: 24px;
    }
    .matrix-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }
    .signal-card {
      background: #f8fafc;
      border-radius: 16px;
      padding: 16px;
      border: 1px solid #e2e8f0;
      text-align: center;
      transition: all 0.2s;
    }
    .signal-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .signal-icon {
      width: 48px;
      height: 48px;
      margin: 0 auto 12px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }
    .signal-icon.green { background: #dcfce7; color: #16a34a; }
    .signal-icon.yellow { background: #fef9c3; color: #ca8a04; }
    .signal-icon.red { background: #fee2e2; color: #dc2626; }
    .signal-icon.gray { background: #f1f5f9; color: #94a3b8; }

    .signal-label {
      font-size: 11px;
      font-weight: 700;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }
    .signal-value {
      font-family: 'Orbitron', sans-serif;
      font-size: 20px;
      font-weight: 700;
      color: #0f172a;
    }
    .signal-unit {
      font-size: 12px;
      color: #64748b;
      margin-left: 2px;
    }
    .signal-status {
      margin-top: 8px;
      font-size: 11px;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 12px;
      display: inline-block;
    }
    .signal-status.normal { background: #dcfce7; color: #166534; }
    .signal-status.caution { background: #fef9c3; color: #854d0e; }
    .signal-status.danger { background: #fee2e2; color: #991b1b; }

    /* Signal Card í™•ì¥ (ê°’+í™”ì‚´í‘œ+ì„œë¸Œí…ìŠ¤íŠ¸+ìŠ¤íŒŒí¬ë¼ì¸) */
    .signal-value-row {
      display: flex;
      align-items: baseline;
      justify-content: center;
      gap: 2px;
    }
    .signal-subtext {
      font-size: 10px;
      color: #94a3b8;
      margin-top: 2px;
    }

    /* ===== Liquidity Pulse Hero ===== */
    .net-flow-hero {
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      border-radius: 16px;
      padding: 20px 24px;
      margin-top: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .net-flow-label {
      font-size: 13px;
      color: #94a3b8;
      font-weight: 600;
    }
    .net-flow-value {
      font-family: 'Orbitron', sans-serif;
      font-size: 32px;
      font-weight: 700;
      color: #fff;
    }
    .net-flow-value.positive { color: #4ade80; }
    .net-flow-value.negative { color: #f87171; }
    .net-flow-trend {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: #94a3b8;
    }
    .net-flow-trend i {
      font-size: 16px;
    }
    .net-flow-trend.up i { color: #4ade80; }
    .net-flow-trend.down i { color: #f87171; }

    /* ===== Chart Section ===== */
    .dashboard-card {
      background: #ffffff;
      border-radius: 24px;
      border: 1px solid #e2e8f0;
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05);
      padding: 32px;
      margin-bottom: 24px;
    }

    /* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */
    .chart-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      background: #f1f5f9;
      padding: 4px;
      border-radius: 12px;
    }
    .chart-tab {
      flex: 1;
      border: none;
      background: transparent;
      padding: 12px 16px;
      font-size: 13px;
      font-weight: 600;
      color: #64748b;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    .chart-tab:hover { color: #1e293b; }
    .chart-tab.active {
      background: #ffffff;
      color: #2563eb;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .chart-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .chart-title { font-size: 14px; font-weight: 600; color: #475569; display: flex; align-items: center; gap: 8px; }
    .period-selector { display: flex; gap: 4px; background: #f8fafc; padding: 4px; border-radius: 8px; border: 1px solid #e2e8f0; }
    .p-btn { border: none; background: none; padding: 6px 12px; font-size: 11px; font-weight: 600; color: #64748b; cursor: pointer; border-radius: 6px; transition: all 0.2s; }
    .p-btn:hover { background: #fff; color: #0f172a; }
    .p-btn.active { background: #ffffff; color: #2563eb; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

    .chart-wrapper { position: relative; height: 340px; width: 100%; }

    .custom-legend { display: flex; justify-content: center; gap: 24px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #f1f5f9; }
    .legend-item { display: flex; align-items: center; gap: 6px; font-size: 12px; color: #64748b; font-weight: 500; }
    .legend-color { width: 12px; height: 12px; border-radius: 3px; }

    /* ===== Info Cards ===== */
    .info-cards-section {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }
    .info-card {
      background: #ffffff;
      border: 1px solid #e2e8f0;
      border-radius: 16px;
      padding: 20px;
      border-left: 4px solid #10b981;
      transition: all 0.2s ease;
    }
    .info-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .info-card.inflow { border-left-color: #10b981; }
    .info-card.neutral { border-left-color: #f59e0b; }
    .info-card.outflow { border-left-color: #ef4444; }

    .info-card-header { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; }
    .info-card-icon { font-size: 18px; }
    .info-card-title { flex: 1; font-size: 13px; font-weight: 700; color: #334155; }
    .info-expand-btn {
      width: 28px; height: 28px;
      border: none; background: #f1f5f9;
      border-radius: 8px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      color: #64748b; transition: all 0.2s;
    }
    .info-expand-btn:hover { background: #e2e8f0; color: #334155; }
    .info-expand-btn i { transition: transform 0.3s ease; }
    .info-card.expanded .info-expand-btn i { transform: rotate(180deg); }

    .info-card-summary { font-size: 13px; color: #475569; line-height: 1.5; }
    .info-value { font-family: 'Orbitron', sans-serif; font-weight: 600; color: #2563eb; }

    .info-card-detail {
      max-height: 0; overflow: hidden;
      transition: max-height 0.3s ease, margin-top 0.3s ease, opacity 0.3s ease;
      opacity: 0;
    }
    .info-card.expanded .info-card-detail { max-height: 500px; margin-top: 16px; opacity: 1; }

    .info-detail-section { padding: 12px 0; border-top: 1px solid #f1f5f9; }
    .info-detail-section:first-child { padding-top: 0; border-top: none; }
    .info-detail-title { font-size: 11px; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
    .info-detail-list { list-style: none; padding: 0; margin: 0; }
    .info-detail-list li { font-size: 12px; color: #475569; padding: 4px 0; line-height: 1.4; }
    .info-detail-text { font-size: 12px; color: #475569; line-height: 1.6; margin: 0; }

    .info-links { display: flex; gap: 12px; padding-top: 12px; border-top: 1px solid #f1f5f9; margin-top: 12px; }
    .info-links a { font-size: 11px; color: #2563eb; text-decoration: none; display: flex; align-items: center; gap: 4px; }
    .info-links a:hover { text-decoration: underline; }

    /* ===== Responsive ===== */
    @media (max-width: 899px) {
      .matrix-grid { grid-template-columns: repeat(3, 1fr); }
      .info-cards-section { grid-template-columns: 1fr; }
      .net-flow-hero { flex-direction: column; text-align: center; gap: 12px; }
    }
    @media (max-width: 599px) {
      .matrix-grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 599px) {
      .container { padding: 16px; }
      .page-header { flex-direction: column; align-items: flex-start; gap: 16px; }
      .header-right { width: 100%; display: flex; justify-content: space-between; align-items: center; }
      .chart-tabs { flex-wrap: wrap; }
      .chart-tab { font-size: 11px; padding: 10px 12px; }
      .period-selector { display: flex; flex-wrap: wrap; gap: 3px; justify-content: center; }
      .p-btn { padding: 5px 8px; font-size: 10px; }
      .chart-wrapper { height: 280px; }
    }
    @media (min-width: 900px) {
      .info-card-detail { max-height: 500px; opacity: 1; margin-top: 16px; }
      .info-expand-btn { display: none; }
      .info-card-title { font-size: 15px; }
      .info-card-summary { font-size: 15px; }
      .info-detail-list li { font-size: 14px; }
    }

    @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(0.9); } 100% { opacity: 1; transform: scale(1); } }
  </style>
</head>
<body>

<div class="container">
  <header class="page-header">
    <div class="header-left">
      <button class="back-btn" onclick="history.back()"><i class="fas fa-arrow-left"></i></button>
      <div class="title-group">
        <h1>Liquidity Flow Monitor</h1>
        <p>Fed Net Liquidity = WALCL - TGA - RRP</p>
      </div>
    </div>
    <div class="header-right">
      <div class="status-badge" id="statusBadge"><span class="status-dot"></span> <span id="statusText">Analyzing...</span></div>
      <span class="update-time" id="updateTime">Last Update: --:--</span>
    </div>
  </header>

  <!-- ===== Signal Matrix (3ê°œ ì§€í‘œ) ===== -->
  <section class="signal-matrix">
    <div class="matrix-grid">
      <!-- M2 YoY (% ë³€í™”ìœ¨ì´ ë©”ì¸) -->
	  <div class="signal-card" id="m2Card">
        <div class="signal-icon gray" id="m2Icon"><i class="fas fa-coins"></i></div>
        <div class="signal-label">M2 YoY</div>
        <div class="signal-value-row">
          <span class="signal-value" id="m2Value">--</span>
          <span class="signal-unit">%</span>
        </div>
        <div class="signal-subtext" id="m2Sub">$--T</div>
        <div class="signal-status" id="m2Status">Loading</div>
      </div>
      <!-- Net Liquidity (ì£¼ê°„ ë³€í™”ê°€ ë©”ì¸) -->
      <div class="signal-card" id="netLiqCard">
        <div class="signal-icon gray" id="netLiqIcon"><i class="fas fa-water"></i></div>
        <div class="signal-label">Net Liquidity</div>
        <div class="signal-value-row">
          <span class="signal-value" id="netLiqValue">--</span>
          <span class="signal-unit">$B</span>
        </div>
        <div class="signal-subtext" id="netLiqSub">$--T</div>
        <div class="signal-status" id="netLiqStatus">Loading</div>
      </div>
      <!-- SC/M2 Ratio (ë¹„ìœ¨ì´ ë©”ì¸) -->
      <div class="signal-card" id="scCard">
        <div class="signal-icon gray" id="scIcon"><i class="fab fa-bitcoin"></i></div>
        <div class="signal-label">SC/M2</div>
        <div class="signal-value-row">
          <span class="signal-value" id="scValue">--</span>
          <span class="signal-unit">%</span>
        </div>
        <div class="signal-subtext" id="scSub">$--B</div>
        <div class="signal-status" id="scStatus">Loading</div>
      </div>
    </div>

    <!-- Liquidity Pulse Hero -->
    <div class="net-flow-hero">
      <div>
        <div class="net-flow-label">Weekly Net Liquidity Flow</div>
        <div class="net-flow-value" id="netFlowValue">$--B</div>
      </div>
      <div class="net-flow-trend" id="netFlowTrend">
        <i class="fas fa-arrow-right"></i>
        <span id="netFlowDesc">Calculating...</span>
      </div>
    </div>
  </section>

  <!-- ===== Chart Section ===== -->
  <section class="dashboard-card">
    <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ (3ê°œ: Liquidity Pulse, Credit Flow, Crypto Bridge) -->
    <div class="chart-tabs" id="chartTabs">
      <button class="chart-tab active" data-tab="pulse" onclick="switchTab('pulse', this)">
        <i class="fas fa-bolt"></i> Liquidity Pulse
      </button>
      <button class="chart-tab" data-tab="credit" onclick="switchTab('credit', this)">
        <i class="fas fa-coins"></i> Credit Flow
      </button>
      <button class="chart-tab" data-tab="crypto" onclick="switchTab('crypto', this)">
        <i class="fab fa-bitcoin"></i> Crypto Bridge
      </button>
    </div>

    <div class="chart-controls">
      <div class="chart-title"><i class="fas fa-chart-bar"></i> <span id="chartTitleText">Net Liquidity Flow</span></div>
      <div class="period-selector">
        <button class="p-btn" onclick="updatePeriod(30, this)">1M</button>
        <button class="p-btn" onclick="updatePeriod(90, this)">3M</button>
        <button class="p-btn active" onclick="updatePeriod(180, this)">6M</button>
        <button class="p-btn" onclick="updatePeriod(365, this)">1Y</button>
        <button class="p-btn" onclick="updatePeriod(1095, this)">3Y</button>
        <button class="p-btn" onclick="updatePeriod(1825, this)">5Y</button>
        <button class="p-btn" onclick="updatePeriod(2925, this)">MAX</button>
      </div>
    </div>

    <div class="chart-wrapper" id="chartWrapper">
      <canvas id="mainChart"></canvas>
    </div>

    <div class="custom-legend" id="chartLegend">
      <div class="legend-item"><div class="legend-color" style="background: #10b981;"></div><span>Inflow (+)</span></div>
      <div class="legend-item"><div class="legend-color" style="background: #ef4444;"></div><span>Outflow (-)</span></div>
      <div class="legend-item"><div class="legend-color" style="background: #94a3b8; height: 2px;"></div><span>4-Week MA</span></div>
    </div>
  </section>

  <!-- ===== Info Cards ===== -->
  <div class="info-cards-section">
    <!-- ì¹´ë“œ 1: í˜„ì¬ ìƒíƒœ -->
    <div class="info-card inflow" id="statusCard">
      <div class="info-card-header">
        <div class="info-card-icon">ğŸ“Š</div>
        <div class="info-card-title">í˜„ì¬ ìœ ë™ì„± ìƒíƒœ</div>
        <button class="info-expand-btn" onclick="toggleInfoCard('statusCard')">
          <i class="fas fa-chevron-down"></i>
        </button>
      </div>
      <div class="info-card-summary" id="statusSummary">
        ë°ì´í„° ë¡œë”© ì¤‘...
      </div>
      <div class="info-card-detail">
        <div class="info-detail-section">
          <div class="info-detail-title">ì£¼ê°„ ë³€í™”</div>
          <ul class="info-detail-list" id="weeklyChanges">
            <li>M2: --</li>
            <li>TGA: --</li>
            <li>RRP: --</li>
          </ul>
        </div>
        <div class="info-links">
          <a href="https://fred.stlouisfed.org/series/M2SL" target="_blank"><i class="fas fa-external-link-alt"></i> M2 (FRED)</a>
          <a href="https://fred.stlouisfed.org/series/WTREGEN" target="_blank"><i class="fas fa-external-link-alt"></i> TGA (FRED)</a>
        </div>
      </div>
    </div>

    <!-- ì¹´ë“œ 2: ì´ ì§€í‘œê°€ ë­”ê°€ìš”? -->
    <div class="info-card neutral" id="whatCard">
      <div class="info-card-header">
        <div class="info-card-icon">ğŸ’¡</div>
        <div class="info-card-title">Fed Net Liquidityê°€ ë­”ê°€ìš”?</div>
        <button class="info-expand-btn" onclick="toggleInfoCard('whatCard')">
          <i class="fas fa-chevron-down"></i>
        </button>
      </div>
      <div class="info-card-summary">
        Fedê°€ ì‹œì¥ì— ì‹¤ì œë¡œ ê³µê¸‰í•˜ëŠ” ìœ ë™ì„± ê·œëª¨
      </div>
      <div class="info-card-detail">
        <div class="info-detail-section">
          <ul class="info-detail-list">
            <li><strong>WALCL</strong>: Fed Balance Sheet (ì´ìì‚°)</li>
            <li><strong>TGA</strong>: ì¬ë¬´ë¶€ ê³„ì¢Œ (ì •ë¶€ ì˜ˆê¸ˆ)</li>
            <li><strong>RRP</strong>: ì—­ë ˆí¬ (ìœ ë™ì„± í¡ìˆ˜)</li>
          </ul>
        </div>
        <div class="info-detail-section">
          <p class="info-detail-text">
            <strong>Net Liquidity</strong> = Fed BS - TGA - RRP<br>
            Fedì˜ ì´ìì‚°ì—ì„œ TGAì™€ RRPë¥¼ ë¹¼ë©´ ì‹¤ì œ ì‹œì¥ì— í’€ë¦° ìœ ë™ì„±ì…ë‹ˆë‹¤.
          </p>
        </div>
      </div>
    </div>

    <!-- ì¹´ë“œ 3: ì™œ ì¤‘ìš”í•œê°€ìš”? -->
    <div class="info-card neutral" id="whyCard">
      <div class="info-card-header">
        <div class="info-card-icon">ğŸ¯</div>
        <div class="info-card-title">ì™œ ì¤‘ìš”í•œê°€ìš”?</div>
        <button class="info-expand-btn" onclick="toggleInfoCard('whyCard')">
          <i class="fas fa-chevron-down"></i>
        </button>
      </div>
      <div class="info-card-summary">
        ìœ ë™ì„±ì€ ëª¨ë“  ìì‚° ê°€ê²©ì˜ ì—°ë£Œì…ë‹ˆë‹¤
      </div>
      <div class="info-card-detail">
        <div class="info-detail-section">
          <div class="info-detail-title">í•µì‹¬ ë©”ì»¤ë‹ˆì¦˜</div>
          <ul class="info-detail-list">
            <li>ìœ ë™ì„± ì¦ê°€ â†’ ìœ„í—˜ìì‚° ìƒìŠ¹</li>
            <li>ìœ ë™ì„± ê°ì†Œ â†’ ìœ„í—˜ìì‚° í•˜ë½</li>
            <li>RRP ì†Œì§„ â†’ QT ì¢…ë£Œ ì••ë ¥</li>
          </ul>
        </div>
        <div class="info-detail-section">
          <div class="info-detail-title">Crypto Rotation</div>
          <p class="info-detail-text">
            M2 ì¦ê°€ë¶„ ëŒ€ë¹„ ìŠ¤í…Œì´ë¸”ì½”ì¸ ì¦ê°€ë¶„ì˜ ë¹„ìœ¨.<br>
            10% ì´ìƒì´ë©´ í¬ë¦½í†  ì‹œì¥ìœ¼ë¡œ ìê¸ˆì´ ì ê·¹ ìœ ì… ì¤‘.
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // ===== ì„ê³„ê°’ í—¬í¼ - constants.js THRESHOLDS ì‚¬ìš© (fallback í¬í•¨) =====
  const getThreshold = (category, level) => {
    if (typeof THRESHOLDS !== 'undefined' && THRESHOLDS[category]) {
      return THRESHOLDS[category][level];
    }
    // Fallback values
    const fallback = {
      M2_YOY: { POSITIVE: 6, NEUTRAL: 2, NEGATIVE: 2 },
      NET_LIQUIDITY: { POSITIVE: 50, NEUTRAL: 50, NEGATIVE: -50 },
      STABLECOIN: { POSITIVE: 350, NEUTRAL: 250, NEGATIVE: 250 },
      OVERALL: { EXPANDING: { netLiq: 50, m2YoY: 4 }, CONTRACTING: { netLiq: -50, m2YoY: 2 } }
    };
    return fallback[category]?.[level];
  };

  // ìƒ‰ìƒ í—¬í¼ - constants.js COLORS ì‚¬ìš© (fallback í¬í•¨)
  const getColor = (category, key) => {
    if (typeof COLORS !== 'undefined' && COLORS[category]) {
      return COLORS[category][key];
    }
    // Fallback
    const fallback = {
      CHART: { M2: '#3b82f6', NET_LIQ: '#10b981', TGA: '#f59e0b', RRP: '#ef4444' }
    };
    return fallback[category]?.[key];
  };

  // ===== CONFIG =====
  const CONFIG = {
    fredApiKey: '6dda7dc3956a2c1d6ac939133de115f1',
    proxy: 'https://fed-proxy.etloveaui.workers.dev/',
    defiLlamaUrl: 'https://stablecoins.llama.fi/stablecoins?includePrices=false',
    colors: {
      inflow: getColor('CHART', 'NET_LIQ') || '#10b981',
      outflow: '#ef4444',
      ma: '#94a3b8',
      m2: getColor('CHART', 'M2') || '#3b82f6',
      tga: getColor('CHART', 'TGA') || '#8b5cf6',
      rrp: getColor('CHART', 'RRP') || '#f59e0b',
      stablecoin: '#06b6d4'
    }
  };

  // ===== DATA FETCH =====
  async function fetchData(url) {
    // ì´ë¯¸ í”„ë¡ì‹œ URLì¸ì§€ í™•ì¸
    const isProxyUrl = url.includes('fed-proxy.etloveaui.workers.dev');

    // í”„ë¡ì‹œ URLì´ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©, ì•„ë‹ˆë©´ fallback í›„ë³´ ìƒì„±
    const candidates = isProxyUrl
      ? [url]  // í”„ë¡ì‹œ URLì€ ì¬ì‹œë„ ì—†ì´ 1íšŒë§Œ
      : [
          url,
          CONFIG.proxy + url.replace(/^https?:\/\//, ''),
          'https://cors.isomorphic-git.org/' + url
        ];

    for (const u of candidates) {
      try {
        const res = await fetch(u);
        if (res.ok) return await res.json();
        console.log('[Fetch] HTTP', res.status, u);
      } catch (e) { console.log('[Fetch] Network error:', u); }
    }
    return null;
  }

  async function getFredSeries(seriesId, days) {
    const end = new Date().toISOString().split('T')[0];
    const start = new Date(Date.now() - days * 86400000).toISOString().split('T')[0];
    const url = `https://fed-proxy.etloveaui.workers.dev/fred/series/observations?series_id=${seriesId}&api_key=${CONFIG.fredApiKey}&file_type=json&observation_start=${start}&observation_end=${end}&sort_order=asc`;

    const json = await fetchData(url);
    if (!json?.observations) return [];
    return json.observations
      .filter(o => o.value !== '.')
      .map(o => ({ date: o.date, val: parseFloat(o.value) }));
  }

  async function getStablecoinData() {
    // â˜… ì‹œê³„ì—´ API ì‚¬ìš© (ì¼ê°„ ë°ì´í„°, 2017ë…„~í˜„ì¬)
    const chartUrl = 'https://stablecoins.llama.fi/stablecoincharts/all';
    const json = await fetchData(chartUrl);

    if (!json || !Array.isArray(json) || json.length === 0) {
      console.warn('[SC] ì‹œê³„ì—´ API ì‹¤íŒ¨, í˜„ì¬ê°’ APIë¡œ fallback');
      // Fallback: í˜„ì¬ê°’ë§Œ ê°€ì ¸ì˜¤ê¸°
      const fallbackJson = await fetchData(CONFIG.defiLlamaUrl);
      if (!fallbackJson?.peggedAssets) return null;
      const total = fallbackJson.peggedAssets.reduce((sum, asset) => {
        return sum + (asset.circulating?.peggedUSD || 0);
      }, 0);
      return { totalMarketCap: total / 1e9, historical: null };
    }

    // ì‹œê³„ì—´ ë°ì´í„°ë¥¼ Mapìœ¼ë¡œ ë³€í™˜ (ë‚ ì§œ â†’ ì‹œì´)
    const historicalMap = new Map();
    json.forEach(item => {
      const timestamp = parseInt(item.date);
      const dateStr = new Date(timestamp * 1000).toISOString().split('T')[0];
      const mcap = (item.totalCirculatingUSD?.peggedUSD || 0) / 1e9; // billions
      historicalMap.set(dateStr, mcap);
    });

    // ìµœì‹  ê°’
    const lastItem = json[json.length - 1];
    const latestMcap = (lastItem.totalCirculatingUSD?.peggedUSD || 0) / 1e9;

    console.log(`[SC] ì‹œê³„ì—´ ë¡œë“œ ì™„ë£Œ: ${historicalMap.size}ì¼, ìµœì‹ : $${latestMcap.toFixed(1)}B`);

    return {
      totalMarketCap: latestMcap,
      historical: historicalMap  // ë‚ ì§œë³„ ì‹œì´
    };
  }

  // ===== DATA PROCESSING =====
  // Net Liquidity ì •ì‹ ê³µì‹: Fed Balance Sheet (WALCL) - TGA - RRP
  function processData(m2, tga, rrp, walcl, stablecoin) {
    // M2: Monthly â†’ Weekly (forward fill)
    // TGA: Weekly (WTREGEN) - millions
    // RRP: Daily â†’ Weekly (RRPONTSYD) - millions
    // WALCL: Weekly (Fed Balance Sheet) - millions â˜… ì‹ ê·œ

    // ê³µí†µ ë‚ ì§œ ê¸°ì¤€: TGA (ì£¼ê°„ ë°ì´í„°)
    const tgaMap = new Map(tga.map(d => [d.date, d.val]));
    const m2Map = new Map(m2.map(d => [d.date, d.val]));
    const rrpMap = new Map(rrp.map(d => [d.date, d.val]));
    const walclMap = new Map(walcl.map(d => [d.date, d.val]));

    let lastM2 = m2.length > 0 ? m2[0].val : 21000; // billions default
    let lastRrp = rrp.length > 0 ? rrp[0].val : 0;
    let lastWalcl = walcl.length > 0 ? walcl[0].val : 7000000; // millions default (~$7T)

    const timeline = tga.map(t => {
      const d = t.date;

      // M2: forward fill (ì›”ê°„ â†’ ì£¼ê°„)
      if (m2Map.has(d)) lastM2 = m2Map.get(d);

      // RRP: forward fill (ì¼ê°„ â†’ ì£¼ê°„)
      if (rrpMap.has(d)) lastRrp = rrpMap.get(d);

      // WALCL: forward fill (ì£¼ê°„ â†’ ì£¼ê°„, ë‚ ì§œ ë¶ˆì¼ì¹˜ ëŒ€ë¹„)
      if (walclMap.has(d)) lastWalcl = walclMap.get(d);

      const tgaB = t.val / 1000;        // millions â†’ billions
      const rrpB = lastRrp / 1000;      // millions â†’ billions
      const walclB = lastWalcl / 1000;  // millions â†’ billions

      // â˜… Net Liquidity ì •ì‹ ê³µì‹: Fed BS - TGA - RRP
      const netLiquidity = walclB - tgaB - rrpB;

      return {
        date: d,
        m2: lastM2,           // billions
        tga: tgaB,            // billions
        rrp: rrpB,            // billions
        walcl: walclB,        // billions (Fed Balance Sheet)
        netLiquidity          // billions (ì •ì‹ ê³µì‹)
      };
    });

    // ì£¼ê°„ ë³€í™”ëŸ‰ ê³„ì‚°
    const weeklyData = [];
    for (let i = 1; i < timeline.length; i++) {
      const prev = timeline[i - 1];
      const curr = timeline[i];

      const m2Delta = curr.m2 - prev.m2;
      const tgaDelta = -(curr.tga - prev.tga);  // TGA ê°ì†Œ = ì‹œì¥ ìœ ì…
      const rrpDelta = -(curr.rrp - prev.rrp);  // RRP ê°ì†Œ = ì‹œì¥ ìœ ì…
      const walclDelta = curr.walcl - prev.walcl;  // Fed BS ì¦ê°€ = ì‹œì¥ ìœ ì…

      // â˜… Net Liquidity ì •ì‹ ë¸íƒ€: WALCLë³€í™” - TGAë³€í™” - RRPë³€í™”
      // ë˜ëŠ” ê°„ë‹¨íˆ: í˜„ì¬ netLiquidity - ì´ì „ netLiquidity
      const netLiquidityDelta = curr.netLiquidity - prev.netLiquidity;

      // ê¸°ì¡´ í˜¸í™˜ìš© netFlow (M2+TGAë°©ì¶œ+RRPë°©ì¶œ) - ê·¼ì‚¬ì¹˜
      const netFlow = m2Delta + tgaDelta + rrpDelta;

      weeklyData.push({
        date: curr.date,
        m2: curr.m2,
        tga: curr.tga,
        rrp: curr.rrp,
        walcl: curr.walcl,
        netLiquidity: curr.netLiquidity,
        m2Delta,
        tgaDelta,
        rrpDelta,
        walclDelta,
        netLiquidityDelta,  // â˜… ì •ì‹ ê³µì‹ ë¸íƒ€
        netFlow             // ê¸°ì¡´ í˜¸í™˜ìš© (ê·¼ì‚¬ì¹˜)
      });
    }

    // 4ì£¼ ì´ë™í‰ê·  (Net Liquidity ê¸°ì¤€)
    for (let i = 0; i < weeklyData.length; i++) {
      const start = Math.max(0, i - 3);
      const slice = weeklyData.slice(start, i + 1);
      weeklyData[i].ma4 = slice.reduce((s, d) => s + d.netLiquidityDelta, 0) / slice.length;
    }

    // M2 YoY% ê³„ì‚° (52ì£¼ ì „ ëŒ€ë¹„) + SC/M2 ë¹„ìœ¨ (ì‹œê³„ì—´)
    const scMcap = stablecoin?.totalMarketCap || 0;
    const scHistorical = stablecoin?.historical;  // Map: ë‚ ì§œ â†’ ì‹œì´ (billions)

    // SC ë‚ ì§œ ë§¤í•‘ í—¬í¼ (ê°€ì¥ ê°€ê¹Œìš´ ë‚ ì§œ ì°¾ê¸°)
    const findClosestScDate = (targetDate) => {
      if (!scHistorical) return null;
      if (scHistorical.has(targetDate)) return scHistorical.get(targetDate);

      // ê°€ì¥ ê°€ê¹Œìš´ ë‚ ì§œ ì°¾ê¸° (Â±7ì¼ ì´ë‚´)
      const target = new Date(targetDate).getTime();
      let closest = null;
      let minDiff = 7 * 86400000; // 7ì¼

      for (const [dateStr, mcap] of scHistorical) {
        const diff = Math.abs(new Date(dateStr).getTime() - target);
        if (diff < minDiff) {
          minDiff = diff;
          closest = mcap;
        }
      }
      return closest;
    };

    for (let i = 0; i < weeklyData.length; i++) {
      const currentDate = weeklyData[i].date;

      // ì•½ 52ì£¼(1ë…„) ì „ ë°ì´í„° ì°¾ê¸°
      const yearAgoIdx = Math.max(0, i - 52);
      const m2Now = weeklyData[i].m2;
      const m2YearAgo = weeklyData[yearAgoIdx].m2;
      weeklyData[i].m2YoY = ((m2Now - m2YearAgo) / m2YearAgo) * 100;

      // â˜… SC/M2 ë¹„ìœ¨ (í•´ë‹¹ ë‚ ì§œ SC / í•´ë‹¹ ë‚ ì§œ M2) - ì‹œê³„ì—´ ì‚¬ìš©
      const scAtDate = findClosestScDate(currentDate);
      if (scAtDate !== null) {
        weeklyData[i].scMcap = scAtDate;  // í•´ë‹¹ ë‚ ì§œ SC ì‹œì´
        weeklyData[i].scM2Ratio = (scAtDate / m2Now) * 100;
      } else {
        // Fallback: ì‹œê³„ì—´ ì—†ìœ¼ë©´ í˜„ì¬ê°’ ì‚¬ìš©
        weeklyData[i].scMcap = scMcap;
        weeklyData[i].scM2Ratio = (scMcap / m2Now) * 100;
      }
    }

    return {
      timeline: weeklyData,
      stablecoinMcap: scMcap
    };
  }

  // ===== CHART =====
  let mainChart = null;
  let currentTab = 'pulse';
  let currentPeriod = 180;
  let processedData = null;
  let fullData = null;  // ì „ì²´ ë°ì´í„° (ìƒë‹¨ ì¹´ë“œìš©)

  window.switchTab = function(tab, btn) {
    document.querySelectorAll('.chart-tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    currentTab = tab;

    // â˜… 3íƒ­ êµ¬ì¡°
    const titles = {
      pulse: 'Liquidity Pulse (Fed BS - TGA - RRP)',
      credit: 'Credit Flow (M2 YoY%)',
      crypto: 'Crypto Bridge (SC/M2)'
    };
    document.getElementById('chartTitleText').textContent = titles[tab];

    // fullDataì—ì„œ í˜„ì¬ ê¸°ê°„ìœ¼ë¡œ sliceí•´ì„œ ì°¨íŠ¸ ê°±ì‹ 
    if (fullData) {
      processedData = sliceDataByPeriod(fullData, currentPeriod);
      renderChart(processedData);
    }
  };

  window.updatePeriod = function(days, btn) {
    document.querySelectorAll('.p-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentPeriod = days;

    // ì´ë¯¸ ë¡œë“œëœ ì „ì²´ ë°ì´í„°ì—ì„œ ê¸°ê°„ë§Œ sliceí•´ì„œ ì°¨íŠ¸ ê°±ì‹  (API ì¬í˜¸ì¶œ ì—†ìŒ)
    if (fullData) {
      const sliced = sliceDataByPeriod(fullData, days);
      renderChart(sliced);
    }
  };

  // ê¸°ê°„ë³„ ë°ì´í„° ìŠ¬ë¼ì´ìŠ¤ (ì°¨íŠ¸ìš©, ìƒë‹¨ ì¹´ë“œëŠ” í•­ìƒ ì „ì²´ ë°ì´í„° ì‚¬ìš©)
  function sliceDataByPeriod(data, days) {
    const weeks = Math.ceil(days / 7);
    const slicedTimeline = data.timeline.slice(-weeks);
    return {
      ...data,
      timeline: slicedTimeline
    };
  }

  function renderChart(data) {
    const ctx = document.getElementById('mainChart').getContext('2d');
    if (mainChart) mainChart.destroy();

    const dates = data.timeline.map(d => d.date);

    let datasets = [];
    let annotations = {};
    let legendHtml = '';

    if (currentTab === 'pulse') {
      // â˜… Liquidity Pulse: Stacked Bar (Fed BS, -TGA, -RRP) + Net Liquidity ì„ 
      datasets = [
        {
          label: 'Fed BS Î”',
          data: data.timeline.map(d => d.walclDelta),
          backgroundColor: 'rgba(59, 130, 246, 0.7)',
          borderRadius: 2,
          type: 'bar',
          stack: 'stack',
          order: 3
        },
        {
          label: '-TGA Î”',
          data: data.timeline.map(d => d.tgaDelta),  // ì´ë¯¸ ìŒìˆ˜ë¡œ ê³„ì‚°ë¨ (TGAâ†“ = ì‹œì¥ìœ ì…)
          backgroundColor: 'rgba(139, 92, 246, 0.7)',
          borderRadius: 2,
          type: 'bar',
          stack: 'stack',
          order: 3
        },
        {
          label: '-RRP Î”',
          data: data.timeline.map(d => d.rrpDelta),  // ì´ë¯¸ ìŒìˆ˜ë¡œ ê³„ì‚°ë¨ (RRPâ†“ = ì‹œì¥ìœ ì…)
          backgroundColor: 'rgba(245, 158, 11, 0.7)',
          borderRadius: 2,
          type: 'bar',
          stack: 'stack',
          order: 3
        },
        {
          label: 'Net Liquidity Î”',
          data: data.timeline.map(d => d.netLiquidityDelta),
          borderColor: '#ef4444',
          borderWidth: 2.5,
          tension: 0.3,
          pointRadius: 0,
          type: 'line',
          order: 1
        }
      ];
      annotations = {
        zeroLine: {
          type: 'line',
          yMin: 0, yMax: 0,
          borderColor: '#94a3b8',
          borderWidth: 1,
          borderDash: [6, 4]
        },
        threshold50: {
          type: 'line',
          yMin: 50, yMax: 50,
          borderColor: 'rgba(34, 197, 94, 0.5)',
          borderWidth: 1.5,
          borderDash: [8, 4],
          label: { content: 'í™•ì¥ ê¸°ì¤€ +$50B', display: true, position: 'start', font: { size: 9 }, color: '#22c55e', backgroundColor: 'rgba(255,255,255,0.8)', padding: 2 }
        },
        thresholdNeg50: {
          type: 'line',
          yMin: -50, yMax: -50,
          borderColor: 'rgba(239, 68, 68, 0.5)',
          borderWidth: 1.5,
          borderDash: [8, 4],
          label: { content: 'ìˆ˜ì¶• ê¸°ì¤€ -$50B', display: true, position: 'start', font: { size: 9 }, color: '#ef4444', backgroundColor: 'rgba(255,255,255,0.8)', padding: 2 }
        }
      };
      legendHtml = `
        <div class="legend-item"><div class="legend-color" style="background: rgba(59, 130, 246, 0.7);"></div><span>Fed BS Î”</span></div>
        <div class="legend-item"><div class="legend-color" style="background: rgba(139, 92, 246, 0.7);"></div><span>-TGA Î”</span></div>
        <div class="legend-item"><div class="legend-color" style="background: rgba(245, 158, 11, 0.7);"></div><span>-RRP Î”</span></div>
        <div class="legend-item"><div class="legend-color" style="background: #ef4444; height: 2px;"></div><span>Net Liq Î”</span></div>
      `;
    } else if (currentTab === 'credit') {
      // â˜… Credit Flow: M2 YoY% + M2 ì´ëŸ‰ ë©´ì 
      const m2YoY = data.timeline.map(d => d.m2YoY || 0);
      const m2Total = data.timeline.map(d => d.m2 / 1000);  // $T ë‹¨ìœ„

      datasets = [
        {
          label: 'M2 Total ($T)',
          data: m2Total,
          backgroundColor: 'rgba(59, 130, 246, 0.15)',
          borderColor: 'transparent',
          fill: true,
          tension: 0.3,
          pointRadius: 0,
          yAxisID: 'y1',
          order: 2
        },
        {
          label: 'M2 YoY%',
          data: m2YoY,
          borderColor: CONFIG.colors.m2,
          borderWidth: 3,
          tension: 0.3,
          pointRadius: 0,
          fill: false,
          yAxisID: 'y',
          order: 1
        }
      ];
      annotations = {
        // M2 YoY ì„ê³„ì„ 
        threshold6: {
          type: 'line',
          yMin: 6, yMax: 6,
          borderColor: 'rgba(34, 197, 94, 0.4)',
          borderWidth: 1,
          borderDash: [2, 2],
          label: { content: '6% (í™•ì¥)', display: true, position: 'start', font: { size: 9 }, color: '#22c55e' }
        },
        threshold2: {
          type: 'line',
          yMin: 2, yMax: 2,
          borderColor: 'rgba(239, 68, 68, 0.4)',
          borderWidth: 1,
          borderDash: [2, 2],
          label: { content: '2% (ê¸´ì¶•)', display: true, position: 'start', font: { size: 9 }, color: '#ef4444' }
        }
      };
      legendHtml = `
        <div class="legend-item"><div class="legend-color" style="background: ${CONFIG.colors.m2};"></div><span>M2 YoY%</span></div>
        <div class="legend-item"><div class="legend-color" style="background: rgba(59, 130, 246, 0.3);"></div><span>M2 Total ($T)</span></div>
      `;
    } else if (currentTab === 'crypto') {
      // â˜… Crypto Bridge: SC ì‹œê³„ì—´ ì´ëŸ‰ (ì¢Œì¶•) + SC/M2 Ratio (ìš°ì¶•)
      const scMcap = data.stablecoinMcap;  // ìµœì‹  ì‹œì´ (billions)
      const scM2Ratio = data.timeline.map(d => d.scM2Ratio || 0);

      // â˜… SC ì‹œê³„ì—´ ë°ì´í„° ì‚¬ìš© (ê° ë‚ ì§œë³„ ì‹¤ì œ ì‹œì´)
      const scTimeSeries = data.timeline.map(d => d.scMcap || scMcap);

      datasets = [
        {
          label: 'SC Total ($B)',
          data: scTimeSeries,  // â˜… ì‹œê³„ì—´ ë°ì´í„°
          backgroundColor: 'rgba(16, 185, 129, 0.15)',
          borderColor: CONFIG.colors.inflow,
          borderWidth: 2.5,
          fill: true,
          tension: 0.3,
          pointRadius: 0,
          yAxisID: 'y',
          order: 2
        },
        {
          label: 'SC/M2 Ratio',
          data: scM2Ratio,
          borderColor: CONFIG.colors.stablecoin,
          borderWidth: 2.5,
          borderDash: [6, 4],
          tension: 0.3,
          pointRadius: 0,
          fill: false,
          yAxisID: 'y1',
          order: 1
        }
      ];
      // SC/M2 ë¹„ìœ¨ ì„ê³„ê°’ í‘œì‹œ (ìš°ì¶• y1 ê¸°ì¤€, ë¦¬ì„œì¹˜ ë¬¸ì„œ ì°¸ì¡°)
      annotations = {
        scRatioThreshold15: {
          type: 'line',
          yMin: 1.5, yMax: 1.5,
          borderColor: 'rgba(34, 197, 94, 0.5)',
          borderWidth: 1.5,
          borderDash: [6, 4],
          yScaleID: 'y1',
          label: { content: '1.5% (ìœ ì…)', display: true, position: 'start', font: { size: 9 }, color: '#22c55e', backgroundColor: 'rgba(255,255,255,0.8)', padding: 2 }
        },
        scRatioThreshold10: {
          type: 'line',
          yMin: 1.0, yMax: 1.0,
          borderColor: 'rgba(239, 68, 68, 0.5)',
          borderWidth: 1.5,
          borderDash: [6, 4],
          yScaleID: 'y1',
          label: { content: '1.0% (ìœ ì¶œ)', display: true, position: 'start', font: { size: 9 }, color: '#ef4444', backgroundColor: 'rgba(255,255,255,0.8)', padding: 2 }
        }
      };
      // ìµœì‹  SC ê°’ (ë²”ë¡€ìš©)
      const latestSc = scTimeSeries[scTimeSeries.length - 1] || scMcap;
      legendHtml = `
        <div class="legend-item"><div class="legend-color" style="background: ${CONFIG.colors.inflow};"></div><span>SC Total (í˜„ì¬: $${latestSc.toFixed(0)}B)</span></div>
        <div class="legend-item"><div class="legend-color" style="background: ${CONFIG.colors.stablecoin}; border: 1px dashed ${CONFIG.colors.stablecoin};"></div><span>SC/M2 Ratio (%)</span></div>
      `;
    }

    document.getElementById('chartLegend').innerHTML = legendHtml;

    // íƒ­ë³„ scales ì„¤ì •
    let scales = {
      x: { grid: { display: false }, ticks: { maxTicksLimit: 8, font: { size: 10 } } },
      y: {
        grid: { color: '#f1f5f9' },
        ticks: { callback: v => '$' + v.toFixed(0) + 'B', font: { size: 10 } }
      }
    };

    if (currentTab === 'pulse') {
      scales = {
        x: { grid: { display: false }, ticks: { maxTicksLimit: 8, font: { size: 10 } }, stacked: true },
        y: {
          grid: { color: '#f1f5f9' },
          ticks: { callback: v => (v >= 0 ? '+' : '') + v.toFixed(0) + 'B', font: { size: 10 } },
          stacked: true
        }
      };
    } else if (currentTab === 'credit') {
      scales = {
        x: { grid: { display: false }, ticks: { maxTicksLimit: 8, font: { size: 10 } } },
        y: {
          type: 'linear',
          position: 'left',
          grid: { color: '#f1f5f9' },
          ticks: { callback: v => v.toFixed(1) + '%', color: CONFIG.colors.m2, font: { size: 10, weight: 'bold' } },
          title: { display: true, text: 'M2 YoY%', color: CONFIG.colors.m2 }
        },
        y1: {
          type: 'linear',
          position: 'right',
          grid: { display: false },
          ticks: { callback: v => '$' + v.toFixed(1) + 'T', font: { size: 10 } },
          title: { display: true, text: 'M2 Total ($T)' }
        }
      };
    } else if (currentTab === 'crypto') {
      // SC ì‹œê³„ì—´ ìµœëŒ€ê°’ ê³„ì‚° (ë™ì  Yì¶•)
      const scValues = data.timeline.map(d => d.scMcap || 0);
      const scMax = Math.max(...scValues, 100);  // ìµœì†Œ 100B
      const yMax = Math.ceil(scMax / 50) * 50 + 50;  // 50B ë‹¨ìœ„ë¡œ ì˜¬ë¦¼ + ì—¬ìœ 

      scales = {
        x: { grid: { display: false }, ticks: { maxTicksLimit: 8, font: { size: 10 } } },
        y: {
          type: 'linear',
          position: 'left',
          grid: { color: '#f1f5f9' },
          ticks: { callback: v => '$' + v.toFixed(0) + 'B', color: CONFIG.colors.inflow, font: { size: 10, weight: 'bold' } },
          title: { display: true, text: 'SC Total ($B)', color: CONFIG.colors.inflow },
          min: 0,
          max: yMax  // ë™ì  ìµœëŒ€ê°’
        },
        y1: {
          type: 'linear',
          position: 'right',
          grid: { display: false },
          ticks: { callback: v => v.toFixed(2) + '%', color: CONFIG.colors.stablecoin, font: { size: 10 } },
          title: { display: true, text: 'SC/M2 Ratio', color: CONFIG.colors.stablecoin }
        }
      };
    }

    // ===== ë¦¬ì„¸ì…˜ ìŒì˜ ì¶”ê°€ =====
    const chartStart = dates[0];
    const chartEnd = dates[dates.length - 1];
    console.log('[Chart] ë‚ ì§œ ë²”ìœ„:', chartStart, '~', chartEnd);
    if (typeof getRecessionAnnotations === 'function') {
      const recessionAnnotations = getRecessionAnnotations(chartStart, chartEnd, { showLabel: true });

      // Category ì¶•ì—ì„œëŠ” ë¼ë²¨ê³¼ ì •í™•íˆ ì¼ì¹˜í•´ì•¼ í•¨ â†’ ê°€ì¥ ê°€ê¹Œìš´ ë‚ ì§œë¡œ ë§¤í•‘
      const findClosestLabel = (targetDate) => {
        const target = new Date(targetDate).getTime();
        let closest = dates[0];
        let minDiff = Math.abs(new Date(dates[0]).getTime() - target);

        for (const d of dates) {
          const diff = Math.abs(new Date(d).getTime() - target);
          if (diff < minDiff) {
            minDiff = diff;
            closest = d;
          }
        }
        return closest;
      };

      // ë¦¬ì„¸ì…˜ ë‚ ì§œë¥¼ ì°¨íŠ¸ ë¼ë²¨ì— ë§ê²Œ ì¡°ì •
      Object.entries(recessionAnnotations).forEach(([key, val]) => {
        const mappedMin = findClosestLabel(val.xMin);
        const mappedMax = findClosestLabel(val.xMax);
        console.log(`[Chart] ${key}: ${val.xMin} â†’ ${mappedMin}, ${val.xMax} â†’ ${mappedMax}`);
        recessionAnnotations[key].xMin = mappedMin;
        recessionAnnotations[key].xMax = mappedMax;
      });

      annotations = { ...annotations, ...recessionAnnotations };
      console.log('[Chart] ìµœì¢… annotations í‚¤:', Object.keys(annotations));
    } else {
      console.warn('[Chart] getRecessionAnnotations í•¨ìˆ˜ ì—†ìŒ!');
    }

    mainChart = new Chart(ctx, {
      type: 'line',
      data: { labels: dates, datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { display: false },
          tooltip: {
            enabled: true,
            backgroundColor: 'rgba(15, 23, 42, 0.95)',
            titleFont: { family: 'Inter', size: 13, weight: '600' },
            bodyFont: { family: 'Orbitron', size: 13 },
            padding: 12,
            cornerRadius: 10,
            callbacks: {
              label: ctx => {
                const val = ctx.raw;
                // Credit Flow: M2 Totalì€ $T, M2 YoY%ëŠ” %
                if (currentTab === 'credit') {
                  if (ctx.datasetIndex === 0) return ` ${ctx.dataset.label}: $${val.toFixed(1)}T`;
                  return ` ${ctx.dataset.label}: ${val.toFixed(2)}%`;
                }
                // Crypto Bridge: SC Totalì€ $B, SC/M2 RatioëŠ” %
                if (currentTab === 'crypto') {
                  if (ctx.datasetIndex === 0) return ` ${ctx.dataset.label}: $${val.toFixed(0)}B`;
                  return ` ${ctx.dataset.label}: ${val.toFixed(2)}%`;
                }
                return ` ${ctx.dataset.label}: $${val.toFixed(1)}B`;
              }
            }
          },
          annotation: { annotations }
        },
        scales: scales
      }
    });
  }

  // ===== UI UPDATE =====

  // ===== ìƒíƒœ íŒë‹¨ í•¨ìˆ˜ë“¤ (THRESHOLDS ê¸°ë°˜, ìš©ì–´: ìƒìŠ¹/íš¡ë³´/í•˜ë½) =====

  // M2 YoY ìƒíƒœ: 6% ì´ìƒ=ìƒìŠ¹, 2-6%=íš¡ë³´, 2% ë¯¸ë§Œ=í•˜ë½
  function getM2Status(yoyPercent) {
    const TH = { POSITIVE: getThreshold('M2_YOY', 'POSITIVE'), NEUTRAL: getThreshold('M2_YOY', 'NEUTRAL') };
    if (yoyPercent >= TH.POSITIVE) return { color: 'green', status: 'ìƒìŠ¹' };
    if (yoyPercent >= TH.NEUTRAL) return { color: 'yellow', status: 'íš¡ë³´' };
    return { color: 'red', status: 'í•˜ë½' };
  }

  // Net Liquidity Delta ìƒíƒœ: +$50B ì´ìƒ=ìƒìŠ¹, Â±$50B=íš¡ë³´, -$50B ë¯¸ë§Œ=í•˜ë½
  function getNetLiqStatus(deltaB) {
    const TH = { POSITIVE: getThreshold('NET_LIQUIDITY', 'POSITIVE'), NEGATIVE: getThreshold('NET_LIQUIDITY', 'NEGATIVE') };
    if (deltaB > TH.POSITIVE) return { color: 'green', status: 'ìƒìŠ¹' };
    if (deltaB < TH.NEGATIVE) return { color: 'red', status: 'í•˜ë½' };
    return { color: 'yellow', status: 'íš¡ë³´' };
  }

  // SC/M2 Ratio ìƒíƒœ: 1.5% ì´ìƒ=ìƒìŠ¹, 1.0-1.5%=íš¡ë³´, 1.0% ë¯¸ë§Œ=í•˜ë½
  function getScM2Status(ratioPercent) {
    const TH = { POSITIVE: getThreshold('STABLECOIN', 'POSITIVE'), NEUTRAL: getThreshold('STABLECOIN', 'NEUTRAL') };
    if (ratioPercent >= TH.POSITIVE) return { color: 'green', status: 'ìƒìŠ¹' };
    if (ratioPercent >= TH.NEUTRAL) return { color: 'yellow', status: 'íš¡ë³´' };
    return { color: 'red', status: 'í•˜ë½' };
  }

  function updateSignalMatrix(data) {
    const last = data.timeline[data.timeline.length - 1];
    const prev = data.timeline.length > 1 ? data.timeline[data.timeline.length - 2] : last;
    // ===== 1. M2 YoY - THRESHOLDS ê¸°ë°˜ ìƒíƒœ =====
    const m2YoY = last.m2YoY || 0;
    const m2TotalT = last.m2 / 1000;
    const m2Status = getM2Status(m2YoY);

    updateSignalCard('m2', `${m2YoY >= 0 ? '+' : ''}${m2YoY.toFixed(1)}`, '%',
      m2Status.color, m2Status.status, { subtext: `$${m2TotalT.toFixed(1)}T` });

    // ===== 2. Net Liquidity - THRESHOLDS ê¸°ë°˜ ìƒíƒœ =====
    const netLiq = last.netLiquidity;
    const netLiqDelta = last.netLiquidityDelta;
    const nlStatus = getNetLiqStatus(netLiqDelta);

    updateSignalCard('netLiq', `${netLiqDelta >= 0 ? '+' : ''}${netLiqDelta.toFixed(0)}`, '$B',
      nlStatus.color, nlStatus.status, { subtext: `$${(netLiq / 1000).toFixed(2)}T` });

    // ===== 3. SC/M2 Ratio - THRESHOLDS ê¸°ë°˜ ìƒíƒœ =====
    const latestScMcap = last.scMcap || data.stablecoinMcap;
    const scM2Ratio = last.scM2Ratio || 0;
    const scStatus = getScM2Status(scM2Ratio);

    updateSignalCard('sc', scM2Ratio.toFixed(2), '%',
      scStatus.color, scStatus.status, { subtext: `$${latestScMcap.toFixed(0)}B` });

    // ===== Hero Section: Weekly Net Liquidity Delta - constants.js THRESHOLDS ì‚¬ìš© =====
    const HERO_TH = { POSITIVE: getThreshold('NET_LIQUIDITY', 'POSITIVE'), NEGATIVE: getThreshold('NET_LIQUIDITY', 'NEGATIVE') };
    const netLiqDeltaVal = last.netLiquidityDelta;
    const netFlowEl = document.getElementById('netFlowValue');
    netFlowEl.textContent = `$${netLiqDeltaVal >= 0 ? '+' : ''}${netLiqDeltaVal.toFixed(0)}B`;
    netFlowEl.className = 'net-flow-value ' + (netLiqDeltaVal >= 0 ? 'positive' : 'negative');

    const trendEl = document.getElementById('netFlowTrend');
    const trendIcon = trendEl.querySelector('i');
    const trendDesc = document.getElementById('netFlowDesc');

    if (netLiqDeltaVal > HERO_TH.POSITIVE) {
      trendEl.className = 'net-flow-trend up';
      trendIcon.className = 'fas fa-arrow-up';
      trendDesc.textContent = 'ìœ ë™ì„± ìƒìŠ¹';
    } else if (netLiqDeltaVal < HERO_TH.NEGATIVE) {
      trendEl.className = 'net-flow-trend down';
      trendIcon.className = 'fas fa-arrow-down';
      trendDesc.textContent = 'ìœ ë™ì„± í•˜ë½';
    } else {
      trendEl.className = 'net-flow-trend';
      trendIcon.className = 'fas fa-minus';
      trendDesc.textContent = 'íš¡ë³´';
    }

    // Status Badge & Info Cards & Time
    updateStatusBadge(netLiqDeltaVal, m2YoY);
    updateInfoCards(last, prev);
    document.getElementById('updateTime').textContent = `Data: ${last.date}`;
  }

  function updateSignalCard(id, value, unit, color, status, opts = {}) {
    // ê°’ ì—…ë°ì´íŠ¸
    document.getElementById(`${id}Value`).textContent = value;

    const icon = document.getElementById(`${id}Icon`);
    icon.className = 'signal-icon ' + color;

    const statusEl = document.getElementById(`${id}Status`);
    statusEl.textContent = status;
    statusEl.className = 'signal-status ' + (color === 'green' ? 'normal' : color === 'yellow' ? 'caution' : 'danger');

    // ì„œë¸Œí…ìŠ¤íŠ¸
    if (opts.subtext !== undefined) {
      const sub = document.getElementById(`${id}Sub`);
      if (sub) sub.textContent = opts.subtext;
    }
  }

  // constants.js THRESHOLDS.OVERALL ì‚¬ìš©
  function updateStatusBadge(netLiqDelta, m2YoY) {
    const badge = document.getElementById('statusBadge');
    const text = document.getElementById('statusText');

    const OVERALL_TH = {
      EXPANDING: getThreshold('OVERALL', 'EXPANDING'),
      CONTRACTING: getThreshold('OVERALL', 'CONTRACTING')
    };

    let status = 'normal';
    if (netLiqDelta > OVERALL_TH.EXPANDING.netLiq && m2YoY >= OVERALL_TH.EXPANDING.m2YoY) status = 'inflow';
    else if (netLiqDelta < OVERALL_TH.CONTRACTING.netLiq || m2YoY < OVERALL_TH.CONTRACTING.m2YoY) status = 'outflow';

    if (status === 'inflow') {
      badge.style.cssText = 'background:#dcfce7; border-color:#bbf7d0; color:#166534';
      badge.querySelector('.status-dot').style.background = '#166534';
      text.textContent = 'ìœ ë™ì„± ìƒìŠ¹';
    } else if (status === 'outflow') {
      badge.style.cssText = 'background:#fee2e2; border-color:#fecaca; color:#dc2626';
      badge.querySelector('.status-dot').style.background = '#dc2626';
      text.textContent = 'ìœ ë™ì„± í•˜ë½';
    } else {
      badge.style.cssText = 'background:#fef9c3; border-color:#fde68a; color:#ca8a04';
      badge.querySelector('.status-dot').style.background = '#ca8a04';
      text.textContent = 'íš¡ë³´';
    }
  }

  // constants.js THRESHOLDS.NET_LIQUIDITY ì‚¬ìš©
  function updateInfoCards(last, prev) {
    const statusCard = document.getElementById('statusCard');
    const summary = document.getElementById('statusSummary');
    const weeklyChanges = document.getElementById('weeklyChanges');

    const INFO_TH = { POSITIVE: getThreshold('NET_LIQUIDITY', 'POSITIVE'), NEGATIVE: getThreshold('NET_LIQUIDITY', 'NEGATIVE') };
    const netLiqDelta = last.netLiquidityDelta;

    if (netLiqDelta > INFO_TH.POSITIVE) {
      statusCard.className = 'info-card inflow';
      summary.innerHTML = `ì£¼ê°„ <span class="info-value">+$${netLiqDelta.toFixed(0)}B</span> ìˆœìœ ì… - ìƒìŠ¹`;
    } else if (netLiqDelta < INFO_TH.NEGATIVE) {
      statusCard.className = 'info-card outflow';
      summary.innerHTML = `ì£¼ê°„ <span class="info-value">-$${Math.abs(netLiqDelta).toFixed(0)}B</span> ìˆœìœ ì¶œ - í•˜ë½`;
    } else {
      statusCard.className = 'info-card neutral';
      summary.innerHTML = `ì£¼ê°„ ë³€ë™ <span class="info-value">$${netLiqDelta >= 0 ? '+' : ''}${netLiqDelta.toFixed(0)}B</span> - íš¡ë³´`;
    }

    // Components ë¶„í•´ í‘œì‹œ
    weeklyChanges.innerHTML = `
      <li>Fed BS (WALCL): <strong>${last.walclDelta >= 0 ? '+' : ''}${last.walclDelta.toFixed(1)}B</strong></li>
      <li>TGA: <strong>${-last.tgaDelta >= 0 ? '+' : ''}${(-last.tgaDelta).toFixed(1)}B</strong> (ì°¨ê°)</li>
      <li>RRP: <strong>${-last.rrpDelta >= 0 ? '+' : ''}${(-last.rrpDelta).toFixed(1)}B</strong> (ì°¨ê°)</li>
      <li><strong>= Net Liquidity Î”: ${netLiqDelta >= 0 ? '+' : ''}${netLiqDelta.toFixed(1)}B</strong></li>
    `;
  }

  window.toggleInfoCard = function(cardId) {
    document.getElementById(cardId).classList.toggle('expanded');
  };

  // ===== CACHE =====
  function saveWidgetCache(data) {
    if (typeof DataManager === 'undefined') return;

    const last = data.timeline[data.timeline.length - 1];

    // â˜… ìƒˆ êµ¬ì¡°: Net Liquidity ì •ì‹ ê³µì‹ ê¸°ë°˜
    const widgetData = {
      // Signal Matrix 3ê°œ ì§€í‘œ
      m2YoY: last.m2YoY || 0,
      m2Total: last.m2,
      netLiquidity: last.netLiquidity,
      netLiquidityDelta: last.netLiquidityDelta,
      stablecoinMcap: data.stablecoinMcap,
      scM2Ratio: last.scM2Ratio || 0,
      // Components (Chartìš©)
      walcl: last.walcl,
      tga: last.tga,
      rrp: last.rrp,
      walclDelta: last.walclDelta,
      tgaDelta: last.tgaDelta,
      rrpDelta: last.rrpDelta,
      // ê¸°ì¡´ í˜¸í™˜ìš©
      netFlow: last.netFlow,
      updated: new Date().toISOString()
    };

    DataManager.saveWidgetData('liquidity-flow', widgetData);
    console.log('[Detail] Widget cache saved:', widgetData);
  }

  // ===== DATA VALIDATION =====
  function validateData(data, days) {
    const issues = [];
    const timeline = data.timeline;

    if (!timeline || timeline.length === 0) {
      issues.push('âŒ íƒ€ì„ë¼ì¸ ë°ì´í„° ì—†ìŒ');
      return { valid: false, issues };
    }

    // 1. ë‚ ì§œ ì—°ì†ì„± ê²€ì¦
    for (let i = 1; i < timeline.length; i++) {
      const prev = new Date(timeline[i-1].date);
      const curr = new Date(timeline[i].date);
      const diffDays = (curr - prev) / (1000 * 60 * 60 * 24);
      if (diffDays > 14) { // 2ì£¼ ì´ìƒ ê°­
        issues.push(`âš ï¸ ë‚ ì§œ ê°­: ${timeline[i-1].date} â†’ ${timeline[i].date} (${diffDays}ì¼)`);
      }
    }

    // 2. ê°’ ë²”ìœ„ ê²€ì¦ (ì´ìƒì¹˜ íƒì§€)
    const lastItem = timeline[timeline.length - 1];
    if (lastItem.m2 < 15000 || lastItem.m2 > 30000) {
      issues.push(`âš ï¸ M2 ì´ìƒê°’: $${lastItem.m2.toFixed(1)}B (ì •ìƒ: 15-30T)`);
    }
    if (lastItem.netLiquidity < 3000 || lastItem.netLiquidity > 10000) {
      issues.push(`âš ï¸ Net Liquidity ì´ìƒê°’: $${lastItem.netLiquidity.toFixed(1)}B (ì •ìƒ: 3-10T)`);
    }

    // 3. ë°ì´í„° ì¶©ë¶„ì„± ê²€ì¦
    const expectedWeeks = Math.floor(days / 7) * 0.7; // 70% ì´ìƒ ìˆì–´ì•¼ í•¨
    if (timeline.length < expectedWeeks) {
      issues.push(`âš ï¸ ë°ì´í„° ë¶€ì¡±: ${timeline.length}ì£¼ (ì˜ˆìƒ: ${Math.floor(expectedWeeks)}+ì£¼)`);
    }

    // 4. NaN/Infinity ê²€ì¦
    const hasInvalid = timeline.some(d =>
      isNaN(d.m2) || isNaN(d.netLiquidity) || !isFinite(d.m2YoY)
    );
    if (hasInvalid) {
      issues.push('âŒ NaN/Infinity ê°’ ë°œê²¬');
    }

    if (issues.length > 0) {
      console.warn('[Data Validation]', issues);
    } else {
      console.log(`[Data Validation] âœ… ${timeline.length}ì£¼ ë°ì´í„° ì •ìƒ (${days}ì¼ ìš”ì²­)`);
    }

    return { valid: issues.filter(i => i.startsWith('âŒ')).length === 0, issues };
  }

  // ===== INIT =====
  // ì „ì²´ ë°ì´í„°(MAX)ë¥¼ í•œ ë²ˆë§Œ ë¡œë“œ, ê¸°ê°„ ë³€ê²½ ì‹œ ì°¨íŠ¸ë§Œ slice
  async function init(initialPeriod = 180) {
    try {
      const MAX_DAYS = 2925;  // MAX ê¸°ê°„ (ì•½ 8ë…„)
      console.log(`[Init] ì „ì²´ ë°ì´í„° ë¡œë“œ ì‹œì‘: ${MAX_DAYS}ì¼`);

      const [m2, tga, rrp, walcl, sc] = await Promise.all([
        getFredSeries('M2SL', MAX_DAYS + 365),  // M2: YoY ê³„ì‚°ì„ ìœ„í•´ +1ë…„
        getFredSeries('WTREGEN', MAX_DAYS),     // TGA: ì£¼ê°„ (millions)
        getFredSeries('RRPONTSYD', MAX_DAYS),   // RRP: ì¼ê°„ (millions)
        getFredSeries('WALCL', MAX_DAYS),       // Fed Balance Sheet: ì£¼ê°„ (millions)
        getStablecoinData()                      // Stablecoin: ì „ì²´ ì‹œê³„ì—´
      ]);

      // ë°ì´í„° ê°€ìš©ì„± ì²´í¬
      console.log(`[Init] ë°ì´í„° ìˆ˜ì‹ : M2=${m2.length}, TGA=${tga.length}, RRP=${rrp.length}, WALCL=${walcl.length}`);

      if (!tga.length || !walcl.length) {
        console.error('[Init] TGA or WALCL data not available');
        return;
      }

      // ì „ì²´ ë°ì´í„° ì €ì¥
      fullData = processData(m2, tga, rrp, walcl, sc);
      console.log(`[Init] ì „ì²´ ë°ì´í„° ì²˜ë¦¬ ì™„ë£Œ: ${fullData.timeline.length}ì£¼`);

      // ì°¨íŠ¸ìš© ë°ì´í„° (ê¸°ê°„ë³„ slice)
      processedData = sliceDataByPeriod(fullData, initialPeriod);

      // ë°ì´í„° ê²€ì¦
      const validation = validateData(fullData, MAX_DAYS);
      if (!validation.valid) {
        console.warn('[Init] ë°ì´í„° ê²€ì¦ ê²½ê³ :', validation.issues);
      }

      renderChart(processedData);
      updateSignalMatrix(fullData);  // â˜… ìƒë‹¨ ì¹´ë“œëŠ” ì „ì²´ ë°ì´í„°ì˜ ë§ˆì§€ë§‰ ê°’ ì‚¬ìš©
      saveWidgetCache(fullData);

    } catch (e) {
      console.error('[Init] Error:', e);
    }
  }

  // Start - ES Module ë¡œë“œ ì™„ë£Œ ëŒ€ê¸°
  // (type="module"ì€ deferì²˜ëŸ¼ ë™ì‘í•˜ë¯€ë¡œ DOMContentLoaded í›„ ì‹¤í–‰ë˜ì§€ë§Œ,
  //  ì¼ë°˜ scriptì™€ì˜ ì‹¤í–‰ ìˆœì„œ ë³´ì¥ ìœ„í•´ ì•½ê°„ì˜ ì§€ì—° ì¶”ê°€)
  function startApp() {
    if (typeof getRecessionAnnotations === 'function') {
      console.log('[Init] getRecessionAnnotations loaded âœ“');
      init(180);
    } else {
      console.log('[Init] Waiting for ES modules...');
      setTimeout(startApp, 50);
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', startApp);
  } else {
    startApp();
  }
</script>
</body>
</html>
