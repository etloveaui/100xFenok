<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AAII Bull-Bear Spread Chart | Market Radar</title>
  <meta name="robots" content="noindex, nofollow">
  <link rel="icon" type="image/x-icon" href="../../../favicon.ico">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; }
    html, body {
      min-height: 100%;
      margin: 0;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    html::-webkit-scrollbar, body::-webkit-scrollbar { display: none; }
    body { background: #f8fafc; }

    /* Period Dropdown */
    .period-dropdown { position: relative; display: inline-block; }
    .period-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      color: #0f172a;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .period-btn:hover { border-color: #a855f7; }
    .period-btn svg { width: 16px; height: 16px; color: #64748b; transition: transform 0.2s; }
    .period-btn.open svg { transform: rotate(180deg); }

    .period-panel {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      min-width: 300px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
      padding: 16px;
      z-index: 100;
      display: none;
    }
    .period-panel.open { display: block; }

    .period-section { margin-bottom: 16px; }
    .period-section:last-child { margin-bottom: 0; }
    .period-section-title {
      font-size: 11px;
      font-weight: 600;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    .period-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
    }
    .period-option {
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      color: #475569;
      background: #f8fafc;
      border: 1px solid transparent;
      cursor: pointer;
      text-align: center;
      transition: all 0.15s ease;
    }
    .period-option:hover { background: #e2e8f0; }
    .period-option.active {
      background: #a855f7;
      color: white;
      border-color: #a855f7;
    }

    /* Custom Date Range */
    .custom-range {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .custom-range input[type="date"] {
      padding: 8px 10px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 12px;
      font-family: inherit;
      color: #334155;
      flex: 1;
      min-width: 110px;
    }
    .custom-range input[type="date"]:focus {
      outline: none;
      border-color: #a855f7;
    }
    .custom-range .apply-btn {
      padding: 8px 14px;
      background: #a855f7;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s;
    }
    .custom-range .apply-btn:hover { background: #9333ea; }

    /* Mobile Backdrop */
    .period-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.3);
      z-index: 99;
    }
    .period-backdrop.open { display: block; }

    @media (max-width: 640px) {
      .period-panel {
        position: fixed;
        left: 16px;
        right: 16px;
        top: auto;
        bottom: 16px;
        min-width: auto;
        border-radius: 20px;
        max-height: 70vh;
        overflow-y: auto;
      }
      .period-grid { grid-template-columns: repeat(3, 1fr); }
    }

    /* Overlay Toggle Chip */
    .overlay-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid #e2e8f0;
      background: #f1f5f9;
      color: #94a3b8;
    }
    .overlay-chip:hover { border-color: #0ea5e9; color: #0ea5e9; }
    .overlay-chip.active {
      background: #0ea5e9;
      color: white;
      border-color: #0ea5e9;
    }
    .chip-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    .overlay-chip.active .chip-dot { background: rgba(255,255,255,0.8); }
    .overlay-chip:not(.active) .chip-dot { background: #0ea5e9; }

    /* Stats Card */
    .stats-card {
      background: white;
      border-radius: 16px;
      padding: 16px 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .stat-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .stat-label {
      font-size: 11px;
      font-weight: 500;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: #0f172a;
      letter-spacing: -0.5px;
    }
    .stat-value.sm {
      font-size: 15px;
      font-weight: 600;
    }

    /* Chart Container */
    .chart-container {
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    /* Legend */
    .chart-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-bottom: 16px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      font-weight: 500;
      color: #64748b;
    }
    .legend-line {
      width: 20px;
      height: 3px;
      border-radius: 2px;
    }
    .legend-line.dashed {
      background: repeating-linear-gradient(90deg, currentColor 0, currentColor 4px, transparent 4px, transparent 8px);
      height: 2px;
    }
    .legend-box {
      width: 14px;
      height: 10px;
      border-radius: 2px;
    }
  </style>
</head>
<body class="p-4 sm:p-6">

  <div class="space-y-4">

    <!-- Mobile Backdrop -->
    <div id="periodBackdrop" class="period-backdrop"></div>

    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
      <div>
        <h1 class="text-xl sm:text-2xl font-bold text-slate-800 flex items-center gap-2">
          <span class="text-2xl sm:text-3xl">üë•</span>
          AAII Bull-Bear Spread
        </h1>
        <p class="text-xs sm:text-sm text-slate-500 mt-1">Investor Sentiment Survey ¬∑ Weekly (1987~)</p>
      </div>

      <div class="flex items-center gap-2 flex-wrap">
        <!-- S&P 500 Overlay Toggle -->
        <div class="overlay-chip" id="sp500Overlay">
          <span class="chip-dot"></span>
          S&P 500
        </div>

        <!-- Period Dropdown -->
        <div class="period-dropdown">
          <button id="periodBtn" class="period-btn">
            <span id="periodLabel">2Y</span>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>
          <div id="periodPanel" class="period-panel">
            <!-- Recent -->
            <div class="period-section">
              <div class="period-section-title">‚ö° Recent</div>
              <div class="period-grid">
                <button class="period-option" data-period="90" data-label="3M">3M</button>
                <button class="period-option" data-period="180" data-label="6M">6M</button>
                <button class="period-option" data-period="365" data-label="1Y">1Y</button>
                <button class="period-option active" data-period="730" data-label="2Y">2Y</button>
              </div>
            </div>
            <!-- Extended -->
            <div class="period-section">
              <div class="period-section-title">üìä Extended</div>
              <div class="period-grid">
                <button class="period-option" data-period="1825" data-label="5Y">5Y</button>
                <button class="period-option" data-period="3650" data-label="10Y">10Y</button>
                <button class="period-option" data-period="7300" data-label="20Y">20Y</button>
                <button class="period-option" data-period="9999" data-label="MAX">MAX</button>
              </div>
            </div>
            <!-- Historical -->
            <div class="period-section">
              <div class="period-section-title">üèõÔ∏è Historical</div>
              <div class="period-grid">
                <button class="period-option" data-period="since_2000" data-label="2000~">2000~</button>
                <button class="period-option" data-period="since_1990" data-label="1990~">1990~</button>
                <button class="period-option" data-period="since_1987" data-label="1987~">1987~</button>
                <button class="period-option" data-period="ytd" data-label="YTD">YTD</button>
              </div>
            </div>
            <!-- Custom Range -->
            <div class="period-section">
              <div class="period-section-title">üéØ Custom</div>
              <div class="custom-range">
                <input type="date" id="startDate" value="2020-01-01">
                <span class="text-slate-400 text-sm">~</span>
                <input type="date" id="endDate">
                <button class="apply-btn" id="applyCustom">Apply</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
      <div class="stats-card">
        <div class="stat-item">
          <span class="stat-label">Spread</span>
          <span id="spreadValue" class="stat-value">--</span>
        </div>
      </div>
      <div class="stats-card">
        <div class="stat-item">
          <span class="stat-label">Bullish</span>
          <span id="bullishValue" class="stat-value sm text-green-600">--</span>
        </div>
      </div>
      <div class="stats-card">
        <div class="stat-item">
          <span class="stat-label">Bearish</span>
          <span id="bearishValue" class="stat-value sm text-red-600">--</span>
        </div>
      </div>
      <div class="stats-card">
        <div class="stat-item">
          <span class="stat-label">Date</span>
          <span id="currentDate" class="stat-value sm text-slate-600">--</span>
        </div>
      </div>
    </div>

    <!-- Status Badge -->
    <div class="flex items-center gap-3">
      <div id="statusBadge" class="px-4 py-2 rounded-lg text-sm font-bold">--</div>
      <span id="neutralValue" class="text-sm text-slate-500">Neutral: --</span>
    </div>

    <!-- Chart -->
    <div class="chart-container">
      <div id="legendContainer" class="chart-legend">
        <div class="legend-item">
          <span class="legend-line" style="background: #a855f7;"></span>
          Bull-Bear Spread
        </div>
      </div>
      <div style="height: 360px;">
        <canvas id="aaiiChart"></canvas>
      </div>
    </div>


  </div>

  <script type="module">
    import { getRecessionAnnotations } from '../../../shared/chart-annotations.js';

    // ========================================
    // DATA & STATE
    // ========================================
    let allData = [];
    let sp500Data = [];
    let chart = null;
    let currentPeriod = 730;
    let currentLabel = '2Y';
    let showSP500 = false;
    let customStart = null;
    let customEnd = null;

    const THRESHOLDS = {
      EXTREME_BULLISH: 20,
      EXTREME_BEARISH: -20
    };

    // ========================================
    // FETCH DATA
    // ========================================
    async function fetchData() {
      try {
        const [aaiiRes, sp500Res] = await Promise.all([
          fetch('../../../../../data/sentiment/aaii.json'),
          fetch('../../../../../data/indices/sp500.json')
        ]);
        allData = await aaiiRes.json();
        sp500Data = await sp500Res.json();
        allData.sort((a, b) => new Date(a.date) - new Date(b.date));
        sp500Data.sort((a, b) => new Date(a.date) - new Date(b.date));
      } catch (error) {
        console.error('Failed to fetch data:', error);
      }
    }

    // ========================================
    // FILTER DATA
    // ========================================
    function filterByPeriod(data, period) {
      if (period === 'ytd') {
        const year = new Date().getFullYear();
        return data.filter(d => new Date(d.date).getFullYear() === year);
      }
      if (typeof period === 'string' && period.startsWith('since_')) {
        const year = parseInt(period.replace('since_', ''));
        return data.filter(d => new Date(d.date).getFullYear() >= year);
      }
      if (period === 'custom' && customStart && customEnd) {
        const start = new Date(customStart);
        const end = new Date(customEnd);
        return data.filter(d => {
          const date = new Date(d.date);
          return date >= start && date <= end;
        });
      }
      if (period >= 9999) return data;
      const cutoff = new Date();
      cutoff.setDate(cutoff.getDate() - period);
      return data.filter(d => new Date(d.date) >= cutoff);
    }

    // ========================================
    // MERGE AAII + S&P 500
    // ========================================
    function mergeSP500WithAAII(aaiiData, sp500Data) {
      const sp500Map = new Map();
      sp500Data.forEach(d => sp500Map.set(d.date, d.value));

      return aaiiData.map(aaii => {
        const aaiiDate = new Date(aaii.date);
        let closestValue = null;
        let minDiff = Infinity;

        for (let i = -3; i <= 3; i++) {
          const checkDate = new Date(aaiiDate);
          checkDate.setDate(checkDate.getDate() + i);
          const dateStr = checkDate.toISOString().split('T')[0];
          if (sp500Map.has(dateStr)) {
            const diff = Math.abs(i);
            if (diff < minDiff) {
              minDiff = diff;
              closestValue = sp500Map.get(dateStr);
            }
          }
        }

        return {
          date: aaii.date,
          spread: aaii.bullish - aaii.bearish,
          bullish: aaii.bullish,
          bearish: aaii.bearish,
          neutral: aaii.neutral,
          sp500: closestValue
        };
      });
    }

    // ========================================
    // UPDATE DISPLAY
    // ========================================
    function updateCurrentDisplay(data) {
      if (!data.length) return;

      const latest = data[data.length - 1];
      const spread = latest.spread;

      document.getElementById('spreadValue').textContent = (spread > 0 ? '+' : '') + spread.toFixed(1);
      document.getElementById('bullishValue').textContent = (latest.bullish || 0).toFixed(1) + '%';
      document.getElementById('bearishValue').textContent = (latest.bearish || 0).toFixed(1) + '%';
      document.getElementById('neutralValue').textContent = 'Neutral: ' + (latest.neutral || 0).toFixed(1) + '%';
      document.getElementById('currentDate').textContent = latest.date;

      const spreadEl = document.getElementById('spreadValue');
      spreadEl.className = spread > 0 ? 'stat-value text-green-600' : spread < 0 ? 'stat-value text-red-600' : 'stat-value text-slate-600';

      const badge = document.getElementById('statusBadge');
      if (spread >= THRESHOLDS.EXTREME_BULLISH) {
        badge.textContent = 'EXTREME BULLISH';
        badge.className = 'px-4 py-2 rounded-lg text-sm font-bold bg-green-700 text-white';
      } else if (spread > 10) {
        badge.textContent = 'BULLISH';
        badge.className = 'px-4 py-2 rounded-lg text-sm font-bold bg-green-100 text-green-800';
      } else if (spread <= THRESHOLDS.EXTREME_BEARISH) {
        badge.textContent = 'EXTREME BEARISH';
        badge.className = 'px-4 py-2 rounded-lg text-sm font-bold bg-red-800 text-white';
      } else if (spread < -10) {
        badge.textContent = 'BEARISH';
        badge.className = 'px-4 py-2 rounded-lg text-sm font-bold bg-red-100 text-red-800';
      } else {
        badge.textContent = 'NEUTRAL';
        badge.className = 'px-4 py-2 rounded-lg text-sm font-bold bg-slate-100 text-slate-700';
      }
    }

    // ========================================
    // UPDATE LEGEND
    // ========================================
    function updateLegend() {
      const container = document.getElementById('legendContainer');
      let html = `
        <div class="legend-item">
          <span class="legend-line" style="background: #a855f7;"></span>
          Bull-Bear Spread
        </div>
      `;

      if (showSP500) {
        html += `
          <div class="legend-item">
            <span class="legend-line dashed" style="color: #f97316;"></span>
            S&P 500 (%)
          </div>
        `;
      }

      html += `
        <div class="legend-item">
          <span class="legend-box" style="background: rgba(22, 163, 74, 0.15);"></span>
          Extreme Bull (‚â•+20)
        </div>
        <div class="legend-item">
          <span class="legend-box" style="background: rgba(220, 38, 38, 0.15);"></span>
          Extreme Bear (‚â§-20)
        </div>
      `;

      container.innerHTML = html;
    }

    // ========================================
    // RENDER CHART
    // ========================================
    function renderChart(mergedData) {
      const ctx = document.getElementById('aaiiChart').getContext('2d');
      const dates = mergedData.map(d => d.date);
      const spreadData = mergedData.map(d => d.spread);

      const recessionAnnotations = dates.length > 0
        ? getRecessionAnnotations(dates[0], dates[dates.length - 1])
        : {};

      const zoneAnnotations = {
        zone_bullish: {
          type: 'box',
          yScaleID: 'y',
          yMin: THRESHOLDS.EXTREME_BULLISH,
          yMax: 60,
          backgroundColor: 'rgba(22, 163, 74, 0.08)',
          borderWidth: 0
        },
        zone_bearish: {
          type: 'box',
          yScaleID: 'y',
          yMin: -60,
          yMax: THRESHOLDS.EXTREME_BEARISH,
          backgroundColor: 'rgba(220, 38, 38, 0.08)',
          borderWidth: 0
        },
        line_zero: {
          type: 'line',
          yScaleID: 'y',
          yMin: 0,
          yMax: 0,
          borderColor: '#94a3b8',
          borderWidth: 1.5
        },
        line_bullish: {
          type: 'line',
          yScaleID: 'y',
          yMin: THRESHOLDS.EXTREME_BULLISH,
          yMax: THRESHOLDS.EXTREME_BULLISH,
          borderColor: '#22c55e',
          borderWidth: 1.5,
          borderDash: [5, 5],
          label: {
            display: true,
            content: '+20',
            position: 'end',
            backgroundColor: 'rgba(34, 197, 94, 0.9)',
            color: '#fff',
            font: { size: 10, weight: 'bold' },
            padding: { x: 6, y: 3 },
            borderRadius: 4
          }
        },
        line_bearish: {
          type: 'line',
          yScaleID: 'y',
          yMin: THRESHOLDS.EXTREME_BEARISH,
          yMax: THRESHOLDS.EXTREME_BEARISH,
          borderColor: '#ef4444',
          borderWidth: 1.5,
          borderDash: [5, 5],
          label: {
            display: true,
            content: '-20',
            position: 'end',
            backgroundColor: 'rgba(239, 68, 68, 0.9)',
            color: '#fff',
            font: { size: 10, weight: 'bold' },
            padding: { x: 6, y: 3 },
            borderRadius: 4
          }
        }
      };

      const datasets = [{
        label: 'Bull-Bear Spread',
        data: spreadData,
        borderColor: '#a855f7',
        backgroundColor: 'rgba(168, 85, 247, 0.08)',
        fill: true,
        tension: 0.4,
        pointRadius: 0,
        pointHoverRadius: 6,
        pointHoverBackgroundColor: '#a855f7',
        pointHoverBorderColor: '#fff',
        pointHoverBorderWidth: 2,
        borderWidth: 3,
        yAxisID: 'y'
      }];

      const scales = {
        x: {
          type: 'time',
          time: {
            unit: currentPeriod <= 365 ? 'month' : currentPeriod <= 1825 ? 'quarter' : 'year',
            displayFormats: { month: 'MMM yy', quarter: 'MMM yy', year: 'yyyy' }
          },
          grid: { display: false },
          ticks: {
            maxTicksLimit: 8,
            color: '#94a3b8',
            font: { size: 11, weight: 500 }
          },
          border: { display: false }
        },
        y: {
          position: 'left',
          min: -50,
          max: 50,
          title: {
            display: true,
            text: 'Spread',
            color: '#a855f7',
            font: { weight: 'bold', size: 12 }
          },
          grid: { color: '#f1f5f9', lineWidth: 1 },
          ticks: {
            color: '#a855f7',
            font: { weight: '600', size: 11 },
            callback: (v) => (v > 0 ? '+' : '') + v
          },
          border: { display: false }
        }
      };

      if (showSP500) {
        const sp500Values = mergedData.map(d => d.sp500);
        const firstValidIndex = sp500Values.findIndex(v => v !== null);
        if (firstValidIndex >= 0) {
          const baseValue = sp500Values[firstValidIndex];
          const normalizedSP500 = sp500Values.map(v =>
            v !== null ? ((v - baseValue) / baseValue) * 100 : null
          );

          datasets.push({
            label: 'S&P 500 (%)',
            data: normalizedSP500,
            borderColor: '#64748b',
            backgroundColor: 'transparent',
            fill: false,
            tension: 0.4,
            pointRadius: 0,
            pointHoverRadius: 5,
            pointHoverBackgroundColor: '#64748b',
            pointHoverBorderColor: '#fff',
            pointHoverBorderWidth: 2,
            borderWidth: 2,
            yAxisID: 'y2',
            spanGaps: true
          });

          scales.y2 = {
            position: 'right',
            title: {
              display: true,
              text: 'S&P 500 (%)',
              color: '#64748b',
              font: { weight: 'bold', size: 12 }
            },
            grid: { drawOnChartArea: false },
            ticks: {
              color: '#64748b',
              font: { weight: '600', size: 11 },
              callback: (v) => (v > 0 ? '+' : '') + v.toFixed(0) + '%'
            },
            border: { display: false }
          };
        }
      }

      updateCurrentDisplay(mergedData);
      updateLegend();

      const config = {
        type: 'line',
        data: { labels: dates, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          scales,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: '#0f172a',
              titleColor: '#f8fafc',
              bodyColor: '#e2e8f0',
              titleFont: { size: 13, weight: 600 },
              bodyFont: { size: 12 },
              padding: 12,
              cornerRadius: 10,
              displayColors: true,
              boxWidth: 8,
              boxHeight: 8,
              callbacks: {
                title: (items) => items[0].label,
                label: (context) => {
                  const v = context.parsed.y;
                  if (context.dataset.label === 'S&P 500 (%)') {
                    return ` S&P 500: ${v > 0 ? '+' : ''}${v?.toFixed(1) || '--'}%`;
                  }
                  return ` Spread: ${v > 0 ? '+' : ''}${v?.toFixed(1) || '--'}`;
                }
              }
            },
            annotation: { annotations: { ...recessionAnnotations, ...zoneAnnotations } }
          }
        }
      };

      if (chart) chart.destroy();
      chart = new Chart(ctx, config);
    }

    // ========================================
    // EVENT HANDLERS
    // ========================================
    function setupEventHandlers() {
      const btn = document.getElementById('periodBtn');
      const panel = document.getElementById('periodPanel');
      const backdrop = document.getElementById('periodBackdrop');
      const labelEl = document.getElementById('periodLabel');

      btn.addEventListener('click', () => {
        btn.classList.toggle('open');
        panel.classList.toggle('open');
        backdrop.classList.toggle('open');
      });

      backdrop.addEventListener('click', () => {
        btn.classList.remove('open');
        panel.classList.remove('open');
        backdrop.classList.remove('open');
      });

      document.querySelectorAll('.period-option').forEach(option => {
        option.addEventListener('click', () => {
          const periodValue = option.dataset.period;
          const label = option.dataset.label;

          document.querySelectorAll('.period-option').forEach(o => o.classList.remove('active'));
          option.classList.add('active');

          if (periodValue === 'ytd' || periodValue.startsWith('since_')) {
            currentPeriod = periodValue;
          } else {
            currentPeriod = parseInt(periodValue);
          }
          currentLabel = label;
          labelEl.textContent = label;

          btn.classList.remove('open');
          panel.classList.remove('open');
          backdrop.classList.remove('open');

          const filtered = filterByPeriod(allData, currentPeriod);
          const merged = mergeSP500WithAAII(filtered, sp500Data);
          renderChart(merged);
        });
      });

      // Custom date range
      const startInput = document.getElementById('startDate');
      const endInput = document.getElementById('endDate');
      const applyBtn = document.getElementById('applyCustom');

      endInput.value = new Date().toISOString().split('T')[0];

      applyBtn.addEventListener('click', () => {
        customStart = startInput.value;
        customEnd = endInput.value;
        if (!customStart || !customEnd) return;

        document.querySelectorAll('.period-option').forEach(o => o.classList.remove('active'));
        currentPeriod = 'custom';
        currentLabel = 'Custom';
        labelEl.textContent = 'Custom';

        btn.classList.remove('open');
        panel.classList.remove('open');
        backdrop.classList.remove('open');

        const filtered = filterByPeriod(allData, currentPeriod);
        const merged = mergeSP500WithAAII(filtered, sp500Data);
        renderChart(merged);
      });

      // S&P 500 overlay toggle
      document.getElementById('sp500Overlay').addEventListener('click', () => {
        showSP500 = !showSP500;
        document.getElementById('sp500Overlay').classList.toggle('active', showSP500);

        const filtered = filterByPeriod(allData, currentPeriod);
        const merged = mergeSP500WithAAII(filtered, sp500Data);
        renderChart(merged);
      });
    }

    // ========================================
    // INITIALIZE
    // ========================================
    async function init() {
      await fetchData();
      const filtered = filterByPeriod(allData, currentPeriod);
      const merged = mergeSP500WithAAII(filtered, sp500Data);
      renderChart(merged);
      setupEventHandlers();
    }

    init();
  </script>

</body>
</html>
