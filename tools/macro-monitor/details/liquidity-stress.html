<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Liquidity Stress Monitor | 100xFenok</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1/dist/chartjs-plugin-annotation.min.js"></script>

  <!-- Constants & DataManager ES Module import -->
  <script type="module">
    import { DataManager } from '../shared/data-manager.js';
    import { THRESHOLDS, COLORS, LABELS } from '../shared/constants.js';
    import { getRecessionAnnotations } from '../shared/chart-annotations.js';
    window.DataManager = DataManager;
    window.THRESHOLDS = THRESHOLDS;
    window.COLORS = COLORS;
    window.LABELS = LABELS;
    window.getRecessionAnnotations = getRecessionAnnotations;
  </script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      color: #1e293b;
      min-height: 100vh;
      display: flex; justify-content: center;
    }
    .container { width: 100%; max-width: 1000px; padding: 32px 20px; }
    
    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
    .header-left { display: flex; align-items: center; gap: 16px; }
    .back-btn { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: #fff; border: 1px solid #cbd5e1; border-radius: 12px; color: #64748b; cursor: pointer; transition: all 0.2s ease; }
    .back-btn:hover { background: #f1f5f9; color: #0f172a; transform: translateY(-1px); }
    .title-group h1 { font-family: 'Orbitron', sans-serif; font-size: 22px; font-weight: 700; color: #0f172a; margin-bottom: 4px; }
    .title-group p { font-size: 13px; color: #64748b; font-weight: 500; }
    
    .header-right { text-align: right; }
    .status-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
    .status-dot { width: 8px; height: 8px; background: #166534; border-radius: 50%; animation: pulse 2s infinite; }
    .update-time { display: block; margin-top: 6px; font-family: 'Orbitron', sans-serif; font-size: 11px; color: #94a3b8; }

    .dashboard-card { background: #ffffff; border-radius: 24px; border: 1px solid #e2e8f0; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05); padding: 32px; margin-bottom: 24px; }
    
    .metrics-row { display: flex; justify-content: space-around; align-items: center; padding-bottom: 32px; border-bottom: 1px solid #f1f5f9; margin-bottom: 24px; }
    .metric-item { text-align: center; }
    .metric-label { font-size: 11px; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
    .metric-val { font-family: 'Orbitron', sans-serif; font-size: 24px; font-weight: 700; color: #334155; }
    .metric-val.main { font-size: 42px; background: linear-gradient(135deg, #2563eb, #4f46e5); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .metric-unit { font-size: 12px; color: #94a3b8; margin-left: 2px; }

    .chart-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .chart-title { font-size: 14px; font-weight: 600; color: #475569; display: flex; align-items: center; gap: 8px; }
    .period-selector { display: flex; gap: 4px; background: #f8fafc; padding: 4px; border-radius: 8px; border: 1px solid #e2e8f0; }
    .p-btn { border: none; background: none; padding: 6px 12px; font-size: 11px; font-weight: 600; color: #64748b; cursor: pointer; border-radius: 6px; transition: all 0.2s; }
    .p-btn:hover { background: #fff; color: #0f172a; }
    .p-btn.active { background: #ffffff; color: #2563eb; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

    .chart-wrapper { position: relative; height: 340px; width: 100%; }

    /* ===== 모바일 탭 전환 UI (<600px) ===== */
    .metric-tabs {
      display: none;  /* 기본: 숨김 (PC/태블릿) */
      gap: 0;
      background: #f1f5f9;
      border-radius: 12px;
      padding: 4px;
      margin-bottom: 16px;
    }
    .metric-tab {
      flex: 1;
      border: none;
      background: transparent;
      padding: 10px 16px;
      font-size: 13px;
      font-weight: 600;
      color: #64748b;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s;
    }
    .metric-tab.active {
      background: #ffffff;
      color: #2563eb;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .metric-tab:hover:not(.active) {
      color: #1e293b;
    }

    /* 스와이프 인디케이터 (모바일) */
    .swipe-indicator {
      display: none;  /* 기본: 숨김 */
      justify-content: center;
      align-items: center;
      gap: 6px;
      margin-top: 12px;
      padding: 8px 0;
    }
    .swipe-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #cbd5e1;
      transition: all 0.2s;
    }
    .swipe-dot.active {
      background: #2563eb;
      transform: scale(1.2);
    }
    .swipe-hint {
      font-size: 11px;
      color: #94a3b8;
      margin-left: 8px;
    }

    /* 모바일 전용 Legend (간소화) */
    .mobile-legend {
      display: none;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #f1f5f9;
    }
    .mobile-legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      color: #64748b;
      font-weight: 500;
    }
    .mobile-legend-color {
      width: 10px;
      height: 10px;
      border-radius: 2px;
    }

    /* ===== 반응형 Breakpoints ===== */
    /* 모바일: <600px (탭 전환 + 스와이프) */
    @media (max-width: 599px) {
      .metric-tabs { display: flex; }
      .swipe-indicator { display: flex; }
      .period-selector { display: none; }  /* 버튼 숨기고 스와이프로 */
      .custom-legend { display: none; }  /* 풀 Legend 숨김 */
      .mobile-legend { display: flex; }  /* 간소화 Legend */
      .chart-wrapper { height: 300px; }
      .chart-title { font-size: 13px; }
    }

    /* 태블릿: 600-899px (탭 전환 + 버튼) */
    @media (min-width: 600px) and (max-width: 899px) {
      .metric-tabs { display: flex; }
      .chart-wrapper { height: 320px; }
    }

    /* PC: 900px+ (듀얼 축 유지) */
    @media (min-width: 900px) {
      .chart-wrapper { height: 340px; }
    }
    
    .custom-legend { display: flex; justify-content: center; gap: 24px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #f1f5f9; }
    .legend-item { display: flex; align-items: center; gap: 6px; font-size: 12px; color: #64748b; font-weight: 500; }
    .legend-color { width: 12px; height: 12px; border-radius: 3px; }

    /* ===== 설명 카드 섹션 ===== */
    .info-cards-section {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }
    .info-card {
      background: #ffffff;
      border: 1px solid #e2e8f0;
      border-radius: 16px;
      padding: 20px;
      border-left: 4px solid #10b981;
      transition: all 0.2s ease;
    }
    .info-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .info-card.normal { border-left-color: #10b981; }
    .info-card.caution { border-left-color: #f59e0b; }
    .info-card.warning { border-left-color: #f97316; }
    .info-card.danger { border-left-color: #ef4444; }

    .info-card-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }
    .info-card-icon {
      font-size: 18px;
    }
    .info-card-title {
      flex: 1;
      font-size: 13px;
      font-weight: 700;
      color: #334155;
    }
    .info-expand-btn {
      width: 28px;
      height: 28px;
      border: none;
      background: #f1f5f9;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #64748b;
      transition: all 0.2s;
    }
    .info-expand-btn:hover {
      background: #e2e8f0;
      color: #334155;
    }
    .info-expand-btn i {
      transition: transform 0.3s ease;
    }
    .info-card.expanded .info-expand-btn i {
      transform: rotate(180deg);
    }

    .info-card-summary {
      font-size: 13px;
      color: #475569;
      line-height: 1.5;
    }
    .info-value {
      font-family: 'Orbitron', sans-serif;
      font-weight: 600;
      color: #2563eb;
    }

    .info-card-detail {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease, margin-top 0.3s ease, opacity 0.3s ease;
      opacity: 0;
    }
    .info-card.expanded .info-card-detail {
      max-height: 500px;
      margin-top: 16px;
      opacity: 1;
    }

    .info-detail-section {
      padding: 12px 0;
      border-top: 1px solid #f1f5f9;
    }
    .info-detail-section:first-child {
      padding-top: 0;
      border-top: none;
    }
    .info-detail-title {
      font-size: 11px;
      font-weight: 700;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    .info-detail-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .info-detail-list li {
      font-size: 12px;
      color: #475569;
      padding: 4px 0;
      line-height: 1.4;
    }
    .info-detail-list.numbered {
      list-style: decimal;
      padding-left: 16px;
    }
    .info-detail-text {
      font-size: 12px;
      color: #475569;
      line-height: 1.6;
      margin: 0;
    }

    .status-legend li {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .status-dot-mini {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }
    .status-dot-mini.normal { background: #10b981; }
    .status-dot-mini.caution { background: #f59e0b; }
    .status-dot-mini.warning { background: #f97316; }
    .status-dot-mini.danger { background: #ef4444; }

    .info-links {
      display: flex;
      gap: 12px;
      padding-top: 12px;
      border-top: 1px solid #f1f5f9;
      margin-top: 12px;
    }
    .info-links a {
      font-size: 11px;
      color: #2563eb;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .info-links a:hover {
      text-decoration: underline;
    }

    /* 설명 카드 반응형 - 모바일/태블릿 */
    @media (max-width: 899px) {
      .info-cards-section {
        grid-template-columns: 1fr;
      }
    }

    /* 설명 카드 반응형 - PC (≥900px): 기본 펼침 + 글씨 크기 증가 */
    @media (min-width: 900px) {
      .info-card-detail {
        max-height: 500px;
        opacity: 1;
        margin-top: 16px;
      }
      .info-expand-btn {
        display: none;
      }
      .info-card-title {
        font-size: 15px;
      }
      .info-card-summary {
        font-size: 15px;
      }
      .info-detail-title {
        font-size: 12px;
      }
      .info-detail-list li {
        font-size: 14px;
      }
      .info-detail-text {
        font-size: 14px;
      }
      .info-links a {
        font-size: 13px;
      }
    }

    /* ===== 듀얼 게이지 (안C-1: 세그먼트형) ===== */
    .dual-gauge-section {
      background: #ffffff;
      border-radius: 24px;
      border: 1px solid #e2e8f0;
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05);
      padding: 24px;
      margin-bottom: 24px;
    }
    .dual-gauge-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }
    .gauge-card {
      background: #f8fafc;
      border-radius: 16px;
      padding: 20px;
      border: 1px solid #e2e8f0;
    }
    .gauge-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }
    .gauge-title {
      font-size: 11px;
      font-weight: 700;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .gauge-value-wrap {
      text-align: right;
    }
    .gauge-value {
      font-family: 'Orbitron', sans-serif;
      font-size: 28px;
      font-weight: 700;
      color: #0f172a;
      line-height: 1;
    }
    .gauge-unit {
      font-size: 14px;
      color: #64748b;
      margin-left: 2px;
    }
    .gauge-status {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      margin-top: 6px;
    }
    .status-normal { background: #dcfce7; color: #166534; }
    .status-caution { background: #fef9c3; color: #854d0e; }
    .status-warning { background: #ffedd5; color: #9a3412; }
    .status-danger { background: #fee2e2; color: #991b1b; }

    /* 세그먼트 프로그레스 바 */
    .segment-bar {
      display: flex;
      height: 20px;
      border-radius: 10px;
      overflow: hidden;
      background: #e2e8f0;
      position: relative;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.06);
    }
    .segment {
      flex: 1;
      position: relative;
      border-right: 2px solid white;
    }
    .segment:last-child { border-right: none; }
    /* 파스텔 테마 (테마3) */
    .seg-normal { background: #86efac; }
    .seg-caution { background: #fde047; }
    .seg-warning { background: #fdba74; }
    .seg-danger { background: #fca5a5; }

    /* 현재 위치 마커 */
    .gauge-marker {
      position: absolute;
      top: -6px;
      width: 4px;
      height: 32px;
      background: #1e293b;
      border-radius: 2px;
      transform: translateX(-50%);
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      z-index: 10;
    }
    .gauge-marker::after {
      content: '';
      position: absolute;
      bottom: -6px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-top: 8px solid #1e293b;
    }

    /* 구간 라벨 */
    .segment-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      padding: 0 2px;
    }
    .segment-labels span {
      font-size: 10px;
      color: #94a3b8;
      font-weight: 500;
    }
    .zone-labels {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 4px;
      margin-top: 12px;
    }
    .zone-label {
      text-align: center;
      font-size: 10px;
      font-weight: 600;
      padding: 4px;
      border-radius: 6px;
    }
    .zone-normal { background: #dcfce7; color: #166534; }
    .zone-caution { background: #fef9c3; color: #854d0e; }
    .zone-warning { background: #ffedd5; color: #9a3412; }
    .zone-danger { background: #fee2e2; color: #991b1b; }
    .zone-active { font-weight: 800; box-shadow: 0 0 0 2px #1e293b; }

    /* 모바일: 세로 배치 */
    @media (max-width: 768px) {
      .dual-gauge-container {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      .gauge-value { font-size: 24px; }
      .gauge-card { padding: 16px; }
      .custom-legend {
        flex-wrap: wrap;
        gap: 12px 16px;
      }
      .legend-item { font-size: 11px; }
    }

    .concept-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
    .concept-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 16px; padding: 20px; }
    .cc-head { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    .cc-icon { width: 32px; height: 32px; background: #eff6ff; color: #3b82f6; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px; }
    .cc-title { font-size: 13px; font-weight: 700; color: #1e293b; }
    .cc-body { font-size: 12px; color: #64748b; line-height: 1.5; }

    @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(0.9); } 100% { opacity: 1; transform: scale(1); } }
    @media (max-width: 768px) {
      .container { padding: 16px; }
      .page-header { flex-direction: column; align-items: flex-start; gap: 16px; }
      .header-right { width: 100%; display: flex; justify-content: space-between; align-items: center; }
      .metrics-row { flex-direction: column; gap: 24px; }
      .chart-controls { flex-direction: column; align-items: flex-start; gap: 12px; }
      .period-selector { width: 100%; justify-content: space-between; }
      .p-btn { flex: 1; text-align: center; }
      .risk-grid, .concept-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<div class="container">
  <header class="page-header">
    <div class="header-left">
      <button class="back-btn" onclick="history.back()"><i class="fas fa-arrow-left"></i></button>
      <div class="title-group">
        <h1>Liquidity Stress Monitor</h1>
        <p>Tier1 SOFR-IORB Spread | Tier2 Reserves / GDP</p>
      </div>
    </div>
    <div class="header-right">
      <div class="status-badge" id="statusBadge"><span class="status-dot"></span> <span id="statusText">System Normal</span></div>
      <span class="update-time" id="updateTime">Last Update: --:--</span>
    </div>
  </header>

  <!-- ===== 안C: 듀얼 게이지 (상단 Hero 대체) ===== -->
  <section class="dual-gauge-section">
    <div class="dual-gauge-container">
      <!-- Tier 1: SOFR-IORB Spread -->
      <div class="gauge-card" id="spreadGauge">
        <div class="gauge-header">
          <div>
            <div class="gauge-title">Tier 1: SOFR-IORB Spread</div>
          </div>
          <div class="gauge-value-wrap">
            <div class="gauge-value" id="spreadVal">--<span class="gauge-unit">bp</span></div>
            <div class="gauge-status status-normal" id="spreadStatus">정상</div>
          </div>
        </div>
        <!-- 세그먼트 바: Spread 0bp → 40bp (정상/주의/경계/위험) -->
        <div class="segment-bar">
          <div class="segment seg-normal"></div>
          <div class="segment seg-caution"></div>
          <div class="segment seg-warning"></div>
          <div class="segment seg-danger"></div>
          <div class="gauge-marker" id="spreadMarker" style="left: 0%;"></div>
        </div>
        <div class="segment-labels">
          <span>0bp</span>
          <span>10bp</span>
          <span>20bp</span>
          <span>30bp</span>
          <span>40bp+</span>
        </div>
        <div class="zone-labels">
          <div class="zone-label zone-normal" id="spreadZone0">정상</div>
          <div class="zone-label zone-caution" id="spreadZone1">주의</div>
          <div class="zone-label zone-warning" id="spreadZone2">경계</div>
          <div class="zone-label zone-danger" id="spreadZone3">위험</div>
        </div>
      </div>

      <!-- Tier 2: Reserves / GDP -->
      <div class="gauge-card" id="rbGdpGauge">
        <div class="gauge-header">
          <div>
            <div class="gauge-title">Tier 2: Reserves / GDP</div>
          </div>
          <div class="gauge-value-wrap">
            <div class="gauge-value" id="rbGdpVal">--<span class="gauge-unit">%</span></div>
            <div class="gauge-status status-normal" id="rbGdpStatus">정상</div>
          </div>
        </div>
        <!-- 세그먼트 바: RB/GDP (8% 미만 위험 → 12%+ 정상) - Fed 기준, 범위 6-14% -->
        <div class="segment-bar">
          <div class="segment seg-danger" style="flex: 2;"></div>
          <div class="segment seg-warning" style="flex: 2;"></div>
          <div class="segment seg-caution" style="flex: 2;"></div>
          <div class="segment seg-normal" style="flex: 2;"></div>
          <div class="gauge-marker" id="rbGdpMarker" style="left: 50%;"></div>
        </div>
        <div class="segment-labels">
          <span>6%</span>
          <span>8%</span>
          <span>10%</span>
          <span>12%</span>
          <span>14%+</span>
        </div>
        <div class="zone-labels">
          <div class="zone-label zone-danger" id="rbGdpZone0">위험</div>
          <div class="zone-label zone-warning" id="rbGdpZone1">경계</div>
          <div class="zone-label zone-caution" id="rbGdpZone2">주의</div>
          <div class="zone-label zone-normal" id="rbGdpZone3">정상</div>
        </div>
      </div>
    </div>
  </section>

  <section class="dashboard-card">
    <!-- 모바일/태블릿: 메트릭 탭 전환 -->
    <div class="metric-tabs" id="metricTabs">
      <button class="metric-tab active" data-metric="spread" onclick="switchMetric('spread', this)">
        <i class="fas fa-chart-line"></i> Spread (bp)
      </button>
      <button class="metric-tab" data-metric="reserves" onclick="switchMetric('reserves', this)">
        <i class="fas fa-coins"></i> Reserves ($T)
      </button>
    </div>

    <div class="chart-controls">
      <div class="chart-title"><i class="fas fa-chart-line"></i> <span id="chartTitleText">Risk Convergence</span></div>
      <div class="period-selector">
        <button class="p-btn" onclick="updatePeriod(30, this)">1M</button>
        <button class="p-btn" onclick="updatePeriod(90, this)">3M</button>
        <button class="p-btn" onclick="updatePeriod(180, this)">6M</button>
        <button class="p-btn active" onclick="updatePeriod(365, this)">1Y</button>
        <button class="p-btn" onclick="updatePeriod(1095, this)">3Y</button>
        <button class="p-btn" onclick="updatePeriod(9999, this)">MAX</button>
      </div>
    </div>

    <div class="chart-wrapper" id="chartWrapper">
      <canvas id="liquidityChart"></canvas>
    </div>

    <!-- 모바일: 스와이프 기간 인디케이터 -->
    <div class="swipe-indicator" id="swipeIndicator">
      <div class="swipe-dot" data-period="30"></div>
      <div class="swipe-dot" data-period="90"></div>
      <div class="swipe-dot" data-period="180"></div>
      <div class="swipe-dot active" data-period="365"></div>
      <div class="swipe-dot" data-period="1095"></div>
      <div class="swipe-dot" data-period="9999"></div>
      <span class="swipe-hint">← 스와이프 →</span>
    </div>

    <!-- PC/태블릿: 풀 Legend -->
    <div class="custom-legend">
      <div class="legend-item"><div class="legend-color" style="background: #2563eb;"></div><span>Spread</span></div>
      <div class="legend-item"><div class="legend-color" style="background: rgba(16, 185, 129, 0.2); border: 1px solid #10b981;"></div><span>Reserves</span></div>
      <div class="legend-item"><div class="legend-color" style="background: #22c55e; height: 2px; border: 1px dashed #22c55e;"></div><span>12% 정상</span></div>
      <div class="legend-item"><div class="legend-color" style="background: #eab308; height: 2px; border: 1px dashed #eab308;"></div><span>10% 주의</span></div>
      <div class="legend-item"><div class="legend-color" style="background: #dc2626;"></div><span>8% 위험</span></div>
    </div>

    <!-- 모바일: 간소화 Legend -->
    <div class="mobile-legend" id="mobileLegend">
      <div class="mobile-legend-item"><div class="mobile-legend-color" style="background: #2563eb;"></div><span>Spread</span></div>
      <div class="mobile-legend-item"><div class="mobile-legend-color" style="background: #10b981;"></div><span>Reserves</span></div>
      <div class="mobile-legend-item"><div class="mobile-legend-color" style="background: #ef4444;"></div><span>경계선</span></div>
    </div>
  </section>

  <!-- ===== 설명 카드 섹션 (3개) ===== -->
  <div class="info-cards-section">
    <!-- 카드 1: 현재 상태 (동적) -->
    <div class="info-card" id="statusCard">
      <div class="info-card-header">
        <div class="info-card-icon">📊</div>
        <div class="info-card-title">현재 상태</div>
        <button class="info-expand-btn" onclick="toggleInfoCard('statusCard')">
          <i class="fas fa-chevron-down"></i>
        </button>
      </div>
      <div class="info-card-summary" id="statusSummary">
        데이터 로딩 중...
      </div>
      <div class="info-card-detail" id="statusDetail">
        <div class="info-detail-section">
          <div class="info-detail-title">현재 수치</div>
          <ul class="info-detail-list">
            <li>스프레드: <strong id="detailSpread">--</strong>bp</li>
            <li>지준/GDP 비율: <strong id="detailRbGdp">--</strong>%</li>
          </ul>
        </div>
        <div class="info-detail-section">
          <div class="info-detail-title">위험 수준 기준</div>
          <ul class="info-detail-list status-legend">
            <li><span class="status-dot-mini normal"></span> 정상: &lt;10bp</li>
            <li><span class="status-dot-mini caution"></span> 주의: 10-20bp</li>
            <li><span class="status-dot-mini warning"></span> 경계: 20-30bp</li>
            <li><span class="status-dot-mini danger"></span> 위험: &gt;30bp</li>
          </ul>
        </div>
        <div class="info-links">
          <a href="https://fred.stlouisfed.org/series/SOFR" target="_blank" rel="noopener">📊 SOFR 데이터 (FRED)</a>
          <a href="https://fred.stlouisfed.org/series/IORB" target="_blank" rel="noopener">📊 IORB 데이터 (FRED)</a>
        </div>
      </div>
    </div>

    <!-- 카드 2: 이 지표가 뭔가요? -->
    <div class="info-card" id="whatCard">
      <div class="info-card-header">
        <div class="info-card-icon">💡</div>
        <div class="info-card-title">이 지표가 뭔가요?</div>
        <button class="info-expand-btn" onclick="toggleInfoCard('whatCard')">
          <i class="fas fa-chevron-down"></i>
        </button>
      </div>
      <div class="info-card-summary">
        단기 자금시장의 건강도를 보여주는 체온계입니다
      </div>
      <div class="info-card-detail" id="whatDetail">
        <div class="info-detail-section">
          <ul class="info-detail-list">
            <li><strong>SOFR</strong> (담보부 익일물 금리): 국채를 담보로 하룻밤 빌리는 금리</li>
            <li><strong>IORB</strong> (지준 이자율): 연준이 은행 지준에 주는 이자</li>
            <li><strong>스프레드</strong> = SOFR - IORB</li>
          </ul>
        </div>
        <div class="info-detail-section">
          <p class="info-detail-text">
            정상 상황에서 SOFR는 IORB보다 약간 낮습니다(음수 스프레드).<br>
            단기 자금시장에 문제가 생기면 SOFR가 급등하며 스프레드가 양수로 전환됩니다.
          </p>
        </div>
      </div>
    </div>

    <!-- 카드 3: 왜 중요한가요? -->
    <div class="info-card" id="whyCard">
      <div class="info-card-header">
        <div class="info-card-icon">🎯</div>
        <div class="info-card-title">왜 중요한가요?</div>
        <button class="info-expand-btn" onclick="toggleInfoCard('whyCard')">
          <i class="fas fa-chevron-down"></i>
        </button>
      </div>
      <div class="info-card-summary">
        연준 정책 전환 시점을 가장 먼저 알려주는 신호등입니다
      </div>
      <div class="info-card-detail" id="whyDetail">
        <div class="info-detail-section">
          <div class="info-detail-title">핵심 메커니즘</div>
          <ol class="info-detail-list numbered">
            <li>단기 시장에 레버리지 집중</li>
            <li>지준 고갈 시 스프레드 급등</li>
            <li>연준이 완화정책 전환 압박받음</li>
          </ol>
        </div>
        <div class="info-detail-section">
          <div class="info-detail-title">역사적 사례</div>
          <ul class="info-detail-list">
            <li><strong>2019년 9월</strong>: 스프레드 급등 → 연준 긴급 개입</li>
            <li><strong>2020년 3월</strong>: 코로나 충격 → 무제한 QE 실시</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // 임계값 헬퍼 - constants.js THRESHOLDS 사용 (fallback 포함)
  const getThreshold = (category, level) => {
    if (typeof THRESHOLDS !== 'undefined' && THRESHOLDS[category]) {
      return THRESHOLDS[category][level];
    }
    // Fallback values
    const fallback = {
      SPREAD: { NORMAL: 10, CAUTION: 20, WARNING: 30, DANGER: 30 },
      RESERVES_GDP: { NORMAL: 12, CAUTION: 10, WARNING: 8, DANGER: 8 }
    };
    return fallback[category]?.[level];
  };

  // 색상 헬퍼 - constants.js COLORS 사용 (fallback 포함)
  const getColor = (category, key) => {
    if (typeof COLORS !== 'undefined' && COLORS[category]) {
      return COLORS[category][key];
    }
    // Fallback
    const fallback = {
      CHART: { SPREAD: '#2563eb', RESERVES: '#10b981' }
    };
    return fallback[category]?.[key];
  };

  const CONFIG = {
    apiKey: (window.FRED_API_KEY || localStorage.getItem('FRED_API_KEY') || '6dda7dc3956a2c1d6ac939133de115f1'),
    proxy: 'https://fed-proxy.etloveaui.workers.dev/',
    colors: {
      spread: getColor('CHART', 'SPREAD') || '#2563eb',
      reservesFill: 'rgba(16, 185, 129, 0.15)',
      reservesLine: getColor('CHART', 'RESERVES') || '#10b981',
      lclor: '#ef4444',
      grid: '#f1f5f9'
    }
  };

  async function fetchData(url) {
    const candidates = [url, CONFIG.proxy + (url.startsWith('http') ? url : ''), 'https://cors.isomorphic-git.org/' + url];
    for (const u of candidates) {
      try { const res = await fetch(u); if (res.ok) return await res.json(); } catch (e) {}
    }
    return null;
  }

  async function getSeries(seriesId, days) {
    const lookback = seriesId === 'GDP' ? 1095 : days;
    const end = new Date().toISOString().split('T')[0];
    const start = new Date(Date.now() - lookback * 86400000).toISOString().split('T')[0];
    const url = `https://fed-proxy.etloveaui.workers.dev/fred/series/observations?series_id=${seriesId}&api_key=${CONFIG.apiKey}&file_type=json&observation_start=${start}&observation_end=${end}&sort_order=asc`;
    
    const json = await fetchData(url);
    if (!json || !json.observations) return [];
    return json.observations.filter(o => o.value !== '.').map(o => ({ date: o.date, val: parseFloat(o.value) }));
  }

  // --- 3. DATA PROCESSING (High-Precision Logic) ---
  // ★★★ 핵심 로직 수정: 단위 변환 (Billions -> Trillions) ★★★
  // ★★★ 핵심 수정: mergeData 함수 (Billions -> Trillions 변환 적용) ★★★
  function mergeData(sofr, iorb, reserves, gdp) {
    // 1. 데이터 매핑
    const iorbMap = new Map(iorb.map(d => [d.date, d.val]));
    const resMap = new Map(reserves.map(d => [d.date, d.val]));
    const gdpMap = new Map(gdp.map(d => [d.date, d.val]));

    // 2. 초기값 및 고정값 설정
    // ★ GDP는 분기별 → 항상 최신값(배열 마지막) 고정 사용
    // ★ LCLoR = GDP × 10% → 차트 전체에서 수평선으로 고정
    const latestGdp = gdp.length > 0 ? gdp[gdp.length - 1].val : 30000;
    const lclorTrillion = (latestGdp * 0.10) / 1000;  // GDP(B) → T

    // Reserves 초기값 (Forward Fill용)
    let lastRes = reserves.length > 0 ? reserves[0].val : 2900000;

    const timeline = sofr.map(s => {
      const d = s.date;

      // Reserves만 Forward Fill (주간 데이터)
      if (resMap.has(d)) lastRes = resMap.get(d);

      if (iorbMap.get(d) === undefined) return null;

      // ★★★ [단위 변환] ★★★
      // WRESBAL: Millions → Trillions (÷ 1,000,000)
      const reservesTrillion = lastRes / 1000000;

      return {
        date: d,
        spread: Math.round((s.val - iorbMap.get(d)) * 100),
        reserves: reservesTrillion,
        lclor: lclorTrillion  // 모든 날짜에 동일한 값 (수평선)
      };
    }).filter(d => d !== null);

    // 최신값 (UI 표시용)
    const latestReserves = timeline.length > 0
      ? timeline[timeline.length - 1].reserves
      : lastRes / 1000000;

    return { timeline, latestLclor: lclorTrillion, latestReserves };
  }
  
  let myChart = null;
  let currentMetric = 'dual';  // 'dual' | 'spread' | 'reserves'
  let currentPeriodIdx = 3;    // 0:1M, 1:3M, 2:6M, 3:1Y, 4:3Y, 5:MAX
  const periods = [30, 90, 180, 365, 1095, 9999];
  let lastDataObj = null;      // 마지막 데이터 저장 (탭 전환용)

  // ===== 레이아웃 모드 감지 =====
  function getLayoutMode() {
    const width = window.innerWidth;
    if (width < 600) return 'mobile';
    if (width < 900) return 'tablet';
    return 'desktop';
  }

  // ===== 메트릭 탭 전환 =====
  window.switchMetric = function(metric, btn) {
    // 탭 UI 업데이트
    document.querySelectorAll('.metric-tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');

    currentMetric = metric;

    // 차트 타이틀 업데이트
    const titleText = document.getElementById('chartTitleText');
    if (metric === 'spread') {
      titleText.textContent = 'SOFR-IORB Spread Trend';
    } else if (metric === 'reserves') {
      titleText.textContent = 'Reserves vs Thresholds';
    } else {
      titleText.textContent = 'Risk Convergence';
    }

    // 차트 다시 렌더링
    if (lastDataObj) renderChart(lastDataObj);
  };

  // ===== 스와이프 기간 선택 (모바일) =====
  function setupSwipeGesture() {
    const wrapper = document.getElementById('chartWrapper');
    let touchStartX = 0;

    wrapper.addEventListener('touchstart', (e) => {
      touchStartX = e.touches[0].clientX;
    }, { passive: true });

    wrapper.addEventListener('touchend', (e) => {
      const touchEndX = e.changedTouches[0].clientX;
      const diff = touchStartX - touchEndX;

      if (Math.abs(diff) > 50) {  // 50px 이상 스와이프
        if (diff > 0 && currentPeriodIdx < periods.length - 1) {
          // 왼쪽 스와이프 → 더 긴 기간
          currentPeriodIdx++;
        } else if (diff < 0 && currentPeriodIdx > 0) {
          // 오른쪽 스와이프 → 더 짧은 기간
          currentPeriodIdx--;
        }
        updateSwipeDots();
        init(periods[currentPeriodIdx]);
      }
    }, { passive: true });
  }

  function updateSwipeDots() {
    document.querySelectorAll('.swipe-dot').forEach((dot, idx) => {
      dot.classList.toggle('active', idx === currentPeriodIdx);
    });
  }

  // ===== 화면 크기 변경 감지 =====
  function handleResize() {
    const mode = getLayoutMode();

    if (mode === 'desktop') {
      currentMetric = 'dual';
      document.getElementById('chartTitleText').textContent = 'Risk Convergence';
    }

    if (lastDataObj) renderChart(lastDataObj);
  }

  window.addEventListener('resize', handleResize);

  function renderChart(dataObj) {
    lastDataObj = dataObj;  // 저장
    const layoutMode = getLayoutMode();
    const ctx = document.getElementById('liquidityChart').getContext('2d');
    if (myChart) myChart.destroy();

    const dates = dataObj.timeline.map(d => d.date);
    const spreads = dataObj.timeline.map(d => d.spread);
    const reserves = dataObj.timeline.map(d => d.reserves);

    // 기준선 값 계산 (Fed 기준: 12%+ 정상, 10% 주의, 8% 위험)
    const gdpT = dataObj.latestLclor / 0.10;
    const line12pct = gdpT * 0.12;
    const line10pct = dataObj.latestLclor;
    const line8pct = gdpT * 0.08;

    // y축 범위 계산
    const allVals = [...reserves, dataObj.latestLclor, line8pct, line12pct];
    const minVal = Math.min(...allVals);
    const maxVal = Math.max(...allVals);
    const yRightMin = minVal * 0.95;
    const yRightMax = maxVal * 1.03;

    // Gradients
    const reservesGradient = ctx.createLinearGradient(0, 0, 0, 400);
    reservesGradient.addColorStop(0, 'rgba(16, 185, 129, 0.3)');
    reservesGradient.addColorStop(0.5, 'rgba(16, 185, 129, 0.1)');
    reservesGradient.addColorStop(1, 'rgba(16, 185, 129, 0.02)');

    const spreadGradient = ctx.createLinearGradient(0, 0, 0, 400);
    spreadGradient.addColorStop(0, '#3b82f6');
    spreadGradient.addColorStop(1, '#1d4ed8');

    // ===== 반응형 모드별 차트 설정 =====
    const showDual = (layoutMode === 'desktop') || (layoutMode !== 'desktop' && currentMetric === 'dual');
    const showSpreadOnly = (layoutMode !== 'desktop' && currentMetric === 'spread');
    const showReservesOnly = (layoutMode !== 'desktop' && currentMetric === 'reserves');

    // 모바일/태블릿에서 탭 선택 없으면 기본 spread
    const effectiveMetric = (layoutMode !== 'desktop' && currentMetric === 'dual') ? 'spread' : currentMetric;

    // 데이터셋 구성
    let datasets = [];
    let scales = {};
    let annotations = {};

    if (layoutMode === 'desktop' || effectiveMetric === 'dual') {
      // PC: 듀얼 축 (기존)
      datasets = [
        {
          label: 'Spread',
          data: spreads,
          borderColor: spreadGradient,
          borderWidth: 2.5,
          tension: 0,
          pointRadius: 0,
          pointHoverRadius: 6,
          pointHoverBackgroundColor: '#2563eb',
          pointHoverBorderColor: '#fff',
          pointHoverBorderWidth: 2,
          yAxisID: 'y_left',
          order: 1
        },
        {
          label: 'Reserves',
          data: reserves,
          borderColor: CONFIG.colors.reservesLine,
          backgroundColor: reservesGradient,
          borderWidth: 2,
          fill: true,
          tension: 0.3,
          pointRadius: 0,
          pointHoverRadius: 5,
          pointHoverBackgroundColor: '#10b981',
          pointHoverBorderColor: '#fff',
          pointHoverBorderWidth: 2,
          yAxisID: 'y_right',
          order: 2
        }
      ];
      scales = {
        x: { grid: { display: false }, ticks: { maxTicksLimit: layoutMode === 'mobile' ? 4 : 6, font: { size: 10 } } },
        y_left: {
          type: 'linear', position: 'left',
          grid: { color: CONFIG.colors.grid },
          ticks: { callback: v => v + 'bp', color: CONFIG.colors.spread, font: { weight: 'bold', size: 10 } }
        },
        y_right: {
          type: 'linear', position: 'right',
          min: yRightMin, max: yRightMax,
          grid: { display: false },
          ticks: { callback: v => '$' + v.toFixed(2) + 'T', color: '#10b981', font: { size: 10 } }
        }
      };
      annotations = getFullAnnotations(line12pct, line10pct, line8pct, yRightMin, yRightMax);

    } else if (effectiveMetric === 'spread') {
      // Spread Only (전체 Y축 활용)
      datasets = [{
        label: 'Spread',
        data: spreads,
        borderColor: '#2563eb',
        backgroundColor: 'rgba(37, 99, 235, 0.1)',
        borderWidth: 3,
        tension: 0,
        pointRadius: 0,
        pointHoverRadius: 8,
        pointHoverBackgroundColor: '#2563eb',
        pointHoverBorderColor: '#fff',
        pointHoverBorderWidth: 3,
        fill: true,
        yAxisID: 'y'
      }];
      scales = {
        x: { grid: { display: false }, ticks: { maxTicksLimit: 5, font: { size: 11 } } },
        y: {
          type: 'linear', position: 'left',
          grid: { color: '#f1f5f9' },
          ticks: {
            callback: v => v + 'bp',
            color: '#2563eb',
            font: { weight: 'bold', size: 12 }
          },
          title: { display: true, text: 'SOFR-IORB Spread (bp)', font: { size: 12, weight: '600' }, color: '#2563eb' }
        }
      };
      // Spread 임계선 (30bp 위험) - 모바일: 좌측 + 반투명
      annotations = {
        line30: {
          type: 'line', yMin: 30, yMax: 30, yScaleID: 'y',
          borderColor: '#dc2626', borderWidth: 2, borderDash: [6, 4],
          label: { display: true, content: '30bp 위험', position: 'start', backgroundColor: 'rgba(254, 226, 226, 0.85)', color: '#991b1b', font: { size: 10, weight: 'bold' }, padding: 4 }
        },
        line20: {
          type: 'line', yMin: 20, yMax: 20, yScaleID: 'y',
          borderColor: '#f59e0b', borderWidth: 1.5, borderDash: [4, 4],
          label: { display: true, content: '20bp 경계', position: 'start', backgroundColor: 'rgba(254, 243, 199, 0.8)', color: '#92400e', font: { size: 9 }, padding: 3 }
        },
        line10: {
          type: 'line', yMin: 10, yMax: 10, yScaleID: 'y',
          borderColor: '#eab308', borderWidth: 1, borderDash: [4, 4],
          label: { display: true, content: '10bp 주의', position: 'start', backgroundColor: 'rgba(254, 249, 195, 0.8)', color: '#854d0e', font: { size: 9 }, padding: 3 }
        }
      };

    } else if (effectiveMetric === 'reserves') {
      // Reserves Only (전체 Y축 + 임계선)
      datasets = [{
        label: 'Reserves',
        data: reserves,
        borderColor: '#10b981',
        backgroundColor: reservesGradient,
        borderWidth: 3,
        tension: 0.3,
        pointRadius: 0,
        pointHoverRadius: 8,
        pointHoverBackgroundColor: '#10b981',
        pointHoverBorderColor: '#fff',
        pointHoverBorderWidth: 3,
        fill: true,
        yAxisID: 'y'
      }];
      scales = {
        x: { grid: { display: false }, ticks: { maxTicksLimit: 5, font: { size: 11 } } },
        y: {
          type: 'linear', position: 'left',
          min: yRightMin, max: yRightMax,
          grid: { color: '#f1f5f9' },
          ticks: {
            callback: v => '$' + v.toFixed(2) + 'T',
            color: '#10b981',
            font: { weight: 'bold', size: 12 }
          },
          title: { display: true, text: 'Reserves ($T)', font: { size: 12, weight: '600' }, color: '#10b981' }
        }
      };
      // Reserves 임계선 - 모바일: 좌측 + 반투명 (Fed 기준: 12%+ 정상, 10-12% 주의, 8-10% 경계, <8% 위험)
      annotations = {
        zone12: { type: 'box', yScaleID: 'y', yMin: line12pct, yMax: yRightMax, backgroundColor: 'rgba(134, 239, 172, 0.12)', borderWidth: 0 },
        zone10: { type: 'box', yScaleID: 'y', yMin: line10pct, yMax: line12pct, backgroundColor: 'rgba(253, 224, 71, 0.10)', borderWidth: 0 },
        zone8: { type: 'box', yScaleID: 'y', yMin: line8pct, yMax: line10pct, backgroundColor: 'rgba(253, 186, 116, 0.10)', borderWidth: 0 },
        zoneDanger: { type: 'box', yScaleID: 'y', yMin: yRightMin, yMax: line8pct, backgroundColor: 'rgba(252, 165, 165, 0.12)', borderWidth: 0 },
        line12: {
          type: 'line', yMin: line12pct, yMax: line12pct, yScaleID: 'y',
          borderColor: '#22c55e', borderWidth: 2, borderDash: [6, 4],
          label: { display: true, content: `12% 정상`, position: 'start', backgroundColor: 'rgba(220, 252, 231, 0.85)', color: '#166534', font: { size: 10, weight: 'bold' }, padding: 4 }
        },
        line10: {
          type: 'line', yMin: line10pct, yMax: line10pct, yScaleID: 'y',
          borderColor: '#eab308', borderWidth: 2, borderDash: [6, 4],
          label: { display: true, content: `10% 주의`, position: 'start', backgroundColor: 'rgba(254, 249, 195, 0.85)', color: '#854d0e', font: { size: 10, weight: 'bold' }, padding: 4 }
        },
        line8: {
          type: 'line', yMin: line8pct, yMax: line8pct, yScaleID: 'y',
          borderColor: '#dc2626', borderWidth: 3,
          label: { display: true, content: `8% 위험`, position: 'start', backgroundColor: 'rgba(220, 38, 38, 0.9)', color: '#fff', font: { size: 10, weight: 'bold' }, padding: 4 }
        }
      };
    }

    // ===== 리세션 음영 추가 =====
    const chartStart = dates[0];
    const chartEnd = dates[dates.length - 1];
    console.log('[Chart] 날짜 범위:', chartStart, '~', chartEnd);

    if (typeof getRecessionAnnotations === 'function') {
      const recessionAnnotations = getRecessionAnnotations(chartStart, chartEnd, { showLabel: true });
      console.log('[Chart] 리세션 annotations:', Object.keys(recessionAnnotations).length, '개');

      if (Object.keys(recessionAnnotations).length === 0) {
        console.log('[Chart] 해당 기간에 리세션 없음 (COVID는 2020-02~04)');
      }

      // Category 축에서는 라벨과 정확히 일치해야 함 → 가장 가까운 날짜로 매핑
      const findClosestLabel = (targetDate) => {
        const target = new Date(targetDate).getTime();
        let closest = dates[0];
        let minDiff = Math.abs(new Date(dates[0]).getTime() - target);
        for (const d of dates) {
          const diff = Math.abs(new Date(d).getTime() - target);
          if (diff < minDiff) { minDiff = diff; closest = d; }
        }
        return closest;
      };

      // 리세션 날짜를 차트 라벨에 맞게 조정
      Object.entries(recessionAnnotations).forEach(([key, val]) => {
        const mappedMin = findClosestLabel(val.xMin);
        const mappedMax = findClosestLabel(val.xMax);
        console.log(`[Chart] ${key}: ${val.xMin} → ${mappedMin}, ${val.xMax} → ${mappedMax}`);
        recessionAnnotations[key].xMin = mappedMin;
        recessionAnnotations[key].xMax = mappedMax;
      });

      annotations = { ...annotations, ...recessionAnnotations };
    }

    myChart = new Chart(ctx, {
      type: 'line',
      data: { labels: dates, datasets: datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { display: false },
          tooltip: {
            enabled: true,
            backgroundColor: 'rgba(15, 23, 42, 0.95)',
            titleFont: { family: 'Inter', size: 13, weight: '600' },
            bodyFont: { family: 'Orbitron', size: 14, weight: '500' },
            padding: 12,
            cornerRadius: 10,
            displayColors: true,
            callbacks: {
              title: (items) => `📅 ${items[0].label}`,
              label: (ctx) => {
                const val = ctx.raw;
                if (ctx.dataset.label === 'Spread') {
                  const status = val < 10 ? '🟢 정상' : val < 20 ? '🟡 주의' : val < 30 ? '🟠 경계' : '🔴 위험';
                  return ` Spread: ${val}bp ${status}`;
                }
                return ` Reserves: $${val.toFixed(2)}T`;
              },
              afterBody: (items) => {
                const spreadVal = items.find(i => i.dataset.label === 'Spread')?.raw;
                const resVal = items.find(i => i.dataset.label === 'Reserves')?.raw;
                if (spreadVal !== undefined && resVal !== undefined) {
                  return [`\n RB/GDP: ${(resVal / gdpT * 100).toFixed(1)}%`];
                }
                return [];
              }
            }
          },
          zoom: { zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' }, pan: { enabled: true, mode: 'x' } },
          annotation: { annotations: annotations }
        },
        scales: scales
      },
      plugins: [{
        id: 'glowEffect',
        beforeDatasetsDraw: (chart) => {
          chart.ctx.save();
          chart.ctx.shadowColor = 'rgba(37, 99, 235, 0.3)';
          chart.ctx.shadowBlur = 6;
        },
        afterDatasetsDraw: (chart) => {
          chart.ctx.restore();
        }
      }]
    });
  }

  // ===== PC용 Annotation 설정 (듀얼 축) - Fed 기준: 12%+ 정상, 10-12% 주의, 8-10% 경계, <8% 위험 =====
  function getFullAnnotations(line12pct, line10pct, line8pct, yRightMin, yRightMax) {
    return {
      zone12: { type: 'box', yScaleID: 'y_right', yMin: line12pct, yMax: yRightMax, backgroundColor: 'rgba(134, 239, 172, 0.08)', borderWidth: 0 },
      zone10: { type: 'box', yScaleID: 'y_right', yMin: line10pct, yMax: line12pct, backgroundColor: 'rgba(253, 224, 71, 0.08)', borderWidth: 0 },
      zone8: { type: 'box', yScaleID: 'y_right', yMin: line8pct, yMax: line10pct, backgroundColor: 'rgba(253, 186, 116, 0.08)', borderWidth: 0 },
      zoneDanger: { type: 'box', yScaleID: 'y_right', yMin: yRightMin, yMax: line8pct, backgroundColor: 'rgba(252, 165, 165, 0.12)', borderWidth: 0 },
      line12: {
        type: 'line', yMin: line12pct, yMax: line12pct, yScaleID: 'y_right',
        borderColor: '#22c55e', borderWidth: 2, borderDash: [8, 4],
        label: { display: true, content: `12% 정상 $${line12pct.toFixed(2)}T`, position: 'start', backgroundColor: '#dcfce7', color: '#166534', font: { size: 10, weight: 'bold' }, padding: 4 }
      },
      line10: {
        type: 'line', yMin: line10pct, yMax: line10pct, yScaleID: 'y_right',
        borderColor: '#eab308', borderWidth: 2, borderDash: [8, 4],
        label: { display: true, content: `10% 주의 $${line10pct.toFixed(2)}T`, position: 'start', backgroundColor: '#fef9c3', color: '#854d0e', font: { size: 10, weight: 'bold' }, padding: 4 }
      },
      line8: {
        type: 'line', yMin: line8pct, yMax: line8pct, yScaleID: 'y_right',
        borderColor: '#dc2626', borderWidth: 3,
        label: { display: true, content: `8% 위험 $${line8pct.toFixed(2)}T`, position: 'start', backgroundColor: '#dc2626', color: '#fff', font: { size: 10, weight: 'bold' }, padding: 4 }
      }
    };
  }

  // ===== 게이지 업데이트 함수들 - constants.js THRESHOLDS.SPREAD 사용 =====
  function updateSpreadGauge(spread) {
    const TH = {
      NORMAL: getThreshold('SPREAD', 'NORMAL'),
      CAUTION: getThreshold('SPREAD', 'CAUTION'),
      WARNING: getThreshold('SPREAD', 'WARNING')
    };

    let status, statusClass, zoneIdx;
    if (spread < TH.NORMAL) { status = '정상'; statusClass = 'status-normal'; zoneIdx = 0; }
    else if (spread < TH.CAUTION) { status = '주의'; statusClass = 'status-caution'; zoneIdx = 1; }
    else if (spread < TH.WARNING) { status = '경계'; statusClass = 'status-warning'; zoneIdx = 2; }
    else { status = '위험'; statusClass = 'status-danger'; zoneIdx = 3; }

    // 값 업데이트
    document.getElementById('spreadVal').innerHTML = `${spread}<span class="gauge-unit">bp</span>`;

    // 상태 뱃지 업데이트
    const statusEl = document.getElementById('spreadStatus');
    statusEl.textContent = status;
    statusEl.className = 'gauge-status ' + statusClass;

    // 마커 위치 (0-40bp 범위, 40bp 이상은 100%)
    const pct = Math.min(spread / 40 * 100, 100);
    document.getElementById('spreadMarker').style.left = pct + '%';

    // 활성 구간 표시
    for (let i = 0; i < 4; i++) {
      const el = document.getElementById('spreadZone' + i);
      el.classList.toggle('zone-active', i === zoneIdx);
    }
  }

  // constants.js THRESHOLDS.RESERVES_GDP 사용
  function updateRbGdpGauge(rbGdpRatio) {
    const TH = {
      NORMAL: getThreshold('RESERVES_GDP', 'NORMAL'),
      CAUTION: getThreshold('RESERVES_GDP', 'CAUTION'),
      WARNING: getThreshold('RESERVES_GDP', 'WARNING')
    };

    let status, statusClass, zoneIdx;
    if (rbGdpRatio >= TH.NORMAL) { status = '정상'; statusClass = 'status-normal'; zoneIdx = 3; }
    else if (rbGdpRatio >= TH.CAUTION) { status = '주의'; statusClass = 'status-caution'; zoneIdx = 2; }
    else if (rbGdpRatio >= TH.WARNING) { status = '경계'; statusClass = 'status-warning'; zoneIdx = 1; }
    else { status = '위험'; statusClass = 'status-danger'; zoneIdx = 0; }

    // 값 업데이트
    document.getElementById('rbGdpVal').innerHTML = `${rbGdpRatio.toFixed(1)}<span class="gauge-unit">%</span>`;

    // 상태 뱃지 업데이트
    const statusEl = document.getElementById('rbGdpStatus');
    statusEl.textContent = status;
    statusEl.className = 'gauge-status ' + statusClass;

    // 마커 위치 (6-14% 범위를 0-100%로 매핑)
    // 6%=0%, 8%=25%, 10%=50%, 12%=75%, 14%=100%
    const pct = Math.max(0, Math.min(100, (rbGdpRatio - 6) / 8 * 100));
    document.getElementById('rbGdpMarker').style.left = pct + '%';

    // 활성 구간 표시
    for (let i = 0; i < 4; i++) {
      const el = document.getElementById('rbGdpZone' + i);
      el.classList.toggle('zone-active', i === zoneIdx);
    }
  }

  function updateUI(dataObj) {
    const last = dataObj.timeline[dataObj.timeline.length - 1];
    const spread = last.spread;

    // Values are now already in Trillions, so direct display
    const resT = last.reserves;
    const lclorT = dataObj.latestLclor;

    // RB/GDP 비율 계산 (Reserves / GDP * 100)
    // GDP는 latestLclor / 0.10 으로 역산 가능
    const gdpT = lclorT / 0.10;
    const rbGdpRatio = (resT / gdpT) * 100;

    // 게이지 업데이트
    updateSpreadGauge(spread);
    updateRbGdpGauge(rbGdpRatio);

    // 설명 카드 업데이트
    updateInfoCards(spread, rbGdpRatio);

    // 헤더 상태 뱃지 (더 심각한 상태 표시)
    const badge = document.getElementById('statusBadge');
    const text = document.getElementById('statusText');

    // 두 지표 중 더 심각한 상태 선택 - constants.js THRESHOLDS 사용
    const SPREAD_TH = {
      NORMAL: getThreshold('SPREAD', 'NORMAL'),
      CAUTION: getThreshold('SPREAD', 'CAUTION'),
      WARNING: getThreshold('SPREAD', 'WARNING')
    };
    const RGDP_TH = {
      NORMAL: getThreshold('RESERVES_GDP', 'NORMAL'),
      CAUTION: getThreshold('RESERVES_GDP', 'CAUTION'),
      WARNING: getThreshold('RESERVES_GDP', 'WARNING')
    };

    let overallStatus = 'normal';
    if (spread >= SPREAD_TH.WARNING || rbGdpRatio < RGDP_TH.WARNING) overallStatus = 'danger';
    else if (spread >= SPREAD_TH.CAUTION || rbGdpRatio < RGDP_TH.CAUTION) overallStatus = 'warning';
    else if (spread >= SPREAD_TH.NORMAL || rbGdpRatio < RGDP_TH.NORMAL) overallStatus = 'caution';

    if (overallStatus === 'danger') {
      badge.style.cssText = 'background:#fee2e2; border-color:#fecaca; color:#dc2626';
      badge.querySelector('.status-dot').style.background = '#dc2626';
      text.innerText = 'LIQUIDITY CRISIS';
    } else if (overallStatus === 'warning') {
      badge.style.cssText = 'background:#ffedd5; border-color:#fed7aa; color:#c2410c';
      badge.querySelector('.status-dot').style.background = '#c2410c';
      text.innerText = 'High Stress';
    } else if (overallStatus === 'caution') {
      badge.style.cssText = 'background:#fef3c7; border-color:#fde68a; color:#d97706';
      badge.querySelector('.status-dot').style.background = '#d97706';
      text.innerText = 'Stress Watch';
    } else {
      badge.style.cssText = 'background:#dcfce7; border-color:#bbf7d0; color:#166534';
      badge.querySelector('.status-dot').style.background = '#166534';
      text.innerText = 'System Normal';
    }

    // lclorDisplay 요소가 없으므로 제거됨
    document.getElementById('updateTime').innerText = `Data: ${last.date}`;

    // ===== Widget용 캐시 저장 =====
    saveWidgetCache(spread, rbGdpRatio, overallStatus, last.date);
  }

  // ===== Widget 캐시 저장 함수 - constants.js THRESHOLDS 사용 =====
  function saveWidgetCache(spread, rbGdpRatio, overallStatus, date) {
    if (typeof DataManager === 'undefined') return;

    const SPREAD_TH = {
      NORMAL: getThreshold('SPREAD', 'NORMAL'),
      CAUTION: getThreshold('SPREAD', 'CAUTION'),
      WARNING: getThreshold('SPREAD', 'WARNING')
    };
    const RGDP_TH = {
      NORMAL: getThreshold('RESERVES_GDP', 'NORMAL'),
      CAUTION: getThreshold('RESERVES_GDP', 'CAUTION'),
      WARNING: getThreshold('RESERVES_GDP', 'WARNING')
    };

    // Tier1 상태 (Spread) - THRESHOLDS.SPREAD 사용
    const tier1Status = spread >= SPREAD_TH.WARNING ? 'danger' : spread >= SPREAD_TH.CAUTION ? 'warning' : spread >= SPREAD_TH.NORMAL ? 'caution' : 'normal';
    // Tier2 상태 (RB/GDP) - THRESHOLDS.RESERVES_GDP 사용
    const tier2Status = rbGdpRatio >= RGDP_TH.NORMAL ? 'normal' : rbGdpRatio >= RGDP_TH.CAUTION ? 'caution' : rbGdpRatio >= RGDP_TH.WARNING ? 'warning' : 'danger';

    // 종합 상태 라벨
    const overallLabels = {
      normal: 'Normal',
      caution: 'Caution',
      warning: 'High Stress',
      danger: 'Critical'
    };

    const statusLabels = {
      normal: '정상',
      caution: '주의',
      warning: '경계',
      danger: '위험'
    };

    const widgetData = {
      overallStatus: overallStatus,
      overallLabel: overallLabels[overallStatus] || 'Normal',
      tier1: {
        status: tier1Status,
        label: statusLabels[tier1Status],
        value: Math.round(spread),
        unit: 'bp'
      },
      tier2: {
        status: tier2Status,
        label: statusLabels[tier2Status],
        value: parseFloat(rbGdpRatio.toFixed(1)),
        unit: '%'
      },
      updated: new Date().toISOString()
    };

    DataManager.saveWidgetData('liquidity-stress', widgetData);
    console.log('[Detail] Widget cache saved:', widgetData);
  }

  async function init(days = 90) {
    const [sofr, iorb, res, gdp] = await Promise.all([
      getSeries('SOFR', days),
      getSeries('IORB', days),
      getSeries('WRESBAL', days),
      getSeries('GDP', days)
    ]);

    if (!sofr.length) return;
    
    window.lastSofr = sofr[sofr.length-1].val.toFixed(2);

    const processed = mergeData(sofr, iorb, res, gdp);
    renderChart(processed);
    updateUI(processed);
  }

  window.updatePeriod = (days, btn) => {
    document.querySelectorAll('.p-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    init(days);
  };

  // ===== 설명 카드 토글 함수 =====
  window.toggleInfoCard = function(cardId) {
    const card = document.getElementById(cardId);
    card.classList.toggle('expanded');
  };

  // ===== 설명 카드 동적 업데이트 - constants.js THRESHOLDS.SPREAD 사용 =====
  function updateInfoCards(spread, rbGdpRatio) {
    const TH = {
      NORMAL: getThreshold('SPREAD', 'NORMAL'),
      CAUTION: getThreshold('SPREAD', 'CAUTION'),
      WARNING: getThreshold('SPREAD', 'WARNING')
    };

    // 상태 판정
    let statusText, statusClass;
    if (spread < TH.NORMAL) {
      statusText = '단기 자금시장은 안정적입니다';
      statusClass = 'normal';
    } else if (spread < TH.CAUTION) {
      statusText = '⚠️ 단기 금리에 상승 압력이 감지됩니다';
      statusClass = 'caution';
    } else if (spread < TH.WARNING) {
      statusText = '⚠️ 단기 시장 경색 징후가 나타나고 있습니다';
      statusClass = 'warning';
    } else {
      statusText = '🚨 단기 자금시장에 심각한 문제가 발생했습니다';
      statusClass = 'danger';
    }

    // 카드 1: 상태 카드 업데이트
    const statusCard = document.getElementById('statusCard');
    statusCard.className = 'info-card ' + statusClass;

    document.getElementById('statusSummary').innerHTML = statusText;

    // 확장 영역 상세 수치
    document.getElementById('detailSpread').textContent = spread.toFixed(1);
    document.getElementById('detailRbGdp').textContent = rbGdpRatio.toFixed(1);
  }

  // 초기화 - ES Module 로드 완료 대기
  function startApp() {
    if (typeof getRecessionAnnotations === 'function') {
      console.log('[Init] getRecessionAnnotations loaded ✓');
      init(365);  // 기본값: 1Y
      setupSwipeGesture();  // 모바일 스와이프 설정
    } else {
      console.log('[Init] Waiting for ES modules...');
      setTimeout(startApp, 50);
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', startApp);
  } else {
    startApp();
  }
</script>
</body>
</html>