<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Banking Health Monitor | 100xFenok</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1/dist/chartjs-plugin-annotation.min.js"></script>

  <!-- Constants & DataManager ES Module import -->
  <script type="module">
    import { DataManager } from '../shared/data-manager.js';
    import { THRESHOLDS, COLORS, LABELS, ICONS } from '../shared/constants.js';
    import { getRecessionAnnotations } from '../shared/chart-annotations.js';
    window.DataManager = DataManager;
    window.THRESHOLDS = THRESHOLDS;
    window.COLORS = COLORS;
    window.LABELS = LABELS;
    window.ICONS = ICONS;
    window.getRecessionAnnotations = getRecessionAnnotations;
  </script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      color: #1e293b;
      min-height: 100vh;
      display: flex; justify-content: center;
    }
    .container { width: 100%; max-width: 1000px; padding: 32px 20px; }

    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
    .header-left { display: flex; align-items: center; gap: 16px; }
    .back-btn { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: #fff; border: 1px solid #cbd5e1; border-radius: 12px; color: #64748b; cursor: pointer; transition: all 0.2s ease; }
    .back-btn:hover { background: #f1f5f9; color: #0f172a; transform: translateY(-1px); }
    .title-group h1 { font-family: 'Orbitron', sans-serif; font-size: 22px; font-weight: 700; color: #0f172a; margin-bottom: 4px; }
    .title-group p { font-size: 13px; color: #64748b; font-weight: 500; }

    .header-right { text-align: right; }
    .status-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
    .status-dot { width: 8px; height: 8px; background: #166534; border-radius: 50%; animation: pulse 2s infinite; }
    .update-time { display: block; margin-top: 6px; font-family: 'Orbitron', sans-serif; font-size: 11px; color: #94a3b8; }

    .dashboard-card { background: #ffffff; border-radius: 24px; border: 1px solid #e2e8f0; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05); padding: 32px; margin-bottom: 24px; }

    /* ===== Signal Matrix (4ê°œ ì§€í‘œ) ===== */
    .signal-matrix {
      background: #ffffff;
      border-radius: 24px;
      border: 1px solid #e2e8f0;
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05);
      padding: 24px;
      margin-bottom: 24px;
    }
    .matrix-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .signal-card {
      background: #f8fafc;
      border-radius: 16px;
      padding: 16px;
      border: 1px solid #e2e8f0;
      text-align: center;
      transition: all 0.2s;
      animation: fadeInUp 0.4s ease-out backwards;
    }
    .signal-card:nth-child(1) { animation-delay: 0.05s; }
    .signal-card:nth-child(2) { animation-delay: 0.1s; }
    .signal-card:nth-child(3) { animation-delay: 0.15s; }
    .signal-card:nth-child(4) { animation-delay: 0.2s; }
    .signal-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      transform: translateY(-2px);
    }
    .signal-icon {
      width: 48px;
      height: 48px;
      margin: 0 auto 12px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }
    .signal-icon.green { background: #dcfce7; color: #16a34a; }
    .signal-icon.yellow { background: #fef9c3; color: #ca8a04; }
    .signal-icon.orange { background: #ffedd5; color: #c2410c; }
    .signal-icon.red { background: #fee2e2; color: #dc2626; }
    .signal-icon.gray { background: #f1f5f9; color: #94a3b8; }

    .signal-label {
      font-size: 11px;
      font-weight: 700;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }
    .signal-value {
      font-family: 'Orbitron', sans-serif;
      font-size: 22px;
      font-weight: 700;
      color: #0f172a;
    }
    .signal-unit {
      font-size: 12px;
      color: #64748b;
      margin-left: 2px;
    }
    .signal-status {
      margin-top: 8px;
      font-size: 11px;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 12px;
      display: inline-block;
    }
    .signal-status.normal { background: #dcfce7; color: #166534; }
    .signal-status.caution { background: #fef9c3; color: #854d0e; }
    .signal-status.warning { background: #ffedd5; color: #c2410c; }
    .signal-status.danger { background: #fee2e2; color: #991b1b; }

    /* ===== Banking Health Pulse Hero ===== */
    .health-pulse-hero {
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      border-radius: 16px;
      padding: 20px 24px;
      margin-top: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
    }
    .health-pulse-label {
      font-size: 13px;
      color: #94a3b8;
      font-weight: 600;
    }
    .health-pulse-value {
      font-family: 'Orbitron', sans-serif;
      font-size: 28px;
      font-weight: 700;
      color: #fff;
    }
    .health-pulse-value.healthy { color: #4ade80; }
    .health-pulse-value.watch { color: #fbbf24; }
    .health-pulse-value.caution { color: #fb923c; }
    .health-pulse-value.stress { color: #f87171; }
    .health-pulse-info {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: #94a3b8;
    }
    .health-pulse-info i {
      font-size: 16px;
    }
    .health-indicator {
      display: flex;
      gap: 6px;
      margin-top: 8px;
    }
    .health-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #4b5563;
    }
    .health-dot.active.green { background: #4ade80; }
    .health-dot.active.yellow { background: #fbbf24; }
    .health-dot.active.orange { background: #fb923c; }
    .health-dot.active.red { background: #f87171; }

    /* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */
    .tab-nav {
      display: flex;
      gap: 8px;
      background: #f1f5f9;
      padding: 4px;
      border-radius: 12px;
      margin-bottom: 20px;
    }
    .tab-btn {
      flex: 1;
      padding: 10px 16px;
      border: none;
      background: transparent;
      font-size: 13px;
      font-weight: 600;
      color: #64748b;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s;
    }
    .tab-btn.active {
      background: #fff;
      color: #2563eb;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .tab-btn:hover:not(.active) { color: #1e293b; transform: translateY(-1px); }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* ì°¨íŠ¸ ì»¨íŠ¸ë¡¤ */
    .chart-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .chart-title { font-size: 14px; font-weight: 600; color: #475569; display: flex; align-items: center; gap: 8px; }
    .period-selector { display: flex; gap: 4px; background: #f8fafc; padding: 4px; border-radius: 8px; border: 1px solid #e2e8f0; }
    .p-btn { border: none; background: none; padding: 6px 12px; font-size: 11px; font-weight: 600; color: #64748b; cursor: pointer; border-radius: 6px; transition: all 0.2s; }
    .p-btn:hover { background: #fff; color: #0f172a; }
    .p-btn.active { background: #ffffff; color: #2563eb; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

    .chart-wrapper { position: relative; height: 340px; width: 100%; }

    /* Legend */
    .custom-legend { display: flex; justify-content: center; gap: 24px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #f1f5f9; }
    .legend-item { display: flex; align-items: center; gap: 6px; font-size: 12px; color: #64748b; font-weight: 500; }
    .legend-color { width: 12px; height: 12px; border-radius: 3px; }

    /* ===== Risks íƒ­: Small Multiples Dêµ¬ì¡° + ì ‘ì´ì‹ ===== */
    .risks-main-section { margin-bottom: 16px; }
    .risks-main-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .risks-main-title { font-size: 14px; font-weight: 600; color: #1f2937; }
    .risks-main-controls { display: flex; align-items: center; gap: 8px; }
    .risks-main-badge { font-size: 12px; font-weight: 600; padding: 4px 10px; border-radius: 12px; background: #f0fdf4; color: #16a34a; }
    .risks-main-chart { height: 220px; background: #fff; border-radius: 10px; padding: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
    /* ğŸ†• NCO í† ê¸€ ë²„íŠ¼ */
    .nco-toggle-btn {
      display: flex; align-items: center; gap: 4px;
      font-size: 11px; font-weight: 500; padding: 4px 10px;
      border: 1px solid #e5e7eb; border-radius: 6px;
      background: #f9fafb; color: #6b7280; cursor: pointer;
      transition: all 0.2s ease;
    }
    .nco-toggle-btn:hover { background: #f3f4f6; border-color: #d1d5db; }
    .nco-toggle-btn.active {
      background: #fef3c7; border-color: #f59e0b; color: #d97706;
    }
    .nco-toggle-btn i { font-size: 10px; }

    /* ì ‘ì´ì‹ ì„¹í„° ë¶„ì„ ì¹´ë“œ */
    .sector-analysis-card {
      background: #fff;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      margin-top: 16px;
      overflow: hidden;
    }
    .sector-analysis-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      cursor: pointer;
      background: #f8fafc;
      transition: background 0.2s;
    }
    .sector-analysis-header:hover { background: #f1f5f9; }
    .sector-analysis-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      font-weight: 600;
      color: #475569;
    }
    .sector-analysis-title i { color: #64748b; }
    .sector-count { font-weight: 500; color: #94a3b8; }
    .sector-expand-btn {
      width: 28px;
      height: 28px;
      border: none;
      background: none;
      cursor: pointer;
      color: #64748b;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: all 0.2s;
    }
    .sector-expand-btn:hover { background: #e2e8f0; }
    .sector-expand-btn i { transition: transform 0.3s ease; }
    .sector-analysis-card.expanded .sector-expand-btn i { transform: rotate(180deg); }

    /* ì ‘ì´ì‹ ì½˜í…ì¸  */
    .sector-analysis-content {
      max-height: 0;
      overflow: hidden;
      opacity: 0;
      transition: max-height 0.3s ease, opacity 0.3s ease, padding 0.3s ease;
      padding: 0 16px;
    }
    .sector-analysis-card.expanded .sector-analysis-content {
      max-height: 500px;
      opacity: 1;
      padding: 16px;
    }

    /* 2x2 ê·¸ë¦¬ë“œ */
    .sector-mini-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    .sector-mini-card {
      background: #f8fafc;
      border-radius: 10px;
      padding: 12px;
      border: 1px solid #e2e8f0;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .sector-mini-card:hover {
      box-shadow: 0 6px 16px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }
    .sector-mini-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .sector-mini-title { font-size: 11px; font-weight: 600; }
    .sector-mini-value { font-size: 12px; font-weight: 700; color: #1f2937; }
    .sector-mini-chart { height: 80px; }

    /* ëª¨ë°”ì¼: 1ì—´ */
    @media (max-width: 768px) {
      .sector-mini-grid { grid-template-columns: 1fr; }
      .risks-main-chart { height: 180px; }
      .sector-mini-chart { height: 70px; }
    }

    /* PC: ìë™ í¼ì¹¨ */
    @media (min-width: 900px) {
      .sector-analysis-content {
        max-height: 500px;
        opacity: 1;
        padding: 16px;
      }
      .sector-expand-btn { display: none; }
    }

    /* ë¡œë”© */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .loading-overlay.hidden { display: none; }
    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid #e2e8f0;
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    .loading-text { margin-top: 16px; font-size: 14px; color: #64748b; }

    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(0.9); } 100% { opacity: 1; transform: scale(1); } }

    /* ë°˜ì‘í˜• */
    @media (max-width: 768px) {
      .container { padding: 16px; }
      .page-header { flex-direction: column; align-items: flex-start; gap: 16px; }
      .header-right { width: 100%; display: flex; justify-content: space-between; align-items: center; }
      .matrix-grid { grid-template-columns: repeat(2, 1fr); }
      .signal-value { font-size: 18px; }
      .signal-icon { width: 40px; height: 40px; font-size: 16px; }
      .health-pulse-hero { flex-direction: column; text-align: center; gap: 12px; }
      .health-pulse-value { font-size: 24px; }
      .health-indicator { justify-content: center; }
      .chart-controls { flex-direction: column; align-items: flex-start; gap: 12px; }
      .period-selector { width: 100%; justify-content: space-between; }
      .comparison-table th, .comparison-table td { padding: 8px; font-size: 11px; }
      /* íƒ­ ë²„íŠ¼ ì¶•ì†Œ (ì•„ì´ì½˜ + ì§§ì€ ë¼ë²¨) */
      .tab-btn { padding: 8px 10px; font-size: 11px; }
      .tab-btn i { font-size: 12px; margin-right: 4px; }
      /* ì„¤ëª… ì¹´ë“œ í„°ì¹˜ í”¼ë“œë°± */
      .info-card-header { padding: 14px; }
      .info-card-header:active { background: #e2e8f0; }
      .info-card-title { font-size: 13px; }
      .info-card-summary { padding: 14px; font-size: 12px; }
      .info-card-detail { font-size: 12px; margin: 0 14px; padding-top: 10px; }
      /* ë¹„êµ í…Œì´ë¸” ìµœì í™” */
      .comparison-table .label-cell { font-size: 11px; white-space: nowrap; }
    }
    @media (max-width: 480px) {
      .signal-label { font-size: 9px; }
      .signal-value { font-size: 16px; }
      .signal-status { font-size: 10px; padding: 3px 8px; }
      /* ë” ì‘ì€ í™”ë©´ */
      .tab-btn { padding: 8px 10px; }
      .tab-btn i { font-size: 12px; }
      .comparison-section { padding: 16px; }
      .comparison-title { font-size: 14px; }
      .comparison-table th, .comparison-table td { padding: 6px 4px; font-size: 10px; }
      .info-card-icon { font-size: 20px; }
      .info-expand-btn { width: 24px; height: 24px; }
    }

    /* Capital Resilience ë²”ë¡€ ë°˜ì‘í˜• */
    .legend-short { display: none; }
    .legend-full { display: inline; }
    @media (max-width: 600px) {
      .legend-short { display: inline; }
      .legend-full { display: none; }
      /* Capital íƒ­ ë²”ë¡€: 2x2 ê·¸ë¦¬ë“œ + ê²½ê¸°ì¹¨ì²´ ì¤‘ì•™ */
      .capital-legend {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px 16px;
        justify-items: start;
      }
      .capital-legend .legend-recession {
        grid-column: 1 / -1;
        justify-self: center;
      }
    }

    /* ===== ì„¤ëª… ì¹´ë“œ ì„¹ì…˜ ===== */
    .info-cards-section {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }
    .info-card {
      background: #ffffff;
      border-radius: 16px;
      border: 1px solid #e2e8f0;
      box-shadow: 0 4px 12px -2px rgba(0, 0, 0, 0.05);
      overflow: hidden;
      transition: all 0.2s ease;
    }
    .info-card:hover {
      box-shadow: 0 8px 20px -4px rgba(0, 0, 0, 0.1);
    }
    .info-card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      cursor: pointer;
      background: #f8fafc;
      border-bottom: 1px solid #e2e8f0;
    }
    .info-card-icon {
      font-size: 18px;
    }
    .info-card-title {
      flex: 1;
      font-size: 14px;
      font-weight: 700;
      color: #1e293b;
    }
    .info-expand-btn {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      color: #64748b;
      cursor: pointer;
      transition: all 0.2s;
    }
    .info-expand-btn:hover {
      background: #f1f5f9;
      color: #0f172a;
    }
    .info-card.expanded .info-expand-btn {
      transform: rotate(180deg);
    }
    .info-card-summary {
      padding: 16px;
      font-size: 13px;
      color: #475569;
      line-height: 1.6;
    }
    .info-card-detail {
      display: none;
      padding: 0 16px 16px;
      font-size: 13px;
      color: #64748b;
      line-height: 1.7;
      border-top: 1px dashed #e2e8f0;
      margin: 0 16px;
      padding-top: 12px;
    }
    .info-card.expanded .info-card-detail {
      display: block;
    }
    .info-card-detail ul {
      margin: 8px 0;
      padding-left: 20px;
    }
    .info-card-detail li {
      margin-bottom: 6px;
    }
    .info-card-detail strong {
      color: #1e293b;
    }
    .info-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      margin-right: 6px;
      margin-bottom: 4px;
    }
    .info-badge.green { background: #dcfce7; color: #166534; }
    .info-badge.yellow { background: #fef9c3; color: #854d0e; }
    .info-badge.orange { background: #ffedd5; color: #c2410c; }
    .info-badge.red { background: #fee2e2; color: #991b1b; }
    .info-badge.blue { background: #dbeafe; color: #1e40af; }
    .info-badge.gray { background: #f1f5f9; color: #64748b; }

    @media (max-width: 900px) {
      .info-cards-section {
        grid-template-columns: 1fr;
      }
    }

    /* ===== ìŠ¤ì™€ì´í”„ ì¸ë””ì¼€ì´í„° (ëª¨ë°”ì¼) ===== */
    .swipe-indicator {
      display: none;
      justify-content: center;
      align-items: center;
      gap: 6px;
      margin-top: 12px;
      padding: 8px;
    }
    .swipe-dot {
      width: 8px;
      height: 8px;
      background: #cbd5e1;
      border-radius: 50%;
      transition: all 0.2s;
    }
    .swipe-dot.active {
      background: #2563eb;
      transform: scale(1.2);
    }
    .swipe-hint {
      font-size: 11px;
      color: #94a3b8;
      margin-left: 8px;
    }
    @media (max-width: 768px) {
      .swipe-indicator { display: flex; }
    }

    /* ===== PC ìë™ í¼ì¹¨ (900px+) ===== */
    @media (min-width: 900px) {
      .info-card-detail {
        display: block !important;
        max-height: 500px;
        opacity: 1;
        margin-top: 16px;
      }
      .info-expand-btn {
        display: none;
      }
      .info-card-title { font-size: 15px; }
      .info-card-summary { font-size: 15px; }
      .info-card-detail { font-size: 14px; }
    }
  </style>
</head>
<body>

<!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner"></div>
  <div class="loading-text">Banking Health ë°ì´í„° ë¡œë”© ì¤‘...</div>
</div>

<div class="container">
  <header class="page-header">
    <div class="header-left">
      <button class="back-btn" onclick="history.back()"><i class="fas fa-arrow-left"></i></button>
      <div class="title-group">
        <h1>ğŸ¦ Banking Health Monitor</h1>
        <p>ì—°ì²´ìœ¨ | ìê¸°ìë³¸ë¹„ìœ¨ | ì˜ˆëŒ€ìœ¨ | ì—¬ì‹ ì¦ê°€ìœ¨</p>
      </div>
    </div>
    <div class="header-right">
      <div class="status-badge" id="statusBadge"><span class="status-dot"></span> <span id="statusText">Loading...</span></div>
      <span class="update-time" id="updateTime">Last Update: --</span>
    </div>
  </header>

  <!-- ===== Signal Matrix Hero ===== -->
  <section class="signal-matrix">
    <div class="matrix-grid">
      <!-- Tier 1 ë¹„ìœ¨ -->
      <div class="signal-card" id="tier1Card">
        <div class="signal-icon gray" id="tier1Icon"><i class="fas fa-shield-alt"></i></div>
        <div class="signal-label">ìê¸°ìë³¸ë¹„ìœ¨</div>
        <div class="signal-value" id="tier1Value">--</div>
        <span class="signal-unit">%</span>
        <div class="signal-status" id="tier1Status">Loading</div>
      </div>
      <!-- ì˜ˆëŒ€ìœ¨ -->
      <div class="signal-card" id="loanDepositCard">
        <div class="signal-icon gray" id="loanDepositIcon"><i class="fas fa-balance-scale"></i></div>
        <div class="signal-label">ì˜ˆëŒ€ìœ¨</div>
        <div class="signal-value" id="loanDepositValue">--</div>
        <span class="signal-unit">%</span>
        <div class="signal-status" id="loanDepositStatus">Loading</div>
      </div>
      <!-- ì—¬ì‹  ì¦ê°€ìœ¨ -->
      <div class="signal-card" id="loanGrowthCard">
        <div class="signal-icon gray" id="loanGrowthIcon"><i class="fas fa-chart-line"></i></div>
        <div class="signal-label">ì—¬ì‹ ì¦ê°€ìœ¨</div>
        <div class="signal-value" id="loanGrowthValue">--</div>
        <span class="signal-unit">%</span>
        <div class="signal-status" id="loanGrowthStatus">Loading</div>
      </div>
      <!-- ì—°ì²´ìœ¨ -->
      <div class="signal-card" id="delinquencyCard">
        <div class="signal-icon gray" id="delinquencyIcon"><i class="fas fa-exclamation-triangle"></i></div>
        <div class="signal-label">ì—°ì²´ìœ¨</div>
        <div class="signal-value" id="delinquencyValue">--</div>
        <span class="signal-unit">%</span>
        <div class="signal-status" id="delinquencyStatus">Loading</div>
      </div>
    </div>

    <!-- Banking Health Pulse Hero -->
    <div class="health-pulse-hero">
      <div>
        <div class="health-pulse-label">Banking Health Index</div>
        <div class="health-pulse-value healthy" id="healthPulseValue">HEALTHY</div>
        <div class="health-indicator" id="healthIndicator">
          <div class="health-dot" id="dot1"></div>
          <div class="health-dot" id="dot2"></div>
          <div class="health-dot" id="dot3"></div>
          <div class="health-dot" id="dot4"></div>
        </div>
      </div>
      <div class="health-pulse-info" id="healthPulseInfo">
        <i class="fas fa-check-circle"></i>
        <span id="healthPulseDesc">4/4 indicators normal</span>
      </div>
    </div>
  </section>

  <!-- ì°¨íŠ¸ ì„¹ì…˜ -->
  <section class="dashboard-card">
    <div class="tab-nav">
      <button class="tab-btn active" onclick="switchTab('capital', this)"><i class="fas fa-shield-alt"></i> ìë³¸</button>
      <button class="tab-btn" onclick="switchTab('credit', this)"><i class="fas fa-chart-line"></i> ì‹ ìš©</button>
      <button class="tab-btn" onclick="switchTab('risks', this)"><i class="fas fa-exclamation-triangle"></i> ì—°ì²´</button>
    </div>

    <!-- ê¸°ê°„ ì„ íƒ (íƒ­ë³„ ë¶„ë¦¬) -->
    <div class="chart-controls">
      <div class="chart-title" id="chartTitle"><i class="fas fa-shield-halved"></i> ìê¸°ìë³¸ë¹„ìœ¨ (Tier 1)</div>
      <!-- Capital/Credit íƒ­ìš©: 1Y/3Y/5Y/10Y/15Y/MAX -->
      <div class="period-selector" id="periodSelectorDefault">
        <button class="p-btn" onclick="updatePeriod(365, this, 'default')">1Y</button>
        <button class="p-btn" onclick="updatePeriod(1095, this, 'default')">3Y</button>
        <button class="p-btn" onclick="updatePeriod(1825, this, 'default')">5Y</button>
        <button class="p-btn active" onclick="updatePeriod(3650, this, 'default')">10Y</button>
        <button class="p-btn" onclick="updatePeriod(5475, this, 'default')">15Y</button>
        <button class="p-btn" onclick="updatePeriod(99999, this, 'default')">MAX</button>
      </div>
      <!-- Risks íƒ­ìš©: 5Y/10Y/15Y/25Y/MAX (ê¸°ë³¸ MAX) -->
      <div class="period-selector" id="periodSelectorRisks" style="display: none;">
        <button class="p-btn" onclick="updatePeriod(1825, this, 'risks')">5Y</button>
        <button class="p-btn" onclick="updatePeriod(3650, this, 'risks')">10Y</button>
        <button class="p-btn" onclick="updatePeriod(5475, this, 'risks')">15Y</button>
        <button class="p-btn" onclick="updatePeriod(9125, this, 'risks')">25Y</button>
        <button class="p-btn active" onclick="updatePeriod(99999, this, 'risks')">MAX</button>
      </div>
    </div>

    <!-- Tab 1: Capital Health (Tier 1 only) -->
    <div class="tab-content active" id="tab-capital">
      <div class="chart-wrapper">
        <canvas id="capitalChart"></canvas>
      </div>
      <div class="custom-legend capital-legend">
        <!-- Defense (ì„±ë²½) - Okabe-Ito Blue Family -->
        <div class="legend-item"><div class="legend-color" style="background: #0072B2;"></div><span class="legend-full">FDIC Tier1</span><span class="legend-short">Tier1</span></div>
        <div class="legend-item"><div class="legend-color" style="background: transparent; border: 2px dashed #56B4E9;"></div><span class="legend-full">FED Tier1</span><span class="legend-short">FED</span></div>
        <!-- Offense (íŒŒë„) - Okabe-Ito Orange Family -->
        <div class="legend-item"><div class="legend-color" style="background: #E69F00;"></div><span class="legend-full">10Y ê¸ˆë¦¬</span><span class="legend-short">10Y</span></div>
        <div class="legend-item"><div class="legend-color" style="background: transparent; border: 2px dashed #CC79A7;"></div><span class="legend-full">HY ìŠ¤í”„ë ˆë“œ</span><span class="legend-short">HY</span></div>
        <div class="legend-item legend-recession"><div class="legend-color" style="background: rgba(0,0,0,0.1);"></div><span>ê²½ê¸°ì¹¨ì²´</span></div>
      </div>
    </div>

    <!-- Tab 2: Credit Activity (L/D + YoY) -->
    <div class="tab-content" id="tab-credit">
      <div class="chart-wrapper">
        <canvas id="creditChart"></canvas>
      </div>
      <div class="custom-legend">
        <div class="legend-item"><div class="legend-color" style="background: #3b82f6;"></div><span>ì˜ˆëŒ€ìœ¨</span></div>
        <div class="legend-item"><div class="legend-color" style="background: #f59e0b;"></div><span>ì—¬ì‹ ì¦ê°€ìœ¨</span></div>
        <div class="legend-item"><div class="legend-color" style="background: rgba(0,0,0,0.1);"></div><span>ê²½ê¸°ì¹¨ì²´</span></div>
      </div>
    </div>

    <!-- Tab 3: Risks (Small Multiples Dêµ¬ì¡° + ì ‘ì´ì‹) -->
    <div class="tab-content" id="tab-risks">
      <!-- ë©”ì¸ ì°¨íŠ¸: Total Delinquency -->
      <div class="risks-main-section">
        <div class="risks-main-header">
          <span class="risks-main-title"><i class="fas fa-chart-area"></i> Total</span>
          <div class="risks-main-controls">
            <!-- ğŸ†• NCO í† ê¸€ ë²„íŠ¼ -->
            <button class="nco-toggle-btn" id="ncoToggleBtn" onclick="toggleNcoOverlay()">
              <i class="fas fa-chart-line"></i> ìƒê°ìœ¨ í‘œì‹œ
            </button>
            <span class="risks-main-badge" id="risksMainBadge">--</span>
          </div>
        </div>
        <div class="risks-main-chart">
          <canvas id="risksMainChart"></canvas>
        </div>
      </div>

      <!-- ì ‘ì´ì‹: ì„¹í„°ë³„ ë¶„ì„ -->
      <div class="sector-analysis-card" id="sectorAnalysisCard">
        <div class="sector-analysis-header" onclick="toggleSectorAnalysis()">
          <div class="sector-analysis-title">
            <i class="fas fa-layer-group"></i> ì„¹í„°ë³„ ë¶„ì„
            <span class="sector-count">(4)</span>
          </div>
          <button class="sector-expand-btn"><i class="fas fa-chevron-down"></i></button>
        </div>
        <div class="sector-analysis-content">
          <!-- 4ê°œ ë¯¸ë‹ˆ ì°¨íŠ¸: 2x2 ê·¸ë¦¬ë“œ -->
          <div class="sector-mini-grid">
            <div class="sector-mini-card">
              <div class="sector-mini-header">
                <span class="sector-mini-title" style="color: #ef4444;"><i class="fas fa-credit-card"></i> ì‹ ìš©ì¹´ë“œ</span>
                <span class="sector-mini-value" id="risksMiniCCValue">--</span>
              </div>
              <div class="sector-mini-chart">
                <canvas id="risksMiniCC"></canvas>
              </div>
            </div>
            <div class="sector-mini-card">
              <div class="sector-mini-header">
                <span class="sector-mini-title" style="color: #f59e0b;"><i class="fas fa-user"></i> ì†Œë¹„ì</span>
                <span class="sector-mini-value" id="risksMiniConsumerValue">--</span>
              </div>
              <div class="sector-mini-chart">
                <canvas id="risksMiniConsumer"></canvas>
              </div>
            </div>
            <div class="sector-mini-card">
              <div class="sector-mini-header">
                <span class="sector-mini-title" style="color: #10b981;"><i class="fas fa-building"></i> ê¸°ì—…</span>
                <span class="sector-mini-value" id="risksMiniBusinessValue">--</span>
              </div>
              <div class="sector-mini-chart">
                <canvas id="risksMiniBusiness"></canvas>
              </div>
            </div>
            <div class="sector-mini-card">
              <div class="sector-mini-header">
                <span class="sector-mini-title" style="color: #8b5cf6;"><i class="fas fa-city"></i> ìƒì—…ë¶€ë™ì‚°</span>
                <span class="sector-mini-value" id="risksMiniCREValue">--</span>
              </div>
              <div class="sector-mini-chart">
                <canvas id="risksMiniCRE"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ë²”ë¡€ -->
      <div class="custom-legend" style="margin-top: 12px;">
        <div class="legend-item"><div class="legend-color" style="background: rgba(0,0,0,0.1);"></div><span>ê²½ê¸°ì¹¨ì²´</span></div>
      </div>
    </div>

    <!-- ìŠ¤ì™€ì´í”„ ì¸ë””ì¼€ì´í„° (ëª¨ë°”ì¼) -->
    <div class="swipe-indicator" id="swipeIndicator">
      <div class="swipe-dot active" id="swipeDot1"></div>
      <div class="swipe-dot" id="swipeDot2"></div>
      <div class="swipe-dot" id="swipeDot3"></div>
      <span class="swipe-hint">â† íƒ­ ìŠ¤ì™€ì´í”„ â†’</span>
    </div>
  </section>

  <!-- ===== ì„¤ëª… ì¹´ë“œ ì„¹ì…˜ ===== -->
  <section class="info-cards-section">
    <!-- ì¹´ë“œ 1: í˜„ì¬ ìƒíƒœ (ë™ì ) -->
    <div class="info-card" id="statusCard">
      <div class="info-card-header" onclick="toggleInfoCard('statusCard')">
        <div class="info-card-icon">ğŸ“Š</div>
        <div class="info-card-title">í˜„ì¬ ìƒíƒœ</div>
        <button class="info-expand-btn"><i class="fas fa-chevron-down"></i></button>
      </div>
      <div class="info-card-summary" id="statusSummary">
        ì€í–‰ ê±´ì „ì„± ì§€í‘œë¥¼ ì¢…í•© ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...
      </div>
      <div class="info-card-detail" id="statusDetail">
        <ul>
          <li><strong>ì—°ì²´ìœ¨</strong>: <span id="detailDelinq">--</span></li>
          <li><strong>Tier 1 ë¹„ìœ¨</strong>: <span id="detailTier1">--</span></li>
          <li><strong>ì˜ˆëŒ€ìœ¨</strong>: <span id="detailLD">--</span></li>
          <li><strong>ì—¬ì‹  ì¦ê°€ìœ¨</strong>: <span id="detailLG">--</span></li>
        </ul>
        <p id="statusConclusion">ë°ì´í„° ë¡œë”© í›„ ì¢…í•© ë¶„ì„ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
      </div>
    </div>

    <!-- ì¹´ë“œ 2: ì§€í‘œ ì •ì˜ -->
    <div class="info-card" id="definitionCard">
      <div class="info-card-header" onclick="toggleInfoCard('definitionCard')">
        <div class="info-card-icon">ğŸ’¡</div>
        <div class="info-card-title">ì´ ì§€í‘œê°€ ë­”ê°€ìš”?</div>
        <button class="info-expand-btn"><i class="fas fa-chevron-down"></i></button>
      </div>
      <div class="info-card-summary">
        ì€í–‰ ê±´ì „ì„±ì„ íŒë‹¨í•˜ëŠ” 4ê°€ì§€ í•µì‹¬ ì§€í‘œì…ë‹ˆë‹¤.
      </div>
      <div class="info-card-detail">
        <ul>
          <li><strong>ì—°ì²´ìœ¨ (Delinquency Rate)</strong>: ì „ì²´ ëŒ€ì¶œ ì¤‘ 30ì¼ ì´ìƒ ì—°ì²´ëœ ë¹„ìœ¨. ë†’ì„ìˆ˜ë¡ ë¶€ì‹¤ ìœ„í—˜ ì¦ê°€.</li>
          <li><strong>Tier 1 ìë³¸ë¹„ìœ¨</strong>: ì€í–‰ì˜ í•µì‹¬ìë³¸ / ìœ„í—˜ê°€ì¤‘ìì‚°. 8% ì´ìƒ ê·œì œ ìš”ê±´, 12% ì´ìƒì´ë©´ ê±´ì „.</li>
          <li><strong>ì˜ˆëŒ€ìœ¨ (Loan/Deposit)</strong>: ì˜ˆê¸ˆ ëŒ€ë¹„ ëŒ€ì¶œ ë¹„ìœ¨. 60-85%ê°€ ì ì •, ë„ˆë¬´ ë†’ìœ¼ë©´ ìœ ë™ì„± ìœ„í—˜.</li>
          <li><strong>ì—¬ì‹  ì¦ê°€ìœ¨ (YoY)</strong>: ì „ë…„ ëŒ€ë¹„ ëŒ€ì¶œ ì¦ê°€ìœ¨. ì–‘(+)ì´ë©´ ì‹ ìš© í™•ì¥, ìŒ(-)ì´ë©´ ì‹ ìš© ìˆ˜ì¶•.</li>
        </ul>
      </div>
    </div>

    <!-- ì¹´ë“œ 3: ì™œ ì¤‘ìš”í•œê°€? -->
    <div class="info-card" id="importanceCard">
      <div class="info-card-header" onclick="toggleInfoCard('importanceCard')">
        <div class="info-card-icon">ğŸ¯</div>
        <div class="info-card-title">ì™œ ì¤‘ìš”í•œê°€ìš”?</div>
        <button class="info-expand-btn"><i class="fas fa-chevron-down"></i></button>
      </div>
      <div class="info-card-summary">
        ì€í–‰ ì‹œìŠ¤í…œì€ ê²½ì œì˜ í˜ˆê´€ì…ë‹ˆë‹¤. ê±´ì „ì„± ì•…í™”ëŠ” ê¸ˆìœµìœ„ê¸°ë¡œ ì´ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      </div>
      <div class="info-card-detail">
        <p><strong>ğŸ“‰ 2008 ê¸ˆìœµìœ„ê¸° (GFC)</strong></p>
        <p>ì—°ì²´ìœ¨ ê¸‰ë“±(4.9%) + ì˜ˆëŒ€ìœ¨ ê³¼ì—´(98%)ì´ ì„œë¸Œí”„ë¼ì„ ìœ„ê¸°ë¥¼ ì´‰ë°œí–ˆìŠµë‹ˆë‹¤. ì€í–‰ íŒŒì‚° ì—°ì‡„ë¡œ ê¸€ë¡œë²Œ ê²½ê¸°ì¹¨ì²´.</p>
        <br>
        <p><strong>ğŸ¦  2020 ì½”ë¡œë‚˜ ìœ„ê¸°</strong></p>
        <p>ì •ë¶€ì˜ ë¹ ë¥¸ ìœ ë™ì„± ê³µê¸‰ìœ¼ë¡œ ì—°ì²´ìœ¨(1.5%)ì„ ì–µì œ. Tier 1 ë¹„ìœ¨(13.3%)ë„ ì‚¬ì „ì— ë†’ì•„ ì¶©ê²© í¡ìˆ˜ ì„±ê³µ.</p>
        <br>
        <p><strong>ğŸ” ì‹œì‚¬ì </strong></p>
        <p>4ê°œ ì§€í‘œê°€ ë™ì‹œì— ì•…í™”ë˜ë©´ ì‹œìŠ¤í…œ ë¦¬ìŠ¤í¬ ê²½ë³´. íŠ¹íˆ ì—°ì²´ìœ¨ ìƒìŠ¹ + Tier 1 í•˜ë½ ì¡°í•©ì€ ìœ„í—˜ ì‹ í˜¸ì…ë‹ˆë‹¤.</p>
      </div>
    </div>
  </section>
</div>

<script>
  // ===== ì„¤ëª… ì¹´ë“œ í† ê¸€ =====
  function toggleInfoCard(cardId) {
    const card = document.getElementById(cardId);
    if (card) {
      card.classList.toggle('expanded');
    }
  }

  // ===== ì„ê³„ê°’ í—¬í¼ =====
  const getThreshold = (category, level) => {
    if (typeof THRESHOLDS !== 'undefined' && THRESHOLDS[category]) {
      return THRESHOLDS[category][level];
    }
    // Fallback (ìˆ˜ì •: ì˜ˆëŒ€ìœ¨ 60-85% ì •ìƒ ë²”ìœ„)
    const fallback = {
      DELINQUENCY: { NORMAL: 2, CAUTION: 3, WARNING: 4, DANGER: 4 },
      TIER1_RATIO: { NORMAL: 12, CAUTION: 10, WARNING: 8, DANGER: 8 },
      LOAN_DEPOSIT: { NORMAL_HIGH: 85, NORMAL_LOW: 60, CAUTION: 60, WARNING: 55 },
      LOAN_GROWTH: { POSITIVE: 5, NEUTRAL: 0, NEGATIVE: 0 }
    };
    return fallback[category]?.[level];
  };

  const getStatusEmoji = (status) => {
    if (typeof ICONS !== 'undefined' && ICONS.BANKING) {
      return ICONS.BANKING[status] || 'ğŸŸ¢';
    }
    const fallback = { normal: 'ğŸŸ¢', caution: 'ğŸŸ¡', warning: 'ğŸŸ ', danger: 'ğŸ”´' };
    return fallback[status] || 'ğŸŸ¢';
  };

  // ===== API Config =====
  const CONFIG = {
    apiKey: '6dda7dc3956a2c1d6ac939133de115f1',
    proxy: 'https://fed-proxy.etloveaui.workers.dev/'
  };

  // ===== FRED API í˜¸ì¶œ =====
  let apiErrorCount = 0;
  const API_TIMEOUT = 10000; // 10ì´ˆ íƒ€ì„ì•„ì›ƒ

  async function getSeries(seriesId, days) {
    const end = new Date().toISOString().split('T')[0];
    const start = new Date(Date.now() - days * 86400000).toISOString().split('T')[0];
    const url = `${CONFIG.proxy}fred/series/observations?series_id=${seriesId}&api_key=${CONFIG.apiKey}&file_type=json&observation_start=${start}&observation_end=${end}&sort_order=asc`;

    try {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), API_TIMEOUT);

      const res = await fetch(url, { signal: controller.signal });
      clearTimeout(timeoutId);

      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const json = await res.json();
      if (!json.observations) return [];

      // NaN ì²˜ë¦¬ ê°•í™”: parseFloat ê²°ê³¼ ê²€ì¦
      return json.observations
        .filter(o => o.value !== '.')
        .map(o => {
          const val = parseFloat(o.value);
          return { date: o.date, val: isNaN(val) ? null : val };
        })
        .filter(o => o.val !== null);
    } catch (e) {
      apiErrorCount++;
      // íƒ€ì„ì•„ì›ƒ ì—ëŸ¬ ì‚¬ìš©ì ì¹œí™”ì  ë©”ì‹œì§€
      const errorMsg = e.name === 'AbortError'
        ? 'íƒ€ì„ì•„ì›ƒ (10ì´ˆ)'
        : e.message;
      console.error(`[FRED] ${seriesId} fetch error:`, e);
      showApiError(seriesId, errorMsg);
      return [];
    }
  }

  // API ì—ëŸ¬ ì‚¬ìš©ì í‘œì‹œ
  function showApiError(seriesId, message) {
    const loadingText = document.querySelector('.loading-text');
    if (loadingText) {
      loadingText.innerHTML = `<span style="color:#dc2626;">âš ï¸ ${seriesId} ë¡œë”© ì‹¤íŒ¨: ${message}</span><br>ë‹¤ë¥¸ ë°ì´í„° ë¡œë”© ì¤‘...`;
    }
  }

  // ===== FDIC API: ì „ì²´ íˆìŠ¤í† ë¦¬ (ìŠ¤ë§ˆíŠ¸ ìºì‹±) =====
  const FDIC_CACHE_KEY = 'fdic_tier1_cache';

  // í˜„ì¬ ì‚¬ìš© ê°€ëŠ¥í•œ ìµœì‹  ë¶„ê¸° ê³„ì‚° (2ê°œì›” ì§€ì—°)
  function getExpectedLatestQuarter() {
    const quarterEnds = ['0331', '0630', '0930', '1231'];
    const now = new Date();
    const d = new Date(now.getFullYear(), now.getMonth() - 2, 1);
    const q = Math.floor(d.getMonth() / 3);
    return `${d.getFullYear()}-${quarterEnds[q].slice(0,2)}-${quarterEnds[q].slice(2)}`;
  }

  async function getFDICTier1() {
    const expectedLatest = getExpectedLatestQuarter();

    // 1. ìºì‹œ í™•ì¸ - ìµœì‹  ë¶„ê¸° í¬í•¨ ì—¬ë¶€ë¡œ íŒë‹¨
    try {
      const cached = localStorage.getItem(FDIC_CACHE_KEY);
      if (cached) {
        const { data } = JSON.parse(cached);
        const cacheLatest = data.length > 0 ? data[data.length - 1].date : '';
        if (cacheLatest >= expectedLatest && data.length > 50) {
          console.log(`[FDIC] ìºì‹œ ì‚¬ìš© (ìµœì‹ : ${cacheLatest})`);
          return data;
        }
        console.log(`[FDIC] ìƒˆ ë¶„ê¸° ê°ì§€ (ìºì‹œ: ${cacheLatest}, ì˜ˆìƒ: ${expectedLatest})`);
      }
    } catch (e) { /* ìºì‹œ ì—ëŸ¬ ë¬´ì‹œ */ }

    // 2. API í˜¸ì¶œ (ì „ì²´ ë¶„ê¸° ë³‘ë ¬)
    try {
      const quarterEnds = ['0331', '0630', '0930', '1231'];
      const now = new Date();
      const currentYear = now.getFullYear();
      const currentMonth = now.getMonth();

      const quarters = [];
      for (let year = 2009; year <= currentYear; year++) {
        for (let q = 0; q < 4; q++) {
          const qMonth = q * 3 + 2;
          if (year < currentYear || (year === currentYear && qMonth <= currentMonth - 2)) {
            quarters.push(`${year}${quarterEnds[q]}`);
          }
        }
      }
      quarters.sort().reverse();
      console.log(`[FDIC] ${quarters.length}ê°œ ë¶„ê¸° ë¡œë“œ ì‹œì‘...`);

      const fetchQ = async (q) => {
        try {
          const res = await fetch(`https://api.fdic.gov/banks/financials?limit=10000&fields=RBC1AAJ,RISDATE&filters=RISDATE:${q}`);
          if (!res.ok) return null;
          const json = await res.json();
          const ratios = json.data?.map(r => r.data?.RBC1AAJ).filter(v => v != null && !isNaN(v)) || [];
          if (ratios.length === 0) return null;
          return { date: `${q.slice(0,4)}-${q.slice(4,6)}-${q.slice(6,8)}`, val: ratios.reduce((a,b) => a+b, 0) / ratios.length };
        } catch { return null; }
      };

      // ì „ì²´ ë³‘ë ¬ (rate limit ì—†ìŒ í™•ì¸ë¨)
      const results = (await Promise.all(quarters.map(fetchQ))).filter(r => r);
      results.sort((a, b) => a.date.localeCompare(b.date));

      // 3. ìºì‹œ ì €ì¥
      if (results.length > 0) {
        try {
          localStorage.setItem(FDIC_CACHE_KEY, JSON.stringify({ data: results, timestamp: Date.now() }));
          console.log(`[FDIC] ${results.length}ê°œ ë¶„ê¸° ìºì‹œ ì €ì¥ ì™„ë£Œ`);
        } catch (e) { /* ìºì‹œ ì €ì¥ ì‹¤íŒ¨ ë¬´ì‹œ */ }
      }

      return results.length > 0 ? results : null;
    } catch (e) {
      console.error('[FDIC] ì—ëŸ¬:', e);
      return null;
    }
  }

  // ===== ë°ì´í„° ê²€ì¦ í•¨ìˆ˜ =====
  function validateData(data) {
    const issues = [];

    // 1. í•„ìˆ˜ ë°ì´í„° ì¡´ì¬ í™•ì¸
    if (!data.delinquency || data.delinquency.length === 0) {
      issues.push('âš ï¸ ì—°ì²´ìœ¨ ë°ì´í„° ì—†ìŒ');
    }
    if (!data.tier1 || data.tier1.length === 0) {
      issues.push('âš ï¸ Tier 1 ë°ì´í„° ì—†ìŒ');
    }
    if (!data.loans || data.loans.length === 0) {
      issues.push('âš ï¸ ëŒ€ì¶œ ë°ì´í„° ì—†ìŒ');
    }
    if (!data.deposits || data.deposits.length === 0) {
      issues.push('âš ï¸ ì˜ˆê¸ˆ ë°ì´í„° ì—†ìŒ');
    }

    // 2. ê°’ ë²”ìœ„ ê²€ì¦
    if (data.delinquency && data.delinquency.length > 0) {
      const lastDel = data.delinquency[data.delinquency.length - 1].val;
      if (lastDel < 0 || lastDel > 20) {
        issues.push(`âš ï¸ ì—°ì²´ìœ¨ ì´ìƒê°’: ${lastDel.toFixed(2)}%`);
      }
    }
    if (data.tier1 && data.tier1.length > 0) {
      const lastT1 = data.tier1[data.tier1.length - 1].val;
      if (lastT1 < 5 || lastT1 > 25) {
        issues.push(`âš ï¸ Tier 1 ì´ìƒê°’: ${lastT1.toFixed(2)}%`);
      }
    }

    // 3. ë‚ ì§œ ì—°ì†ì„± (ë¶„ê¸° ë°ì´í„° ê¸°ì¤€ 120ì¼ ê°­ ê²½ê³ )
    if (data.delinquency && data.delinquency.length > 1) {
      for (let i = 1; i < data.delinquency.length; i++) {
        const prev = new Date(data.delinquency[i - 1].date);
        const curr = new Date(data.delinquency[i].date);
        const diffDays = (curr - prev) / (1000 * 60 * 60 * 24);
        if (diffDays > 120) {
          issues.push(`âš ï¸ ì—°ì²´ìœ¨ ë‚ ì§œ ê°­: ${diffDays.toFixed(0)}ì¼`);
          break;
        }
      }
    }

    // ê²°ê³¼ ë¡œê¹…
    if (issues.length > 0) {
      console.warn('[Validate] ë°ì´í„° ê²€ì¦ ê²½ê³ :', issues);
    } else {
      console.log('[Validate] ë°ì´í„° ê²€ì¦ í†µê³¼ âœ“');
    }

    return { valid: issues.length === 0, issues };
  }

  // ===== ë°ì´í„° ì €ì¥ =====
  let fullData = {
    delinquency: [],
    tier1: [],        // FDIC Tier 1 (Defense 1)
    fedTier1: [],     // FED Tier 1 BOGZ1FL010000016Q (Defense 2)
    yield10y: [],     // 10Y Treasury DGS10 (Offense 1)
    hySpread: [],     // HY Spread BAMLH0A0HYM2 (Offense 2)
    loans: [],
    deposits: [],
    // Risks íƒ­ìš© ì—°ì²´ìœ¨ ì„¸ë¶„í™”
    creditCardDelinq: [],
    consumerDelinq: [],
    businessDelinq: [],
    // ğŸ†• Shadow of Death - ìƒê°ìœ¨(NCO) ë°ì´í„°
    ncoTotal: [],           // CORALACBN - Total NCO
    ncoCreditCard: [],      // CORCCACBS - Credit Card NCO
    ncoConsumer: [],        // CORCACBS - Consumer NCO
    ncoBusiness: [],        // CORBLACBS - Business NCO
    ncoCRE: [],             // CORCREXFACBS - CRE NCO
    timeline: []
  };
  // ğŸ†• NCO í† ê¸€ ìƒíƒœ
  let showNcoOverlay = false;
  let currentTab = 'capital';
  let currentPeriod = 3650; // 10Y default
  let capitalChart = null;
  let creditChart = null;
  let risksChart = null;

  // ===== ë°ì´í„° ì²˜ë¦¬ =====
  function processData() {
    // ì˜ˆëŒ€ìœ¨ ê³„ì‚°: TOTLL / DPSACBW027SBOG * 100 (ì „ì²´ ëŒ€ì¶œ ê¸°ì¤€)
    const loansMap = new Map(fullData.loans.map(d => [d.date, d.val]));
    const depositsMap = new Map(fullData.deposits.map(d => [d.date, d.val]));

    // YoY ê³„ì‚°ìš© (52ì£¼ = 364ì¼ ê¸°ì¤€, Â±7ì¼ í—ˆìš©)
    const YEAR_DAYS = 364; // 52ì£¼
    const TOLERANCE_DAYS = 7;
    const MS_PER_DAY = 86400000;

    const loanGrowthData = fullData.loans.map((d, i) => {
      const currentDate = new Date(d.date).getTime();
      const targetMin = currentDate - (YEAR_DAYS + TOLERANCE_DAYS) * MS_PER_DAY;
      const targetMax = currentDate - (YEAR_DAYS - TOLERANCE_DAYS) * MS_PER_DAY;

      // ê°€ì¥ ê°€ê¹Œìš´ 52ì£¼ ì „ ë°ì´í„° ì°¾ê¸°
      let bestMatch = null;
      let minDiff = Infinity;

      for (const x of fullData.loans) {
        const xTime = new Date(x.date).getTime();
        if (xTime >= targetMin && xTime <= targetMax) {
          const diff = Math.abs(currentDate - xTime - YEAR_DAYS * MS_PER_DAY);
          if (diff < minDiff) {
            minDiff = diff;
            bestMatch = x;
          }
        }
      }

      if (bestMatch && bestMatch.val !== 0) {
        const yoy = ((d.val - bestMatch.val) / bestMatch.val) * 100;
        return { date: d.date, val: yoy };
      }
      return null;
    }).filter(d => d !== null);

    // ì˜ˆëŒ€ìœ¨ ê³„ì‚°
    const loanDepositData = fullData.loans.map(d => {
      const deposit = depositsMap.get(d.date);
      if (deposit && deposit > 0) {
        return { date: d.date, val: (d.val / deposit) * 100 };
      }
      return null;
    }).filter(d => d !== null);

    return { loanGrowthData, loanDepositData };
  }

  // ===== ìƒíƒœ íŒì • =====
  function getDelinquencyStatus(val) {
    const TH = {
      NORMAL: getThreshold('DELINQUENCY', 'NORMAL'),
      CAUTION: getThreshold('DELINQUENCY', 'CAUTION'),
      WARNING: getThreshold('DELINQUENCY', 'WARNING')
    };
    if (val < TH.NORMAL) return 'normal';
    if (val < TH.CAUTION) return 'caution';
    if (val < TH.WARNING) return 'warning';
    return 'danger';
  }

  function getTier1Status(val) {
    const TH = {
      NORMAL: getThreshold('TIER1_RATIO', 'NORMAL'),
      CAUTION: getThreshold('TIER1_RATIO', 'CAUTION'),
      WARNING: getThreshold('TIER1_RATIO', 'WARNING')
    };
    if (val >= TH.NORMAL) return 'normal';
    if (val >= TH.CAUTION) return 'caution';
    if (val >= TH.WARNING) return 'warning';
    return 'danger';
  }

  function getLoanDepositStatus(val) {
    const TH = {
      HIGH: getThreshold('LOAN_DEPOSIT', 'NORMAL_HIGH'),
      LOW: getThreshold('LOAN_DEPOSIT', 'NORMAL_LOW'),
      WARNING: getThreshold('LOAN_DEPOSIT', 'WARNING')
    };
    if (val >= TH.LOW && val <= TH.HIGH) return 'normal';
    if (val > TH.HIGH) return 'caution'; // ê³¼ì—´
    if (val >= TH.WARNING) return 'caution';
    return 'warning';
  }

  function getLoanGrowthStatus(val) {
    const TH = {
      POSITIVE: getThreshold('LOAN_GROWTH', 'POSITIVE'),
      NEUTRAL: getThreshold('LOAN_GROWTH', 'NEUTRAL')
    };
    if (val >= TH.POSITIVE) return 'normal';
    if (val >= TH.NEUTRAL) return 'caution';
    return 'warning';
  }

  // ===== UI ì—…ë°ì´íŠ¸ =====
  function updateUI(processed) {
    const statusLabels = { normal: 'ì •ìƒ', caution: 'ì£¼ì˜', warning: 'ê²½ê³„', danger: 'ìœ„í—˜' };
    const iconColorMap = { normal: 'green', caution: 'yellow', warning: 'orange', danger: 'red' };
    const allStatuses = [];

    // ì—°ì²´ìœ¨
    if (fullData.delinquency.length > 0) {
      const latestDel = fullData.delinquency[fullData.delinquency.length - 1];
      const delStatus = getDelinquencyStatus(latestDel.val);
      allStatuses.push(delStatus);

      document.getElementById('delinquencyValue').textContent = latestDel.val.toFixed(2);
      document.getElementById('delinquencyStatus').textContent = statusLabels[delStatus];
      document.getElementById('delinquencyStatus').className = 'signal-status ' + delStatus;
      document.getElementById('delinquencyIcon').className = 'signal-icon ' + iconColorMap[delStatus];
    } else {
      document.getElementById('delinquencyValue').textContent = 'N/A';
      document.getElementById('delinquencyStatus').textContent = 'ë°ì´í„° ì—†ìŒ';
      document.getElementById('delinquencyStatus').className = 'signal-status';
      document.getElementById('delinquencyIcon').className = 'signal-icon gray';
    }

    // Tier 1
    if (fullData.tier1.length > 0) {
      const latestT1 = fullData.tier1[fullData.tier1.length - 1];
      const t1Status = getTier1Status(latestT1.val);
      allStatuses.push(t1Status);

      document.getElementById('tier1Value').textContent = latestT1.val.toFixed(2);
      document.getElementById('tier1Status').textContent = statusLabels[t1Status];
      document.getElementById('tier1Status').className = 'signal-status ' + t1Status;
      document.getElementById('tier1Icon').className = 'signal-icon ' + iconColorMap[t1Status];
    } else {
      document.getElementById('tier1Value').textContent = 'N/A';
      document.getElementById('tier1Status').textContent = 'ë°ì´í„° ì—†ìŒ';
      document.getElementById('tier1Status').className = 'signal-status';
      document.getElementById('tier1Icon').className = 'signal-icon gray';
    }

    // ì˜ˆëŒ€ìœ¨
    if (processed.loanDepositData.length > 0) {
      const latestLD = processed.loanDepositData[processed.loanDepositData.length - 1];
      const ldStatus = getLoanDepositStatus(latestLD.val);
      allStatuses.push(ldStatus);

      document.getElementById('loanDepositValue').textContent = latestLD.val.toFixed(1);
      document.getElementById('loanDepositStatus').textContent = statusLabels[ldStatus];
      document.getElementById('loanDepositStatus').className = 'signal-status ' + ldStatus;
      document.getElementById('loanDepositIcon').className = 'signal-icon ' + iconColorMap[ldStatus];
    } else {
      document.getElementById('loanDepositValue').textContent = 'N/A';
      document.getElementById('loanDepositStatus').textContent = 'ë°ì´í„° ì—†ìŒ';
      document.getElementById('loanDepositStatus').className = 'signal-status';
      document.getElementById('loanDepositIcon').className = 'signal-icon gray';
    }

    // ì—¬ì‹  ì¦ê°€ìœ¨
    if (processed.loanGrowthData.length > 0) {
      const latestLG = processed.loanGrowthData[processed.loanGrowthData.length - 1];
      const lgStatus = getLoanGrowthStatus(latestLG.val);
      allStatuses.push(lgStatus);

      const sign = latestLG.val >= 0 ? '+' : '';
      document.getElementById('loanGrowthValue').textContent = sign + latestLG.val.toFixed(1);
      document.getElementById('loanGrowthStatus').textContent = statusLabels[lgStatus];
      document.getElementById('loanGrowthStatus').className = 'signal-status ' + lgStatus;
      document.getElementById('loanGrowthIcon').className = 'signal-icon ' + iconColorMap[lgStatus];
    } else {
      document.getElementById('loanGrowthValue').textContent = 'N/A';
      document.getElementById('loanGrowthStatus').textContent = 'ë°ì´í„° ì—†ìŒ';
      document.getElementById('loanGrowthStatus').className = 'signal-status';
      document.getElementById('loanGrowthIcon').className = 'signal-icon gray';
    }

    // ì¢…í•© ìƒíƒœ ë°°ì§€ + Health Pulse Hero ì—…ë°ì´íŠ¸
    updateOverallBadge();
    updateHealthPulseHero(allStatuses);

    // ì„¤ëª… ì¹´ë“œ ë™ì  ì—…ë°ì´íŠ¸
    updateInfoCards(processed, allStatuses);

    // ì—…ë°ì´íŠ¸ ì‹œê°„ (ëª¨ë“  ë°ì´í„° ì¤‘ ê°€ì¥ ìµœì‹ )
    const allDates = [
      fullData.delinquency.length > 0 ? fullData.delinquency[fullData.delinquency.length - 1].date : null,
      fullData.tier1.length > 0 ? fullData.tier1[fullData.tier1.length - 1].date : null,
      fullData.loans.length > 0 ? fullData.loans[fullData.loans.length - 1].date : null,
      fullData.deposits.length > 0 ? fullData.deposits[fullData.deposits.length - 1].date : null
    ].filter(d => d !== null);
    const latestDate = allDates.length > 0 ? allDates.sort().reverse()[0] : '--';
    document.getElementById('updateTime').textContent = `Data: ${latestDate}`;

    // ìœ„ì ¯ ìºì‹œ ì €ì¥
    saveWidgetCache(processed);
  }

  // Health Pulse Hero ì—…ë°ì´íŠ¸
  function updateHealthPulseHero(allStatuses) {
    const statusOrder = ['normal', 'caution', 'warning', 'danger'];
    const worst = allStatuses.reduce((a, b) => statusOrder.indexOf(a) > statusOrder.indexOf(b) ? a : b, 'normal');

    const pulseValue = document.getElementById('healthPulseValue');
    const pulseDesc = document.getElementById('healthPulseDesc');
    const pulseInfo = document.getElementById('healthPulseInfo');

    const config = {
      normal: { label: 'HEALTHY', class: 'healthy', icon: 'fa-check-circle', iconColor: '#4ade80' },
      caution: { label: 'WATCH', class: 'watch', icon: 'fa-eye', iconColor: '#fbbf24' },
      warning: { label: 'CAUTION', class: 'caution', icon: 'fa-exclamation-circle', iconColor: '#fb923c' },
      danger: { label: 'STRESS', class: 'stress', icon: 'fa-times-circle', iconColor: '#f87171' }
    };

    const c = config[worst];
    pulseValue.textContent = c.label;
    pulseValue.className = 'health-pulse-value ' + c.class;
    pulseInfo.querySelector('i').className = 'fas ' + c.icon;
    pulseInfo.querySelector('i').style.color = c.iconColor;

    // ì •ìƒ ì§€í‘œ ê°œìˆ˜
    const normalCount = allStatuses.filter(s => s === 'normal').length;
    pulseDesc.textContent = `${normalCount}/4 indicators normal`;

    // 4ê°œ dot ì—…ë°ì´íŠ¸
    const dotColors = { normal: 'green', caution: 'yellow', warning: 'orange', danger: 'red' };
    allStatuses.forEach((status, i) => {
      const dot = document.getElementById(`dot${i + 1}`);
      if (dot) {
        dot.className = 'health-dot active ' + dotColors[status];
      }
    });
  }

  // ì„¤ëª… ì¹´ë“œ ë™ì  ì—…ë°ì´íŠ¸
  function updateInfoCards(processed, allStatuses) {
    const statusLabels = { normal: 'ì •ìƒ', caution: 'ì£¼ì˜', warning: 'ê²½ê³„', danger: 'ìœ„í—˜' };
    const badgeColors = { normal: 'green', caution: 'yellow', warning: 'orange', danger: 'red' };

    // í˜„ì¬ ê°’ ì¶”ì¶œ
    const latestDel = fullData.delinquency.length > 0 ? fullData.delinquency[fullData.delinquency.length - 1] : null;
    const latestT1 = fullData.tier1.length > 0 ? fullData.tier1[fullData.tier1.length - 1] : null;
    const latestLD = processed.loanDepositData.length > 0 ? processed.loanDepositData[processed.loanDepositData.length - 1] : null;
    const latestLG = processed.loanGrowthData.length > 0 ? processed.loanGrowthData[processed.loanGrowthData.length - 1] : null;

    // ê°œë³„ ìƒíƒœ
    const delStatus = latestDel ? getDelinquencyStatus(latestDel.val) : 'normal';
    const t1Status = latestT1 ? getTier1Status(latestT1.val) : 'normal';
    const ldStatus = latestLD ? getLoanDepositStatus(latestLD.val) : 'normal';
    const lgStatus = latestLG ? getLoanGrowthStatus(latestLG.val) : 'normal';

    // ìƒì„¸ ë°ì´í„° ì—…ë°ì´íŠ¸ (null ì²˜ë¦¬ í¬í•¨)
    if (latestDel) {
      document.getElementById('detailDelinq').innerHTML =
        `${latestDel.val.toFixed(2)}% <span class="info-badge ${badgeColors[delStatus]}">${statusLabels[delStatus]}</span>`;
    } else {
      document.getElementById('detailDelinq').innerHTML =
        `N/A <span class="info-badge gray">ë°ì´í„° ì—†ìŒ</span>`;
    }
    if (latestT1) {
      document.getElementById('detailTier1').innerHTML =
        `${latestT1.val.toFixed(2)}% <span class="info-badge ${badgeColors[t1Status]}">${statusLabels[t1Status]}</span>`;
    } else {
      document.getElementById('detailTier1').innerHTML =
        `N/A <span class="info-badge gray">ë°ì´í„° ì—†ìŒ</span>`;
    }
    if (latestLD) {
      document.getElementById('detailLD').innerHTML =
        `${latestLD.val.toFixed(1)}% <span class="info-badge ${badgeColors[ldStatus]}">${statusLabels[ldStatus]}</span>`;
    } else {
      document.getElementById('detailLD').innerHTML =
        `N/A <span class="info-badge gray">ë°ì´í„° ì—†ìŒ</span>`;
    }
    if (latestLG) {
      const sign = latestLG.val >= 0 ? '+' : '';
      document.getElementById('detailLG').innerHTML =
        `${sign}${latestLG.val.toFixed(1)}% <span class="info-badge ${badgeColors[lgStatus]}">${statusLabels[lgStatus]}</span>`;
    } else {
      document.getElementById('detailLG').innerHTML =
        `N/A <span class="info-badge gray">ë°ì´í„° ì—†ìŒ</span>`;
    }

    // ì¢…í•© ìƒíƒœ íŒì •
    const statusOrder = ['normal', 'caution', 'warning', 'danger'];
    const worst = allStatuses.reduce((a, b) => statusOrder.indexOf(a) > statusOrder.indexOf(b) ? a : b, 'normal');
    const normalCount = allStatuses.filter(s => s === 'normal').length;

    // ìš”ì•½ ë° ê²°ë¡  ì—…ë°ì´íŠ¸
    const summaryMessages = {
      normal: `ğŸŸ¢ ì€í–‰ ê±´ì „ì„± ì–‘í˜¸ (${normalCount}/4 ì§€í‘œ ì •ìƒ)`,
      caution: `ğŸŸ¡ ì¼ë¶€ ì§€í‘œ ì£¼ì˜ í•„ìš” (${normalCount}/4 ì§€í‘œ ì •ìƒ)`,
      warning: `ğŸŸ  ê±´ì „ì„± ê²½ê³„ ìˆ˜ì¤€ (${normalCount}/4 ì§€í‘œ ì •ìƒ)`,
      danger: `ğŸ”´ ì‹œìŠ¤í…œ ë¦¬ìŠ¤í¬ ê²½ë³´ (${normalCount}/4 ì§€í‘œ ì •ìƒ)`
    };

    const conclusionMessages = {
      normal: 'ëª¨ë“  í•µì‹¬ ì§€í‘œê°€ ì•ˆì •ì ì¸ ë²”ìœ„ ë‚´ì— ìˆìŠµë‹ˆë‹¤. ì€í–‰ ì‹œìŠ¤í…œì´ ê±´ì „í•˜ê²Œ ìš´ì˜ë˜ê³  ìˆìŠµë‹ˆë‹¤.',
      caution: 'ì¼ë¶€ ì§€í‘œì—ì„œ ì£¼ì˜ ì‹ í˜¸ê°€ ê°ì§€ë©ë‹ˆë‹¤. í•´ë‹¹ ì§€í‘œì˜ ì¶”ì´ë¥¼ ê³„ì† ëª¨ë‹ˆí„°ë§í•˜ì„¸ìš”.',
      warning: 'ì—¬ëŸ¬ ì§€í‘œì—ì„œ ê²½ê³„ ìˆ˜ì¤€ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤. ê¸ˆìœµ ì‹œì¥ ë³€ë™ì„± í™•ëŒ€ì— ì£¼ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.',
      danger: 'ë³µìˆ˜ì˜ í•µì‹¬ ì§€í‘œê°€ ìœ„í—˜ ìˆ˜ì¤€ì…ë‹ˆë‹¤. 2008ë…„ ê¸ˆìœµìœ„ê¸° ì§ì „ê³¼ ìœ ì‚¬í•œ íŒ¨í„´ì´ ê°ì§€ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'
    };

    document.getElementById('statusSummary').textContent = summaryMessages[worst];
    document.getElementById('statusConclusion').textContent = conclusionMessages[worst];
  }

  function updateOverallBadge() {
    const badge = document.getElementById('statusBadge');
    const text = document.getElementById('statusText');

    // 4ê°œ ì§€í‘œ ì¤‘ ê°€ì¥ ë‚˜ìœ ìƒíƒœ ì„ íƒ
    const statuses = [];

    if (fullData.delinquency.length > 0) {
      statuses.push(getDelinquencyStatus(fullData.delinquency[fullData.delinquency.length - 1].val));
    }
    if (fullData.tier1.length > 0) {
      statuses.push(getTier1Status(fullData.tier1[fullData.tier1.length - 1].val));
    }

    const statusOrder = ['normal', 'caution', 'warning', 'danger'];
    const worst = statuses.reduce((a, b) => statusOrder.indexOf(a) > statusOrder.indexOf(b) ? a : b, 'normal');

    const config = {
      normal: { bg: '#dcfce7', border: '#bbf7d0', color: '#166534', text: 'Healthy' },
      caution: { bg: '#fef3c7', border: '#fde68a', color: '#d97706', text: 'Watch' },
      warning: { bg: '#ffedd5', border: '#fed7aa', color: '#c2410c', text: 'Caution' },
      danger: { bg: '#fee2e2', border: '#fecaca', color: '#dc2626', text: 'Stress' }
    };

    const c = config[worst];
    badge.style.cssText = `background:${c.bg}; border-color:${c.border}; color:${c.color}`;
    badge.querySelector('.status-dot').style.background = c.color;
    text.textContent = c.text;
  }

  // ===== Widget ìºì‹œ ì €ì¥ =====
  function saveWidgetCache(processed) {
    if (typeof DataManager === 'undefined') return;

    const statusLabels = { normal: 'ì •ìƒ', caution: 'ì£¼ì˜', warning: 'ê²½ê³„', danger: 'ìœ„í—˜' };

    const latestDel = fullData.delinquency.length > 0 ? fullData.delinquency[fullData.delinquency.length - 1] : { val: 0 };
    const latestT1 = fullData.tier1.length > 0 ? fullData.tier1[fullData.tier1.length - 1] : { val: 0 };
    const latestLD = processed.loanDepositData.length > 0 ? processed.loanDepositData[processed.loanDepositData.length - 1] : { val: 0 };
    const latestLG = processed.loanGrowthData.length > 0 ? processed.loanGrowthData[processed.loanGrowthData.length - 1] : { val: 0 };

    const delStatus = getDelinquencyStatus(latestDel.val);
    const t1Status = getTier1Status(latestT1.val);
    const ldStatus = getLoanDepositStatus(latestLD.val);
    const lgStatus = getLoanGrowthStatus(latestLG.val);

    // ì¢…í•© ìƒíƒœ
    const statusOrder = ['normal', 'caution', 'warning', 'danger'];
    const overallStatus = [delStatus, t1Status, ldStatus, lgStatus].reduce(
      (a, b) => statusOrder.indexOf(a) > statusOrder.indexOf(b) ? a : b, 'normal'
    );

    const overallLabels = { normal: 'Healthy', caution: 'Watch', warning: 'Caution', danger: 'Stress' };

    const widgetData = {
      overallStatus,
      overallLabel: overallLabels[overallStatus],
      delinquency: { value: latestDel.val, status: delStatus, label: statusLabels[delStatus] },
      tier1: { value: latestT1.val, status: t1Status, label: statusLabels[t1Status] },
      loanDeposit: { value: latestLD.val, status: ldStatus, label: statusLabels[ldStatus] },
      loanGrowth: { value: latestLG.val, status: lgStatus, label: statusLabels[lgStatus] },
      updated: new Date().toISOString()
    };

    DataManager.saveWidgetData('banking-health', widgetData);
    console.log('[Detail] Banking Health cache saved:', widgetData);
  }

  // ===== ì•ˆì „í•œ ì°¨íŠ¸ destroy í—¬í¼ =====
  function safeDestroyChart(chart) {
    if (chart && typeof chart.destroy === 'function') {
      try {
        chart.destroy();
      } catch (e) {
        console.warn('[Chart] destroy error:', e);
      }
    }
    return null;
  }

  // ===== ì°¨íŠ¸ ë Œë”ë§ =====
  // ===== Fill-Forward ë³´ê°„ í•¨ìˆ˜ (ë¶„ê¸° â†’ ì¼ê°„) =====
  // ë¶„ê¸° ë°ì´í„°ë¥¼ ì¼ê°„ ë‚ ì§œ ê·¸ë¦¬ë“œì— ë§ì¶° ì±„ì›€ (ê°€ì¥ ìµœê·¼ ê³¼ê±° ê°’ ì‚¬ìš©)
  function fillForward(quarterlyData, dailyDates) {
    // ë¶„ê¸° ë°ì´í„°ë¥¼ ë‚ ì§œìˆœ ì •ë ¬
    const sorted = [...quarterlyData].sort((a, b) => a.date.localeCompare(b.date));
    const filled = [];
    let lastValue = null;

    for (const date of dailyDates) {
      // í˜„ì¬ ë‚ ì§œ ì´í•˜ì˜ ê°€ì¥ ìµœê·¼ ë¶„ê¸° ë°ì´í„° ì°¾ê¸°
      for (const q of sorted) {
        if (q.date <= date) {
          lastValue = q.val;
        } else {
          break;  // ì´ë¯¸ ì •ë ¬ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ë” ë³¼ í•„ìš” ì—†ìŒ
        }
      }
      filled.push(lastValue);
    }
    return filled;
  }

  // ===== Capital Resilience ì°¨íŠ¸ (Defense vs Offense ëª¨ë¸) =====
  // Defense (ì„±ë²½): FDIC Tier1 + FED Tier1 â†’ ë†’ì„ìˆ˜ë¡ ì•ˆì „
  // Offense (íŒŒë„): 10Y Yield + HY Spread â†’ ë†’ì„ìˆ˜ë¡ ìœ„í—˜
  // ìˆ˜ì •: suggestedMax (ì ì‘í˜• ìŠ¤ì¼€ì¼), Fill-Forward (íˆ´íŒ ì™„ì „ í‘œì‹œ)
  function renderCapitalChart(processed) {
    const ctx = document.getElementById('capitalChart').getContext('2d');
    capitalChart = safeDestroyChart(capitalChart);

    // ê¸°ê°„ í•„í„°ë§
    const cutoff = new Date(Date.now() - currentPeriod * 86400000).toISOString().split('T')[0];

    // ì¼ê°„ ë°ì´í„°: cutoff ì´í›„ë§Œ
    const y10Data = fullData.yield10y.filter(d => d.date >= cutoff);   // 10Y Yield (Offense 1) - ì¼ê°„
    const hyData = fullData.hySpread.filter(d => d.date >= cutoff);    // HY Spread (Offense 2) - ì¼ê°„

    // ë¶„ê¸° ë°ì´í„°: cutoff ì´ì „ ìµœê·¼ 1ê°œ í¬í•¨ (fillForwardê°€ ì²« êµ¬ê°„ ì±„ìš°ë„ë¡)
    // ì˜ˆ: 1Y cutoff=2024-12-07ì´ë©´, 2024-10-01 ë¶„ê¸° ë°ì´í„°ë„ í•„ìš”
    const getQuarterlyWithPrior = (data) => {
      const sorted = [...data].sort((a, b) => a.date.localeCompare(b.date));
      const priorData = sorted.filter(d => d.date < cutoff);
      const afterData = sorted.filter(d => d.date >= cutoff);
      // cutoff ì´ì „ ë§ˆì§€ë§‰ 1ê°œ + cutoff ì´í›„ ì „ì²´
      const lastPrior = priorData.length > 0 ? [priorData[priorData.length - 1]] : [];
      return [...lastPrior, ...afterData];
    };

    const t1Data = getQuarterlyWithPrior(fullData.tier1);       // FDIC Tier1 (Defense 1) - ë¶„ê¸°
    const fedT1Data = getQuarterlyWithPrior(fullData.fedTier1); // FED Tier1 (Defense 2) - ë¶„ê¸°

    // ì¼ê°„ ë°ì´í„° ë‚ ì§œë¥¼ ê¸°ì¤€ ê·¸ë¦¬ë“œë¡œ ì‚¬ìš© (ë” ì´˜ì´˜í•¨)
    const dailyDates = [...new Set([
      ...y10Data.map(d => d.date),
      ...hyData.map(d => d.date)
    ])].sort();

    // ë¶„ê¸° ë°ì´í„° â†’ ì¼ê°„ ê·¸ë¦¬ë“œë¡œ Fill-Forward ë³´ê°„
    const t1Filled = fillForward(t1Data, dailyDates);
    const fedT1Filled = fillForward(fedT1Data, dailyDates);

    // ì¼ê°„ ë°ì´í„° Map
    const y10Map = new Map(y10Data.map(d => [d.date, d.val]));
    const hyMap = new Map(hyData.map(d => [d.date, d.val]));

    const labels = dailyDates;
    const y10Values = labels.map(d => y10Map.get(d) || null);
    const hyValues = labels.map(d => hyMap.get(d) || null);

    // ì½˜ì†” ë¡œê·¸: ë°ì´í„° ê²€ì¦
    console.log('[Capital] Data check:', {
      labels: labels.length,
      t1Filled: t1Filled.filter(v => v !== null).length,
      fedT1Filled: fedT1Filled.filter(v => v !== null).length,
      y10: y10Values.filter(v => v !== null).length,
      hy: hyValues.filter(v => v !== null).length
    });

    // Annotations: ë¦¬ì„¸ì…˜ + Danger Zone + Stress Zone
    let annotations = {};
    if (typeof getRecessionAnnotations === 'function' && labels.length > 0) {
      annotations = getRecessionAnnotations(labels[0], labels[labels.length - 1], { showLabel: true });
      Object.entries(annotations).forEach(([key, val]) => {
        const findClosest = (target) => {
          const t = new Date(target).getTime();
          return labels.reduce((prev, curr) =>
            Math.abs(new Date(curr).getTime() - t) < Math.abs(new Date(prev).getTime() - t) ? curr : prev
          );
        };
        annotations[key].xMin = findClosest(val.xMin);
        annotations[key].xMax = findClosest(val.xMax);
      });
    }

    // Defense: Danger Zone 8~10% ë¶‰ì€ ë°•ìŠ¤ (Tier1 10% ë¯¸ë§Œ = ìœ„í—˜)
    annotations.dangerZone = {
      type: 'box',
      yMin: 8, yMax: 10,
      yScaleID: 'y',
      backgroundColor: 'rgba(239, 68, 68, 0.08)',
      borderWidth: 0
    };

    // Defense: ìë³¸ ìœ„í—˜ì„  10% (Tier1 ê¸°ì¤€)
    annotations.capitalThreshold = {
      type: 'line',
      yMin: 10, yMax: 10,
      yScaleID: 'y',
      borderColor: 'rgba(239, 68, 68, 0.5)',
      borderWidth: 1.5,
      borderDash: [8, 4],
      label: {
        content: 'ìë³¸ ìœ„í—˜ì„  10%',
        display: true,
        position: 'start',
        font: { size: 9 },
        color: '#ef4444',
        backgroundColor: 'rgba(255,255,255,0.8)',
        padding: 2
      }
    };

    // Offense: ìŠ¤íŠ¸ë ˆìŠ¤ ê²½ê³„ 5% (HY/ê¸ˆë¦¬ ê³µí†µ)
    // ë°•ìŠ¤ ì œê±° - ê²½ê³„ì„ ë§Œ í‘œì‹œ (ë‹¤ë¥¸ ê·¸ë˜í”„ì™€ í†µì¼ì„±)
    // Okabe-Ito Vermillion: #D55E00
    annotations.stressThreshold = {
      type: 'line',
      yMin: 5, yMax: 5,
      yScaleID: 'y1',
      borderColor: 'rgba(213, 94, 0, 0.5)',
      borderWidth: 1.5,
      borderDash: [8, 4],
      label: {
        content: 'ìŠ¤íŠ¸ë ˆìŠ¤ ê²½ê³„ 5%',
        display: true,
        position: 'end',
        font: { size: 9 },
        color: '#D55E00',
        backgroundColor: 'rgba(255,255,255,0.8)',
        padding: 2
      }
    };

    capitalChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          // Defense 1: FDIC Tier 1 (ì£¼ì—­, Steel Blue, fill, stepped)
          // Okabe-Ito ìƒ‰ë§¹ ì•ˆì „ íŒ”ë ˆíŠ¸ + Bloomberg ì»¨ë²¤ì…˜
          {
            label: 'FDIC Tier1',
            data: t1Filled,
            borderColor: '#0072B2',  // Steel Blue (ìƒ‰ë§¹ ì•ˆì „)
            backgroundColor: 'rgba(0, 114, 178, 0.15)',
            borderWidth: 3,
            pointRadius: 0,
            fill: true,
            spanGaps: true,
            stepped: 'before',  // ê³„ë‹¨ì‹ (ë¶„ê¸° ë°ì´í„°)
            yAxisID: 'y',
            order: 3  // ë’¤ì— ë°°ì¹˜
          },
          // Defense 2: FED Tier 1 (êµì°¨ê²€ì¦, Sky Blue ì ì„ , stepped)
          {
            label: 'FED Tier1',
            data: fedT1Filled,
            borderColor: '#56B4E9',  // Sky Blue (ë³´ì¡°)
            backgroundColor: 'transparent',
            borderWidth: 2,
            borderDash: [5, 3],
            pointRadius: 0,
            fill: false,
            spanGaps: true,
            stepped: 'before',  // ê³„ë‹¨ì‹ (ë¶„ê¸° ë°ì´í„°)
            yAxisID: 'y',
            order: 2  // Defense ë’¤
          },
          // Offense 1: 10Y Yield (Orange, ë‚ ì¹´ë¡­ê²Œ)
          {
            label: '10Y ê¸ˆë¦¬',
            data: y10Values,
            borderColor: '#E69F00',  // Orange (ìƒ‰ë§¹ ì•ˆì „)
            backgroundColor: 'transparent',
            borderWidth: 2.5,
            tension: 0.1,
            pointRadius: 0,
            fill: false,
            spanGaps: true,
            yAxisID: 'y1',
            order: 1  // ì•ì— ë°°ì¹˜
          },
          // Offense 2: HY Spread (Reddish Purple ì ì„ )
          {
            label: 'HY ìŠ¤í”„ë ˆë“œ',
            data: hyValues,
            borderColor: '#CC79A7',  // Reddish Purple (ìƒ‰ìƒ ëŒ€ë¹„ ê°•í™”)
            backgroundColor: 'transparent',
            borderWidth: 2,
            borderDash: [4, 2],
            tension: 0.1,
            pointRadius: 0,
            fill: false,
            spanGaps: true,
            yAxisID: 'y1',
            order: 1  // ì•ì— ë°°ì¹˜
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(15, 23, 42, 0.95)',
            padding: 12,
            cornerRadius: 10,
            callbacks: {
              label: (ctx) => {
                const label = ctx.dataset.label;
                const val = ctx.parsed.y;
                if (val === null) return null;
                return `${label}: ${val.toFixed(2)}%`;
              }
            }
          },
          annotation: { annotations }
        },
        scales: {
          x: { grid: { display: false }, ticks: { maxTicksLimit: 8, font: { size: 10 } } },
          // Left Y-axis: Defense (8% ~ suggestedMax 16%)
          // Okabe-Ito Steel Blue: #0072B2
          y: {
            type: 'linear', position: 'left',
            min: 8,
            suggestedMax: 16,  // ì ì‘í˜•: 16 ë„˜ìœ¼ë©´ í™•ì¥
            grid: { color: '#f1f5f9' },
            ticks: { callback: v => v + '%', color: '#0072B2', font: { size: 10 } },
            title: { display: true, text: 'Tier 1 ìë³¸ë¹„ìœ¨ %', color: '#0072B2', font: { size: 11 } }
          },
          // Right Y-axis: Offense (0% ~ suggestedMax 10%)
          // Okabe-Ito Orange: #E69F00
          y1: {
            type: 'linear', position: 'right',
            min: 0,
            suggestedMax: 10,  // ì ì‘í˜•: 10 ë„˜ìœ¼ë©´ í™•ì¥ (2008ë…„ HY 21%+)
            grid: { drawOnChartArea: false },
            ticks: { callback: v => v + '%', color: '#E69F00', font: { size: 10 } },
            title: { display: true, text: 'ê¸ˆë¦¬ / ìŠ¤í”„ë ˆë“œ %', color: '#E69F00', font: { size: 11 } }
          }
        }
      }
    });
  }

  function renderCreditChart(processed) {
    const ctx = document.getElementById('creditChart').getContext('2d');
    creditChart = safeDestroyChart(creditChart);

    const cutoff = new Date(Date.now() - currentPeriod * 86400000).toISOString().split('T')[0];
    const ldData = processed.loanDepositData.filter(d => d.date >= cutoff);
    const lgData = processed.loanGrowthData.filter(d => d.date >= cutoff);

    // ê³µí†µ ë‚ ì§œ ì¶”ì¶œ
    const allDates = [...new Set([...ldData.map(d => d.date), ...lgData.map(d => d.date)])].sort();

    const ldMap = new Map(ldData.map(d => [d.date, d.val]));
    const lgMap = new Map(lgData.map(d => [d.date, d.val]));

    const labels = allDates;
    const ldValues = labels.map(d => ldMap.get(d) || null);
    const lgValues = labels.map(d => lgMap.get(d) || null);

    // ë¦¬ì„¸ì…˜ annotation
    let annotations = {};
    if (typeof getRecessionAnnotations === 'function' && labels.length > 0) {
      annotations = getRecessionAnnotations(labels[0], labels[labels.length - 1], { showLabel: true });
      Object.entries(annotations).forEach(([key, val]) => {
        const findClosest = (target) => {
          const t = new Date(target).getTime();
          return labels.reduce((prev, curr) =>
            Math.abs(new Date(curr).getTime() - t) < Math.abs(new Date(prev).getTime() - t) ? curr : prev
          );
        };
        annotations[key].xMin = findClosest(val.xMin);
        annotations[key].xMax = findClosest(val.xMax);
      });
    }

    // ì˜ˆëŒ€ìœ¨ ì„ê³„ê°’ ì°¸ì¡°ì„  (ì¢Œì¸¡ yì¶•)
    annotations.ldHigh = {
      type: 'line',
      yMin: 85, yMax: 85,
      yScaleID: 'y_left',
      borderColor: 'rgba(202, 138, 4, 0.5)',
      borderWidth: 1,
      borderDash: [5, 5],
      label: { display: true, content: 'ê³¼ì—´ 85%', position: 'start', backgroundColor: 'rgba(202, 138, 4, 0.8)', font: { size: 9 } }
    };
    annotations.ldLow = {
      type: 'line',
      yMin: 60, yMax: 60,
      yScaleID: 'y_left',
      borderColor: 'rgba(59, 130, 246, 0.5)',
      borderWidth: 1,
      borderDash: [5, 5],
      label: { display: true, content: 'ìœ„ì¶• 60%', position: 'start', backgroundColor: 'rgba(59, 130, 246, 0.8)', font: { size: 9 } }
    };
    // 0% ì°¸ì¡°ì„  (ìš°ì¸¡ yì¶•)
    annotations.zeroLine = {
      type: 'line',
      yMin: 0, yMax: 0,
      yScaleID: 'y_right',
      borderColor: 'rgba(107, 114, 128, 0.5)',
      borderWidth: 1,
      borderDash: [5, 5]
    };

    creditChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: 'Loan/Deposit Ratio',
            data: ldValues,
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            borderWidth: 2,
            tension: 0.3,
            pointRadius: 0,
            yAxisID: 'y_left',
            spanGaps: true
          },
          {
            label: 'Loan Growth YoY',
            data: lgValues,
            borderColor: '#f59e0b',
            backgroundColor: 'rgba(245, 158, 11, 0.1)',
            borderWidth: 2,
            tension: 0.3,
            pointRadius: 0,
            yAxisID: 'y_right',
            spanGaps: true
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(15, 23, 42, 0.95)',
            padding: 12,
            cornerRadius: 10
          },
          annotation: { annotations }
        },
        scales: {
          x: { grid: { display: false }, ticks: { maxTicksLimit: 8, font: { size: 10 } } },
          y_left: {
            type: 'linear', position: 'left',
            grid: { color: '#f1f5f9' },
            ticks: { callback: v => v + '%', color: '#3b82f6', font: { size: 10 } },
            title: { display: true, text: 'Loan/Deposit %', color: '#3b82f6' }
          },
          y_right: {
            type: 'linear', position: 'right',
            grid: { display: false },
            ticks: { callback: v => v.toFixed(0) + '%', color: '#f59e0b', font: { size: 10 } },
            title: { display: true, text: 'Loan Growth YoY %', color: '#f59e0b' }
          }
        }
      }
    });
  }

  // ===== Risks ì°¨íŠ¸: Small Multiples Dêµ¬ì¡° + ì ‘ì´ì‹ =====
  let risksMainChart = null;
  let risksMiniCCChart = null;
  let risksMiniConsumerChart = null;
  let risksMiniBusinessChart = null;
  let risksMiniCREChart = null;

  function renderRisksChart() {
    const cutoff = new Date(Date.now() - risksPeriod * 86400000).toISOString().split('T')[0];

    // ì—°ì²´ìœ¨ ë°ì´í„°
    const totalData = fullData.delinquency.filter(d => d.date >= cutoff);
    const ccData = fullData.creditCardDelinq.filter(d => d.date >= cutoff);
    const csData = fullData.consumerDelinq.filter(d => d.date >= cutoff);
    const bsData = fullData.businessDelinq.filter(d => d.date >= cutoff);
    const creData = (fullData.creDelinq || []).filter(d => d.date >= cutoff);

    // ğŸ†• NCO (ìƒê°ìœ¨) ë°ì´í„° - 5ê°œ ì „ì²´
    const ncoTotalData = (fullData.ncoTotal || []).filter(d => d.date >= cutoff);
    const ncoCCData = (fullData.ncoCreditCard || []).filter(d => d.date >= cutoff);
    const ncoConsumerData = (fullData.ncoConsumer || []).filter(d => d.date >= cutoff);
    const ncoBusinessData = (fullData.ncoBusiness || []).filter(d => d.date >= cutoff);
    const ncoCREData = (fullData.ncoCRE || []).filter(d => d.date >= cutoff);

    // ê³µí†µ ë‚ ì§œ ì¶”ì¶œ (ì—°ì²´ìœ¨ + NCO ì „ì²´)
    const allDates = [...new Set([
      ...totalData.map(d => d.date),
      ...ccData.map(d => d.date),
      ...csData.map(d => d.date),
      ...bsData.map(d => d.date),
      ...creData.map(d => d.date),
      ...ncoTotalData.map(d => d.date),
      ...ncoCCData.map(d => d.date),
      ...ncoConsumerData.map(d => d.date),
      ...ncoBusinessData.map(d => d.date),
      ...ncoCREData.map(d => d.date)
    ])].sort();

    // Map ìƒì„±
    const totalMap = new Map(totalData.map(d => [d.date, d.val]));
    const ccMap = new Map(ccData.map(d => [d.date, d.val]));
    const csMap = new Map(csData.map(d => [d.date, d.val]));
    const bsMap = new Map(bsData.map(d => [d.date, d.val]));
    const creMap = new Map(creData.map(d => [d.date, d.val]));
    const ncoTotalMap = new Map(ncoTotalData.map(d => [d.date, d.val]));
    const ncoCCMap = new Map(ncoCCData.map(d => [d.date, d.val]));
    const ncoConsumerMap = new Map(ncoConsumerData.map(d => [d.date, d.val]));
    const ncoBusinessMap = new Map(ncoBusinessData.map(d => [d.date, d.val]));
    const ncoCREMap = new Map(ncoCREData.map(d => [d.date, d.val]));

    const labels = allDates;
    const totalValues = labels.map(d => totalMap.get(d) || null);
    const ccValues = labels.map(d => ccMap.get(d) || null);
    const csValues = labels.map(d => csMap.get(d) || null);
    const bsValues = labels.map(d => bsMap.get(d) || null);
    const creValues = labels.map(d => creMap.get(d) || null);
    // NCO ê°’ ë°°ì—´
    const ncoTotalValues = labels.map(d => ncoTotalMap.get(d) || null);
    const ncoCCValues = labels.map(d => ncoCCMap.get(d) || null);
    const ncoConsumerValues = labels.map(d => ncoConsumerMap.get(d) || null);
    const ncoBusinessValues = labels.map(d => ncoBusinessMap.get(d) || null);
    const ncoCREValues = labels.map(d => ncoCREMap.get(d) || null);

    // Yì¶• ë™ì¼ ìŠ¤ì¼€ì¼ (ì„¹í„° ë¹„êµ ê°€ëŠ¥) - ì—°ì²´ìœ¨ ê¸°ì¤€
    const allValues = [...totalValues, ...ccValues, ...csValues, ...bsValues, ...creValues].filter(v => v !== null);
    const yMax = Math.ceil(Math.max(...allValues)) + 1;

    // ë¦¬ì„¸ì…˜ annotation (ê³µí†µ)
    let annotations = {};
    if (typeof getRecessionAnnotations === 'function' && labels.length > 0) {
      annotations = getRecessionAnnotations(labels[0], labels[labels.length - 1], { showLabel: false });
      Object.entries(annotations).forEach(([key, val]) => {
        const findClosest = (target) => {
          const t = new Date(target).getTime();
          return labels.reduce((prev, curr) =>
            Math.abs(new Date(curr).getTime() - t) < Math.abs(new Date(prev).getTime() - t) ? curr : prev
          );
        };
        annotations[key].xMin = findClosest(val.xMin);
        annotations[key].xMax = findClosest(val.xMax);
      });
    }

    // ë©”ì¸ ì°¨íŠ¸ ë Œë”ë§ (NCO ë°ì´í„° ì¶”ê°€)
    renderRisksMainChart(labels, totalValues, ncoTotalValues, annotations, yMax);

    // ğŸ†• ë¯¸ë‹ˆ ì°¨íŠ¸ 4ê°œ ë Œë”ë§ (NCO ë°ì´í„° ì¶”ê°€)
    renderRisksMiniChart('risksMiniCC', ccValues, ncoCCValues, labels, '#ef4444', annotations, yMax, 'risksMiniCCChart');
    renderRisksMiniChart('risksMiniConsumer', csValues, ncoConsumerValues, labels, '#f59e0b', annotations, yMax, 'risksMiniConsumerChart');
    renderRisksMiniChart('risksMiniBusiness', bsValues, ncoBusinessValues, labels, '#10b981', annotations, yMax, 'risksMiniBusinessChart');
    renderRisksMiniChart('risksMiniCRE', creValues, ncoCREValues, labels, '#8b5cf6', annotations, yMax, 'risksMiniCREChart');

    // ê°’ ì—…ë°ì´íŠ¸
    updateRisksValues(totalValues, ccValues, csValues, bsValues, creValues);
  }

  // ğŸ†• Dual-Axis ì°¨íŠ¸: ì—°ì²´ìœ¨ (ì¢Œ) + ìƒê°ìœ¨ (ìš°)
  function renderRisksMainChart(labels, delinqData, ncoData, annotations, yMax) {
    risksMainChart = safeDestroyChart(risksMainChart);
    const ctx = document.getElementById('risksMainChart').getContext('2d');

    // ì„ê³„ê°’ ì°¸ì¡°ì„  (ì¢Œì¸¡ Yì¶• = ì—°ì²´ìœ¨)
    const mainAnnotations = { ...annotations };
    mainAnnotations.thresholdNormal = {
      type: 'line', yMin: 2, yMax: 2, yScaleID: 'yDelinq',
      borderColor: 'rgba(22, 163, 74, 0.5)', borderWidth: 1, borderDash: [5, 5],
      label: { display: true, content: 'ì •ìƒ 2%', position: 'start', backgroundColor: 'rgba(22, 163, 74, 0.8)', font: { size: 9 } }
    };
    mainAnnotations.thresholdCaution = {
      type: 'line', yMin: 3, yMax: 3, yScaleID: 'yDelinq',
      borderColor: 'rgba(202, 138, 4, 0.5)', borderWidth: 1, borderDash: [5, 5],
      label: { display: true, content: 'ì£¼ì˜ 3%', position: 'start', backgroundColor: 'rgba(202, 138, 4, 0.8)', font: { size: 9 } }
    };
    mainAnnotations.thresholdWarning = {
      type: 'line', yMin: 4, yMax: 4, yScaleID: 'yDelinq',
      borderColor: 'rgba(220, 38, 38, 0.5)', borderWidth: 1, borderDash: [5, 5],
      label: { display: true, content: 'ìœ„í—˜ 4%', position: 'start', backgroundColor: 'rgba(220, 38, 38, 0.8)', font: { size: 9 } }
    };

    // ğŸ†• NCO Yì¶• ìµœëŒ€ê°’ ê³„ì‚° (ì‹¤ì œ ë°ì´í„° ê¸°ì¤€ - ìƒê°ìœ¨ì´ ì—°ì²´ìœ¨ë³´ë‹¤ ë†’ì„ ìˆ˜ ìˆìŒ)
    const ncoValidValues = ncoData ? ncoData.filter(v => v !== null) : [];
    const ncoActualMax = ncoValidValues.length > 0 ? Math.max(...ncoValidValues) : 0;
    const ncoMax = Math.ceil(Math.max(ncoActualMax, yMax / 2)) + 1;

    // Datasets êµ¬ì„±
    const datasets = [
      // ì—°ì²´ìœ¨ (ì¢Œì¸¡ Yì¶•) - Primary, fill
      {
        label: 'ì—°ì²´ìœ¨ (Delinquency)',
        data: delinqData,
        borderColor: '#E69F00',  // Okabe-Ito Orange
        backgroundColor: 'rgba(230, 159, 0, 0.15)',
        borderWidth: 3,
        tension: 0.3,
        pointRadius: 0,
        fill: true,
        spanGaps: true,
        yAxisID: 'yDelinq',
        order: 2  // ë’¤ì— ê·¸ë ¤ì§
      }
    ];

    // ğŸ†• NCO í† ê¸€ ONì¼ ë•Œë§Œ ì¶”ê°€
    if (showNcoOverlay && ncoData) {
      datasets.push({
        label: 'ìƒê°ìœ¨ (Charge-Off)',
        data: ncoData,
        borderColor: '#D55E00',  // Okabe-Ito Vermillion
        backgroundColor: 'transparent',
        borderWidth: 2,
        borderDash: [4, 4],
        tension: 0.3,
        pointRadius: 0,
        fill: false,
        spanGaps: true,
        yAxisID: 'yNCO',
        order: 1  // ì•ì— ê·¸ë ¤ì§
      });
    }

    // Scales êµ¬ì„±
    const scales = {
      x: { grid: { display: false }, ticks: { maxTicksLimit: 6, font: { size: 10 } } },
      yDelinq: {
        type: 'linear',
        position: 'left',
        min: 0,
        max: yMax,
        grid: { color: '#e5e7eb' },
        ticks: {
          callback: v => v.toFixed(1) + '%',
          font: { size: 10 },
          color: '#E69F00'
        },
        title: { display: true, text: 'ì—°ì²´ìœ¨ %', color: '#E69F00', font: { size: 10, weight: 'bold' } }
      }
    };

    // ğŸ†• NCO ìš°ì¸¡ Yì¶• (í† ê¸€ ONì¼ ë•Œë§Œ)
    if (showNcoOverlay) {
      scales.yNCO = {
        type: 'linear',
        position: 'right',
        min: 0,
        max: ncoMax,
        grid: { display: false },
        ticks: {
          callback: v => v.toFixed(1) + '%',
          font: { size: 10 },
          color: '#D55E00'
        },
        title: { display: true, text: 'ìƒê°ìœ¨ %', color: '#D55E00', font: { size: 10, weight: 'bold' } }
      };
    }

    risksMainChart = new Chart(ctx, {
      type: 'line',
      data: { labels, datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { display: showNcoOverlay, position: 'bottom', labels: { boxWidth: 12, padding: 8, font: { size: 10 } } },
          tooltip: {
            backgroundColor: 'rgba(15, 23, 42, 0.95)',
            padding: 12,
            cornerRadius: 10,
            callbacks: {
              label: ctx => {
                const label = ctx.dataset.label || '';
                const val = ctx.parsed.y;
                return val !== null ? `${label}: ${val.toFixed(2)}%` : `${label}: N/A`;
              }
            }
          },
          annotation: { annotations: mainAnnotations }
        },
        scales
      }
    });
  }

  // ğŸ†• ë¯¸ë‹ˆ ì°¨íŠ¸: Dual-Axis ì§€ì› (ì—°ì²´ìœ¨ + NCO)
  function renderRisksMiniChart(canvasId, delinqData, ncoData, labels, borderColor, annotations, yMax, chartVarName) {
    // ê¸°ì¡´ ì°¨íŠ¸ ì •ë¦¬
    if (chartVarName === 'risksMiniCCChart') risksMiniCCChart = safeDestroyChart(risksMiniCCChart);
    else if (chartVarName === 'risksMiniConsumerChart') risksMiniConsumerChart = safeDestroyChart(risksMiniConsumerChart);
    else if (chartVarName === 'risksMiniBusinessChart') risksMiniBusinessChart = safeDestroyChart(risksMiniBusinessChart);
    else if (chartVarName === 'risksMiniCREChart') risksMiniCREChart = safeDestroyChart(risksMiniCREChart);

    const ctx = document.getElementById(canvasId).getContext('2d');

    // NCO ìƒ‰ìƒ: ì—°ì²´ìœ¨ ìƒ‰ìƒë³´ë‹¤ ì–´ë‘¡ê²Œ
    const ncoColorMap = {
      '#ef4444': '#b91c1c',  // Red â†’ Dark Red
      '#f59e0b': '#b45309',  // Amber â†’ Dark Amber
      '#10b981': '#047857',  // Emerald â†’ Dark Emerald
      '#8b5cf6': '#6d28d9'   // Violet â†’ Dark Violet
    };
    const ncoColor = ncoColorMap[borderColor] || '#666666';

    // Datasets êµ¬ì„±
    const datasets = [
      // ì—°ì²´ìœ¨ (Primary)
      {
        label: 'ì—°ì²´ìœ¨',
        data: delinqData,
        borderColor,
        backgroundColor: borderColor + '15',
        borderWidth: 2,
        tension: 0.3,
        pointRadius: 0,
        spanGaps: true,
        yAxisID: 'yDelinq',
        order: 2
      }
    ];

    // ğŸ†• NCO í† ê¸€ ONì¼ ë•Œë§Œ ì¶”ê°€
    if (showNcoOverlay && ncoData) {
      datasets.push({
        label: 'ìƒê°ìœ¨',
        data: ncoData,
        borderColor: ncoColor,
        backgroundColor: 'transparent',
        borderWidth: 1.5,
        borderDash: [3, 3],
        tension: 0.3,
        pointRadius: 0,
        fill: false,
        spanGaps: true,
        yAxisID: 'yNCO',
        order: 1
      });
    }

    // Scales êµ¬ì„± (NCO ì‹¤ì œ ë°ì´í„° ê¸°ì¤€ - ìƒê°ìœ¨ì´ ì—°ì²´ìœ¨ë³´ë‹¤ ë†’ì„ ìˆ˜ ìˆìŒ)
    const ncoValidValues = ncoData ? ncoData.filter(v => v !== null) : [];
    const ncoActualMax = ncoValidValues.length > 0 ? Math.max(...ncoValidValues) : 0;
    const ncoMax = Math.ceil(Math.max(ncoActualMax, yMax / 2)) + 1;

    const scales = {
      x: { display: false },
      yDelinq: {
        type: 'linear',
        position: 'left',
        min: 0,
        max: yMax,
        display: false
      }
    };

    // NCO ìš°ì¸¡ Yì¶• (í† ê¸€ ONì¼ ë•Œë§Œ)
    if (showNcoOverlay) {
      scales.yNCO = {
        type: 'linear',
        position: 'right',
        min: 0,
        max: ncoMax,
        display: false
      };
    }

    const chart = new Chart(ctx, {
      type: 'line',
      data: { labels, datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(15, 23, 42, 0.95)',
            padding: 8,
            cornerRadius: 6,
            callbacks: {
              label: ctx => {
                const label = ctx.dataset.label || '';
                const val = ctx.parsed.y;
                return val !== null ? `${label}: ${val.toFixed(2)}%` : `${label}: N/A`;
              }
            }
          },
          annotation: { annotations }
        },
        scales
      }
    });

    // ë³€ìˆ˜ ì €ì¥
    if (chartVarName === 'risksMiniCCChart') risksMiniCCChart = chart;
    else if (chartVarName === 'risksMiniConsumerChart') risksMiniConsumerChart = chart;
    else if (chartVarName === 'risksMiniBusinessChart') risksMiniBusinessChart = chart;
    else if (chartVarName === 'risksMiniCREChart') risksMiniCREChart = chart;
  }

  function updateRisksValues(totalValues, ccValues, csValues, bsValues, creValues) {
    const latestTotal = totalValues.filter(v => v !== null).pop();
    const latestCC = ccValues.filter(v => v !== null).pop();
    const latestCs = csValues.filter(v => v !== null).pop();
    const latestBs = bsValues.filter(v => v !== null).pop();
    const latestCRE = creValues ? creValues.filter(v => v !== null).pop() : null;

    // ë©”ì¸ ë°°ì§€ (ì—°ì²´ìœ¨ë§Œ í‘œì‹œ)
    const badge = document.getElementById('risksMainBadge');
    if (latestTotal !== undefined) {
      const status = getDelinquencyStatus(latestTotal);
      const statusLabels = { normal: 'ì •ìƒ', caution: 'ì£¼ì˜', warning: 'ê²½ê³„', danger: 'ìœ„í—˜' };
      const statusColors = { normal: '#16a34a', caution: '#ca8a04', warning: '#ea580c', danger: '#dc2626' };
      const statusBg = { normal: '#f0fdf4', caution: '#fefce8', warning: '#fff7ed', danger: '#fef2f2' };
      badge.textContent = latestTotal.toFixed(2) + '% ' + statusLabels[status];
      badge.style.color = statusColors[status];
      badge.style.background = statusBg[status];
    }

    // ë¯¸ë‹ˆ ê°’
    document.getElementById('risksMiniCCValue').textContent = latestCC !== undefined ? latestCC.toFixed(2) + '%' : '--';
    document.getElementById('risksMiniConsumerValue').textContent = latestCs !== undefined ? latestCs.toFixed(2) + '%' : '--';
    document.getElementById('risksMiniBusinessValue').textContent = latestBs !== undefined ? latestBs.toFixed(2) + '%' : '--';
    document.getElementById('risksMiniCREValue').textContent = latestCRE !== undefined ? latestCRE.toFixed(2) + '%' : '--';
  }

  // ì ‘ì´ì‹ ì„¹í„° ë¶„ì„ í† ê¸€
  window.toggleSectorAnalysis = function() {
    document.getElementById('sectorAnalysisCard').classList.toggle('expanded');
  };

  // ğŸ†• NCO ì˜¤ë²„ë ˆì´ í† ê¸€
  window.toggleNcoOverlay = function() {
    showNcoOverlay = !showNcoOverlay;
    const btn = document.getElementById('ncoToggleBtn');
    btn.classList.toggle('active', showNcoOverlay);
    btn.innerHTML = showNcoOverlay
      ? '<i class="fas fa-chart-line"></i> ìƒê°ìœ¨ ìˆ¨ê¹€'
      : '<i class="fas fa-chart-line"></i> ìƒê°ìœ¨ í‘œì‹œ';
    renderRisksChart(); // ì°¨íŠ¸ ì¬ë Œë”ë§
  };

  // ===== íƒ­ ì „í™˜ =====
  let risksPeriod = 99999; // Risks íƒ­ ê¸°ë³¸ê°’: MAX

  window.switchTab = function(tab, btn) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.getElementById('tab-' + tab).classList.add('active');

    currentTab = tab;

    // ì°¨íŠ¸ íƒ€ì´í‹€ ì—…ë°ì´íŠ¸
    const titles = {
      capital: '<i class="fas fa-shield-halved"></i> ìê¸°ìë³¸ë¹„ìœ¨ (Tier 1)',
      credit: '<i class="fas fa-chart-line"></i> ì˜ˆëŒ€ìœ¨ & ì—¬ì‹ ì¦ê°€ìœ¨',
      risks: '<i class="fas fa-exclamation-triangle"></i> ì—°ì²´ìœ¨ ë¶„ì„'
    };
    document.getElementById('chartTitle').innerHTML = titles[tab];

    // ê¸°ê°„ ì„ íƒê¸° ì „í™˜ (Risks vs Default)
    const defaultSelector = document.getElementById('periodSelectorDefault');
    const risksSelector = document.getElementById('periodSelectorRisks');
    if (tab === 'risks') {
      defaultSelector.style.display = 'none';
      risksSelector.style.display = 'flex';
    } else {
      defaultSelector.style.display = 'flex';
      risksSelector.style.display = 'none';
    }

    // ìŠ¤ì™€ì´í”„ ì¸ë””ì¼€ì´í„° ì—…ë°ì´íŠ¸
    const tabIndex = { capital: 1, credit: 2, risks: 3 };
    document.querySelectorAll('.swipe-dot').forEach((dot, i) => {
      dot.classList.toggle('active', i + 1 === tabIndex[tab]);
    });
  };

  // ===== ê¸°ê°„ ë³€ê²½ (íƒ­ë³„ ë¶„ë¦¬) =====
  window.updatePeriod = function(days, btn, selectorType) {
    // í•´ë‹¹ ì„ íƒê¸° ë‚´ ë²„íŠ¼ë§Œ active í† ê¸€
    const selector = selectorType === 'risks' ? 'periodSelectorRisks' : 'periodSelectorDefault';
    document.querySelectorAll('#' + selector + ' .p-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    if (selectorType === 'risks') {
      // Risks íƒ­ë§Œ ì—…ë°ì´íŠ¸
      risksPeriod = days;
      renderRisksChart();
    } else {
      // Capital/Credit íƒ­ ì—…ë°ì´íŠ¸
      currentPeriod = days;
      const processed = processData();
      renderCapitalChart(processed);
      renderCreditChart(processed);
    }
  };

  // ===== ì´ˆê¸°í™” =====
  async function init() {
    console.log('[Init] Banking Health loading...');

    try {
      // 15ê°œ FRED ì‹œë¦¬ì¦ˆ + FDIC Tier1 ë³‘ë ¬ ë¡œë“œ (NCO 5ê°œ ì¶”ê°€)
      // Capital Resilience: Defense(FDIC Tier1, FED Tier1) vs Offense(10Y, HY Spread)
      const [delinquency, loans, deposits, creditCard, consumer, business, cre, fedTier1, yield10y, hySpread, tier1,
             // ğŸ†• Shadow of Death - NCO (ìƒê°ìœ¨) ì‹œë¦¬ì¦ˆ
             ncoTotal, ncoCreditCard, ncoConsumer, ncoBusiness, ncoCRE] = await Promise.all([
        getSeries('DRALACBN', 9999),           // ì—°ì²´ìœ¨ (ë¶„ê¸°)
        getSeries('TOTLL', 9999),               // ì „ì²´ ëŒ€ì¶œ (ì£¼ê°„)
        getSeries('DPSACBW027SBOG', 9999),      // ì˜ˆê¸ˆ (ì£¼ê°„)
        // Risks íƒ­ìš© ì„¸ë¶„í™” ì—°ì²´ìœ¨
        getSeries('DRCCLACBS', 9999),           // ì‹ ìš©ì¹´ë“œ ì—°ì²´ìœ¨ (ë¶„ê¸°)
        getSeries('DRCLACBS', 9999),            // ì†Œë¹„ì ëŒ€ì¶œ ì—°ì²´ìœ¨ (ë¶„ê¸°)
        getSeries('DRBLACBS', 9999),            // ê¸°ì—… ëŒ€ì¶œ ì—°ì²´ìœ¨ (ë¶„ê¸°)
        getSeries('DRCRELEXFACBS', 9999),       // CRE ì—°ì²´ìœ¨ (ë¶„ê¸°) - ë‹¤ìŒ ìœ„ê¸° í›„ë³´
        // Capital Resilience ì°¨íŠ¸ìš© (Defense 2, Offense 1, 2)
        getSeries('BOGZ1FL010000016Q', 9999),   // FED Tier 1 (ë¶„ê¸°) - Defense 2
        getSeries('DGS10', 9999),               // 10Y Treasury Yield (ì¼ê°„) - Offense 1
        getSeries('BAMLH0A0HYM2', 9999),        // HY Spread (ì¼ê°„) - Offense 2
        // FDIC Tier1 (2009~í˜„ì¬, 24ì‹œê°„ ìºì‹œ) - Defense 1
        getFDICTier1(),
        // ğŸ†• NCO (ìƒê°ìœ¨) ì‹œë¦¬ì¦ˆ - Shadow of Death
        getSeries('CORALACBN', 9999),          // Total NCO (ë¶„ê¸°)
        getSeries('CORCCACBS', 9999),          // Credit Card NCO (ë¶„ê¸°)
        getSeries('CORCACBS', 9999),           // Consumer NCO (ë¶„ê¸°)
        getSeries('CORBLACBS', 9999),          // Business NCO (ë¶„ê¸°)
        getSeries('CORCREXFACBS', 9999)        // CRE NCO (ë¶„ê¸°)
      ]);

      fullData.delinquency = delinquency;
      fullData.tier1 = tier1;
      fullData.fedTier1 = fedTier1;
      fullData.yield10y = yield10y;
      fullData.hySpread = hySpread;
      fullData.loans = loans;
      fullData.deposits = deposits;
      fullData.creditCardDelinq = creditCard;
      fullData.consumerDelinq = consumer;
      fullData.businessDelinq = business;
      fullData.creDelinq = cre;
      // ğŸ†• NCO ë°ì´í„° í• ë‹¹
      fullData.ncoTotal = ncoTotal;
      fullData.ncoCreditCard = ncoCreditCard;
      fullData.ncoConsumer = ncoConsumer;
      fullData.ncoBusiness = ncoBusiness;
      fullData.ncoCRE = ncoCRE;

      // ë°ì´í„° ê²€ì¦
      validateData(fullData);

      console.log('[Init] Data loaded:', {
        delinquency: delinquency.length,
        tier1: tier1.length,
        fedTier1: fedTier1.length,
        yield10y: yield10y.length,
        hySpread: hySpread.length,
        loans: loans.length,
        deposits: deposits.length,
        creditCard: creditCard.length,
        consumer: consumer.length,
        business: business.length,
        cre: cre.length,
        // ğŸ†• NCO ë°ì´í„°
        ncoTotal: ncoTotal.length,
        ncoCreditCard: ncoCreditCard.length,
        ncoConsumer: ncoConsumer.length,
        ncoBusiness: ncoBusiness.length,
        ncoCRE: ncoCRE.length
      });

      // ì „ì²´ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨ ì²´í¬
      if (apiErrorCount >= 4) {
        document.querySelector('.loading-text').innerHTML =
          '<span style="color:#dc2626; font-weight:600;">âŒ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨</span><br>' +
          '<span style="font-size:12px;">ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ê³  ìƒˆë¡œê³ ì¹¨í•´ ì£¼ì„¸ìš”.</span>';
        return;
      }

      // ë¶€ë¶„ ì‹¤íŒ¨ ê²½ê³ 
      if (apiErrorCount > 0) {
        console.warn(`[Init] ${apiErrorCount} API calls failed, showing partial data`);
      }

      const processed = processData();

      updateUI(processed);
      renderCapitalChart(processed);
      renderCreditChart(processed);
      renderRisksChart(); // Risks íƒ­ ì°¨íŠ¸

    } catch (err) {
      console.error('[Init] Error:', err);
    } finally {
      // ì—ëŸ¬ ë°œìƒí•´ë„ ë¡œë”© ìˆ¨ê¹€
      document.getElementById('loadingOverlay').classList.add('hidden');
    }
  }

  // ES Module ëŒ€ê¸° (íƒ€ì„ì•„ì›ƒ í¬í•¨)
  const MODULE_TIMEOUT = 10000; // 10ì´ˆ ëª¨ë“ˆ ë¡œë”© íƒ€ì„ì•„ì›ƒ
  let moduleWaitStart = Date.now();

  function startApp() {
    if (typeof getRecessionAnnotations === 'function') {
      console.log('[Init] Modules loaded âœ“');
      init();
    } else if (Date.now() - moduleWaitStart > MODULE_TIMEOUT) {
      // ëª¨ë“ˆ ë¡œë”© íƒ€ì„ì•„ì›ƒ - ê¸°ë³¸ ê¸°ëŠ¥ìœ¼ë¡œ ì§„í–‰
      console.warn('[Init] Module load timeout, proceeding without annotations');
      window.getRecessionAnnotations = () => ({}); // ë¹ˆ í•¨ìˆ˜ë¡œ ëŒ€ì²´
      init();
    } else {
      console.log('[Init] Waiting for ES modules...');
      setTimeout(startApp, 50);
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', startApp);
  } else {
    startApp();
  }
</script>
</body>
</html>
