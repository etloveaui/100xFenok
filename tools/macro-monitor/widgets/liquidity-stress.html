<!-- 100x Market Radar Widget - Liquidity Stress v2 (Dual Precision Arc) -->
<!-- ì»¨ì…‰: ì‹ ì „(Banking Health) ì˜†ì˜ ì •ë°€ ì„¼ì„œ -->
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">

<!-- Constants & DataManager ES Module import -->
<script type="module">
  import { DataManager, MacroDataManager } from '../shared/data-manager.js';
  import { ICONS, COLORS, LABELS } from '../shared/constants.js';
  window.DataManager = DataManager;
  window.MacroDataManager = MacroDataManager;
  window.ICONS = ICONS;
  window.COLORS = COLORS;
  window.LABELS = LABELS;
</script>

<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  html, body { height: 100%; background: transparent; }

  /* === ì¹´ë“œ ê¸°ë³¸ === */
  .card-widget {
    height: 100%;
    min-height: 280px;
    background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
    border-radius: 16px;
    padding: 16px;
    font-family: 'Inter', -apple-system, sans-serif;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    border: 1px solid #e2e8f0;
    box-shadow: inset 0 1px 2px rgba(255,255,255,0.8), 0 4px 12px rgba(0,0,0,0.06);
  }

  .card-widget:hover {
    transform: translateY(-4px);
    box-shadow: inset 0 1px 2px rgba(255,255,255,0.8), 0 12px 28px rgba(0,0,0,0.1);
  }

  /* === Header === */
  .card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 8px;
  }

  .card-title {
    font-family: 'Orbitron', monospace;
    font-size: 11px;
    font-weight: 700;
    color: #475569;
    display: flex;
    align-items: center;
    gap: 5px;
    letter-spacing: 0.5px;
    text-transform: uppercase;
  }

  .title-icon { font-size: 12px; }

  /* ì¢…í•© ìƒíƒœ ë°°ì§€ */
  .overall-badge {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    border: 1px solid;
  }

  .badge-normal { background: #dcfce7; color: #166534; border-color: #86efac; }
  .badge-caution { background: #fef9c3; color: #a16207; border-color: #fde047; }
  .badge-warning { background: #fed7aa; color: #9a3412; border-color: #fdba74; }
  .badge-danger { background: #fecaca; color: #991b1b; border-color: #fca5a5; }

  /* === ë“€ì–¼ ì•„í¬ ì»¨í…Œì´ë„ˆ === */
  .dual-arc-container {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 4px 0;
  }

  /* ì¤‘ì•™ êµ¬ë¶„ì„  */
  .arc-divider {
    width: 1px;
    height: 80%;
    background: linear-gradient(180deg, transparent 0%, #cbd5e1 20%, #cbd5e1 80%, transparent 100%);
  }

  /* === ê°œë³„ ê²Œì´ì§€ === */
  .gauge-wrapper {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    max-width: 170px;
  }

  .gauge {
    position: relative;
    width: 150px;
    height: 150px;
  }

  /* 270Â° ì•„í¬ (conic-gradient) */
  .gauge-track {
    position: absolute;
    inset: 0;
    border-radius: 50%;
    background: conic-gradient(
      from 135deg,
      #e2e8f0 0deg,
      #e2e8f0 270deg,
      transparent 270deg
    );
    mask: radial-gradient(transparent 55%, black 56%);
    -webkit-mask: radial-gradient(transparent 55%, black 56%);
  }

  .gauge-fill {
    position: absolute;
    inset: 0;
    border-radius: 50%;
    mask: radial-gradient(transparent 55%, black 56%);
    -webkit-mask: radial-gradient(transparent 55%, black 56%);
    transition: all 0.6s ease-out;
    /* ê¸°ë³¸: 0% */
    background: conic-gradient(
      from 135deg,
      var(--gauge-color, #22c55e) 0deg,
      var(--gauge-color, #22c55e) calc(var(--gauge-percent, 0) * 2.7deg),
      transparent calc(var(--gauge-percent, 0) * 2.7deg)
    );
  }

  /* Glow íš¨ê³¼ */
  .gauge-fill::after {
    content: '';
    position: absolute;
    inset: -4px;
    border-radius: 50%;
    background: conic-gradient(
      from 135deg,
      transparent 0deg,
      var(--gauge-color, #22c55e) calc(var(--gauge-percent, 0) * 2.7deg - 10deg),
      transparent calc(var(--gauge-percent, 0) * 2.7deg)
    );
    filter: blur(8px);
    opacity: 0.4;
    mask: radial-gradient(transparent 50%, black 60%);
    -webkit-mask: radial-gradient(transparent 50%, black 60%);
    transition: opacity 0.3s ease;
  }

  .gauge-wrapper:hover .gauge-fill::after {
    opacity: 0.7;
  }

  /* ì„ê³„ê°’ ë§ˆì»¤ (Tick Mark) */
  .gauge-threshold {
    position: absolute;
    inset: 0;
    border-radius: 50%;
    pointer-events: none;
  }

  .threshold-tick {
    position: absolute;
    width: 2px;
    height: 10px;
    background: #94a3b8;
    border-radius: 1px;
    top: 6px;
    left: 50%;
    transform-origin: center 69px;
  }

  /* ì¤‘ì•™ ì •ë³´ */
  .gauge-center {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding-top: 8px;
  }

  .gauge-value {
    font-family: 'Orbitron', monospace;
    font-size: 26px;
    font-weight: 700;
    color: #1e293b;
    line-height: 1;
  }

  .gauge-unit {
    font-size: 12px;
    color: #64748b;
    font-weight: 500;
    margin-top: 3px;
  }

  .gauge-label {
    font-size: 10px;
    color: #94a3b8;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-top: 5px;
  }

  /* ìƒíƒœ í…ìŠ¤íŠ¸ (hover ì‹œ í‘œì‹œ) */
  .gauge-status {
    font-size: 9px;
    font-weight: 600;
    margin-top: 8px;
    padding: 3px 8px;
    border-radius: 8px;
    opacity: 0;
    transform: translateY(-4px);
    transition: all 0.3s ease;
  }

  .gauge-wrapper:hover .gauge-status {
    opacity: 1;
    transform: translateY(0);
  }

  .status-normal { background: #dcfce7; color: #166534; }
  .status-caution { background: #fef9c3; color: #a16207; }
  .status-warning { background: #fed7aa; color: #9a3412; }
  .status-danger { background: #fecaca; color: #991b1b; }

  /* === Loading === */
  .loading {
    position: absolute;
    inset: 0;
    background: rgba(248, 250, 252, 0.95);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border-radius: 16px;
    z-index: 10;
  }

  .spinner {
    width: 32px;
    height: 32px;
    border: 3px solid #e2e8f0;
    border-top-color: #3b82f6;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  .loading-text {
    margin-top: 12px;
    font-size: 11px;
    color: #64748b;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  /* === ìºì‹œ ì—†ìŒ ìƒíƒœ === */
  .no-cache {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: #64748b;
  }

  .no-cache-icon { font-size: 36px; margin-bottom: 8px; }
  .no-cache-text { font-size: 12px; text-align: center; font-weight: 500; }
  .no-cache-hint { font-size: 10px; margin-top: 4px; color: #94a3b8; }

  /* === Stale Data ê²½ê³  ë°°ë„ˆ === */
  .stale-warning {
    background: linear-gradient(90deg, #fef3c7 0%, #fde68a 100%);
    border: 1px solid #f59e0b;
    border-radius: 8px;
    padding: 5px 8px;
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 9px;
    color: #92400e;
  }

  .stale-warning-icon { font-size: 11px; }
  .stale-warning-text { font-weight: 500; }
  .stale-warning-age { color: #b45309; font-weight: 600; }

  /* === Responsive - ëª¨ë°”ì¼ (ì„¸ë¡œ ìŠ¤íƒ) === */
  @media (max-width: 400px) {
    .card-widget { padding: 10px; min-height: 350px; }
    .card-title { font-size: 10px; }

    .dual-arc-container {
      flex-direction: row;  /* ê²Œì´ì§€ 2ê°œ ê°€ë¡œ ë°°ì¹˜ */
      gap: 8px;
      justify-content: center;
    }

    .arc-divider {
      display: none;  /* ê°€ë¡œ ë°°ì¹˜ ì‹œ êµ¬ë¶„ì„  ìˆ¨ê¹€ */
    }

    .gauge-wrapper {
      max-width: none;
      flex-direction: column;  /* ê²Œì´ì§€+ë ˆì´ë¸” ì„¸ë¡œ */
      gap: 4px;
    }

    .gauge {
      width: 100px;
      height: 100px;
    }

    .gauge-value { font-size: 18px; }
    .gauge-unit { font-size: 10px; }
    .gauge-status { margin-top: 2px; font-size: 8px; }

    .threshold-tick {
      transform-origin: center 45px;
    }
  }

  /* === Responsive - íƒœë¸”ë¦¿ === */
  @media (min-width: 401px) and (max-width: 500px) {
    .gauge {
      width: 130px;
      height: 130px;
    }
    .gauge-value { font-size: 24px; }

    .threshold-tick {
      transform-origin: center 59px;
    }
  }
</style>
</head>
<body>

<div class="card-widget" onclick="openDetail()" style="position: relative;">
  <div class="loading" id="loader">
    <div class="spinner"></div>
    <div class="loading-text">ë°ì´í„° ë¡œë”© ì¤‘...</div>
  </div>

  <!-- Header -->
  <div class="card-header">
    <div class="card-title"><span class="title-icon">âš¡</span> LIQUIDITY STRESS</div>
    <div class="overall-badge badge-normal" id="overallBadge">
      <span id="overallLabel">NORMAL</span>
    </div>
  </div>

  <!-- Stale Data ê²½ê³  ë°°ë„ˆ -->
  <div class="stale-warning" id="staleWarning" style="display: none;">
    <span class="stale-warning-icon">âš ï¸</span>
    <span class="stale-warning-text">ì˜¤ë˜ëœ ë°ì´í„°</span>
    <span class="stale-warning-age" id="staleAge">6ì‹œê°„ ì „</span>
  </div>

  <!-- ë©”ì¸ ì»¨í…ì¸ : Dual Precision Arc -->
  <div id="mainContent" class="dual-arc-container" style="display: none;">
    <!-- ì¢Œì¸¡: Spread (Tier 1) -->
    <div class="gauge-wrapper" id="spreadGauge">
      <div class="gauge">
        <div class="gauge-track"></div>
        <div class="gauge-fill" id="spreadFill" style="--gauge-percent: 0; --gauge-color: #22c55e;"></div>
        <div class="gauge-threshold">
          <!-- 20bp ì„ê³„ê°’ ë§ˆì»¤ (270Â° ì¤‘ ì•½ 74Â° ìœ„ì¹˜ = 20/73*100 â‰ˆ 27%) -->
          <div class="threshold-tick" id="spreadThreshold" style="transform: rotate(calc(135deg + 73deg));"></div>
        </div>
        <div class="gauge-center">
          <span class="gauge-value" id="spreadValue">--</span>
          <span class="gauge-unit">bp</span>
          <span class="gauge-label">Spread</span>
        </div>
      </div>
      <div class="gauge-status status-normal" id="spreadStatus">ì •ìƒ</div>
    </div>

    <!-- êµ¬ë¶„ì„  -->
    <div class="arc-divider"></div>

    <!-- ìš°ì¸¡: RB/GDP (Tier 2) -->
    <div class="gauge-wrapper" id="rbgdpGauge">
      <div class="gauge">
        <div class="gauge-track"></div>
        <div class="gauge-fill" id="rbgdpFill" style="--gauge-percent: 0; --gauge-color: #22c55e;"></div>
        <div class="gauge-threshold">
          <!-- 8% ì„ê³„ê°’ ë§ˆì»¤ -->
          <div class="threshold-tick" id="rbgdpThreshold" style="transform: rotate(calc(135deg + 135deg));"></div>
        </div>
        <div class="gauge-center">
          <span class="gauge-value" id="rbgdpValue">--</span>
          <span class="gauge-unit">%</span>
          <span class="gauge-label">RB/GDP</span>
        </div>
      </div>
      <div class="gauge-status status-normal" id="rbgdpStatus">ì •ìƒ</div>
    </div>
  </div>


  <!-- ìºì‹œ ì—†ìŒ ìƒíƒœ -->
  <div class="no-cache" id="noCache" style="display: none;">
    <div class="no-cache-icon">ğŸ“Š</div>
    <div class="no-cache-text">ë°ì´í„° ì—†ìŒ</div>
    <div class="no-cache-hint">í´ë¦­í•˜ì—¬ ìƒì„¸ í˜ì´ì§€ì—ì„œ ë¡œë“œ</div>
  </div>
</div>

<script>
  const WIDGET_ID = 'liquidity-stress';
  const DETAIL_PATH = 'tools/macro-monitor/details/liquidity-stress.html';

  // ìƒíƒœë³„ ìƒ‰ìƒ
  const STATUS_COLORS = {
    normal: '#22c55e',
    caution: '#eab308',
    warning: '#f97316',
    danger: '#ef4444',
    high_stress: '#f97316',
    critical: '#ef4444'
  };

  // ìƒíƒœë³„ ë°°ì§€ í´ë˜ìŠ¤
  const BADGE_CLASSES = {
    normal: 'badge-normal',
    caution: 'badge-caution',
    warning: 'badge-warning',
    danger: 'badge-danger',
    high_stress: 'badge-warning',
    critical: 'badge-danger'
  };

  // ìƒíƒœë³„ ë¼ë²¨
  const STATUS_LABELS = {
    normal: 'NORMAL',
    caution: 'CAUTION',
    warning: 'WARNING',
    danger: 'DANGER',
    high_stress: 'HIGH STRESS',
    critical: 'CRITICAL'
  };

  const STATUS_LABELS_KR = {
    normal: 'ì •ìƒ',
    caution: 'ì£¼ì˜',
    warning: 'ê²½ê³ ',
    danger: 'ìœ„í—˜',
    high_stress: 'ê³ ìŠ¤íŠ¸ë ˆìŠ¤',
    critical: 'ì‹¬ê°'
  };

  // postMessage ìˆ˜ì‹  ë¦¬ìŠ¤ë„ˆ
  window.addEventListener('message', (event) => {
    if (event.data && event.data.type === 'WIDGET_DATA_UPDATE') {
      console.log('[Widget] ë¶€ëª¨ë¡œë¶€í„° ë°ì´í„° ìˆ˜ì‹ ');
      renderWidget(event.data.payload);

      const loader = document.getElementById('loader');
      if (loader) loader.style.display = 'none';

      const staleWarning = document.getElementById('staleWarning');
      if (staleWarning) staleWarning.style.display = 'none';
    }
  });

  /**
   * Spread â†’ ìŠ¤íŠ¸ë ˆìŠ¤ í¼ì„¼íŠ¸ (ë†’ì„ìˆ˜ë¡ ìœ„í—˜)
   * ë²”ìœ„: -10bp ~ 60bp+ â†’ 0% ~ 100%
   */
  function spreadToPercent(value) {
    const min = -10;  // ì•ˆì „ ìµœì €
    const max = 60;   // ìœ„í—˜ ìµœê³ 
    const percent = ((value - min) / (max - min)) * 100;
    return Math.max(0, Math.min(100, percent));
  }

  /**
   * RB/GDP â†’ ìŠ¤íŠ¸ë ˆìŠ¤ í¼ì„¼íŠ¸ (ë‚®ì„ìˆ˜ë¡ ìœ„í—˜, ì—­ë°©í–¥)
   * ë²”ìœ„: 15% ~ 5% â†’ 0% ~ 100% (ì—­ë°©í–¥)
   */
  function rbgdpToPercent(value) {
    const safe = 15;   // ì•ˆì „ ìµœê³ 
    const danger = 5;  // ìœ„í—˜ ìµœì €
    const percent = ((safe - value) / (safe - danger)) * 100;
    return Math.max(0, Math.min(100, percent));
  }

  function renderWidget(data) {
    const mainContent = document.getElementById('mainContent');
    const noCache = document.getElementById('noCache');

    if (!data) {
      mainContent.style.display = 'none';
      noCache.style.display = 'flex';
      return;
    }

    mainContent.style.display = 'flex';
    noCache.style.display = 'none';

    // Overall Badge
    const badge = document.getElementById('overallBadge');
    const overallStatus = data.overallStatus || 'normal';
    badge.className = 'overall-badge ' + (BADGE_CLASSES[overallStatus] || 'badge-normal');
    document.getElementById('overallLabel').textContent = STATUS_LABELS[overallStatus] || 'NORMAL';

    // Tier 1: Spread
    if (data.tier1) {
      const spreadValue = data.tier1.value;
      const spreadStatus = data.tier1.status || 'normal';
      const spreadPercent = spreadToPercent(spreadValue);
      const spreadColor = STATUS_COLORS[spreadStatus] || STATUS_COLORS.normal;

      document.getElementById('spreadValue').textContent = (spreadValue >= 0 ? '+' : '') + spreadValue;
      document.getElementById('spreadFill').style.setProperty('--gauge-percent', spreadPercent);
      document.getElementById('spreadFill').style.setProperty('--gauge-color', spreadColor);

      const spreadStatusEl = document.getElementById('spreadStatus');
      spreadStatusEl.textContent = STATUS_LABELS_KR[spreadStatus] || 'ì •ìƒ';
      spreadStatusEl.className = 'gauge-status status-' + spreadStatus;
    }

    // Tier 2: RB/GDP
    if (data.tier2) {
      const rbgdpValue = data.tier2.value;
      const rbgdpStatus = data.tier2.status || 'normal';
      const rbgdpPercent = rbgdpToPercent(rbgdpValue);
      const rbgdpColor = STATUS_COLORS[rbgdpStatus] || STATUS_COLORS.normal;

      document.getElementById('rbgdpValue').textContent = rbgdpValue.toFixed(1);
      document.getElementById('rbgdpFill').style.setProperty('--gauge-percent', rbgdpPercent);
      document.getElementById('rbgdpFill').style.setProperty('--gauge-color', rbgdpColor);

      const rbgdpStatusEl = document.getElementById('rbgdpStatus');
      rbgdpStatusEl.textContent = STATUS_LABELS_KR[rbgdpStatus] || 'ì •ìƒ';
      rbgdpStatusEl.className = 'gauge-status status-' + rbgdpStatus;
    }

    // ë Œë”ë§ ì™„ë£Œ ì‹ í˜¸ (Carouselìš©)
    try {
      window.parent.postMessage({ type: 'WIDGET_READY', widgetId: 'liquidity-stress' }, '*');
    } catch (e) {}
  }

  async function init() {
    const loader = document.getElementById('loader');
    const staleWarning = document.getElementById('staleWarning');

    try {
      // ìºì‹œì—ì„œ ë°ì´í„° ì½ê¸° ì‹œë„
      let cacheResult = { data: null, isStale: true, ageMs: 0 };
      try {
        if (typeof DataManager !== 'undefined' && DataManager.getWidgetDataWithStale) {
          cacheResult = DataManager.getWidgetDataWithStale(WIDGET_ID);
        } else if (typeof DataManager !== 'undefined') {
          cacheResult.data = DataManager.getWidgetData(WIDGET_ID);
          cacheResult.isStale = false;
        }
      } catch (storageError) {
        console.warn('[Widget] ì§ì ‘ ìŠ¤í† ë¦¬ì§€ ì ‘ê·¼ ë¶ˆê°€ (postMessage ëŒ€ê¸° ì¤‘)');
      }

      if (cacheResult.data) {
        renderWidget(cacheResult.data);

        // Stale ê²½ê³  í‘œì‹œ (6ì‹œê°„ ì´ˆê³¼)
        if (cacheResult.isStale && cacheResult.ageMs > 0) {
          const ageText = typeof MacroDataManager !== 'undefined'
            ? MacroDataManager.formatAge(cacheResult.ageMs)
            : formatAgeSimple(cacheResult.ageMs);
          document.getElementById('staleAge').textContent = ageText;
          staleWarning.style.display = 'flex';
        } else {
          staleWarning.style.display = 'none';
        }
        loader.style.display = 'none';
      } else {
        // ë°ì´í„° ì—†ìŒ - postMessage ëŒ€ê¸° (3ì´ˆ í›„ì—ë„ ì—†ìœ¼ë©´ 'ë°ì´í„° ì—†ìŒ' í‘œì‹œ)
        setTimeout(() => {
          const noCache = document.getElementById('noCache');
          if (noCache && noCache.style.display !== 'none') return;
          const mainContent = document.getElementById('mainContent');
          if (mainContent && mainContent.style.display === 'none') {
            renderWidget(null);
            loader.style.display = 'none';
          }
        }, 3000);
      }
    } catch (e) {
      console.error('[Widget] Init error:', e);
      renderWidget(null);
      staleWarning.style.display = 'none';
      loader.style.display = 'none';
    }
  }

  // Fallback age formatter
  function formatAgeSimple(ageMs) {
    const minutes = Math.floor(ageMs / 60000);
    if (minutes < 60) return `${minutes}ë¶„ ì „`;
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `${hours}ì‹œê°„ ì „`;
    return `${Math.floor(hours / 24)}ì¼ ì „`;
  }

  // ìºì‹œ ì—…ë°ì´íŠ¸ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë‹
  window.addEventListener('macro-data-updated', (e) => {
    if (e.detail.widgetId === WIDGET_ID) {
      renderWidget(e.detail.data);
    }
  });

  // ìƒì„¸ í˜ì´ì§€ ì—´ê¸°
  function openDetail() {
    try {
      if (window.top?.loadPage) { window.top.loadPage(DETAIL_PATH); return; }
      if (window.parent?.loadPage) { window.parent.loadPage(DETAIL_PATH); return; }
    } catch(e) {}
    const base = window.top?.baseHref || '/';
    (window.top||window).location.assign(`${base}index.html?path=${DETAIL_PATH}`);
  }

  // ì´ˆê¸°í™”
  init();
</script>
</body>
</html>
