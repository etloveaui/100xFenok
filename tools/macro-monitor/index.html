<!DOCTYPE html>
<html lang="ko">
<head>
  <!-- Google tag (gtag.js) - 호스트별 자동 선택 -->
  <script>
    (function() {
      const GA_IDS = {
        'etloveaui.github.io': 'G-X7MZFQZRBW',
        '100xfenok.pages.dev': 'G-BWHGXQPH2D'
      };
      const id = GA_IDS[location.hostname] || 'G-X7MZFQZRBW';
      const s = document.createElement('script');
      s.async = true;
      s.src = 'https://www.googletagmanager.com/gtag/js?id=' + id;
      document.head.appendChild(s);
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      window.gtag = gtag;
      gtag('js', new Date());
      gtag('config', id);
    })();
  </script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>100x Market Radar | 100xFenok</title>

  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;700;800&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --radar-bg-0: #f6fbff;
      --radar-bg-1: #e5eef9;
      --radar-ink: #0f172a;
      --radar-muted: #5b6b82;
      --radar-card: #ffffff;
      --radar-border: #cfdced;
      --radar-primary: #0f5ccf;
      --radar-primary-soft: #e8f0ff;
      --radar-accent: #0694c9;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Space Grotesk', 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
      color: var(--radar-ink);
      min-height: 100vh;
      background:
        radial-gradient(1200px 420px at 12% -10%, rgba(6, 148, 201, 0.16), transparent 58%),
        radial-gradient(980px 460px at 100% 0%, rgba(15, 92, 207, 0.18), transparent 60%),
        linear-gradient(160deg, var(--radar-bg-0) 0%, var(--radar-bg-1) 100%);
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background:
        linear-gradient(rgba(15, 92, 207, 0.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(15, 92, 207, 0.05) 1px, transparent 1px);
      background-size: 32px 32px;
      opacity: 0.3;
      pointer-events: none;
      z-index: 0;
    }

    .container {
      position: relative;
      z-index: 1;
      max-width: 1480px;
      margin: 0 auto;
      padding: 30px 18px 36px;
    }

    .page-header {
      margin-bottom: 24px;
      border-radius: 24px;
      border: 1px solid rgba(255, 255, 255, 0.75);
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(247, 251, 255, 0.75));
      box-shadow: 0 26px 48px -42px rgba(15, 23, 42, 0.7);
      padding: 22px 20px;
      text-align: center;
      backdrop-filter: blur(8px);
    }

    .page-title {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-family: 'Orbitron', sans-serif;
      font-size: 30px;
      font-weight: 800;
      line-height: 1.05;
      letter-spacing: 0.02em;
      margin-bottom: 8px;
      background: linear-gradient(120deg, #0b4fb2 0%, #0996c8 52%, #1a6fdd 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .title-icon {
      width: 34px;
      height: 34px;
      border-radius: 11px;
      background: linear-gradient(135deg, #0f5ccf, #0894c8);
      color: #ffffff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      -webkit-background-clip: initial !important;
      -webkit-text-fill-color: initial !important;
      box-shadow: 0 14px 26px -18px rgba(15, 92, 207, 0.9);
    }

    .page-subtitle {
      margin: 0 auto;
      max-width: 760px;
      font-size: 13px;
      font-weight: 600;
      color: var(--radar-muted);
      letter-spacing: 0.01em;
    }

    .radar-summary {
      margin-top: 16px;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 8px;
    }

    .summary-pill {
      min-height: 30px;
      padding: 0 12px;
      border-radius: 999px;
      border: 1px solid #d5e2f4;
      background: #ffffff;
      color: #355177;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .summary-pill strong {
      color: var(--radar-primary);
      font-size: 12px;
      font-weight: 800;
    }

    .summary-pill.summary-pill-live {
      border-color: #9be7b0;
      background: #f3fff6;
      color: #166534;
    }

    .summary-pill.summary-pill-stale {
      border-color: #f7dd8b;
      background: #fff9e8;
      color: #92400e;
    }

    .summary-pill.summary-pill-empty {
      border-color: #d4dce8;
      background: #f8fafc;
      color: #64748b;
    }

    .summary-pill.summary-pill-sync {
      border-color: #b9d6f2;
      background: #eff6ff;
      color: #1d4f8f;
    }

    .summary-pill.summary-pill-research.is-live {
      border-color: #9be7b0;
      background: #f3fff6;
      color: #166534;
    }

    .summary-pill.summary-pill-research.is-stale {
      border-color: #f7dd8b;
      background: #fff9e8;
      color: #92400e;
    }

    .summary-pill.summary-pill-research.is-empty {
      border-color: #d4dce8;
      background: #f8fafc;
      color: #64748b;
    }

    .category-tabs {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 16px;
    }

    .radar-toolbar {
      margin-top: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .radar-sync-button {
      border: 1px solid #a9c7eb;
      background: linear-gradient(135deg, #0f5ccf, #0783d1);
      color: #ffffff;
      min-height: 34px;
      padding: 0 14px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
      box-shadow: 0 10px 18px -14px rgba(15, 92, 207, 0.9);
    }

    .radar-sync-button:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 20px -14px rgba(15, 92, 207, 0.92);
    }

    .radar-sync-button:disabled {
      cursor: not-allowed;
      opacity: 0.72;
      transform: none;
      box-shadow: none;
    }

    .tab-btn {
      border: 1px solid #ccdbee;
      background: #ffffff;
      color: #41577a;
      min-height: 38px;
      padding: 0 16px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      cursor: pointer;
      transition: transform 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease, color 0.2s ease;
    }

    .tab-btn:hover {
      border-color: #a8c5eb;
      background: var(--radar-primary-soft);
      color: #15396b;
      transform: translateY(-1px);
      box-shadow: 0 10px 20px -16px rgba(15, 92, 207, 0.75);
    }

    .tab-btn.active {
      border-color: var(--radar-primary);
      background: linear-gradient(135deg, #0f5ccf, #0d82d1);
      color: #ffffff;
      box-shadow: 0 14px 24px -14px rgba(12, 88, 200, 0.95);
    }

    .card-grid {
      display: grid;
      gap: 16px;
      margin-top: 18px;
      grid-template-columns: repeat(12, minmax(0, 1fr));
    }

    .indicator-card {
      position: relative;
      border-radius: 22px;
      border: 1px solid var(--radar-border);
      background: var(--radar-card);
      box-shadow: 0 26px 36px -34px rgba(15, 23, 42, 0.7);
      overflow: hidden;
      transition: transform 0.22s ease, box-shadow 0.22s ease, border-color 0.22s ease;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      min-height: 320px;
      grid-column: span 4;
    }

    .indicator-card:hover {
      transform: translateY(-3px);
      border-color: #a8c6eb;
      box-shadow: 0 32px 40px -32px rgba(15, 23, 42, 0.75);
    }

    .live-widget {
      background: linear-gradient(180deg, #f9fcff 0%, #f0f6ff 100%);
    }

    .widget-meta {
      min-height: 56px;
      padding: 10px 12px 8px;
      border-bottom: 1px solid #d7e5f4;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .widget-kicker {
      border-radius: 999px;
      border: 1px solid #bfd5ef;
      background: #ffffff;
      color: #2f557d;
      padding: 0 9px;
      min-height: 24px;
      display: inline-flex;
      align-items: center;
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.07em;
      text-transform: uppercase;
      white-space: nowrap;
    }

    .widget-title {
      color: #0f284f;
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 0.01em;
      text-align: right;
    }

    .widget-meta-main {
      display: inline-flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 3px;
      min-width: 0;
    }

    .widget-status {
      min-height: 19px;
      border-radius: 999px;
      border: 1px solid #cbd5e1;
      background: #ffffff;
      color: #475569;
      padding: 0 8px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      font-weight: 700;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      white-space: nowrap;
    }

    .widget-status.is-live {
      border-color: #86efac;
      background: #f0fdf4;
      color: #166534;
    }

    .widget-status.is-stale {
      border-color: #fde68a;
      background: #fffbeb;
      color: #92400e;
    }

    .widget-status.is-empty {
      border-color: #cbd5e1;
      background: #f8fafc;
      color: #64748b;
    }

    .live-widget iframe {
      border: 0;
      width: 100%;
      height: calc(100% - 56px);
      min-height: 260px;
      display: block;
      background: #ffffff;
    }

    .research-widget {
      background: linear-gradient(180deg, #ffffff 0%, #f4f8ff 100%);
    }

    .research-body {
      padding: 14px 14px 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 0;
      height: calc(100% - 56px);
    }

    .research-grid {
      display: grid;
      gap: 8px;
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }

    .research-metric {
      border: 1px solid #d5e1f0;
      border-radius: 12px;
      background: #ffffff;
      padding: 8px 9px;
      min-height: 64px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 4px;
    }

    .research-metric span {
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: #597394;
    }

    .research-metric strong {
      font-family: 'Orbitron', sans-serif;
      font-size: 15px;
      line-height: 1.1;
      color: #0f284f;
    }

    .research-note {
      margin-top: auto;
      font-size: 11px;
      line-height: 1.45;
      color: #5a6f8b;
      border-radius: 10px;
      border: 1px solid #d9e5f3;
      background: #f8fbff;
      padding: 8px 9px;
    }

    .coming-soon {
      background: linear-gradient(180deg, #ffffff 0%, #f6fbff 100%);
      padding: 28px 22px;
      text-align: center;
      align-items: center;
      justify-content: center;
      grid-column: span 4;
    }

    .cs-icon {
      width: 66px;
      height: 66px;
      border-radius: 18px;
      background: linear-gradient(145deg, rgba(15, 92, 207, 0.14), rgba(6, 148, 201, 0.14));
      color: var(--radar-primary);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      margin-bottom: 14px;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.9);
    }

    .cs-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 17px;
      font-weight: 700;
      color: #10294f;
      margin-bottom: 7px;
    }

    .cs-category {
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.09em;
      text-transform: uppercase;
      color: #547298;
      margin-bottom: 12px;
    }

    .cs-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      min-height: 30px;
      padding: 0 12px;
      border-radius: 999px;
      border: 1px solid #cde0f5;
      background: #ffffff;
      color: #3e5d85;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.04em;
    }

    .cs-description {
      margin-top: 11px;
      font-size: 12px;
      line-height: 1.45;
      color: #6782a7;
    }

    .category-liquidity .cs-icon {
      color: #0f8f83;
      background: linear-gradient(145deg, rgba(15, 143, 131, 0.13), rgba(20, 184, 166, 0.1));
    }

    .category-rates .cs-icon {
      color: #4f46e5;
      background: linear-gradient(145deg, rgba(79, 70, 229, 0.12), rgba(129, 140, 248, 0.12));
    }

    .category-sentiment .cs-icon {
      color: #d97706;
      background: linear-gradient(145deg, rgba(217, 119, 6, 0.14), rgba(251, 191, 36, 0.12));
    }

    @media (max-width: 1199px) {
      .indicator-card,
      .coming-soon {
        grid-column: span 6;
      }
    }

    @media (max-width: 820px) {
      .container {
        padding: 20px 12px 26px;
      }
      .page-header {
        border-radius: 20px;
        padding: 18px 14px;
      }
      .page-title {
        font-size: 24px;
      }
      .title-icon {
        width: 30px;
        height: 30px;
        border-radius: 10px;
        font-size: 15px;
      }
      .tab-btn {
        min-height: 34px;
        padding: 0 13px;
        font-size: 11px;
      }
      .radar-sync-button {
        min-height: 32px;
        padding: 0 12px;
        font-size: 10px;
      }
      .indicator-card,
      .coming-soon {
        grid-column: span 12;
      }
      .widget-meta {
        min-height: 52px;
        padding: 8px 10px;
      }
      .widget-title {
        font-size: 12px;
      }
      .widget-status {
        min-height: 18px;
        font-size: 8px;
        padding: 0 7px;
      }
      .live-widget iframe {
        min-height: 285px;
      }
      .research-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 400px) {
      .page-title {
        font-size: 21px;
      }
      .summary-pill {
        font-size: 10px;
      }
      .radar-sync-button {
        width: 100%;
        max-width: 260px;
      }
      .live-widget iframe {
        min-height: 310px;
      }
    }

    /* ===== 필터링 애니메이션 ===== */
    .indicator-card.hidden {
      display: none;
    }

    .indicator-card.fade-in {
      animation: fadeIn 0.3s ease-in-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>
<body>

<div class="container">
  <!-- 헤더 -->
  <header class="page-header">
    <h1 class="page-title"><span class="title-icon">R</span> 100x Market Radar</h1>
    <p class="page-subtitle">거시경제 리스크 신호를 위젯 단위로 추적하고, 상세 페이지로 즉시 전환하는 실시간 모니터링 허브</p>
    <div class="radar-summary" aria-label="Radar Summary">
      <span class="summary-pill summary-pill-live"><strong id="summary-live-count">0</strong> Live Widgets</span>
      <span class="summary-pill summary-pill-stale"><strong id="summary-stale-count">0</strong> Stale Signals</span>
      <span class="summary-pill summary-pill-empty"><strong id="summary-empty-count">0</strong> Empty Slots</span>
      <span class="summary-pill summary-pill-sync" id="summary-sync-label">SYNC --:--</span>
      <span class="summary-pill summary-pill-research is-empty" id="summary-research-status">Research --</span>
    </div>

    <!-- 카테고리 탭 -->
    <div class="category-tabs">
      <button class="tab-btn active" data-category="all" onclick="filterCategory('all', this)">All</button>
      <button class="tab-btn" data-category="liquidity" onclick="filterCategory('liquidity', this)">Liquidity</button>
      <button class="tab-btn" data-category="rates" onclick="filterCategory('rates', this)">Rates</button>
      <button class="tab-btn" data-category="sentiment" onclick="filterCategory('sentiment', this)">Sentiment</button>
    </div>
    <div class="radar-toolbar">
      <button class="radar-sync-button" id="radar-sync-button" type="button">Sync Data</button>
    </div>
  </header>

  <!-- 카드 그리드 -->
  <div class="card-grid" id="cardGrid">

    <!-- 1. Liquidity Flow (Layer 2 - 라이브 위젯) -->
    <div class="indicator-card live-widget fade-in" data-category="liquidity" onclick="openDetail('details/liquidity-flow.html')">
      <div class="widget-meta">
        <span class="widget-kicker">Liquidity</span>
        <div class="widget-meta-main">
          <span class="widget-title">Liquidity Flow Monitor</span>
          <span class="widget-status is-empty" id="widget-status-liquidity-flow">Cache Empty</span>
        </div>
      </div>
      <iframe
        src="widgets/liquidity-flow.html"
        scrolling="no"
        loading="lazy"
        title="Liquidity Flow Monitor">
      </iframe>
    </div>

    <!-- 2. Liquidity Stress (라이브 위젯 - Layer 1) -->
    <div class="indicator-card live-widget fade-in" data-category="liquidity" onclick="openDetail('details/liquidity-stress.html')">
      <div class="widget-meta">
        <span class="widget-kicker">Liquidity</span>
        <div class="widget-meta-main">
          <span class="widget-title">Liquidity Stress Monitor</span>
          <span class="widget-status is-empty" id="widget-status-liquidity-stress">Cache Empty</span>
        </div>
      </div>
      <iframe
        src="widgets/liquidity-stress.html"
        scrolling="no"
        loading="lazy"
        title="Liquidity Stress Monitor">
      </iframe>
    </div>

    <!-- 3. Banking Health (4-A) - 라이브 위젯 -->
    <div class="indicator-card live-widget fade-in" data-category="liquidity" onclick="openDetail('details/banking-health.html')">
      <div class="widget-meta">
        <span class="widget-kicker">Funding</span>
        <div class="widget-meta-main">
          <span class="widget-title">Banking Health Monitor</span>
          <span class="widget-status is-empty" id="widget-status-banking-health">Cache Empty</span>
        </div>
      </div>
      <iframe
        src="widgets/banking-health.html"
        scrolling="no"
        loading="lazy"
        title="Banking Health Monitor">
      </iframe>
    </div>

    <!-- 4. Sentiment Signal (4-D) - 라이브 위젯 -->
    <div class="indicator-card live-widget fade-in" data-category="sentiment" onclick="openDetail('details/sentiment-signal/index.html')">
      <div class="widget-meta">
        <span class="widget-kicker">Sentiment</span>
        <div class="widget-meta-main">
          <span class="widget-title">Sentiment Signal Monitor</span>
          <span class="widget-status is-empty" id="widget-status-sentiment-signal">Cache Empty</span>
        </div>
      </div>
      <iframe
        src="widgets/sentiment-signal.html"
        scrolling="no"
        loading="lazy"
        title="Sentiment Signal Monitor">
      </iframe>
    </div>

    <!-- 5. Corporate Health (4-B) - 리서치 슬롯 -->
    <div class="indicator-card research-widget fade-in" data-category="rates" onclick="openDetail('details/corporate-health.html')">
      <div class="widget-meta">
        <span class="widget-kicker">Rates</span>
        <div class="widget-meta-main">
          <span class="widget-title">Corporate Health Console</span>
          <span class="widget-status is-empty" id="widget-status-corporate-health">Loading</span>
        </div>
      </div>
      <div class="research-body">
        <div class="research-grid">
          <p class="research-metric">
            <span>Forward P/E</span>
            <strong id="corp-pe-value">--</strong>
          </p>
          <p class="research-metric">
            <span>P/B Ratio</span>
            <strong id="corp-pb-value">--</strong>
          </p>
          <p class="research-metric">
            <span>ROE</span>
            <strong id="corp-roe-value">--</strong>
          </p>
        </div>
        <p class="research-note" id="corp-note">Loading benchmark snapshot...</p>
      </div>
    </div>

  </div>
</div>

<script>
  const VALID_CATEGORIES = new Set(['all', 'liquidity', 'rates', 'sentiment']);
  const CATEGORY_TAB_ORDER = ['all', 'liquidity', 'rates', 'sentiment'];

  function emitRadarIndexTelemetry(event, payload = {}) {
    try {
      window.dispatchEvent(new CustomEvent('fenok:radar-index', {
        detail: {
          event,
          ...payload,
          at: new Date().toISOString(),
        },
      }));
    } catch (error) {
      console.debug('[Radar] telemetry skipped:', error);
    }
  }

  function updateCategoryQuery(category) {
    const url = new URL(window.location.href);
    if (category === 'all') {
      url.searchParams.delete('category');
    } else {
      url.searchParams.set('category', category);
    }
    window.history.replaceState(null, '', `${url.pathname}${url.search}${url.hash}`);
  }

  function resolveCategoryFromQuery() {
    const requested = new URLSearchParams(window.location.search).get('category');
    if (!requested || !VALID_CATEGORIES.has(requested)) {
      return 'all';
    }
    return requested;
  }

  // ===== 카테고리 필터링 =====
  function filterCategory(category, btn, syncUrl = true) {
    const normalized = VALID_CATEGORIES.has(category) ? category : 'all';

    // 탭 활성화 상태 업데이트
    document.querySelectorAll('.tab-btn').forEach(tab => tab.classList.remove('active'));
    btn.classList.add('active');

    // 카드 필터링
    const cards = document.querySelectorAll('.indicator-card');
    cards.forEach(card => {
      const cardCategory = card.getAttribute('data-category');

      if (normalized === 'all' || cardCategory === normalized) {
        card.classList.remove('hidden');
        card.classList.add('fade-in');
      } else {
        card.classList.add('hidden');
        card.classList.remove('fade-in');
      }
    });

    if (syncUrl) {
      updateCategoryQuery(normalized);
    }

    emitRadarIndexTelemetry('category-change', {
      category: normalized,
      syncUrl,
    });
  }

  function initializeCategoryFilter() {
    const initialCategory = resolveCategoryFromQuery();
    const initialButton = document.querySelector(`.tab-btn[data-category="${initialCategory}"]`);
    if (initialButton instanceof HTMLButtonElement) {
      filterCategory(initialCategory, initialButton, false);
      return;
    }
    const fallbackButton = document.querySelector('.tab-btn[data-category="all"]');
    if (fallbackButton instanceof HTMLButtonElement) {
      filterCategory('all', fallbackButton, false);
    }
  }

  function activateCategoryFromKeyboard(category, shouldFocus = true) {
    if (!VALID_CATEGORIES.has(category)) {
      return;
    }
    const targetButton = document.querySelector(`.tab-btn[data-category="${category}"]`);
    if (!(targetButton instanceof HTMLButtonElement)) {
      return;
    }
    if (shouldFocus) {
      targetButton.focus();
    }
    filterCategory(category, targetButton);
  }

  function handleCategoryTabKeydown(event) {
    const target = event.currentTarget;
    if (!(target instanceof HTMLButtonElement)) {
      return;
    }

    const currentCategory = target.dataset.category ?? 'all';
    const currentIndex = Math.max(0, CATEGORY_TAB_ORDER.indexOf(currentCategory));

    switch (event.key) {
      case 'ArrowRight': {
        event.preventDefault();
        const nextIndex = (currentIndex + 1) % CATEGORY_TAB_ORDER.length;
        activateCategoryFromKeyboard(CATEGORY_TAB_ORDER[nextIndex], true);
        return;
      }
      case 'ArrowLeft': {
        event.preventDefault();
        const prevIndex = (currentIndex - 1 + CATEGORY_TAB_ORDER.length) % CATEGORY_TAB_ORDER.length;
        activateCategoryFromKeyboard(CATEGORY_TAB_ORDER[prevIndex], true);
        return;
      }
      case 'Home': {
        event.preventDefault();
        activateCategoryFromKeyboard(CATEGORY_TAB_ORDER[0], true);
        return;
      }
      case 'End': {
        event.preventDefault();
        activateCategoryFromKeyboard(CATEGORY_TAB_ORDER[CATEGORY_TAB_ORDER.length - 1], true);
        return;
      }
      case 'Enter':
      case ' ': {
        event.preventDefault();
        filterCategory(currentCategory, target);
        return;
      }
      default:
        return;
    }
  }

  window.addEventListener('popstate', () => {
    initializeCategoryFilter();
  });

  async function handleManualRadarSync(button) {
    if (!(button instanceof HTMLButtonElement) || button.disabled) {
      return;
    }

    const refreshWidgets = window.refreshRadarWidgets;
    if (typeof refreshWidgets !== 'function') {
      button.textContent = 'Sync Pending';
      setTimeout(() => {
        button.textContent = 'Sync Data';
      }, 900);
      return;
    }

    button.disabled = true;
    button.textContent = 'Syncing...';
    emitRadarIndexTelemetry('manual-sync-start');

    try {
      await refreshWidgets();
      emitRadarIndexTelemetry('manual-sync-success');
    } catch (error) {
      console.warn('[Index] 수동 동기화 실패:', error);
      emitRadarIndexTelemetry('manual-sync-error', {
        message: error instanceof Error ? error.message : String(error),
      });
    } finally {
      if (typeof window.updateWidgetStatusBadges === 'function') {
        window.updateWidgetStatusBadges();
      }
      button.disabled = false;
      button.textContent = 'Sync Data';
    }
  }

  function setCorporateWidgetStatus(label, tone = 'is-empty') {
    const statusElement = document.getElementById('widget-status-corporate-health');
    if (!(statusElement instanceof HTMLElement)) {
      return;
    }
    statusElement.textContent = label;
    statusElement.classList.remove('is-live', 'is-stale', 'is-empty');
    statusElement.classList.add(tone);

    const summaryElement = document.getElementById('summary-research-status');
    if (summaryElement instanceof HTMLElement) {
      summaryElement.textContent = `Research ${label}`;
      summaryElement.classList.remove('is-live', 'is-stale', 'is-empty');
      summaryElement.classList.add(tone);
    }
  }

  async function hydrateCorporateHealthPreview() {
    const peElement = document.getElementById('corp-pe-value');
    const pbElement = document.getElementById('corp-pb-value');
    const roeElement = document.getElementById('corp-roe-value');
    const noteElement = document.getElementById('corp-note');

    if (!(peElement instanceof HTMLElement) || !(pbElement instanceof HTMLElement) || !(roeElement instanceof HTMLElement) || !(noteElement instanceof HTMLElement)) {
      return;
    }

    try {
      const response = await fetch('/data/benchmarks/us.json', { cache: 'no-store' });
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }

      const payload = await response.json();
      const rows = payload?.sections?.sp500?.data;
      if (!Array.isArray(rows) || rows.length === 0) {
        throw new Error('sp500 benchmark data unavailable');
      }

      const latestRow = rows[rows.length - 1] ?? {};
      const pe = Number(latestRow.best_pe_ratio);
      const pb = Number(latestRow.px_to_book_ratio);
      const roeRaw = Number(latestRow.roe);
      const roe = Number.isFinite(roeRaw) ? (roeRaw <= 1 ? roeRaw * 100 : roeRaw) : Number.NaN;

      peElement.textContent = Number.isFinite(pe) ? pe.toFixed(1) : '--';
      pbElement.textContent = Number.isFinite(pb) ? pb.toFixed(2) : '--';
      roeElement.textContent = Number.isFinite(roe) ? `${roe.toFixed(1)}%` : '--';

      const dateLabel = typeof latestRow.date === 'string' && latestRow.date.length > 0 ? latestRow.date : '--';
      const sourceLabel = payload?.metadata?.source || 'Benchmark';
      noteElement.textContent = `${sourceLabel} snapshot · ${dateLabel}`;

      if (Number.isFinite(pe)) {
        if (pe >= 22) {
          setCorporateWidgetStatus('Valuation Hot', 'is-stale');
        } else {
          setCorporateWidgetStatus('Research Live', 'is-live');
        }
      } else {
        setCorporateWidgetStatus('Research Data', 'is-empty');
      }

      emitRadarIndexTelemetry('research-preview-success', {
        source: sourceLabel,
        date: dateLabel,
      });
    } catch (error) {
      console.warn('[Index] Corporate Health preview load failed:', error);
      peElement.textContent = '--';
      pbElement.textContent = '--';
      roeElement.textContent = '--';
      noteElement.textContent = 'Corporate benchmark snapshot unavailable';
      setCorporateWidgetStatus('Snapshot Offline', 'is-empty');
      emitRadarIndexTelemetry('research-preview-error', {
        message: error instanceof Error ? error.message : String(error),
      });
    }
  }

  // ===== 디테일 페이지 열기 =====
  function openDetail(path) {
    // iframe 내부라면 부모 창에서 페이지 로드
    try {
      if (window.top?.loadPage) {
        window.top.loadPage('tools/macro-monitor/' + path);
        return;
      }
      if (window.parent?.loadPage) {
        window.parent.loadPage('tools/macro-monitor/' + path);
        return;
      }
    } catch(e) {
      console.error('Parent navigation failed:', e);
    }

    // Next.js 라우트 fallback: nav/footer를 유지한 채 상세 이동
    const fullPath = `tools/macro-monitor/${String(path || '').replace(/^\/+/, '')}`;
    (window.top || window).location.assign(`/radar?path=${encodeURIComponent(fullPath)}`);
  }

  // ===== Coming Soon 카드 클릭 시 알림 =====
  document.querySelectorAll('.coming-soon').forEach(card => {
    card.addEventListener('click', (e) => {
      e.stopPropagation();
      const title = card.querySelector('.cs-title').textContent;
      alert(`"${title}" 지표는 곧 제공될 예정입니다!\n\n개발 진행 중입니다.`);
    });
  });

  // ===== 초기 애니메이션 =====
  window.addEventListener('load', () => {
    initializeCategoryFilter();
    const cards = document.querySelectorAll('.indicator-card');
    cards.forEach((card, index) => {
      setTimeout(() => {
        card.classList.add('fade-in');
      }, index * 50);
    });

    const syncButton = document.getElementById('radar-sync-button');
    if (syncButton instanceof HTMLButtonElement && syncButton.dataset.bound !== '1') {
      syncButton.dataset.bound = '1';
      syncButton.addEventListener('click', () => {
        void handleManualRadarSync(syncButton);
      });
    }

    document.querySelectorAll('.tab-btn').forEach((button) => {
      if (button instanceof HTMLButtonElement && button.dataset.keyboardBound !== '1') {
        button.dataset.keyboardBound = '1';
        button.addEventListener('keydown', handleCategoryTabKeydown);
      }
    });

    void hydrateCorporateHealthPreview();
  });

  // ===== 위젯 데이터 전달 (postMessage) =====
  // iframe sandbox에서 localStorage 접근 불가 → 부모에서 데이터 전달
  (function() {
    const WIDGET_IDS = ['liquidity-flow', 'liquidity-stress', 'banking-health', 'sentiment-signal'];
    const STATUS_CLASS_LIST = ['is-live', 'is-stale', 'is-empty'];
    const STALE_DAY_LIMIT_MS = 24 * 60 * 60 * 1000;

    function formatCacheAge(ageMs) {
      if (!Number.isFinite(ageMs) || ageMs < 0) {
        return 'Now';
      }

      const minutes = Math.floor(ageMs / 60000);
      if (minutes < 1) {
        return 'Now';
      }
      if (minutes < 60) {
        return `${minutes}m`;
      }

      const hours = Math.floor(minutes / 60);
      if (hours < 24) {
        return `${hours}h`;
      }

      const days = Math.floor(hours / 24);
      return `${days}d`;
    }

    function formatSyncLabel(timestamp) {
      if (!Number.isFinite(timestamp) || timestamp <= 0) {
        return 'SYNC --:--';
      }

      const date = new Date(timestamp);
      if (Number.isNaN(date.getTime())) {
        return 'SYNC --:--';
      }

      const clock = date.toLocaleTimeString('ko-KR', {
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
      });
      return `SYNC ${clock}`;
    }

    function resolveWidgetCacheStatus(widgetId) {
      const cacheKey = `macro_${widgetId}`;
      const rawData = localStorage.getItem(cacheKey);
      if (!rawData) {
        return { label: 'Cache Empty', tone: 'is-empty', timestamp: 0 };
      }

      let parsed;
      try {
        parsed = JSON.parse(rawData);
      } catch (error) {
        return { label: 'Cache Empty', tone: 'is-empty', timestamp: 0 };
      }

      if (!parsed || typeof parsed !== 'object' || !parsed.data) {
        return { label: 'Cache Empty', tone: 'is-empty', timestamp: 0 };
      }

      const now = Date.now();
      const timestamp = Number(parsed.timestamp);
      const expires = Number(parsed.expires);

      if (!Number.isFinite(timestamp) || timestamp <= 0) {
        return { label: 'Stale · Unknown', tone: 'is-stale', timestamp: 0 };
      }

      const ageMs = Math.max(0, now - timestamp);
      const ageLabel = formatCacheAge(ageMs);

      if (Number.isFinite(expires) && expires > now) {
        return { label: `Live · ${ageLabel}`, tone: 'is-live', timestamp };
      }

      if (ageMs >= STALE_DAY_LIMIT_MS) {
        return { label: 'Stale 24h+', tone: 'is-stale', timestamp };
      }

      return { label: `Stale · ${ageLabel}`, tone: 'is-stale', timestamp };
    }

    function updateWidgetStatusBadge(widgetId, status = resolveWidgetCacheStatus(widgetId)) {
      const statusElement = document.getElementById(`widget-status-${widgetId}`);
      if (!(statusElement instanceof HTMLElement)) {
        return;
      }

      statusElement.textContent = status.label;
      statusElement.classList.remove(...STATUS_CLASS_LIST);
      statusElement.classList.add(status.tone);
    }

    function updateWidgetStatusBadges() {
      let liveCount = 0;
      let staleCount = 0;
      let emptyCount = 0;
      let latestTimestamp = 0;

      WIDGET_IDS.forEach(widgetId => {
        const status = resolveWidgetCacheStatus(widgetId);
        updateWidgetStatusBadge(widgetId, status);

        if (Number.isFinite(status.timestamp) && status.timestamp > latestTimestamp) {
          latestTimestamp = status.timestamp;
        }

        if (status.tone === 'is-live') {
          liveCount += 1;
          return;
        }
        if (status.tone === 'is-stale') {
          staleCount += 1;
          return;
        }
        emptyCount += 1;
      });

      const liveCountElement = document.getElementById('summary-live-count');
      if (liveCountElement) {
        liveCountElement.textContent = String(liveCount);
      }

      const staleCountElement = document.getElementById('summary-stale-count');
      if (staleCountElement) {
        staleCountElement.textContent = String(staleCount);
      }

      const emptyCountElement = document.getElementById('summary-empty-count');
      if (emptyCountElement) {
        emptyCountElement.textContent = String(emptyCount);
      }

      const syncLabelElement = document.getElementById('summary-sync-label');
      if (syncLabelElement) {
        syncLabelElement.textContent = formatSyncLabel(latestTimestamp);
      }
    }

    window.updateWidgetStatusBadges = updateWidgetStatusBadges;

    function sendDataToWidgets() {
      WIDGET_IDS.forEach(widgetId => {
        const iframe = document.querySelector(`iframe[src*="${widgetId}.html"]`);
        if (!iframe || !iframe.contentWindow) return;

        try {
          const rawData = localStorage.getItem('macro_' + widgetId);
          if (rawData) {
            const parsed = JSON.parse(rawData);
            iframe.contentWindow.postMessage({
              type: 'WIDGET_DATA_UPDATE',
              payload: parsed.data
            }, '*');
            console.log(`[Index] ${widgetId} 위젯으로 데이터 전송`);
          }
        } catch (e) {
          console.warn(`[Index] ${widgetId} 데이터 전송 실패:`, e);
        }
      });
      updateWidgetStatusBadges();
    }

    // 페이지 로드 시 + iframe 로드 완료 시
    window.addEventListener('load', () => {
      updateWidgetStatusBadges();
      // iframe 로드 대기 후 전송
      setTimeout(sendDataToWidgets, 500);
      setTimeout(sendDataToWidgets, 1500);
      setTimeout(updateWidgetStatusBadges, 1700);
    });

    // 각 iframe onload 이벤트
    document.querySelectorAll('.live-widget iframe').forEach(iframe => {
      iframe.addEventListener('load', () => {
        setTimeout(() => {
          const widgetId = WIDGET_IDS.find(id => iframe.src.includes(id));
          if (!widgetId) return;

          try {
            const rawData = localStorage.getItem('macro_' + widgetId);
            if (rawData) {
              const parsed = JSON.parse(rawData);
              iframe.contentWindow.postMessage({
                type: 'WIDGET_DATA_UPDATE',
                payload: parsed.data
              }, '*');
              console.log(`[Index] ${widgetId} iframe 로드 후 데이터 전송`);
            }
          } catch (e) {}
          updateWidgetStatusBadge(widgetId);
        }, 300);
      });
    });

    window.addEventListener('storage', (event) => {
      if (!event.key || !event.key.startsWith('macro_')) {
        return;
      }
      updateWidgetStatusBadges();
    });
  })();
</script>

<!-- ===== 적극적 데이터 갱신 (2026-01-08 추가) ===== -->
<!-- DataFetcher를 통한 캐시 확인 + 필요시 API 호출 -->
<script type="module">
  import { DataFetcher } from './shared/data-fetcher.js';

  const WIDGET_IDS = ['liquidity-flow', 'liquidity-stress', 'banking-health', 'sentiment-signal'];

  /**
   * 위젯 데이터 갱신 (캐시 상태 확인 → stale이면 API 호출)
   * 1시간 TTL: data-manager.js v1.1.0에서 설정
   */
  async function refreshWidgetData() {
    console.log('[Index] 위젯 데이터 갱신 시작...');

    for (const widgetId of WIDGET_IDS) {
      try {
        // DataFetcher가 캐시 상태 확인 → stale이면 API 호출
        const result = await DataFetcher.fetch(widgetId);

        if (result.data) {
          // iframe에 데이터 전송
          const iframe = document.querySelector(`iframe[src*="${widgetId}.html"]`);
          if (iframe?.contentWindow) {
            iframe.contentWindow.postMessage({
              type: 'WIDGET_DATA_UPDATE',
              payload: result.data
            }, '*');
            console.log(`[Index] ${widgetId}: ${result.isFresh ? 'fresh' : 'stale'} 데이터 전송`);
          }
        }
      } catch (e) {
        console.warn(`[Index] ${widgetId} 갱신 실패:`, e);
      }
    }

    if (typeof window.updateWidgetStatusBadges === 'function') {
      window.updateWidgetStatusBadges();
    }
    console.log('[Index] 위젯 데이터 갱신 완료');
  }

  window.refreshRadarWidgets = refreshWidgetData;

  // 페이지 로드 시 실행 (iframe 로드 대기)
  window.addEventListener('load', () => {
    setTimeout(refreshWidgetData, 1000);
  });
</script>

</body>
</html>
