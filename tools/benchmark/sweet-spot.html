<!DOCTYPE html>
<html lang="ko" class="antialiased scroll-smooth">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sweet Spot Scanner v7.0 - 100xFenok</title>
  <meta name="description" content="Valuation vs Momentum analysis with advanced analytics">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
            mono: ['JetBrains Mono', 'Monaco', 'monospace']
          },
          animation: {
            'fade-in-up': 'fadeInUp 0.6s ease-out forwards',
            'fade-in-down': 'fadeInDown 0.4s ease-out forwards',
            'scale-in': 'scaleIn 0.3s ease-out forwards',
            'pulse-glow': 'pulseGlow 2s ease-in-out infinite',
            'shimmer': 'shimmer 2.5s linear infinite',
            'slide-in-right': 'slideInRight 0.3s ease-out forwards',
            'bounce-subtle': 'bounceSubtle 2s ease-in-out infinite',
            'spin-slow': 'spin 3s linear infinite'
          },
          keyframes: {
            fadeInUp: {
              '0%': { opacity: '0', transform: 'translateY(30px)' },
              '100%': { opacity: '1', transform: 'translateY(0)' }
            },
            fadeInDown: {
              '0%': { opacity: '0', transform: 'translateY(-20px)' },
              '100%': { opacity: '1', transform: 'translateY(0)' }
            },
            scaleIn: {
              '0%': { opacity: '0', transform: 'scale(0.9)' },
              '100%': { opacity: '1', transform: 'scale(1)' }
            },
            slideInRight: {
              '0%': { opacity: '0', transform: 'translateX(100%)' },
              '100%': { opacity: '1', transform: 'translateX(0)' }
            },
            pulseGlow: {
              '0%, 100%': {
                boxShadow: '0 0 20px rgba(34, 197, 94, 0.3), 0 0 40px rgba(34, 197, 94, 0.1)'
              },
              '50%': {
                boxShadow: '0 0 30px rgba(34, 197, 94, 0.5), 0 0 60px rgba(34, 197, 94, 0.2)'
              }
            },
            shimmer: {
              '0%': { backgroundPosition: '-200% 0' },
              '100%': { backgroundPosition: '200% 0' }
            },
            bounceSubtle: {
              '0%, 100%': { transform: 'translateY(0)' },
              '50%': { transform: 'translateY(-5px)' }
            },
            spin: {
              'to': { transform: 'rotate(360deg)' }
            }
          }
        }
      }
    }
  </script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    /* ==================== CSS VARIABLES SYSTEM v4 ==================== */
    :root {
      /* Primary Colors */
      --sweet-primary: #22c55e;
      --sweet-primary-dark: #16a34a;
      --sweet-light: #dcfce7;
      --sweet-bg: rgba(34, 197, 94, 0.08);
      --sweet-bg-hover: rgba(34, 197, 94, 0.15);
      --sweet-border: rgba(34, 197, 94, 0.3);
      --sweet-gradient: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 50%, #dcfce7 100%);
      --sweet-text: #166534;

      --danger-primary: #ef4444;
      --danger-primary-dark: #dc2626;
      --danger-light: #fee2e2;
      --danger-bg: rgba(239, 68, 68, 0.08);
      --danger-bg-hover: rgba(239, 68, 68, 0.15);
      --danger-border: rgba(239, 68, 68, 0.3);
      --danger-gradient: linear-gradient(135deg, #fee2e2 0%, #fecaca 50%, #fee2e2 100%);
      --danger-text: #991b1b;

      --neutral-primary: #64748b;
      --neutral-light: #f1f5f9;
      --neutral-bg: rgba(100, 116, 139, 0.08);
      --neutral-bg-hover: rgba(100, 116, 139, 0.15);
      --neutral-border: rgba(203, 213, 225, 0.6);
      --neutral-text: #475569;

      /* v7.0: Heatmap Colors */
      --heatmap-low: #22c55e;
      --heatmap-medium: #eab308;
      --heatmap-high: #ef4444;

      /* Semantic Colors */
      --info-primary: #3b82f6;
      --info-bg: rgba(59, 130, 246, 0.08);
      --info-text: #1e40af;

      /* Glass Effect */
      --glass-bg: rgba(255, 255, 255, 0.8);
      --glass-bg-dark: rgba(17, 24, 39, 0.85);
      --glass-border: rgba(255, 255, 255, 0.4);
      --glass-blur: blur(20px) saturate(180%);
      --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);

      /* Shadows */
      --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.05);
      --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.06);
      --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.08);
      --shadow-lg: 0 12px 24px rgba(0, 0, 0, 0.1);
      --shadow-xl: 0 25px 50px rgba(0, 0, 0, 0.15);

      /* Transitions */
      --transition-instant: 100ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-fast: 200ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-normal: 300ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: 500ms cubic-bezier(0.4, 0, 0.2, 1);

      /* Spacing */
      --radius-sm: 0.375rem;
      --radius-md: 0.5rem;
      --radius-lg: 0.75rem;
      --radius-xl: 1rem;
      --radius-2xl: 1.5rem;

      /* Fluid Typography Scale */
      --font-size-xs: clamp(0.7rem, 1.5vw, 0.75rem);
      --font-size-sm: clamp(0.8rem, 1.8vw, 0.875rem);
      --font-size-base: clamp(0.875rem, 2vw, 1rem);
      --font-size-lg: clamp(1rem, 2.2vw, 1.125rem);
      --font-size-xl: clamp(1.125rem, 2.5vw, 1.25rem);
      --font-size-2xl: clamp(1.25rem, 3vw, 1.5rem);
      --font-size-3xl: clamp(1.5rem, 4vw, 1.875rem);
      --font-size-4xl: clamp(1.875rem, 5vw, 2.25rem);

      /* Line Heights for Readability */
      --line-height-tight: 1.25;
      --line-height-normal: 1.5;
      --line-height-relaxed: 1.75;
      --line-height-loose: 2;

      /* Letter Spacing */
      --letter-spacing-tight: -0.02em;
      --letter-spacing-normal: 0;
      --letter-spacing-wide: 0.025em;

      /* Touch Target Sizes */
      --touch-target-min: 44px;
      --touch-target-comfortable: 48px;
    }

    .dark {
      --glass-bg: rgba(17, 24, 39, 0.85);
      --glass-border: rgba(55, 65, 81, 0.5);
      --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      --neutral-bg: rgba(75, 85, 99, 0.25);
      --neutral-bg-hover: rgba(75, 85, 99, 0.4);
      --neutral-border: rgba(75, 85, 99, 0.5);
      --neutral-text: #94a3b8;
      --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.3);
      --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.4);
      --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.5);
      --shadow-lg: 0 12px 24px rgba(0, 0, 0, 0.6);
      --shadow-xl: 0 25px 50px rgba(0, 0, 0, 0.7);
    }

    /* ==================== BASE STYLES ==================== */
    *, *::before, *::after {
      box-sizing: border-box;
    }

    html {
      scroll-behavior: smooth;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      font-size: var(--font-size-base);
      line-height: var(--line-height-normal);
      letter-spacing: var(--letter-spacing-normal);
      overflow-wrap: break-word;
      word-wrap: break-word;
      word-break: break-word;
      -webkit-hyphens: auto;
      -ms-hyphens: auto;
      hyphens: auto;
    }

    h1 {
      font-size: var(--font-size-4xl);
      line-height: var(--line-height-tight);
      letter-spacing: var(--letter-spacing-tight);
      font-weight: 800;
    }

    h2 {
      font-size: var(--font-size-3xl);
      line-height: var(--line-height-tight);
      letter-spacing: var(--letter-spacing-tight);
      font-weight: 700;
    }

    h3 {
      font-size: var(--font-size-2xl);
      line-height: var(--line-height-normal);
      font-weight: 600;
    }

    h4 {
      font-size: var(--font-size-xl);
      line-height: var(--line-height-normal);
      font-weight: 600;
    }

    p {
      font-size: var(--font-size-base);
      line-height: var(--line-height-relaxed);
      max-width: 65ch;
    }

    small, .text-small {
      font-size: var(--font-size-sm);
      line-height: var(--line-height-normal);
    }

    /* ==================== GLASSMORPHISM ==================== */
    .glass {
      background: var(--glass-bg);
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
      border: 1px solid var(--glass-border);
      box-shadow: var(--glass-shadow);
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.6);
      box-shadow: var(--shadow-lg);
    }

    .dark .glass-card {
      background: rgba(31, 41, 55, 0.95);
      border: 1px solid rgba(55, 65, 81, 0.5);
    }

    /* ==================== GRID LAYOUTS ==================== */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
    }

    @media (min-width: 640px) {
      .metrics-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
      }
    }

    @supports (display: grid) {
      .zone-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      @media (min-width: 768px) {
        .zone-grid {
          grid-template-columns: repeat(2, 1fr);
          gap: 1.5rem;
        }
      }
    }

    /* ==================== METRIC CARDS ==================== */
    .metric-card {
      position: relative;
      overflow: hidden;
      transition: all var(--transition-normal);
      transform-style: preserve-3d;
      backface-visibility: hidden;
      min-height: var(--touch-target-comfortable);
      display: flex;
      flex-direction: column;
      justify-content: center;
      padding: clamp(0.75rem, 3vw, 1rem);
    }

    .metric-card::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at var(--mouse-x, 50%) var(--mouse-y, 50%),
                  rgba(255, 255, 255, 0.15), transparent 60%);
      opacity: 0;
      transition: opacity var(--transition-fast);
      pointer-events: none;
    }

    .metric-card:hover::before {
      opacity: 1;
    }

    .metric-card:hover {
      transform: translateY(-4px) scale(1.01);
      box-shadow: var(--shadow-lg);
    }

    @media (hover: none) {
      .metric-card:hover {
        transform: none;
      }
    }

    .metric-card .icon-wrapper {
      transition: all var(--transition-normal);
      width: clamp(2rem, 6vw, 2.5rem);
      height: clamp(2rem, 6vw, 2.5rem);
    }

    .metric-card:hover .icon-wrapper {
      transform: rotate(8deg) scale(1.1);
    }

    @media (hover: none) {
      .metric-card:hover .icon-wrapper {
        transform: none;
      }
    }

    .metric-card .metric-value {
      transition: all var(--transition-normal);
      font-size: clamp(1.25rem, 5vw, 1.875rem);
      font-weight: 700;
      line-height: var(--line-height-tight);
    }

    .metric-card .metric-label {
      font-size: var(--font-size-sm);
      line-height: var(--line-height-normal);
    }

    /* ==================== ZONE BADGES ==================== */
    .zone-badge {
      position: relative;
      overflow: hidden;
      transition: all var(--transition-normal);
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      min-height: var(--touch-target-min);
      padding: 0.375rem 0.75rem;
      font-size: var(--font-size-sm);
      font-weight: 600;
    }

    .zone-badge::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
      transition: left var(--transition-slow);
    }

    .zone-badge:hover::before {
      left: 100%;
    }

    .zone-badge:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    @media (hover: none) {
      .zone-badge:hover {
        transform: none;
      }
    }

    .zone-sweet-spot {
      background: var(--sweet-gradient);
      border: 2px solid var(--sweet-primary);
      color: var(--sweet-text);
    }

    .zone-danger {
      background: var(--danger-gradient);
      border: 2px solid var(--danger-primary);
      color: var(--danger-text);
    }

    .zone-neutral {
      background: var(--neutral-light);
      border: 1px solid var(--neutral-border);
      color: var(--neutral-text);
    }

    /* ==================== SKELETON LOADING ==================== */
    .skeleton {
      background: linear-gradient(
        90deg,
        var(--neutral-bg) 25%,
        var(--neutral-border) 50%,
        var(--neutral-bg) 75%
      );
      background-size: 200% 100%;
      animation: shimmer 2.5s infinite;
      border-radius: var(--radius-md);
    }

    .skeleton-text {
      height: 1em;
      margin-bottom: 0.5em;
      border-radius: var(--radius-sm);
    }

    .skeleton-circle {
      border-radius: 50%;
    }

    /* ==================== PROGRESS BAR ==================== */
    .progress-bar {
      position: fixed;
      top: 0;
      left: 0;
      width: 0%;
      height: 3px;
      background: linear-gradient(90deg, var(--sweet-primary), var(--info-primary));
      transition: width var(--transition-fast);
      z-index: 9999;
      box-shadow: 0 0 10px rgba(34, 197, 94, 0.5);
    }

    .progress-bar.complete {
      width: 100%;
      transition: width var(--transition-slow);
    }

    /* ==================== FADE IN ANIMATIONS ==================== */
    .fade-in-section {
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.6s ease-out, transform 0.6s ease-out;
    }

    .fade-in-section.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .stagger-1 { transition-delay: 0.1s; }
    .stagger-2 { transition-delay: 0.2s; }
    .stagger-3 { transition-delay: 0.3s; }
    .stagger-4 { transition-delay: 0.4s; }

    /* ==================== ZONE LIST CARDS ==================== */
    .zone-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .zone-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: clamp(0.75rem, 3vw, 1rem);
      border-radius: var(--radius-lg);
      transition: all var(--transition-fast);
      cursor: pointer;
      min-height: var(--touch-target-min);
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
    }

    .zone-item:hover {
      transform: translateX(4px);
      box-shadow: var(--shadow-md);
    }

    @media (hover: none) {
      .zone-item:hover {
        transform: none;
      }
      .zone-item:active {
        transform: scale(0.98);
        background: var(--neutral-bg-hover);
      }
    }

    .zone-item-rank {
      display: flex;
      align-items: center;
      justify-content: center;
      width: clamp(1.75rem, 5vw, 2rem);
      height: clamp(1.75rem, 5vw, 2rem);
      font-size: var(--font-size-sm);
      font-weight: 700;
      border-radius: var(--radius-md);
      flex-shrink: 0;
    }

    .zone-item-content {
      flex: 1;
      min-width: 0;
    }

    .zone-item-name {
      font-size: var(--font-size-base);
      font-weight: 600;
      line-height: var(--line-height-tight);
      margin-bottom: 0.125rem;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .zone-item-metrics {
      display: flex;
      gap: 0.75rem;
      font-size: var(--font-size-sm);
      line-height: var(--line-height-normal);
    }

    .zone-item-metric {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    /* ==================== DATA TABLE ==================== */
    .table-container {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-gutter: stable;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: var(--font-size-sm);
      table-layout: auto;
      min-width: 600px;
    }

    .data-table thead {
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .data-table th,
    .data-table td {
      padding: clamp(0.625rem, 2.5vw, 0.875rem);
      text-align: left;
      vertical-align: middle;
    }

    .data-table th {
      font-weight: 600;
      font-size: var(--font-size-sm);
      letter-spacing: var(--letter-spacing-wide);
      text-transform: uppercase;
      background: var(--neutral-light);
      border-bottom: 2px solid var(--neutral-border);
      white-space: nowrap;
      cursor: pointer;
      user-select: none;
    }

    .data-table th:hover {
      background: var(--neutral-bg);
    }

    .data-table th.sort-asc::after {
      content: ' ‚ñ≤';
      font-size: 0.7em;
    }

    .data-table th.sort-desc::after {
      content: ' ‚ñº';
      font-size: 0.7em;
    }

    .data-table td {
      border-bottom: 1px solid var(--neutral-border);
    }

    .data-table tbody tr {
      transition: all var(--transition-fast);
    }

    .data-table tbody tr:hover {
      background: var(--neutral-bg);
      transform: scale(1.003);
    }

    @media (hover: none) {
      .data-table tbody tr:hover {
        background: transparent;
        transform: none;
      }
      .data-table tbody tr:active {
        background: var(--neutral-bg);
      }
    }

    .data-table tbody tr.highlighted {
      background: var(--info-bg) !important;
      animation: pulseHighlight 1s ease-in-out 3;
    }

    @keyframes pulseHighlight {
      0%, 100% { background: var(--info-bg); }
      50% { background: rgba(59, 130, 246, 0.15); }
    }

    /* ==================== SEARCH INPUT ==================== */
    .search-input-wrapper {
      position: relative;
      width: 100%;
      max-width: 400px;
    }

    .search-input {
      width: 100%;
      padding: 0.75rem 1rem 0.75rem 2.75rem;
      font-size: var(--font-size-base);
      line-height: var(--line-height-normal);
      border: 2px solid var(--neutral-border);
      border-radius: var(--radius-lg);
      transition: all var(--transition-fast);
      min-height: var(--touch-target-min);
    }

    .search-input:focus {
      outline: none;
      border-color: var(--info-primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .search-input-icon {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--neutral-primary);
      pointer-events: none;
    }

    /* ==================== CHART CONTAINER ==================== */
    .chart-container {
      position: relative;
      width: 100%;
      height: clamp(300px, 60vw, 450px);
      margin: 0 auto;
    }

    .chart-container canvas {
      width: 100% !important;
      height: 100% !important;
    }

    /* ==================== BUTTONS ==================== */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      min-height: var(--touch-target-min);
      padding: 0.625rem 1rem;
      font-size: var(--font-size-base);
      font-weight: 600;
      line-height: var(--line-height-normal);
      border-radius: var(--radius-lg);
      border: none;
      cursor: pointer;
      transition: all var(--transition-fast);
      text-decoration: none;
      white-space: nowrap;
    }

    .btn:active {
      transform: scale(0.98);
    }

    .btn-primary {
      background: var(--sweet-primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--sweet-primary-dark);
    }

    .btn-secondary {
      background: var(--neutral-light);
      color: var(--neutral-text);
    }

    .btn-secondary:hover {
      background: var(--neutral-bg);
    }

    .btn-icon {
      padding: 0.5rem;
      width: var(--touch-target-min);
      height: var(--touch-target-min);
    }

    /* ==================== v7.0: DROPDOWN MENU ==================== */
    .dropdown {
      position: relative;
      display: inline-block;
    }

    .dropdown-menu {
      position: absolute;
      top: 100%;
      right: 0;
      z-index: 1000;
      min-width: 200px;
      margin-top: 0.5rem;
      background: white;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-xl);
      border: 1px solid var(--neutral-border);
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all var(--transition-fast);
    }

    .dropdown.open .dropdown-menu {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .dropdown-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      font-size: var(--font-size-sm);
      color: var(--neutral-text);
      transition: all var(--transition-fast);
      cursor: pointer;
    }

    .dropdown-item:hover {
      background: var(--neutral-bg);
    }

    .dropdown-item:first-child {
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
    }

    .dropdown-item:last-child {
      border-radius: 0 0 var(--radius-lg) var(--radius-lg);
    }

    .dropdown-divider {
      height: 1px;
      background: var(--neutral-border);
      margin: 0.25rem 0;
    }

    .dark .dropdown-menu {
      background: #1e293b;
      border-color: #334155;
    }

    .dark .dropdown-item {
      color: #cbd5e1;
    }

    .dark .dropdown-item:hover {
      background: rgba(75, 85, 99, 0.3);
    }

    /* ==================== v7.0: TOAST NOTIFICATIONS ==================== */
    .toast-container {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .toast {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      background: white;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-xl);
      border: 1px solid var(--neutral-border);
      min-width: 300px;
      animation: slideInRight 0.3s ease-out forwards;
    }

    .toast.success {
      border-left: 4px solid var(--sweet-primary);
    }

    .toast.error {
      border-left: 4px solid var(--danger-primary);
    }

    .toast.info {
      border-left: 4px solid var(--info-primary);
    }

    .toast.hiding {
      animation: fadeOut 0.3s ease-out forwards;
    }

    @keyframes fadeOut {
      to {
        opacity: 0;
        transform: translateX(100%);
      }
    }

    .dark .toast {
      background: #1e293b;
      border-color: #334155;
    }

    /* ==================== v7.0: STATS PANEL ==================== */
    .stats-panel {
      background: var(--glass-bg);
      border-radius: var(--radius-xl);
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }

    @media (min-width: 640px) {
      .stats-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    .stat-item {
      text-align: center;
    }

    .stat-label {
      font-size: var(--font-size-sm);
      color: var(--neutral-text);
      margin-bottom: 0.25rem;
    }

    .stat-value {
      font-size: var(--font-size-xl);
      font-weight: 700;
      color: var(--neutral-text);
    }

    /* ==================== v7.0: HEATMAP ==================== */
    .heatmap-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .heatmap-cell {
      aspect-ratio: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-md);
      padding: 0.5rem;
      font-size: var(--font-size-xs);
      transition: all var(--transition-fast);
      cursor: pointer;
    }

    .heatmap-cell:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow-md);
    }

    .heatmap-cell .cell-name {
      font-weight: 600;
      margin-bottom: 0.25rem;
      text-align: center;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 100%;
    }

    .heatmap-cell .cell-value {
      font-size: var(--font-size-sm);
      font-weight: 700;
    }

    /* ==================== CUSTOM SCROLLBAR ==================== */
    .table-container::-webkit-scrollbar {
      height: 8px;
    }

    .table-container::-webkit-scrollbar-track {
      background: var(--neutral-light);
      border-radius: var(--radius-lg);
    }

    .table-container::-webkit-scrollbar-thumb {
      background: var(--neutral-primary);
      border-radius: var(--radius-lg);
    }

    .table-container::-webkit-scrollbar-thumb:hover {
      background: var(--neutral-text);
    }

    .dark .table-container::-webkit-scrollbar-track {
      background: var(--neutral-bg);
    }

    .dark .table-container::-webkit-scrollbar-thumb {
      background: var(--neutral-text);
    }

    /* ==================== REDUCED MOTION ==================== */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }

      .metric-card:hover::before,
      .zone-badge::before {
        display: none;
      }
    }

    /* ==================== PRINT STYLES ==================== */
    @media print {
      .no-print {
        display: none !important;
      }

      .metric-card,
      .zone-item {
        break-inside: avoid;
      }

      .data-table {
        page-break-inside: auto;
      }

      .data-table tr {
        page-break-inside: avoid;
      }

      .chart-container {
        page-break-inside: avoid;
      }
    }

    /* ==================== MOBILE-SPECIFIC ==================== */
    @media (max-width: 767px) {
      body {
        -webkit-text-size-adjust: 100%;
        -moz-text-size-adjust: 100%;
        text-size-adjust: 100%;
      }

      .btn,
      .zone-badge,
      .zone-item {
        min-height: var(--touch-target-comfortable);
      }

      .metrics-grid {
        gap: 0.5rem;
      }

      .chart-container {
        height: 280px;
      }

      .hide-mobile {
        display: none;
      }

      .show-mobile {
        display: block;
      }

      .toast-container {
        left: 1rem;
        right: 1rem;
        bottom: 1rem;
      }

      .toast {
        min-width: auto;
      }

      .heatmap-container {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (min-width: 768px) {
      .show-mobile {
        display: none;
      }
    }

    /* ==================== TABLET-SPECIFIC ==================== */
    @media (min-width: 768px) and (max-width: 1023px) {
      .metrics-grid {
        gap: 0.875rem;
      }

      .zone-item {
        padding: 0.875rem;
      }

      .chart-container {
        height: 380px;
      }
    }

    /* ==================== DARK MODE OVERRIDES ==================== */
    .dark body {
      background: #0f172a;
      color: #e2e8f0;
    }

    .dark .data-table th {
      background: #1e293b;
      color: #94a3b8;
    }

    .dark .data-table td {
      border-color: #334155;
      color: #cbd5e1;
    }

    .dark .data-table tbody tr:hover {
      background: rgba(75, 85, 99, 0.3);
    }

    .dark .search-input {
      background: #1e293b;
      border-color: #334155;
      color: #e2e8f0;
    }

    .dark .zone-item {
      background: rgba(30, 41, 59, 0.8);
      border-color: #334155;
    }
  </style>
</head>
<body class="bg-gray-50 dark:bg-slate-900 min-h-screen">
  <!-- Progress Bar -->
  <div id="progressBar" class="progress-bar"></div>

  <!-- Toast Container -->
  <div id="toastContainer" class="toast-container no-print"></div>

  <!-- Main Content -->
  <div id="main-content" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-8">
    <!-- Header -->
    <header class="mb-6 sm:mb-8 fade-in-section stagger-1">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-4">
        <div>
          <h1 class="text-2xl sm:text-3xl md:text-4xl font-extrabold text-gray-900 dark:text-white mb-2">
            üéØ Sweet Spot Scanner
          </h1>
          <p class="text-sm sm:text-base text-gray-600 dark:text-gray-400 max-w-2xl">
            Ï†ÄÌèâÍ∞Ä + Í∞ïÌïú Î™®Î©òÌÖÄ = ÏµúÏ†Å Îß§Ïàò ÌÉÄÏù¥Î∞ç
          </p>
        </div>
        <div class="flex items-center gap-2 no-print">
          <!-- Export Dropdown -->
          <div class="dropdown" id="exportDropdown">
            <button id="exportBtn" class="btn btn-secondary" aria-label="ÎÇ¥Î≥¥ÎÇ¥Í∏∞">
              <i class="fas fa-download"></i>
              <span class="hide-mobile">ÎÇ¥Î≥¥ÎÇ¥Í∏∞</span>
              <i class="fas fa-chevron-down text-xs"></i>
            </button>
            <div class="dropdown-menu">
              <div class="dropdown-item" data-export="csv">
                <i class="fas fa-file-csv text-green-600"></i>
                <span>CSVÎ°ú ÎÇ¥Î≥¥ÎÇ¥Í∏∞</span>
              </div>
              <div class="dropdown-item" data-export="excel">
                <i class="fas fa-file-excel text-green-600"></i>
                <span>ExcelÎ°ú ÎÇ¥Î≥¥ÎÇ¥Í∏∞</span>
              </div>
              <div class="dropdown-item" data-export="image">
                <i class="fas fa-image text-blue-600"></i>
                <span>Ïù¥ÎØ∏ÏßÄÎ°ú Ï†ÄÏû•</span>
              </div>
              <div class="dropdown-divider"></div>
              <div class="dropdown-item" data-export="share">
                <i class="fas fa-share-alt text-purple-600"></i>
                <span>ÎßÅÌÅ¨ Í≥µÏú†</span>
              </div>
            </div>
          </div>

          <button id="refreshBtn" class="btn btn-secondary" aria-label="Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ®">
            <i class="fas fa-sync-alt"></i>
            <span class="hide-mobile">ÏÉàÎ°úÍ≥†Ïπ®</span>
          </button>
          <button id="darkModeToggle" class="btn btn-icon btn-secondary" aria-label="Îã§ÌÅ¨ Î™®Îìú ÌÜ†Í∏Ä">
            <i class="fas fa-moon"></i>
          </button>
          <a href="../index.html" class="btn btn-icon btn-secondary" aria-label="Î≤§ÏπòÎßàÌÅ¨ ÌóàÎ∏åÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞">
            <i class="fas fa-arrow-left"></i>
          </a>
        </div>
      </div>
      <div class="flex items-center gap-2 text-xs sm:text-sm text-gray-500 dark:text-gray-500">
        <span id="lastUpdate"></span>
        <span class="hide-mobile">‚Ä¢</span>
        <span class="hide-mobile">v7.0 Advanced Analytics</span>
      </div>
    </header>

    <!-- Loading State -->
    <div id="loadingState" class="flex flex-col items-center justify-center py-12 sm:py-16 fade-in-section">
      <div class="spinner spinner-lg mb-4"></div>
      <p class="text-base sm:text-lg text-gray-600 dark:text-gray-400">Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</p>
    </div>

    <!-- Main App (Hidden until loaded) -->
    <div id="appContent" class="hidden">
      <!-- Summary Metrics -->
      <section class="mb-6 sm:mb-8 fade-in-section stagger-2">
        <div class="metrics-grid">
          <!-- Sweet Spot Count -->
          <div class="metric-card glass-card rounded-xl p-3 sm:p-4" role="region" aria-label="Sweet Spot Í∞úÏàò">
            <div class="flex items-start justify-between mb-2">
              <div class="icon-wrapper flex items-center justify-center w-10 h-10 sm:w-12 sm:h-12 rounded-lg" style="background: var(--sweet-bg)">
                <i class="fas fa-bullseye text-lg sm:text-xl" style="color: var(--sweet-primary)"></i>
              </div>
              <span class="zone-badge zone-sweet-spot text-xs sm:text-sm">Sweet</span>
            </div>
            <div class="metric-value" style="color: var(--sweet-text)" id="sweetSpotCount">-</div>
            <div class="metric-label text-gray-600 dark:text-gray-400">Sweet Spot</div>
          </div>

          <!-- Danger Zone Count -->
          <div class="metric-card glass-card rounded-xl p-3 sm:p-4" role="region" aria-label="Danger Zone Í∞úÏàò">
            <div class="flex items-start justify-between mb-2">
              <div class="icon-wrapper flex items-center justify-center w-10 h-10 sm:w-12 sm:h-12 rounded-lg" style="background: var(--danger-bg)">
                <i class="fas fa-exclamation-triangle text-lg sm:text-xl" style="color: var(--danger-primary)"></i>
              </div>
              <span class="zone-badge zone-danger text-xs sm:text-sm">Danger</span>
            </div>
            <div class="metric-value" style="color: var(--danger-text)" id="dangerZoneCount">-</div>
            <div class="metric-label text-gray-600 dark:text-gray-400">Danger Zone</div>
          </div>

          <!-- Correlation -->
          <div class="metric-card glass-card rounded-xl p-3 sm:p-4" role="region" aria-label="ÏÉÅÍ¥ÄÍ≥ÑÏàò">
            <div class="flex items-start justify-between mb-2">
              <div class="icon-wrapper flex items-center justify-center w-10 h-10 sm:w-12 sm:h-12 rounded-lg" style="background: var(--info-bg)">
                <i class="fas fa-chart-line text-lg sm:text-xl" style="color: var(--info-primary)"></i>
              </div>
              <span class="zone-badge zone-neutral text-xs sm:text-sm">ÏÉÅÍ¥Ä</span>
            </div>
            <div class="metric-value" style="color: var(--info-text)" id="correlationValue">-</div>
            <div class="metric-label text-gray-600 dark:text-gray-400">P/E vs 6M</div>
          </div>

          <!-- Total Indices -->
          <div class="metric-card glass-card rounded-xl p-3 sm:p-4" role="region" aria-label="Î∂ÑÏÑù ÎåÄÏÉÅ Ïàò">
            <div class="flex items-start justify-between mb-2">
              <div class="icon-wrapper flex items-center justify-center w-10 h-10 sm:w-12 sm:h-12 rounded-lg" style="background: var(--neutral-bg)">
                <i class="fas fa-layer-group text-lg sm:text-xl" style="color: var(--neutral-primary)"></i>
              </div>
              <span class="zone-badge zone-neutral text-xs sm:text-sm">Ï†ÑÏ≤¥</span>
            </div>
            <div class="metric-value" style="color: var(--neutral-text)" id="totalCount">-</div>
            <div class="metric-label text-gray-600 dark:text-gray-400">Î∂ÑÏÑù ÎåÄÏÉÅ</div>
          </div>
        </div>
      </section>

      <!-- v7.0: Advanced Statistics Panel -->
      <section class="mb-6 sm:mb-8 fade-in-section">
        <div class="stats-panel glass-card">
          <h3 class="text-lg sm:text-xl font-bold text-gray-900 dark:text-white mb-4">
            üìä Í≥†Í∏â ÌÜµÍ≥Ñ (Advanced Statistics)
          </h3>
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-label">R¬≤ (Í≤∞Ï†ïÍ≥ÑÏàò)</div>
              <div class="stat-value" id="rSquaredValue">-</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">P-value</div>
              <div class="stat-value" id="pValue">-</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">ÌëúÏ§ÄÏò§Ï∞®</div>
              <div class="stat-value" id="stdError">-</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Ï∂îÏÑ∏ÏÑ† Í∏∞Ïö∏Í∏∞</div>
              <div class="stat-value" id="trendSlope">-</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Scatter Plot -->
      <section class="mb-6 sm:mb-8 fade-in-section stagger-3">
        <div class="glass-card rounded-xl p-4 sm:p-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl sm:text-2xl font-bold text-gray-900 dark:text-white">
              üìä Valuation vs Momentum Scatter
            </h2>
            <button id="toggleHeatmap" class="btn btn-secondary btn-sm">
              <i class="fas fa-th"></i>
              <span class="hide-mobile">ÌûàÌä∏Îßµ</span>
            </button>
          </div>
          <div class="chart-container" id="chartWrapper">
            <canvas id="scatterChart"></canvas>
          </div>
          <!-- v7.0: Heatmap View -->
          <div id="heatmapView" class="hidden mt-4">
            <h4 class="text-base font-semibold mb-3 text-gray-700 dark:text-gray-300">ÏÉÅÍ¥ÄÍ¥ÄÍ≥Ñ ÌûàÌä∏Îßµ</h4>
            <div class="heatmap-container" id="heatmapContainer"></div>
          </div>
        </div>
      </section>

      <!-- Zone Lists -->
      <div class="zone-grid mb-6 sm:mb-8 fade-in-section stagger-4">
        <!-- Sweet Spot List -->
        <section class="glass-card rounded-xl p-4 sm:p-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg sm:text-xl font-bold" style="color: var(--sweet-text)">
              üü¢ Sweet Spot
            </h2>
            <span class="zone-badge zone-sweet-spot" id="sweetSpotBadge">0Í∞ú</span>
          </div>
          <ul class="zone-list" id="sweetSpotList" role="listbox">
            <li class="skeleton skeleton-text" style="height: 60px"></li>
          </ul>
          <p class="empty-state hidden text-center text-gray-500 dark:text-gray-500 py-6 sm:py-8 text-sm sm:text-base">
            <i class="fas fa-search text-2xl mb-2 block"></i>
            Ìï¥Îãπ Íµ¨Í∞ÑÏóê Ïù∏Îç±Ïä§Í∞Ä ÏóÜÏäµÎãàÎã§
          </p>
        </section>

        <!-- Danger Zone List -->
        <section class="glass-card rounded-xl p-4 sm:p-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg sm:text-xl font-bold" style="color: var(--danger-text)">
              üî¥ Danger Zone
            </h2>
            <span class="zone-badge zone-danger" id="dangerZoneBadge">0Í∞ú</span>
          </div>
          <ul class="zone-list" id="dangerZoneList" role="listbox">
            <li class="skeleton skeleton-text" style="height: 60px"></li>
          </ul>
          <p class="empty-state hidden text-center text-gray-500 dark:text-gray-500 py-6 sm:py-8 text-sm sm:text-base">
            <i class="fas fa-search text-2xl mb-2 block"></i>
            Ìï¥Îãπ Íµ¨Í∞ÑÏóê Ïù∏Îç±Ïä§Í∞Ä ÏóÜÏäµÎãàÎã§
          </p>
        </section>
      </div>

      <!-- Full Analysis Table -->
      <section class="mb-6 sm:mb-8 fade-in-section">
        <div class="glass-card rounded-xl p-4 sm:p-6">
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-4">
            <h2 class="text-lg sm:text-xl font-bold text-gray-900 dark:text-white">
              üìã Ï†ÑÏ≤¥ Î∂ÑÏÑù ÌÖåÏù¥Î∏î
            </h2>
            <div class="search-input-wrapper">
              <i class="fas fa-search search-input-icon"></i>
              <input
                type="search"
                id="searchInput"
                class="search-input"
                placeholder="Ïù∏Îç±Ïä§ Í≤ÄÏÉâ..."
                aria-label="Ïù∏Îç±Ïä§ Í≤ÄÏÉâ"
              >
            </div>
          </div>
          <div class="table-container">
            <table class="data-table" id="analysisTable">
              <thead>
                <tr>
                  <th scope="col" data-sort="name">Ïù∏Îç±Ïä§</th>
                  <th scope="col" data-sort="pe">P/E</th>
                  <th scope="col" data-sort="1m">1M</th>
                  <th scope="col" data-sort="3m">3M</th>
                  <th scope="col" data-sort="6m">6M</th>
                  <th scope="col" data-sort="ytd">YTD</th>
                  <th scope="col">Signal</th>
                  <th scope="col" data-sort="zone">Zone</th>
                </tr>
              </thead>
              <tbody id="tableBody">
              </tbody>
            </table>
          </div>
          <div class="mt-4 text-sm text-gray-500 dark:text-gray-500">
            <span id="resultCount">0</span>Í∞ú Í≤∞Í≥º
          </div>
        </div>
      </section>

      <!-- Methodology -->
      <section class="glass-card rounded-xl p-4 sm:p-6 mb-6 sm:mb-8 fade-in-section">
        <h2 class="text-lg sm:text-xl font-bold text-gray-900 dark:text-white mb-4">
          üìö Î∂ÑÏÑù Î∞©Î≤ïÎ°†
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm sm:text-base">
          <div>
            <h3 class="font-semibold mb-2" style="color: var(--sweet-text)">üü¢ Sweet Spot</h3>
            <p class="text-gray-600 dark:text-gray-400 mb-2">Ï†ÄÌèâÍ∞Ä + Í∞ïÌïú Î™®Î©òÌÖÄ = ÏµúÏ†Å Îß§Ïàò Í∏∞Ìöå</p>
            <ul class="list-disc list-inside text-gray-600 dark:text-gray-400 space-y-1">
              <li>P/E < 15 (Ï†ÄÌèâÍ∞Ä)</li>
              <li>6M ÏàòÏùµÎ•† > 20% (Í∞ïÌïú Î™®Î©òÌÖÄ)</li>
            </ul>
          </div>
          <div>
            <h3 class="font-semibold mb-2" style="color: var(--danger-text)">üî¥ Danger Zone</h3>
            <p class="text-gray-600 dark:text-gray-400 mb-2">Í≥†ÌèâÍ∞Ä + ÏïΩÌïú Î™®Î©òÌÖÄ = ÌöåÌîº Íµ¨Í∞Ñ</p>
            <ul class="list-disc list-inside text-gray-600 dark:text-gray-400 space-y-1">
              <li>P/E > 25 (Í≥†ÌèâÍ∞Ä)</li>
              <li>6M ÏàòÏùµÎ•† < 5% (ÏïΩÌïú Î™®Î©òÌÖÄ)</li>
            </ul>
          </div>
        </div>
        <div class="mt-4 p-3 sm:p-4 rounded-lg" style="background: var(--info-bg)">
          <p class="text-sm sm:text-base" style="color: var(--info-text)">
            <strong>üìä ÏÉÅÍ¥ÄÍ¥ÄÍ≥Ñ:</strong> P/E vs 6M Momentum = <span id="methodCorrelation">-0.399</span><br>
            <strong>üìà Ï∂îÏÑ∏ÏÑ†:</strong> y = <span id="trendEquation">-</span><br>
            <span class="text-xs sm:text-sm">Ìï¥ÏÑù: Î∞∏Î•òÏóêÏù¥ÏÖòÏù¥ ÎÇÆÏùÑÏàòÎ°ù Î™®Î©òÌÖÄÏù¥ Í∞ïÌïú ÏùåÏùò ÏÉÅÍ¥ÄÍ¥ÄÍ≥Ñ</span>
          </p>
        </div>
      </section>
    </div>

    <!-- Footer -->
    <footer class="text-center py-6 sm:py-8 border-t border-gray-200 dark:border-gray-700 no-print">
      <div class="flex flex-wrap justify-center gap-2 mb-3 text-xs sm:text-sm">
        <span class="zone-badge zone-neutral">Analytics v7.0</span>
        <span class="zone-badge zone-neutral">Export</span>
        <span class="zone-badge zone-neutral">Heatmap</span>
      </div>
      <p class="text-xs sm:text-sm text-gray-500 dark:text-gray-500">
        Sweet Spot Scanner v7.0 | Î∂ÑÏÑù: benchmarks-data-analysis.md
      </p>
    </footer>
  </div>

  <!-- Chart.js & Plugins -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-advanced-labels@2.0.0/dist/chartjs-plugin-advanced-labels.min.js"></script>

  <script>
    // ==================== CONFIGURATION ====================
    const CONFIG = {
      dataFiles: [
        'us.json',
        'us_sectors.json',
        'developed.json',
        'emerging.json',
        'msci.json',
        'micro_sectors.json'
      ],
      summariesFile: 'summaries.json',
      thresholds: {
        sweetSpotPE: 15,
        sweetSpotMomentum: 0.20,
        dangerPE: 25,
        dangerMomentum: 0.05
      },
      correlation: {
        peVs6m: -0.399,
        peVsYtd: -0.445
      }
    };

    // ==================== v7.0: STATISTICS ENGINE ====================
    class StatisticsEngine {
      constructor() {
        this.results = {};
      }

      calculateLinearRegression(xValues, yValues) {
        const n = xValues.length;
        const sumX = xValues.reduce((a, b) => a + b, 0);
        const sumY = yValues.reduce((a, b) => a + b, 0);
        const sumXY = xValues.reduce((sum, x, i) => sum + x * yValues[i], 0);
        const sumXX = xValues.reduce((sum, x) => sum + x * x, 0);
        const sumYY = yValues.reduce((sum, y) => sum + y * y, 0);

        const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
        const intercept = (sumY - slope * sumX) / n;

        // R¬≤ calculation
        const ssTotal = sumYY - (sumY * sumY) / n;
        const ssResidual = yValues.reduce((sum, y, i) => {
          const predicted = slope * xValues[i] + intercept;
          return sum + Math.pow(y - predicted, 2);
        }, 0);
        const rSquared = 1 - (ssResidual / ssTotal);

        // Standard error
        const stdError = Math.sqrt(ssResidual / (n - 2));

        // Correlation coefficient
        const correlation = (n * sumXY - sumX * sumY) /
                           Math.sqrt((n * sumXX - sumX * sumX) * (n * sumYY - sumY * sumY));

        // P-value (approximate for large n)
        const tStat = correlation * Math.sqrt((n - 2) / (1 - correlation * correlation));
        const pValue = 2 * (1 - this.tCDF(Math.abs(tStat), n - 2));

        return {
          slope,
          intercept,
          rSquared,
          correlation,
          stdError,
          pValue,
          equation: `y = ${slope.toFixed(4)}x ${intercept >= 0 ? '+' : ''}${intercept.toFixed(2)}`
        };
      }

      // Student's t CDF (approximation)
      tCDF(t, df) {
        if (df === Infinity) return this.normalCDF(t);

        const a = df / 2;
        const b = 0.5;
        const x = t * t / (df + t * t);

        return 1 - 0.5 * this.incompleteBeta(a, b, x) * (t < 0 ? -1 : 1);
      }

      // Normal CDF (approximation)
      normalCDF(x) {
        const a1 = 0.254829592;
        const a2 = -0.284496736;
        const a3 = 1.421413741;
        const a4 = -1.453152027;
        const a5 = 1.061405429;
        const p = 0.3275911;

        const sign = x < 0 ? -1 : 1;
        x = Math.abs(x) / Math.sqrt(2);

        const t = 1.0 / (1.0 + p * x);
        const y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);

        return 0.5 * (1.0 + sign * y);
      }

      // Incomplete beta function (simplified approximation)
      incompleteBeta(a, b, x) {
        // Simplified approximation for p-value calculation
        return x; // This is a placeholder - use proper implementation for production
      }
    }

    // ==================== v7.0: EXPORT MANAGER ====================
    class ExportManager {
      constructor(data, stats) {
        this.data = data;
        this.stats = stats;
      }

      exportToCSV() {
        const headers = ['Index', 'P/E', '1M', '3M', '6M', 'YTD', 'Signal', 'Zone'];
        const rows = this.data.map(item => [
          item.name,
          item.pe?.toFixed(2) || 'N/A',
          Utils.formatPercent(item.momentum1m * 100),
          Utils.formatPercent(item.momentum3m * 100),
          Utils.formatPercent(item.momentum6m * 100),
          Utils.formatPercent(item.momentumYtd * 100),
          item.signal,
          item.label
        ]);

        const csvContent = [
          headers.join(','),
          ...rows.map(row => row.join(','))
        ].join('\n');

        this.downloadFile(csvContent, 'sweet-spot-scanner.csv', 'text/csv');
        ToastManager.show('CSV ÌååÏùºÎ°ú ÎÇ¥Î≥¥ÎÇ¥Í∏∞ ÏôÑÎ£å!', 'success');
      }

      exportToExcel() {
        // Create HTML table for Excel
        const table = document.createElement('table');
        table.innerHTML = `
          <thead>
            <tr>
              <th>Index</th>
              <th>P/E</th>
              <th>1M</th>
              <th>3M</th>
              <th>6M</th>
              <th>YTD</th>
              <th>Signal</th>
              <th>Zone</th>
            </tr>
          </thead>
          <tbody>
            ${this.data.map(item => `
              <tr>
                <td>${item.name}</td>
                <td>${item.pe?.toFixed(2) || 'N/A'}</td>
                <td>${Utils.formatPercent(item.momentum1m * 100)}</td>
                <td>${Utils.formatPercent(item.momentum3m * 100)}</td>
                <td>${Utils.formatPercent(item.momentum6m * 100)}</td>
                <td>${Utils.formatPercent(item.momentumYtd * 100)}</td>
                <td>${item.signal}</td>
                <td>${item.label}</td>
              </tr>
            `).join('')}
          </tbody>
        `;

        const htmlContent = `
          <html>
            <head>
              <meta charset="UTF-8">
              <style>
                table { border-collapse: collapse; }
                th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
                th { background: #f0f0f0; font-weight: bold; }
              </style>
            </head>
            <body>
              <h2>Sweet Spot Scanner Data</h2>
              <p>Generated: ${new Date().toLocaleString()}</p>
              ${table.outerHTML}
            </body>
          </html>
        `;

        this.downloadFile(htmlContent, 'sweet-spot-scanner.xls', 'application/vnd.ms-excel');
        ToastManager.show('Excel ÌååÏùºÎ°ú ÎÇ¥Î≥¥ÎÇ¥Í∏∞ ÏôÑÎ£å!', 'success');
      }

      exportToImage() {
        const chartCanvas = document.getElementById('scatterChart');

        chartCanvas.toBlob((blob) => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `sweet-spot-scanner-${Date.now()}.png`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          ToastManager.show('Ïù¥ÎØ∏ÏßÄ Ï†ÄÏû• ÏôÑÎ£å!', 'success');
        }, 'image/png');
      }

      shareLink() {
        const url = new URL(window.location.href);
        // Add current filter parameters if any
        url.searchParams.set('v', '7.0');
        url.searchParams.set('date', new Date().toISOString().split('T')[0]);

        navigator.clipboard.writeText(url.toString()).then(() => {
          ToastManager.show('ÎßÅÌÅ¨Í∞Ä ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!', 'success');
        }).catch(() => {
          ToastManager.show('ÎßÅÌÅ¨ Î≥µÏÇ¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§', 'error');
        });
      }

      downloadFile(content, filename, type) {
        const blob = new Blob([content], { type });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }
    }

    // ==================== v7.0: TOAST MANAGER ====================
    class ToastManager {
      static show(message, type = 'info', duration = 3000) {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;

        const icons = {
          success: 'fa-check-circle',
          error: 'fa-exclamation-circle',
          info: 'fa-info-circle'
        };

        toast.innerHTML = `
          <i class="fas ${icons[type]}"></i>
          <span>${message}</span>
        `;

        container.appendChild(toast);

        setTimeout(() => {
          toast.classList.add('hiding');
          setTimeout(() => toast.remove(), 300);
        }, duration);
      }
    }

    // ==================== UTILITY FUNCTIONS ====================
    const Utils = {
      formatPercent(value, decimals = 1) {
        if (value === null || value === undefined) return 'N/A';
        return `${value.toFixed(decimals)}%`;
      },

      formatPE(value, decimals = 2) {
        if (value === null || value === undefined) return 'N/A';
        return value.toFixed(decimals);
      },

      debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      },

      rafThrottle(func) {
        let rafId = null;
        return (...args) => {
          if (rafId === null) {
            rafId = requestAnimationFrame(() => {
              func(...args);
              rafId = null;
            });
          }
        };
      },

      memoize(fn) {
        const cache = new Map();
        return (...args) => {
          const key = JSON.stringify(args);
          if (cache.has(key)) return cache.get(key);
          const result = fn(...args);
          cache.set(key, result);
          return result;
        };
      }
    };

    // ==================== OBSERVABLE STATE MANAGEMENT ====================
    class Observable {
      constructor(initialState) {
        this._state = initialState;
        this._observers = new Set();
      }

      setState(updates) {
        const oldState = this._state;
        this._state = { ...this._state, ...updates };
        this._notify(oldState);
      }

      getState() {
        return { ...this._state };
      }

      subscribe(observer) {
        this._observers.add(observer);
        return () => this._observers.delete(observer);
      }

      _notify(oldState) {
        this._observers.forEach(observer => {
          observer(this._state, oldState);
        });
      }
    }

    // ==================== ZONE CLASSIFIER ====================
    class ZoneClassifier {
      constructor(config) {
        this.config = config;
      }

      classify(pe, momentum6m) {
        if (pe === null || pe === undefined || momentum6m === null) {
          return { zone: 'neutral', signal: '‚ö™', label: 'Neutral' };
        }

        const { sweetSpotPE, sweetSpotMomentum, dangerPE, dangerMomentum } = this.config.thresholds;

        if (pe < sweetSpotPE && momentum6m > sweetSpotMomentum) {
          return { zone: 'sweet-spot', signal: 'üü¢', label: 'Sweet Spot' };
        }
        if (pe > dangerPE && momentum6m < dangerMomentum) {
          return { zone: 'danger-zone', signal: 'üî¥', label: 'Danger Zone' };
        }
        return { zone: 'neutral', signal: '‚ö™', label: 'Neutral' };
      }

      getAllZones(data) {
        const zones = {
          sweetSpot: [],
          dangerZone: [],
          neutral: []
        };

        data.forEach(item => {
          const classification = this.classify(item.pe, item.momentum6m);
          zones[classification.zone.replace('-', '')].push({ ...item, ...classification });
        });

        return zones;
      }
    }

    // ==================== DATA LOADER ====================
    class DataLoader {
      constructor(config) {
        this.config = config;
      }

      async loadAllData() {
        try {
          const [peData, summaries] = await Promise.all([
            this.loadPEData(),
            this.loadSummaries()
          ]);

          return this.combineData(peData, summaries);
        } catch (error) {
          console.error('Error loading data:', error);
          throw error;
        }
      }

      async loadPEData() {
        const peData = {};

        for (const file of this.config.dataFiles) {
          try {
            const response = await fetch(`../../data/benchmarks/${file}`);
            const data = await response.json();
            const sections = data.sections || {};

            for (const [key, value] of Object.entries(sections)) {
              if (value.data && value.data.length > 0) {
                const latest = value.data[value.data.length - 1];
                peData[key] = latest.best_pe_ratio || null;
              }
            }
          } catch (error) {
            console.warn(`Failed to load ${file}:`, error);
          }
        }

        return peData;
      }

      async loadSummaries() {
        const response = await fetch(`../../data/benchmarks/${this.config.summariesFile}`);
        const data = await response.json();
        return data.momentum || {};
      }

      combineData(peData, momentumData) {
        const combined = [];

        for (const [key, pe] of Object.entries(peData)) {
          const momentum = momentumData[key] || {};
          combined.push({
            key,
            name: this.formatName(key),
            pe,
            momentum1m: momentum['1m'] || null,
            momentum3m: momentum['3m'] || null,
            momentum6m: momentum['6m'] || null,
            momentumYtd: momentum['ytd'] || null
          });
        }

        return combined.filter(item => item.pe !== null);
      }

      formatName(key) {
        return key
          .split('-')
          .map(word => word.charAt(0).toUpperCase() + word.slice(1))
          .join(' ');
      }
    }

    // ==================== UI RENDERER ====================
    class UIRenderer {
      constructor(state) {
        this.state = state;
        this.elements = {
          sweetSpotCount: document.getElementById('sweetSpotCount'),
          dangerZoneCount: document.getElementById('dangerZoneCount'),
          correlationValue: document.getElementById('correlationValue'),
          totalCount: document.getElementById('totalCount'),
          sweetSpotList: document.getElementById('sweetSpotList'),
          dangerZoneList: document.getElementById('dangerZoneList'),
          sweetSpotBadge: document.getElementById('sweetSpotBadge'),
          dangerZoneBadge: document.getElementById('dangerZoneBadge'),
          tableBody: document.getElementById('tableBody'),
          resultCount: document.getElementById('resultCount'),
          searchInput: document.getElementById('searchInput'),
          progressBar: document.getElementById('progressBar'),
          loadingState: document.getElementById('loadingState'),
          appContent: document.getElementById('appContent'),
          lastUpdate: document.getElementById('lastUpdate'),
          // v7.0
          rSquaredValue: document.getElementById('rSquaredValue'),
          pValue: document.getElementById('pValue'),
          stdError: document.getElementById('stdError'),
          trendSlope: document.getElementById('trendSlope'),
          trendEquation: document.getElementById('trendEquation'),
          heatmapContainer: document.getElementById('heatmapContainer'),
          heatmapView: document.getElementById('heatmapView')
        };

        this.currentSort = { column: null, direction: 'asc' };
        this.allData = [];
      }

      updateMetrics(data) {
        const sweetSpotCount = data.filter(d => d.zone === 'sweet-spot').length;
        const dangerZoneCount = data.filter(d => d.zone === 'danger-zone').length;

        this.elements.sweetSpotCount.textContent = sweetSpotCount;
        this.elements.dangerZoneCount.textContent = dangerZoneCount;
        this.elements.totalCount.textContent = data.length;
        this.elements.sweetSpotBadge.textContent = `${sweetSpotCount}Í∞ú`;
        this.elements.dangerZoneBadge.textContent = `${dangerZoneCount}Í∞ú`;
      }

      updateStats(stats) {
        if (!stats) return;

        this.elements.correlationValue.textContent = stats.correlation.toFixed(3);
        this.elements.rSquaredValue.textContent = stats.rSquared.toFixed(4);
        this.elements.pValue.textContent = stats.pValue < 0.001 ? '<0.001' : stats.pValue.toFixed(4);
        this.elements.stdError.textContent = stats.stdError.toFixed(4);
        this.elements.trendSlope.textContent = stats.slope.toFixed(4);
        this.elements.trendEquation.textContent = stats.equation;
      }

      renderHeatmap(data) {
        // Create correlation heatmap between P/E and Momentum periods
        const periods = ['1m', '3m', '6m', 'ytd'];
        const peValues = data.map(d => d.pe).filter(v => v != null);

        // Calculate correlations
        const correlations = periods.map(period => {
          const values = data.map(d => d[`momentum${period}`]).filter(v => v != null);
          if (values.length !== peValues.length) return null;

          const n = Math.min(peValues.length, values.length);
          let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0, sumYY = 0;

          for (let i = 0; i < n; i++) {
            sumX += peValues[i];
            sumY += values[i];
            sumXY += peValues[i] * values[i];
            sumXX += peValues[i] * peValues[i];
            sumYY += values[i] * values[i];
          }

          const corr = (n * sumXY - sumX * sumY) /
                       Math.sqrt((n * sumXX - sumX * sumX) * (n * sumYY - sumY * sumY));
          return { period, correlation: corr || 0 };
        }).filter(c => c !== null);

        const labels = { '1m': '1M', '3m': '3M', '6m': '6M', 'ytd': 'YTD' };

        this.elements.heatmapContainer.innerHTML = correlations.map(c => {
          const value = c.correlation;
          const color = this.getHeatmapColor(value);
          const textColor = Math.abs(value) > 0.3 ? 'white' : '#374151';

          return `
            <div class="heatmap-cell" style="background: ${color}; color: ${textColor}">
              <div class="cell-name" title="P/E vs ${labels[c.period]}">${labels[c.period]}</div>
              <div class="cell-value">${value.toFixed(3)}</div>
            </div>
          `;
        }).join('');
      }

      getHeatmapColor(value) {
        // Red for negative, green for positive
        const absValue = Math.abs(value);
        if (value < 0) {
          // Red scale
          const intensity = Math.min(absValue * 2, 1);
          return `rgba(239, 68, 68, ${0.3 + intensity * 0.7})`;
        } else {
          // Green scale
          const intensity = Math.min(absValue * 2, 1);
          return `rgba(34, 197, 94, ${0.3 + intensity * 0.7})`;
        }
      }

      renderZoneLists(zones) {
        this.renderZoneList(this.elements.sweetSpotList, zones.sweetSpot, 'sweet');
        this.renderZoneList(this.elements.dangerZoneList, zones.dangerZone, 'danger');
      }

      renderZoneList(element, items, type) {
        if (items.length === 0) {
          element.innerHTML = '';
          element.nextElementSibling.classList.remove('hidden');
          return;
        }

        element.nextElementSibling.classList.add('hidden');

        element.innerHTML = items.map((item, index) => `
          <li class="zone-item" data-index-id="${item.key}" role="option" tabindex="0">
            <div class="zone-item-rank ${type === 'sweet' ? 'zone-sweet-spot' : 'zone-danger'}">
              ${index + 1}
            </div>
            <div class="zone-item-content">
              <div class="zone-item-name" data-tooltip="${item.name}">${item.name}</div>
              <div class="zone-item-metrics">
                <span class="zone-item-metric">
                  <i class="fas fa-chart-line text-xs"></i>
                  P/E: ${Utils.formatPE(item.pe)}
                </span>
                <span class="zone-item-metric">
                  <i class="fas fa-rocket text-xs"></i>
                  6M: ${Utils.formatPercent(item.momentum6m * 100)}
                </span>
              </div>
            </div>
          </li>
        `).join('');

        element.querySelectorAll('.zone-item').forEach(item => {
          item.addEventListener('click', () => {
            this.highlightTable(item.dataset.indexId);
          });

          item.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              this.highlightTable(item.dataset.indexId);
            }
          });
        });
      }

      renderTable(data) {
        this.allData = data;
        const sortedData = this.getSortedData(data);

        this.elements.tableBody.innerHTML = sortedData.map(item => `
          <tr data-index-id="${item.key}">
            <td class="font-medium">${item.name}</td>
            <td>${Utils.formatPE(item.pe)}</td>
            <td>${Utils.formatPercent(item.momentum1m * 100)}</td>
            <td>${Utils.formatPercent(item.momentum3m * 100)}</td>
            <td class="font-semibold">${Utils.formatPercent(item.momentum6m * 100)}</td>
            <td>${Utils.formatPercent(item.momentumYtd * 100)}</td>
            <td><span class="zone-badge zone-${item.zone}">${item.signal}</span></td>
            <td><span class="text-xs sm:text-sm ${item.zone === 'sweet-spot' ? 'text-green-600 dark:text-green-400' : item.zone === 'danger-zone' ? 'text-red-600 dark:text-red-400' : 'text-gray-600 dark:text-gray-400'}">${item.label}</span></td>
          </tr>
        `).join('');

        this.elements.resultCount.textContent = data.length;
        this.updateSortIndicators();
      }

      getSortedData(data) {
        if (!this.currentSort.column) return data;

        return [...data].sort((a, b) => {
          let aVal, bVal;

          switch (this.currentSort.column) {
            case 'name':
              aVal = a.name;
              bVal = b.name;
              break;
            case 'pe':
              aVal = a.pe || 0;
              bVal = b.pe || 0;
              break;
            case '1m':
              aVal = a.momentum1m || 0;
              bVal = b.momentum1m || 0;
              break;
            case '3m':
              aVal = a.momentum3m || 0;
              bVal = b.momentum3m || 0;
              break;
            case '6m':
              aVal = a.momentum6m || 0;
              bVal = b.momentum6m || 0;
              break;
            case 'ytd':
              aVal = a.momentumYtd || 0;
              bVal = b.momentumYtd || 0;
              break;
            case 'zone':
              const zoneOrder = { 'sweet-spot': 0, 'neutral': 1, 'danger-zone': 2 };
              aVal = zoneOrder[a.zone] || 1;
              bVal = zoneOrder[b.zone] || 1;
              break;
            default:
              return 0;
          }

          if (aVal < bVal) return this.currentSort.direction === 'asc' ? -1 : 1;
          if (aVal > bVal) return this.currentSort.direction === 'asc' ? 1 : -1;
          return 0;
        });
      }

      sortTable(column) {
        if (this.currentSort.column === column) {
          this.currentSort.direction = this.currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
          this.currentSort.column = column;
          this.currentSort.direction = 'asc';
        }
        this.renderTable(this.allData);
      }

      updateSortIndicators() {
        document.querySelectorAll('.data-table th').forEach(th => {
          th.classList.remove('sort-asc', 'sort-desc');
          if (th.dataset.sort === this.currentSort.column) {
            th.classList.add(this.currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
          }
        });
      }

      highlightTable(indexId) {
        this.elements.tableBody.querySelectorAll('.highlighted').forEach(row => {
          row.classList.remove('highlighted');
        });

        const targetRow = this.elements.tableBody.querySelector(`[data-index-id="${indexId}"]`);
        if (targetRow) {
          targetRow.classList.add('highlighted');
          targetRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }

      filterTable(query) {
        const rows = this.elements.tableBody.querySelectorAll('tr[data-index-id]');
        let visibleCount = 0;

        rows.forEach(row => {
          const name = row.querySelector('td').textContent.toLowerCase();
          const matches = name.includes(query.toLowerCase());

          row.style.display = matches ? '' : 'none';
          if (matches) visibleCount++;
        });

        this.elements.resultCount.textContent = visibleCount;
      }

      showProgress(progress) {
        this.elements.progressBar.style.width = `${progress}%`;
      }

      hideProgress() {
        this.elements.progressBar.classList.add('complete');
        setTimeout(() => {
          this.elements.progressBar.style.display = 'none';
        }, 500);
      }

      showContent() {
        this.elements.loadingState.classList.add('hidden');
        this.elements.appContent.classList.remove('hidden');
      }

      updateLastUpdate() {
        const now = new Date();
        const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
        this.elements.lastUpdate.textContent = `ÏóÖÎç∞Ïù¥Ìä∏: ${now.toLocaleDateString('ko-KR', options)}`;
      }
    }

    // ==================== CHART RENDERER ====================
    class ChartRenderer {
      constructor() {
        this.chart = null;
        this.ctx = document.getElementById('scatterChart').getContext('2d');
        this.stats = null;
      }

      render(data, stats) {
        this.stats = stats;
        const scatterData = this.prepareScatterData(data);

        if (this.chart) {
          this.chart.destroy();
        }

        this.chart = new Chart(this.ctx, {
          type: 'scatter',
          data: {
            datasets: [
              {
                label: 'Sweet Spot',
                data: scatterData.sweetSpot,
                backgroundColor: 'rgba(34, 197, 94, 0.7)',
                borderColor: 'rgba(34, 197, 94, 1)',
                borderWidth: 2,
                pointRadius: this.getPointRadius(),
                pointHoverRadius: 10
              },
              {
                label: 'Danger Zone',
                data: scatterData.dangerZone,
                backgroundColor: 'rgba(239, 68, 68, 0.7)',
                borderColor: 'rgba(239, 68, 68, 1)',
                borderWidth: 2,
                pointRadius: this.getPointRadius(),
                pointHoverRadius: 10
              },
              {
                label: 'Neutral',
                data: scatterData.neutral,
                backgroundColor: 'rgba(156, 163, 175, 0.5)',
                borderColor: 'rgba(156, 163, 175, 1)',
                borderWidth: 1,
                pointRadius: this.getPointRadius() - 2,
                pointHoverRadius: 8
              },
              // v7.0: Trend line
              {
                label: 'Ï∂îÏÑ∏ÏÑ†',
                data: this.generateTrendLine(scatterData.all),
                type: 'line',
                borderColor: 'rgba(59, 130, 246, 0.8)',
                borderWidth: 2,
                pointRadius: 0,
                fill: false,
                tension: 0
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: {
              duration: 750,
              easing: 'easeOutQuart',
              delay: (context) => context.dataIndex * 30
            },
            plugins: {
              legend: {
                display: true,
                position: 'top',
                labels: {
                  font: { size: this.getLegendFontSize() },
                  usePointStyle: true,
                  padding: 15
                }
              },
              tooltip: {
                callbacks: {
                  label: (context) => {
                    const point = context.raw;
                    if (context.dataset.label === 'Ï∂îÏÑ∏ÏÑ†') return null;
                    return `${point.label}: P/E ${point.x.toFixed(2)}, 6M ${point.y.toFixed(1)}%`;
                  }
                },
                titleFont: { size: 14 },
                bodyFont: { size: 13 },
                padding: 12
              },
              annotation: {
                annotations: {
                  sweetSpotArea: {
                    type: 'box',
                    xMin: 0,
                    xMax: CONFIG.thresholds.sweetSpotPE,
                    yMin: CONFIG.thresholds.sweetSpotMomentum * 100,
                    yMax: 100,
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    borderColor: 'transparent'
                  },
                  dangerZoneArea: {
                    type: 'box',
                    xMin: CONFIG.thresholds.dangerPE,
                    xMax: 50,
                    yMin: -50,
                    yMax: CONFIG.thresholds.dangerMomentum * 100,
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    borderColor: 'transparent'
                  }
                }
              }
            },
            scales: {
              x: {
                title: {
                  display: true,
                  text: 'P/E Ratio',
                  font: { size: this.getAxisFontSize(), weight: '600' }
                },
                min: 0,
                max: 45,
                grid: {
                  color: 'rgba(0, 0, 0, 0.05)'
                },
                ticks: {
                  font: { size: this.getTickFontSize() }
                }
              },
              y: {
                title: {
                  display: true,
                  text: '6M Momentum (%)',
                  font: { size: this.getAxisFontSize(), weight: '600' }
                },
                min: -20,
                max: 100,
                grid: {
                  color: 'rgba(0, 0, 0, 0.05)'
                },
                ticks: {
                  font: { size: this.getTickFontSize() },
                  callback: (value) => `${value}%`
                }
              }
            }
          }
        });
      }

      prepareScatterData(data) {
        const all = data.map(d => ({
          x: d.pe,
          y: d.momentum6m * 100,
          label: d.name,
          zone: d.zone
        }));

        return {
          sweetSpot: all.filter(d => d.zone === 'sweet-spot'),
          dangerZone: all.filter(d => d.zone === 'danger-zone'),
          neutral: all.filter(d => d.zone === 'neutral'),
          all
        };
      }

      generateTrendLine(data) {
        if (!this.stats || data.length === 0) return [];

        const minX = Math.min(...data.map(d => d.x));
        const maxX = Math.max(...data.map(d => d.x));

        return [
          { x: minX, y: this.stats.slope * minX + this.stats.intercept * 100 },
          { x: maxX, y: this.stats.slope * maxX + this.stats.intercept * 100 }
        ];
      }

      getPointRadius() {
        return window.innerWidth < 640 ? 5 : 7;
      }

      getLegendFontSize() {
        return window.innerWidth < 640 ? 11 : 12;
      }

      getAxisFontSize() {
        return window.innerWidth < 640 ? 11 : 13;
      }

      getTickFontSize() {
        return window.innerWidth < 640 ? 10 : 11;
      }
    }

    // ==================== MAIN APP ====================
    class SweetSpotApp {
      constructor() {
        this.state = new Observable({
          data: [],
          zones: { sweetSpot: [], dangerZone: [], neutral: [] },
          loading: true,
          stats: null
        });

        this.dataLoader = new DataLoader(CONFIG);
        this.zoneClassifier = new ZoneClassifier(CONFIG);
        this.uiRenderer = new UIRenderer(this.state);
        this.chartRenderer = new ChartRenderer();
        this.statsEngine = new StatisticsEngine();

        this.exportManager = null;
        this.init();
      }

      async init() {
        this.setupEventListeners();
        this.setupIntersectionObserver();
        this.setupMouseTracking();

        try {
          await this.loadData();
        } catch (error) {
          console.error('Failed to initialize app:', error);
          this.showError();
        }
      }

      async loadData() {
        this.uiRenderer.showProgress(30);

        const data = await this.dataLoader.loadAllData();
        this.uiRenderer.showProgress(70);

        // Classify zones
        const dataWithZones = data.map(item => ({
          ...item,
          ...this.zoneClassifier.classify(item.pe, item.momentum6m)
        }));

        const zones = this.zoneClassifier.getAllZones(dataWithZones);

        // Calculate statistics
        const xValues = dataWithZones.map(d => d.pe).filter(v => v != null);
        const yValues = dataWithZones.map(d => d.momentum6m * 100).filter(v => v != null);
        const stats = this.statsEngine.calculateLinearRegression(xValues, yValues);

        this.state.setState({
          data: dataWithZones,
          zones,
          loading: false,
          stats
        });

        // Initialize export manager
        this.exportManager = new ExportManager(dataWithZones, stats);

        this.uiRenderer.showProgress(100);

        setTimeout(() => {
          this.uiRenderer.updateMetrics(dataWithZones);
          this.uiRenderer.updateStats(stats);
          this.uiRenderer.renderZoneLists(zones);
          this.uiRenderer.renderTable(dataWithZones);
          this.uiRenderer.renderHeatmap(dataWithZones);
          this.chartRenderer.render(dataWithZones, stats);
          this.uiRenderer.showContent();
          this.uiRenderer.hideProgress();
          this.uiRenderer.updateLastUpdate();
        }, 300);
      }

      setupEventListeners() {
        // Search input with debounce
        const debouncedSearch = Utils.debounce((query) => {
          this.uiRenderer.filterTable(query);
        }, 300);

        this.uiRenderer.elements.searchInput.addEventListener('input', (e) => {
          debouncedSearch(e.target.value);
        });

        // Table sorting
        document.querySelectorAll('.data-table th[data-sort]').forEach(th => {
          th.addEventListener('click', () => {
            this.uiRenderer.sortTable(th.dataset.sort);
          });
        });

        // Refresh button
        document.getElementById('refreshBtn').addEventListener('click', () => {
          location.reload();
        });

        // Dark mode toggle
        const darkModeToggle = document.getElementById('darkModeToggle');
        darkModeToggle.addEventListener('click', () => {
          document.documentElement.classList.toggle('dark');
          const icon = darkModeToggle.querySelector('i');
          icon.classList.toggle('fa-moon');
          icon.classList.toggle('fa-sun');
        });

        // v7.0: Export dropdown
        const exportDropdown = document.getElementById('exportDropdown');
        const exportBtn = document.getElementById('exportBtn');

        exportBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          exportDropdown.classList.toggle('open');
        });

        document.querySelectorAll('[data-export]').forEach(item => {
          item.addEventListener('click', () => {
            const exportType = item.dataset.export;
            if (!this.exportManager) return;

            switch (exportType) {
              case 'csv':
                this.exportManager.exportToCSV();
                break;
              case 'excel':
                this.exportManager.exportToExcel();
                break;
              case 'image':
                this.exportManager.exportToImage();
                break;
              case 'share':
                this.exportManager.shareLink();
                break;
            }
            exportDropdown.classList.remove('open');
          });
        });

        document.addEventListener('click', () => {
          exportDropdown.classList.remove('open');
        });

        // v7.0: Heatmap toggle
        const heatmapBtn = document.getElementById('toggleHeatmap');
        heatmapBtn.addEventListener('click', () => {
          const heatmapView = this.uiRenderer.elements.heatmapView;
          heatmapView.classList.toggle('hidden');
        });

        this.setupEventDelegation();
      }

      setupEventDelegation() {
        const mainContent = document.getElementById('main-content');

        mainContent.addEventListener('click', (e) => {
          const zoneItem = e.target.closest('.zone-item');
          if (zoneItem) {
            const indexId = zoneItem.dataset.indexId;
            this.uiRenderer.highlightTable(indexId);
          }
        });
      }

      setupIntersectionObserver() {
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              entry.target.classList.add('visible');
            }
          });
        }, { threshold: 0.1 });

        document.querySelectorAll('.fade-in-section').forEach(section => {
          observer.observe(section);
        });
      }

      setupMouseTracking() {
        const metricCards = document.querySelectorAll('.metric-card');

        const updateMousePosition = Utils.rafThrottle((e, card) => {
          const rect = card.getBoundingClientRect();
          const x = ((e.clientX - rect.left) / rect.width) * 100;
          const y = ((e.clientY - rect.top) / rect.height) * 100;
          card.style.setProperty('--mouse-x', `${x}%`);
          card.style.setProperty('--mouse-y', `${y}%`);
        });

        metricCards.forEach(card => {
          card.addEventListener('mousemove', (e) => updateMousePosition(e, card));
        });
      }

      showError() {
        this.uiRenderer.elements.loadingState.innerHTML = `
          <div class="text-center">
            <i class="fas fa-exclamation-circle text-4xl text-red-500 mb-4"></i>
            <p class="text-lg text-gray-600 dark:text-gray-400">Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§</p>
            <button onclick="location.reload()" class="btn btn-primary mt-4">Îã§Ïãú ÏãúÎèÑ</button>
          </div>
        `;
      }
    }

    // ==================== INITIALIZE APP ====================
    document.addEventListener('DOMContentLoaded', () => {
      new SweetSpotApp();
    });
  </script>
</body>
</html>
