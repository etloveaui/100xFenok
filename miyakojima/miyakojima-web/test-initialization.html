<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¯¸ì•¼ì½”ì§€ë§ˆ ì•± ì´ˆê¸°í™” í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 30px;
        }
        
        .module-status {
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            background: white;
        }
        
        .module-status.ready {
            background: #e8f5e8;
            border-color: #4caf50;
        }
        
        .module-status.loading {
            background: #fff3e0;
            border-color: #ff9800;
        }
        
        .module-status.failed {
            background: #ffebee;
            border-color: #f44336;
        }
        
        .module-status.optional {
            opacity: 0.7;
        }
        
        .module-name {
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .module-deps {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .module-error {
            color: #f44336;
            font-size: 12px;
            margin-top: 8px;
        }
        
        .controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .btn-primary {
            background: #2196f3;
            color: white;
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        
        .console {
            background: #1e1e1e;
            color: #ffffff;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .log-info { color: #4fc3f7; }
        .log-warn { color: #ffb74d; }
        .log-error { color: #f44336; }
        .log-success { color: #81c784; }
        
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #2196f3;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .initialization-progress {
            background: #f0f0f0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }
        
        .progress-bar {
            background: #e0e0e0;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin: 8px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #81c784);
            transition: width 0.3s ease;
        }
        
        .section {
            display: none;
            padding: 20px 0;
        }
        
        .section.active {
            display: block;
        }
        
        .nav-item {
            padding: 8px 16px;
            margin: 0 4px;
            border-radius: 4px;
            cursor: pointer;
            background: #f0f0f0;
        }
        
        .nav-item.active {
            background: #2196f3;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸï¸ ë¯¸ì•¼ì½”ì§€ë§ˆ ì•± ì´ˆê¸°í™” í…ŒìŠ¤íŠ¸</h1>
        
        <div class="initialization-progress">
            <div class="progress-header">
                <span>ì´ˆê¸°í™” ì§„í–‰ë¥ : </span>
                <span id="progress-text">0/0 ëª¨ë“ˆ</span>
                <span id="progress-percentage">0%</span>
            </div>
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
            </div>
            <div id="current-module" class="current-module"></div>
        </div>
        
        <div class="controls">
            <button id="refresh-status" class="btn-primary">ìƒíƒœ ìƒˆë¡œê³ ì¹¨</button>
            <button id="clear-console" class="btn-secondary">ì½˜ì†” ì§€ìš°ê¸°</button>
            <button id="reinitialize" class="btn-secondary">ë‹¤ì‹œ ì´ˆê¸°í™”</button>
            <button id="export-log" class="btn-secondary">ë¡œê·¸ ë‚´ë³´ë‚´ê¸°</button>
        </div>
        
        <!-- Navigation -->
        <div style="display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap;">
            <div class="nav-item active" data-section="status">ëª¨ë“ˆ ìƒíƒœ</div>
            <div class="nav-item" data-section="dashboard">ëŒ€ì‹œë³´ë“œ</div>
            <div class="nav-item" data-section="console">ì½˜ì†”</div>
        </div>
        
        <!-- Status Section -->
        <div id="status-section" class="section active">
            <h3>ëª¨ë“ˆ ì´ˆê¸°í™” ìƒíƒœ</h3>
            <div id="status-grid" class="status-grid">
                <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
            </div>
        </div>
        
        <!-- Dashboard Section -->
        <div id="dashboard-section" class="section">
            <h3>ì•± ëŒ€ì‹œë³´ë“œ (ë¯¸ë‹ˆ ë²„ì „)</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px;">
                <div class="module-status">
                    <div class="module-name">í˜„ì¬ ìœ„ì¹˜</div>
                    <div id="current-location">ìœ„ì¹˜ í™•ì¸ ì¤‘...</div>
                    <div id="location-detail" style="font-size: 12px; color: #666; margin-top: 4px;"></div>
                </div>
                
                <div class="module-status">
                    <div class="module-name">ì˜¤ëŠ˜ ì˜ˆì‚°</div>
                    <div id="today-budget">ë¡œë”© ì¤‘...</div>
                    <div style="font-size: 12px; color: #666; margin-top: 4px;">
                        ì‚¬ìš©: <span id="today-spent">-</span>
                    </div>
                </div>
                
                <div class="module-status">
                    <div class="module-name">ì¶”ì²œ ì¥ì†Œ</div>
                    <div id="recommendations-count">-</div>
                    <div style="font-size: 12px; color: #666; margin-top: 4px;">ê·¼ì²˜ POI</div>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <button id="test-functions" class="btn-primary">ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸</button>
            </div>
        </div>
        
        <!-- Console Section -->
        <div id="console-section" class="section">
            <h3>ì´ˆê¸°í™” ë¡œê·¸</h3>
            <div id="console-output" class="console">
                ì´ˆê¸°í™” ì‹œì‘ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...
            </div>
        </div>
    </div>

    <!-- ìŠ¤í¬ë¦½íŠ¸ ë¡œë”© -->
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/api.js"></script>
    <script src="js/budget.js"></script>
    <script src="js/location.js"></script>
    <script src="js/poi.js"></script>
    <script src="js/itinerary.js"></script>
    <script src="js/app.js"></script>

    <script>
        // ì½˜ì†” ë¡œê·¸ ìº¡ì²˜
        const originalConsole = {
            log: console.log,
            info: console.info,
            warn: console.warn,
            error: console.error
        };
        
        const consoleOutput = document.getElementById('console-output');
        const logs = [];
        
        function formatTimestamp() {
            return new Date().toLocaleTimeString();
        }
        
        function addToConsole(level, args) {
            const timestamp = formatTimestamp();
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            
            const logEntry = `[${timestamp}] ${message}`;
            logs.push({ timestamp, level, message: logEntry });
            
            const logElement = document.createElement('div');
            logElement.className = `log-${level}`;
            logElement.textContent = logEntry;
            
            if (consoleOutput) {
                consoleOutput.appendChild(logElement);
                consoleOutput.scrollTop = consoleOutput.scrollHeight;
            }
        }
        
        // ì½˜ì†” ì˜¤ë²„ë¼ì´ë“œ
        console.log = (...args) => {
            originalConsole.log.apply(console, args);
            addToConsole('info', args);
        };
        
        console.info = (...args) => {
            originalConsole.info.apply(console, args);
            addToConsole('info', args);
        };
        
        console.warn = (...args) => {
            originalConsole.warn.apply(console, args);
            addToConsole('warn', args);
        };
        
        console.error = (...args) => {
            originalConsole.error.apply(console, args);
            addToConsole('error', args);
        };
        
        // ëª¨ë“ˆ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateModuleStatus() {
            const statusGrid = document.getElementById('status-grid');
            const progressText = document.getElementById('progress-text');
            const progressPercentage = document.getElementById('progress-percentage');
            const progressFill = document.getElementById('progress-fill');
            const currentModuleSpan = document.getElementById('current-module');
            
            if (!window.debugApp) {
                statusGrid.innerHTML = '<div class="module-status loading"><div class="module-name">ì´ˆê¸°í™” ëŒ€ê¸° ì¤‘...</div></div>';
                return;
            }
            
            const status = window.debugApp.getInitializationStatus();
            const modules = window.debugApp.getModules();
            
            if (!status || !modules) {
                statusGrid.innerHTML = '<div class="module-status loading"><div class="module-name">ìƒíƒœ ì •ë³´ ì—†ìŒ</div></div>';
                return;
            }
            
            statusGrid.innerHTML = '';
            
            let totalModules = 0;
            let readyModules = 0;
            let currentModule = '';
            
            for (const [name, moduleInfo] of modules) {
                totalModules++;
                
                const moduleDiv = document.createElement('div');
                moduleDiv.className = `module-status ${moduleInfo.status}`;
                
                if (moduleInfo.optional) {
                    moduleDiv.classList.add('optional');
                }
                
                if (moduleInfo.status === 'ready') {
                    readyModules++;
                } else if (moduleInfo.status === 'loading') {
                    currentModule = name;
                }
                
                moduleDiv.innerHTML = `
                    <div class="module-name">
                        ${name}
                        ${moduleInfo.optional ? ' (ì„ íƒì )' : ''}
                        ${moduleInfo.status === 'loading' ? '<div class="spinner"></div>' : ''}
                    </div>
                    <div class="module-deps">
                        ${moduleInfo.dependencies?.length ? 
                            `ì˜ì¡´ì„±: ${moduleInfo.dependencies.join(', ')}` : 
                            'ì˜ì¡´ì„± ì—†ìŒ'
                        }
                    </div>
                    <div style="font-size: 12px; color: #666;">
                        ìƒíƒœ: ${moduleInfo.status}
                        ${moduleInfo.retryCount > 0 ? ` (ì¬ì‹œë„: ${moduleInfo.retryCount})` : ''}
                    </div>
                    ${moduleInfo.error ? `<div class="module-error">ì˜¤ë¥˜: ${moduleInfo.error}</div>` : ''}
                `;
                
                statusGrid.appendChild(moduleDiv);
            }
            
            // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
            const percentage = Math.round((readyModules / totalModules) * 100);
            progressText.textContent = `${readyModules}/${totalModules} ëª¨ë“ˆ`;
            progressPercentage.textContent = `${percentage}%`;
            progressFill.style.width = `${percentage}%`;
            
            if (currentModule) {
                currentModuleSpan.textContent = `í˜„ì¬ ì´ˆê¸°í™” ì¤‘: ${currentModule}`;
            } else if (readyModules === totalModules) {
                currentModuleSpan.textContent = 'ëª¨ë“  ëª¨ë“ˆ ì´ˆê¸°í™” ì™„ë£Œ!';
                currentModuleSpan.style.color = '#4caf50';
            }
        }
        
        // ë„¤ë¹„ê²Œì´ì…˜
        function setupNavigation() {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    const section = e.target.dataset.section;
                    
                    // ëª¨ë“  ë„¤ë¹„ê²Œì´ì…˜ ì•„ì´í…œ ë¹„í™œì„±í™”
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    // ëª¨ë“  ì„¹ì…˜ ìˆ¨ê¸°ê¸°
                    document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
                    
                    // í´ë¦­ëœ ë„¤ë¹„ê²Œì´ì…˜ í™œì„±í™”
                    e.target.classList.add('active');
                    // í•´ë‹¹ ì„¹ì…˜ í‘œì‹œ
                    document.getElementById(`${section}-section`).classList.add('active');
                });
            });
        }
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupEventListeners() {
            document.getElementById('refresh-status').addEventListener('click', updateModuleStatus);
            
            document.getElementById('clear-console').addEventListener('click', () => {
                consoleOutput.innerHTML = 'ì½˜ì†”ì´ ì§€ì›Œì¡ŒìŠµë‹ˆë‹¤.\n';
                logs.length = 0;
            });
            
            document.getElementById('reinitialize').addEventListener('click', () => {
                if (window.debugApp) {
                    window.debugApp.reinitialize();
                } else {
                    location.reload();
                }
            });
            
            document.getElementById('export-log').addEventListener('click', () => {
                const logText = logs.map(log => log.message).join('\n');
                const blob = new Blob([logText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `miyakojima-init-log-${new Date().toISOString().slice(0, 19)}.txt`;
                a.click();
                URL.revokeObjectURL(url);
            });
            
            document.getElementById('test-functions')?.addEventListener('click', testAppFunctions);
        }
        
        // ì•± ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
        function testAppFunctions() {
            console.log('=== ì•± ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹œì‘ ===');
            
            try {
                // ìœ„ì¹˜ í…ŒìŠ¤íŠ¸
                if (window.locationManager) {
                    console.log('âœ… LocationManager ì‚¬ìš© ê°€ëŠ¥');
                    const locationInfo = window.locationManager.getCurrentLocationInfo();
                    console.log('í˜„ì¬ ìœ„ì¹˜ ì •ë³´:', locationInfo);
                } else {
                    console.warn('âš ï¸ LocationManager ì—†ìŒ');
                }
                
                // ì˜ˆì‚° í…ŒìŠ¤íŠ¸
                if (window.budgetManager) {
                    console.log('âœ… BudgetManager ì‚¬ìš© ê°€ëŠ¥');
                    const todayExpenses = window.budgetManager.getTodayExpenses();
                    console.log('ì˜¤ëŠ˜ ì§€ì¶œ:', todayExpenses);
                } else {
                    console.warn('âš ï¸ BudgetManager ì—†ìŒ');
                }
                
                // POI í…ŒìŠ¤íŠ¸
                if (window.poiManager) {
                    console.log('âœ… POIManager ì‚¬ìš© ê°€ëŠ¥');
                    console.log('POI ë°ì´í„°:', window.poiManager.pois?.length || 0, 'ê°œ');
                } else {
                    console.warn('âš ï¸ POIManager ì—†ìŒ');
                }
                
                // ì¼ì • í…ŒìŠ¤íŠ¸
                if (window.itinerary) {
                    console.log('âœ… ItineraryManager ì‚¬ìš© ê°€ëŠ¥');
                    const stats = window.itinerary.getScheduleStats();
                    console.log('ì¼ì • í†µê³„:', stats);
                } else {
                    console.warn('âš ï¸ ItineraryManager ì—†ìŒ');
                }
                
                console.log('=== í…ŒìŠ¤íŠ¸ ì™„ë£Œ ===');
                
            } catch (error) {
                console.error('í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜:', error);
            }
        }
        
        // ì •ê¸°ì ìœ¼ë¡œ ìƒíƒœ ì—…ë°ì´íŠ¸
        function startStatusPolling() {
            updateModuleStatus();
            setInterval(updateModuleStatus, 1000);
        }
        
        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            setupNavigation();
            setupEventListeners();
            startStatusPolling();
            
            console.log('ğŸï¸ ë¯¸ì•¼ì½”ì§€ë§ˆ ì•± í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ì´ˆê¸°í™” ì™„ë£Œ');
        });
        
        // ëª¨ë“ˆ ì¤€ë¹„ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        window.addEventListener('moduleReady', (event) => {
            console.log(`âœ… ëª¨ë“ˆ ì¤€ë¹„ ì™„ë£Œ: ${event.detail.moduleName}`);
            updateModuleStatus();
        });
    </script>
</body>
</html>