<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>IB Helper - ë¬´í•œë§¤ìˆ˜ ë„ìš°ë¯¸</title>

  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Custom Styles for Mobile -->
  <style>
    /* Mobile-first: Large touch targets */
    .touch-target {
      min-height: 44px;
      min-width: 44px;
    }

    /* Large number display */
    .number-display {
      font-size: 1.5rem;
      font-weight: 600;
      font-variant-numeric: tabular-nums;
    }

    /* Input number styling */
    input[type="number"] {
      font-size: 1.125rem;
      font-variant-numeric: tabular-nums;
    }

    /* Order card styling */
    .order-card {
      border-left: 4px solid;
    }
    .order-card.buy {
      border-left-color: #10b981;
    }
    .order-card.sell {
      border-left-color: #ef4444;
    }

    /* Phase indicator */
    .phase-first { background: linear-gradient(135deg, #10b981, #059669); }
    .phase-second { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .phase-stop { background: linear-gradient(135deg, #ef4444, #dc2626); }

    /* Sticky header */
    .sticky-header {
      position: sticky;
      top: 0;
      z-index: 10;
      background: white;
      border-bottom: 1px solid #e5e7eb;
    }

    /* Balance Section (Phase 3) */
    .balance-input {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }
    .balance-input input {
      flex: 1;
      font-size: 1.125rem;
    }
    .status-box {
      background: #f8fafc;
      padding: 0.75rem;
      border-radius: 0.5rem;
      margin-top: 0.75rem;
    }
    .status-row {
      display: flex;
      justify-content: space-between;
      padding: 0.25rem 0;
      font-size: 0.875rem;
    }
    .status-ok { color: #10b981; font-weight: 600; }
    .status-warning { color: #ef4444; font-weight: 600; }

    /* Alert Banner */
    .alert-banner {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #fef2f2;
      border-bottom: 2px solid #ef4444;
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      z-index: 1000;
    }
    .alert-banner.hidden { display: none; }
    .alert-icon { font-size: 1.25rem; }

    /* Breakdown Table */
    .breakdown-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8125rem;
      margin-top: 0.75rem;
    }
    .breakdown-table th,
    .breakdown-table td {
      padding: 0.375rem 0.5rem;
      text-align: right;
      border-bottom: 1px solid #e2e8f0;
    }
    .breakdown-table th:first-child,
    .breakdown-table td:first-child {
      text-align: left;
    }
    .breakdown-table th {
      background: #f8fafc;
      font-weight: 500;
      color: #64748b;
    }
    .bar-cell {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    .bar {
      height: 6px;
      background: #3b82f6;
      border-radius: 3px;
    }

    /* Order Type Badge */
    .order-badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.625rem;
      font-weight: 700;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }
    .badge-loc {
      background: #dbeafe;
      color: #1d4ed8;
    }
    .badge-limit {
      background: #fef3c7;
      color: #d97706;
    }

    /* Quick Add Buttons */
    .quick-add-btn {
      min-width: 42px;
      min-height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.875rem;
      transition: all 0.15s;
    }
    .quick-add-btn:active {
      transform: scale(0.95);
    }

    /* Copy Button Animation */
    .copy-btn {
      opacity: 0.6;
      transition: all 0.15s;
    }
    .copy-btn:hover {
      opacity: 1;
    }
    .copy-btn.copied {
      color: #10b981;
    }

    /* Order Card Enhanced */
    .order-card-enhanced {
      position: relative;
      border-radius: 12px;
      padding: 1rem;
      border-left: 4px solid;
      transition: all 0.15s;
    }
    .order-card-enhanced:active {
      transform: scale(0.99);
    }
    .order-card-enhanced.buy {
      background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
      border-left-color: #10b981;
    }
    .order-card-enhanced.sell {
      background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
      border-left-color: #ef4444;
    }
    .order-card-enhanced.decline {
      background: linear-gradient(135deg, #f0f9ff 0%, #dbeafe 100%);
      border-left-color: #3b82f6;
    }

    /* Main Value Display */
    .main-value {
      font-size: 1.75rem;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
      line-height: 1;
    }
    .sub-value {
      font-size: 1rem;
      font-weight: 600;
      color: #6b7280;
    }

    /* Section Header */
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.75rem;
    }

    /* Toast Notification */
    .toast {
      background: #1f2937;
      color: white;
      padding: 0.75rem 1rem;
      border-radius: 0.75rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      animation: toast-in 0.3s ease-out;
      pointer-events: auto;
    }
    .toast.success { background: #059669; }
    .toast.error { background: #dc2626; }
    .toast.warning { background: #d97706; }
    @keyframes toast-in {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes toast-out {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(-20px); }
    }

    /* Focus Ring for Accessibility */
    input:focus, button:focus, select:focus {
      outline: none;
      box-shadow: 0 0 0 2px #3b82f6;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">

  <!-- Alert Banner (Phase 3) -->
  <div id="alert-banner" class="alert-banner hidden" role="alert" aria-live="assertive">
    <span class="alert-icon">ğŸš¨</span>
    <span id="alert-message" class="flex-1 text-sm text-red-700 font-medium"></span>
    <button onclick="dismissAlert()" class="touch-target text-red-400 hover:text-red-600">
      <i class="fas fa-times"></i>
    </button>
  </div>

  <!-- Header -->
  <header class="sticky-header px-4 py-3">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <a href="../" class="text-gray-500 hover:text-gray-700 touch-target flex items-center justify-center" aria-label="ë’¤ë¡œê°€ê¸°">
          <i class="fas fa-arrow-left"></i>
        </a>
        <div>
          <h1 class="text-lg font-bold">
            <span class="bg-gradient-to-r from-rose-500 to-amber-500 bg-clip-text text-transparent">100x</span>
            <span class="text-gray-800"> IB Helper</span>
          </h1>
          <p class="text-xs text-gray-500">ë¬´í•œë§¤ìˆ˜ V2.2</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <span id="today-date" class="text-xs text-gray-500"></span>
      </div>
    </div>
  </header>

  <!-- Empty State (í”„ë¡œí•„ ì—†ì„ ë•Œ) - Light Theme -->
  <div id="empty-state" class="hidden px-4 py-12 max-w-lg mx-auto">
    <div class="bg-white rounded-2xl p-8 shadow-lg border border-gray-100 text-center">
      <!-- Logo -->
      <div class="w-24 h-24 bg-gradient-to-br from-rose-500 to-amber-500 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg">
        <span class="text-white text-3xl font-black">100x</span>
      </div>

      <!-- Title -->
      <h1 class="text-2xl font-black mb-1">
        <span class="bg-gradient-to-r from-rose-500 to-amber-500 bg-clip-text text-transparent">100x</span>
        <span class="text-gray-800"> IB Helper</span>
      </h1>
      <p class="text-gray-500 text-sm mb-8">ë¬´í•œë§¤ìˆ˜ V2.2 ì•Œê³ ë¦¬ì¦˜</p>

      <!-- Google Login Button -->
      <button onclick="quickStart()" class="w-full py-4 bg-gradient-to-r from-rose-500 to-amber-500 text-white rounded-xl font-semibold text-lg hover:from-rose-600 hover:to-amber-600 transition-all shadow-md flex items-center justify-center gap-3">
        <svg class="w-5 h-5" viewBox="0 0 24 24"><path fill="#fff" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#fff" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#fff" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#fff" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
        Googleë¡œ ì‹œì‘í•˜ê¸°
      </button>

      <p class="mt-4 text-xs text-gray-400">
        ğŸ“Š Google Sheets ìë™ ë™ê¸°í™”
      </p>

      <button onclick="quickStartOffline()" class="mt-4 text-xs text-gray-400 hover:text-gray-600 underline underline-offset-2">
        ë¡œê·¸ì¸ ì—†ì´ ì‹œì‘
      </button>

      <!-- Powered by -->
      <div class="mt-8 pt-6 border-t border-gray-100">
        <p class="text-xs text-gray-400">Powered by <span class="font-bold text-rose-500">FENOK</span></p>
      </div>
    </div>
  </div>

  <!-- Main Content: PC 2-column / Mobile single column (hidden until profile exists) -->
  <main id="main-content" style="display: none;" class="px-4 py-4 max-w-6xl mx-auto lg:flex lg:gap-6">

    <!-- LEFT COLUMN: Input Sections -->
    <div id="input-column" class="space-y-4 lg:w-96 lg:flex-shrink-0">

    <!-- Profile Selector (moved from header) -->
    <div class="bg-white rounded-xl p-3 shadow-sm flex items-center gap-2">
      <select id="profile-selector" onchange="switchProfile(this.value)" class="flex-1 px-3 py-2 border border-gray-200 rounded-lg text-sm font-medium bg-white">
        <!-- Dynamic options -->
      </select>
      <button onclick="showProfileSettings()" class="touch-target px-3 py-2 bg-gray-100 rounded-lg text-gray-600 hover:bg-gray-200" aria-label="í”„ë¡œí•„ ì„¤ì •">
        <i class="fas fa-user-cog"></i>
      </button>
    </div>

    <!-- Ticker Selection -->
    <div class="bg-white rounded-xl p-4 shadow-sm">
      <label class="block text-sm font-medium text-gray-700 mb-2">ì¢…ëª© ì„ íƒ</label>
      <div id="ticker-buttons" class="grid grid-cols-2 gap-2">
        <button onclick="selectTicker('TQQQ')" class="ticker-btn touch-target py-3 rounded-lg text-center font-semibold transition-all bg-gray-100 text-gray-600 hover:bg-blue-100" data-ticker="TQQQ">TQQQ</button>
        <button onclick="selectTicker('SOXL')" class="ticker-btn touch-target py-3 rounded-lg text-center font-semibold transition-all bg-gray-100 text-gray-600 hover:bg-blue-100" data-ticker="SOXL">SOXL</button>
      </div>
    </div>

    <!-- Settings (Collapsible) -->
    <details class="bg-white rounded-xl shadow-sm">
      <summary class="px-4 py-3 cursor-pointer font-medium text-gray-700 flex items-center justify-between">
        <span><i class="fas fa-cog mr-2 text-gray-400"></i>ì„¤ì •</span>
        <i class="fas fa-chevron-down text-gray-400 transition-transform"></i>
      </summary>
      <div class="px-4 pb-4 space-y-3 border-t border-gray-100 pt-3">
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-xs text-gray-500 mb-1">ì„¸íŒ…ì›ê¸ˆ ($)</label>
            <input type="number" id="input-principal" class="w-full px-3 py-2 border rounded-lg" value="13000" inputmode="numeric" onchange="saveCurrentInputs()">
          </div>
          <div>
            <label class="block text-xs text-gray-500 mb-1">ë¶„í•  ìˆ˜</label>
            <input type="number" id="input-divisions" class="w-full px-3 py-2 border rounded-lg" value="40" inputmode="numeric">
          </div>
        </div>
        <div>
          <label class="block text-xs text-gray-500 mb-1">AFTER ë§¤ë„% (TQQQ=10, SOXL=12)</label>
          <input type="number" id="input-sellPercent" class="w-full px-3 py-2 border rounded-lg" value="12" step="0.5" inputmode="decimal" onchange="saveCurrentInputs()">
        </div>
      </div>
    </details>

    <!-- Daily Input -->
    <div class="bg-white rounded-xl p-4 shadow-sm space-y-3">
      <h3 class="font-medium text-gray-700"><i class="fas fa-edit mr-2 text-blue-500"></i>ì˜¤ëŠ˜ ì…ë ¥</h3>

      <div>
        <label class="block text-xs text-gray-500 mb-1">í‰ë‹¨ê°€ ($)</label>
        <input type="number" id="input-avgPrice" class="w-full px-3 py-2 border rounded-lg text-lg" placeholder="0.00" step="0.01" inputmode="decimal" onchange="saveCurrentInputs()">
      </div>

      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="block text-xs text-gray-500 mb-1">ì´ ë§¤ì…ê¸ˆ ($)</label>
          <input type="number" id="input-totalInvested" class="w-full px-3 py-2 border rounded-lg" placeholder="0.00" step="0.01" inputmode="decimal" onchange="saveCurrentInputs()">
        </div>
        <div>
          <label class="block text-xs text-gray-500 mb-1">ë³´ìœ  ìˆ˜ëŸ‰</label>
          <div class="flex gap-1">
            <input type="number" id="input-holdings" class="flex-1 min-w-0 px-3 py-2 border rounded-lg" placeholder="0" inputmode="numeric" onchange="saveCurrentInputs()">
            <button onclick="adjustHoldings(1)" class="quick-add-btn bg-green-100 text-green-700 hover:bg-green-200">+1</button>
            <button onclick="adjustHoldings(3)" class="quick-add-btn bg-green-100 text-green-700 hover:bg-green-200">+3</button>
          </div>
        </div>
      </div>

      <!-- ì˜¤ëŠ˜ ë§¤ìˆ˜ëŸ‰ ì¶”ê°€ -->
      <div id="today-buy-helper" class="hidden bg-blue-50 rounded-lg p-3">
        <div class="flex items-center justify-between">
          <span class="text-sm text-blue-700">
            <i class="fas fa-lightbulb mr-1"></i>ì˜¤ëŠ˜ <span id="today-buy-qty">0</span>ì£¼ ë§¤ìˆ˜?
          </span>
          <button onclick="applyTodayBuy()" class="px-3 py-1 bg-blue-500 text-white rounded-lg text-sm font-medium hover:bg-blue-600">
            <i class="fas fa-plus mr-1"></i>ìˆ˜ëŸ‰ ì¶”ê°€
          </button>
        </div>
      </div>

      <!-- Calculate Button -->
      <button onclick="calculateOrders()" class="w-full touch-target py-4 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl font-semibold text-lg hover:from-blue-600 hover:to-blue-700 transition-all shadow-md">
        <i class="fas fa-calculator mr-2"></i>ì£¼ë¬¸ ê³„ì‚°
      </button>
    </div>

    <!-- Cash Management (Phase 3) - moved into left column -->
    <div class="bg-white rounded-xl p-4 shadow-sm">
      <h3 class="font-medium text-gray-700 mb-3">
        <i class="fas fa-wallet mr-2 text-amber-500"></i>ì˜ˆìˆ˜ê¸ˆ ê´€ë¦¬
      </h3>
      <div class="balance-input">
        <div class="flex-1">
          <label class="block text-xs text-gray-500 mb-1">ì£¼ë¬¸ê°€ëŠ¥ê¸ˆì•¡ (USD)</label>
          <input type="number" id="input-balance" class="w-full px-3 py-2 border rounded-lg" placeholder="0.00" step="0.01" inputmode="decimal">
        </div>
        <button onclick="recalculateBalance()" class="touch-target mt-5 px-3 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600">
          <i class="fas fa-sync-alt"></i>
        </button>
      </div>
      <div id="order-status" class="status-box hidden"></div>
      <div id="stock-breakdown" class="hidden"></div>
    </div>

    </div><!-- END LEFT COLUMN (input-column) -->

    <!-- RIGHT COLUMN: Results (PC: inline, Mobile: overlay) -->
    <div id="results-column" class="hidden lg:block lg:flex-1 lg:min-w-0">
      <!-- PC Results Container -->
      <div id="results-pc" class="hidden lg:block sticky top-4 space-y-4">
        <div class="text-center text-gray-400 py-8">
          <i class="fas fa-calculator text-4xl mb-2"></i>
          <p>ì£¼ë¬¸ ê³„ì‚° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</p>
        </div>
      </div>
    </div>

    <!-- Mobile Results Overlay -->
    <div id="results-overlay" class="fixed inset-0 bg-black/50 z-50 hidden lg:hidden" onclick="closeResultsOverlay()">
      <div class="absolute inset-x-0 bottom-0 top-16 bg-gray-100 rounded-t-2xl overflow-y-auto" onclick="event.stopPropagation()">
        <div class="sticky top-0 bg-white px-4 py-3 border-b flex items-center justify-between shadow-sm">
          <h2 class="font-bold text-gray-800"><i class="fas fa-receipt mr-2"></i>ì£¼ë¬¸ ê²°ê³¼</h2>
          <button onclick="closeResultsOverlay()" class="touch-target text-gray-400 hover:text-gray-600">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
        <div id="results-mobile" class="p-4 space-y-4">
          <!-- Mobile results content -->
        </div>
      </div>
    </div>

    <!-- Results Section (Original - now hidden, used as template) -->
    <div id="results-section" class="hidden space-y-4">

      <!-- Summary Card -->
      <div id="summary-card" class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-xl p-4 text-white">
        <div class="flex items-center justify-between mb-3">
          <div>
            <span id="result-ticker" class="text-2xl font-bold">SOXL</span>
            <span id="result-phase" class="ml-2 px-2 py-0.5 text-xs rounded bg-green-500/30 text-green-300">ì „ë°˜ì „</span>
          </div>
          <div class="text-right">
            <div class="text-xs text-slate-400">Tê°’</div>
            <div id="result-T" class="text-2xl font-bold">15.4</div>
          </div>
        </div>

        <div class="grid grid-cols-3 gap-3 text-center">
          <div class="bg-white/10 rounded-lg p-2">
            <div class="text-xs text-slate-400">ë³„%</div>
            <div id="result-starPercent" class="text-lg font-semibold">2.3%</div>
          </div>
          <div class="bg-white/10 rounded-lg p-2">
            <div class="text-xs text-slate-400">1íšŒë§¤ìˆ˜</div>
            <div id="result-oneTimeBuy" class="text-lg font-semibold">$325</div>
          </div>
          <div class="bg-white/10 rounded-lg p-2">
            <div class="text-xs text-slate-400">LOCê°€</div>
            <div id="result-locPrice" class="text-lg font-semibold">$54.52</div>
          </div>
        </div>

        <div id="result-locReason" class="mt-2 text-xs text-slate-400 text-center">
          ë³„%ê°€ ì„ íƒ (í˜„ì¬ê°€+15% = $57.68)
        </div>
      </div>

      <!-- Buy Orders -->
      <div class="bg-white rounded-xl p-4 shadow-sm">
        <div class="section-header">
          <h3 class="font-medium text-green-600">
            <i class="fas fa-arrow-down mr-2"></i>ë§¤ìˆ˜ ì£¼ë¬¸ <span class="order-badge badge-loc ml-2">ì „ì²´ LOC</span>
          </h3>
          <button onclick="copyAllOrders('buy')" class="copy-btn text-gray-400 hover:text-gray-600 touch-target">
            <i class="fas fa-copy"></i>
          </button>
        </div>
        <div id="buy-orders" class="space-y-3">
          <!-- Dynamic content -->
        </div>
      </div>

      <!-- Sell Orders -->
      <div class="bg-white rounded-xl p-4 shadow-sm">
        <div class="section-header">
          <h3 class="font-medium text-red-600">
            <i class="fas fa-arrow-up mr-2"></i>ë§¤ë„ ì£¼ë¬¸
          </h3>
          <button onclick="copyAllOrders('sell')" class="copy-btn text-gray-400 hover:text-gray-600 touch-target">
            <i class="fas fa-copy"></i>
          </button>
        </div>
        <div id="sell-orders" class="space-y-3">
          <!-- Dynamic content -->
        </div>
      </div>

      <!-- Decline Protection Orders (í•˜ë½ëŒ€ë¹„) -->
      <div id="decline-orders-section" class="hidden bg-white rounded-xl p-4 shadow-sm">
        <div class="section-header">
          <h3 class="font-medium text-blue-600">
            <i class="fas fa-shield-alt mr-2"></i>í•˜ë½ëŒ€ë¹„ <span class="order-badge badge-loc ml-2">ì „ì²´ LOC</span>
          </h3>
          <button onclick="copyAllOrders('decline')" class="copy-btn text-gray-400 hover:text-gray-600 touch-target">
            <i class="fas fa-copy"></i>
          </button>
        </div>
        <div id="decline-orders" class="space-y-2">
          <!-- Dynamic content -->
        </div>
      </div>

      <!-- Quarter Stop Loss Warning -->
      <div id="quarter-stop-loss" class="hidden bg-red-50 border border-red-200 rounded-xl p-4">
        <h3 class="font-bold text-red-700 mb-2">
          <i class="fas fa-exclamation-triangle mr-2"></i>ì¿¼í„°ì†ì ˆ ëª¨ë“œ
        </h3>
        <div id="quarter-stop-loss-content" class="text-sm text-red-600 space-y-1">
          <!-- Dynamic content -->
        </div>
      </div>

    </div>

  </main>

  <!-- Profile Settings Modal -->
  <div id="profile-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-end sm:items-center justify-center" onclick="handleModalBackdrop(event)" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="bg-white w-full sm:w-96 sm:rounded-xl rounded-t-xl max-h-[80vh] overflow-y-auto" onclick="event.stopPropagation()">
      <div class="sticky top-0 bg-white px-4 py-3 border-b flex items-center justify-between">
        <h2 id="modal-title" class="font-bold text-gray-800">í”„ë¡œí•„ ì„¤ì •</h2>
        <button onclick="closeProfileModal()" class="touch-target text-gray-400 hover:text-gray-600" aria-label="ë‹«ê¸°">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="p-4 space-y-4">
        <!-- Profile Info -->
        <div>
          <label class="block text-xs text-gray-500 mb-1">í”„ë¡œí•„ ì´ë¦„</label>
          <input type="text" id="modal-profile-name" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="ì´ë¦„">
        </div>

        <!-- Profile Stocks -->
        <div>
          <label class="block text-xs text-gray-500 mb-2">ë“±ë¡ ì¢…ëª©</label>
          <div id="modal-stocks-list" class="space-y-2">
            <!-- Dynamic content -->
          </div>
          <button onclick="showAddStockForm()" class="mt-2 w-full py-2 border-2 border-dashed border-gray-200 rounded-lg text-gray-400 text-sm hover:border-blue-300 hover:text-blue-500 focus:ring-2 focus:ring-blue-500 focus:outline-none">
            <i class="fas fa-plus mr-1"></i>ì¢…ëª© ì¶”ê°€
          </button>
        </div>

        <!-- Add Stock Form (hidden by default) -->
        <div id="add-stock-form" class="hidden bg-gray-50 rounded-lg p-3 space-y-2">
          <div class="grid grid-cols-2 gap-2">
            <input type="text" id="new-stock-symbol" class="px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="ì¢…ëª©ì½”ë“œ (ì˜ˆ: TQQQ)">
            <input type="number" id="new-stock-principal" class="px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="ì„¸íŒ…ì›ê¸ˆ ($)">
          </div>
          <div class="flex gap-2">
            <button onclick="addNewStock()" class="flex-1 py-2 bg-blue-500 text-white rounded-lg text-sm">ì¶”ê°€</button>
            <button onclick="hideAddStockForm()" class="px-4 py-2 bg-gray-200 rounded-lg text-sm">ì·¨ì†Œ</button>
          </div>
        </div>

        <!-- Google Sync Status (ìƒë‹¨ ë°°ì¹˜) -->
        <div id="google-sync-section" class="bg-gradient-to-r from-blue-50 to-green-50 rounded-lg p-3 border border-blue-100">
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-2">
              <i class="fab fa-google text-blue-500"></i>
              <span id="sheets-user" class="text-sm font-medium text-gray-700 truncate">ë¯¸ì—°ê²°</span>
            </div>
            <span id="sheets-status" class="text-xs px-2 py-0.5 rounded-full bg-gray-200 text-gray-600">ì˜¤í”„ë¼ì¸</span>
          </div>
          <button onclick="handleSheetsPull()" class="w-full py-2 bg-white border border-gray-200 rounded-lg text-sm text-gray-600 hover:bg-gray-50">
            <i class="fas fa-cloud-download-alt mr-1"></i>ì‹œíŠ¸ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
          </button>
        </div>

        <!-- Main Actions -->
        <div class="pt-3 space-y-2">
          <button onclick="syncToCloud()" class="w-full py-3 bg-blue-500 text-white rounded-lg font-medium focus:ring-2 focus:ring-blue-300 focus:outline-none">
            <i class="fas fa-cloud-upload-alt mr-2"></i>í´ë¼ìš°ë“œ ë™ê¸°í™”
          </button>
          <button onclick="importDatFile()" class="w-full py-2 border border-purple-500 text-purple-600 rounded-lg text-sm hover:bg-purple-50">
            <i class="fas fa-file-import mr-1"></i>Genie RPA ë°ì´í„° (.dat) ê°€ì ¸ì˜¤ê¸°
          </button>
          <button onclick="createNewProfile()" class="w-full py-2 border border-green-500 text-green-600 rounded-lg text-sm hover:bg-green-50">
            <i class="fas fa-user-plus mr-1"></i>ìƒˆ í”„ë¡œí•„ ë§Œë“¤ê¸°
          </button>
        </div>

        <!-- Advanced Options (Collapsible) -->
        <details class="pt-2">
          <summary class="cursor-pointer text-xs text-gray-400 hover:text-gray-600 py-2">
            <i class="fas fa-cog mr-1"></i>ê³ ê¸‰ ì˜µì…˜
          </summary>
          <div class="pt-2 space-y-2">
            <div class="grid grid-cols-2 gap-2">
              <button onclick="exportCurrentProfile()" class="py-2 border rounded-lg text-xs text-gray-500 hover:bg-gray-50">
                <i class="fas fa-download mr-1"></i>ë‚´ë³´ë‚´ê¸°
              </button>
              <button onclick="importProfile()" class="py-2 border rounded-lg text-xs text-gray-500 hover:bg-gray-50">
                <i class="fas fa-upload mr-1"></i>ê°€ì ¸ì˜¤ê¸°
              </button>
            </div>
            <button onclick="deleteCurrentProfile()" class="w-full py-2 border border-red-300 text-red-500 rounded-lg text-xs hover:bg-red-50">
              <i class="fas fa-trash mr-1"></i>í”„ë¡œí•„ ì‚­ì œ
            </button>
          </div>
        </details>
      </div>
    </div>
  </div>

  <!-- Toast Notification Container -->
  <div id="toast-container" class="fixed bottom-4 left-4 right-4 z-50 flex flex-col gap-2 pointer-events-none"></div>

  <!-- Footer -->
  <footer class="px-4 py-6 text-center">
    <p class="text-xs text-gray-500">100x IB Helper v4.14.0</p>
    <p class="mt-1 text-xs text-gray-400">Powered by <span class="font-semibold text-rose-500">FENOK</span></p>
  </footer>

  <!-- Scripts -->
  <script src="js/calculator.js"></script>
  <script src="js/profile-manager.js"></script>
  <script src="js/balance-manager.js"></script>
  <script src="js/sheets-sync.js"></script>
  <script>
    // =====================================================
    // State
    // =====================================================

    let selectedTicker = 'SOXL';
    let currentProfile = null;

    // =====================================================
    // Toast Notification System
    // =====================================================

    function showToast(message, type = 'info', duration = 3000) {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;

      const icon = type === 'success' ? 'fa-check-circle' :
                   type === 'error' ? 'fa-exclamation-circle' :
                   type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle';

      toast.innerHTML = `<i class="fas ${icon}"></i><span>${message}</span>`;
      container.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = 'toast-out 0.3s ease-out forwards';
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }

    // =====================================================
    // Modal Helpers
    // =====================================================

    function handleModalBackdrop(event) {
      // Close modal when clicking backdrop
      if (event.target.id === 'profile-modal') {
        closeProfileModal();
      }
    }

    // =====================================================
    // Profile Delete
    // =====================================================

    function deleteCurrentProfile() {
      if (!currentProfile) return;

      const profiles = ProfileManager.getAllProfiles();
      if (profiles.length <= 1) {
        showToast('ë§ˆì§€ë§‰ í”„ë¡œí•„ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'warning');
        return;
      }

      const confirmed = confirm(`"${currentProfile.name}" í”„ë¡œí•„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
      if (!confirmed) return;

      // Save ID to delete
      const profileToDelete = currentProfile.id;

      // First switch to another profile (ProfileManager.delete requires non-active profile)
      const remaining = profiles.filter(p => p.id !== profileToDelete);
      if (remaining.length > 0) {
        ProfileManager.setActive(remaining[0].id);
        currentProfile = ProfileManager.getActive();
        SheetsSync.setCurrentProfile(remaining[0].id);
      }

      // Now delete the profile
      ProfileManager.delete(profileToDelete);

      // Update UI
      updateProfileSelector();
      loadProfileData();
      loadBalanceData();
      closeProfileModal();

      showToast('í”„ë¡œí•„ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    }

    // =====================================================
    // Initialization
    // =====================================================

    document.addEventListener('DOMContentLoaded', () => {
      // Initialize ProfileManager
      currentProfile = ProfileManager.init();

      // Set current profile for SheetsSync (per-profile Sheet storage)
      if (currentProfile) {
        SheetsSync.setCurrentProfile(currentProfile.id);
      }

      // Show today's date
      const today = new Date();
      document.getElementById('today-date').textContent = today.toLocaleDateString('ko-KR', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      });

      // Load profile selector
      updateProfileSelector();

      // Load profile's first ticker or default
      loadProfileData();

      // Load balance data
      loadBalanceData();

      // Auto-calculate on input change (debounced)
      const inputs = document.querySelectorAll('input[type="number"]');
      let debounceTimer;
      inputs.forEach(input => {
        input.addEventListener('input', () => {
          clearTimeout(debounceTimer);
          debounceTimer = setTimeout(() => {
            // Save daily data (except balance input)
            if (input.id !== 'input-balance') {
              saveDailyInputs();
              if (hasRequiredInputs()) {
                calculateOrders();
              }
            } else {
              // Handle balance input
              handleBalanceChange(input.value);
            }
          }, 500);
        });
      });
    });

    // =====================================================
    // Profile Management
    // =====================================================

    function updateProfileSelector() {
      const selector = document.getElementById('profile-selector');
      const profiles = ProfileManager.getAllProfiles();
      const activeId = ProfileManager.getActiveId();
      const emptyState = document.getElementById('empty-state');
      const mainContent = document.getElementById('main-content');

      if (profiles.length === 0) {
        // No profiles - show empty state
        selector.innerHTML = '<option value="">â• í”„ë¡œí•„ì„ ì¶”ê°€í•˜ì„¸ìš”</option>';
        emptyState.classList.remove('hidden');
        mainContent.style.display = 'none';  // inline style override
      } else {
        // Has profiles - show main content
        emptyState.classList.add('hidden');
        mainContent.style.display = '';  // restore default (lg:flex takes over)
        selector.innerHTML = profiles.map(p => `
          <option value="${p.id}" ${p.id === activeId ? 'selected' : ''}>
            ğŸ‘¤ ${p.name}
          </option>
        `).join('');
      }
    }

    function switchProfile(profileId) {
      ProfileManager.setActive(profileId);
      currentProfile = ProfileManager.getActive();

      // Update SheetsSync to use this profile's Sheet
      SheetsSync.setCurrentProfile(profileId);

      loadProfileData();
      loadBalanceData();
      document.getElementById('results-section').classList.add('hidden');
      // Clear balance display on switch
      document.getElementById('order-status').classList.add('hidden');
      document.getElementById('stock-breakdown').classList.add('hidden');
      dismissAlert();
    }

    function loadProfileData() {
      currentProfile = ProfileManager.getActive();
      if (!currentProfile) return;

      // Update ticker buttons based on profile stocks
      updateTickerButtons();

      // Select first stock or default
      const firstStock = currentProfile.stocks[0];
      if (firstStock) {
        selectTicker(firstStock.symbol);
      } else {
        selectTicker('SOXL');
      }
    }

    function updateTickerButtons() {
      const container = document.getElementById('ticker-buttons');
      if (!container) return;

      // Get profile stocks or use defaults (TQQQ, SOXL only - no BITU)
      const stocks = currentProfile?.stocks?.length > 0
        ? currentProfile.stocks
        : [{ symbol: 'TQQQ' }, { symbol: 'SOXL' }];

      container.innerHTML = stocks.map(s => `
        <button onclick="selectTicker('${s.symbol}')"
                class="ticker-btn touch-target py-3 rounded-lg text-center font-semibold transition-all bg-gray-100 text-gray-600 hover:bg-blue-100"
                data-ticker="${s.symbol}">
          ${s.symbol}
        </button>
      `).join('');
    }

    // =====================================================
    // Profile Modal
    // =====================================================

    function showProfileSettings() {
      const modal = document.getElementById('profile-modal');
      modal.classList.remove('hidden');

      // Load current profile data
      currentProfile = ProfileManager.getActive();
      document.getElementById('modal-profile-name').value = currentProfile?.name || '';

      // Load stocks list
      updateModalStocksList();
    }

    function closeProfileModal() {
      document.getElementById('profile-modal').classList.add('hidden');
      document.getElementById('add-stock-form').classList.add('hidden');
    }

    function updateModalStocksList() {
      const container = document.getElementById('modal-stocks-list');
      const stocks = currentProfile?.stocks || [];

      if (stocks.length === 0) {
        container.innerHTML = '<p class="text-sm text-gray-400 text-center py-2">ë“±ë¡ëœ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤</p>';
        return;
      }

      container.innerHTML = stocks.map(s => `
        <div class="flex items-center justify-between bg-gray-50 rounded-lg px-3 py-2">
          <div>
            <span class="font-medium">${s.symbol}</span>
            <span class="text-xs text-gray-500 ml-2">$${(s.principal || 0).toLocaleString()}</span>
          </div>
          <button onclick="removeStockFromProfile('${s.symbol}')" class="text-red-400 hover:text-red-600">
            <i class="fas fa-trash-alt"></i>
          </button>
        </div>
      `).join('');
    }

    function showAddStockForm() {
      document.getElementById('add-stock-form').classList.remove('hidden');
    }

    function hideAddStockForm() {
      document.getElementById('add-stock-form').classList.add('hidden');
      document.getElementById('new-stock-symbol').value = '';
      document.getElementById('new-stock-principal').value = '';
    }

    function addNewStock() {
      const symbol = document.getElementById('new-stock-symbol').value.toUpperCase().trim();
      const principal = parseFloat(document.getElementById('new-stock-principal').value) || 0;

      if (!symbol) {
        showToast('ì¢…ëª©ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'warning');
        return;
      }

      const sellPercent = symbol === 'TQQQ' ? 10 : 12;
      ProfileManager.addStock(currentProfile.id, { symbol, principal, sellPercent });
      currentProfile = ProfileManager.getActive();

      hideAddStockForm();
      updateModalStocksList();
    }

    function removeStockFromProfile(symbol) {
      if (confirm(`${symbol} ì¢…ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        ProfileManager.removeStock(currentProfile.id, symbol);
        currentProfile = ProfileManager.getActive();
        updateModalStocksList();
      }
    }

    /**
     * ğŸ”´ í´ë¼ìš°ë“œ ë™ê¸°í™” (v4.12.0)
     * - ë¡œì»¬ ì €ì¥ì€ onchangeì—ì„œ ìë™ ì²˜ë¦¬ë¨
     * - ì´ ë²„íŠ¼ì€ í´ë¼ìš°ë“œ(Google Sheets) ë™ê¸°í™”ë§Œ ë‹´ë‹¹
     */
    async function syncToCloud() {
      // 1. í˜„ì¬ ì…ë ¥ê°’ ìµœì¢… ì €ì¥ (í˜¹ì‹œ ëª¨ë¥¼ ë¯¸ì €ì¥ ë°ì´í„°)
      saveCurrentInputs();

      // 2. í”„ë¡œí•„ ì´ë¦„ ì—…ë°ì´íŠ¸
      const name = document.getElementById('modal-profile-name').value.trim();
      if (name && currentProfile) {
        ProfileManager.update(currentProfile.id, { name });
        currentProfile = ProfileManager.getActive();
      }

      // 3. Google Sheets ë™ê¸°í™”
      if (!SheetsSync.isAuthenticated()) {
        showToast('Google ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤', 'warning');
        // ë¡œê·¸ì¸ ì‹œë„
        try {
          await initSheets();
          if (!SheetsSync.isAuthenticated()) {
            return;
          }
        } catch (e) {
          return;
        }
      }

      try {
        showToast('ì‹œíŠ¸ ë™ê¸°í™” ì¤‘...', 'info', 2000);
        await SheetsSync.push();
        showToast('í´ë¼ìš°ë“œ ë™ê¸°í™” ì™„ë£Œ!', 'success');
      } catch (error) {
        console.error('Sync error:', error);
        showToast('ë™ê¸°í™” ì‹¤íŒ¨: ' + error.message, 'error');
      }

      updateProfileSelector();
      closeProfileModal();
    }

    /**
     * í”„ë¡œí•„ ì„¤ì • ì €ì¥ (ì´ë¦„ë§Œ - ë ˆê±°ì‹œ í˜¸í™˜)
     */
    async function saveProfileSettings() {
      const name = document.getElementById('modal-profile-name').value.trim();
      if (!name) {
        showToast('í”„ë¡œí•„ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”', 'warning');
        return;
      }
      ProfileManager.update(currentProfile.id, { name });
      currentProfile = ProfileManager.getActive();
      showToast('í”„ë¡œí•„ ì´ë¦„ ì €ì¥ë¨', 'success');
      updateProfileSelector();
    }

    /**
     * Quick Start - Google ë¡œê·¸ì¸ â†’ ì‹œíŠ¸ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
     */
    async function quickStart() {
      try {
        // 1. Google ë¡œê·¸ì¸
        showToast('Google ë¡œê·¸ì¸ ì¤‘...', 'info');
        await initSheets();

        const userEmail = SheetsSync.getUserEmail();
        if (!userEmail) {
          showToast('ë¡œê·¸ì¸ ì‹¤íŒ¨', 'error');
          return;
        }

        showToast(`${userEmail} ë¡œê·¸ì¸ ì™„ë£Œ`, 'success');

        // 2. í”„ë¡œí•„ ìƒì„± (ì´ë©”ì¼ ê¸°ë°˜)
        const profileName = userEmail.split('@')[0]; // ì´ë©”ì¼ ì•ë¶€ë¶„ì„ í”„ë¡œí•„ëª…ìœ¼ë¡œ
        let profileId = profileName;

        // ì´ë¯¸ ì¡´ì¬í•˜ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ìƒì„±
        const existing = ProfileManager.getAll();
        if (!existing.profiles[profileId]) {
          profileId = ProfileManager.create(profileName, '');
        }

        ProfileManager.setActive(profileId);
        currentProfile = ProfileManager.getActive();
        SheetsSync.setCurrentProfile(profileId);

        // 3. ì‹œíŠ¸ì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹œë„
        try {
          const pulled = await SheetsSync.pull();
          if (pulled.length > 0) {
            showToast(`${pulled.length}ê°œ ì¢…ëª© ë¶ˆëŸ¬ì˜´`, 'success');
          } else {
            showToast('ì‹œíŠ¸ì— ë°ì´í„° ì—†ìŒ - ì¢…ëª© ì¶”ê°€í•˜ì„¸ìš”', 'info');
          }
        } catch (pullError) {
          console.warn('Pull failed (may be first time):', pullError);
          showToast('ìƒˆ ì‚¬ìš©ì - ì¢…ëª©ì„ ì¶”ê°€í•˜ì„¸ìš”', 'info');
        }

        // 4. UI ì—…ë°ì´íŠ¸
        updateProfileSelector();
        loadProfileData();
        loadBalanceData();

        // 5. Sheets ìƒíƒœ í‘œì‹œ
        const userEl = document.getElementById('sheets-user');
        const statusEl = document.getElementById('sheets-status');
        if (userEl) {
          userEl.textContent = userEmail;
          userEl.classList.remove('hidden');
        }
        if (statusEl) {
          statusEl.textContent = 'ì—°ê²°ë¨';
          statusEl.className = 'text-xs text-green-600';
        }

      } catch (error) {
        console.error('Quick start error:', error);
        showToast('ì‹œì‘ ì‹¤íŒ¨: ' + error.message, 'error');

        // í´ë°±: ìˆ˜ë™ í”„ë¡œí•„ ìƒì„±
        const name = prompt('Google ì—°ë™ ì‹¤íŒ¨. í”„ë¡œí•„ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', 'ë‚´ í”„ë¡œí•„');
        if (name) {
          const newId = ProfileManager.create(name, '');
          ProfileManager.setActive(newId);
          currentProfile = ProfileManager.getActive();
          updateProfileSelector();
          loadProfileData();
          loadBalanceData();
        }
      }
    }

    /**
     * ë¡œê·¸ì¸ ì—†ì´ ì‹œì‘ (ë¡œì»¬ ì „ìš©)
     */
    function quickStartOffline() {
      const name = prompt('í”„ë¡œí•„ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', 'ë‚´ í”„ë¡œí•„');
      if (!name) return;

      const newId = ProfileManager.create(name, '');
      ProfileManager.setActive(newId);
      currentProfile = ProfileManager.getActive();

      updateProfileSelector();
      loadProfileData();
      loadBalanceData();
      showToast('ë¡œì»¬ í”„ë¡œí•„ ìƒì„± ì™„ë£Œ', 'success');
    }

    function createNewProfile() {
      const name = prompt('ìƒˆ í”„ë¡œí•„ ì´ë¦„:');
      if (!name) return;

      const newId = ProfileManager.create(name, '');
      ProfileManager.setActive(newId);
      currentProfile = ProfileManager.getActive();

      // Update SheetsSync to use new profile's Sheet
      SheetsSync.setCurrentProfile(newId);

      updateProfileSelector();
      loadProfileData();
      loadBalanceData();
      closeProfileModal();
    }

    function exportCurrentProfile() {
      const json = ProfileManager.exportProfile(currentProfile.id);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = `ib-profile-${currentProfile.id}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function importProfile() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (ev) => {
          const newId = ProfileManager.importProfile(ev.target.result);
          if (newId) {
            ProfileManager.setActive(newId);
            updateProfileSelector();
            loadProfileData();
            closeProfileModal();
            showToast('í”„ë¡œí•„ì„ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤', 'success');
          } else {
            showToast('í”„ë¡œí•„ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨', 'error');
          }
        };
        reader.readAsText(file);
      };
      input.click();
    }

    // =====================================================
    // Genie RPA .dat File Import
    // =====================================================

    /**
     * Parse Genie RPA .dat file format
     * Format: 0|SYMBOL|PRINCIPAL|STAR%|T%|VERSION|DIVISIONS|QTY|?|?
     * Example: 0|SOXL|16000|12%|6%|V2.2|40||0|0
     */
    function parseDatFile(content) {
      const lines = content.split(/\r?\n/).filter(line => line.trim());
      const stocks = [];

      for (const line of lines) {
        const parts = line.split('|');
        if (parts.length < 7) continue;

        const symbol = parts[1]?.trim();
        if (!symbol) continue;

        const principal = parseFloat(parts[2]) || 0;
        const starPercent = parseFloat(parts[3]?.replace('%', '')) || 0;
        const tPercent = parseFloat(parts[4]?.replace('%', '')) || 0;
        const divisions = parseInt(parts[6]) || 40;

        // Determine sellPercent based on symbol
        const sellPercent = symbol === 'TQQQ' ? 10 : 12;

        stocks.push({
          symbol,
          principal,
          sellPercent,
          starPercent,  // For reference
          tPercent,     // For reference
          divisions
        });
      }

      return stocks;
    }

    function importDatFile() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.dat,.txt';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (ev) => {
          try {
            const content = ev.target.result;
            const stocks = parseDatFile(content);

            if (stocks.length === 0) {
              alert('íŒŒì¼ì—ì„œ ì¢…ëª© ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
              return;
            }

            // Ask user what to do
            const action = confirm(
              `${stocks.length}ê°œ ì¢…ëª©ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤:\n` +
              stocks.map(s => `  â€¢ ${s.symbol}: $${s.principal.toLocaleString()}`).join('\n') +
              `\n\ní˜„ì¬ í”„ë¡œí•„ì— ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n` +
              `[í™•ì¸] = í˜„ì¬ í”„ë¡œí•„ì— ì¶”ê°€\n` +
              `[ì·¨ì†Œ] = ìƒˆ í”„ë¡œí•„ë¡œ ìƒì„±`
            );

            if (action && currentProfile) {
              // Replace current profile stocks (ê¸°ì¡´ ì¢…ëª© ì‚­ì œ í›„ ìƒˆ ì¢…ëª©ìœ¼ë¡œ êµì²´)
              // 1. ê¸°ì¡´ ì¢…ëª© ëª¨ë‘ ì‚­ì œ
              const existingStocks = [...(currentProfile.stocks || [])];
              existingStocks.forEach(s => {
                ProfileManager.removeStock(currentProfile.id, s.symbol);
              });
              // 2. ìƒˆ ì¢…ëª© ì¶”ê°€
              stocks.forEach(stock => {
                ProfileManager.addStock(currentProfile.id, stock);
              });
              currentProfile = ProfileManager.getActive();
              updateModalStocksList();
              updateTickerButtons();
              showToast(`${stocks.length}ê°œ ì¢…ëª©ìœ¼ë¡œ êµì²´ë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
            } else {
              // Create new profile
              const name = prompt('ìƒˆ í”„ë¡œí•„ ì´ë¦„:', file.name.replace('.dat', ''));
              if (!name) return;

              const newId = ProfileManager.create(name, '');
              stocks.forEach(stock => {
                ProfileManager.addStock(newId, stock);
              });
              ProfileManager.setActive(newId);
              currentProfile = ProfileManager.getActive();
              SheetsSync.setCurrentProfile(newId);

              updateProfileSelector();
              loadProfileData();
              closeProfileModal();
              alert(`ìƒˆ í”„ë¡œí•„ "${name}"ì´(ê°€) ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤`);
            }
          } catch (error) {
            console.error('DAT file parse error:', error);
            alert('íŒŒì¼ íŒŒì‹± ì˜¤ë¥˜: ' + error.message);
          }
        };
        reader.readAsText(file);
      };
      input.click();
    }

    // =====================================================
    // Daily Data Persistence
    // =====================================================

    /**
     * ğŸ”´ ëª¨ë“  í˜„ì¬ ì…ë ¥ê°’ ì €ì¥ (v4.12.0)
     * - dailyData (í‰ë‹¨ê°€, ì´ë§¤ì…ê¸ˆ, ìˆ˜ëŸ‰)
     * - stock settings (ì„¸íŒ…ì›ê¸ˆ, ë§¤ë„%)
     * - ìë™ ì €ì¥ í”¼ë“œë°± í‘œì‹œ
     */
    function saveCurrentInputs() {
      if (!currentProfile || !selectedTicker) return;

      // 1. Daily data ì €ì¥
      saveDailyInputs();

      // 2. Stock settings ì €ì¥ (ì„¸íŒ…ì›ê¸ˆ, ë§¤ë„%)
      const principal = parseFloat(document.getElementById('input-principal').value) || 0;
      const sellPercent = parseFloat(document.getElementById('input-sellPercent').value) || 12;

      ProfileManager.addStock(currentProfile.id, {
        symbol: selectedTicker,
        principal: principal,
        sellPercent: sellPercent
      });

      // 3. ìë™ ì €ì¥ í”¼ë“œë°± (ì§§ì€ í† ìŠ¤íŠ¸)
      showToast('âœ“ ìë™ ì €ì¥ë¨', 'success', 800);

      console.log(`saveCurrentInputs: ${selectedTicker} principal=${principal}, sellPercent=${sellPercent}`);
    }

    function saveDailyInputs() {
      if (!currentProfile || !selectedTicker) return;

      const data = {
        avgPrice: parseFloat(document.getElementById('input-avgPrice').value) || 0,
        totalInvested: parseFloat(document.getElementById('input-totalInvested').value) || 0,
        holdings: parseInt(document.getElementById('input-holdings').value) || 0
      };

      ProfileManager.saveDailyData(currentProfile.id, selectedTicker, data);
      console.log(`saveDailyInputs: ${selectedTicker}`, data);
    }

    function loadDailyInputs() {
      if (!currentProfile) return;

      // ğŸ”´ v4.14.0: ë¨¼ì € í•„ë“œ ì´ˆê¸°í™” (ì¢…ëª© ê°„ ë°ì´í„° ê³µìœ  ë²„ê·¸ ìˆ˜ì •)
      document.getElementById('input-avgPrice').value = '';
      document.getElementById('input-totalInvested').value = '';
      document.getElementById('input-holdings').value = '';

      const data = ProfileManager.loadDailyData(currentProfile.id, selectedTicker);
      if (data) {
        if (data.avgPrice) document.getElementById('input-avgPrice').value = data.avgPrice;
        if (data.totalInvested) document.getElementById('input-totalInvested').value = data.totalInvested;
        if (data.holdings) document.getElementById('input-holdings').value = data.holdings;
      }
    }

    // =====================================================
    // Ticker Selection
    // =====================================================

    function selectTicker(ticker) {
      // ğŸ”´ ì¢…ëª© ì „í™˜ ì „ì— í˜„ì¬ ì…ë ¥ê°’ ì €ì¥ (v4.11.0 ë²„ê·¸ ìˆ˜ì •)
      if (selectedTicker && selectedTicker !== ticker) {
        saveCurrentInputs();
      }

      selectedTicker = ticker;

      // Update UI
      document.querySelectorAll('.ticker-btn').forEach(btn => {
        const isSelected = btn.dataset.ticker === ticker;
        btn.classList.toggle('bg-blue-500', isSelected);
        btn.classList.toggle('text-white', isSelected);
        btn.classList.toggle('bg-gray-100', !isSelected);
        btn.classList.toggle('text-gray-600', !isSelected);
      });

      // Load stock settings from profile
      const stock = ProfileManager.getStock(ticker);
      if (stock) {
        document.getElementById('input-principal').value = stock.principal || 13000;
        document.getElementById('input-sellPercent').value = stock.sellPercent || IBCalculator.getSellPercent(ticker);
      } else {
        // Default values
        document.getElementById('input-sellPercent').value = IBCalculator.getSellPercent(ticker);
      }

      // Load saved daily inputs
      loadDailyInputs();

      // Hide results when switching
      document.getElementById('results-section').classList.add('hidden');
    }

    // =====================================================
    // Current Price Fetch (100xFenok Ticker API)
    // =====================================================

    /**
     * ì¬ê³„ì‚° ë²„íŠ¼
     */
    function recalculate() {
      if (hasRequiredInputs()) {
        calculateOrders();
        showToast('ê³„ì‚° ì™„ë£Œ', 'success', 1500);
      } else {
        showToast('í‰ë‹¨ê°€ì™€ ì„¸íŒ…ì›ê¸ˆì„ ì…ë ¥í•˜ì„¸ìš”', 'warning');
      }
    }

    // =====================================================
    // Holdings Quick Adjust (UX Enhancement)
    // =====================================================

    /**
     * ë³´ìœ  ìˆ˜ëŸ‰ ë¹ ë¥¸ ì¡°ì • (+ë²„íŠ¼)
     */
    function adjustHoldings(amount) {
      const input = document.getElementById('input-holdings');
      const current = parseInt(input.value) || 0;
      input.value = current + amount;

      // Trigger save and recalculate
      saveDailyInputs();
      if (hasRequiredInputs()) {
        calculateOrders();
      }

      // Visual feedback
      input.classList.add('ring-2', 'ring-green-400');
      setTimeout(() => input.classList.remove('ring-2', 'ring-green-400'), 300);
    }

    /**
     * ì˜¤ëŠ˜ ë§¤ìˆ˜ëŸ‰ í—¬í¼ í‘œì‹œ
     */
    function showTodayBuyHelper(quantity) {
      const helper = document.getElementById('today-buy-helper');
      const qtySpan = document.getElementById('today-buy-qty');

      if (quantity > 0) {
        helper.classList.remove('hidden');
        qtySpan.textContent = quantity;
      } else {
        helper.classList.add('hidden');
      }
    }

    /**
     * ì˜¤ëŠ˜ ë§¤ìˆ˜ëŸ‰ì„ ìˆ˜ëŸ‰ì— ì¶”ê°€
     */
    function applyTodayBuy() {
      if (!lastCalculation) return;

      const mainBuyOrders = lastCalculation.buyOrders.filter(o => !o.type.includes('í•˜ë½ëŒ€ë¹„'));
      const totalBuyQty = mainBuyOrders.reduce((sum, o) => sum + o.quantity, 0);

      // 1. ìˆ˜ëŸ‰ ì¶”ê°€ (adjustHoldings ë‚´ë¶€ì—ì„œ saveDailyInputs í˜¸ì¶œ)
      adjustHoldings(totalBuyQty);

      // 2. ì´ë§¤ì…ê¸ˆ ì—…ë°ì´íŠ¸
      const totalAmount = mainBuyOrders.reduce((sum, o) => sum + (o.price * o.quantity), 0);
      const investedInput = document.getElementById('input-totalInvested');
      const currentInvested = parseFloat(investedInput.value) || 0;
      investedInput.value = (currentInvested + totalAmount).toFixed(2);

      // ğŸ”´ v4.14.0: totalInvested ë³€ê²½ í›„ ì €ì¥ (ë²„ê·¸ ìˆ˜ì •)
      saveDailyInputs();

      // Hide helper
      document.getElementById('today-buy-helper').classList.add('hidden');

      // Show feedback
      alert(`âœ… ìˆ˜ëŸ‰ +${totalBuyQty}ì£¼, ë§¤ì…ê¸ˆ +$${totalAmount.toFixed(2)} ì¶”ê°€ë¨\n\në‚´ì¼ ë‹¤ì‹œ ê³„ì‚°í•˜ì„¸ìš”!`);
    }

    // =====================================================
    // Copy Functions (UX Enhancement)
    // =====================================================

    /**
     * ê°œë³„ ì£¼ë¬¸ ë³µì‚¬
     */
    function copyOrder(btn, price, quantity) {
      const text = `$${price} / ${quantity}ì£¼`;
      navigator.clipboard.writeText(text).then(() => {
        btn.innerHTML = '<i class="fas fa-check mr-1"></i>ë³µì‚¬ë¨';
        btn.classList.add('copied');
        setTimeout(() => {
          btn.innerHTML = '<i class="fas fa-copy mr-1"></i>ë³µì‚¬';
          btn.classList.remove('copied');
        }, 1500);
      });
    }

    /**
     * ì „ì²´ ì£¼ë¬¸ ë³µì‚¬ (ì„¹ì…˜ë³„)
     */
    function copyAllOrders(type) {
      if (!lastCalculation) return;

      let orders = [];
      let title = '';

      if (type === 'buy') {
        orders = lastCalculation.buyOrders.filter(o => !o.type.includes('í•˜ë½ëŒ€ë¹„'));
        title = 'ğŸ“‰ ë§¤ìˆ˜ ì£¼ë¬¸ (LOC)';
      } else if (type === 'sell') {
        orders = lastCalculation.sellOrders;
        title = 'ğŸ“ˆ ë§¤ë„ ì£¼ë¬¸';
      } else if (type === 'decline') {
        orders = lastCalculation.buyOrders.filter(o => o.type.includes('í•˜ë½ëŒ€ë¹„'));
        title = 'ğŸ›¡ï¸ í•˜ë½ëŒ€ë¹„ (LOC)';
      }

      const lines = [
        `${title}`,
        `â”â”â”â”â”â”â”â”â”â”â”â”â”â”`,
        ...orders.map(o => `${o.type}: $${o.price.toFixed(2)} Ã— ${o.quantity}ì£¼`)
      ];

      const text = lines.join('\n');
      navigator.clipboard.writeText(text).then(() => {
        showToast('í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
      });
    }

    // =====================================================
    // Calculate Orders
    // =====================================================

    function hasRequiredInputs() {
      const avgPrice = parseFloat(document.getElementById('input-avgPrice').value);
      const principal = parseFloat(document.getElementById('input-principal').value);
      // í˜„ì¬ê°€ëŠ” ì„ íƒ - ì—†ìœ¼ë©´ ë³„%ê°€ë§Œ ì‚¬ìš©
      return avgPrice > 0 && principal > 0;
    }

    function calculateOrders() {
      // Gather inputs
      const input = {
        ticker: selectedTicker,
        principal: parseFloat(document.getElementById('input-principal').value) || 0,
        divisions: parseInt(document.getElementById('input-divisions').value) || 40,
        avgPrice: parseFloat(document.getElementById('input-avgPrice').value) || 0,
        totalInvested: parseFloat(document.getElementById('input-totalInvested').value) || 0,
        holdings: parseInt(document.getElementById('input-holdings').value) || 0,
        currentPrice: 0  // UIì—ì„œ ì œê±°ë¨ - LOC ìº¡ì€ ì‚¬ìš© ì•ˆí•¨
      };

      // Validate - í•„ìˆ˜ ì…ë ¥ê°’ ì²´í¬ (í˜„ì¬ê°€ëŠ” ì„ íƒ - LOC ìº¡ì—ë§Œ ì‚¬ìš©)
      const missing = [];
      if (!input.principal) missing.push('ì„¸íŒ…ì›ê¸ˆ');
      if (!input.avgPrice) missing.push('í‰ë‹¨ê°€');

      if (missing.length > 0) {
        alert(`í•„ìˆ˜ ì…ë ¥ê°’ì´ ì—†ìŠµë‹ˆë‹¤:\nâ€¢ ${missing.join('\nâ€¢ ')}`);
        return;
      }

      // Calculate
      const result = IBCalculator.calculate(input);

      if (result.error) {
        alert(result.error);
        return;
      }

      // Display results
      displayResults(result);
    }

    // =====================================================
    // Display Results
    // =====================================================

    // Store last calculation for copy/helper features
    let lastCalculation = null;

    function displayResults(result) {
      const { calculation, buyOrders, sellOrders, quarterStopLoss } = result;
      lastCalculation = result;

      // Show results section
      document.getElementById('results-section').classList.remove('hidden');

      // Summary card
      document.getElementById('result-ticker').textContent = result.ticker;
      document.getElementById('result-T').textContent = calculation.T.toFixed(1);
      document.getElementById('result-starPercent').textContent = calculation.starPercent.toFixed(1) + '%';
      document.getElementById('result-oneTimeBuy').textContent = IBCalculator.formatDollar(calculation.oneTimeBuy);
      document.getElementById('result-locPrice').textContent = IBCalculator.formatDollar(calculation.locInfo.locPrice);

      // Phase badge
      const phaseBadge = document.getElementById('result-phase');
      phaseBadge.textContent = calculation.phase;
      phaseBadge.className = 'ml-2 px-2 py-0.5 text-xs rounded';
      if (calculation.phase === 'ì „ë°˜ì „') {
        phaseBadge.classList.add('bg-green-500/30', 'text-green-300');
      } else if (calculation.phase === 'í›„ë°˜ì „') {
        phaseBadge.classList.add('bg-yellow-500/30', 'text-yellow-300');
      } else {
        phaseBadge.classList.add('bg-red-500/30', 'text-red-300');
      }

      // LOC reason
      const locReason = document.getElementById('result-locReason');
      if (calculation.locInfo.currentPriceCap > 0) {
        locReason.textContent = `${calculation.locInfo.reason} (ë³„%ê°€ = ${IBCalculator.formatDollar(calculation.locInfo.starPrice)}, í˜„ì¬ê°€Ã—1.15 = ${IBCalculator.formatDollar(calculation.locInfo.currentPriceCap)})`;
      } else {
        locReason.textContent = `${calculation.locInfo.reason}`;
      }

      // Separate main buy orders and decline orders
      const mainBuyOrders = buyOrders.filter(o => !o.type.includes('í•˜ë½ëŒ€ë¹„'));
      const declineOrders = buyOrders.filter(o => o.type.includes('í•˜ë½ëŒ€ë¹„'));

      // Buy orders (main)
      const buyOrdersEl = document.getElementById('buy-orders');
      buyOrdersEl.innerHTML = mainBuyOrders.map(order => renderOrderCard(order, 'buy')).join('');

      // Decline orders (í•˜ë½ëŒ€ë¹„)
      const declineSection = document.getElementById('decline-orders-section');
      const declineOrdersEl = document.getElementById('decline-orders');
      if (declineOrders.length > 0) {
        declineSection.classList.remove('hidden');
        declineOrdersEl.innerHTML = declineOrders.map(order => renderDeclineOrderCard(order)).join('');
      } else {
        declineSection.classList.add('hidden');
      }

      // Sell orders
      const sellOrdersEl = document.getElementById('sell-orders');
      if (quarterStopLoss.active) {
        sellOrdersEl.innerHTML = '<p class="text-gray-500 text-sm">ì¿¼í„°ì†ì ˆ ëª¨ë“œ - ì•„ë˜ ì•ˆë‚´ ì°¸ì¡°</p>';
      } else {
        sellOrdersEl.innerHTML = sellOrders.map(order => renderOrderCard(order, 'sell')).join('');
      }

      // Quarter stop loss warning
      const qslSection = document.getElementById('quarter-stop-loss');
      if (quarterStopLoss.active) {
        qslSection.classList.remove('hidden');
        document.getElementById('quarter-stop-loss-content').innerHTML = `
          <p><strong>MOC ë§¤ë„ ìˆ˜ëŸ‰:</strong> ${quarterStopLoss.mocQuantity}ì£¼</p>
          <ul class="list-disc pl-5 mt-2">
            ${quarterStopLoss.instructions.map(i => `<li>${i}</li>`).join('')}
          </ul>
        `;
      } else {
        qslSection.classList.add('hidden');
      }

      // Show today buy helper
      const totalBuyQty = mainBuyOrders.reduce((sum, o) => sum + o.quantity, 0);
      showTodayBuyHelper(totalBuyQty);

      // Display results based on screen size (PC vs Mobile)
      showResultsResponsive();
    }

    /**
     * PC/Mobile ë°˜ì‘í˜• ê²°ê³¼ í‘œì‹œ
     */
    function showResultsResponsive() {
      const resultsSection = document.getElementById('results-section');
      const resultsPC = document.getElementById('results-pc');
      const resultsMobile = document.getElementById('results-mobile');
      const resultsOverlay = document.getElementById('results-overlay');
      const resultsColumn = document.getElementById('results-column');

      // Check if PC (lg breakpoint = 1024px)
      const isPC = window.innerWidth >= 1024;

      if (isPC) {
        // PC: Show in right column
        resultsPC.innerHTML = resultsSection.innerHTML;
        resultsColumn.classList.remove('hidden');
        resultsPC.querySelector('.text-center.text-gray-400')?.remove(); // Remove placeholder
      } else {
        // Mobile: Show in overlay
        resultsMobile.innerHTML = resultsSection.innerHTML;
        resultsOverlay.classList.remove('hidden');
        document.body.style.overflow = 'hidden'; // Prevent background scroll
      }
    }

    /**
     * ëª¨ë°”ì¼ ê²°ê³¼ ì˜¤ë²„ë ˆì´ ë‹«ê¸°
     */
    function closeResultsOverlay() {
      document.getElementById('results-overlay').classList.add('hidden');
      document.body.style.overflow = ''; // Restore scroll
    }

    function renderOrderCard(order, type) {
      const isLOC = order.orderType === 'LOC';
      const badgeClass = isLOC ? 'badge-loc' : 'badge-limit';
      const badgeText = isLOC ? 'LOC' : 'ì§€ì •ê°€';

      return `
        <div class="order-card-enhanced ${type}" data-price="${order.price}" data-qty="${order.quantity}">
          <div class="flex justify-between items-start">
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-1">
                <span class="order-badge ${badgeClass}">${badgeText}</span>
                <span class="text-sm font-medium text-gray-700">${order.type}</span>
              </div>
              <div class="text-xs text-gray-500">${order.description}</div>
            </div>
            <div class="text-right">
              <div class="main-value text-gray-800">${IBCalculator.formatDollar(order.price)}</div>
              <div class="sub-value">${order.quantity}ì£¼</div>
            </div>
          </div>
          <div class="mt-3 flex items-center justify-between">
            <div class="text-xs text-gray-400">
              ${order.amount ? 'ì˜ˆìƒ ' + IBCalculator.formatDollar(order.amount) : ''}
            </div>
            <button onclick="copyOrder(this, '${order.price}', ${order.quantity})" class="copy-btn touch-target px-2 py-1 text-xs text-gray-500 hover:text-gray-700 rounded">
              <i class="fas fa-copy mr-1"></i>ë³µì‚¬
            </button>
          </div>
        </div>
      `;
    }

    // í•˜ë½ëŒ€ë¹„ ì „ìš© ë Œë”ë§ (ë” ê°„ê²°í•˜ê²Œ)
    function renderDeclineOrderCard(order) {
      return `
        <div class="order-card-enhanced decline" data-price="${order.price}" data-qty="${order.quantity}">
          <div class="flex justify-between items-center">
            <div>
              <span class="order-badge badge-loc mr-2">LOC</span>
              <span class="text-sm text-gray-600">${order.description}</span>
            </div>
            <div class="flex items-center gap-3">
              <div class="text-right">
                <span class="font-bold text-gray-800">${IBCalculator.formatDollar(order.price)}</span>
                <span class="text-gray-500 text-sm ml-1">${order.quantity}ì£¼</span>
              </div>
              <button onclick="copyOrder(this, '${order.price}', ${order.quantity})" class="copy-btn text-gray-400 hover:text-gray-600">
                <i class="fas fa-copy"></i>
              </button>
            </div>
          </div>
        </div>
      `;
    }

    // =====================================================
    // Balance Management (Phase 3)
    // =====================================================

    function loadBalanceData() {
      if (!currentProfile) return;

      const balance = BalanceManager.getBalance(currentProfile.id);
      const balanceInput = document.getElementById('input-balance');
      if (balance.available > 0) {
        balanceInput.value = balance.available;
        recalculateBalance();
      }
    }

    function handleBalanceChange(value) {
      if (!currentProfile) return;

      BalanceManager.updateBalance(currentProfile.id, value);
      recalculateBalance();
    }

    function recalculateBalance() {
      if (!currentProfile) return;

      // Save current balance value
      const balanceValue = parseFloat(document.getElementById('input-balance').value) || 0;
      if (balanceValue > 0) {
        BalanceManager.updateBalance(currentProfile.id, balanceValue);
      }

      // Recalculate
      const status = BalanceManager.calcOrderStatus(currentProfile);
      renderOrderStatus(status);
      checkAndShowAlert();
    }

    function renderOrderStatus(status) {
      const statusBox = document.getElementById('order-status');
      const breakdownBox = document.getElementById('stock-breakdown');

      // Only show if balance is set
      if (status.available <= 0 && status.required <= 0) {
        statusBox.classList.add('hidden');
        breakdownBox.classList.add('hidden');
        return;
      }

      statusBox.classList.remove('hidden');
      const statusClass = status.status === 'OK' ? 'status-ok' : 'status-warning';
      const statusIcon = status.status === 'OK' ? 'âœ…' : 'âš ï¸';

      statusBox.innerHTML = `
        <div class="status-row">
          <span class="text-gray-600">ì¼ë§¤ìˆ˜ì‹œë„ê¸ˆì•¡</span>
          <span class="font-medium">$${status.required.toFixed(2)}</span>
        </div>
        <div class="status-row">
          <span class="text-gray-600">ì£¼ë¬¸ê°€ëŠ¥ê¸ˆì•¡</span>
          <span class="font-medium">$${status.available.toFixed(2)}</span>
        </div>
        <hr class="my-1 border-gray-200">
        <div class="status-row ${statusClass}">
          <span>ì°¨ì•¡</span>
          <span>${status.diff >= 0 ? '+' : ''}$${status.diff.toFixed(2)} ${statusIcon} ${status.statusKo}</span>
        </div>
      `;

      // Stock breakdown
      if (status.details && status.details.length > 0) {
        breakdownBox.classList.remove('hidden');
        renderStockBreakdown(status.details, status.required);
      } else {
        breakdownBox.classList.add('hidden');
      }
    }

    function renderStockBreakdown(details, total) {
      const container = document.getElementById('stock-breakdown');

      let html = '<table class="breakdown-table">';
      html += '<thead><tr><th>ì¢…ëª©</th><th>1íšŒë§¤ìˆ˜</th><th>í•˜ë½ëŒ€ë¹„</th><th>í•©ê³„</th><th>ë¹„ìœ¨</th></tr></thead>';
      html += '<tbody>';

      details.forEach(d => {
        const barWidth = Math.min(d.percentage, 100);
        html += `
          <tr>
            <td class="font-medium">${d.symbol}</td>
            <td>$${d.oneTimeBuy.toFixed(0)}</td>
            <td>$${d.additionalAmount.toFixed(0)}</td>
            <td class="font-medium">$${d.total.toFixed(0)}</td>
            <td>
              <div class="bar-cell">
                <div class="bar" style="width: ${barWidth}px;"></div>
                <span class="text-gray-500">${d.percentage}%</span>
              </div>
            </td>
          </tr>
        `;
      });

      html += `
        <tr class="font-medium bg-gray-50">
          <td>í•©ê³„</td>
          <td></td>
          <td></td>
          <td>$${total.toFixed(0)}</td>
          <td>100%</td>
        </tr>
      `;
      html += '</tbody></table>';

      container.innerHTML = html;
    }

    function checkAndShowAlert() {
      if (!currentProfile) return;

      const alert = BalanceManager.checkAlert(currentProfile.id);
      const banner = document.getElementById('alert-banner');

      if (alert.show) {
        document.getElementById('alert-message').textContent = alert.message;
        banner.classList.remove('hidden');
        document.body.style.paddingTop = '52px'; // Offset for fixed banner
      } else {
        banner.classList.add('hidden');
        document.body.style.paddingTop = '0';
      }
    }

    function dismissAlert() {
      document.getElementById('alert-banner').classList.add('hidden');
      document.body.style.paddingTop = '0';
    }

    // =====================================================
    // Google Sheets Sync (Phase 2B)
    // =====================================================

    // =====================================================
    // Google Sheets Sync (Simplified - Hardcoded Sheet)
    // =====================================================

    let sheetsInitialized = false;

    /**
     * Google Sheets ì´ˆê¸°í™” ë° ë¡œê·¸ì¸
     * @returns {Promise<boolean>} ì„±ê³µ ì—¬ë¶€
     */
    async function initSheets() {
      if (sheetsInitialized && SheetsSync.getUserEmail()) {
        return true;
      }

      await SheetsSync.init();
      await SheetsSync.signIn();
      sheetsInitialized = true;

      // ë¡œê·¸ì¸í•œ ì´ë©”ì¼ í‘œì‹œ
      const userEmail = SheetsSync.getUserEmail();
      const userEl = document.getElementById('sheets-user');
      if (userEmail && userEl) {
        userEl.textContent = userEmail;
        userEl.classList.remove('hidden');
      }

      return true;
    }

    /**
     * ì‹œíŠ¸ì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (DEC-150: Dual-Key)
     */
    async function handleSheetsPull() {
      const status = document.getElementById('sheets-status');

      try {
        status.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
        status.className = 'text-xs text-amber-600';

        // Initialize and sign in
        await initSheets();

        // Set current profile for filtering
        SheetsSync.setCurrentProfile(currentProfile.id);

        // Pull data from sheet (ë‚´ êµ¬ê¸€ID + ë‚´ í”„ë¡œí•„ë§Œ)
        const pulled = await SheetsSync.pull();

        // Refresh UI
        currentProfile = ProfileManager.getActive();
        loadProfileData();
        loadBalanceData();
        updateProfileSelector();

        status.textContent = 'ì—°ê²°ë¨';
        status.className = 'text-xs text-green-600';
        showToast(`${pulled.length}ê°œ ì¢…ëª© ë¶ˆëŸ¬ì˜´`, 'success');

      } catch (error) {
        console.error('Sheets pull error:', error);
        status.textContent = 'ì˜¤ë¥˜';
        status.className = 'text-xs text-red-600';
        showToast('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + error.message, 'error');
      }
    }

    /**
     * ì‹œíŠ¸ì— ë°ì´í„° ì €ì¥í•˜ê¸° (DEC-150: Dual-Key)
     */
    async function handleSheetsPush() {
      const status = document.getElementById('sheets-status');

      try {
        status.textContent = 'ì €ì¥í•˜ëŠ” ì¤‘...';
        status.className = 'text-xs text-amber-600';

        // Initialize and sign in
        await initSheets();

        // Set current profile for filtering
        SheetsSync.setCurrentProfile(currentProfile.id);

        // Push data to sheet (ë‚´ êµ¬ê¸€ID + ë‚´ í”„ë¡œí•„ë§Œ ì—…ë°ì´íŠ¸)
        await SheetsSync.push();

        status.textContent = 'ì—°ê²°ë¨';
        status.className = 'text-xs text-green-600';
        showToast(`${currentProfile.id} í”„ë¡œí•„ ì €ì¥ ì™„ë£Œ`, 'success');

      } catch (error) {
        console.error('Sheets push error:', error);
        status.textContent = 'ì˜¤ë¥˜';
        status.className = 'text-xs text-red-600';
        showToast('ì €ì¥ ì‹¤íŒ¨: ' + error.message, 'error');
      }
    }
  </script>

</body>
</html>
