<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>IB Helper - ë¬´í•œë§¤ìˆ˜ ë„ìš°ë¯¸</title>

  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Custom Styles for Mobile -->
  <style>
    /* Mobile-first: Large touch targets */
    .touch-target {
      min-height: 44px;
      min-width: 44px;
    }

    /* Large number display */
    .number-display {
      font-size: 1.5rem;
      font-weight: 600;
      font-variant-numeric: tabular-nums;
    }

    /* Input number styling */
    input[type="number"] {
      font-size: 1.125rem;
      font-variant-numeric: tabular-nums;
    }

    /* Order card styling */
    .order-card {
      border-left: 4px solid;
    }
    .order-card.buy {
      border-left-color: #10b981;
    }
    .order-card.sell {
      border-left-color: #ef4444;
    }

    /* Phase indicator */
    .phase-first { background: linear-gradient(135deg, #10b981, #059669); }
    .phase-second { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .phase-stop { background: linear-gradient(135deg, #ef4444, #dc2626); }

    /* Sticky header */
    .sticky-header {
      position: sticky;
      top: 0;
      z-index: 10;
      background: white;
      border-bottom: 1px solid #e5e7eb;
    }

    /* Balance Section (Phase 3) */
    .balance-input {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }
    .balance-input input {
      flex: 1;
      font-size: 1.125rem;
    }
    .status-box {
      background: #f8fafc;
      padding: 0.75rem;
      border-radius: 0.5rem;
      margin-top: 0.75rem;
    }
    .status-row {
      display: flex;
      justify-content: space-between;
      padding: 0.25rem 0;
      font-size: 0.875rem;
    }
    .status-ok { color: #10b981; font-weight: 600; }
    .status-warning { color: #ef4444; font-weight: 600; }

    /* Alert Banner */
    .alert-banner {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #fef2f2;
      border-bottom: 2px solid #ef4444;
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      z-index: 1000;
    }
    .alert-banner.hidden { display: none; }
    .alert-icon { font-size: 1.25rem; }

    /* Breakdown Table */
    .breakdown-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8125rem;
      margin-top: 0.75rem;
    }
    .breakdown-table th,
    .breakdown-table td {
      padding: 0.375rem 0.5rem;
      text-align: right;
      border-bottom: 1px solid #e2e8f0;
    }
    .breakdown-table th:first-child,
    .breakdown-table td:first-child {
      text-align: left;
    }
    .breakdown-table th {
      background: #f8fafc;
      font-weight: 500;
      color: #64748b;
    }
    .bar-cell {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    .bar {
      height: 6px;
      background: #3b82f6;
      border-radius: 3px;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">

  <!-- Alert Banner (Phase 3) -->
  <div id="alert-banner" class="alert-banner hidden">
    <span class="alert-icon">ğŸš¨</span>
    <span id="alert-message" class="flex-1 text-sm text-red-700 font-medium"></span>
    <button onclick="dismissAlert()" class="touch-target text-red-400 hover:text-red-600">
      <i class="fas fa-times"></i>
    </button>
  </div>

  <!-- Header -->
  <header class="sticky-header px-4 py-3">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <a href="../" class="text-gray-500 hover:text-gray-700 touch-target flex items-center justify-center">
          <i class="fas fa-arrow-left"></i>
        </a>
        <div>
          <h1 class="text-lg font-bold text-gray-800">IB Helper</h1>
          <p class="text-xs text-gray-500">ë¬´í•œë§¤ìˆ˜ V2.2</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <span id="today-date" class="text-xs text-gray-500"></span>
        <button onclick="refreshCurrentPrice()" class="touch-target px-3 py-2 bg-blue-500 text-white rounded-lg text-sm hover:bg-blue-600">
          <i class="fas fa-sync-alt"></i>
        </button>
      </div>
    </div>

    <!-- Profile Selector -->
    <div class="mt-3 flex items-center gap-2">
      <select id="profile-selector" onchange="switchProfile(this.value)" class="flex-1 px-3 py-2 border border-gray-200 rounded-lg text-sm font-medium bg-white">
        <!-- Dynamic options -->
      </select>
      <button onclick="showProfileSettings()" class="touch-target px-3 py-2 border border-gray-200 rounded-lg text-gray-600 hover:bg-gray-50">
        <i class="fas fa-user-cog"></i>
      </button>
    </div>
  </header>

  <!-- Main Content -->
  <main class="px-4 py-4 max-w-lg mx-auto space-y-4">

    <!-- Ticker Selection -->
    <div class="bg-white rounded-xl p-4 shadow-sm">
      <label class="block text-sm font-medium text-gray-700 mb-2">ì¢…ëª© ì„ íƒ</label>
      <div class="grid grid-cols-3 gap-2">
        <button onclick="selectTicker('TQQQ')" class="ticker-btn touch-target py-3 rounded-lg text-center font-semibold transition-all bg-gray-100 text-gray-600 hover:bg-blue-100" data-ticker="TQQQ">TQQQ</button>
        <button onclick="selectTicker('SOXL')" class="ticker-btn touch-target py-3 rounded-lg text-center font-semibold transition-all bg-gray-100 text-gray-600 hover:bg-blue-100" data-ticker="SOXL">SOXL</button>
        <button onclick="selectTicker('BITU')" class="ticker-btn touch-target py-3 rounded-lg text-center font-semibold transition-all bg-gray-100 text-gray-600 hover:bg-blue-100" data-ticker="BITU">BITU</button>
      </div>
    </div>

    <!-- Settings (Collapsible) -->
    <details class="bg-white rounded-xl shadow-sm">
      <summary class="px-4 py-3 cursor-pointer font-medium text-gray-700 flex items-center justify-between">
        <span><i class="fas fa-cog mr-2 text-gray-400"></i>ì„¤ì •</span>
        <i class="fas fa-chevron-down text-gray-400 transition-transform"></i>
      </summary>
      <div class="px-4 pb-4 space-y-3 border-t border-gray-100 pt-3">
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-xs text-gray-500 mb-1">ì„¸íŒ…ì›ê¸ˆ ($)</label>
            <input type="number" id="input-principal" class="w-full px-3 py-2 border rounded-lg" value="13000" inputmode="numeric">
          </div>
          <div>
            <label class="block text-xs text-gray-500 mb-1">ë¶„í•  ìˆ˜</label>
            <input type="number" id="input-divisions" class="w-full px-3 py-2 border rounded-lg" value="40" inputmode="numeric">
          </div>
        </div>
        <div>
          <label class="block text-xs text-gray-500 mb-1">AFTER ë§¤ë„% (TQQQ=10, SOXL/BITU=12)</label>
          <input type="number" id="input-sellPercent" class="w-full px-3 py-2 border rounded-lg" value="12" step="0.5" inputmode="decimal">
        </div>
      </div>
    </details>

    <!-- Daily Input -->
    <div class="bg-white rounded-xl p-4 shadow-sm space-y-3">
      <h3 class="font-medium text-gray-700"><i class="fas fa-edit mr-2 text-blue-500"></i>ì˜¤ëŠ˜ ì…ë ¥</h3>

      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="block text-xs text-gray-500 mb-1">í‰ë‹¨ê°€ ($)</label>
          <input type="number" id="input-avgPrice" class="w-full px-3 py-2 border rounded-lg text-lg" placeholder="0.00" step="0.01" inputmode="decimal">
        </div>
        <div>
          <label class="block text-xs text-gray-500 mb-1">í˜„ì¬ê°€ ($)</label>
          <div class="relative">
            <input type="number" id="input-currentPrice" class="w-full px-3 py-2 border rounded-lg text-lg pr-10" placeholder="0.00" step="0.01" inputmode="decimal">
            <button onclick="fetchCurrentPrice()" class="absolute right-2 top-1/2 -translate-y-1/2 text-blue-500 hover:text-blue-700">
              <i class="fas fa-search-dollar"></i>
            </button>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="block text-xs text-gray-500 mb-1">ì´ ë§¤ì…ê¸ˆ ($)</label>
          <input type="number" id="input-totalInvested" class="w-full px-3 py-2 border rounded-lg" placeholder="0.00" step="0.01" inputmode="decimal">
        </div>
        <div>
          <label class="block text-xs text-gray-500 mb-1">ë³´ìœ  ìˆ˜ëŸ‰</label>
          <input type="number" id="input-holdings" class="w-full px-3 py-2 border rounded-lg" placeholder="0" inputmode="numeric">
        </div>
      </div>

      <!-- Calculate Button -->
      <button onclick="calculateOrders()" class="w-full touch-target py-4 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl font-semibold text-lg hover:from-blue-600 hover:to-blue-700 transition-all shadow-md">
        <i class="fas fa-calculator mr-2"></i>ì£¼ë¬¸ ê³„ì‚°
      </button>
    </div>

    <!-- Results Section -->
    <div id="results-section" class="hidden space-y-4">

      <!-- Summary Card -->
      <div id="summary-card" class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-xl p-4 text-white">
        <div class="flex items-center justify-between mb-3">
          <div>
            <span id="result-ticker" class="text-2xl font-bold">SOXL</span>
            <span id="result-phase" class="ml-2 px-2 py-0.5 text-xs rounded bg-green-500/30 text-green-300">ì „ë°˜ì „</span>
          </div>
          <div class="text-right">
            <div class="text-xs text-slate-400">Tê°’</div>
            <div id="result-T" class="text-2xl font-bold">15.4</div>
          </div>
        </div>

        <div class="grid grid-cols-3 gap-3 text-center">
          <div class="bg-white/10 rounded-lg p-2">
            <div class="text-xs text-slate-400">ë³„%</div>
            <div id="result-starPercent" class="text-lg font-semibold">2.3%</div>
          </div>
          <div class="bg-white/10 rounded-lg p-2">
            <div class="text-xs text-slate-400">1íšŒë§¤ìˆ˜</div>
            <div id="result-oneTimeBuy" class="text-lg font-semibold">$325</div>
          </div>
          <div class="bg-white/10 rounded-lg p-2">
            <div class="text-xs text-slate-400">LOCê°€</div>
            <div id="result-locPrice" class="text-lg font-semibold">$54.52</div>
          </div>
        </div>

        <div id="result-locReason" class="mt-2 text-xs text-slate-400 text-center">
          ë³„%ê°€ ì„ íƒ (í˜„ì¬ê°€+15% = $57.68)
        </div>
      </div>

      <!-- Buy Orders -->
      <div class="bg-white rounded-xl p-4 shadow-sm">
        <h3 class="font-medium text-green-600 mb-3">
          <i class="fas fa-arrow-down mr-2"></i>ë§¤ìˆ˜ ì£¼ë¬¸
        </h3>
        <div id="buy-orders" class="space-y-2">
          <!-- Dynamic content -->
        </div>
      </div>

      <!-- Sell Orders -->
      <div class="bg-white rounded-xl p-4 shadow-sm">
        <h3 class="font-medium text-red-600 mb-3">
          <i class="fas fa-arrow-up mr-2"></i>ë§¤ë„ ì£¼ë¬¸
        </h3>
        <div id="sell-orders" class="space-y-2">
          <!-- Dynamic content -->
        </div>
      </div>

      <!-- Quarter Stop Loss Warning -->
      <div id="quarter-stop-loss" class="hidden bg-red-50 border border-red-200 rounded-xl p-4">
        <h3 class="font-bold text-red-700 mb-2">
          <i class="fas fa-exclamation-triangle mr-2"></i>ì¿¼í„°ì†ì ˆ ëª¨ë“œ
        </h3>
        <div id="quarter-stop-loss-content" class="text-sm text-red-600 space-y-1">
          <!-- Dynamic content -->
        </div>
      </div>

    </div>

    <!-- Cash Management (Phase 3) -->
    <div class="bg-white rounded-xl p-4 shadow-sm">
      <h3 class="font-medium text-gray-700 mb-3">
        <i class="fas fa-wallet mr-2 text-amber-500"></i>ì˜ˆìˆ˜ê¸ˆ ê´€ë¦¬
      </h3>

      <div class="balance-input">
        <div class="flex-1">
          <label class="block text-xs text-gray-500 mb-1">ì£¼ë¬¸ê°€ëŠ¥ê¸ˆì•¡ (USD)</label>
          <input type="number" id="input-balance" class="w-full px-3 py-2 border rounded-lg" placeholder="0.00" step="0.01" inputmode="decimal">
        </div>
        <button onclick="recalculateBalance()" class="touch-target mt-5 px-3 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600">
          <i class="fas fa-sync-alt"></i>
        </button>
      </div>

      <!-- Order Status -->
      <div id="order-status" class="status-box hidden">
        <!-- Dynamically populated -->
      </div>

      <!-- Stock Breakdown -->
      <div id="stock-breakdown" class="hidden">
        <!-- Dynamically populated -->
      </div>
    </div>

  </main>

  <!-- Profile Settings Modal -->
  <div id="profile-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-end sm:items-center justify-center">
    <div class="bg-white w-full sm:w-96 sm:rounded-xl rounded-t-xl max-h-[80vh] overflow-y-auto">
      <div class="sticky top-0 bg-white px-4 py-3 border-b flex items-center justify-between">
        <h2 class="font-bold text-gray-800">í”„ë¡œí•„ ì„¤ì •</h2>
        <button onclick="closeProfileModal()" class="touch-target text-gray-400 hover:text-gray-600">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="p-4 space-y-4">
        <!-- Profile Info -->
        <div class="space-y-3">
          <div>
            <label class="block text-xs text-gray-500 mb-1">í”„ë¡œí•„ ì´ë¦„</label>
            <input type="text" id="modal-profile-name" class="w-full px-3 py-2 border rounded-lg" placeholder="ì´ë¦„">
          </div>
          <div>
            <label class="block text-xs text-gray-500 mb-1">ê³„ì¢Œë²ˆí˜¸</label>
            <input type="text" id="modal-account-number" class="w-full px-3 py-2 border rounded-lg" placeholder="000000">
          </div>
        </div>

        <!-- Profile Stocks -->
        <div>
          <label class="block text-xs text-gray-500 mb-2">ë“±ë¡ ì¢…ëª©</label>
          <div id="modal-stocks-list" class="space-y-2">
            <!-- Dynamic content -->
          </div>
          <button onclick="showAddStockForm()" class="mt-2 w-full py-2 border-2 border-dashed border-gray-200 rounded-lg text-gray-400 text-sm hover:border-blue-300 hover:text-blue-500">
            <i class="fas fa-plus mr-1"></i>ì¢…ëª© ì¶”ê°€
          </button>
        </div>

        <!-- Add Stock Form (hidden by default) -->
        <div id="add-stock-form" class="hidden bg-gray-50 rounded-lg p-3 space-y-2">
          <div class="grid grid-cols-2 gap-2">
            <input type="text" id="new-stock-symbol" class="px-3 py-2 border rounded-lg text-sm" placeholder="ì¢…ëª©ì½”ë“œ (ì˜ˆ: TQQQ)">
            <input type="number" id="new-stock-principal" class="px-3 py-2 border rounded-lg text-sm" placeholder="ì„¸íŒ…ì›ê¸ˆ ($)">
          </div>
          <div class="flex gap-2">
            <button onclick="addNewStock()" class="flex-1 py-2 bg-blue-500 text-white rounded-lg text-sm">ì¶”ê°€</button>
            <button onclick="hideAddStockForm()" class="px-4 py-2 bg-gray-200 rounded-lg text-sm">ì·¨ì†Œ</button>
          </div>
        </div>

        <!-- Actions -->
        <div class="pt-4 border-t space-y-2">
          <button onclick="saveProfileSettings()" class="w-full py-3 bg-blue-500 text-white rounded-lg font-medium">
            <i class="fas fa-save mr-2"></i>ì €ì¥
          </button>
          <div class="grid grid-cols-2 gap-2">
            <button onclick="exportCurrentProfile()" class="py-2 border rounded-lg text-sm text-gray-600">
              <i class="fas fa-download mr-1"></i>ë‚´ë³´ë‚´ê¸°
            </button>
            <button onclick="importProfile()" class="py-2 border rounded-lg text-sm text-gray-600">
              <i class="fas fa-upload mr-1"></i>ê°€ì ¸ì˜¤ê¸°
            </button>
          </div>
          <button onclick="createNewProfile()" class="w-full py-2 border border-green-500 text-green-600 rounded-lg text-sm">
            <i class="fas fa-user-plus mr-1"></i>ìƒˆ í”„ë¡œí•„ ë§Œë“¤ê¸°
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="px-4 py-6 text-center text-xs text-gray-400">
    <p>IB Helper v3.0.0 | V2.2 Algorithm</p>
    <p class="mt-1">Multi-Profile + ì˜ˆìˆ˜ê¸ˆ ê´€ë¦¬ + Genie RPA ë¡œì§ ê¸°ë°˜</p>
  </footer>

  <!-- Scripts -->
  <script src="js/calculator.js"></script>
  <script src="js/profile-manager.js"></script>
  <script src="js/balance-manager.js"></script>
  <script>
    // =====================================================
    // State
    // =====================================================

    let selectedTicker = 'SOXL';
    let currentProfile = null;

    // =====================================================
    // Initialization
    // =====================================================

    document.addEventListener('DOMContentLoaded', () => {
      // Initialize ProfileManager
      currentProfile = ProfileManager.init();

      // Show today's date
      const today = new Date();
      document.getElementById('today-date').textContent = today.toLocaleDateString('ko-KR', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      });

      // Load profile selector
      updateProfileSelector();

      // Load profile's first ticker or default
      loadProfileData();

      // Load balance data
      loadBalanceData();

      // Auto-calculate on input change (debounced)
      const inputs = document.querySelectorAll('input[type="number"]');
      let debounceTimer;
      inputs.forEach(input => {
        input.addEventListener('input', () => {
          clearTimeout(debounceTimer);
          debounceTimer = setTimeout(() => {
            // Save daily data (except balance input)
            if (input.id !== 'input-balance') {
              saveDailyInputs();
              if (hasRequiredInputs()) {
                calculateOrders();
              }
            } else {
              // Handle balance input
              handleBalanceChange(input.value);
            }
          }, 500);
        });
      });
    });

    // =====================================================
    // Profile Management
    // =====================================================

    function updateProfileSelector() {
      const selector = document.getElementById('profile-selector');
      const profiles = ProfileManager.getAllProfiles();
      const activeId = ProfileManager.getActiveId();

      selector.innerHTML = profiles.map(p => `
        <option value="${p.id}" ${p.id === activeId ? 'selected' : ''}>
          ğŸ‘¤ ${p.name}
        </option>
      `).join('');
    }

    function switchProfile(profileId) {
      ProfileManager.setActive(profileId);
      currentProfile = ProfileManager.getActive();
      loadProfileData();
      loadBalanceData();
      document.getElementById('results-section').classList.add('hidden');
      // Clear balance display on switch
      document.getElementById('order-status').classList.add('hidden');
      document.getElementById('stock-breakdown').classList.add('hidden');
      dismissAlert();
    }

    function loadProfileData() {
      currentProfile = ProfileManager.getActive();
      if (!currentProfile) return;

      // Update ticker buttons based on profile stocks
      updateTickerButtons();

      // Select first stock or default
      const firstStock = currentProfile.stocks[0];
      if (firstStock) {
        selectTicker(firstStock.symbol);
      } else {
        selectTicker('SOXL');
      }
    }

    function updateTickerButtons() {
      const container = document.querySelector('.ticker-btn')?.parentElement;
      if (!container) return;

      // Get profile stocks or use defaults
      const stocks = currentProfile?.stocks?.length > 0
        ? currentProfile.stocks
        : [{ symbol: 'TQQQ' }, { symbol: 'SOXL' }, { symbol: 'BITU' }];

      container.innerHTML = stocks.map(s => `
        <button onclick="selectTicker('${s.symbol}')"
                class="ticker-btn touch-target py-3 rounded-lg text-center font-semibold transition-all bg-gray-100 text-gray-600 hover:bg-blue-100"
                data-ticker="${s.symbol}">
          ${s.symbol}
        </button>
      `).join('');
    }

    // =====================================================
    // Profile Modal
    // =====================================================

    function showProfileSettings() {
      const modal = document.getElementById('profile-modal');
      modal.classList.remove('hidden');

      // Load current profile data
      currentProfile = ProfileManager.getActive();
      document.getElementById('modal-profile-name').value = currentProfile?.name || '';
      document.getElementById('modal-account-number').value = currentProfile?.accountNumber || '';

      // Load stocks list
      updateModalStocksList();
    }

    function closeProfileModal() {
      document.getElementById('profile-modal').classList.add('hidden');
      document.getElementById('add-stock-form').classList.add('hidden');
    }

    function updateModalStocksList() {
      const container = document.getElementById('modal-stocks-list');
      const stocks = currentProfile?.stocks || [];

      if (stocks.length === 0) {
        container.innerHTML = '<p class="text-sm text-gray-400 text-center py-2">ë“±ë¡ëœ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤</p>';
        return;
      }

      container.innerHTML = stocks.map(s => `
        <div class="flex items-center justify-between bg-gray-50 rounded-lg px-3 py-2">
          <div>
            <span class="font-medium">${s.symbol}</span>
            <span class="text-xs text-gray-500 ml-2">$${(s.principal || 0).toLocaleString()}</span>
          </div>
          <button onclick="removeStockFromProfile('${s.symbol}')" class="text-red-400 hover:text-red-600">
            <i class="fas fa-trash-alt"></i>
          </button>
        </div>
      `).join('');
    }

    function showAddStockForm() {
      document.getElementById('add-stock-form').classList.remove('hidden');
    }

    function hideAddStockForm() {
      document.getElementById('add-stock-form').classList.add('hidden');
      document.getElementById('new-stock-symbol').value = '';
      document.getElementById('new-stock-principal').value = '';
    }

    function addNewStock() {
      const symbol = document.getElementById('new-stock-symbol').value.toUpperCase().trim();
      const principal = parseFloat(document.getElementById('new-stock-principal').value) || 0;

      if (!symbol) {
        alert('ì¢…ëª©ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”');
        return;
      }

      const sellPercent = symbol === 'TQQQ' ? 10 : 12;
      ProfileManager.addStock(currentProfile.id, { symbol, principal, sellPercent });
      currentProfile = ProfileManager.getActive();

      hideAddStockForm();
      updateModalStocksList();
    }

    function removeStockFromProfile(symbol) {
      if (confirm(`${symbol} ì¢…ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        ProfileManager.removeStock(currentProfile.id, symbol);
        currentProfile = ProfileManager.getActive();
        updateModalStocksList();
      }
    }

    function saveProfileSettings() {
      const name = document.getElementById('modal-profile-name').value.trim();
      const accountNumber = document.getElementById('modal-account-number').value.trim();

      if (!name) {
        alert('í”„ë¡œí•„ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');
        return;
      }

      ProfileManager.update(currentProfile.id, { name, accountNumber });
      currentProfile = ProfileManager.getActive();

      updateProfileSelector();
      closeProfileModal();
      alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function createNewProfile() {
      const name = prompt('ìƒˆ í”„ë¡œí•„ ì´ë¦„:');
      if (!name) return;

      const accountNumber = prompt('ê³„ì¢Œë²ˆí˜¸ (ì„ íƒ):') || '';
      const newId = ProfileManager.create(name, accountNumber);
      ProfileManager.setActive(newId);

      updateProfileSelector();
      loadProfileData();
      closeProfileModal();
    }

    function exportCurrentProfile() {
      const json = ProfileManager.exportProfile(currentProfile.id);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = `ib-profile-${currentProfile.id}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function importProfile() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (ev) => {
          const newId = ProfileManager.importProfile(ev.target.result);
          if (newId) {
            ProfileManager.setActive(newId);
            updateProfileSelector();
            loadProfileData();
            closeProfileModal();
            alert('í”„ë¡œí•„ì„ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤');
          } else {
            alert('í”„ë¡œí•„ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨');
          }
        };
        reader.readAsText(file);
      };
      input.click();
    }

    // =====================================================
    // Daily Data Persistence
    // =====================================================

    function saveDailyInputs() {
      if (!currentProfile) return;

      const data = {
        avgPrice: parseFloat(document.getElementById('input-avgPrice').value) || 0,
        totalInvested: parseFloat(document.getElementById('input-totalInvested').value) || 0,
        holdings: parseInt(document.getElementById('input-holdings').value) || 0,
        currentPrice: parseFloat(document.getElementById('input-currentPrice').value) || 0
      };

      ProfileManager.saveDailyData(currentProfile.id, selectedTicker, data);
    }

    function loadDailyInputs() {
      if (!currentProfile) return;

      const data = ProfileManager.loadDailyData(currentProfile.id, selectedTicker);
      if (data) {
        if (data.avgPrice) document.getElementById('input-avgPrice').value = data.avgPrice;
        if (data.totalInvested) document.getElementById('input-totalInvested').value = data.totalInvested;
        if (data.holdings) document.getElementById('input-holdings').value = data.holdings;
        if (data.currentPrice) document.getElementById('input-currentPrice').value = data.currentPrice;
      }
    }

    // =====================================================
    // Ticker Selection
    // =====================================================

    function selectTicker(ticker) {
      selectedTicker = ticker;

      // Update UI
      document.querySelectorAll('.ticker-btn').forEach(btn => {
        const isSelected = btn.dataset.ticker === ticker;
        btn.classList.toggle('bg-blue-500', isSelected);
        btn.classList.toggle('text-white', isSelected);
        btn.classList.toggle('bg-gray-100', !isSelected);
        btn.classList.toggle('text-gray-600', !isSelected);
      });

      // Load stock settings from profile
      const stock = ProfileManager.getStock(ticker);
      if (stock) {
        document.getElementById('input-principal').value = stock.principal || 13000;
        document.getElementById('input-sellPercent').value = stock.sellPercent || IBCalculator.getSellPercent(ticker);
      } else {
        // Default values
        document.getElementById('input-sellPercent').value = IBCalculator.getSellPercent(ticker);
      }

      // Load saved daily inputs
      loadDailyInputs();

      // Hide results when switching
      document.getElementById('results-section').classList.add('hidden');
    }

    // =====================================================
    // Current Price Fetch (Yahoo Finance)
    // =====================================================

    async function fetchCurrentPrice() {
      const ticker = selectedTicker;
      if (!ticker) return;

      const btn = document.querySelector('[onclick="fetchCurrentPrice()"]');
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

      try {
        // Using Yahoo Finance chart API (free, no CORS issues with proxy)
        const url = `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1d&range=1d`;

        // Note: This may fail due to CORS. In production, use a proxy or Cloudflare Worker
        const response = await fetch(url);
        const data = await response.json();

        const price = data?.chart?.result?.[0]?.meta?.regularMarketPrice;
        if (price) {
          document.getElementById('input-currentPrice').value = price.toFixed(2);
          if (hasRequiredInputs()) {
            calculateOrders();
          }
        } else {
          alert('í˜„ì¬ê°€ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        }
      } catch (error) {
        console.error('Price fetch error:', error);
        alert('í˜„ì¬ê°€ ì¡°íšŒ ì‹¤íŒ¨. ìˆ˜ë™ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.\n(CORS ì œí•œìœ¼ë¡œ ì¸í•´ ì§ì ‘ ì¡°íšŒê°€ ì•ˆ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤)');
      } finally {
        btn.innerHTML = '<i class="fas fa-search-dollar"></i>';
      }
    }

    function refreshCurrentPrice() {
      fetchCurrentPrice();
    }

    // =====================================================
    // Calculate Orders
    // =====================================================

    function hasRequiredInputs() {
      const avgPrice = parseFloat(document.getElementById('input-avgPrice').value);
      const currentPrice = parseFloat(document.getElementById('input-currentPrice').value);
      const principal = parseFloat(document.getElementById('input-principal').value);
      return avgPrice > 0 && currentPrice > 0 && principal > 0;
    }

    function calculateOrders() {
      // Gather inputs
      const input = {
        ticker: selectedTicker,
        principal: parseFloat(document.getElementById('input-principal').value) || 0,
        divisions: parseInt(document.getElementById('input-divisions').value) || 40,
        avgPrice: parseFloat(document.getElementById('input-avgPrice').value) || 0,
        totalInvested: parseFloat(document.getElementById('input-totalInvested').value) || 0,
        holdings: parseInt(document.getElementById('input-holdings').value) || 0,
        currentPrice: parseFloat(document.getElementById('input-currentPrice').value) || 0
      };

      // Validate
      if (!input.avgPrice || !input.currentPrice || !input.principal) {
        return;
      }

      // Calculate
      const result = IBCalculator.calculate(input);

      if (result.error) {
        alert(result.error);
        return;
      }

      // Display results
      displayResults(result);
    }

    // =====================================================
    // Display Results
    // =====================================================

    function displayResults(result) {
      const { calculation, buyOrders, sellOrders, quarterStopLoss } = result;

      // Show results section
      document.getElementById('results-section').classList.remove('hidden');

      // Summary card
      document.getElementById('result-ticker').textContent = result.ticker;
      document.getElementById('result-T').textContent = calculation.T.toFixed(1);
      document.getElementById('result-starPercent').textContent = calculation.starPercent.toFixed(1) + '%';
      document.getElementById('result-oneTimeBuy').textContent = IBCalculator.formatDollar(calculation.oneTimeBuy);
      document.getElementById('result-locPrice').textContent = IBCalculator.formatDollar(calculation.locInfo.locPrice);

      // Phase badge
      const phaseBadge = document.getElementById('result-phase');
      phaseBadge.textContent = calculation.phase;
      phaseBadge.className = 'ml-2 px-2 py-0.5 text-xs rounded';
      if (calculation.phase === 'ì „ë°˜ì „') {
        phaseBadge.classList.add('bg-green-500/30', 'text-green-300');
      } else if (calculation.phase === 'í›„ë°˜ì „') {
        phaseBadge.classList.add('bg-yellow-500/30', 'text-yellow-300');
      } else {
        phaseBadge.classList.add('bg-red-500/30', 'text-red-300');
      }

      // LOC reason
      const locReason = document.getElementById('result-locReason');
      locReason.textContent = `${calculation.locInfo.reason} (ë³„%ê°€ = ${IBCalculator.formatDollar(calculation.locInfo.starPrice)}, í˜„ì¬ê°€Ã—1.15 = ${IBCalculator.formatDollar(calculation.locInfo.currentPriceCap)})`;

      // Buy orders
      const buyOrdersEl = document.getElementById('buy-orders');
      buyOrdersEl.innerHTML = buyOrders.map(order => renderOrderCard(order, 'buy')).join('');

      // Sell orders
      const sellOrdersEl = document.getElementById('sell-orders');
      if (quarterStopLoss.active) {
        sellOrdersEl.innerHTML = '<p class="text-gray-500 text-sm">ì¿¼í„°ì†ì ˆ ëª¨ë“œ - ì•„ë˜ ì•ˆë‚´ ì°¸ì¡°</p>';
      } else {
        sellOrdersEl.innerHTML = sellOrders.map(order => renderOrderCard(order, 'sell')).join('');
      }

      // Quarter stop loss warning
      const qslSection = document.getElementById('quarter-stop-loss');
      if (quarterStopLoss.active) {
        qslSection.classList.remove('hidden');
        document.getElementById('quarter-stop-loss-content').innerHTML = `
          <p><strong>MOC ë§¤ë„ ìˆ˜ëŸ‰:</strong> ${quarterStopLoss.mocQuantity}ì£¼</p>
          <ul class="list-disc pl-5 mt-2">
            ${quarterStopLoss.instructions.map(i => `<li>${i}</li>`).join('')}
          </ul>
        `;
      } else {
        qslSection.classList.add('hidden');
      }

      // Scroll to results
      document.getElementById('results-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function renderOrderCard(order, type) {
      const borderClass = type === 'buy' ? 'border-l-green-500' : 'border-l-red-500';
      const bgClass = type === 'buy' ? 'bg-green-50' : 'bg-red-50';

      return `
        <div class="order-card ${type} ${bgClass} rounded-lg p-3 border-l-4 ${borderClass}">
          <div class="flex justify-between items-start">
            <div>
              <div class="font-medium text-gray-800">${order.type}</div>
              <div class="text-xs text-gray-500">${order.description}</div>
            </div>
            <div class="text-right">
              <div class="font-bold text-lg">${IBCalculator.formatDollar(order.price)}</div>
              <div class="text-sm text-gray-600">${order.quantity}ì£¼</div>
            </div>
          </div>
          <div class="mt-2 text-xs text-gray-400">
            ${order.orderType}
            ${order.amount ? ' | ' + IBCalculator.formatDollar(order.amount) : ''}
          </div>
        </div>
      `;
    }

    // =====================================================
    // Balance Management (Phase 3)
    // =====================================================

    function loadBalanceData() {
      if (!currentProfile) return;

      const balance = BalanceManager.getBalance(currentProfile.id);
      const balanceInput = document.getElementById('input-balance');
      if (balance.available > 0) {
        balanceInput.value = balance.available;
        recalculateBalance();
      }
    }

    function handleBalanceChange(value) {
      if (!currentProfile) return;

      BalanceManager.updateBalance(currentProfile.id, value);
      recalculateBalance();
    }

    function recalculateBalance() {
      if (!currentProfile) return;

      // Save current balance value
      const balanceValue = parseFloat(document.getElementById('input-balance').value) || 0;
      if (balanceValue > 0) {
        BalanceManager.updateBalance(currentProfile.id, balanceValue);
      }

      // Recalculate
      const status = BalanceManager.calcOrderStatus(currentProfile);
      renderOrderStatus(status);
      checkAndShowAlert();
    }

    function renderOrderStatus(status) {
      const statusBox = document.getElementById('order-status');
      const breakdownBox = document.getElementById('stock-breakdown');

      // Only show if balance is set
      if (status.available <= 0 && status.required <= 0) {
        statusBox.classList.add('hidden');
        breakdownBox.classList.add('hidden');
        return;
      }

      statusBox.classList.remove('hidden');
      const statusClass = status.status === 'OK' ? 'status-ok' : 'status-warning';
      const statusIcon = status.status === 'OK' ? 'âœ…' : 'âš ï¸';

      statusBox.innerHTML = `
        <div class="status-row">
          <span class="text-gray-600">ì¼ë§¤ìˆ˜ì‹œë„ê¸ˆì•¡</span>
          <span class="font-medium">$${status.required.toFixed(2)}</span>
        </div>
        <div class="status-row">
          <span class="text-gray-600">ì£¼ë¬¸ê°€ëŠ¥ê¸ˆì•¡</span>
          <span class="font-medium">$${status.available.toFixed(2)}</span>
        </div>
        <hr class="my-1 border-gray-200">
        <div class="status-row ${statusClass}">
          <span>ì°¨ì•¡</span>
          <span>${status.diff >= 0 ? '+' : ''}$${status.diff.toFixed(2)} ${statusIcon} ${status.statusKo}</span>
        </div>
      `;

      // Stock breakdown
      if (status.details && status.details.length > 0) {
        breakdownBox.classList.remove('hidden');
        renderStockBreakdown(status.details, status.required);
      } else {
        breakdownBox.classList.add('hidden');
      }
    }

    function renderStockBreakdown(details, total) {
      const container = document.getElementById('stock-breakdown');

      let html = '<table class="breakdown-table">';
      html += '<thead><tr><th>ì¢…ëª©</th><th>1íšŒë§¤ìˆ˜</th><th>í•˜ë½ëŒ€ë¹„</th><th>í•©ê³„</th><th>ë¹„ìœ¨</th></tr></thead>';
      html += '<tbody>';

      details.forEach(d => {
        const barWidth = Math.min(d.percentage, 100);
        html += `
          <tr>
            <td class="font-medium">${d.symbol}</td>
            <td>$${d.oneTimeBuy.toFixed(0)}</td>
            <td>$${d.additionalAmount.toFixed(0)}</td>
            <td class="font-medium">$${d.total.toFixed(0)}</td>
            <td>
              <div class="bar-cell">
                <div class="bar" style="width: ${barWidth}px;"></div>
                <span class="text-gray-500">${d.percentage}%</span>
              </div>
            </td>
          </tr>
        `;
      });

      html += `
        <tr class="font-medium bg-gray-50">
          <td>í•©ê³„</td>
          <td></td>
          <td></td>
          <td>$${total.toFixed(0)}</td>
          <td>100%</td>
        </tr>
      `;
      html += '</tbody></table>';

      container.innerHTML = html;
    }

    function checkAndShowAlert() {
      if (!currentProfile) return;

      const alert = BalanceManager.checkAlert(currentProfile.id);
      const banner = document.getElementById('alert-banner');

      if (alert.show) {
        document.getElementById('alert-message').textContent = alert.message;
        banner.classList.remove('hidden');
        document.body.style.paddingTop = '52px'; // Offset for fixed banner
      } else {
        banner.classList.add('hidden');
        document.body.style.paddingTop = '0';
      }
    }

    function dismissAlert() {
      document.getElementById('alert-banner').classList.add('hidden');
      document.body.style.paddingTop = '0';
    }
  </script>

</body>
</html>
