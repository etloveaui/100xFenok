<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë°¸ë¥˜ì—ì´ì…˜ ì¹´ë“œ - Valuation Lab</title>
  <meta name="robots" content="noindex, nofollow">
  <link rel="icon" type="image/x-icon" href="../../favicon.ico">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* ë°¸ë¥˜ì—ì´ì…˜ ì¹´ë“œ */
    .valuation-card {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .valuation-card .header {
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .valuation-card .header .title {
      font-weight: 700;
      font-size: 1.125rem;
      color: #1e293b;
    }

    .valuation-card .header .overall-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.375rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.875rem;
      font-weight: 600;
    }

    .valuation-card .header .overall-badge.bullish {
      background: #dcfce7;
      color: #166534;
    }

    .valuation-card .header .overall-badge.neutral {
      background: #fef9c3;
      color: #854d0e;
    }

    .valuation-card .header .overall-badge.bearish {
      background: #fee2e2;
      color: #991b1b;
    }

    .valuation-card .signals {
      display: flex;
      justify-content: space-around;
      padding: 1rem;
      background: #f8fafc;
      border-bottom: 1px solid #e5e7eb;
    }

    .valuation-card .signal-item {
      text-align: center;
    }

    .valuation-card .signal-item .emoji {
      font-size: 1.5rem;
      margin-bottom: 0.25rem;
    }

    .valuation-card .signal-item .label {
      font-size: 0.75rem;
      color: #64748b;
    }

    .valuation-card .signal-item .value {
      font-size: 0.875rem;
      font-weight: 600;
      color: #1e293b;
    }

    .valuation-card .chart-section {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid #e5e7eb;
    }

    .valuation-card .one-liner-section {
      padding: 1rem 1.5rem;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    }

    .valuation-card .one-liner-section.bullish {
      border-left: 4px solid #16a34a;
    }

    .valuation-card .one-liner-section.neutral {
      border-left: 4px solid #ca8a04;
    }

    .valuation-card .one-liner-section.bearish {
      border-left: 4px solid #dc2626;
    }

    .valuation-card .footer {
      padding: 0.75rem 1.5rem;
      background: #f8fafc;
      font-size: 0.75rem;
      color: #64748b;
      text-align: right;
    }

    /* ì»´íŒ©íŠ¸ ì¹´ë“œ */
    .valuation-card-compact {
      background: white;
      border-radius: 0.75rem;
      padding: 1rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .valuation-card-compact .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.75rem;
    }

    .valuation-card-compact .signals {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .valuation-card-compact .signal-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 0.5rem;
      border-radius: 0.375rem;
      font-size: 0.75rem;
      background: #f1f5f9;
    }

    /* ë¯¸ë‹ˆ ë°” */
    .mini-bar {
      height: 0.5rem;
      border-radius: 9999px;
      background: #e5e7eb;
      overflow: hidden;
    }

    .mini-bar .fill {
      height: 100%;
      border-radius: 9999px;
      transition: width 0.5s ease-out;
    }

    .mini-bar .fill.green { background: #16a34a; }
    .mini-bar .fill.yellow { background: #ca8a04; }
    .mini-bar .fill.red { background: #dc2626; }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-100 to-slate-200 min-h-screen">

  <!-- Shared Modules -->
  <!-- Shared Modules -->
  <script src="../shared/config/manifest-loader.js"></script>
  <script src="../shared/core/cache-manager.js"></script>
  <script src="../shared/core/data-manager.js"></script>
  <script src="../shared/core/formatters.js"></script>
  <script src="../shared/validators/freshness-checker.js"></script>

  <!-- Valuation Lab Specific -->
  <script src="shared/constants.js"></script>
  <script src="shared/calculations.js"></script>
  <script src="shared/indicators.js"></script>
  <script src="shared/security.js"></script>
  <script src="shared/validator.js"></script>

  <script>
    // Set prefix for Valuation Lab
    if (window.CacheManager) CacheManager.setPrefix('vlab_cache_');
  </script>

  <header class="py-6 border-b bg-white">
    <div class="container mx-auto px-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 bg-amber-100 rounded-xl flex items-center justify-center">
            <i class="fas fa-id-card text-amber-500"></i>
          </div>
          <div>
            <h1 class="text-xl font-bold">ë°¸ë¥˜ì—ì´ì…˜ ì¹´ë“œ</h1>
            <p class="text-gray-500 text-sm">Step 3.4 - UI ì»´í¬ë„ŒíŠ¸ (ìµœì¢…)</p>
          </div>
        </div>
        <a href="./" class="text-gray-500 hover:text-blue-600">
          <i class="fas fa-arrow-left mr-1"></i> ì‹¤í—˜ì‹¤
        </a>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 py-8">

    <!-- ì»´í¬ë„ŒíŠ¸ ë°ëª¨ -->
    <section class="mb-8">
      <h2 class="text-lg font-semibold text-gray-700 mb-4">
        <i class="fas fa-palette text-purple-500 mr-2"></i>ì»´í¬ë„ŒíŠ¸ ìŠ¤íƒ€ì¼
      </h2>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

        <!-- ìŠ¤íƒ€ì¼ 1: ì „ì²´ ì¹´ë“œ -->
        <div>
          <h3 class="font-semibold mb-3 text-sm text-gray-600">1. ì „ì²´ ì¹´ë“œ (Full)</h3>
          <div class="valuation-card">
            <div class="header">
              <div class="title">ğŸ“Š S&P 500</div>
              <span class="overall-badge bearish">ğŸ”´ ê³ í‰ê°€</span>
            </div>
            <div class="signals">
              <div class="signal-item">
                <div class="emoji">ğŸ”´</div>
                <div class="label">P/E</div>
                <div class="value">98%</div>
              </div>
              <div class="signal-item">
                <div class="emoji">ğŸ”´</div>
                <div class="label">P/B</div>
                <div class="value">99%</div>
              </div>
              <div class="signal-item">
                <div class="emoji">ğŸŸ¢</div>
                <div class="label">ROE</div>
                <div class="value">100%</div>
              </div>
              <div class="signal-item">
                <div class="emoji">ğŸŸ¢</div>
                <div class="label">PEG</div>
                <div class="value">0.92x</div>
              </div>
            </div>
            <div class="chart-section">
              <div class="flex items-center gap-3 mb-2">
                <span class="w-12 text-xs text-gray-500">P/E</span>
                <div class="flex-1 mini-bar">
                  <div class="fill red" style="width: 98%"></div>
                </div>
                <span class="w-10 text-xs text-right text-red-600 font-medium">98%</span>
              </div>
              <div class="flex items-center gap-3">
                <span class="w-12 text-xs text-gray-500">P/B</span>
                <div class="flex-1 mini-bar">
                  <div class="fill red" style="width: 99%"></div>
                </div>
                <span class="w-10 text-xs text-right text-red-600 font-medium">99%</span>
              </div>
            </div>
            <div class="one-liner-section bearish">
              <p class="text-sm text-gray-700">
                ğŸ”´ S&P 500ì€ í˜„ì¬ <strong>P/E 98%</strong>, <strong>PEG 0.92x</strong>ë¡œ
                <strong>ê³ í‰ê°€</strong> êµ¬ê°„ì…ë‹ˆë‹¤. ë‹¤ë§Œ ROE 100%ë¡œ í€ë”ë©˜í„¸ì€ ì–‘í˜¸í•©ë‹ˆë‹¤.
              </p>
            </div>
            <div class="footer">
              ğŸ“… 2025-12-05 ê¸°ì¤€
            </div>
          </div>
        </div>

        <!-- ìŠ¤íƒ€ì¼ 2: ì»´íŒ©íŠ¸ ì¹´ë“œ -->
        <div>
          <h3 class="font-semibold mb-3 text-sm text-gray-600">2. ì»´íŒ©íŠ¸ ì¹´ë“œ</h3>
          <div class="space-y-4">
            <div class="valuation-card-compact">
              <div class="header">
                <span class="font-semibold">S&P 500</span>
                <span class="text-xs px-2 py-0.5 bg-red-100 text-red-700 rounded">ê³ í‰ê°€</span>
              </div>
              <div class="signals">
                <span class="signal-badge">ğŸ”´ P/E 98%</span>
                <span class="signal-badge">ğŸ”´ P/B 99%</span>
                <span class="signal-badge">ğŸŸ¢ ROE 100%</span>
                <span class="signal-badge">ğŸŸ¢ PEG 0.92x</span>
              </div>
            </div>
            <div class="valuation-card-compact">
              <div class="header">
                <span class="font-semibold">NASDAQ 100</span>
                <span class="text-xs px-2 py-0.5 bg-yellow-100 text-yellow-700 rounded">ì ì •</span>
              </div>
              <div class="signals">
                <span class="signal-badge">ğŸŸ¡ P/E 55%</span>
                <span class="signal-badge">ğŸŸ¡ P/B 60%</span>
                <span class="signal-badge">ğŸŸ¢ ROE 85%</span>
              </div>
            </div>
            <div class="valuation-card-compact">
              <div class="header">
                <span class="font-semibold">Russell 2000</span>
                <span class="text-xs px-2 py-0.5 bg-red-100 text-red-700 rounded">ê³ í‰ê°€</span>
              </div>
              <div class="signals">
                <span class="signal-badge">ğŸ”´ P/E 73%</span>
                <span class="signal-badge">ğŸ”´ PEG 2.71x</span>
                <span class="signal-badge">ğŸŸ¡ ROE 36%</span>
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>

    <!-- ì‹¤ì‹œê°„ ë°ì´í„° ì—°ë™ -->
    <section class="mb-8">
      <h2 class="text-lg font-semibold text-gray-700 mb-4">
        <i class="fas fa-database text-blue-500 mr-2"></i>ì‹¤ì‹œê°„ ë°ì´í„° ì—°ë™
      </h2>

      <div class="bg-white rounded-xl p-6 shadow">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-2">
            <select id="benchmark-select" class="border rounded px-3 py-1.5 text-sm">
              <option value="US">US (ë¯¸êµ­)</option>
              <option value="SECTORS">ì„¹í„°</option>
              <option value="EMERGING">ì‹ í¥êµ­</option>
              <option value="DEVELOPED">ì„ ì§„êµ­</option>
            </select>
            <select id="section-select" class="border rounded px-3 py-1.5 text-sm">
              <option value="sp500">S&P 500</option>
            </select>
            <select id="style-select" class="border rounded px-3 py-1.5 text-sm">
              <option value="full">ì „ì²´ ì¹´ë“œ</option>
              <option value="compact">ì»´íŒ©íŠ¸</option>
            </select>
          </div>
          <button onclick="generateCard()" class="bg-amber-500 text-white px-4 py-1.5 rounded text-sm hover:bg-amber-600">
            <i class="fas fa-id-card mr-1"></i> ìƒì„±
          </button>
        </div>

        <div id="card-output">
          <div class="text-gray-400 text-sm text-center py-8">
            ë²¤ì¹˜ë§ˆí¬ ì„ íƒ í›„ 'ìƒì„±' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”
          </div>
        </div>
      </div>
    </section>

    <!-- JavaScript API -->
    <section>
      <h2 class="text-lg font-semibold text-gray-700 mb-4">
        <i class="fas fa-code text-green-500 mr-2"></i>JavaScript API
      </h2>

      <div class="bg-white rounded-xl p-6 shadow">
        <pre class="bg-gray-900 text-green-400 p-4 rounded font-mono text-xs overflow-auto"><code>// ValuationCard ì»´í¬ë„ŒíŠ¸ ì‚¬ìš©ë²•

// 1. ì „ì²´ ì¹´ë“œ ìƒì„±
const summary = await Indicators.getValuationSummary('US', 'sp500');
const fullCard = ValuationCard.createFull(summary, {
  indexName: 'S&P 500'
});
container.appendChild(fullCard);

// 2. ì»´íŒ©íŠ¸ ì¹´ë“œ ìƒì„±
const compactCard = ValuationCard.createCompact(summary, {
  indexName: 'S&P 500'
});

// 3. ë©€í‹° ì¹´ë“œ ê·¸ë¦¬ë“œ (ì—¬ëŸ¬ ì§€ìˆ˜)
const indices = ['sp500', 'nasdaq100', 'russell2000'];
ValuationCard.renderGrid(container, 'US', indices);

// 4. ì¢…í•© íŒì • ê°€ì ¸ì˜¤ê¸°
const overall = ValuationCard.getOverall(summary);
console.log(overall); // { signal: 'ğŸ”´', class: 'bearish', label: 'ê³ í‰ê°€' }</code></pre>
      </div>
    </section>

  </main>

  <script>
    /**
     * ValuationCard - ë°¸ë¥˜ì—ì´ì…˜ ì¹´ë“œ ì»´í¬ë„ŒíŠ¸
     * Step 3.4: Layer 1B UI (ìµœì¢…)
     */
    const ValuationCard = (function() {

      /**
       * ì¢…í•© íŒì • (ë‹¤ìˆ˜ê²°)
       */
      function getOverall(summary) {
        const signals = [
          summary.pePercentile?.signal,
          summary.pbPercentile?.signal,
          summary.roePercentile?.signal,
          summary.pegProxy?.signal,
          summary.peZScore?.signal
        ].filter(Boolean);

        const counts = { green: 0, yellow: 0, red: 0 };
        signals.forEach(s => {
          if (s === 'ğŸŸ¢') counts.green++;
          else if (s === 'ğŸŸ¡') counts.yellow++;
          else if (s === 'ğŸ”´') counts.red++;
        });

        if (counts.green > counts.red && counts.green >= counts.yellow) {
          return { signal: 'ğŸŸ¢', class: 'bullish', label: 'ì €í‰ê°€' };
        } else if (counts.red > counts.green && counts.red >= counts.yellow) {
          return { signal: 'ğŸ”´', class: 'bearish', label: 'ê³ í‰ê°€' };
        } else {
          return { signal: 'ğŸŸ¡', class: 'neutral', label: 'ì ì •' };
        }
      }

      /**
       * ìƒ‰ìƒ í´ë˜ìŠ¤
       */
      function getColorClass(value, inverted = false) {
        if (inverted) {
          if (value >= 70) return 'green';
          if (value >= 30) return 'yellow';
          return 'red';
        } else {
          if (value <= 30) return 'green';
          if (value <= 70) return 'yellow';
          return 'red';
        }
      }

      /**
       * 1ë¬¸ì¥ ìƒì„±
       */
      function getOneLiner(summary, indexName) {
        const overall = getOverall(summary);
        const pe = summary.pePercentile;
        const peg = summary.pegProxy;
        const roe = summary.roePercentile;

        let text = `${overall.signal} ${indexName}ì€ í˜„ì¬ `;

        if (pe?.value !== null) {
          text += `<strong>P/E ${pe.formatted}</strong>`;
        }
        if (peg?.value !== null) {
          text += `, <strong>PEG ${peg.formatted}</strong>`;
        }

        text += `ë¡œ <strong>${overall.label}</strong> êµ¬ê°„ì…ë‹ˆë‹¤.`;

        if (overall.class === 'bearish' && roe?.signal === 'ğŸŸ¢') {
          text += ` ë‹¤ë§Œ ROE ${roe.formatted}ë¡œ í€ë”ë©˜í„¸ì€ ì–‘í˜¸í•©ë‹ˆë‹¤.`;
        } else if (overall.class === 'bullish' && roe?.signal === 'ğŸŸ¢') {
          text += ` ROEë„ ${roe.formatted}ë¡œ ìš°ìˆ˜í•©ë‹ˆë‹¤.`;
        }

        return text;
      }

      /**
       * ì „ì²´ ì¹´ë“œ ìƒì„±
       */
      function createFull(summary, options = {}) {
        const { indexName = 'ì§€ìˆ˜' } = options;
        const overall = getOverall(summary);

        const card = document.createElement('div');
        card.className = 'valuation-card';

        // ì‹ í˜¸ ì•„ì´í…œ ìƒì„±
        const signalItems = [
          { key: 'pePercentile', label: 'P/E', inverted: false },
          { key: 'pbPercentile', label: 'P/B', inverted: false },
          { key: 'roePercentile', label: 'ROE', inverted: true },
          { key: 'pegProxy', label: 'PEG', inverted: false, isPeg: true }
        ];

        let signalsHtml = '';
        let chartHtml = '';

        signalItems.forEach(({ key, label, inverted, isPeg }) => {
          const data = summary[key];
          if (data && data.value !== null) {
            const signal = data.signal || 'ğŸŸ¡';
            const formatted = data.formatted;

            signalsHtml += `
              <div class="signal-item">
                <div class="emoji">${signal}</div>
                <div class="label">${label}</div>
                <div class="value">${formatted}</div>
              </div>
            `;

            // ì°¨íŠ¸ (P/E, P/Bë§Œ)
            if (!isPeg && !inverted) {
              const value = data.value;
              const color = getColorClass(value, false);
              const colorText = color === 'green' ? 'text-green-600' : color === 'yellow' ? 'text-yellow-600' : 'text-red-600';
              chartHtml += `
                <div class="flex items-center gap-3 mb-2">
                  <span class="w-12 text-xs text-gray-500">${label}</span>
                  <div class="flex-1 mini-bar">
                    <div class="fill ${color}" style="width: ${Math.min(value, 100)}%"></div>
                  </div>
                  <span class="w-10 text-xs text-right ${colorText} font-medium">${formatted}</span>
                </div>
              `;
            }
          }
        });

        card.innerHTML = `
          <div class="header">
            <div class="title">ğŸ“Š ${indexName}</div>
            <span class="overall-badge ${overall.class}">${overall.signal} ${overall.label}</span>
          </div>
          <div class="signals">${signalsHtml}</div>
          <div class="chart-section">${chartHtml}</div>
          <div class="one-liner-section ${overall.class}">
            <p class="text-sm text-gray-700">${getOneLiner(summary, indexName)}</p>
          </div>
          <div class="footer">ğŸ“… ${summary.date || 'N/A'} ê¸°ì¤€</div>
        `;

        return card;
      }

      /**
       * ì»´íŒ©íŠ¸ ì¹´ë“œ ìƒì„±
       */
      function createCompact(summary, options = {}) {
        const { indexName = 'ì§€ìˆ˜' } = options;
        const overall = getOverall(summary);

        const card = document.createElement('div');
        card.className = 'valuation-card-compact';

        const signalItems = [
          { key: 'pePercentile', label: 'P/E' },
          { key: 'pbPercentile', label: 'P/B' },
          { key: 'roePercentile', label: 'ROE' },
          { key: 'pegProxy', label: 'PEG' }
        ];

        let badgesHtml = '';
        signalItems.forEach(({ key, label }) => {
          const data = summary[key];
          if (data && data.signal) {
            badgesHtml += `<span class="signal-badge">${data.signal} ${label} ${data.formatted}</span>`;
          }
        });

        const badgeClass = overall.class === 'bearish' ? 'bg-red-100 text-red-700'
          : overall.class === 'bullish' ? 'bg-green-100 text-green-700'
          : 'bg-yellow-100 text-yellow-700';

        card.innerHTML = `
          <div class="header">
            <span class="font-semibold">${indexName}</span>
            <span class="text-xs px-2 py-0.5 ${badgeClass} rounded">${overall.label}</span>
          </div>
          <div class="signals">${badgesHtml}</div>
        `;

        return card;
      }

      /**
       * ê·¸ë¦¬ë“œ ë Œë”ë§
       */
      async function renderGrid(container, benchmark, sections) {
        container.innerHTML = '<div class="text-center py-4 text-gray-400">ë¡œë”© ì¤‘...</div>';

        try {
          const data = await DataManager.loadBenchmark(benchmark);
          container.innerHTML = '';

          const grid = document.createElement('div');
          grid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4';

          for (const section of sections) {
            const summary = await Indicators.getValuationSummary(benchmark, section);
            if (!summary.error) {
              const indexNames = {
                sp500: 'S&P 500',
                nasdaq100: 'NASDAQ 100',
                russell2000: 'Russell 2000'
              };
              const card = createCompact(summary, { indexName: indexNames[section] || section });
              grid.appendChild(card);
            }
          }

          container.appendChild(grid);
        } catch (e) {
          container.innerHTML = `<div class="text-center py-4 text-red-500">ì˜¤ë¥˜: ${e.message}</div>`;
        }
      }

      return {
        getOverall,
        getOneLiner,
        createFull,
        createCompact,
        renderGrid
      };

    })();

    // ========================================
    // UI ì—°ë™
    // ========================================

    const benchmarkSelect = document.getElementById('benchmark-select');
    const sectionSelect = document.getElementById('section-select');
    const styleSelect = document.getElementById('style-select');

    benchmarkSelect.addEventListener('change', async () => {
      const benchmark = benchmarkSelect.value;
      sectionSelect.innerHTML = '<option>ë¡œë”© ì¤‘...</option>';

      try {
        const data = await DataManager.loadBenchmark(benchmark);
        const sections = DataManager.getSectionKeys(data);
        sectionSelect.innerHTML = sections.map(s =>
          `<option value="${s}">${s}</option>`
        ).join('');
      } catch (e) {
        sectionSelect.innerHTML = '<option>ì˜¤ë¥˜</option>';
      }
    });

    async function generateCard() {
      const benchmark = benchmarkSelect.value;
      const section = sectionSelect.value;
      const style = styleSelect.value;
      const output = document.getElementById('card-output');

      output.innerHTML = '<div class="text-center py-4 text-gray-400">ìƒì„± ì¤‘...</div>';

      try {
        const summary = await Indicators.getValuationSummary(benchmark, section);

        if (summary.error) {
          output.innerHTML = `<div class="text-center py-4 text-red-500">ì˜¤ë¥˜: ${summary.error}</div>`;
          return;
        }

        const indexNames = {
          sp500: 'S&P 500',
          nasdaq100: 'NASDAQ 100',
          russell2000: 'Russell 2000'
        };
        const indexName = indexNames[section] || section;

        output.innerHTML = '';

        if (style === 'full') {
          output.appendChild(ValuationCard.createFull(summary, { indexName }));
        } else {
          output.appendChild(ValuationCard.createCompact(summary, { indexName }));
        }
      } catch (e) {
        output.innerHTML = `<div class="text-center py-4 text-red-500">ì˜¤ë¥˜: ${e.message}</div>`;
      }
    }

    // ì´ˆê¸°í™”
    (async () => {
      try {
        const data = await DataManager.loadBenchmark('US');
        const sections = DataManager.getSectionKeys(data);
        sectionSelect.innerHTML = sections.map(s =>
          `<option value="${s}">${s}</option>`
        ).join('');
      } catch (e) {
        console.error('ì´ˆê¸°í™” ì˜¤ë¥˜:', e);
      }
    })();
  </script>

</body>
</html>
