<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Composite Benchmark 리포트</title>
  <meta name="robots" content="noindex, nofollow">
  <link rel="icon" type="image/x-icon" href="../../../favicon.ico">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-100 to-slate-200 min-h-screen text-gray-800">

  <header class="py-6 border-b bg-white">
    <div class="container mx-auto px-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center">
            <i class="fas fa-chart-pie text-indigo-500"></i>
          </div>
          <div>
            <h1 class="text-xl font-bold">Composite Benchmark 리포트</h1>
            <p class="text-gray-500 text-sm">Benchmarks + Damodaran 요약</p>
          </div>
        </div>
        <a href="./" class="text-gray-500 hover:text-blue-600">
          <i class="fas fa-arrow-left mr-1"></i> 확장 섹션
        </a>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 py-8 space-y-6">

    <section class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <div class="bg-white rounded-xl p-5 shadow">
        <h2 class="font-semibold text-gray-700">시장 밸류 요약</h2>
        <div class="mt-3 text-sm text-gray-600 space-y-1">
          <p>Benchmarks 기준일: <span class="mono" id="bench-date">-</span></p>
          <p>S&P500 P/E: <span class="mono" id="bench-pe">-</span></p>
          <p>P/E 분위수: <span class="mono" id="bench-percentile">-</span></p>
        </div>
      </div>
      <div class="bg-white rounded-xl p-5 shadow">
        <h2 class="font-semibold text-gray-700">Damodaran 요약</h2>
        <div class="mt-3 text-sm text-gray-600 space-y-1">
          <p>US ERP: <span class="mono" id="us-erp">-</span></p>
          <p>ERP 중앙값: <span class="mono" id="erp-median">-</span></p>
          <p>EV/Sales 중앙값: <span class="mono" id="ev-median">-</span></p>
        </div>
      </div>
      <div class="bg-white rounded-xl p-5 shadow">
        <h2 class="font-semibold text-gray-700">최근 생성일</h2>
        <div class="mt-3 text-sm text-gray-600 space-y-1">
          <p>Benchmarks: <span class="mono" id="bench-gen">-</span></p>
          <p>ERP: <span class="mono" id="erp-gen">-</span></p>
          <p>EV/Sales: <span class="mono" id="ev-gen">-</span></p>
        </div>
      </div>
    </section>

    <section class="bg-white rounded-xl p-5 shadow">
      <h2 class="font-semibold text-gray-700 mb-4">ERP 상위 5 국가</h2>
      <ul id="erp-top" class="space-y-2 text-sm"></ul>
    </section>

    <section class="bg-white rounded-xl p-5 shadow">
      <h2 class="font-semibold text-gray-700 mb-4">EV/Sales 상위 5 섹터</h2>
      <ul id="ev-top" class="space-y-2 text-sm"></ul>
    </section>

  </main>

  <script>
    const DATA_URLS = (() => {
      const host = location.hostname;
      const isLocal = location.protocol === 'file:' || host === 'localhost' || host === '127.0.0.1' || host === '0.0.0.0' || host === '[::1]' || host.startsWith('192.168.') || host.startsWith('10.') || host.startsWith('172.');
      const isCloudflare = host.endsWith('pages.dev');
      const base = (isLocal || isCloudflare) ? '' : '/100xFenok';
      return {
        bench: `${base}/data/benchmarks/us.json`,
        erp: `${base}/data/damodaran/erp.json`,
        ev: `${base}/data/damodaran/ev_sales.json`
      };
    })();

    const elements = {
      benchDate: document.getElementById('bench-date'),
      benchPe: document.getElementById('bench-pe'),
      benchPercentile: document.getElementById('bench-percentile'),
      usErp: document.getElementById('us-erp'),
      erpMedian: document.getElementById('erp-median'),
      evMedian: document.getElementById('ev-median'),
      benchGen: document.getElementById('bench-gen'),
      erpGen: document.getElementById('erp-gen'),
      evGen: document.getElementById('ev-gen'),
      erpTop: document.getElementById('erp-top'),
      evTop: document.getElementById('ev-top')
    };

    function formatPercent(value) {
      if (value === null || value === undefined || Number.isNaN(value)) return '-';
      return `${(value * 100).toFixed(2)}%`;
    }

    function formatNumber(value) {
      if (value === null || value === undefined || Number.isNaN(value)) return '-';
      return Number(value).toFixed(2);
    }

    function median(values) {
      if (!values.length) return null;
      const sorted = [...values].sort((a, b) => a - b);
      const mid = Math.floor(sorted.length / 2);
      return sorted.length % 2 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
    }

    function percentile(value, list) {
      const sorted = [...list].sort((a, b) => a - b);
      const idx = sorted.findIndex(v => v >= value);
      if (idx < 0) return 1;
      return idx / (sorted.length - 1 || 1);
    }

    function renderList(el, items, formatter) {
      el.innerHTML = '';
      items.forEach(item => {
        const li = document.createElement('li');
        li.className = 'flex items-center justify-between';
        li.innerHTML = `
          <span>${item.name}</span>
          <span class="mono text-indigo-700">${formatter(item.value)}</span>
        `;
        el.appendChild(li);
      });
    }

    async function init() {
      const [benchRes, erpRes, evRes] = await Promise.all([fetch(DATA_URLS.bench), fetch(DATA_URLS.erp), fetch(DATA_URLS.ev)]);
      if (!benchRes.ok || !erpRes.ok || !evRes.ok) throw new Error('데이터 로딩 실패');
      const bench = await benchRes.json();
      const erp = await erpRes.json();
      const ev = await evRes.json();

      const sp = bench?.sections?.sp500?.data || [];
      const latest = sp[sp.length - 1];
      const peList = sp.map(row => row.best_pe_ratio).filter(v => v && v > 0);
      const pePercentile = latest ? percentile(latest.best_pe_ratio, peList) : 0.5;

      elements.benchDate.textContent = latest?.date || '-';
      elements.benchPe.textContent = latest ? latest.best_pe_ratio.toFixed(2) : '-';
      elements.benchPercentile.textContent = `${(pePercentile * 100).toFixed(0)}p`;
      elements.benchGen.textContent = bench?.metadata?.generated ? bench.metadata.generated.slice(0, 10) : '-';

      const erpValues = Object.values(erp?.countries || {}).map(row => row.equity_risk_premium).filter(v => v !== null && v !== undefined);
      elements.usErp.textContent = formatPercent(erp?.us_erp);
      elements.erpMedian.textContent = formatPercent(median(erpValues));
      elements.erpGen.textContent = erp?.metadata?.generated_at ? erp.metadata.generated_at.slice(0, 10) : '-';

      const evValues = Object.values(ev?.sectors || {}).map(row => row.ev_sales).filter(v => v !== null && v !== undefined);
      elements.evMedian.textContent = formatNumber(median(evValues));
      elements.evGen.textContent = ev?.metadata?.generated_at ? ev.metadata.generated_at.slice(0, 10) : '-';

      const erpSorted = Object.entries(erp?.countries || {}).map(([name, row]) => ({ name, value: row.equity_risk_premium }))
        .sort((a, b) => b.value - a.value)
        .slice(0, 5);
      const evSorted = Object.entries(ev?.sectors || {}).map(([name, row]) => ({ name, value: row.ev_sales }))
        .sort((a, b) => b.value - a.value)
        .slice(0, 5);

      renderList(elements.erpTop, erpSorted, formatPercent);
      renderList(elements.evTop, evSorted, formatNumber);
    }

    init().catch(err => {
      elements.benchDate.textContent = err.message;
    });
  </script>
</body>
</html>
