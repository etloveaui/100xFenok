<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Global Scouter Explorer - 100xFenok</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 20px;
    }

    /* Loading State */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #e5e7eb;
      border-top-color: #10b981;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Content Tabs */
    .content-tab {
      padding: 12px 20px;
      border-radius: 8px 8px 0 0;
      font-weight: 600;
      transition: all 0.2s;
      cursor: pointer;
      border: none;
      font-size: 14px;
      background: transparent;
      color: #64748b;
      border-bottom: 3px solid transparent;
    }
    .content-tab.active {
      background: white;
      color: #10b981;
      border-bottom-color: #10b981;
    }
    .content-tab:not(.active):hover {
      background: rgba(255,255,255,0.5);
      color: #475569;
    }
    .content-section {
      display: none;
    }
    .content-section.active {
      display: block;
    }

    /* Filter Tabs */
    .tab-btn {
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.2s;
      cursor: pointer;
      border: none;
      font-size: 14px;
    }
    .tab-btn.active { background: #10b981; color: white; }
    .tab-btn:not(.active) { background: #f1f5f9; color: #475569; }
    .tab-btn:not(.active):hover { background: #e2e8f0; }

    /* Table */
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; }
    th { background: #f9fafb; font-weight: 600; font-size: 12px; text-transform: uppercase; color: #6b7280; cursor: pointer; }
    tbody tr { transition: all 0.2s; cursor: pointer; }
    tbody tr:hover { background: #ecfdf5; }
    tbody tr.selected { background: #d1fae5 !important; }

    /* Checkbox */
    .checkbox-cell { width: 40px; text-align: center; }
    input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }

    /* Sparkline */
    .sparkline { display: inline-block; vertical-align: middle; }

    /* Badge */
    .badge { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 500; }
    .badge-country { background: #dbeafe; color: #1e40af; }
    .badge-sector { background: #fef3c7; color: #92400e; }
    .badge-exchange { background: #e0e7ff; color: #3730a3; }

    /* Selection Counter */
    .selection-counter {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: #d1fae5;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      color: #065f46;
    }

    /* Chart Container */
    .chart-container { height: 400px; position: relative; }
    .chart-empty-state {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(249, 250, 251, 0.9);
      border-radius: 8px;
    }

    /* Metric Cards */
    .metric-card {
      transition: all 0.3s;
      cursor: pointer;
    }
    .metric-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }

    /* Period Selector */
    .period-selector { display: flex; gap: 6px; }
    .period-btn {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid #e5e7eb;
    }
    .period-btn.active { background: #10b981; color: white; border-color: #10b981; }
    .period-btn:not(.active) { background: white; color: #64748b; }
    .period-btn:not(.active):hover { background: #f8fafc; }

    /* Export Buttons */
    .export-btn {
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid #e5e7eb;
      background: white;
      color: #64748b;
    }
    .export-btn:hover { background: #f8fafc; }
    .export-btn.primary { background: #10b981; color: white; border-color: #10b981; }
    .export-btn.primary:hover { background: #059669; }

    /* Value colors */
    .positive { color: #16a34a; }
    .negative { color: #dc2626; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }

    /* Detail Panel */
    .detail-panel {
      position: fixed;
      top: 0;
      right: 0;
      width: 500px;
      max-width: 90vw;
      height: 100vh;
      background: white;
      box-shadow: -10px 0 30px rgba(0,0,0,0.15);
      z-index: 1000;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      overflow-y: auto;
    }
    .detail-panel.open {
      transform: translateX(0);
    }
    .detail-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.3);
      z-index: 999;
      display: none;
    }
    .detail-overlay.open {
      display: block;
    }

    /* Pagination */
    .pagination {
      display: flex;
      gap: 4px;
      align-items: center;
      justify-content: center;
      margin-top: 16px;
    }
    .page-btn {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      border: 1px solid #e5e7eb;
      background: white;
      color: #64748b;
    }
    .page-btn.active { background: #10b981; color: white; border-color: #10b981; }
    .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* TomSelect Custom Styles */
    .ts-wrapper { min-width: 220px; }
    .ts-control { border-radius: 8px !important; padding: 8px 12px !important; }
    .ts-dropdown { border-radius: 8px !important; }
    .ts-dropdown-content { max-height: 300px; }
    .ts-dropdown .option { padding: 8px 12px; }
    .ts-dropdown .option.active { background: #ecfdf5; color: #065f46; }

    /* v3: ETF í…Œì´ë¸” ëª¨ë°”ì¼ ëŒ€ì‘ */
    #etfTable { min-width: 1400px; }
    #etfTable th, #etfTable td { white-space: nowrap; font-size: 13px; }

    /* v4: Toast Animation */
    @keyframes slide-in {
      from { transform: translateX(100px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slide-out {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100px); opacity: 0; }
    }
    .toast-enter { animation: slide-in 0.3s ease-out; }
    .toast-exit { animation: slide-out 0.3s ease-out; }

    /* v4: Overlay Chart Period Buttons */
    .overlay-period-btn {
      padding: 4px 12px;
      font-size: 12px;
      font-weight: 500;
      border-radius: 6px;
      background: #f1f5f9;
      color: #64748b;
      transition: all 0.2s;
      border: none;
      cursor: pointer;
    }
    .overlay-period-btn.active {
      background: #6366f1;
      color: white;
    }
    .overlay-period-btn:hover:not(.active) {
      background: #e2e8f0;
    }

    /* v4: Global Selector Badge */
    .global-stock-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 14px;
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      color: #065f46;
      box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
    }

    /* v4: Peer Mode Toggle */
    .peer-mode-btn {
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 500;
      border-radius: 8px;
      transition: all 0.2s;
      border: 1px solid #e5e7eb;
      cursor: pointer;
    }
    .peer-mode-btn.active {
      background: #14b8a6;
      color: white;
      border-color: #14b8a6;
    }
    .peer-mode-btn:not(.active) {
      background: white;
      color: #64748b;
    }
    .peer-mode-btn:not(.active):hover {
      background: #f0fdfa;
      border-color: #14b8a6;
    }

    /* v4: Peer Chip */
    .peer-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }
    .peer-chip-base {
      background: #d1fae5;
      color: #065f46;
    }
    .peer-chip-manual {
      background: #ccfbf1;
      color: #0f766e;
    }
    .peer-chip-remove {
      cursor: pointer;
      opacity: 0.6;
      transition: opacity 0.2s;
    }
    .peer-chip-remove:hover {
      opacity: 1;
      color: #dc2626;
    }

    /* #195: Parameter Hints */
    .param-hint {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
      padding: 4px 8px;
      background: linear-gradient(to right, rgba(139, 92, 246, 0.05), transparent);
      border-left: 2px solid #8b5cf6;
      border-radius: 0 4px 4px 0;
    }
    .param-hint-icon { color: #8b5cf6; margin-right: 4px; }
    .param-range {
      display: inline-flex;
      gap: 8px;
      font-size: 10px;
      color: #9ca3af;
      margin-top: 2px;
    }
    .param-range span {
      padding: 2px 6px;
      background: #f3f4f6;
      border-radius: 4px;
    }
    .param-guide-toggle {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid;
      transition: all 0.2s;
      cursor: pointer;
      background: transparent;
    }
    .param-guide-toggle:hover { border-color: inherit; }
    .param-guide-content { transition: all 0.3s ease; }
    .rotate-180 { transform: rotate(180deg); }

    /* #196: DDM Yield Warning */
    .ddm-yield-warning {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 12px;
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }
    .ddm-yield-warning.error {
      background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
      border: 1px solid #fecaca;
    }
    .ddm-yield-warning.warning {
      background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
      border: 1px solid #fde68a;
    }
    .ddm-yield-warning-icon {
      font-size: 20px;
      flex-shrink: 0;
      margin-top: 2px;
    }
    .ddm-yield-warning.error .ddm-yield-warning-icon { color: #dc2626; }
    .ddm-yield-warning.warning .ddm-yield-warning-icon { color: #d97706; }

    /* #196: Peer Quick Add */
    .peer-quick-add {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }
    .peer-quick-btn {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 6px 12px;
      font-size: 12px;
      background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
      border: 1px solid #a7f3d0;
      border-radius: 20px;
      color: #065f46;
      cursor: pointer;
      transition: all 0.2s;
    }
    .peer-quick-btn:hover {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      border-color: #6ee7b7;
      transform: translateY(-1px);
    }
    .peer-quick-btn i { color: #10b981; }

    /* #196: Macro Alert */
    .macro-alert-banner {
      margin-bottom: 16px;
    }
    .macro-alert {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .macro-alert:last-child { margin-bottom: 0; }
    .macro-alert-danger {
      background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
      border-left: 4px solid #dc2626;
    }
    .macro-alert-warning {
      background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
      border-left: 4px solid #f59e0b;
    }
    .macro-alert-info {
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      border-left: 4px solid #3b82f6;
    }
    .macro-alert-header {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
    }
    .macro-alert-danger .macro-alert-header { color: #991b1b; }
    .macro-alert-warning .macro-alert-header { color: #92400e; }
    .macro-alert-info .macro-alert-header { color: #1e40af; }
    .macro-alert-body {
      font-size: 13px;
      color: #4b5563;
      margin-left: 24px;
    }
    .macro-alert-meta {
      font-size: 11px;
      color: #9ca3af;
      margin-left: 24px;
    }

    /* #197: Indicator Guide System - Level 1 Tooltip */
    .indicator-label {
      position: relative;
      cursor: help;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .indicator-label[data-tooltip]:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #1f2937;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 400;
      white-space: nowrap;
      max-width: 280px;
      z-index: 100;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .indicator-label[data-tooltip]:hover::before {
      content: '';
      position: absolute;
      bottom: calc(100% - 6px);
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: #1f2937;
      z-index: 100;
    }
    .indicator-help-icon {
      font-size: 10px;
      color: #9ca3af;
      transition: color 0.2s;
    }
    .indicator-label:hover .indicator-help-icon {
      color: #6b7280;
    }

    /* #197: Level 2 Context Badge */
    .context-badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 500;
    }
    .context-low { background: #dcfce7; color: #166534; }
    .context-high { background: #fee2e2; color: #991b1b; }
    .context-neutral { background: #f3f4f6; color: #4b5563; }
    .context-warning { background: #fef3c7; color: #92400e; }

    /* #197: Level 3 Guide Panel */
    .guide-toggle {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      border: 1px solid #bae6fd;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: #0369a1;
      transition: all 0.2s;
    }
    .guide-toggle:hover {
      background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
      border-color: #7dd3fc;
    }
    .guide-toggle i {
      transition: transform 0.3s;
    }
    .guide-toggle.open i {
      transform: rotate(180deg);
    }
    .guide-panel {
      margin-top: 12px;
      padding: 16px;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      display: none;
    }
    .guide-panel.open {
      display: block;
    }
    .guide-card {
      padding: 12px 16px;
      margin-bottom: 12px;
      background: #fafafa;
      border-radius: 8px;
      border-left: 4px solid #3b82f6;
    }
    .guide-card:last-child {
      margin-bottom: 0;
    }
    .guide-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      flex-wrap: wrap;
      gap: 8px;
    }
    .guide-title {
      font-weight: 600;
      color: #1f2937;
      font-size: 14px;
    }
    .guide-formula {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      color: #6b7280;
      font-size: 12px;
      background: #f3f4f6;
      padding: 2px 8px;
      border-radius: 4px;
    }
    .guide-what, .guide-meaning {
      font-size: 13px;
      margin-bottom: 8px;
      color: #374151;
      line-height: 1.5;
    }
    .guide-interpretation {
      background: white;
      border-radius: 6px;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #e5e7eb;
    }
    .interp-row {
      display: flex;
      gap: 12px;
      padding: 6px 10px;
      border-radius: 4px;
      margin-bottom: 4px;
      align-items: center;
    }
    .interp-row:last-child {
      margin-bottom: 0;
    }
    .interp-range {
      font-weight: 600;
      min-width: 80px;
      font-size: 12px;
    }
    .interp-text {
      font-size: 12px;
      color: #4b5563;
    }
    .interp-low { background: #dcfce7; }
    .interp-neutral { background: #f3f4f6; }
    .interp-high { background: #fef3c7; }
    .interp-danger { background: #fee2e2; }
    .guide-warning {
      font-size: 12px;
      color: #dc2626;
      margin-top: 10px;
      padding: 10px;
      background: #fef2f2;
      border-radius: 6px;
      display: flex;
      align-items: flex-start;
      gap: 8px;
    }
    .guide-warning i {
      margin-top: 2px;
      flex-shrink: 0;
    }
    .guide-tip {
      font-size: 12px;
      color: #0369a1;
      margin-top: 10px;
      padding: 10px;
      background: #f0f9ff;
      border-radius: 6px;
      display: flex;
      align-items: flex-start;
      gap: 8px;
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="spinner"></div>
    <p class="text-gray-600 mt-4">Global Scouter ë°ì´í„° ë¡œë”© ì¤‘...</p>
    <p class="text-gray-400 text-sm mt-2">1,243 ì¢…ëª© + 23 ETF + 1,045 ë§¤í¬ë¡œ ì§€í‘œ</p>
  </div>

  <!-- Detail Overlay -->
  <div id="detailOverlay" class="detail-overlay" onclick="closeDetail()"></div>

  <!-- Detail Panel -->
  <div id="detailPanel" class="detail-panel">
    <div id="detailContent" class="p-6"></div>
  </div>

  <div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="card">
      <div class="flex items-center justify-between flex-wrap gap-3">
        <div>
          <h1 class="text-2xl font-bold text-gray-800">Global Scouter Explorer</h1>
          <p class="text-gray-500">ì¢…ëª© â€¢ ì¬ë¬´ì œí‘œ â€¢ ë°¸ë¥˜ì—ì´ì…˜ â€¢ ì„±ì¥ì„± â€¢ ë°°ë‹¹ â€¢ ETF/ë§¤í¬ë¡œ</p>
        </div>
        <div class="flex items-center gap-2">
          <button onclick="exportCSV()" class="export-btn">
            <i class="fas fa-file-csv mr-1"></i>CSV
          </button>
          <a href="../" class="text-emerald-500 hover:underline ml-2">â† ë’¤ë¡œ</a>
        </div>
      </div>
    </div>

    <!-- v4: Global Stock Selector -->
    <div class="card mb-4" id="globalSelectorCard">
      <div class="flex items-center justify-between flex-wrap gap-3">
        <div class="flex items-center gap-3 flex-wrap">
          <label for="globalStockSelector" class="text-sm font-medium text-gray-600">
            <i class="fas fa-chart-line text-emerald-500 mr-1"></i>ë¶„ì„ ì¢…ëª©:
          </label>
          <select id="globalStockSelector" class="min-w-64" aria-label="ë¶„ì„í•  ì¢…ëª© ì„ íƒ"></select>
        </div>
        <div id="selectedStockBadge" class="hidden">
          <span class="global-stock-badge">
            <i class="fas fa-star text-amber-500 text-xs"></i>
            <span id="selectedStockName">-</span>
          </span>
        </div>
      </div>
      <p class="text-xs text-gray-400 mt-2">
        <i class="fas fa-info-circle mr-1"></i>
        ì¢…ëª© ì„ íƒ ì‹œ ëª¨ë“  íƒ­ì— ìë™ ë°˜ì˜ë©ë‹ˆë‹¤. í‘œì—ì„œ ğŸ“Š ë²„íŠ¼ì„ í´ë¦­í•˜ê±°ë‚˜ ë“œë¡­ë‹¤ìš´ì—ì„œ ì„ íƒí•˜ì„¸ìš”.
      </p>
    </div>

    <!-- Content Tabs -->
    <div class="flex gap-1 bg-emerald-100 rounded-t-lg p-1 mb-0 overflow-x-auto">
      <button class="content-tab active" data-tab="overview" onclick="setContentTab('overview')">
        <i class="fas fa-table mr-2"></i>ì „ì²´ë³´ê¸°
      </button>
      <button class="content-tab" data-tab="financials" onclick="setContentTab('financials')">
        <i class="fas fa-receipt mr-2"></i>ì¬ë¬´ì œí‘œ
      </button>
      <button class="content-tab" data-tab="valuations" onclick="setContentTab('valuations')">
        <i class="fas fa-chart-bar mr-2"></i>ë°¸ë¥˜ì—ì´ì…˜
      </button>
      <button class="content-tab" data-tab="growth" onclick="setContentTab('growth')">
        <i class="fas fa-arrow-trend-up mr-2"></i>ì„±ì¥ì„±
      </button>
      <button class="content-tab" data-tab="dividends" onclick="setContentTab('dividends')">
        <i class="fas fa-coins mr-2"></i>ë°°ë‹¹
      </button>
      <button class="content-tab" data-tab="dcf" onclick="setContentTab('dcf')">
        <i class="fas fa-calculator mr-2"></i>DCF
      </button>
      <button class="content-tab" data-tab="ddm" onclick="setContentTab('ddm')">
        <i class="fas fa-hand-holding-dollar mr-2"></i>DDM
      </button>
      <button class="content-tab" data-tab="peer" onclick="setContentTab('peer')">
        <i class="fas fa-users mr-2"></i>Peerë¹„êµ
      </button>
      <button class="content-tab" data-tab="etfs" onclick="setContentTab('etfs')">
        <i class="fas fa-layer-group mr-2"></i>ETFs
      </button>
      <button class="content-tab" data-tab="macro" onclick="setContentTab('macro')">
        <i class="fas fa-globe mr-2"></i>Macro
      </button>
    </div>

    <!-- ==================== OVERVIEW TAB ==================== -->
    <div id="section-overview" class="content-section active">
      <!-- Filter Tabs -->
      <div class="card" style="border-top-left-radius: 0; border-top-right-radius: 0;">
        <div class="flex flex-wrap gap-2">
          <button id="tab-all" onclick="setFilter('all')" class="tab-btn active">ì „ì²´ (<span id="count-all">0</span>)</button>
          <button id="tab-us" onclick="setFilter('US')" class="tab-btn">ğŸ‡ºğŸ‡¸ ë¯¸êµ­ (<span id="count-us">0</span>)</button>
          <button id="tab-kr" onclick="setFilter('KR')" class="tab-btn">ğŸ‡°ğŸ‡· í•œêµ­ (<span id="count-kr">0</span>)</button>
          <button id="tab-cn" onclick="setFilter('CN')" class="tab-btn">ğŸ‡¨ğŸ‡³ ì¤‘êµ­ (<span id="count-cn">0</span>)</button>
          <button id="tab-jp" onclick="setFilter('JP')" class="tab-btn">ğŸ‡¯ğŸ‡µ ì¼ë³¸ (<span id="count-jp">0</span>)</button>
          <button id="tab-hk" onclick="setFilter('HK')" class="tab-btn">ğŸ‡­ğŸ‡° í™ì½© (<span id="count-hk">0</span>)</button>
          <button id="tab-eu" onclick="setFilter('EU')" class="tab-btn">ğŸ‡ªğŸ‡º ìœ ëŸ½ (<span id="count-eu">0</span>)</button>
        </div>
      </div>

      <!-- Screener Table -->
      <div class="card">
        <div class="flex items-center justify-between mb-4 flex-wrap gap-3">
          <h2 class="text-lg font-bold text-gray-800">
            <i class="fas fa-table text-emerald-500 mr-2"></i>ì¢…ëª© ìŠ¤í¬ë¦¬ë„ˆ
          </h2>
          <div class="text-sm text-gray-500">
            <i class="fas fa-mouse-pointer mr-1"></i>í–‰ í´ë¦­ ì‹œ ìƒì„¸ ì •ë³´ í‘œì‹œ
          </div>
        </div>

        <input id="search" type="text" placeholder="ì¢…ëª© ê²€ìƒ‰ (í‹°ì»¤, ì´ë¦„, ì„¹í„°)..."
               class="w-full p-3 border rounded-lg mb-4" oninput="filterTable()">

        <div style="overflow-x: auto;">
          <table id="screenerTable">
            <thead>
              <tr>
                <th class="text-center w-14">ë¶„ì„</th>
                <th onclick="sortTable('ticker')">í‹°ì»¤ <i class="fas fa-sort text-xs ml-1"></i></th>
                <th onclick="sortTable('name')">ì¢…ëª©ëª… <i class="fas fa-sort text-xs ml-1"></i></th>
                <th onclick="sortTable('sector')">ì„¹í„° <i class="fas fa-sort text-xs ml-1"></i></th>
                <th onclick="sortTable('mc')">ì‹œì´ <i class="fas fa-sort text-xs ml-1"></i></th>
                <th onclick="sortTable('pe')">P/E <i class="fas fa-sort text-xs ml-1"></i></th>
                <th onclick="sortTable('pb')">P/B <i class="fas fa-sort text-xs ml-1"></i></th>
                <th onclick="sortTable('dy')">ë°°ë‹¹ë¥  <i class="fas fa-sort text-xs ml-1"></i></th>
                <th onclick="sortTable('r12')">12M ìˆ˜ìµë¥  <i class="fas fa-sort text-xs ml-1"></i></th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="pagination" id="pagination"></div>

        <p class="text-xs text-gray-500 mt-3">
          <i class="fas fa-info-circle mr-1"></i>
          í–‰ í´ë¦­ ì‹œ ìƒì„¸ íŒ¨ë„ í‘œì‹œ â€¢ íƒ­ ì „í™˜ìœ¼ë¡œ ì¬ë¬´/ë°¸ë¥˜ì—ì´ì…˜/ì„±ì¥ì„±/ë°°ë‹¹ ë¶„ì„
        </p>
      </div>

      <!-- Top/Bottom Cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="card">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-sm font-bold text-green-600 flex items-center gap-1.5">
              <i class="fas fa-crown"></i>Top 5 (12M ìˆ˜ìµë¥ )
            </h2>
            <span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-lg">YoY Return</span>
          </div>
          <div id="top5-cards" class="space-y-2"></div>
        </div>
        <div class="card">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-sm font-bold text-red-600 flex items-center gap-1.5">
              <i class="fas fa-exclamation-circle"></i>Bottom 5 (12M ìˆ˜ìµë¥ )
            </h2>
            <span class="text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded-lg">YoY Return</span>
          </div>
          <div id="bottom5-cards" class="space-y-2"></div>
        </div>
      </div>

      <!-- Sector & Country Summary (from dashboard.json) -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
        <div class="card">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-sm font-bold text-amber-600 flex items-center gap-1.5">
              <i class="fas fa-layer-group"></i>ì„¹í„°ë³„ í˜„í™© (26ê°œ)
            </h2>
            <span class="text-xs bg-amber-100 text-amber-700 px-2 py-0.5 rounded-lg">dashboard.json</span>
          </div>
          <div id="sector-summary" class="space-y-1 max-h-64 overflow-y-auto text-sm"></div>
        </div>
        <div class="card">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-sm font-bold text-blue-600 flex items-center gap-1.5">
              <i class="fas fa-globe"></i>êµ­ê°€ë³„ í˜„í™© (5ê°œ)
            </h2>
            <span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-lg">dashboard.json</span>
          </div>
          <div id="country-summary" class="space-y-2"></div>
        </div>
      </div>
    </div>

    <!-- ==================== FINANCIALS TAB ==================== -->
    <div id="section-financials" class="content-section">
      <div class="card" style="border-top-left-radius: 0; border-top-right-radius: 0;">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-bold text-gray-800">
            <i class="fas fa-receipt text-blue-500 mr-2"></i>ì¬ë¬´ì œí‘œ ë¹„êµ
          </h2>
          <div class="flex items-center gap-3">
            <label for="financialSelector" class="text-sm text-gray-600">ì¢…ëª©:</label>
            <select id="financialSelector" onchange="renderFinancialsChart()" class="p-2 border rounded-lg text-sm min-w-48">
              <option value="">-- ì¢…ëª© ì„ íƒ --</option>
            </select>
          </div>
        </div>

        <div class="metric-tabs flex flex-wrap gap-2 mb-4">
          <button class="tab-btn active" data-metric="revenue" onclick="setFinancialMetric('revenue')">ë§¤ì¶œì•¡</button>
          <button class="tab-btn" data-metric="gross_profit" onclick="setFinancialMetric('gross_profit')">ë§¤ì¶œì´ì´ìµ</button>
          <button class="tab-btn" data-metric="operating_income" onclick="setFinancialMetric('operating_income')">ì˜ì—…ì´ìµ</button>
          <button class="tab-btn" data-metric="net_income" onclick="setFinancialMetric('net_income')">ìˆœì´ìµ</button>
          <button class="tab-btn" data-metric="sga" onclick="setFinancialMetric('sga')">íŒê´€ë¹„</button>
          <button class="tab-btn" data-metric="fcf" onclick="setFinancialMetric('fcf')">FCF</button>
          <button class="tab-btn" data-metric="cfi" onclick="setFinancialMetric('cfi')">íˆ¬ìCF</button>
          <button class="tab-btn" data-metric="cff" onclick="setFinancialMetric('cff')">ì¬ë¬´CF</button>
        </div>

        <div id="financialsChartContainer" class="chart-container">
          <canvas id="financialsChart"></canvas>
          <div id="financialsEmptyState" class="chart-empty-state">
            <div class="text-center text-gray-400">
              <i class="fas fa-chart-bar text-5xl mb-3"></i>
              <p class="text-lg font-medium">ì¢…ëª©ì„ ì„ íƒí•˜ì„¸ìš”</p>
              <p class="text-sm mt-1">Overview íƒ­ì—ì„œ ì¢…ëª© í´ë¦­ ë˜ëŠ” ìœ„ ë“œë¡­ë‹¤ìš´ì—ì„œ ì„ íƒ</p>
            </div>
          </div>
        </div>

        <!-- Financial Summary Table -->
        <div id="financialSummary" class="mt-6 hidden">
          <h3 class="text-sm font-bold text-gray-700 mb-3">5ê°œë…„ ì¬ë¬´ ìš”ì•½</h3>
          <div style="overflow-x: auto;">
            <table class="text-sm">
              <thead>
                <tr>
                  <th>í•­ëª©</th>
                  <th>FY-4</th>
                  <th>FY-3</th>
                  <th>FY-2</th>
                  <th>FY-1</th>
                  <th>FY0</th>
                </tr>
              </thead>
              <tbody id="financialSummaryBody"></tbody>
            </table>
          </div>
        </div>

        <!-- #197: Financials Indicator Guide -->
        <div class="mt-6">
          <button onclick="toggleIndicatorGuide('financials')" class="guide-toggle" id="financialsGuideToggle">
            <span><i class="fas fa-book-open mr-2"></i>ì¬ë¬´ì œí‘œ ì§€í‘œ ê°€ì´ë“œ (ì´ˆë³´ììš©)</span>
            <i class="fas fa-chevron-down"></i>
          </button>
          <div id="financialsGuideContent" class="guide-panel">
            <!-- Revenue -->
            <div class="guide-card">
              <div class="guide-header">
                <span class="guide-title">ë§¤ì¶œì•¡ (Revenue)</span>
                <span class="guide-formula">= íŒë§¤ëŸ‰ Ã— íŒë§¤ê°€ê²©</span>
              </div>
              <p class="guide-what"><strong>ì •ì˜:</strong> ì œí’ˆ/ì„œë¹„ìŠ¤ íŒë§¤ë¡œ ì–»ì€ ì´ ìˆ˜ìµ</p>
              <p class="guide-meaning"><strong>ì˜ë¯¸:</strong> ì‚¬ì—… ê·œëª¨ì™€ ì‹œì¥ ì ìœ ìœ¨ ë°˜ì˜</p>
              <div class="guide-tip">
                <i class="fas fa-lightbulb"></i>
                <span>ë§¤ì¶œ ìì²´ë³´ë‹¤ ì„±ì¥ë¥ ì´ ë” ì¤‘ìš”. ë™ì¢… ì—…ê³„ì™€ ë¹„êµ í•„ìš”</span>
              </div>
            </div>
            <!-- Gross Profit -->
            <div class="guide-card">
              <div class="guide-header">
                <span class="guide-title">ë§¤ì¶œì´ì´ìµ (Gross Profit)</span>
                <span class="guide-formula">= ë§¤ì¶œì•¡ - ë§¤ì¶œì›ê°€</span>
              </div>
              <p class="guide-what"><strong>ì •ì˜:</strong> ì œí’ˆ ì›ê°€ë¥¼ ì œì™¸í•œ ì´ìµ</p>
              <p class="guide-meaning"><strong>ì˜ë¯¸:</strong> ì œí’ˆ/ì„œë¹„ìŠ¤ì˜ ê¸°ë³¸ì ì¸ ìˆ˜ìµì„±</p>
              <div class="guide-interpretation">
                <div class="interp-row interp-high">
                  <span class="interp-range">ë§ˆì§„ 50%+</span>
                  <span class="interp-text">ì†Œí”„íŠ¸ì›¨ì–´, SaaS ë“± ê³ ë§ˆì§„ ì‚¬ì—…</span>
                </div>
                <div class="interp-row interp-neutral">
                  <span class="interp-range">ë§ˆì§„ 20~50%</span>
                  <span class="interp-text">ì œì¡°ì—… ì¼ë°˜ ìˆ˜ì¤€</span>
                </div>
                <div class="interp-row interp-low">
                  <span class="interp-range">ë§ˆì§„ 20% ë¯¸ë§Œ</span>
                  <span class="interp-text">ìœ í†µ, ì›ìì¬ ë“± ì €ë§ˆì§„ ì‚¬ì—…</span>
                </div>
              </div>
            </div>
            <!-- Operating Income -->
            <div class="guide-card">
              <div class="guide-header">
                <span class="guide-title">ì˜ì—…ì´ìµ (Operating Income)</span>
                <span class="guide-formula">= ë§¤ì¶œì´ì´ìµ - íŒê´€ë¹„</span>
              </div>
              <p class="guide-what"><strong>ì •ì˜:</strong> ë³¸ì—… í™œë™ì—ì„œ ë°œìƒí•œ ì´ìµ</p>
              <p class="guide-meaning"><strong>ì˜ë¯¸:</strong> ê¸°ì—…ì˜ í•µì‹¬ ì‚¬ì—… ìˆ˜ìµë ¥</p>
              <div class="guide-interpretation">
                <div class="interp-row interp-high">
                  <span class="interp-range">ë§ˆì§„ 15%+</span>
                  <span class="interp-text">ìš°ìˆ˜í•œ ì˜ì—… íš¨ìœ¨ì„±</span>
                </div>
                <div class="interp-row interp-neutral">
                  <span class="interp-range">ë§ˆì§„ 5~15%</span>
                  <span class="interp-text">ì–‘í˜¸í•œ ìˆ˜ì¤€</span>
                </div>
                <div class="interp-row interp-danger">
                  <span class="interp-range">ë§ˆì§„ 0% ë¯¸ë§Œ</span>
                  <span class="interp-text">ì˜ì—…ì ì (ë³¸ì—… ìˆ˜ìµì„± ë¬¸ì œ)</span>
                </div>
              </div>
            </div>
            <!-- Net Income -->
            <div class="guide-card">
              <div class="guide-header">
                <span class="guide-title">ìˆœì´ìµ (Net Income)</span>
                <span class="guide-formula">= ì˜ì—…ì´ìµ Â± ì˜ì—…ì™¸ì†ìµ - ì„¸ê¸ˆ</span>
              </div>
              <p class="guide-what"><strong>ì •ì˜:</strong> ëª¨ë“  ë¹„ìš©ì„ ì œì™¸í•œ ìµœì¢… ì´ìµ</p>
              <p class="guide-meaning"><strong>ì˜ë¯¸:</strong> ì£¼ì£¼ì—ê²Œ ê·€ì†ë˜ëŠ” ì‹¤ì œ ì´ìµ</p>
              <div class="guide-warning">
                <i class="fas fa-exclamation-triangle"></i>
                <span>ì¼íšŒì„± í•­ëª©(ìì‚°ë§¤ê°, ì†Œì†¡ ë“±) ì œì™¸í•˜ê³  íŒë‹¨í•´ì•¼ ì •í™•</span>
              </div>
            </div>
            <!-- FCF -->
            <div class="guide-card" style="border-left-color: #10b981;">
              <div class="guide-header">
                <span class="guide-title">FCF (ì‰ì—¬í˜„ê¸ˆíë¦„)</span>
                <span class="guide-formula">= ì˜ì—…CF - CapEx</span>
              </div>
              <p class="guide-what"><strong>ì •ì˜:</strong> ì‚¬ì—… ìœ ì§€ì— í•„ìš”í•œ íˆ¬ìë¥¼ ì œì™¸í•œ í˜„ê¸ˆ</p>
              <p class="guide-meaning"><strong>ì˜ë¯¸:</strong> ë°°ë‹¹, ìì‚¬ì£¼ ë§¤ì…, ë¶€ì±„ ìƒí™˜ì— ì‚¬ìš© ê°€ëŠ¥í•œ ì‹¤ì œ í˜„ê¸ˆ</p>
              <div class="guide-interpretation">
                <div class="interp-row interp-high">
                  <span class="interp-range">ì–‘ìˆ˜ ì§€ì†</span>
                  <span class="interp-text">ê±´ì „í•œ í˜„ê¸ˆ ì°½ì¶œë ¥ (DCFì˜ í•µì‹¬)</span>
                </div>
                <div class="interp-row interp-danger">
                  <span class="interp-range">ì§€ì†ì  ìŒìˆ˜</span>
                  <span class="interp-text">í˜„ê¸ˆ ìœ ì¶œ ì§€ì† â†’ ìê¸ˆ ì¡°ë‹¬ í•„ìš”</span>
                </div>
              </div>
              <div class="guide-tip">
                <i class="fas fa-lightbulb"></i>
                <span>ì„±ì¥ ê¸°ì—…ì€ FCF ìŒìˆ˜ê°€ ì •ìƒì¼ ìˆ˜ ìˆìŒ (íˆ¬ì í™•ëŒ€ ì¤‘)</span>
              </div>
            </div>
            <!-- SG&A -->
            <div class="guide-card">
              <div class="guide-header">
                <span class="guide-title">íŒê´€ë¹„ (SG&A)</span>
                <span class="guide-formula">= íŒë§¤ë¹„ + ì¼ë°˜ê´€ë¦¬ë¹„</span>
              </div>
              <p class="guide-what"><strong>ì •ì˜:</strong> ì˜ì—…/ë§ˆì¼€íŒ…, ê´€ë¦¬ ë“± ìš´ì˜ ë¹„ìš©</p>
              <p class="guide-meaning"><strong>ì˜ë¯¸:</strong> ë§¤ì¶œ ëŒ€ë¹„ ë¹„ìœ¨ë¡œ íš¨ìœ¨ì„± íŒë‹¨</p>
              <div class="guide-tip">
                <i class="fas fa-lightbulb"></i>
                <span>ë§¤ì¶œ ì„±ì¥ ì‹œ íŒê´€ë¹„ìœ¨ í•˜ë½ â†’ ê·œëª¨ì˜ ê²½ì œ ë‹¬ì„±</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== VALUATIONS TAB ==================== -->
    <div id="section-valuations" class="content-section">
      <div class="card" style="border-top-left-radius: 0; border-top-right-radius: 0;">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-bold text-gray-800">
            <i class="fas fa-chart-bar text-purple-500 mr-2"></i>ë°¸ë¥˜ì—ì´ì…˜ ë°´ë“œ
          </h2>
          <div class="flex items-center gap-3">
            <label for="valuationSelector" class="text-sm text-gray-600">ì¢…ëª©:</label>
            <select id="valuationSelector" onchange="renderValuationsChart()" class="p-2 border rounded-lg text-sm min-w-48">
              <option value="">-- ì¢…ëª© ì„ íƒ --</option>
            </select>
          </div>
        </div>

        <div class="metric-tabs flex flex-wrap gap-2 mb-4">
          <button class="tab-btn active" data-metric="per" onclick="setValuationMetric('per')">P/E Band</button>
          <button class="tab-btn" data-metric="pbr" onclick="setValuationMetric('pbr')">P/B Band</button>
          <button class="tab-btn" data-metric="psr" onclick="setValuationMetric('psr')">P/S Ratio</button>
          <button class="tab-btn" data-metric="pcr" onclick="setValuationMetric('pcr')">P/C Ratio</button>
          <button class="tab-btn" data-metric="peg" onclick="setValuationMetric('peg')">PEG</button>
        </div>

        <div id="valuationsChartContainer" class="chart-container">
          <canvas id="valuationsChart"></canvas>
          <div id="valuationsEmptyState" class="chart-empty-state">
            <div class="text-center text-gray-400">
              <i class="fas fa-chart-line text-5xl mb-3"></i>
              <p class="text-lg font-medium">ì¢…ëª©ì„ ì„ íƒí•˜ì„¸ìš”</p>
              <p class="text-sm mt-1">5ê°œë…„ ë°¸ë¥˜ì—ì´ì…˜ ë°´ë“œ í™•ì¸</p>
            </div>
          </div>
        </div>

        <!-- Valuation Summary Cards -->
        <div id="valuationSummary" class="grid grid-cols-2 md:grid-cols-6 gap-4 mt-4 hidden">
          <div class="bg-emerald-50 rounded-lg p-4 text-center">
            <div class="text-xs text-gray-500" id="currentPELabel">í˜„ì¬ P/E</div>
            <div class="text-xl font-bold text-emerald-600 mono" id="currentPE">-</div>
          </div>
          <div class="bg-purple-50 rounded-lg p-4 text-center">
            <div class="text-xs text-gray-500" id="forwardPELabel">Forward P/E</div>
            <div class="text-xl font-bold text-purple-600 mono" id="forwardPE">-</div>
          </div>
          <div class="bg-blue-50 rounded-lg p-4 text-center">
            <div class="text-xs text-gray-500" id="avgPELabel">8Y í‰ê·  P/E</div>
            <div class="text-xl font-bold text-blue-600 mono" id="avgPE">-</div>
          </div>
          <div class="bg-gray-50 rounded-lg p-4 text-center">
            <div class="text-xs text-gray-500" id="minPELabel">8Y ìµœì € P/E</div>
            <div class="text-xl font-bold text-gray-600 mono" id="minPE">-</div>
          </div>
          <div class="bg-amber-50 rounded-lg p-4 text-center">
            <div class="text-xs text-gray-500" id="maxPELabel">8Y ìµœê³  P/E</div>
            <div class="text-xl font-bold text-amber-600 mono" id="maxPE">-</div>
          </div>
          <!-- P/E Position Badge (v4.3) -->
          <div id="pePositionCard" class="rounded-lg p-4 text-center" role="status" aria-live="polite">
            <div class="text-xs text-gray-500" id="positionLabel">ë°¸ë¥˜ì—ì´ì…˜ ìœ„ì¹˜</div>
            <div class="text-lg font-bold" id="pePositionBadge">-</div>
          </div>
        </div>

        <!-- #197: Valuations Indicator Guide -->
        <div class="mt-6">
          <button onclick="toggleIndicatorGuide('valuations')" class="guide-toggle" id="valuationsGuideToggle">
            <span><i class="fas fa-book-open mr-2"></i>ë°¸ë¥˜ì—ì´ì…˜ ì§€í‘œ ê°€ì´ë“œ (ì´ˆë³´ììš©)</span>
            <i class="fas fa-chevron-down"></i>
          </button>
          <div id="valuationsGuideContent" class="guide-panel">
            <!-- P/E -->
            <div class="guide-card">
              <div class="guide-header">
                <span class="guide-title">P/E (ì£¼ê°€ìˆ˜ìµë¹„ìœ¨)</span>
                <span class="guide-formula">= ì£¼ê°€ Ã· EPS</span>
              </div>
              <p class="guide-what"><strong>ì •ì˜:</strong> í˜„ì¬ ì£¼ê°€ê°€ ì£¼ë‹¹ìˆœì´ìµ(EPS)ì˜ ëª‡ ë°°ì¸ì§€ ë‚˜íƒ€ë‚´ëŠ” ì§€í‘œ</p>
              <p class="guide-meaning"><strong>ì˜ë¯¸:</strong> íˆ¬ììë“¤ì´ ì´ íšŒì‚¬ì˜ $1 ì´ìµì— ì–¼ë§ˆë¥¼ ì§€ë¶ˆí•˜ëŠ”ê°€</p>
              <div class="guide-interpretation">
                <div class="interp-row interp-low">
                  <span class="interp-range">10 ì´í•˜</span>
                  <span class="interp-text">ì €í‰ê°€ ê°€ëŠ¥ì„± (ë˜ëŠ” ì„±ì¥ ë‘”í™” ìš°ë ¤)</span>
                </div>
                <div class="interp-row interp-neutral">
                  <span class="interp-range">15~25</span>
                  <span class="interp-text">ì‹œì¥ í‰ê·  ìˆ˜ì¤€ (ì—…ì¢…ë³„ ì°¨ì´ í¼)</span>
                </div>
                <div class="interp-row interp-high">
                  <span class="interp-range">30+</span>
                  <span class="interp-text">ê³ í‰ê°€ (ë˜ëŠ” ê³ ì„±ì¥ ê¸°ëŒ€ ë°˜ì˜)</span>
                </div>
              </div>
              <div class="guide-warning">
                <i class="fas fa-exclamation-triangle"></i>
                <span>ì ì ê¸°ì—…ì€ P/E ì˜ë¯¸ ì—†ìŒ â†’ P/S ë˜ëŠ” EV/EBITDA í™œìš©</span>
              </div>
            </div>
            <!-- Forward P/E -->
            <div class="guide-card">
              <div class="guide-header">
                <span class="guide-title">Forward P/E (ì„ í–‰ PER)</span>
                <span class="guide-formula">= ì£¼ê°€ Ã· ì˜ˆìƒ EPS</span>
              </div>
              <p class="guide-what"><strong>ì •ì˜:</strong> ë¯¸ë˜ ì˜ˆìƒ ì´ìµ ê¸°ì¤€ì˜ P/E</p>
              <p class="guide-meaning"><strong>ì˜ë¯¸:</strong> ì‹œì¥ì´ ë¯¸ë˜ ì‹¤ì ì„ ì–´ë–»ê²Œ í‰ê°€í•˜ëŠ”ì§€ ë³´ì—¬ì¤Œ</p>
              <div class="guide-tip">
                <i class="fas fa-lightbulb"></i>
                <span>Forward P/Eê°€ í˜„ì¬ P/Eë³´ë‹¤ ë‚®ìœ¼ë©´ â†’ ì´ìµ ì„±ì¥ ê¸°ëŒ€</span>
              </div>
            </div>
            <!-- P/B -->
            <div class="guide-card">
              <div class="guide-header">
                <span class="guide-title">P/B (ì£¼ê°€ìˆœìì‚°ë¹„ìœ¨)</span>
                <span class="guide-formula">= ì£¼ê°€ Ã· BPS</span>
              </div>
              <p class="guide-what"><strong>ì •ì˜:</strong> ì£¼ê°€ê°€ 1ì£¼ë‹¹ ìˆœìì‚°(ì¥ë¶€ê°€ì¹˜)ì˜ ëª‡ ë°°ì¸ì§€</p>
              <p class="guide-meaning"><strong>ì˜ë¯¸:</strong> ê¸°ì—…ì˜ ìˆœìì‚° ëŒ€ë¹„ ì‹œì¥ í‰ê°€</p>
              <div class="guide-interpretation">
                <div class="interp-row interp-low">
                  <span class="interp-range">1 ë¯¸ë§Œ</span>
                  <span class="interp-text">ì¥ë¶€ê°€ì¹˜ ì´í•˜ ê±°ë˜ (ì €í‰ê°€ ë˜ëŠ” ë¬¸ì œ ê¸°ì—…)</span>
                </div>
                <div class="interp-row interp-neutral">
                  <span class="interp-range">1~3</span>
                  <span class="interp-text">ì ì • ìˆ˜ì¤€ (ì—…ì¢…ì— ë”°ë¼ ë‹¤ë¦„)</span>
                </div>
                <div class="interp-row interp-high">
                  <span class="interp-range">3+</span>
                  <span class="interp-text">í”„ë¦¬ë¯¸ì—„ í‰ê°€ (ë¸Œëœë“œ ê°€ì¹˜, ë¬´í˜•ìì‚°)</span>
                </div>
              </div>
            </div>
            <!-- P/S -->
            <div class="guide-card">
              <div class="guide-header">
                <span class="guide-title">P/S (ì£¼ê°€ë§¤ì¶œë¹„ìœ¨)</span>
                <span class="guide-formula">= ì£¼ê°€ Ã· SPS</span>
              </div>
              <p class="guide-what"><strong>ì •ì˜:</strong> ì£¼ê°€ê°€ 1ì£¼ë‹¹ ë§¤ì¶œì˜ ëª‡ ë°°ì¸ì§€</p>
              <p class="guide-meaning"><strong>ì˜ë¯¸:</strong> ì ì ê¸°ì—…ì´ë‚˜ ê³ ì„±ì¥ ê¸°ì—… í‰ê°€ì— ìœ ìš©</p>
              <div class="guide-interpretation">
                <div class="interp-row interp-neutral">
                  <span class="interp-range">1~2</span>
                  <span class="interp-text">ì „í†µ ê¸°ì—… ì ì • ìˆ˜ì¤€</span>
                </div>
                <div class="interp-row interp-high">
                  <span class="interp-range">10+</span>
                  <span class="interp-text">SaaS/ê³ ì„±ì¥ ê¸°ì—…ì€ ë†’ì„ ìˆ˜ ìˆìŒ</span>
                </div>
              </div>
              <div class="guide-tip">
                <i class="fas fa-lightbulb"></i>
                <span>ì ì ê¸°ì—…ë„ P/Së¡œ ë¹„êµ ê°€ëŠ¥ (ë§¤ì¶œì€ í•­ìƒ ì–‘ìˆ˜)</span>
              </div>
            </div>
            <!-- PEG -->
            <div class="guide-card">
              <div class="guide-header">
                <span class="guide-title">PEG (ì£¼ê°€ìˆ˜ìµì„±ì¥ë¹„ìœ¨)</span>
                <span class="guide-formula">= P/E Ã· EPS ì„±ì¥ë¥ </span>
              </div>
              <p class="guide-what"><strong>ì •ì˜:</strong> P/Eë¥¼ ì´ìµ ì„±ì¥ë¥ ë¡œ ë‚˜ëˆˆ ê°’</p>
              <p class="guide-meaning"><strong>ì˜ë¯¸:</strong> ì„±ì¥ë¥ ì„ ê°ì•ˆí•œ ë°¸ë¥˜ì—ì´ì…˜ ì ì •ì„± íŒë‹¨</p>
              <div class="guide-interpretation">
                <div class="interp-row interp-low">
                  <span class="interp-range">1 ë¯¸ë§Œ</span>
                  <span class="interp-text">ì €í‰ê°€ (ì„±ì¥ë¥  ëŒ€ë¹„ P/E ë‚®ìŒ)</span>
                </div>
                <div class="interp-row interp-neutral">
                  <span class="interp-range">1</span>
                  <span class="interp-text">ì ì • í‰ê°€</span>
                </div>
                <div class="interp-row interp-high">
                  <span class="interp-range">1 ì´ˆê³¼</span>
                  <span class="interp-text">ê³ í‰ê°€ (ì„±ì¥ë¥  ëŒ€ë¹„ P/E ë†’ìŒ)</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== GROWTH TAB ==================== -->
    <div id="section-growth" class="content-section">
      <div class="card" style="border-top-left-radius: 0; border-top-right-radius: 0;">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-bold text-gray-800">
            <i class="fas fa-arrow-trend-up text-orange-500 mr-2"></i>ì„±ì¥ì„± ë¶„ì„
          </h2>
          <div class="flex items-center gap-3">
            <label for="growthSelector" class="text-sm text-gray-600">ì¢…ëª©:</label>
            <select id="growthSelector" onchange="renderGrowthChart()" class="p-2 border rounded-lg text-sm min-w-48">
              <option value="">-- ì¢…ëª© ì„ íƒ --</option>
            </select>
          </div>
        </div>

        <div class="metric-tabs flex flex-wrap gap-2 mb-4">
          <button class="tab-btn active" data-metric="revenue_growth" onclick="setGrowthMetric('revenue_growth')">ë§¤ì¶œ ì„±ì¥ë¥ </button>
          <button class="tab-btn" data-metric="op_income_growth" onclick="setGrowthMetric('op_income_growth')">ì˜ì—…ì´ìµ ì„±ì¥ë¥ </button>
          <button class="tab-btn" data-metric="net_income_growth" onclick="setGrowthMetric('net_income_growth')">ìˆœì´ìµ ì„±ì¥ë¥ </button>
          <button class="tab-btn" data-metric="eps_growth" onclick="setGrowthMetric('eps_growth')">EPS ì„±ì¥ë¥ </button>
          <button class="tab-btn" data-metric="estimates" onclick="setGrowthMetric('estimates')">EPS ì»¨ì„¼ì„œìŠ¤</button>
        </div>

        <div id="growthChartContainer" class="chart-container">
          <canvas id="growthChart"></canvas>
          <div id="growthEmptyState" class="chart-empty-state">
            <div class="text-center text-gray-400">
              <i class="fas fa-chart-area text-5xl mb-3"></i>
              <p class="text-lg font-medium">ì¢…ëª©ì„ ì„ íƒí•˜ì„¸ìš”</p>
              <p class="text-sm mt-1">ê³¼ê±° ì„±ì¥ë¥  + í–¥í›„ ì»¨ì„¼ì„œìŠ¤</p>
            </div>
          </div>
        </div>

        <!-- Growth Summary -->
        <div id="growthSummary" class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4 hidden">
          <div class="bg-orange-50 rounded-lg p-4 text-center">
            <div class="text-xs text-gray-500">ë§¤ì¶œ CAGR (5Y)</div>
            <div class="text-xl font-bold text-orange-600 mono" id="revCAGR">-</div>
          </div>
          <div class="bg-purple-50 rounded-lg p-4 text-center">
            <div class="text-xs text-gray-500">EPS CAGR (5Y)</div>
            <div class="text-xl font-bold text-purple-600 mono" id="epsCAGR">-</div>
          </div>
          <div class="bg-emerald-50 rounded-lg p-4 text-center">
            <div class="text-xs text-gray-500">FY1 EPS ì˜ˆìƒ</div>
            <div class="text-xl font-bold text-emerald-600 mono" id="fy1EPS">-</div>
          </div>
          <div class="bg-blue-50 rounded-lg p-4 text-center">
            <div class="text-xs text-gray-500">FY2 EPS ì˜ˆìƒ</div>
            <div class="text-xl font-bold text-blue-600 mono" id="fy2EPS">-</div>
          </div>
        </div>

        <!-- v4.3: Growth Consensus (ì¥ê¸° ì„±ì¥ ì»¨ì„¼ì„œìŠ¤) - ìƒ‰ìƒ 2ê³„ì—´ (ë§¤ì¶œ=Blue, ì´ìµ=Amber) -->
        <div id="growthConsensus" class="mt-4 hidden">
          <h4 class="text-sm font-semibold text-gray-600 mb-2">ğŸ“Š ì¥ê¸° ì„±ì¥ ì»¨ì„¼ì„œìŠ¤</h4>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-2 md:gap-3">
            <!-- ë§¤ì¶œ ì„±ì¥ (Blue ê³„ì—´) -->
            <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-3 text-center border border-blue-200">
              <div class="text-xs text-blue-700">ë§¤ì¶œ ì„±ì¥ (7Y)</div>
              <div class="text-base md:text-lg font-bold text-blue-600 mono" id="revGrowth7y">-</div>
            </div>
            <div class="bg-gradient-to-br from-blue-50 to-sky-100 rounded-lg p-3 text-center border border-sky-200">
              <div class="text-xs text-sky-700">ë§¤ì¶œ ì„±ì¥ (3Y)</div>
              <div class="text-base md:text-lg font-bold text-sky-600 mono" id="revGrowth3y">-</div>
            </div>
            <!-- ì´ìµ ì„±ì¥ (Amber ê³„ì—´) -->
            <div class="bg-gradient-to-br from-amber-50 to-orange-100 rounded-lg p-3 text-center border border-orange-200">
              <div class="text-xs text-orange-700">ì´ìµ ì„±ì¥ (7Y)</div>
              <div class="text-base md:text-lg font-bold text-orange-600 mono" id="earnGrowth7y">-</div>
            </div>
            <div class="bg-gradient-to-br from-amber-50 to-amber-100 rounded-lg p-3 text-center border border-amber-200">
              <div class="text-xs text-amber-700">ì´ìµ ì„±ì¥ (3Y)</div>
              <div class="text-base md:text-lg font-bold text-amber-600 mono" id="earnGrowth3y">-</div>
            </div>
          </div>
          <div class="mt-2 flex items-center gap-2">
            <span class="text-xs text-gray-500">ì¢…ëª© ë¶„ë¥˜:</span>
            <span id="growthBadge" class="px-2 py-1 rounded text-xs font-semibold">-</span>
          </div>
        </div>

        <!-- #197: Growth Indicator Guide -->
        <div class="mt-6">
          <button onclick="toggleIndicatorGuide('growth')" class="guide-toggle" id="growthGuideToggle">
            <span><i class="fas fa-book-open mr-2"></i>ì„±ì¥ì„± ì§€í‘œ ê°€ì´ë“œ (ì´ˆë³´ììš©)</span>
            <i class="fas fa-chevron-down"></i>
          </button>
          <div id="growthGuideContent" class="guide-panel">
            <!-- Revenue Growth -->
            <div class="guide-card">
              <div class="guide-header">
                <span class="guide-title">ë§¤ì¶œ ì„±ì¥ë¥  (Revenue Growth)</span>
                <span class="guide-formula">= (ê¸ˆë…„ ë§¤ì¶œ - ì „ë…„ ë§¤ì¶œ) Ã· ì „ë…„ ë§¤ì¶œ</span>
              </div>
              <p class="guide-what"><strong>ì •ì˜:</strong> ì „ë…„ ëŒ€ë¹„ ë§¤ì¶œ ì¦ê°€ìœ¨</p>
              <p class="guide-meaning"><strong>ì˜ë¯¸:</strong> ì‚¬ì—… í™•ì¥ ì†ë„, ì‹œì¥ ì ìœ ìœ¨ í™•ëŒ€ ì—¬ë¶€</p>
              <div class="guide-interpretation">
                <div class="interp-row interp-high">
                  <span class="interp-range">20%+</span>
                  <span class="interp-text">ê³ ì„±ì¥ì£¼ (Tech, ë°”ì´ì˜¤ ë“±)</span>
                </div>
                <div class="interp-row interp-neutral">
                  <span class="interp-range">5~20%</span>
                  <span class="interp-text">ì•ˆì •ì  ì„±ì¥</span>
                </div>
                <div class="interp-row interp-danger">
                  <span class="interp-range">ë§ˆì´ë„ˆìŠ¤</span>
                  <span class="interp-text">ì—­ì„±ì¥ (ì‹œì¥ ì¶•ì†Œ ë˜ëŠ” ê²½ìŸ ì—´ìœ„)</span>
                </div>
              </div>
            </div>
            <!-- EPS Growth -->
            <div class="guide-card">
              <div class="guide-header">
                <span class="guide-title">EPS ì„±ì¥ë¥  (EPS Growth)</span>
                <span class="guide-formula">= (ê¸ˆë…„ EPS - ì „ë…„ EPS) Ã· ì „ë…„ EPS</span>
              </div>
              <p class="guide-what"><strong>ì •ì˜:</strong> ì£¼ë‹¹ìˆœì´ìµ ì¦ê°€ìœ¨</p>
              <p class="guide-meaning"><strong>ì˜ë¯¸:</strong> ìˆ˜ìµì„± ê°œì„  ì†ë„, ì£¼ì£¼ê°€ì¹˜ ì°½ì¶œë ¥</p>
              <div class="guide-tip">
                <i class="fas fa-lightbulb"></i>
                <span>EPS ì„±ì¥ë¥  > ë§¤ì¶œ ì„±ì¥ë¥  â†’ ìš´ì˜ íš¨ìœ¨ ê°œì„  ì¤‘</span>
              </div>
            </div>
            <!-- CAGR -->
            <div class="guide-card" style="border-left-color: #f59e0b;">
              <div class="guide-header">
                <span class="guide-title">CAGR (ì—°í‰ê·  ì„±ì¥ë¥ )</span>
                <span class="guide-formula">= (ìµœì¢…ê°’/ìµœì´ˆê°’)^(1/ê¸°ê°„) - 1</span>
              </div>
              <p class="guide-what"><strong>ì •ì˜:</strong> ì—¬ëŸ¬ í•´ì— ê±¸ì¹œ í‰ê·  ì„±ì¥ë¥ </p>
              <p class="guide-meaning"><strong>ì˜ë¯¸:</strong> ì¥ê¸° ì„±ì¥ ì¶”ì„¸ë¥¼ ë‹¨ì¼ ìˆ«ìë¡œ í‘œí˜„</p>
              <div class="guide-interpretation">
                <div class="interp-row interp-high">
                  <span class="interp-range">15%+ (5Y)</span>
                  <span class="interp-text">ìš°ìˆ˜í•œ ì¥ê¸° ì„±ì¥</span>
                </div>
                <div class="interp-row interp-neutral">
                  <span class="interp-range">5~15%</span>
                  <span class="interp-text">ì–‘í˜¸í•œ ì„±ì¥</span>
                </div>
                <div class="interp-row interp-low">
                  <span class="interp-range">5% ë¯¸ë§Œ</span>
                  <span class="interp-text">ì €ì„±ì¥ (ì„±ìˆ™ê¸°ì—… ë˜ëŠ” ì •ì²´)</span>
                </div>
              </div>
              <div class="guide-tip">
                <i class="fas fa-lightbulb"></i>
                <span>ë‹¨ë…„ë„ ê¸‰ë“±ë½ë³´ë‹¤ CAGRì´ ë” ì‹ ë¢°ì„± ìˆëŠ” ì§€í‘œ</span>
              </div>
            </div>
            <!-- Estimates -->
            <div class="guide-card">
              <div class="guide-header">
                <span class="guide-title">EPS ì»¨ì„¼ì„œìŠ¤ (Estimates)</span>
                <span class="guide-formula">= ì• ë„ë¦¬ìŠ¤íŠ¸ ì˜ˆìƒ EPS í‰ê· </span>
              </div>
              <p class="guide-what"><strong>ì •ì˜:</strong> ì¦ê¶Œì‚¬ ì• ë„ë¦¬ìŠ¤íŠ¸ë“¤ì˜ ì´ìµ ì „ë§ì¹˜ í‰ê· </p>
              <p class="guide-meaning"><strong>ì˜ë¯¸:</strong> ì‹œì¥ì˜ ê¸°ëŒ€ì¹˜, ì‹¤ì  ì„œí”„ë¼ì´ì¦ˆ íŒë‹¨ ê¸°ì¤€</p>
              <div class="guide-warning">
                <i class="fas fa-exclamation-triangle"></i>
                <span>ì‹¤ì  ë°œí‘œ ì‹œ ì»¨ì„¼ì„œìŠ¤ ëŒ€ë¹„ Beat/Miss ì—¬ë¶€ê°€ ì£¼ê°€ì— í° ì˜í–¥</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== DIVIDENDS TAB ==================== -->
    <div id="section-dividends" class="content-section">
      <div class="card" style="border-top-left-radius: 0; border-top-right-radius: 0;">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-bold text-gray-800">
            <i class="fas fa-coins text-yellow-500 mr-2"></i>ë°°ë‹¹ ë¶„ì„
          </h2>
          <div class="flex items-center gap-3">
            <label for="dividendSelector" class="text-sm text-gray-600">ì¢…ëª©:</label>
            <select id="dividendSelector" onchange="renderDividendChart()" class="p-2 border rounded-lg text-sm min-w-48">
              <option value="">-- ì¢…ëª© ì„ íƒ --</option>
            </select>
          </div>
        </div>

        <div class="metric-tabs flex flex-wrap gap-2 mb-4">
          <button class="tab-btn active" data-metric="dps" onclick="setDividendMetric('dps')">ì£¼ë‹¹ ë°°ë‹¹ê¸ˆ</button>
          <button class="tab-btn" data-metric="div_yield" onclick="setDividendMetric('div_yield')">ë°°ë‹¹ ìˆ˜ìµë¥ </button>
          <button class="tab-btn" data-metric="roe" onclick="setDividendMetric('roe')">ROE</button>
          <button class="tab-btn" data-metric="roa" onclick="setDividendMetric('roa')">ROA</button>
          <button class="tab-btn" data-metric="gross_margin" onclick="setDividendMetric('gross_margin')">ë§¤ì¶œì´ì´ìµë¥ </button>
          <button class="tab-btn" data-metric="operating_margin" onclick="setDividendMetric('operating_margin')">ì˜ì—…ì´ìµë¥ </button>
          <button class="tab-btn" data-metric="net_margin" onclick="setDividendMetric('net_margin')">ìˆœì´ìµë¥ </button>
        </div>

        <div id="dividendChartContainer" class="chart-container">
          <canvas id="dividendChart"></canvas>
          <div id="dividendEmptyState" class="chart-empty-state">
            <div class="text-center text-gray-400">
              <i class="fas fa-money-bill-wave text-5xl mb-3"></i>
              <p class="text-lg font-medium">ì¢…ëª©ì„ ì„ íƒí•˜ì„¸ìš”</p>
              <p class="text-sm mt-1">ë°°ë‹¹ê¸ˆ ì¶”ì´ + ìˆ˜ìµë¥  í™•ì¸</p>
            </div>
          </div>
        </div>

        <!-- Dividend Summary -->
        <div id="dividendSummary" class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4 hidden">
          <div class="bg-yellow-50 rounded-lg p-4 text-center">
            <div class="text-xs text-gray-500">í˜„ì¬ DPS</div>
            <div class="text-xl font-bold text-yellow-600 mono" id="currentDPS">-</div>
          </div>
          <div class="bg-green-50 rounded-lg p-4 text-center">
            <div class="text-xs text-gray-500">ë°°ë‹¹ ìˆ˜ìµë¥ </div>
            <div class="text-xl font-bold text-green-600 mono" id="currentYield">-</div>
          </div>
          <div class="bg-blue-50 rounded-lg p-4 text-center">
            <div class="text-xs text-gray-500">DPS CAGR (5Y)</div>
            <div class="text-xl font-bold text-blue-600 mono" id="dpsCAGR">-</div>
          </div>
          <div class="bg-purple-50 rounded-lg p-4 text-center">
            <div class="text-xs text-gray-500">í‰ê·  ROE</div>
            <div class="text-xl font-bold text-purple-600 mono" id="avgROE">-</div>
          </div>
        </div>

        <!-- #197: Dividends Indicator Guide -->
        <div class="mt-6">
          <button onclick="toggleIndicatorGuide('dividends')" class="guide-toggle" id="dividendsGuideToggle">
            <span><i class="fas fa-book-open mr-2"></i>ë°°ë‹¹/ìˆ˜ìµì„± ì§€í‘œ ê°€ì´ë“œ (ì´ˆë³´ììš©)</span>
            <i class="fas fa-chevron-down"></i>
          </button>
          <div id="dividendsGuideContent" class="guide-panel">
            <!-- DPS -->
            <div class="guide-card" style="border-left-color: #eab308;">
              <div class="guide-header">
                <span class="guide-title">DPS (ì£¼ë‹¹ ë°°ë‹¹ê¸ˆ)</span>
                <span class="guide-formula">= ì´ ë°°ë‹¹ê¸ˆ Ã· ë°œí–‰ì£¼ì‹ìˆ˜</span>
              </div>
              <p class="guide-what"><strong>ì •ì˜:</strong> 1ì£¼ë‹¹ ì§€ê¸‰ë°›ëŠ” ë°°ë‹¹ê¸ˆ</p>
              <p class="guide-meaning"><strong>ì˜ë¯¸:</strong> ì£¼ì£¼í™˜ì› ê·œëª¨, ì•ˆì •ì  í˜„ê¸ˆíë¦„ ì‹ í˜¸</p>
              <div class="guide-tip">
                <i class="fas fa-lightbulb"></i>
                <span>DPS ìƒìŠ¹ ì¶”ì„¸ = ê²½ì˜ì§„ì˜ ì£¼ì£¼í™˜ì› ì˜ì§€ + ì´ìµ ì•ˆì •ì„±</span>
              </div>
            </div>
            <!-- Dividend Yield -->
            <div class="guide-card" style="border-left-color: #22c55e;">
              <div class="guide-header">
                <span class="guide-title">ë°°ë‹¹ ìˆ˜ìµë¥  (Dividend Yield)</span>
                <span class="guide-formula">= DPS Ã· ì£¼ê°€ Ã— 100</span>
              </div>
              <p class="guide-what"><strong>ì •ì˜:</strong> í˜„ì¬ ì£¼ê°€ ëŒ€ë¹„ ì—°ê°„ ë°°ë‹¹ê¸ˆ ë¹„ìœ¨</p>
              <p class="guide-meaning"><strong>ì˜ë¯¸:</strong> íˆ¬ìê¸ˆ ëŒ€ë¹„ ë°°ë‹¹ ìˆ˜ìµë¥ </p>
              <div class="guide-interpretation">
                <div class="interp-row interp-low">
                  <span class="interp-range">1% ë¯¸ë§Œ</span>
                  <span class="interp-text">ì„±ì¥ì£¼ (ë°°ë‹¹ë³´ë‹¤ ì¬íˆ¬ì ìš°ì„ )</span>
                </div>
                <div class="interp-row interp-neutral">
                  <span class="interp-range">2~4%</span>
                  <span class="interp-text">ì•ˆì •ì  ë°°ë‹¹ (S&P 500 í‰ê·  ìˆ˜ì¤€)</span>
                </div>
                <div class="interp-row interp-high">
                  <span class="interp-range">5%+</span>
                  <span class="interp-text">ê³ ë°°ë‹¹ (ì§€ì†ì„± ê²€í†  í•„ìš”)</span>
                </div>
              </div>
              <div class="guide-warning">
                <i class="fas fa-exclamation-triangle"></i>
                <span>ìˆ˜ìµë¥ ì´ ë„ˆë¬´ ë†’ìœ¼ë©´ â†’ ì£¼ê°€ ê¸‰ë½ ë˜ëŠ” ë°°ë‹¹ ì§€ì† ë¶ˆê°€ ì‹ í˜¸ì¼ ìˆ˜ ìˆìŒ</span>
              </div>
            </div>
            <!-- ROE -->
            <div class="guide-card">
              <div class="guide-header">
                <span class="guide-title">ROE (ìê¸°ìë³¸ì´ìµë¥ )</span>
                <span class="guide-formula">= ìˆœì´ìµ Ã· ìê¸°ìë³¸ Ã— 100</span>
              </div>
              <p class="guide-what"><strong>ì •ì˜:</strong> ì£¼ì£¼ íˆ¬ìê¸ˆ ëŒ€ë¹„ ì´ìµ ì°½ì¶œ íš¨ìœ¨</p>
              <p class="guide-meaning"><strong>ì˜ë¯¸:</strong> ìë³¸ í™œìš© íš¨ìœ¨ì„±, ë³µë¦¬ ì„±ì¥ ì ì¬ë ¥</p>
              <div class="guide-interpretation">
                <div class="interp-row interp-high">
                  <span class="interp-range">15%+</span>
                  <span class="interp-text">ìš°ìˆ˜ (ë²„í• ê¸°ì¤€: 15% ì´ìƒ ì§€ì†)</span>
                </div>
                <div class="interp-row interp-neutral">
                  <span class="interp-range">10~15%</span>
                  <span class="interp-text">ì–‘í˜¸</span>
                </div>
                <div class="interp-row interp-low">
                  <span class="interp-range">10% ë¯¸ë§Œ</span>
                  <span class="interp-text">ì €ì¡° (ìë³¸ í™œìš© ë¹„íš¨ìœ¨)</span>
                </div>
              </div>
            </div>
            <!-- ROA -->
            <div class="guide-card">
              <div class="guide-header">
                <span class="guide-title">ROA (ì´ìì‚°ì´ìµë¥ )</span>
                <span class="guide-formula">= ìˆœì´ìµ Ã· ì´ìì‚° Ã— 100</span>
              </div>
              <p class="guide-what"><strong>ì •ì˜:</strong> ì´ìì‚° ëŒ€ë¹„ ì´ìµ ì°½ì¶œ íš¨ìœ¨</p>
              <p class="guide-meaning"><strong>ì˜ë¯¸:</strong> ìì‚° í™œìš© íš¨ìœ¨ (ë¶€ì±„ í¬í•¨ ì „ì²´ ìì›)</p>
              <div class="guide-interpretation">
                <div class="interp-row interp-high">
                  <span class="interp-range">5%+</span>
                  <span class="interp-text">ìš°ìˆ˜</span>
                </div>
                <div class="interp-row interp-neutral">
                  <span class="interp-range">2~5%</span>
                  <span class="interp-text">ì–‘í˜¸</span>
                </div>
                <div class="interp-row interp-low">
                  <span class="interp-range">2% ë¯¸ë§Œ</span>
                  <span class="interp-text">ì €ì¡°</span>
                </div>
              </div>
              <div class="guide-tip">
                <i class="fas fa-lightbulb"></i>
                <span>ROEì™€ ROA ì°¨ì´ê°€ í¬ë©´ â†’ ë ˆë²„ë¦¬ì§€(ë¶€ì±„) ì˜ì¡´ë„ ë†’ìŒ</span>
              </div>
            </div>
            <!-- Margins -->
            <div class="guide-card">
              <div class="guide-header">
                <span class="guide-title">ì´ìµë¥  (Profit Margins)</span>
                <span class="guide-formula">= ì´ìµ Ã· ë§¤ì¶œ Ã— 100</span>
              </div>
              <p class="guide-what"><strong>ì •ì˜:</strong> ë§¤ì¶œ ëŒ€ë¹„ ê° ë‹¨ê³„ë³„ ì´ìµ ë¹„ìœ¨</p>
              <p class="guide-meaning"><strong>ì˜ë¯¸:</strong> ë¹„ìš© í†µì œë ¥, ê°€ê²© ê²°ì •ë ¥</p>
              <div class="guide-interpretation">
                <div class="interp-row interp-neutral">
                  <span class="interp-range">ë§¤ì¶œì´ì´ìµë¥ </span>
                  <span class="interp-text">ì œí’ˆ/ì„œë¹„ìŠ¤ ê¸°ë³¸ ë§ˆì§„ (ì›ê°€ ê²½ìŸë ¥)</span>
                </div>
                <div class="interp-row interp-neutral">
                  <span class="interp-range">ì˜ì—…ì´ìµë¥ </span>
                  <span class="interp-text">ë³¸ì—… ìˆ˜ìµì„± (ìš´ì˜ íš¨ìœ¨ì„±)</span>
                </div>
                <div class="interp-row interp-neutral">
                  <span class="interp-range">ìˆœì´ìµë¥ </span>
                  <span class="interp-text">ìµœì¢… ìˆ˜ìµì„± (ì„¸ê¸ˆ, ì´ì í¬í•¨)</span>
                </div>
              </div>
              <div class="guide-tip">
                <i class="fas fa-lightbulb"></i>
                <span>ë§ˆì§„ ê°œì„  ì¶”ì„¸ = ê·œëª¨ì˜ ê²½ì œ ë˜ëŠ” ë¹„ìš© ì ˆê° ì„±ê³µ</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== DCF CALCULATOR TAB (#192) ==================== -->
    <div id="section-dcf" class="content-section">
      <div class="card" style="border-top-left-radius: 0; border-top-right-radius: 0;">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-bold text-gray-800">
            <i class="fas fa-calculator text-indigo-500 mr-2"></i>DCF Calculator
          </h2>
          <div class="flex items-center gap-3">
            <label for="dcfSelector" class="text-sm text-gray-600">ì¢…ëª©:</label>
            <select id="dcfSelector" onchange="renderDCFTab()" class="p-2 border rounded-lg text-sm min-w-48">
              <option value="">-- ì¢…ëª© ì„ íƒ --</option>
            </select>
          </div>
        </div>

        <div id="dcfContent">
          <div id="dcfEmptyState" class="chart-empty-state" style="height: 300px; position: relative;">
            <div class="text-center text-gray-400">
              <i class="fas fa-calculator text-5xl mb-3"></i>
              <p class="text-lg font-medium">ì¢…ëª©ì„ ì„ íƒí•˜ì„¸ìš”</p>
              <p class="text-sm mt-1">FCF ê¸°ë°˜ DCF ë°¸ë¥˜ì—ì´ì…˜ + Damodaran WACC ìë™ ì—°ë™</p>
            </div>
          </div>

          <div id="dcfResults" class="hidden">
            <!-- FCF ë°ì´í„° + íŒŒë¼ë¯¸í„° -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <!-- FCF ë°ì´í„° ì¹´ë“œ -->
              <div class="bg-gradient-to-br from-emerald-50 to-white p-4 rounded-lg border border-emerald-100">
                <h3 class="text-sm font-bold text-emerald-700 mb-3"><i class="fas fa-money-bill-trend-up mr-1"></i>FCF ë°ì´í„° (5ê°œë…„)</h3>
                <div id="dcfFCFData" class="grid grid-cols-5 gap-2 text-center"></div>
                <div class="mt-3 pt-3 border-t border-emerald-100">
                  <div class="flex justify-between items-center">
                    <span class="text-xs text-gray-500">5Y FCF CAGR</span>
                    <span id="dcfFCFCAGR" class="font-bold text-emerald-600 mono">-</span>
                  </div>
                </div>
              </div>

              <!-- íŒŒë¼ë¯¸í„° ìŠ¬ë¼ì´ë” -->
              <div class="bg-gradient-to-br from-purple-50 to-white p-4 rounded-lg border border-purple-100">
                <h3 class="text-sm font-bold text-purple-700 mb-3"><i class="fas fa-sliders-h mr-1"></i>DCF íŒŒë¼ë¯¸í„°</h3>
                <div class="space-y-3">
                  <div>
                    <div class="flex justify-between text-xs mb-1">
                      <span class="text-gray-600">ì„±ì¥ë¥  (g)</span>
                      <span id="dcfGrowthValue" class="font-bold text-purple-600">10.0%</span>
                    </div>
                    <input type="range" id="dcfGrowthSlider" min="0" max="30" step="0.5" value="10"
                           class="w-full h-2 bg-purple-200 rounded-lg cursor-pointer" oninput="updateDCFCalc()">
                    <div class="param-hint" id="dcfGrowthHint">
                      <i class="fas fa-lightbulb param-hint-icon"></i>
                      <span id="dcfGrowthSectorRef">ì„¹í„° ë°ì´í„° ë¡œë”©...</span>
                    </div>
                    <div class="param-range">
                      <span>ë³´ìˆ˜ì : 3-5%</span>
                      <span>ì¤‘ë¦½: 8-12%</span>
                      <span>ê³µê²©ì : 15%+</span>
                    </div>
                  </div>
                  <div>
                    <div class="flex justify-between text-xs mb-1">
                      <span class="text-gray-600">WACC <span id="dcfWACCSource" class="text-purple-400">(Damodaran)</span></span>
                      <span id="dcfWACCValue" class="font-bold text-purple-600">10.0%</span>
                    </div>
                    <input type="range" id="dcfWACCSlider" min="4" max="20" step="0.25" value="10"
                           class="w-full h-2 bg-purple-200 rounded-lg cursor-pointer" oninput="updateDCFCalc()">
                    <div class="param-hint" id="dcfWACCHint">
                      <i class="fas fa-lightbulb param-hint-icon"></i>
                      <span id="dcfWACCSectorRef">Damodaran ì„¹í„° WACC ìë™ ì ìš©</span>
                    </div>
                    <div class="param-range">
                      <span>ìœ í‹¸ë¦¬í‹°: 5-7%</span>
                      <span>ì¼ë°˜: 8-10%</span>
                      <span>ê¸°ìˆ ì£¼: 10-14%</span>
                    </div>
                  </div>
                  <div>
                    <div class="flex justify-between text-xs mb-1">
                      <span class="text-gray-600">í„°ë¯¸ë„ ì„±ì¥ë¥ </span>
                      <span id="dcfTerminalValue" class="font-bold text-purple-600">2.5%</span>
                    </div>
                    <input type="range" id="dcfTerminalSlider" min="0" max="5" step="0.25" value="2.5"
                           class="w-full h-2 bg-purple-200 rounded-lg cursor-pointer" oninput="updateDCFCalc()">
                    <div class="param-hint" id="dcfTerminalHint">
                      <i class="fas fa-lightbulb param-hint-icon"></i>
                      ì¥ê¸° GDP ì„±ì¥ë¥  (2-3%) ê¸°ì¤€
                    </div>
                    <!-- v4.3: growth_consensus ê¸°ë°˜ Terminal ê¶Œì¥ê°’ -->
                    <div class="param-hint text-indigo-600" id="dcfTerminalSectorRef"></div>
                    <div class="param-range">
                      <span>ë³´ìˆ˜ì : 1-2%</span>
                      <span>ì¼ë°˜: 2-3%</span>
                      <span>ë‚™ê´€: 3-4%</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- ë°¸ë¥˜ì—ì´ì…˜ ê²°ê³¼ ì¹´ë“œ -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
              <div class="bg-emerald-50 rounded-lg p-4 text-center">
                <div class="text-xs text-gray-500">ì ì •ê°€ì¹˜</div>
                <div class="text-xl font-bold text-emerald-600 mono" id="dcfFairValue">-</div>
              </div>
              <div class="bg-blue-50 rounded-lg p-4 text-center">
                <div class="text-xs text-gray-500">í˜„ì¬ê°€ê²©</div>
                <div class="text-xl font-bold text-blue-600 mono" id="dcfCurrentPrice">-</div>
              </div>
              <div class="bg-purple-50 rounded-lg p-4 text-center">
                <div class="text-xs text-gray-500">ê´´ë¦¬ìœ¨</div>
                <div class="text-xl font-bold mono" id="dcfGap">-</div>
              </div>
              <div class="bg-gray-50 rounded-lg p-4 text-center">
                <div class="text-xs text-gray-500">íŒì •</div>
                <div class="text-xl font-bold" id="dcfVerdict">-</div>
              </div>
            </div>

            <!-- ë¯¼ê°ë„ ë¶„ì„ í…Œì´ë¸” -->
            <div class="bg-gradient-to-br from-slate-50 to-white p-4 rounded-lg border border-slate-100">
              <h3 class="text-sm font-bold text-slate-700 mb-3"><i class="fas fa-table mr-1"></i>ë¯¼ê°ë„ ë¶„ì„ (Growth Ã— WACC)</h3>
              <div style="overflow-x: auto;">
                <table id="dcfSensitivityTable" class="text-xs w-full">
                  <thead id="dcfSensitivityHead"></thead>
                  <tbody id="dcfSensitivityBody"></tbody>
                </table>
              </div>
            </div>

            <!-- #195: DCF Parameter Guide (Collapsible) -->
            <div class="mt-4">
              <button onclick="toggleDCFGuide()" class="param-guide-toggle bg-gradient-to-r from-indigo-50 to-purple-50 border-indigo-100 hover:border-indigo-200">
                <span class="text-sm font-medium text-indigo-700">
                  <i class="fas fa-book-open mr-2"></i>ğŸ“– DCF íŒŒë¼ë¯¸í„° ì„¤ì • ê°€ì´ë“œ (ì´ˆë³´ììš©)
                </span>
                <i id="dcfGuideIcon" class="fas fa-chevron-down text-indigo-500 transition-transform"></i>
              </button>

              <div id="dcfGuideContent" class="hidden mt-2 p-4 bg-white border border-indigo-100 rounded-lg param-guide-content">
                <div class="grid md:grid-cols-3 gap-4 text-sm">
                  <!-- Growth Rate Guide Card -->
                  <div class="bg-purple-50 p-3 rounded-lg">
                    <h4 class="font-bold text-purple-700 mb-2">
                      <i class="fas fa-chart-line mr-1"></i>ì„±ì¥ë¥  (g)
                    </h4>
                    <p class="text-gray-600 mb-2"><strong>ì •ì˜:</strong> í–¥í›„ FCF ì—°ê°„ ì„±ì¥ ì˜ˆì¸¡</p>
                    <ul class="text-gray-500 text-xs space-y-1 ml-3">
                      <li>â€¢ ê³¼ê±° FCF CAGR í™•ì¸</li>
                      <li>â€¢ ì‚°ì—… ì„±ì¥ë¥  ë²¤ì¹˜ë§ˆí¬</li>
                      <li>â€¢ ì„±ìˆ™ê¸°ì—…: 5-8%</li>
                      <li>â€¢ ì„±ì¥ê¸°ì—…: 10-20%</li>
                    </ul>
                  </div>

                  <!-- WACC Guide Card -->
                  <div class="bg-blue-50 p-3 rounded-lg">
                    <h4 class="font-bold text-blue-700 mb-2">
                      <i class="fas fa-percentage mr-1"></i>WACC (í• ì¸ìœ¨)
                    </h4>
                    <p class="text-gray-600 mb-2"><strong>ì •ì˜:</strong> íˆ¬ìì˜ ê¸°íšŒë¹„ìš©</p>
                    <ul class="text-gray-500 text-xs space-y-1 ml-3">
                      <li>â€¢ Damodaran ì„¹í„°ë³„ ìë™ ì—°ë™</li>
                      <li>â€¢ ë†’ì„ìˆ˜ë¡ â†’ ì ì •ê°€ì¹˜ â†“</li>
                      <li>â€¢ ê¸°ìˆ ì£¼: 10-14%</li>
                      <li>â€¢ ìœ í‹¸ë¦¬í‹°: 5-7%</li>
                    </ul>
                  </div>

                  <!-- Terminal Growth Guide Card -->
                  <div class="bg-emerald-50 p-3 rounded-lg">
                    <h4 class="font-bold text-emerald-700 mb-2">
                      <i class="fas fa-infinity mr-1"></i>í„°ë¯¸ë„ ì„±ì¥ë¥ 
                    </h4>
                    <p class="text-gray-600 mb-2"><strong>ì •ì˜:</strong> ì˜êµ¬ ì„±ì¥ë¥  (Gordon)</p>
                    <ul class="text-gray-500 text-xs space-y-1 ml-3">
                      <li>â€¢ ë¯¸êµ­ í‰ê· : 2-3%</li>
                      <li>â€¢ ì¸í”Œë ˆì´ì…˜ ìˆ˜ì¤€</li>
                      <li>â€¢ WACCë³´ë‹¤ ë‚®ì•„ì•¼ í•¨ (í•„ìˆ˜)</li>
                      <li>â€¢ ê²°ê³¼ì— ê°€ì¥ í° ì˜í–¥</li>
                    </ul>
                  </div>
                </div>

                <div class="mt-4 p-3 bg-amber-50 rounded-lg border border-amber-100">
                  <p class="text-xs text-amber-700">
                    <i class="fas fa-exclamation-triangle mr-1"></i>
                    <strong>ì£¼ì˜:</strong> DCFëŠ” ê°€ì •ì— ë¯¼ê°í•©ë‹ˆë‹¤. ë¯¼ê°ë„ ë¶„ì„ í…Œì´ë¸”ë¡œ ë²”ìœ„ë¥¼ í™•ì¸í•˜ì„¸ìš”.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== DDM CALCULATOR TAB (#193) ==================== -->
    <div id="section-ddm" class="content-section">
      <div class="card" style="border-top-left-radius: 0; border-top-right-radius: 0;">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-bold text-gray-800">
            <i class="fas fa-hand-holding-dollar text-amber-500 mr-2"></i>DDM Calculator (Gordon Growth Model)
          </h2>
          <div class="flex items-center gap-3">
            <label for="ddmSelector" class="text-sm text-gray-600">ì¢…ëª©:</label>
            <select id="ddmSelector" onchange="renderDDMTab()" class="p-2 border rounded-lg text-sm min-w-48">
              <option value="">-- ì¢…ëª© ì„ íƒ --</option>
            </select>
          </div>
        </div>

        <div id="ddmContent">
          <div id="ddmEmptyState" class="chart-empty-state" style="height: 300px; position: relative;">
            <div class="text-center text-gray-400">
              <i class="fas fa-coins text-5xl mb-3"></i>
              <p class="text-lg font-medium">ì¢…ëª©ì„ ì„ íƒí•˜ì„¸ìš”</p>
              <p class="text-sm mt-1">ë°°ë‹¹ ê¸°ë°˜ DDM ë°¸ë¥˜ì—ì´ì…˜ (ë°°ë‹¹ì£¼ ì „ìš©)</p>
            </div>
          </div>

          <div id="ddmResults" class="hidden">
            <!-- ë°°ë‹¹ ë°ì´í„° + íŒŒë¼ë¯¸í„° -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <!-- ë°°ë‹¹ ë°ì´í„° ì¹´ë“œ -->
              <div class="bg-gradient-to-br from-amber-50 to-white p-4 rounded-lg border border-amber-100">
                <h3 class="text-sm font-bold text-amber-700 mb-3"><i class="fas fa-coins mr-1"></i>DPS ë°ì´í„° (5ê°œë…„)</h3>
                <div id="ddmDPSData" class="grid grid-cols-5 gap-2 text-center"></div>
                <div class="mt-3 pt-3 border-t border-amber-100">
                  <div class="flex justify-between items-center">
                    <span class="text-xs text-gray-500">5Y DPS CAGR</span>
                    <span id="ddmDPSCAGR" class="font-bold text-amber-600 mono">-</span>
                  </div>
                </div>
              </div>

              <!-- íŒŒë¼ë¯¸í„° ìŠ¬ë¼ì´ë” -->
              <div class="bg-gradient-to-br from-blue-50 to-white p-4 rounded-lg border border-blue-100">
                <h3 class="text-sm font-bold text-blue-700 mb-3"><i class="fas fa-sliders-h mr-1"></i>DDM íŒŒë¼ë¯¸í„°</h3>
                <div class="space-y-3">
                  <div>
                    <div class="flex justify-between text-xs mb-1">
                      <span class="text-gray-600">ìš”êµ¬ìˆ˜ìµë¥  (r)</span>
                      <span id="ddmRequiredValue" class="font-bold text-blue-600">8.0%</span>
                    </div>
                    <input type="range" id="ddmRequiredSlider" min="4" max="20" step="0.5" value="8"
                           class="w-full h-2 bg-blue-200 rounded-lg cursor-pointer" oninput="updateDDMCalc()">
                    <div class="param-hint" id="ddmRequiredHint" style="border-color: #3b82f6; background: linear-gradient(to right, rgba(59, 130, 246, 0.05), transparent);">
                      <i class="fas fa-lightbulb param-hint-icon" style="color: #3b82f6;"></i>
                      <span id="ddmRequiredSectorRef">CAPM: ë¬´ìœ„í—˜ì´ììœ¨ + Î²Ã—MRP</span>
                    </div>
                    <div class="param-range">
                      <span>ì•ˆì •ì£¼: 6-8%</span>
                      <span>ì„±ì¥ì£¼: 10-12%</span>
                      <span>ê³ ìœ„í—˜: 15%+</span>
                    </div>
                  </div>
                  <div>
                    <div class="flex justify-between text-xs mb-1">
                      <span class="text-gray-600">ë°°ë‹¹ì„±ì¥ë¥  (g)</span>
                      <span id="ddmGrowthValue" class="font-bold text-blue-600">3.0%</span>
                    </div>
                    <input type="range" id="ddmGrowthSlider" min="0" max="15" step="0.5" value="3"
                           class="w-full h-2 bg-blue-200 rounded-lg cursor-pointer" oninput="updateDDMCalc()">
                    <div class="param-hint" id="ddmGrowthHint" style="border-color: #f59e0b; background: linear-gradient(to right, rgba(245, 158, 11, 0.05), transparent);">
                      <i class="fas fa-lightbulb param-hint-icon" style="color: #f59e0b;"></i>
                      <span id="ddmGrowthSectorRef">ê³¼ê±° DPS CAGR ì°¸ê³ </span>
                    </div>
                    <div class="param-range">
                      <span>ì•ˆì •ë°°ë‹¹: 2-4%</span>
                      <span>ì„±ì¥ë°°ë‹¹: 5-8%</span>
                      <span>ê³ ì„±ì¥: 10%+</span>
                    </div>
                  </div>
                  <div id="ddmWarning" class="hidden bg-red-100 text-red-700 text-xs p-2 rounded">
                    <i class="fas fa-exclamation-triangle mr-1"></i>ìš”êµ¬ìˆ˜ìµë¥ (r)ì´ ë°°ë‹¹ì„±ì¥ë¥ (g)ë³´ë‹¤ ë†’ì•„ì•¼ í•©ë‹ˆë‹¤
                  </div>
                </div>
              </div>
            </div>

            <!-- #196: DDM Yield Warning -->
            <div id="ddmYieldWarning" class="hidden"></div>

            <!-- ë°¸ë¥˜ì—ì´ì…˜ ê²°ê³¼ ì¹´ë“œ -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
              <div class="bg-amber-50 rounded-lg p-4 text-center">
                <div class="text-xs text-gray-500">ì ì •ê°€ì¹˜</div>
                <div class="text-xl font-bold text-amber-600 mono" id="ddmFairValue">-</div>
              </div>
              <div class="bg-blue-50 rounded-lg p-4 text-center">
                <div class="text-xs text-gray-500">í˜„ì¬ê°€ê²©</div>
                <div class="text-xl font-bold text-blue-600 mono" id="ddmCurrentPrice">-</div>
              </div>
              <div class="bg-purple-50 rounded-lg p-4 text-center">
                <div class="text-xs text-gray-500">ê´´ë¦¬ìœ¨</div>
                <div class="text-xl font-bold mono" id="ddmGap">-</div>
              </div>
              <div class="bg-gray-50 rounded-lg p-4 text-center">
                <div class="text-xs text-gray-500">íŒì •</div>
                <div class="text-xl font-bold" id="ddmVerdict">-</div>
              </div>
            </div>

            <!-- ë¬´ë°°ë‹¹ ê²½ê³  -->
            <div id="ddmNoDividend" class="hidden bg-amber-100 p-4 rounded-lg text-center">
              <i class="fas fa-info-circle text-amber-600 text-2xl mb-2"></i>
              <p class="text-amber-700 font-medium">N/A - í•´ë‹¹ ì¢…ëª©ì€ ë°°ë‹¹ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤</p>
              <p class="text-amber-600 text-sm mt-1">DDMì€ ë°°ë‹¹ì£¼ ì „ìš© ë°¸ë¥˜ì—ì´ì…˜ ëª¨ë¸ì…ë‹ˆë‹¤</p>
            </div>

            <!-- #195: DDM Parameter Guide (Collapsible) -->
            <div class="mt-4">
              <button onclick="toggleDDMGuide()" class="param-guide-toggle bg-gradient-to-r from-amber-50 to-yellow-50 border-amber-100 hover:border-amber-200">
                <span class="text-sm font-medium text-amber-700">
                  <i class="fas fa-book-open mr-2"></i>ğŸ“– DDM íŒŒë¼ë¯¸í„° ì„¤ì • ê°€ì´ë“œ (ì´ˆë³´ììš©)
                </span>
                <i id="ddmGuideIcon" class="fas fa-chevron-down text-amber-500 transition-transform"></i>
              </button>

              <div id="ddmGuideContent" class="hidden mt-2 p-4 bg-white border border-amber-100 rounded-lg param-guide-content">
                <div class="grid md:grid-cols-2 gap-4 text-sm">
                  <!-- Required Return Guide -->
                  <div class="bg-blue-50 p-3 rounded-lg">
                    <h4 class="font-bold text-blue-700 mb-2">
                      <i class="fas fa-bullseye mr-1"></i>ìš”êµ¬ìˆ˜ìµë¥  (r)
                    </h4>
                    <p class="text-gray-600 mb-2"><strong>ì •ì˜:</strong> íˆ¬ìì ê¸°ëŒ€ ìµœì†Œ ìˆ˜ìµë¥ </p>
                    <ul class="text-gray-500 text-xs space-y-1 ml-3">
                      <li>â€¢ CAPM: Rf + Î² Ã— MRP</li>
                      <li>â€¢ Rf(ë¬´ìœ„í—˜): êµ­ì±„ê¸ˆë¦¬ ~4-5%</li>
                      <li>â€¢ MRP(ì‹œì¥í”„ë¦¬ë¯¸ì—„): ~5-6%</li>
                      <li>â€¢ ì•ˆì •ë°°ë‹¹ì£¼: 6-8%</li>
                      <li>â€¢ ì„±ì¥ë°°ë‹¹ì£¼: 10-12%</li>
                    </ul>
                  </div>

                  <!-- Dividend Growth Guide -->
                  <div class="bg-amber-50 p-3 rounded-lg">
                    <h4 class="font-bold text-amber-700 mb-2">
                      <i class="fas fa-seedling mr-1"></i>ë°°ë‹¹ì„±ì¥ë¥  (g)
                    </h4>
                    <p class="text-gray-600 mb-2"><strong>ì •ì˜:</strong> ë°°ë‹¹ê¸ˆ ì—°ê°„ ì¦ê°€ìœ¨</p>
                    <ul class="text-gray-500 text-xs space-y-1 ml-3">
                      <li>â€¢ ê³¼ê±° DPS CAGR ì°¸ê³ </li>
                      <li>â€¢ g = ROE Ã— (1 - ë°°ë‹¹ì„±í–¥)</li>
                      <li>â€¢ ì„±ìˆ™ê¸°ì—…: 2-4%</li>
                      <li>â€¢ ì„±ì¥ê¸°ì—…: 5-10%</li>
                      <li>â€¢ <strong>í•„ìˆ˜:</strong> g &lt; r</li>
                    </ul>
                  </div>
                </div>

                <div class="mt-4 p-3 bg-red-50 rounded-lg border border-red-100">
                  <p class="text-xs text-red-700">
                    <i class="fas fa-exclamation-circle mr-1"></i>
                    <strong>Gordon Growth Model ì œì•½:</strong> r &gt; g í•„ìˆ˜. g â‰¥ rì´ë©´ ë¬´í•œëŒ€ë¡œ ë°œì‚°í•©ë‹ˆë‹¤.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== PEER COMPARISON TAB (#191) ==================== -->
    <div id="section-peer" class="content-section">
      <div class="card" style="border-top-left-radius: 0; border-top-right-radius: 0;">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-bold text-gray-800">
            <i class="fas fa-users text-teal-500 mr-2"></i>Peer Comparison
          </h2>
          <div class="flex items-center gap-3">
            <label for="peerSelector" class="text-sm text-gray-600">ì¢…ëª©:</label>
            <select id="peerSelector" onchange="renderPeerTab()" class="p-2 border rounded-lg text-sm min-w-48">
              <option value="">-- ì¢…ëª© ì„ íƒ --</option>
            </select>
          </div>
        </div>

        <!-- #196: Simplified Peer Selection (Cì•ˆ) -->
        <div id="peerSelectionPanel" class="mb-4">
          <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
            <!-- Selected Chips (Base + Manual) -->
            <div id="selectedPeerChips" class="flex flex-wrap gap-2 mb-3"></div>

            <!-- v4.3.1: Inline Search (direct typing) -->
            <div class="flex items-center gap-3 flex-wrap">
              <label class="text-sm font-medium text-gray-700">
                <i class="fas fa-plus-circle text-teal-500 mr-1"></i>ì¢…ëª© ì¶”ê°€
              </label>
              <div class="relative flex-1 min-w-48">
                <input type="text" id="peerSearchInput"
                       placeholder="ì¢…ëª© ê²€ìƒ‰ (í‹°ì»¤ ë˜ëŠ” ì´ë¦„)..."
                       autocomplete="off"
                       class="w-full p-2 border rounded-lg text-sm focus:ring-2 focus:ring-teal-500 focus:border-teal-500">
                <div id="peerSearchResults" class="absolute z-50 w-full mt-1 bg-white border rounded-lg shadow-lg max-h-60 overflow-y-auto hidden"></div>
              </div>
            </div>

            <!-- Quick Add Suggestions -->
            <div id="peerQuickAdd" class="peer-quick-add hidden">
              <span class="text-xs text-gray-500 mr-2"><i class="fas fa-lightbulb text-amber-400 mr-1"></i>ì¶”ì²œ:</span>
              <!-- Dynamically populated -->
            </div>

            <p class="text-xs text-gray-500 mt-3">
              <i class="fas fa-info-circle mr-1"></i>
              ê¸°ì¤€ ì¢…ëª© + ë¹„êµ ì¢…ëª© ìµœëŒ€ 5ê°œ â€¢ Overlay ì°¨íŠ¸ì—ì„œ ìˆ˜ìµë¥  ë¹„êµ
            </p>
          </div>
        </div>

        <div id="peerContent">
          <div id="peerEmptyState" class="chart-empty-state" style="height: 300px; position: relative;">
            <div class="text-center text-gray-400">
              <i class="fas fa-chart-bar text-5xl mb-3"></i>
              <p class="text-lg font-medium">ì¢…ëª©ì„ ì„ íƒí•˜ì„¸ìš”</p>
              <p class="text-sm mt-1">ë™ì¼ ì„¹í„° ë‚´ Peer ë¹„êµ ë¶„ì„</p>
            </div>
          </div>

          <div id="peerResults" class="hidden">
            <!-- ì„¹í„° ì •ë³´ -->
            <div class="bg-teal-50 p-3 rounded-lg mb-4 flex items-center justify-between">
              <div>
                <span class="text-sm text-teal-700"><i class="fas fa-layer-group mr-1"></i>ì„¹í„°: </span>
                <span id="peerSectorName" class="font-bold text-teal-800">-</span>
                <span id="peerDamodaranName" class="text-xs text-teal-600 ml-2">(-)</span>
              </div>
              <div>
                <span class="text-sm text-teal-700">ë™ì¼ ì„¹í„° </span>
                <span id="peerCount" class="font-bold text-teal-800">0</span>
                <span class="text-sm text-teal-700">ê°œ ì¢…ëª©</span>
              </div>
            </div>

            <!-- Percentile Bars -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
              <div class="bg-white border rounded-lg p-3">
                <div class="text-xs text-gray-500 mb-2">P/E Percentile</div>
                <div class="bg-gray-200 rounded-full h-4 relative overflow-hidden">
                  <div id="peerPEBar" class="bg-emerald-500 h-4 rounded-full transition-all" style="width: 0%"></div>
                  <div id="peerPEMarker" class="absolute top-0 h-4 w-1 bg-gray-800 transition-all" style="left: 0%"></div>
                </div>
                <div class="text-right text-xs mt-1"><span id="peerPEPct" class="font-bold">-</span>% (ìƒìœ„ <span id="peerPETop">-</span>%)</div>
              </div>
              <div class="bg-white border rounded-lg p-3">
                <div class="text-xs text-gray-500 mb-2">P/B Percentile</div>
                <div class="bg-gray-200 rounded-full h-4 relative overflow-hidden">
                  <div id="peerPBBar" class="bg-purple-500 h-4 rounded-full transition-all" style="width: 0%"></div>
                  <div id="peerPBMarker" class="absolute top-0 h-4 w-1 bg-gray-800 transition-all" style="left: 0%"></div>
                </div>
                <div class="text-right text-xs mt-1"><span id="peerPBPct" class="font-bold">-</span>% (ìƒìœ„ <span id="peerPBTop">-</span>%)</div>
              </div>
              <div class="bg-white border rounded-lg p-3">
                <div class="text-xs text-gray-500 mb-2">ROE Percentile</div>
                <div class="bg-gray-200 rounded-full h-4 relative overflow-hidden">
                  <div id="peerROEBar" class="bg-blue-500 h-4 rounded-full transition-all" style="width: 0%"></div>
                  <div id="peerROEMarker" class="absolute top-0 h-4 w-1 bg-gray-800 transition-all" style="left: 0%"></div>
                </div>
                <div class="text-right text-xs mt-1"><span id="peerROEPct" class="font-bold">-</span>% (ìƒìœ„ <span id="peerROETop">-</span>%)</div>
              </div>
              <div class="bg-white border rounded-lg p-3">
                <div class="text-xs text-gray-500 mb-2">ì‹œì´ Percentile</div>
                <div class="bg-gray-200 rounded-full h-4 relative overflow-hidden">
                  <div id="peerMCBar" class="bg-amber-500 h-4 rounded-full transition-all" style="width: 0%"></div>
                  <div id="peerMCMarker" class="absolute top-0 h-4 w-1 bg-gray-800 transition-all" style="left: 0%"></div>
                </div>
                <div class="text-right text-xs mt-1"><span id="peerMCPct" class="font-bold">-</span>% (ìƒìœ„ <span id="peerMCTop">-</span>%)</div>
              </div>
            </div>

            <!-- ì°¨íŠ¸ íƒ­ & ë©”íŠ¸ë¦­ ì„ íƒ -->
            <div class="flex flex-wrap gap-2 mb-3">
              <div class="flex gap-1">
                <button class="tab-btn active" data-chart="bar" onclick="setPeerChartType('bar')">Bar</button>
                <button class="tab-btn" data-chart="box" onclick="setPeerChartType('box')">Box</button>
              </div>
              <div class="flex gap-1 ml-4">
                <button class="tab-btn active" data-metric="pe" onclick="setPeerMetric('pe')">P/E</button>
                <button class="tab-btn" data-metric="pb" onclick="setPeerMetric('pb')">P/B</button>
                <button class="tab-btn" data-metric="roe" onclick="setPeerMetric('roe')">ROE</button>
                <button class="tab-btn" data-metric="mc" onclick="setPeerMetric('mc')">ì‹œì´</button>
              </div>
            </div>

            <!-- ì°¨íŠ¸ -->
            <div class="chart-container" style="height: 350px;">
              <canvas id="peerChart"></canvas>
            </div>

            <!-- Peer Table -->
            <div class="mt-4">
              <h3 class="text-sm font-bold text-gray-700 mb-3"><i class="fas fa-table mr-1"></i>Top 15 Peers (ì‹œì´ ê¸°ì¤€)</h3>
              <div style="overflow-x: auto;">
                <table class="text-sm w-full">
                  <thead>
                    <tr>
                      <th>í‹°ì»¤</th>
                      <th>ì¢…ëª©ëª…</th>
                      <th>P/E</th>
                      <th>P/B</th>
                      <th>ë°°ë‹¹ë¥ </th>
                      <th>12Mìˆ˜ìµë¥ </th>
                      <th>ì‹œì´</th>
                    </tr>
                  </thead>
                  <tbody id="peerTableBody"></tbody>
                </table>
              </div>
            </div>

            <!-- v4: Overlay Comparison Chart -->
            <div id="overlaySection" class="bg-white p-4 rounded-lg border mt-4">
              <div class="flex items-center justify-between mb-4 flex-wrap gap-3">
                <h3 class="text-sm font-bold text-gray-700">
                  <i class="fas fa-layer-group text-indigo-500 mr-1"></i>ìˆ˜ìµë¥  ë¹„êµ (Overlay)
                </h3>

                <!-- Period Buttons -->
                <div class="flex gap-1">
                  <button onclick="setComparisonPeriod('1m')" data-period="1m" class="overlay-period-btn">1M</button>
                  <button onclick="setComparisonPeriod('3m')" data-period="3m" class="overlay-period-btn">3M</button>
                  <button onclick="setComparisonPeriod('6m')" data-period="6m" class="overlay-period-btn active">6M</button>
                  <button onclick="setComparisonPeriod('1y')" data-period="1y" class="overlay-period-btn">1Y</button>
                  <button onclick="setComparisonPeriod('ytd')" data-period="ytd" class="overlay-period-btn">YTD</button>
                </div>
              </div>

              <div id="overlayChartContainer" class="chart-container" style="height: 300px; position: relative;">
                <canvas id="overlayChart"></canvas>
                <div id="overlayEmptyState" class="chart-empty-state">
                  <div class="text-center text-gray-400">
                    <i class="fas fa-chart-line text-4xl mb-2"></i>
                    <p class="text-sm">2ê°œ ì´ìƒì˜ ì¢…ëª©ì„ ì„ íƒí•˜ì„¸ìš”</p>
                  </div>
                </div>
              </div>

              <p class="text-xs text-gray-500 mt-3">
                <i class="fas fa-info-circle mr-1"></i>
                ì‹œì‘ì  ê¸°ì¤€ ìƒëŒ€ ìˆ˜ìµë¥  (%) â€¢ ì„ íƒ ê¸°ê°„ì˜ ê°€ê²© ë³€ë™ ë¹„êµ â€¢ ìë™: ì„¹í„° Top 5 / ìˆ˜ë™: ì„ íƒ ì¢…ëª©
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== ETFs/MACRO TAB ==================== -->
    <div id="section-etfs" class="content-section">
      <!-- ETF Section -->
      <div class="card" style="border-top-left-radius: 0; border-top-right-radius: 0;">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-bold text-gray-800">
            <i class="fas fa-layer-group text-indigo-500 mr-2"></i>ETF ëª©ë¡ (23ê°œ)
          </h2>
        </div>

        <!-- v3: ETF í…Œì´ë¸” 17ê°œ ì»¬ëŸ¼ í™•ì¥ + v4.3.1: ì •ë ¬ ê¸°ëŠ¥ -->
        <div style="overflow-x: auto;">
          <table id="etfTable">
            <thead>
              <tr>
                <th class="cursor-pointer hover:bg-gray-100 select-none" onclick="sortETFs('ticker')">í‹°ì»¤ <span id="etfSort-ticker"></span></th>
                <th>ì´ë¦„</th>
                <th class="cursor-pointer hover:bg-gray-100 select-none" onclick="sortETFs('category')">ì¹´í…Œê³ ë¦¬ <span id="etfSort-category"></span></th>
                <th class="cursor-pointer hover:bg-gray-100 select-none" onclick="sortETFs('market_cap')">ì‹œì´ <span id="etfSort-market_cap"></span></th>
                <th class="cursor-pointer hover:bg-gray-100 select-none" onclick="sortETFs('r1m')">1M <span id="etfSort-r1m"></span></th>
                <th class="cursor-pointer hover:bg-gray-100 select-none" onclick="sortETFs('r3m')">3M <span id="etfSort-r3m"></span></th>
                <th class="cursor-pointer hover:bg-gray-100 select-none" onclick="sortETFs('r6m')">6M <span id="etfSort-r6m"></span></th>
                <th class="cursor-pointer hover:bg-gray-100 select-none" onclick="sortETFs('ytd')">YTD <span id="etfSort-ytd"></span></th>
                <th class="cursor-pointer hover:bg-gray-100 select-none" onclick="sortETFs('r1y')">1Y <span id="etfSort-r1y"></span></th>
                <th class="cursor-pointer hover:bg-gray-100 select-none" onclick="sortETFs('r3y')">3Y <span id="etfSort-r3y"></span></th>
                <th class="cursor-pointer hover:bg-gray-100 select-none" onclick="sortETFs('r5y')">5Y <span id="etfSort-r5y"></span></th>
                <th class="cursor-pointer hover:bg-gray-100 select-none" onclick="sortETFs('r10y')">10Y <span id="etfSort-r10y"></span></th>
                <th class="cursor-pointer hover:bg-gray-100 select-none" onclick="sortETFs('cagr3y')">3Y CAGR <span id="etfSort-cagr3y"></span></th>
                <th class="cursor-pointer hover:bg-gray-100 select-none" onclick="sortETFs('cagr5y')">5Y CAGR <span id="etfSort-cagr5y"></span></th>
                <th class="cursor-pointer hover:bg-gray-100 select-none" onclick="sortETFs('cagr10y')">10Y CAGR <span id="etfSort-cagr10y"></span></th>
                <th class="cursor-pointer hover:bg-gray-100 select-none" onclick="sortETFs('beta')">Beta <span id="etfSort-beta"></span></th>
                <th class="cursor-pointer hover:bg-gray-100 select-none" onclick="sortETFs('expense_ratio')">ë¹„ìš© <span id="etfSort-expense_ratio"></span></th>
              </tr>
            </thead>
            <tbody id="etfTableBody"></tbody>
          </table>
        </div>
      </div>

    </div>

    <!-- ==================== MACRO TAB (#197) ==================== -->
    <div id="section-macro" class="content-section">
      <div class="card" style="border-top-left-radius: 0; border-top-right-radius: 0;">
        <!-- #196: Macro Alert Banner -->
        <div id="macroAlertBanner" class="macro-alert-banner hidden"></div>

        <div class="flex items-center justify-between mb-4 flex-wrap gap-3">
          <h2 class="text-lg font-bold text-gray-800">
            <i class="fas fa-globe text-teal-500 mr-2"></i>ë§¤í¬ë¡œ ì§€í‘œ ì‹œê³„ì—´ (1,045 records)
          </h2>
          <div class="flex items-center gap-2 flex-wrap">
            <select id="macroIndicatorSelect" onchange="renderMacroChart()" class="p-2 border rounded-lg text-sm">
              <option value="">ì£¼ ì§€í‘œ...</option>
            </select>
            <span class="text-gray-400 text-sm font-medium">vs</span>
            <select id="macroIndicator2Select" onchange="renderMacroChart()" class="p-2 border rounded-lg text-sm">
              <option value="">ë¹„êµ ì§€í‘œ (ì„ íƒ)</option>
            </select>
          </div>
        </div>

        <!-- Macro Time Series Chart -->
        <div id="macroChartContainer" class="chart-container mb-4">
          <canvas id="macroChart"></canvas>
          <div id="macroEmptyState" class="chart-empty-state">
            <div class="text-center text-gray-400">
              <i class="fas fa-chart-area text-5xl mb-3"></i>
              <p class="text-lg font-medium">ì§€í‘œë¥¼ ì„ íƒí•˜ì„¸ìš”</p>
              <p class="text-sm mt-1">4ë…„ íˆìŠ¤í† ë¦¬ ì‹œê³„ì—´ í™•ì¸</p>
            </div>
          </div>
        </div>

        <!-- Macro Summary Cards - Primary -->
        <div id="macroSummary" class="mb-4 hidden">
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-2">
            <div class="bg-teal-50 rounded-lg p-3 text-center">
              <div class="text-xs text-gray-500">ìµœì‹ ê°’ <span id="macroLabel1" class="text-teal-600"></span></div>
              <div class="text-lg font-bold text-teal-600 mono" id="macroLatest">-</div>
            </div>
            <div class="bg-blue-50 rounded-lg p-3 text-center">
              <div class="text-xs text-gray-500">í‰ê· </div>
              <div class="text-lg font-bold text-blue-600 mono" id="macroAvg">-</div>
            </div>
            <div class="bg-gray-50 rounded-lg p-3 text-center">
              <div class="text-xs text-gray-500">ìµœì €</div>
              <div class="text-lg font-bold text-gray-600 mono" id="macroMin">-</div>
            </div>
            <div class="bg-amber-50 rounded-lg p-3 text-center">
              <div class="text-xs text-gray-500">ìµœê³ </div>
              <div class="text-lg font-bold text-amber-600 mono" id="macroMax">-</div>
            </div>
          </div>
          <!-- Secondary Indicator Stats (shown when comparing) -->
          <div id="macroSummary2" class="grid grid-cols-2 md:grid-cols-4 gap-4 hidden">
            <div class="bg-purple-50 rounded-lg p-3 text-center">
              <div class="text-xs text-gray-500">ìµœì‹ ê°’ <span id="macroLabel2" class="text-purple-600"></span></div>
              <div class="text-lg font-bold text-purple-600 mono" id="macroLatest2">-</div>
            </div>
            <div class="bg-purple-50/50 rounded-lg p-3 text-center">
              <div class="text-xs text-gray-500">í‰ê· </div>
              <div class="text-lg font-bold text-purple-600 mono" id="macroAvg2">-</div>
            </div>
            <div class="bg-purple-50/30 rounded-lg p-3 text-center">
              <div class="text-xs text-gray-500">ìµœì €</div>
              <div class="text-lg font-bold text-purple-500 mono" id="macroMin2">-</div>
            </div>
            <div class="bg-purple-50 rounded-lg p-3 text-center">
              <div class="text-xs text-gray-500">ìµœê³ </div>
              <div class="text-lg font-bold text-purple-700 mono" id="macroMax2">-</div>
            </div>
          </div>
        </div>

        <details class="mt-4">
          <summary class="text-sm text-gray-500 cursor-pointer hover:text-gray-700">
            <i class="fas fa-table mr-1"></i>í…Œì´ë¸” ë³´ê¸° (ìµœì‹  100ê°œ)
          </summary>
          <div style="overflow-x: auto; max-height: 300px;" class="mt-2">
            <table id="macroTable">
              <thead>
                <tr>
                  <th>ì§€í‘œëª…</th>
                  <th>ê°’</th>
                  <th>ë‹¨ìœ„</th>
                  <th>ë‚ ì§œ</th>
                </tr>
              </thead>
              <tbody id="macroTableBody"></tbody>
            </table>
          </div>
        </details>
      </div>
    </div>
  </div>

  <script>
    // ================== DATA & STATE ==================
    const buildBase = () => {
      const host = location.hostname;
      const isLocal = location.protocol === 'file:' || host === 'localhost' || host === '127.0.0.1' || host.startsWith('192.168.') || host.startsWith('10.');
      const isCloudflare = host.endsWith('pages.dev');
      return (isLocal || isCloudflare) ? '' : '/100xFenok';
    };

    const BASE = buildBase();
    const DATA_URLS = {
      stocksIndex: `${BASE}/data/global-scouter/core/stocks_index.json`,
      metadata: `${BASE}/data/global-scouter/core/metadata.json`,
      dashboard: `${BASE}/data/global-scouter/core/dashboard.json`,
      etfs: `${BASE}/data/global-scouter/etfs/index.json`,
      economic: `${BASE}/data/global-scouter/indicators/economic.json`,
      stockDetail: (ticker) => `${BASE}/data/global-scouter/stocks/detail/${ticker}.json`,
      damodaran: `${BASE}/data/damodaran/industries.json`
    };

    let state = {
      stocks: {},
      stocksList: [],
      dashboard: null,
      etfs: [],
      economic: [],
      economicRecords: [], // Full time series records
      economicIndicators: [], // Available indicator names
      damodaranIndustries: {}, // Damodaran industry data
      detailCache: {},
      currentTab: 'overview',
      filter: 'all',
      sort: { key: 'mc', asc: false },
      search: '',
      page: 1,
      pageSize: 50,
      financialMetric: 'revenue',
      valuationMetric: 'per',
      growthMetric: 'revenue_growth',
      dividendMetric: 'dps',
      macroIndicator: '',
      dcfParams: { growthRate: 0.10, wacc: 0.10, terminalGrowth: 0.025 },
      ddmParams: { requiredReturn: 0.08, dividendGrowth: 0.03 },
      peerMetric: 'pe',
      peerChartType: 'bar',
      // v4: UX Overhaul
      selectedTicker: null,
      peerMode: 'manual',  // #196: Default to manual (Cì•ˆ)
      manualPeers: [],
      comparisonPeriod: '6m',
      // #196: Macro Alert
      vixData: null,
      // v4.3.1: ETF sorting
      etfSortKey: 'market_cap',
      etfSortDir: 'desc'
    };

    let charts = {
      financials: null,
      valuations: null,
      growth: null,
      dividend: null,
      macro: null,
      peer: null,
      overlay: null  // v4: Overlay comparison chart
    };

    // ================== SECTOR MAPPING (Korean â†’ Damodaran Industry) ==================
    const SECTOR_MAPPING = {
      'ë°˜ë„ì²´': 'Semiconductor',
      'ì†Œí”„íŠ¸ì›¨ì–´': 'Software (System & Application)',
      'ITí•˜ë“œì›¨ì–´': 'Computers/Peripherals',
      'ITê°€ì „': 'Electronics (Consumer & Office)',
      'ìë™ì°¨': 'Auto & Truck',
      'ì€í–‰': 'Banks (Regional)',
      'ê±´ê°•ê´€ë¦¬': 'Healthcare Products',
      'í•„ìˆ˜ì†Œë¹„ì¬': 'Household Products',
      'ì†Œë§¤(ìœ í†µ)': 'Retail (General)',
      'ì—ë„ˆì§€': 'Oil/Gas (Integrated)',
      'í†µì‹ ì„œë¹„ìŠ¤': 'Telecom. Services',
      'ìœ í‹¸ë¦¬í‹°': 'Utility (General)',
      'í™”í•™': 'Chemical (Specialty)',
      'ì² ê°•': 'Steel',
      'ê¸°ê³„': 'Machinery',
      'ê±´ì„¤,ê±´ì¶•ê´€ë ¨': 'Engineering/Construction',
      'ìš´ì†¡': 'Transportation',
      'ì¡°ì„ ': 'Shipbuilding & Marine',
      'ë¯¸ë””ì–´,êµìœ¡': 'Entertainment',
      'ë³´í—˜': 'Insurance (General)',
      'ì¦ê¶Œ': 'Brokerage & Investment Banking',
      'í˜¸í…”,ë ˆì €ì„œë¹„ìŠ¤': 'Hotel/Gaming',
      'í™”ì¥í’ˆ,ì˜ë¥˜,ì™„êµ¬': 'Apparel',
      'ìƒì‚¬,ìë³¸ì¬': 'Diversified',
      'ë¹„ì² ,ëª©ì¬ë“±': 'Metals & Mining',
      'ë””ìŠ¤í”Œë ˆì´': 'Electronics (General)',
      'ì œì•½': 'Drugs (Pharmaceutical)',
      'ë°”ì´ì˜¤': 'Drugs (Biotechnology)',
      'ìŒì‹ë£Œ': 'Food Processing',
      'ë‹´ë°°': 'Tobacco',
      'í•­ê³µì‚¬': 'Air Transport',
      'í•´ìš´': 'Shipbuilding & Marine',
      'ì „ë ¥': 'Power',
      'ê°€ìŠ¤': 'Oil/Gas Distribution',
      'ë¦¬ì¸ ': 'R.E.I.T.',
      'í†µì‹ ì¥ë¹„': 'Telecom. Equipment'
    };

    // ================== INITIALIZATION ==================
    async function init() {
      try {
        // Load stocks index
        const stocksRes = await fetch(DATA_URLS.stocksIndex);
        const stocksData = await stocksRes.json();
        state.stocks = stocksData.stocks || {};

        // Convert to array for easier manipulation
        state.stocksList = Object.entries(state.stocks).map(([ticker, data]) => ({
          ticker,
          name: data.n || ticker,
          exchange: data.x || '-',
          sector: data.s || '-',
          country: data.c || '-',
          price: data.p || 0,
          mc: data.mc || 0,
          pe: data.pe || 0,
          pb: data.pb || 0,
          dy: data.dy || 0,
          r12: data.r12 || 0
        }));

        // Try loading dashboard summary
        try {
          const dashRes = await fetch(DATA_URLS.dashboard);
          state.dashboard = await dashRes.json();
        } catch (e) {
          console.warn('Dashboard data not available:', e);
          state.dashboard = null;
        }

        // Try loading ETFs and economic (may not exist)
        try {
          const etfsRes = await fetch(DATA_URLS.etfs);
          const etfsData = await etfsRes.json();
          // Convert ETFs object to array
          if (etfsData.etfs && typeof etfsData.etfs === 'object' && !Array.isArray(etfsData.etfs)) {
            state.etfs = Object.entries(etfsData.etfs).map(([name, data]) => ({
              name,
              ticker: data.ticker || name,
              ...data
            }));
          } else {
            state.etfs = etfsData.etfs || [];
          }
        } catch (e) {
          console.warn('ETFs data not available:', e);
          state.etfs = [];
        }

        try {
          const econRes = await fetch(DATA_URLS.economic);
          const econData = await econRes.json();
          // Economic data structure: { records: [...] }
          if (econData.records && Array.isArray(econData.records)) {
            state.economicRecords = econData.records;
            // Extract indicator names from first record
            const firstRecord = econData.records[0] || {};
            state.economicIndicators = Object.keys(firstRecord).filter(k => k !== 'date');
            // Flatten latest records into indicator list for table
            state.economic = state.economicIndicators.map(key => ({
              indicator: key.toUpperCase().replace(/_/g, ' '),
              name: key.toUpperCase().replace(/_/g, ' '),
              value: firstRecord[key],
              unit: 'ratio',
              date: firstRecord.date
            }));
          } else {
            state.economic = econData.indicators || econData || [];
            state.economicRecords = [];
            state.economicIndicators = [];
          }
        } catch (e) {
          console.warn('Economic data not available:', e);
          state.economic = [];
          state.economicRecords = [];
          state.economicIndicators = [];
        }

        // Load Damodaran industry data
        try {
          const damoRes = await fetch(DATA_URLS.damodaran);
          const damoData = await damoRes.json();
          state.damodaranIndustries = damoData.industries || {};
          console.log(`Loaded ${Object.keys(state.damodaranIndustries).length} Damodaran industries`);
        } catch (e) {
          console.warn('Damodaran data not available:', e);
          state.damodaranIndustries = {};
        }

        // Update counts
        updateFilterCounts();

        // Render
        renderTable();
        renderTopBottom();
        renderSectorSummary();
        populateSelectors();
        populateMacroSelector();
        renderETFTable();
        renderMacroTable();

        // v4: Initialize global selector and manual peer selector
        initGlobalSelector();
        initManualPeerSelector();

        // #196: Load VIX data and update Macro Alerts
        await loadVIXData();
        updateMacroAlerts();

        // Hide loading
        document.getElementById('loadingOverlay').style.display = 'none';
      } catch (err) {
        console.error('Failed to load data:', err);
        document.getElementById('loadingOverlay').innerHTML = `
          <div class="text-red-500 text-center">
            <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
            <p class="text-lg font-bold">ë°ì´í„° ë¡œë”© ì‹¤íŒ¨</p>
            <p class="text-sm mt-2">${err.message}</p>
          </div>
        `;
      }
    }

    // ================== FILTER COUNTS ==================
    function updateFilterCounts() {
      const countryCounts = { all: state.stocksList.length };
      const countryMap = { US: 'us', KR: 'kr', CN: 'cn', JP: 'jp', HK: 'hk' };

      state.stocksList.forEach(stock => {
        const c = stock.country;
        const key = countryMap[c] || 'eu';
        countryCounts[key] = (countryCounts[key] || 0) + 1;
      });

      document.getElementById('count-all').textContent = countryCounts.all || 0;
      document.getElementById('count-us').textContent = countryCounts.us || 0;
      document.getElementById('count-kr').textContent = countryCounts.kr || 0;
      document.getElementById('count-cn').textContent = countryCounts.cn || 0;
      document.getElementById('count-jp').textContent = countryCounts.jp || 0;
      document.getElementById('count-hk').textContent = countryCounts.hk || 0;
      document.getElementById('count-eu').textContent = countryCounts.eu || 0;
    }

    // ================== #197: INDICATOR GUIDE TOGGLE ==================
    function toggleIndicatorGuide(guideId) {
      const toggle = document.getElementById(`${guideId}GuideToggle`);
      const content = document.getElementById(`${guideId}GuideContent`);
      if (!toggle || !content) return;

      const isOpen = content.classList.contains('open');
      if (isOpen) {
        content.classList.remove('open');
        toggle.classList.remove('open');
      } else {
        content.classList.add('open');
        toggle.classList.add('open');
      }
    }

    // ================== TAB NAVIGATION ==================
    function setContentTab(tabName) {
      state.currentTab = tabName;
      document.querySelectorAll('.content-tab').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tabName);
      });
      document.querySelectorAll('.content-section').forEach(section => {
        section.classList.toggle('active', section.id === `section-${tabName}`);
      });

      // v4: Auto-render if stock is selected (Tab Sync)
      if (state.selectedTicker) {
        renderCurrentTabContent();
      }
    }

    // v4: Render content for current tab based on selected stock
    function renderCurrentTabContent() {
      const ticker = state.selectedTicker;
      if (!ticker) return;

      switch (state.currentTab) {
        case 'financials':
          renderFinancialsChart();
          break;
        case 'valuations':
          renderValuationsChart();
          break;
        case 'growth':
          renderGrowthChart();
          break;
        case 'dividends':
          renderDividendChart();
          break;
        case 'dcf':
          renderDCFTab();
          break;
        case 'ddm':
          renderDDMTab();
          break;
        case 'peer':
          renderPeerTab();
          break;
        // 'overview', 'etfs', and 'macro' tabs don't need stock selection
      }
    }

    // #197: setContentTab already triggers Macro Alerts via init()
    // Macro tab uses updateMacroAlerts() called during init

    // ================== FILTER ==================
    function setFilter(filter) {
      state.filter = filter;
      state.page = 1;
      document.querySelectorAll('[id^="tab-"]').forEach(btn => {
        const btnFilter = btn.id.replace('tab-', '').toUpperCase();
        btn.classList.toggle('active', btnFilter === filter.toUpperCase() || (filter === 'all' && btn.id === 'tab-all'));
      });
      renderTable();
      renderTopBottom();
    }

    // ================== TABLE RENDERING ==================
    function getFilteredStocks() {
      let filtered = [...state.stocksList];

      // Country filter
      if (state.filter !== 'all') {
        if (state.filter === 'EU') {
          filtered = filtered.filter(s => !['US', 'KR', 'CN', 'JP', 'HK'].includes(s.country));
        } else {
          filtered = filtered.filter(s => s.country === state.filter);
        }
      }

      // Search filter
      if (state.search) {
        const term = state.search.toLowerCase();
        filtered = filtered.filter(s =>
          s.ticker.toLowerCase().includes(term) ||
          s.name.toLowerCase().includes(term) ||
          s.sector.toLowerCase().includes(term)
        );
      }

      // Sort
      const { key, asc } = state.sort;
      filtered.sort((a, b) => {
        let valA = a[key];
        let valB = b[key];
        if (typeof valA === 'string') {
          return asc ? valA.localeCompare(valB) : valB.localeCompare(valA);
        }
        return asc ? valA - valB : valB - valA;
      });

      return filtered;
    }

    function renderTable() {
      const tbody = document.getElementById('tableBody');
      const filtered = getFilteredStocks();
      const totalPages = Math.ceil(filtered.length / state.pageSize);
      const start = (state.page - 1) * state.pageSize;
      const pageData = filtered.slice(start, start + state.pageSize);

      tbody.innerHTML = pageData.map(stock => {
        const r12Class = stock.r12 >= 0 ? 'positive' : 'negative';
        const isSelected = stock.ticker === state.selectedTicker;
        return `
          <tr onclick="openDetail('${stock.ticker}')" class="hover:bg-emerald-50 ${isSelected ? 'selected' : ''}">
            <td class="text-center">
              <button onclick="event.stopPropagation(); analyzeStock('${stock.ticker}')"
                      class="px-2 py-1 ${isSelected ? 'bg-emerald-600' : 'bg-emerald-500'} text-white text-xs rounded hover:bg-emerald-600 transition"
                      title="ë¶„ì„ ëª¨ë“œ">
                ğŸ“Š
              </button>
            </td>
            <td class="font-bold text-emerald-600">${stock.ticker}</td>
            <td class="text-gray-800">${stock.name}</td>
            <td><span class="badge badge-sector">${stock.sector}</span></td>
            <td class="mono">${formatMarketCap(stock.mc)}</td>
            <td class="mono">${formatNumber(stock.pe, 1)}</td>
            <td class="mono">${formatNumber(stock.pb, 2)}</td>
            <td class="mono">${formatPercent(stock.dy)}</td>
            <td class="mono ${r12Class}">${formatPercent(stock.r12)}</td>
          </tr>
        `;
      }).join('');

      renderPagination(totalPages);
    }

    function renderPagination(totalPages) {
      const container = document.getElementById('pagination');
      if (totalPages <= 1) {
        container.innerHTML = '';
        return;
      }

      let html = `
        <button class="page-btn" onclick="goToPage(1)" ${state.page === 1 ? 'disabled' : ''}>
          <i class="fas fa-angle-double-left"></i>
        </button>
        <button class="page-btn" onclick="goToPage(${state.page - 1})" ${state.page === 1 ? 'disabled' : ''}>
          <i class="fas fa-angle-left"></i>
        </button>
      `;

      const start = Math.max(1, state.page - 2);
      const end = Math.min(totalPages, state.page + 2);

      for (let i = start; i <= end; i++) {
        html += `<button class="page-btn ${i === state.page ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
      }

      html += `
        <button class="page-btn" onclick="goToPage(${state.page + 1})" ${state.page === totalPages ? 'disabled' : ''}>
          <i class="fas fa-angle-right"></i>
        </button>
        <button class="page-btn" onclick="goToPage(${totalPages})" ${state.page === totalPages ? 'disabled' : ''}>
          <i class="fas fa-angle-double-right"></i>
        </button>
        <span class="text-sm text-gray-500 ml-2">${state.page} / ${totalPages}</span>
      `;

      container.innerHTML = html;
    }

    function goToPage(page) {
      state.page = page;
      renderTable();
    }

    function sortTable(key) {
      if (state.sort.key === key) {
        state.sort.asc = !state.sort.asc;
      } else {
        state.sort = { key, asc: key === 'ticker' || key === 'name' };
      }
      renderTable();
    }

    function filterTable() {
      state.search = document.getElementById('search').value;
      state.page = 1;
      renderTable();
    }

    // ================== TOP/BOTTOM ==================
    function renderTopBottom() {
      const filtered = getFilteredStocks();
      const sorted = [...filtered].sort((a, b) => b.r12 - a.r12);
      const top5 = sorted.slice(0, 5);
      const bottom5 = sorted.slice(-5).reverse();

      document.getElementById('top5-cards').innerHTML = top5.map(s => `
        <div class="metric-card flex items-center justify-between p-2 bg-green-50 rounded-lg" onclick="openDetail('${s.ticker}')">
          <div>
            <span class="font-bold text-emerald-700">${s.ticker}</span>
            <span class="text-xs text-gray-500 ml-2">${s.name}</span>
          </div>
          <span class="mono font-bold text-green-600">${formatPercent(s.r12)}</span>
        </div>
      `).join('');

      document.getElementById('bottom5-cards').innerHTML = bottom5.map(s => `
        <div class="metric-card flex items-center justify-between p-2 bg-red-50 rounded-lg" onclick="openDetail('${s.ticker}')">
          <div>
            <span class="font-bold text-red-700">${s.ticker}</span>
            <span class="text-xs text-gray-500 ml-2">${s.name}</span>
          </div>
          <span class="mono font-bold text-red-600">${formatPercent(s.r12)}</span>
        </div>
      `).join('');
    }

    // ================== SECTOR/COUNTRY SUMMARY ==================
    function renderSectorSummary() {
      if (!state.dashboard) return;

      const { sectors, countries, summary } = state.dashboard;

      // Sector Summary (sorted by count)
      const sectorContainer = document.getElementById('sector-summary');
      if (sectorContainer && sectors) {
        const sortedSectors = Object.entries(sectors)
          .sort((a, b) => b[1].count - a[1].count);

        sectorContainer.innerHTML = sortedSectors.map(([name, data]) => `
          <div class="flex items-center justify-between py-1.5 border-b border-gray-100">
            <span class="text-gray-700">${name}</span>
            <div class="flex items-center gap-4">
              <span class="text-xs text-gray-500">${data.count}ê°œ</span>
              <span class="text-xs text-blue-600 mono">${formatMarketCap(data.market_cap)}</span>
              <span class="text-xs text-emerald-600 mono">P/E ${formatNumber(data.avg_per, 1)}</span>
            </div>
          </div>
        `).join('');
      }

      // Country Summary
      const countryContainer = document.getElementById('country-summary');
      if (countryContainer && countries) {
        const countryFlags = { US: 'ğŸ‡ºğŸ‡¸', KR: 'ğŸ‡°ğŸ‡·', CN: 'ğŸ‡¨ğŸ‡³', JP: 'ğŸ‡¯ğŸ‡µ', HK: 'ğŸ‡­ğŸ‡°' };
        const countryNames = { US: 'ë¯¸êµ­', KR: 'í•œêµ­', CN: 'ì¤‘êµ­', JP: 'ì¼ë³¸', HK: 'í™ì½©' };
        const sortedCountries = Object.entries(countries)
          .sort((a, b) => b[1].count - a[1].count);

        countryContainer.innerHTML = sortedCountries.map(([code, data]) => `
          <div class="flex items-center justify-between p-3 bg-blue-50 rounded-lg">
            <div class="flex items-center gap-2">
              <span class="text-xl">${countryFlags[code] || 'ğŸŒ'}</span>
              <span class="font-medium text-gray-700">${countryNames[code] || code}</span>
            </div>
            <div class="flex items-center gap-4">
              <span class="text-sm text-gray-600">${data.count}ê°œ</span>
              <span class="text-sm font-bold text-blue-600 mono">${formatMarketCap(data.market_cap)}</span>
            </div>
          </div>
        `).join('');
      }
    }

    // ================== DETAIL LOADING ==================
    async function loadDetailData(ticker) {
      if (state.detailCache[ticker]) return state.detailCache[ticker];

      try {
        const res = await fetch(DATA_URLS.stockDetail(ticker));
        const data = await res.json();
        state.detailCache[ticker] = data;
        return data;
      } catch (e) {
        console.warn(`Failed to load detail for ${ticker}:`, e);
        return null;
      }
    }

    async function openDetail(ticker) {
      const data = await loadDetailData(ticker);
      if (!data) {
        alert('ìƒì„¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      // v3: ëª¨ë“  ë“œë¡­ë‹¤ìš´ì— ì„ íƒê°’ ìë™ ì„¤ì •
      setSelectorsValue(ticker);

      const stock = state.stocksList.find(s => s.ticker === ticker);
      const panel = document.getElementById('detailPanel');
      const content = document.getElementById('detailContent');
      const overlay = document.getElementById('detailOverlay');

      // v4.3: Growth Classification + Fiscal Month
      const growthClass = classifyStock(data.growth_consensus);
      const fiscalInfo = data.fiscal_month ? ` Â· ê²°ì‚°ì›”: ${data.fiscal_month}` : '';

      content.innerHTML = `
        <div class="flex items-center justify-between mb-6">
          <div>
            <div class="flex items-center gap-3">
              <h2 class="text-xl font-bold text-emerald-600">${ticker}</h2>
              <span class="px-2 py-1 rounded text-xs font-semibold ${growthClass.bgColor} ${growthClass.color}" title="7Y ì´ìµì„±ì¥ ê¸°ì¤€">${growthClass.badge} ${growthClass.label}</span>
            </div>
            <p class="text-gray-500">${stock?.name || ticker}${fiscalInfo}</p>
          </div>
          <button onclick="closeDetail()" class="p-2 text-gray-400 hover:text-gray-600" aria-label="ë‹«ê¸°">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-6">
          <div class="bg-emerald-50 rounded-lg p-4">
            <div class="text-xs text-gray-500">ì‹œê°€ì´ì•¡</div>
            <div class="text-lg font-bold text-emerald-600 mono">${formatMarketCap(stock?.mc)}</div>
          </div>
          <div class="bg-blue-50 rounded-lg p-4">
            <div class="text-xs text-gray-500">P/E</div>
            <div class="text-lg font-bold text-blue-600 mono">${formatNumber(data.valuation?.per?.[4] || stock?.pe, 1)}</div>
          </div>
          <div class="bg-purple-50 rounded-lg p-4">
            <div class="text-xs text-gray-500">ROE</div>
            <div class="text-lg font-bold text-purple-600 mono">${formatPercent((data.profitability?.roe?.[4] || 0) / 100)}</div>
          </div>
          <div class="bg-amber-50 rounded-lg p-4">
            <div class="text-xs text-gray-500">ë°°ë‹¹ë¥ </div>
            <div class="text-lg font-bold text-amber-600 mono">${formatPercent((data.dividend?.div_yield?.[4] || 0) / 100)}</div>
          </div>
        </div>

        <h3 class="font-bold text-gray-700 mb-3">5ê°œë…„ ì¬ë¬´ í•˜ì´ë¼ì´íŠ¸</h3>
        <table class="text-sm w-full mb-6">
          <thead>
            <tr>
              <th class="text-left">í•­ëª©</th>
              ${data.years?.map(y => `<th class="text-right">${y}</th>`).join('') || ''}
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>ë§¤ì¶œì•¡</td>
              ${data.income_statement?.revenue?.map(v => `<td class="text-right mono">${formatB(v)}</td>`).join('') || ''}
            </tr>
            <tr>
              <td>ìˆœì´ìµ</td>
              ${data.income_statement?.net_income?.map(v => `<td class="text-right mono">${formatB(v)}</td>`).join('') || ''}
            </tr>
            <tr>
              <td>EPS</td>
              ${data.per_share?.eps?.map(v => `<td class="text-right mono">$${formatNumber(v, 2)}</td>`).join('') || ''}
            </tr>
            <tr>
              <td>P/E</td>
              ${data.valuation?.per?.map(v => `<td class="text-right mono">${formatNumber(v, 1)}</td>`).join('') || ''}
            </tr>
          </tbody>
        </table>

        <h3 class="font-bold text-gray-700 mb-3">EPS ì»¨ì„¼ì„œìŠ¤ (6ì£¼ í‰ê· )</h3>
        <div class="grid grid-cols-3 gap-4 mb-6">
          <div class="bg-gray-50 rounded-lg p-3 text-center">
            <div class="text-xs text-gray-500">FY+1 EPS</div>
            <div class="font-bold text-emerald-600 mono">$${formatNumber(data.eps_consensus?.fy_plus_1, 2)}</div>
          </div>
          <div class="bg-gray-50 rounded-lg p-3 text-center">
            <div class="text-xs text-gray-500">FY+2 EPS</div>
            <div class="font-bold text-blue-600 mono">$${formatNumber(data.eps_consensus?.fy_plus_2, 2)}</div>
          </div>
          <div class="bg-gray-50 rounded-lg p-3 text-center">
            <div class="text-xs text-gray-500">FY+3 EPS</div>
            <div class="font-bold text-purple-600 mono">$${formatNumber(data.eps_consensus?.fy_plus_3, 2)}</div>
          </div>
        </div>

        <!-- v3: Scale ë°ì´í„° í™œìš© - ì‹œê°€ì´ì•¡ ì¶”ì´ -->
        ${data.scale?.market_cap ? `
        <h3 class="font-bold text-gray-700 mb-3">ì‹œê°€ì´ì•¡ ì¶”ì´</h3>
        <div class="flex gap-2 overflow-x-auto pb-2">
          ${data.scale.market_cap.map((v, i) => `
            <div class="bg-gradient-to-b from-emerald-50 to-white p-2 rounded-lg text-center min-w-16 flex-shrink-0 border border-emerald-100">
              <div class="text-xs text-gray-400">${data.years?.[i] || 'FY'}</div>
              <div class="font-bold text-emerald-700 mono text-sm">${formatMarketCap(v)}</div>
            </div>
          `).join('')}
        </div>
        ` : ''}

        <!-- v4.3: Forward P/E ê³„ì‚° - eps_consensus ì‚¬ìš© -->
        ${stock?.price && data.eps_consensus?.fy_plus_1 ? `
        <div class="mt-4 p-3 bg-purple-50 rounded-lg">
          <div class="flex items-center justify-between">
            <span class="text-sm text-purple-700">Forward P/E (FY+1)</span>
            <span class="font-bold text-purple-600 mono">${formatNumber(stock.price / data.eps_consensus.fy_plus_1, 2)}</span>
          </div>
          <div class="text-xs text-purple-500 mt-1">
            í˜„ì¬ê°€ $${formatNumber(stock.price, 2)} Ã· FY+1 ì»¨ì„¼ì„œìŠ¤ EPS $${formatNumber(data.eps_consensus.fy_plus_1, 2)}
          </div>
        </div>
        ` : ''}
      `;

      panel.classList.add('open');
      overlay.classList.add('open');
    }

    function closeDetail() {
      document.getElementById('detailPanel').classList.remove('open');
      document.getElementById('detailOverlay').classList.remove('open');
    }

    // ================== SELECTORS (v3: TomSelect + ì „ì²´ ì¢…ëª©) ==================
    let tomSelectInstances = {};

    function populateSelectors() {
      const selectors = ['financialSelector', 'valuationSelector', 'growthSelector', 'dividendSelector', 'dcfSelector', 'ddmSelector', 'peerSelector'];
      // v3: slice(0, 100) ì œê±° â†’ ì „ì²´ 1,243ê°œ ì¢…ëª©
      const sorted = [...state.stocksList].sort((a, b) => b.mc - a.mc);

      selectors.forEach(id => {
        const select = document.getElementById(id);
        if (!select) return;

        // TomSelect ì´ë¯¸ ì´ˆê¸°í™”ëœ ê²½ìš° destroy
        if (tomSelectInstances[id]) {
          tomSelectInstances[id].destroy();
          delete tomSelectInstances[id];
        }

        select.innerHTML = '<option value="">-- ì¢…ëª© ì„ íƒ --</option>';
        sorted.forEach(stock => {
          const opt = document.createElement('option');
          opt.value = stock.ticker;
          opt.textContent = `${stock.ticker} - ${stock.name}`;
          select.appendChild(opt);
        });

        // TomSelect ì´ˆê¸°í™”
        tomSelectInstances[id] = new TomSelect(select, {
          maxItems: 1,
          placeholder: 'í‹°ì»¤/íšŒì‚¬ëª… ê²€ìƒ‰...',
          allowEmptyOption: true,
          create: false,
          sortField: { field: 'text', direction: 'asc' }
        });
      });
    }

    // ë“œë¡­ë‹¤ìš´ ê°’ ì„¤ì • (TomSelect í˜¸í™˜)
    function setSelectorsValue(ticker) {
      ['financialSelector', 'valuationSelector', 'growthSelector', 'dividendSelector', 'dcfSelector', 'ddmSelector', 'peerSelector'].forEach(id => {
        if (tomSelectInstances[id]) {
          tomSelectInstances[id].setValue(ticker, true);
        }
      });
    }

    // ================== v4: TOAST NOTIFICATION ==================
    function showToast(message, type = 'success') {
      const colors = {
        success: 'bg-emerald-600',
        warning: 'bg-amber-500',
        error: 'bg-red-500',
        info: 'bg-blue-500'
      };
      const icons = {
        success: 'fa-check-circle',
        warning: 'fa-exclamation-triangle',
        error: 'fa-times-circle',
        info: 'fa-info-circle'
      };

      const toast = document.createElement('div');
      toast.className = `fixed top-4 right-4 px-6 py-3 ${colors[type]} text-white rounded-lg shadow-lg z-50 toast-enter flex items-center gap-2`;
      toast.innerHTML = `<i class="fas ${icons[type]}"></i>${message}`;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.classList.replace('toast-enter', 'toast-exit');
        setTimeout(() => toast.remove(), 300);
      }, 2500);
    }

    // ================== v4: GLOBAL STOCK SELECTOR ==================
    function initGlobalSelector() {
      const select = document.getElementById('globalStockSelector');
      if (!select) return;

      // Sort by market cap
      const sorted = [...state.stocksList].sort((a, b) => b.mc - a.mc);

      sorted.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.ticker;
        opt.textContent = `${s.ticker} - ${s.name}`;
        select.appendChild(opt);
      });

      tomSelectInstances.global = new TomSelect(select, {
        maxItems: 1,
        placeholder: 'í‹°ì»¤/íšŒì‚¬ëª… ê²€ìƒ‰...',
        allowEmptyOption: true,
        create: false,
        sortField: { field: 'text', direction: 'asc' },
        onChange: (ticker) => {
          if (ticker) {
            syncGlobalSelection(ticker);
          }
        }
      });
    }

    function syncGlobalSelection(ticker) {
      if (!ticker) return;

      state.selectedTicker = ticker;
      setSelectorsValue(ticker);
      updateSelectedStockBadge(ticker);
      renderCurrentTabContent();
      renderTable(); // Update table highlighting
      showToast(`${ticker} ë¶„ì„ ëª¨ë“œ`);
    }

    function updateSelectedStockBadge(ticker) {
      const stock = state.stocksList.find(s => s.ticker === ticker);
      const badge = document.getElementById('selectedStockBadge');
      const name = document.getElementById('selectedStockName');

      if (stock && badge && name) {
        name.textContent = `${ticker} - ${stock.name}`;
        badge.classList.remove('hidden');
      }
    }

    function analyzeStock(ticker) {
      // Update global selector
      if (tomSelectInstances.global) {
        tomSelectInstances.global.setValue(ticker, true);
      }
      syncGlobalSelection(ticker);
    }

    // ================== v4.3.1: PEER SEARCH (Direct Typing) ==================
    // Debounce utility
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    function initPeerSearch() {
      const input = document.getElementById('peerSearchInput');
      const results = document.getElementById('peerSearchResults');
      if (!input || !results) return;

      const debouncedSearch = debounce(() => {
        const query = input.value.toLowerCase().trim();
        if (query.length < 1) {
          results.classList.add('hidden');
          return;
        }

        const matches = state.stocksList
          .filter(s =>
            s.ticker.toLowerCase().includes(query) ||
            s.name.toLowerCase().includes(query)
          )
          .slice(0, 10);

        if (matches.length === 0) {
          results.innerHTML = '<div class="p-3 text-gray-500 text-sm">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>';
          results.classList.remove('hidden');
          return;
        }

        results.innerHTML = matches.map(s => `
          <div class="peer-search-item p-2 hover:bg-teal-50 cursor-pointer border-b last:border-b-0"
               data-ticker="${s.ticker}">
            <span class="font-medium text-teal-700">${s.ticker}</span>
            <span class="text-gray-500 text-sm ml-2">${s.name}</span>
          </div>
        `).join('');
        results.classList.remove('hidden');

        // Click handler for results
        results.querySelectorAll('.peer-search-item').forEach(item => {
          item.addEventListener('click', () => {
            const ticker = item.dataset.ticker;
            addManualPeer(ticker);
            input.value = '';
            results.classList.add('hidden');
          });
        });
      }, 200);

      input.addEventListener('input', debouncedSearch);

      // Hide results on click outside
      document.addEventListener('click', (e) => {
        if (!input.contains(e.target) && !results.contains(e.target)) {
          results.classList.add('hidden');
        }
      });

      // Enter key to add first match
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          const firstItem = results.querySelector('.peer-search-item');
          if (firstItem) {
            const ticker = firstItem.dataset.ticker;
            addManualPeer(ticker);
            input.value = '';
            results.classList.add('hidden');
          }
        }
      });
    }

    // Legacy function name for backward compatibility
    function initManualPeerSelector() {
      initPeerSearch();
    }

    function addManualPeer(ticker) {
      if (ticker === state.selectedTicker) {
        showToast('ê¸°ì¤€ ì¢…ëª©ì€ ì¶”ê°€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'warning');
        return;
      }
      if (state.manualPeers.length >= 4) {
        showToast('ìµœëŒ€ 4ê°œê¹Œì§€ ì¶”ê°€ ê°€ëŠ¥ (ê¸°ì¤€ í¬í•¨ 5ê°œ)', 'warning');
        return;
      }
      if (state.manualPeers.includes(ticker)) {
        showToast('ì´ë¯¸ ì¶”ê°€ëœ ì¢…ëª©ì…ë‹ˆë‹¤', 'warning');
        return;
      }

      state.manualPeers.push(ticker);
      renderManualPeerChips();
      renderPeerTab();
      showToast(`${ticker} ë¹„êµ ì¢…ëª© ì¶”ê°€`, 'info');
    }

    function removeManualPeer(ticker) {
      state.manualPeers = state.manualPeers.filter(t => t !== ticker);
      renderManualPeerChips();
      renderPeerQuickAdd();  // #196
      renderPeerTab();
    }

    function renderManualPeerChips() {
      const container = document.getElementById('selectedPeerChips');
      if (!container) return;

      // Base stock chip (non-removable)
      const baseTicker = state.selectedTicker;
      let html = baseTicker ? `
        <span class="peer-chip peer-chip-base">
          <i class="fas fa-star text-amber-500 text-xs"></i>
          ${baseTicker} (ê¸°ì¤€)
        </span>
      ` : '';

      // Manual peer chips (removable)
      html += state.manualPeers.map(ticker => `
        <span class="peer-chip peer-chip-manual">
          ${ticker}
          <button onclick="removeManualPeer('${ticker}')" class="peer-chip-remove">
            <i class="fas fa-times text-xs"></i>
          </button>
        </span>
      `).join('');

      container.innerHTML = html;

      // #196: Update quick-add suggestions
      renderPeerQuickAdd();
    }

    // #196: Quick-add peer suggestions
    function renderPeerQuickAdd() {
      const container = document.getElementById('peerQuickAdd');
      if (!container || !state.selectedTicker) {
        if (container) container.classList.add('hidden');
        return;
      }

      const stock = state.stocksList.find(s => s.ticker === state.selectedTicker);
      if (!stock) {
        container.classList.add('hidden');
        return;
      }

      // Get sector peers sorted by market cap, exclude base and already added
      const sectorPeers = state.stocksList
        .filter(s => s.sector === stock.sector && s.ticker !== state.selectedTicker && !state.manualPeers.includes(s.ticker))
        .sort((a, b) => b.mc - a.mc)
        .slice(0, 3);

      if (sectorPeers.length === 0) {
        container.classList.add('hidden');
        return;
      }

      const buttonsHtml = sectorPeers.map(p => `
        <button class="peer-quick-btn" onclick="addQuickPeer('${p.ticker}')">
          <i class="fas fa-plus"></i>${p.ticker}
        </button>
      `).join('');

      container.innerHTML = `
        <span class="text-xs text-gray-500 mr-2"><i class="fas fa-lightbulb text-amber-400 mr-1"></i>ì¶”ì²œ:</span>
        ${buttonsHtml}
      `;
      container.classList.remove('hidden');
    }

    function addQuickPeer(ticker) {
      if (state.manualPeers.includes(ticker)) return;
      if (state.manualPeers.length >= 4) {
        showToast('ìµœëŒ€ 5ê°œ ì¢…ëª©ê¹Œì§€ ë¹„êµ ê°€ëŠ¥í•©ë‹ˆë‹¤', 'warning');
        return;
      }

      state.manualPeers.push(ticker);
      renderManualPeerChips();
      renderPeerQuickAdd();
      renderPeerTab();
      showToast(`${ticker} ì¶”ê°€ë¨`, 'info');
    }

    // ================== v4: OVERLAY COMPARISON CHART ==================
    function setComparisonPeriod(period) {
      state.comparisonPeriod = period;
      document.querySelectorAll('.overlay-period-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.period === period);
      });
      renderOverlayChart();
    }

    function renderOverlayChart() {
      const overlayEmpty = document.getElementById('overlayEmptyState');
      const overlayCanvas = document.getElementById('overlayChart');

      if (!overlayEmpty || !overlayCanvas) return;

      let peers;
      if (state.peerMode === 'auto') {
        // Auto mode: sector top 5 by market cap
        if (!state.selectedTicker) {
          overlayEmpty.style.display = 'flex';
          return;
        }
        const stock = state.stocksList.find(s => s.ticker === state.selectedTicker);
        if (!stock) {
          overlayEmpty.style.display = 'flex';
          return;
        }
        const sectorPeers = state.stocksList
          .filter(s => s.sector === stock.sector)
          .sort((a, b) => b.mc - a.mc)
          .slice(0, 5)
          .map(s => s.ticker);
        peers = sectorPeers;
      } else {
        // Manual mode: base + selected peers
        if (!state.selectedTicker) {
          overlayEmpty.style.display = 'flex';
          return;
        }
        peers = [state.selectedTicker, ...state.manualPeers];
      }

      if (peers.length < 2) {
        overlayEmpty.style.display = 'flex';
        return;
      }
      overlayEmpty.style.display = 'none';

      // Chart colors (distinct for each stock)
      const colors = ['#10b981', '#3b82f6', '#8b5cf6', '#f59e0b', '#ef4444'];

      // Generate indexed return data
      // Note: Using r12 (12M return) as proxy since we don't have daily price data
      const periodMonths = { '1m': 1, '3m': 3, '6m': 6, '1y': 12, 'ytd': new Date().getMonth() + 1 };
      const months = periodMonths[state.comparisonPeriod] || 6;

      const datasets = peers.map((ticker, i) => {
        const stock = state.stocksList.find(s => s.ticker === ticker);
        const r12 = stock?.r12 || 0;

        // Simulate monthly returns based on r12
        // Using volatility simulation to make it more realistic
        const monthlyReturn = r12 / 12;
        const volatility = Math.abs(r12) / 20; // Proportional volatility

        const data = [0];  // Start at 0%
        let cumReturn = 0;
        for (let m = 1; m <= months; m++) {
          // Add some randomness but trend toward r12
          const noise = (Math.random() - 0.5) * volatility * 2;
          cumReturn += monthlyReturn + noise;
          data.push(cumReturn);
        }

        // Adjust final point to match r12 proportionally
        const factor = months / 12;
        const expectedReturn = r12 * factor;
        const adjustment = (expectedReturn - cumReturn) / months;
        for (let m = 1; m <= months; m++) {
          data[m] += adjustment * m;
        }

        return {
          label: ticker,
          data: data,
          borderColor: colors[i % colors.length],
          backgroundColor: 'transparent',
          borderWidth: ticker === state.selectedTicker ? 3 : 2,
          pointRadius: 0,
          tension: 0.4
        };
      });

      // Generate labels
      const labels = ['Start'];
      for (let m = 1; m <= months; m++) {
        labels.push(`M${m}`);
      }

      // Render chart
      const ctx = overlayCanvas.getContext('2d');
      if (charts.overlay) charts.overlay.destroy();

      charts.overlay = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          scales: {
            y: {
              title: { display: true, text: 'ìƒëŒ€ ìˆ˜ìµë¥  (%)' },
              ticks: { callback: v => `${v.toFixed(1)}%` }
            }
          },
          plugins: {
            legend: { position: 'top' },
            tooltip: {
              callbacks: {
                label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(2)}%`
              }
            }
          }
        }
      });
    }

    // ================== FINANCIALS CHART ==================
    function setFinancialMetric(metric) {
      state.financialMetric = metric;
      document.querySelectorAll('#section-financials .metric-tabs .tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.metric === metric);
      });
      renderFinancialsChart();
    }

    async function renderFinancialsChart() {
      const ticker = document.getElementById('financialSelector').value;
      if (!ticker) {
        document.getElementById('financialsEmptyState').style.display = 'flex';
        document.getElementById('financialSummary').classList.add('hidden');
        return;
      }

      const data = await loadDetailData(ticker);
      if (!data) return;

      document.getElementById('financialsEmptyState').style.display = 'none';
      document.getElementById('financialSummary').classList.remove('hidden');

      const ctx = document.getElementById('financialsChart').getContext('2d');
      const years = data.years || ['FY-4', 'FY-3', 'FY-2', 'FY-1', 'FY0'];

      let chartData, label;
      switch (state.financialMetric) {
        case 'revenue':
          chartData = data.income_statement?.revenue || [];
          label = 'ë§¤ì¶œì•¡';
          break;
        case 'gross_profit':
          chartData = data.income_statement?.gross_profit || [];
          label = 'ë§¤ì¶œì´ì´ìµ';
          break;
        case 'operating_income':
          chartData = data.income_statement?.operating_income || [];
          label = 'ì˜ì—…ì´ìµ';
          break;
        case 'net_income':
          chartData = data.income_statement?.net_income || [];
          label = 'ìˆœì´ìµ';
          break;
        case 'sga':
          chartData = data.income_statement?.sga || [];
          label = 'íŒê´€ë¹„(SG&A)';
          break;
        case 'fcf':
          chartData = data.cash_flow?.fcf || [];
          label = 'Free Cash Flow';
          break;
        case 'cfi':
          chartData = data.cash_flow?.cfi || [];
          label = 'íˆ¬ìí™œë™ í˜„ê¸ˆíë¦„';
          break;
        case 'cff':
          chartData = data.cash_flow?.cff || [];
          label = 'ì¬ë¬´í™œë™ í˜„ê¸ˆíë¦„';
          break;
      }

      if (charts.financials) charts.financials.destroy();

      // v3: ê³¼ê±° ì‹¤ì  + ë¯¸ë˜ ì˜ˆì¸¡ ë°ì´í„° ì¡°í™”
      const datasets = [];
      let allLabels = [...years];

      // ê¸°ë³¸ ì‹¤ì  ë°ì´í„°
      datasets.push({
        label: `${label} (ì‹¤ì )`,
        data: chartData,
        backgroundColor: 'rgba(16, 185, 129, 0.8)',
        borderColor: '#10b981',
        borderWidth: 1,
        order: 1
      });

      // ë¯¸ë˜ ì˜ˆì¸¡ ë°ì´í„° ì¶”ê°€ (ë§¤ì¶œ/ìˆœì´ìµ/EPS)
      let estimateData = [];
      let estimateLabels = ['FY+1', 'FY+2', 'FY+3'];

      if (state.financialMetric === 'revenue' && data.estimates?.revenue) {
        estimateData = [
          data.estimates.revenue.fy1,
          data.estimates.revenue.fy2,
          data.estimates.revenue.fy3
        ].filter(v => v != null);
      } else if (state.financialMetric === 'net_income' && data.estimates?.net_income) {
        estimateData = [
          data.estimates.net_income.fy1,
          data.estimates.net_income.fy2,
          data.estimates.net_income.fy3
        ].filter(v => v != null);
      }

      // ì˜ˆì¸¡ ë°ì´í„°ê°€ ìˆìœ¼ë©´ í™•ì¥
      if (estimateData.length > 0) {
        allLabels = [...years, ...estimateLabels.slice(0, estimateData.length)];

        // ì‹¤ì  ë°ì´í„°ì— null íŒ¨ë”©
        const paddedHistorical = [...chartData, ...new Array(estimateData.length).fill(null)];
        datasets[0].data = paddedHistorical;

        // ì˜ˆì¸¡ ë°ì´í„° (ë°˜íˆ¬ëª… + íŒ¨í„´)
        const paddedEstimate = [...new Array(years.length).fill(null), ...estimateData];
        datasets.push({
          label: `${label} (ì˜ˆì¸¡)`,
          data: paddedEstimate,
          backgroundColor: 'rgba(139, 92, 246, 0.4)', // ë³´ë¼ìƒ‰ ë°˜íˆ¬ëª…
          borderColor: '#8b5cf6',
          borderWidth: 2,
          borderDash: [4, 4],
          order: 2
        });
      }

      charts.financials = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: allLabels,
          datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true, position: 'top' },
            tooltip: {
              callbacks: {
                label: ctx => `${ctx.dataset.label}: ${formatB(ctx.raw)}`
              }
            }
          },
          scales: {
            y: {
              ticks: { callback: v => formatB(v) }
            }
          }
        }
      });

      // Summary table
      const summary = document.getElementById('financialSummaryBody');
      summary.innerHTML = `
        <tr><td>ë§¤ì¶œì•¡</td>${(data.income_statement?.revenue || []).map(v => `<td class="mono text-right">${formatB(v)}</td>`).join('')}</tr>
        <tr><td>ì˜ì—…ì´ìµ</td>${(data.income_statement?.operating_income || []).map(v => `<td class="mono text-right">${formatB(v)}</td>`).join('')}</tr>
        <tr><td>ìˆœì´ìµ</td>${(data.income_statement?.net_income || []).map(v => `<td class="mono text-right">${formatB(v)}</td>`).join('')}</tr>
        <tr><td>FCF</td>${(data.cash_flow?.fcf || []).map(v => `<td class="mono text-right">${formatB(v)}</td>`).join('')}</tr>
      `;
    }

    // ================== VALUATIONS CHART ==================
    // v4.3.1: Metric-specific label mapping
    function getMetricLabels(metric) {
      const labels = {
        per: { current: 'í˜„ì¬ P/E', forward: 'Forward P/E', avg: '8Y í‰ê·  P/E', min: '8Y ìµœì € P/E', max: '8Y ìµœê³  P/E', position: 'ë°¸ë¥˜ì—ì´ì…˜ ìœ„ì¹˜' },
        pbr: { current: 'í˜„ì¬ P/B', forward: '-', avg: '5Y í‰ê·  P/B', min: '5Y ìµœì € P/B', max: '5Y ìµœê³  P/B', position: 'P/B ìœ„ì¹˜' },
        psr: { current: 'í˜„ì¬ P/S', forward: '-', avg: '-', min: '-', max: '-', position: '-' },
        pcr: { current: 'í˜„ì¬ P/C', forward: '-', avg: '-', min: '-', max: '-', position: '-' },
        peg: { current: 'í˜„ì¬ PEG', forward: '-', avg: '-', min: '-', max: '-', position: '-' }
      };
      return labels[metric] || labels.per;
    }

    function setValuationMetric(metric) {
      state.valuationMetric = metric;
      document.querySelectorAll('#section-valuations .metric-tabs .tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.metric === metric);
      });
      renderValuationsChart();
    }

    async function renderValuationsChart() {
      const ticker = document.getElementById('valuationSelector').value;
      if (!ticker) {
        document.getElementById('valuationsEmptyState').style.display = 'flex';
        document.getElementById('valuationSummary').classList.add('hidden');
        return;
      }

      const data = await loadDetailData(ticker);
      if (!data) return;

      document.getElementById('valuationsEmptyState').style.display = 'none';
      document.getElementById('valuationSummary').classList.remove('hidden');

      const ctx = document.getElementById('valuationsChart').getContext('2d');
      const years = data.years || ['FY-4', 'FY-3', 'FY-2', 'FY-1', 'FY0'];

      let chartData, band, label, color, bandPeriod;
      switch (state.valuationMetric) {
        case 'per':
          chartData = data.valuation?.per || [];
          // v4.3: per_bands 8ë…„ ë°ì´í„° ì‚¬ìš© (current, min_8y, max_8y, avg_8y)
          const perBands = data.per_bands || {};
          band = {
            min: perBands.min_8y ?? data.valuation?.per_band?.min,
            max: perBands.max_8y ?? data.valuation?.per_band?.max,
            avg: perBands.avg_8y ?? data.valuation?.per_band?.avg,
            current: perBands.current,
            source: perBands.source
          };
          bandPeriod = perBands.min_8y ? '8Y' : '5Y';
          label = 'P/E Ratio';
          color = '#10b981';
          break;
        case 'pbr':
          chartData = data.valuation?.pbr || [];
          band = data.valuation?.pbr_band || {};
          bandPeriod = '5Y';
          label = 'P/B Ratio';
          color = '#8b5cf6';
          break;
        case 'psr':
          chartData = data.valuation?.psr || [];
          band = {};
          label = 'P/S Ratio';
          color = '#f59e0b';
          break;
        case 'pcr':
          chartData = data.valuation?.pcr || [];
          band = {};
          label = 'P/C Ratio (Price-to-Cash)';
          color = '#3b82f6';
          break;
        case 'peg':
          chartData = data.valuation?.peg || [];
          band = {};
          label = 'PEG Ratio';
          color = '#ec4899';
          break;
      }

      if (charts.valuations) charts.valuations.destroy();

      // v4.3: P/E Band ì°¨íŠ¸ - per_bands 8ë…„ ë°ì´í„° + eps_consensus Forward P/E
      const datasets = [];
      const stock = state.stocksList.find(s => s.ticker === ticker);
      const fy1Eps = data.eps_consensus?.fy_plus_1 || 0;
      const forwardPE = (stock?.price && fy1Eps > 0) ? stock.price / fy1Eps : 0;

      // í™•ì¥ ë ˆì´ë¸” (Forward P/Eê°€ ìˆìœ¼ë©´ FY+1 ì¶”ê°€)
      const extendedLabels = forwardPE > 0 ? [...years, 'FY+1'] : years;

      // 1. Min ë°´ë“œ (í•˜ë‹¨ ê²½ê³„)
      if (band.min != null) {
        datasets.push({
          label: 'Min',
          data: new Array(extendedLabels.length).fill(band.min),
          borderColor: 'rgba(107, 114, 128, 0.4)',
          backgroundColor: 'transparent',
          borderDash: [2, 2],
          borderWidth: 1,
          pointRadius: 0,
          fill: false,
          order: 4
        });
      }

      // 2. Max ë°´ë“œ (ìƒë‹¨ ê²½ê³„) + ì˜ì—­ ì±„ìš°ê¸°
      if (band.max != null && band.min != null) {
        datasets.push({
          label: 'Max',
          data: new Array(extendedLabels.length).fill(band.max),
          borderColor: 'rgba(107, 114, 128, 0.4)',
          backgroundColor: 'rgba(107, 114, 128, 0.08)', // ë°´ë“œ ì˜ì—­ ìƒ‰
          borderDash: [2, 2],
          borderWidth: 1,
          pointRadius: 0,
          fill: '-1', // ì´ì „ dataset(Min)ê³¼ ì‚¬ì´ ì±„ìš°ê¸°
          order: 3
        });
      }

      // 3. í‰ê· ì„  (8Y/5Y ë™ì )
      if (band.avg != null) {
        datasets.push({
          label: `${bandPeriod || '5Y'} í‰ê· `,
          data: new Array(extendedLabels.length).fill(band.avg),
          borderColor: '#6b7280',
          borderDash: [5, 5],
          borderWidth: 2,
          pointRadius: 0,
          fill: false,
          order: 2
        });
      }

      // 3.5. v4.3: Current P/E ë§ˆì»¤ (per_bands.current í™œìš©) - ë³´ë¼ìƒ‰ìœ¼ë¡œ ë³€ê²½ (ë¹¨ê°•=ê³ í‰ê°€ì™€ êµ¬ë¶„)
      if (band.current != null && state.valuationMetric === 'per') {
        datasets.push({
          label: 'í˜„ì¬ P/E',
          data: new Array(extendedLabels.length).fill(band.current),
          borderColor: '#8b5cf6',
          borderDash: [8, 4],
          borderWidth: 2,
          pointRadius: 0,
          fill: false,
          order: 1.5
        });
      }

      // 4. ì‹¤ì œ P/E (ì‹¤ì„ ) - ê³¼ê±° ë°ì´í„°
      const historicalData = forwardPE > 0 ? [...chartData, null] : chartData;
      datasets.push({
        label: label,
        data: historicalData,
        borderColor: color,
        backgroundColor: `${color}33`,
        fill: false,
        tension: 0.3,
        pointRadius: 4,
        pointBackgroundColor: color,
        borderWidth: 2,
        order: 1
      });

      // 5. Forward P/E (FY+1 ìœ„ì¹˜ì— ì ì„  ì—°ê²°)
      if (forwardPE > 0) {
        // ë§ˆì§€ë§‰ ì‹¤ì œ P/E â†’ Forward P/E ì—°ê²°ì„ 
        const lastActual = chartData[chartData.length - 1] || 0;
        const forwardConnectData = [...chartData.map(() => null), lastActual];
        forwardConnectData[chartData.length - 1] = lastActual;
        forwardConnectData[chartData.length] = forwardPE;

        datasets.push({
          label: 'Forward P/E',
          data: [...chartData.map(() => null), forwardPE],
          borderColor: '#8b5cf6',
          backgroundColor: '#8b5cf6',
          borderDash: [3, 3],
          borderWidth: 2,
          pointRadius: 8,
          pointStyle: 'triangle',
          fill: false,
          order: 0,
          // ì—°ê²°ì„  í‘œì‹œë¥¼ ìœ„í•œ ì¶”ê°€ í¬ì¸íŠ¸
          segment: {
            borderDash: ctx => ctx.p0DataIndex === chartData.length - 1 ? [3, 3] : undefined
          }
        });

        // ì—°ê²°ì„  ì¶”ê°€
        datasets.push({
          label: '_connector',
          data: forwardConnectData,
          borderColor: '#8b5cf680',
          borderDash: [4, 4],
          borderWidth: 1,
          pointRadius: 0,
          fill: false,
          order: 1.5
        });
      }

      // 6. í˜„ì¬ P/E ìœ„ì¹˜ ë§ˆì»¤ (ìˆ˜í‰ì„ )
      const currentPE = chartData[chartData.length - 1] || 0;
      if (currentPE > 0) {
        datasets.push({
          label: 'í˜„ì¬',
          data: new Array(extendedLabels.length).fill(currentPE),
          borderColor: '#10b98180',
          borderWidth: 1,
          borderDash: [8, 4],
          pointRadius: 0,
          fill: false,
          order: 2.5
        });
      }

      charts.valuations = new Chart(ctx, {
        type: 'line',
        data: { labels: extendedLabels, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: {
                filter: item => !item.text.startsWith('_') // _connector ìˆ¨ê¸°ê¸°
              }
            },
            tooltip: {
              callbacks: {
                label: ctx => {
                  if (ctx.dataset.label.startsWith('_')) return null;
                  return `${ctx.dataset.label}: ${formatNumber(ctx.raw, 2)}`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: false,
              suggestedMin: band.min ? band.min * 0.8 : undefined,
              suggestedMax: band.max ? band.max * 1.2 : undefined
            }
          }
        }
      });

      // Update summary values
      document.getElementById('currentPE').textContent = formatNumber(currentPE, 2);
      // v4.3.2: Forward value only for P/E metric (EPS-based)
      if (state.valuationMetric === 'per') {
        document.getElementById('forwardPE').textContent = forwardPE > 0 ? formatNumber(forwardPE, 2) : '-';
      } else {
        document.getElementById('forwardPE').textContent = '-';
      }
      document.getElementById('avgPE').textContent = band.avg != null ? formatNumber(band.avg, 2) : '-';
      document.getElementById('minPE').textContent = band.min != null ? formatNumber(band.min, 2) : '-';
      document.getElementById('maxPE').textContent = band.max != null ? formatNumber(band.max, 2) : '-';

      // v4.3.1: Dynamic label update based on metric
      const metricLabels = getMetricLabels(state.valuationMetric);
      document.getElementById('currentPELabel').textContent = metricLabels.current;
      document.getElementById('forwardPELabel').textContent = metricLabels.forward;
      document.getElementById('avgPELabel').textContent = metricLabels.avg;
      document.getElementById('minPELabel').textContent = metricLabels.min;
      document.getElementById('maxPELabel').textContent = metricLabels.max;
      document.getElementById('positionLabel').textContent = metricLabels.position;

      // v4.3: P/E Position Badge (per_bands ê¸°ë°˜) - only show for P/E metric
      const positionCard = document.getElementById('pePositionCard');
      const positionBadge = document.getElementById('pePositionBadge');
      if (state.valuationMetric === 'per') {
        const pePosition = getPEPosition(data.per_bands);
        if (pePosition) {
          positionBadge.textContent = `${pePosition.badge} ${pePosition.label}`;
          positionCard.className = `rounded-lg p-4 text-center ${pePosition.bgColor}`;
          positionBadge.className = `text-lg font-bold ${pePosition.color}`;
        } else {
          positionBadge.textContent = '-';
          positionCard.className = 'rounded-lg p-4 text-center bg-gray-50';
          positionBadge.className = 'text-lg font-bold text-gray-400';
        }
      } else {
        // Non-P/E metrics: show dash
        positionBadge.textContent = '-';
        positionCard.className = 'rounded-lg p-4 text-center bg-gray-50';
        positionBadge.className = 'text-lg font-bold text-gray-400';
      }
    }

    // ================== GROWTH CHART ==================
    function setGrowthMetric(metric) {
      state.growthMetric = metric;
      document.querySelectorAll('#section-growth .metric-tabs .tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.metric === metric);
      });
      renderGrowthChart();
    }

    async function renderGrowthChart() {
      const ticker = document.getElementById('growthSelector').value;
      if (!ticker) {
        document.getElementById('growthEmptyState').style.display = 'flex';
        document.getElementById('growthSummary').classList.add('hidden');
        return;
      }

      const data = await loadDetailData(ticker);
      if (!data) return;

      document.getElementById('growthEmptyState').style.display = 'none';
      document.getElementById('growthSummary').classList.remove('hidden');

      const ctx = document.getElementById('growthChart').getContext('2d');

      let chartData, labels, label, color;
      let datasets = [];

      if (state.growthMetric === 'estimates') {
        // v4.3: eps_consensus ì‚¬ìš© - 6ì£¼ í‰ê·  ì»¨ì„¼ì„œìŠ¤
        labels = ['FY0', 'FY+1(E)', 'FY+2(E)', 'FY+3(E)'];
        const eps0 = data.per_share?.eps?.[4] || 0;
        const eps1 = data.eps_consensus?.fy_plus_1 || 0;
        const eps2 = data.eps_consensus?.fy_plus_2 || 0;
        const eps3 = data.eps_consensus?.fy_plus_3 || 0;
        chartData = [eps0, eps1, eps2, eps3];

        // ì‹¤ì  (ì‹¤ì„ , ì§„í•œ ìƒ‰) vs ì˜ˆì¸¡ (ì ì„ , ì—°í•œ ìƒ‰)
        datasets = [
          {
            label: 'EPS ì‹¤ì ',
            data: [eps0, null, null, null],
            borderColor: '#10b981',
            backgroundColor: '#10b981',
            pointRadius: 8,
            pointStyle: 'circle',
            fill: false,
            order: 1
          },
          {
            label: 'EPS ì˜ˆì¸¡',
            data: [eps0, eps1, eps2, eps3], // ì—°ê²°ì„ ìœ„í•´ FY0ë¶€í„° ì‹œì‘
            borderColor: '#8b5cf6',
            backgroundColor: 'rgba(139, 92, 246, 0.1)',
            borderDash: [5, 5],
            fill: true,
            tension: 0.3,
            pointRadius: [0, 6, 6, 6], // FY0ëŠ” ìˆ¨ê¹€
            pointStyle: 'triangle',
            order: 2
          }
        ];
        label = 'EPS';
        color = '#10b981';
      } else {
        labels = data.years || ['FY-4', 'FY-3', 'FY-2', 'FY-1', 'FY0'];
        chartData = data.growth?.[state.growthMetric] || [];
        const metricLabels = {
          'revenue_growth': 'ë§¤ì¶œ ì„±ì¥ë¥ ',
          'op_income_growth': 'ì˜ì—…ì´ìµ ì„±ì¥ë¥ ',
          'net_income_growth': 'ìˆœì´ìµ ì„±ì¥ë¥ ',
          'eps_growth': 'EPS ì„±ì¥ë¥ '
        };
        label = metricLabels[state.growthMetric] || state.growthMetric;
        color = '#f97316';

        datasets = [{
          label,
          data: chartData,
          borderColor: color,
          backgroundColor: chartData.map(v => v >= 0 ? 'rgba(16, 185, 129, 0.7)' : 'rgba(220, 38, 38, 0.7)'),
          fill: false,
          tension: 0.3
        }];
      }

      if (charts.growth) charts.growth.destroy();

      charts.growth = new Chart(ctx, {
        type: state.growthMetric === 'estimates' ? 'line' : 'bar',
        data: { labels, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true, position: 'top' },
            tooltip: {
              callbacks: {
                label: ctx => state.growthMetric === 'estimates' ? `$${formatNumber(ctx.raw, 2)}` : `${formatNumber(ctx.raw, 1)}%`
              }
            }
          },
          scales: {
            y: {
              ticks: {
                callback: v => state.growthMetric === 'estimates' ? `$${v}` : `${v}%`
              }
            }
          }
        }
      });

      // Calculate CAGR
      const revGrowth = data.growth?.revenue_growth || [];
      const epsGrowth = data.growth?.eps_growth || [];
      const revCAGR = revGrowth.length > 0 ? revGrowth.reduce((a, b) => a + b, 0) / revGrowth.length : 0;
      const epsCAGR = epsGrowth.length > 0 ? epsGrowth.reduce((a, b) => a + b, 0) / epsGrowth.length : 0;

      document.getElementById('revCAGR').textContent = `${formatNumber(revCAGR, 1)}%`;
      document.getElementById('epsCAGR').textContent = `${formatNumber(epsCAGR, 1)}%`;
      // v4.3: eps_consensus ì‚¬ìš©
      document.getElementById('fy1EPS').textContent = `$${formatNumber(data.eps_consensus?.fy_plus_1, 2)}`;
      document.getElementById('fy2EPS').textContent = `$${formatNumber(data.eps_consensus?.fy_plus_2, 2)}`;

      // v4.3: Growth Consensus ì—…ë°ì´íŠ¸
      const gc = data.growth_consensus;
      const gcPanel = document.getElementById('growthConsensus');
      if (gc && (gc.revenue_7y || gc.earnings_7y)) {
        gcPanel.classList.remove('hidden');
        document.getElementById('revGrowth7y').textContent = gc.revenue_7y ? `${formatNumber(gc.revenue_7y, 1)}%` : '-';
        document.getElementById('revGrowth3y').textContent = gc.revenue_3y ? `${formatNumber(gc.revenue_3y, 1)}%` : '-';
        document.getElementById('earnGrowth7y').textContent = gc.earnings_7y ? `${formatNumber(gc.earnings_7y, 1)}%` : '-';
        document.getElementById('earnGrowth3y').textContent = gc.earnings_3y ? `${formatNumber(gc.earnings_3y, 1)}%` : '-';

        // Growth Badge
        const classification = classifyStock(gc);
        const badgeEl = document.getElementById('growthBadge');
        badgeEl.textContent = `${classification.badge} ${classification.label}`;
        badgeEl.className = `px-2 py-1 rounded text-xs font-semibold ${classification.bgColor} ${classification.color}`;
      } else {
        gcPanel.classList.add('hidden');
      }
    }

    // ================== DIVIDEND CHART ==================
    function setDividendMetric(metric) {
      state.dividendMetric = metric;
      document.querySelectorAll('#section-dividends .metric-tabs .tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.metric === metric);
      });
      renderDividendChart();
    }

    async function renderDividendChart() {
      const ticker = document.getElementById('dividendSelector').value;
      if (!ticker) {
        document.getElementById('dividendEmptyState').style.display = 'flex';
        document.getElementById('dividendSummary').classList.add('hidden');
        return;
      }

      const data = await loadDetailData(ticker);
      if (!data) return;

      document.getElementById('dividendEmptyState').style.display = 'none';
      document.getElementById('dividendSummary').classList.remove('hidden');

      const ctx = document.getElementById('dividendChart').getContext('2d');
      const years = data.years || ['FY-4', 'FY-3', 'FY-2', 'FY-1', 'FY0'];

      let chartData, label, color;
      switch (state.dividendMetric) {
        case 'dps':
          chartData = data.dividend?.dps || [];
          label = 'ì£¼ë‹¹ ë°°ë‹¹ê¸ˆ (DPS)';
          color = '#f59e0b';
          break;
        case 'div_yield':
          chartData = data.dividend?.div_yield || [];
          label = 'ë°°ë‹¹ ìˆ˜ìµë¥ ';
          color = '#10b981';
          break;
        case 'roe':
          chartData = data.profitability?.roe || [];
          label = 'ROE';
          color = '#8b5cf6';
          break;
        case 'roa':
          chartData = data.profitability?.roa || [];
          label = 'ROA';
          color = '#6366f1';
          break;
        case 'gross_margin':
          chartData = data.profitability?.gross_margin || [];
          label = 'ë§¤ì¶œì´ì´ìµë¥ ';
          color = '#14b8a6';
          break;
        case 'operating_margin':
          chartData = data.profitability?.operating_margin || [];
          label = 'ì˜ì—…ì´ìµë¥ ';
          color = '#f97316';
          break;
        case 'net_margin':
          chartData = data.profitability?.net_margin || [];
          label = 'ìˆœì´ìµë¥ ';
          color = '#ec4899';
          break;
      }

      if (charts.dividend) charts.dividend.destroy();

      charts.dividend = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: years,
          datasets: [{
            label,
            data: chartData,
            backgroundColor: `${color}aa`,
            borderColor: color,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true, position: 'top' },
            tooltip: {
              callbacks: {
                label: ctx => state.dividendMetric === 'dps' ? `$${formatNumber(ctx.raw, 2)}` : `${formatNumber(ctx.raw, 2)}%`
              }
            }
          },
          scales: {
            y: {
              ticks: {
                callback: v => state.dividendMetric === 'dps' ? `$${v}` : `${v}%`
              }
            }
          }
        }
      });

      // Update summary
      const dps = data.dividend?.dps || [];
      const dy = data.dividend?.div_yield || [];
      const roe = data.profitability?.roe || [];

      document.getElementById('currentDPS').textContent = `$${formatNumber(dps[dps.length - 1], 2)}`;
      document.getElementById('currentYield').textContent = `${formatNumber(dy[dy.length - 1], 2)}%`;

      const dpsStart = dps[0] || 0;
      const dpsEnd = dps[dps.length - 1] || 0;
      const dpsCAGR = dpsStart > 0 ? ((Math.pow(dpsEnd / dpsStart, 1 / 4) - 1) * 100) : 0;
      document.getElementById('dpsCAGR').textContent = `${formatNumber(dpsCAGR, 1)}%`;

      const avgROE = roe.length > 0 ? roe.reduce((a, b) => a + b, 0) / roe.length : 0;
      document.getElementById('avgROE').textContent = `${formatNumber(avgROE, 1)}%`;
    }

    // ================== ETF TABLE (v3: 17ê°œ ì»¬ëŸ¼ ì™„ì „í™” + v4.3.1: ì •ë ¬) ==================
    // v4.3.1: ETF sorting function
    function sortETFs(key) {
      if (state.etfSortKey === key) {
        state.etfSortDir = state.etfSortDir === 'asc' ? 'desc' : 'asc';
      } else {
        state.etfSortKey = key;
        state.etfSortDir = 'desc'; // Default to descending for numbers
      }
      renderETFTable();
    }

    // v4.3.1: Update sort icons
    function updateETFSortIcons() {
      const keys = ['ticker', 'category', 'market_cap', 'r1m', 'r3m', 'r6m', 'ytd', 'r1y', 'r3y', 'r5y', 'r10y', 'cagr3y', 'cagr5y', 'cagr10y', 'beta', 'expense_ratio'];
      keys.forEach(k => {
        const el = document.getElementById(`etfSort-${k}`);
        if (el) {
          if (state.etfSortKey === k) {
            el.textContent = state.etfSortDir === 'asc' ? 'â–²' : 'â–¼';
            el.className = 'text-teal-600 font-bold';
          } else {
            el.textContent = '';
          }
        }
      });
    }

    // v4.3.1: Get ETF value for sorting
    function getETFSortValue(etf, key) {
      switch (key) {
        case 'ticker': return etf.ticker || '';
        case 'category': return etf.category || '';
        case 'market_cap': return etf.market_cap || etf.mc || 0;
        case 'r1m': return etf.returns?.['1m'] ?? -Infinity;
        case 'r3m': return etf.returns?.['3m'] ?? -Infinity;
        case 'r6m': return etf.returns?.['6m'] ?? -Infinity;
        case 'ytd': return etf.returns?.['ytd'] ?? -Infinity;
        case 'r1y': return etf.returns?.['1y'] ?? -Infinity;
        case 'r3y': return etf.returns?.['3y'] ?? -Infinity;
        case 'r5y': return etf.returns?.['5y'] ?? -Infinity;
        case 'r10y': return etf.returns?.['10y'] ?? -Infinity;
        case 'cagr3y': return etf.cagr?.['3y'] ?? -Infinity;
        case 'cagr5y': return etf.cagr?.['5y'] ?? -Infinity;
        case 'cagr10y': return etf.cagr?.['10y'] ?? -Infinity;
        case 'beta': return etf.beta ?? -Infinity;
        case 'expense_ratio': return etf.expense_ratio ?? -Infinity;
        default: return 0;
      }
    }

    function renderETFTable() {
      const tbody = document.getElementById('etfTableBody');
      if (!state.etfs || state.etfs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="17" class="text-center text-gray-400 py-8">ETF ë°ì´í„° ì—†ìŒ</td></tr>';
        return;
      }

      // v3: ëª¨ë“  í•„ë“œ + null-safe í—¬í¼
      const fmt = (v, decimals = 2) => v != null && !isNaN(v) ? formatNumber(v, decimals) : '-';
      const fmtPct = (v) => v != null && !isNaN(v) ? formatPctValue(v) : '-';
      const fmtPctClass = (v) => v != null && !isNaN(v) ? (v >= 0 ? 'positive' : 'negative') : '';

      // v4.3.1: Sort ETFs
      const sortedETFs = [...state.etfs].sort((a, b) => {
        const aVal = getETFSortValue(a, state.etfSortKey);
        const bVal = getETFSortValue(b, state.etfSortKey);
        const dir = state.etfSortDir === 'asc' ? 1 : -1;
        if (typeof aVal === 'string') {
          return dir * aVal.localeCompare(bVal);
        }
        return dir * (aVal - bVal);
      });

      // Update sort icons
      updateETFSortIcons();

      tbody.innerHTML = sortedETFs.map(etf => {
        // Returns (1m, 3m, 6m, ytd, 1y, 3y, 5y, 10y)
        const r1m = etf.returns?.['1m'];
        const r3m = etf.returns?.['3m'];
        const r6m = etf.returns?.['6m'];
        const rYtd = etf.returns?.['ytd'];
        const r1y = etf.returns?.['1y'];
        const r3y = etf.returns?.['3y'];
        const r5y = etf.returns?.['5y'];
        const r10y = etf.returns?.['10y'];

        // CAGR (3y, 5y, 10y)
        const cagr3y = etf.cagr?.['3y'];
        const cagr5y = etf.cagr?.['5y'];
        const cagr10y = etf.cagr?.['10y'];

        return `
        <tr>
          <td class="font-bold text-indigo-600">${etf.ticker || etf.name || '-'}</td>
          <td class="text-sm">${etf.name || etf.ticker || '-'}</td>
          <td><span class="badge badge-sector">${etf.category || '-'}</span></td>
          <td class="mono">${formatMarketCap(etf.market_cap || etf.mc)}</td>
          <td class="mono ${fmtPctClass(r1m)}">${fmtPct(r1m)}</td>
          <td class="mono ${fmtPctClass(r3m)}">${fmtPct(r3m)}</td>
          <td class="mono ${fmtPctClass(r6m)}">${fmtPct(r6m)}</td>
          <td class="mono ${fmtPctClass(rYtd)}">${fmtPct(rYtd)}</td>
          <td class="mono ${fmtPctClass(r1y)}">${fmtPct(r1y)}</td>
          <td class="mono ${fmtPctClass(r3y)}">${fmtPct(r3y)}</td>
          <td class="mono ${fmtPctClass(r5y)}">${fmtPct(r5y)}</td>
          <td class="mono ${fmtPctClass(r10y)}">${fmtPct(r10y)}</td>
          <td class="mono ${fmtPctClass(cagr3y)}">${fmtPct(cagr3y)}</td>
          <td class="mono ${fmtPctClass(cagr5y)}">${fmtPct(cagr5y)}</td>
          <td class="mono ${fmtPctClass(cagr10y)}">${fmtPct(cagr10y)}</td>
          <td class="mono">${fmt(etf.beta)}</td>
          <td class="mono">${fmtPct(etf.expense_ratio)}</td>
        </tr>
      `}).join('');
    }

    function formatPctValue(val) {
      if (val == null || isNaN(val)) return '-';
      return (val * 100).toFixed(1) + '%';
    }

    // ================== MACRO TABLE ==================
    function renderMacroTable() {
      const tbody = document.getElementById('macroTableBody');
      const search = (document.getElementById('macroSearch')?.value || '').toLowerCase();

      let filtered = state.economic;
      if (Array.isArray(filtered) && filtered.length > 0) {
        if (search) {
          filtered = filtered.filter(item => {
            const name = item.name || item.indicator || '';
            return name.toLowerCase().includes(search);
          });
        }
        filtered = filtered.slice(0, 100); // Limit display
      }

      if (!filtered || filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-400 py-8">ë§¤í¬ë¡œ ë°ì´í„° ì—†ìŒ</td></tr>';
        return;
      }

      tbody.innerHTML = filtered.map(item => `
        <tr>
          <td>${item.name || item.indicator || '-'}</td>
          <td class="mono">${formatNumber(item.value, 2)}</td>
          <td>${item.unit || '-'}</td>
          <td class="text-gray-500 text-sm">${item.date || '-'}</td>
        </tr>
      `).join('');
    }

    // ================== MACRO CHART (v3: ë ˆì´ë¸” í•œê¸€í™” + ì´ëª¨ì§€) ==================

    // v3: ì§€í‘œëª… í•œê¸€í™” + ì´ëª¨ì§€
    const INDICATOR_LABELS = {
      // HY Spreads
      hys_us: 'ğŸ‡ºğŸ‡¸ ë¯¸êµ­ HY ìŠ¤í”„ë ˆë“œ (1Y)',
      hys_em: 'ğŸŒ ì‹ í¥êµ­ HY ìŠ¤í”„ë ˆë“œ (1Y)',
      hys_eu: 'ğŸ‡ªğŸ‡º ìœ ëŸ½ HY ìŠ¤í”„ë ˆë“œ (1Y)',
      hyy_us: 'ğŸ‡ºğŸ‡¸ ë¯¸êµ­ HY ìŠ¤í”„ë ˆë“œ (YTD)',
      hyy_em: 'ğŸŒ ì‹ í¥êµ­ HY ìŠ¤í”„ë ˆë“œ (YTD)',
      hyy_eu: 'ğŸ‡ªğŸ‡º ìœ ëŸ½ HY ìŠ¤í”„ë ˆë“œ (YTD)',
      // Treasury Yields
      t30y: 'ğŸ‡ºğŸ‡¸ 30ë…„ êµ­ì±„ ê¸ˆë¦¬',
      t20y: 'ğŸ‡ºğŸ‡¸ 20ë…„ êµ­ì±„ ê¸ˆë¦¬',
      t10y: 'ğŸ‡ºğŸ‡¸ 10ë…„ êµ­ì±„ ê¸ˆë¦¬',
      t5y: 'ğŸ‡ºğŸ‡¸ 5ë…„ êµ­ì±„ ê¸ˆë¦¬',
      t2y: 'ğŸ‡ºğŸ‡¸ 2ë…„ êµ­ì±„ ê¸ˆë¦¬',
      t1y: 'ğŸ‡ºğŸ‡¸ 1ë…„ êµ­ì±„ ê¸ˆë¦¬',
      t6m: 'ğŸ‡ºğŸ‡¸ 6ê°œì›” êµ­ì±„ ê¸ˆë¦¬',
      t3m: 'ğŸ‡ºğŸ‡¸ 3ê°œì›” êµ­ì±„ ê¸ˆë¦¬',
      // Spreads
      t10y_2y_spread: 'ğŸ“‰ 10Y-2Y ìŠ¤í”„ë ˆë“œ (ì—­ì „ ì‹ í˜¸)',
      t10y_3m_spread: 'ğŸ“‰ 10Y-3M ìŠ¤í”„ë ˆë“œ',
      // Inflation
      bei_10y: 'ğŸ“ˆ 10ë…„ ê¸°ëŒ€ ì¸í”Œë ˆ',
      bei_5y: 'ğŸ“ˆ 5ë…„ ê¸°ëŒ€ ì¸í”Œë ˆ',
      bei_2y: 'ğŸ“ˆ 2ë…„ ê¸°ëŒ€ ì¸í”Œë ˆ',
      // TIPS
      tips_10y: 'ğŸ›¡ï¸ 10ë…„ TIPS ê¸ˆë¦¬',
      tips_5y: 'ğŸ›¡ï¸ 5ë…„ TIPS ê¸ˆë¦¬',
      // Other
      vix: 'ğŸ˜° VIX (ê³µí¬ ì§€ìˆ˜)',
      move: 'ğŸ“Š MOVE (ì±„ê¶Œ ë³€ë™ì„±)',
      dxy: 'ğŸ’µ ë‹¬ëŸ¬ ì¸ë±ìŠ¤',
      gold: 'ğŸ¥‡ ê¸ˆ ê°€ê²©',
      oil: 'ğŸ›¢ï¸ ìœ ê°€ (WTI)',
      copper: 'ğŸ”¶ êµ¬ë¦¬ ê°€ê²©'
    };

    function populateMacroSelector() {
      const select1 = document.getElementById('macroIndicatorSelect');
      const select2 = document.getElementById('macroIndicator2Select');
      if (!select1 || state.economicIndicators.length === 0) return;

      // v3.1: Populate both dropdowns for multi-indicator comparison
      select1.innerHTML = '<option value="">ì£¼ ì§€í‘œ...</option>';
      if (select2) select2.innerHTML = '<option value="">ë¹„êµ ì§€í‘œ (ì„ íƒ)</option>';

      state.economicIndicators.forEach(ind => {
        const opt1 = document.createElement('option');
        opt1.value = ind;
        // v3: Korean labels (fallback to English uppercase)
        opt1.textContent = INDICATOR_LABELS[ind] || ind.toUpperCase().replace(/_/g, ' ');
        select1.appendChild(opt1);

        // Copy to second selector
        if (select2) {
          const opt2 = opt1.cloneNode(true);
          select2.appendChild(opt2);
        }
      });
    }

    function renderMacroChart() {
      const indicator1 = document.getElementById('macroIndicatorSelect').value;
      const indicator2 = document.getElementById('macroIndicator2Select')?.value || '';
      state.macroIndicator = indicator1;

      // Hide secondary stats by default
      const summary2 = document.getElementById('macroSummary2');
      if (summary2) summary2.classList.add('hidden');

      if (!indicator1 || state.economicRecords.length === 0) {
        document.getElementById('macroEmptyState').style.display = 'flex';
        document.getElementById('macroSummary').classList.add('hidden');
        return;
      }

      document.getElementById('macroEmptyState').style.display = 'none';
      document.getElementById('macroSummary').classList.remove('hidden');

      const ctx = document.getElementById('macroChart').getContext('2d');

      // Extract time series data for indicator 1
      const labels = [];
      const values1 = [];
      state.economicRecords.forEach(record => {
        if (record.date && record[indicator1] != null) {
          labels.push(record.date);
          values1.push(record[indicator1]);
        }
      });

      // Reverse to show oldest first
      labels.reverse();
      values1.reverse();

      // v3: Korean labels
      const label1 = INDICATOR_LABELS[indicator1] || indicator1.toUpperCase().replace(/_/g, ' ');

      // Build datasets
      const datasets = [{
        label: label1,
        data: values1,
        borderColor: '#14b8a6',
        backgroundColor: 'rgba(20, 184, 166, 0.1)',
        fill: true,
        tension: 0.3,
        pointRadius: 0,
        yAxisID: 'y'
      }];

      // v3.1: Add second indicator for comparison (dual-axis)
      let values2 = [];
      let label2 = '';
      const hasComparison = indicator2 && indicator2 !== indicator1;

      if (hasComparison) {
        label2 = INDICATOR_LABELS[indicator2] || indicator2.toUpperCase().replace(/_/g, ' ');

        // Extract values2 aligned with labels
        state.economicRecords.forEach(record => {
          if (record.date && record[indicator1] != null) {
            values2.push(record[indicator2] != null ? record[indicator2] : null);
          }
        });
        values2.reverse();

        datasets.push({
          label: label2,
          data: values2,
          borderColor: '#8b5cf6',
          backgroundColor: 'rgba(139, 92, 246, 0.05)',
          fill: false,
          tension: 0.3,
          pointRadius: 0,
          borderDash: [5, 5],
          yAxisID: 'y1'
        });
      }

      if (charts.macro) charts.macro.destroy();

      // Build scales
      const scales = {
        x: { ticks: { maxTicksLimit: 12 } },
        y: {
          type: 'linear',
          position: 'left',
          title: { display: hasComparison, text: label1.replace(/[ğŸ‡ºğŸ‡¸ğŸŒğŸ‡ªğŸ‡ºğŸ“‰ğŸ“ˆğŸ›¡ï¸ğŸ˜°ğŸ’µğŸ¥‡ğŸ›¢ï¸ğŸ”¶]/g, '').trim(), color: '#14b8a6' },
          ticks: { color: '#14b8a6' }
        }
      };

      if (hasComparison) {
        scales.y1 = {
          type: 'linear',
          position: 'right',
          title: { display: true, text: label2.replace(/[ğŸ‡ºğŸ‡¸ğŸŒğŸ‡ªğŸ‡ºğŸ“‰ğŸ“ˆğŸ›¡ï¸ğŸ˜°ğŸ’µğŸ¥‡ğŸ›¢ï¸ğŸ”¶]/g, '').trim(), color: '#8b5cf6' },
          ticks: { color: '#8b5cf6' },
          grid: { drawOnChartArea: false }
        };
      }

      charts.macro = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { display: true, position: 'top' },
            tooltip: {
              callbacks: {
                label: ctx => `${ctx.dataset.label}: ${formatNumber(ctx.raw, 4)}`
              }
            }
          },
          scales
        }
      });

      // Update primary summary
      const latest1 = values1[values1.length - 1] || 0;
      const avg1 = values1.reduce((a, b) => a + b, 0) / values1.length;
      const min1 = Math.min(...values1);
      const max1 = Math.max(...values1);

      document.getElementById('macroLatest').textContent = formatNumber(latest1, 4);
      document.getElementById('macroAvg').textContent = formatNumber(avg1, 4);
      document.getElementById('macroMin').textContent = formatNumber(min1, 4);
      document.getElementById('macroMax').textContent = formatNumber(max1, 4);

      // Update label if exists
      const labelEl1 = document.getElementById('macroLabel1');
      if (labelEl1) labelEl1.textContent = '';

      // v3.1: Update secondary summary if comparing
      if (hasComparison && summary2) {
        summary2.classList.remove('hidden');
        const validValues2 = values2.filter(v => v != null);
        const latest2 = validValues2[validValues2.length - 1] || 0;
        const avg2 = validValues2.length ? validValues2.reduce((a, b) => a + b, 0) / validValues2.length : 0;
        const min2 = validValues2.length ? Math.min(...validValues2) : 0;
        const max2 = validValues2.length ? Math.max(...validValues2) : 0;

        document.getElementById('macroLatest2').textContent = formatNumber(latest2, 4);
        document.getElementById('macroAvg2').textContent = formatNumber(avg2, 4);
        document.getElementById('macroMin2').textContent = formatNumber(min2, 4);
        document.getElementById('macroMax2').textContent = formatNumber(max2, 4);

        const labelEl2 = document.getElementById('macroLabel2');
        if (labelEl2) labelEl2.textContent = '';
      }
    }

    // ================== EXPORT ==================
    function exportCSV() {
      const filtered = getFilteredStocks();
      let csv = 'Ticker,Name,Sector,Country,Exchange,MarketCap,PE,PB,DividendYield,12MReturn\n';
      filtered.forEach(s => {
        csv += `"${s.ticker}","${s.name}","${s.sector}","${s.country}","${s.exchange}",${s.mc},${s.pe},${s.pb},${s.dy},${s.r12}\n`;
      });

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `global-scouter-${new Date().toISOString().slice(0, 10)}.csv`;
      a.click();
    }

    // ================== DCF CALCULATOR (#192) ==================

    // Helper: Calculate CAGR
    function calculateCAGR(startValue, endValue, years) {
      if (!startValue || startValue <= 0 || !endValue || endValue <= 0 || years <= 0) return 0;
      return (Math.pow(endValue / startValue, 1 / years) - 1) * 100;
    }

    // Helper: Get WACC from Damodaran
    function getSectorWACC(sector) {
      const industry = SECTOR_MAPPING[sector] || 'Diversified';
      const data = state.damodaranIndustries[industry];
      return data?.eva?.wacc || 0.10;
    }

    // Helper: Get Terminal Growth from Damodaran
    function getSectorTerminalGrowth(sector) {
      const industry = SECTOR_MAPPING[sector] || 'Diversified';
      const data = state.damodaranIndustries[industry];
      const fundamentalGrowth = data?.growth?.fundamental_growth || 0.025;
      // Terminal growth capped at 3% (conservative)
      return Math.min(Math.max(fundamentalGrowth, 0.01), 0.03);
    }

    // DCF Calculation
    function calculateDCF(fcfArray, growthRate, wacc, terminalGrowth, projectionYears = 5) {
      if (!fcfArray || fcfArray.length === 0) return null;
      const currentFCF = fcfArray[fcfArray.length - 1];
      if (!currentFCF || currentFCF <= 0) return null;
      if (wacc <= terminalGrowth) return null;

      let pvFCF = 0;
      for (let i = 1; i <= projectionYears; i++) {
        const projectedFCF = currentFCF * Math.pow(1 + growthRate, i);
        pvFCF += projectedFCF / Math.pow(1 + wacc, i);
      }

      const terminalFCF = currentFCF * Math.pow(1 + growthRate, projectionYears) * (1 + terminalGrowth);
      const terminalValue = terminalFCF / (wacc - terminalGrowth);
      const pvTerminal = terminalValue / Math.pow(1 + wacc, projectionYears);

      return pvFCF + pvTerminal;
    }

    let currentDCFData = null;

    async function renderDCFTab() {
      const ticker = document.getElementById('dcfSelector')?.value;
      if (!ticker) {
        document.getElementById('dcfEmptyState').style.display = 'flex';
        document.getElementById('dcfResults').classList.add('hidden');
        return;
      }

      const data = await loadDetailData(ticker);
      if (!data) return;

      const stock = state.stocksList.find(s => s.ticker === ticker);
      if (!stock) return;

      currentDCFData = { data, stock, ticker };

      // FCF data
      const fcf = data.cash_flow?.fcf || [];
      const years = data.years || ['FY-4', 'FY-3', 'FY-2', 'FY-1', 'FY0'];

      // Check for positive FCF
      const lastFCF = fcf[fcf.length - 1];
      if (!lastFCF || lastFCF <= 0) {
        document.getElementById('dcfEmptyState').innerHTML = `
          <div class="text-center text-amber-500">
            <i class="fas fa-exclamation-triangle text-5xl mb-3"></i>
            <p class="text-lg font-medium">N/A - FCF ìŒìˆ˜ ë˜ëŠ” ì—†ìŒ</p>
            <p class="text-sm mt-1">${ticker}ì˜ ìµœê·¼ FCF: ${formatB(lastFCF)}</p>
          </div>`;
        document.getElementById('dcfEmptyState').style.display = 'flex';
        document.getElementById('dcfResults').classList.add('hidden');
        return;
      }

      document.getElementById('dcfEmptyState').style.display = 'none';
      document.getElementById('dcfResults').classList.remove('hidden');

      // Display FCF data
      document.getElementById('dcfFCFData').innerHTML = fcf.map((v, i) => `
        <div class="bg-white rounded p-2 border border-emerald-100">
          <div class="text-xs text-gray-400">${years[i] || 'FY'}</div>
          <div class="font-bold text-emerald-700 mono text-sm">${formatB(v)}</div>
        </div>
      `).join('');

      // FCF CAGR
      const fcfCAGR = calculateCAGR(fcf[0], fcf[fcf.length - 1], fcf.length - 1);
      document.getElementById('dcfFCFCAGR').textContent = `${formatNumber(fcfCAGR, 1)}%`;

      // Set initial params from Damodaran
      const sector = stock.sector;
      const damodaranWACC = getSectorWACC(sector) * 100;
      const damodaranTerminal = getSectorTerminalGrowth(sector) * 100;
      const damodaranIndustry = SECTOR_MAPPING[sector] || 'Diversified';

      document.getElementById('dcfWACCSlider').value = damodaranWACC.toFixed(2);
      document.getElementById('dcfWACCValue').textContent = `${damodaranWACC.toFixed(2)}%`;
      document.getElementById('dcfWACCSource').textContent = `(${damodaranIndustry})`;

      document.getElementById('dcfTerminalSlider').value = damodaranTerminal.toFixed(2);
      document.getElementById('dcfTerminalValue').textContent = `${damodaranTerminal.toFixed(2)}%`;

      // Set growth rate from FCF CAGR
      const initialGrowth = Math.min(Math.max(fcfCAGR, 0), 30);
      document.getElementById('dcfGrowthSlider').value = initialGrowth.toFixed(1);
      document.getElementById('dcfGrowthValue').textContent = `${initialGrowth.toFixed(1)}%`;

      document.getElementById('dcfCurrentPrice').textContent = `$${formatNumber(stock.price, 2)}`;

      // #195 + v4.3: Update parameter hints with growth_consensus
      updateDCFHints(ticker, getSectorWACC(sector), fcfCAGR, data.growth_consensus);

      updateDCFCalc();
    }

    function updateDCFCalc() {
      if (!currentDCFData) return;

      const { data, stock } = currentDCFData;
      const fcf = data.cash_flow?.fcf || [];

      const growthRate = parseFloat(document.getElementById('dcfGrowthSlider').value) / 100;
      const wacc = parseFloat(document.getElementById('dcfWACCSlider').value) / 100;
      const terminalGrowth = parseFloat(document.getElementById('dcfTerminalSlider').value) / 100;

      document.getElementById('dcfGrowthValue').textContent = `${(growthRate * 100).toFixed(1)}%`;
      document.getElementById('dcfWACCValue').textContent = `${(wacc * 100).toFixed(2)}%`;
      document.getElementById('dcfTerminalValue').textContent = `${(terminalGrowth * 100).toFixed(2)}%`;

      // Get shares outstanding (approximate from market cap and price)
      const sharesOutstanding = stock.price > 0 ? (stock.mc * 1000000) / stock.price : 0;

      const enterpriseValue = calculateDCF(fcf, growthRate, wacc, terminalGrowth);
      if (!enterpriseValue || sharesOutstanding <= 0) {
        document.getElementById('dcfFairValue').textContent = 'N/A';
        document.getElementById('dcfGap').textContent = '-';
        document.getElementById('dcfVerdict').textContent = '-';
        return;
      }

      const fairValue = enterpriseValue / sharesOutstanding * 1000000;
      const currentPrice = stock.price;
      const gap = ((fairValue - currentPrice) / currentPrice) * 100;

      document.getElementById('dcfFairValue').textContent = `$${formatNumber(fairValue, 2)}`;

      const gapEl = document.getElementById('dcfGap');
      gapEl.textContent = `${gap >= 0 ? '+' : ''}${formatNumber(gap, 1)}%`;
      gapEl.className = gap >= 0 ? 'text-xl font-bold mono positive' : 'text-xl font-bold mono negative';

      const verdictEl = document.getElementById('dcfVerdict');
      if (gap > 20) {
        verdictEl.textContent = 'ğŸŸ¢ ì €í‰ê°€';
        verdictEl.className = 'text-xl font-bold text-green-600';
      } else if (gap < -20) {
        verdictEl.textContent = 'ğŸ”´ ê³ í‰ê°€';
        verdictEl.className = 'text-xl font-bold text-red-600';
      } else {
        verdictEl.textContent = 'ğŸŸ¡ ì ì •';
        verdictEl.className = 'text-xl font-bold text-amber-600';
      }

      renderSensitivityTable(fcf, growthRate, wacc, terminalGrowth, sharesOutstanding, currentPrice);
    }

    function renderSensitivityTable(fcf, currentGrowth, currentWACC, terminalGrowth, shares, currentPrice) {
      const growthRates = [-0.02, -0.01, 0, 0.01, 0.02].map(d => currentGrowth + d);
      const waccRates = [-0.01, -0.005, 0, 0.005, 0.01].map(d => currentWACC + d);

      const headRow = '<tr><th class="bg-gray-100">Growth \\ WACC</th>' +
        waccRates.map(w => `<th class="bg-gray-100">${(w * 100).toFixed(1)}%</th>`).join('') + '</tr>';
      document.getElementById('dcfSensitivityHead').innerHTML = headRow;

      let bodyHTML = '';
      growthRates.forEach(g => {
        bodyHTML += `<tr><td class="font-bold bg-gray-50">${(g * 100).toFixed(1)}%</td>`;
        waccRates.forEach(w => {
          const ev = calculateDCF(fcf, g, w, terminalGrowth);
          const fairVal = ev && shares > 0 ? (ev / shares * 1000000) : 0;
          const gap = currentPrice > 0 ? ((fairVal - currentPrice) / currentPrice) * 100 : 0;

          const isCurrentCell = Math.abs(g - currentGrowth) < 0.001 && Math.abs(w - currentWACC) < 0.001;
          const bgColor = isCurrentCell ? 'bg-purple-200' : (gap > 20 ? 'bg-green-100' : (gap < -20 ? 'bg-red-100' : 'bg-amber-50'));

          bodyHTML += `<td class="${bgColor} mono text-center">$${formatNumber(fairVal, 0)}</td>`;
        });
        bodyHTML += '</tr>';
      });
      document.getElementById('dcfSensitivityBody').innerHTML = bodyHTML;
    }

    // ================== PARAMETER GUIDE FUNCTIONS (#195) ==================

    // Toggle Guide Panels
    function toggleDCFGuide() {
      const content = document.getElementById('dcfGuideContent');
      const icon = document.getElementById('dcfGuideIcon');
      content.classList.toggle('hidden');
      icon.classList.toggle('rotate-180');
    }

    function toggleDDMGuide() {
      const content = document.getElementById('ddmGuideContent');
      const icon = document.getElementById('ddmGuideIcon');
      content.classList.toggle('hidden');
      icon.classList.toggle('rotate-180');
    }

    // Dynamic DCF Hints (call in renderDCFTab)
    // v4.3: growth_consensus íŒŒë¼ë¯¸í„° ì¶”ê°€
    function updateDCFHints(ticker, waccData, fcfCAGR, growthConsensus) {
      const stock = state.stocksList.find(s => s.ticker === ticker);
      const sector = stock?.sector || '-';
      const damodaranIndustry = SECTOR_MAPPING[sector] || 'Diversified';

      const growthHint = document.getElementById('dcfGrowthSectorRef');
      if (growthHint) {
        let hintText = '';
        if (fcfCAGR !== null && !isNaN(fcfCAGR)) {
          hintText = `${sector}: ê³¼ê±° FCF CAGR <strong>${fcfCAGR.toFixed(1)}%</strong>`;
        } else {
          hintText = `${sector}: FCF CAGR ë°ì´í„° ì—†ìŒ`;
        }
        // v4.3: growth_consensus ì¶”ê°€ í‘œì‹œ
        if (growthConsensus?.earnings_3y) {
          hintText += ` | ì»¨ì„¼ì„œìŠ¤ ì´ìµì„±ì¥(3Y): <strong>${growthConsensus.earnings_3y.toFixed(1)}%</strong>`;
        }
        growthHint.innerHTML = hintText;
      }

      const waccHint = document.getElementById('dcfWACCSectorRef');
      if (waccHint && waccData) {
        waccHint.innerHTML = `Damodaran ${damodaranIndustry}: <strong>${(waccData * 100).toFixed(2)}%</strong>`;
      }

      // v4.3: Terminal Growth íŒíŠ¸ì— growth_consensus ê¸°ë°˜ ê¶Œì¥ê°’ ì¶”ê°€
      // í•™ê³„ í‘œì¤€: Terminal GrowthëŠ” ì¥ê¸° GDP ì„±ì¥ë¥ (2-3%)ì„ ì´ˆê³¼í•˜ê¸° ì–´ë ¤ì›€
      const terminalHint = document.getElementById('dcfTerminalSectorRef');
      if (terminalHint && growthConsensus?.earnings_7y) {
        const earnings7y = growthConsensus.earnings_7y;
        let suggested;
        if (earnings7y >= 20) suggested = '3-4% (ê³ ì„±ì¥ â†’ ì¥ê¸° ìˆ˜ë ´)';
        else if (earnings7y >= 10) suggested = '2.5-3.5% (ì„±ì¥ì£¼)';
        else if (earnings7y >= 5) suggested = '2-3% (ì•ˆì •ì£¼)';
        else suggested = '1.5-2.5% (ê°€ì¹˜/ë°°ë‹¹ì£¼)';
        terminalHint.innerHTML = `7Y ì´ìµì„±ì¥ ${earnings7y.toFixed(1)}% â†’ Terminal ê¶Œì¥: <strong>${suggested}</strong>`;
      }
    }

    // Dynamic DDM Hints (call in renderDDMTab)
    // v4.3: growth_consensus íŒŒë¼ë¯¸í„° ì¶”ê°€
    function updateDDMHints(ticker, dpsCAGR, growthConsensus) {
      const stock = state.stocksList.find(s => s.ticker === ticker);

      const requiredHint = document.getElementById('ddmRequiredSectorRef');
      if (requiredHint) {
        const beta = stock?.beta || 1;
        const estimatedR = 4.5 + beta * 5.5; // Rf + Î² Ã— MRP (simplified CAPM)
        requiredHint.innerHTML = `CAPM ì¶”ì •: Î²=${beta.toFixed(2)} â†’ <strong>${estimatedR.toFixed(1)}%</strong>`;
      }

      const growthHint = document.getElementById('ddmGrowthSectorRef');
      if (growthHint) {
        let hintText = '';
        if (dpsCAGR !== null && !isNaN(dpsCAGR)) {
          hintText = `ê³¼ê±° DPS CAGR: <strong>${dpsCAGR.toFixed(1)}%</strong>`;
        } else {
          hintText = 'ê³¼ê±° DPS CAGR ë°ì´í„° ì—†ìŒ';
        }
        // v4.3: growth_consensus ì¶”ê°€ í‘œì‹œ
        if (growthConsensus?.earnings_3y) {
          hintText += ` | ì´ìµì„±ì¥ ì»¨ì„¼ì„œìŠ¤(3Y): <strong>${growthConsensus.earnings_3y.toFixed(1)}%</strong>`;
          // ë°°ë‹¹ì„±ì¥ì€ ì´ìµì„±ì¥ì˜ ì¼ë¶€ë¥¼ ë”°ë¼ê°€ë¯€ë¡œ ê°€ì´ë“œ ì œì‹œ
          const suggestedDivGrowth = Math.min(growthConsensus.earnings_3y * 0.5, 8);
          hintText += ` â†’ ë°°ë‹¹ì„±ì¥ ${suggestedDivGrowth.toFixed(1)}% ê¶Œì¥`;
        }
        growthHint.innerHTML = hintText;
      }
    }

    // ================== DDM CALCULATOR (#193) ==================

    let currentDDMData = null;

    async function renderDDMTab() {
      const ticker = document.getElementById('ddmSelector')?.value;
      if (!ticker) {
        document.getElementById('ddmEmptyState').style.display = 'flex';
        document.getElementById('ddmResults').classList.add('hidden');
        return;
      }

      const data = await loadDetailData(ticker);
      if (!data) return;

      const stock = state.stocksList.find(s => s.ticker === ticker);
      if (!stock) return;

      currentDDMData = { data, stock, ticker };

      const dps = data.dividend?.dps || [];
      const years = data.years || ['FY-4', 'FY-3', 'FY-2', 'FY-1', 'FY0'];

      // Check for dividend
      const lastDPS = dps[dps.length - 1];
      if (!lastDPS || lastDPS <= 0) {
        document.getElementById('ddmEmptyState').style.display = 'none';
        document.getElementById('ddmResults').classList.remove('hidden');
        document.getElementById('ddmNoDividend').classList.remove('hidden');
        document.getElementById('ddmDPSData').parentElement.classList.add('hidden');
        document.getElementById('ddmFairValue').textContent = 'N/A';
        document.getElementById('ddmCurrentPrice').textContent = `$${formatNumber(stock.price, 2)}`;
        document.getElementById('ddmGap').textContent = '-';
        document.getElementById('ddmVerdict').textContent = '-';
        return;
      }

      document.getElementById('ddmEmptyState').style.display = 'none';
      document.getElementById('ddmResults').classList.remove('hidden');
      document.getElementById('ddmNoDividend').classList.add('hidden');
      document.getElementById('ddmDPSData').parentElement.classList.remove('hidden');

      // #196: DDM Yield Warning
      const dividendYield = (lastDPS / stock.price) * 100;
      const yieldWarningEl = document.getElementById('ddmYieldWarning');

      if (dividendYield < 1) {
        yieldWarningEl.className = 'ddm-yield-warning error';
        yieldWarningEl.innerHTML = `
          <i class="fas fa-exclamation-circle ddm-yield-warning-icon"></i>
          <div>
            <div class="font-medium text-red-800">DDM ë¶€ì í•© - ì„±ì¥ì£¼ì…ë‹ˆë‹¤</div>
            <div class="text-sm text-red-700 mt-1">ë°°ë‹¹ìˆ˜ìµë¥  ${dividendYield.toFixed(2)}%ëŠ” ë„ˆë¬´ ë‚®ìŠµë‹ˆë‹¤. DDMì€ ë°°ë‹¹ì£¼ ì „ìš© ëª¨ë¸ì…ë‹ˆë‹¤.</div>
            <div class="text-sm text-red-600 mt-1"><i class="fas fa-arrow-right mr-1"></i>DCF íƒ­ì—ì„œ í˜„ê¸ˆíë¦„ ê¸°ë°˜ ë°¸ë¥˜ì—ì´ì…˜ì„ ì‚¬ìš©í•˜ì„¸ìš”.</div>
          </div>
        `;
        yieldWarningEl.classList.remove('hidden');
      } else if (dividendYield < 2) {
        yieldWarningEl.className = 'ddm-yield-warning warning';
        yieldWarningEl.innerHTML = `
          <i class="fas fa-exclamation-triangle ddm-yield-warning-icon"></i>
          <div>
            <div class="font-medium text-amber-800">ë°°ë‹¹ìˆ˜ìµë¥  ë‚®ìŒ - DDM ì‹ ë¢°ë„ ë‚®ìŒ</div>
            <div class="text-sm text-amber-700 mt-1">ë°°ë‹¹ìˆ˜ìµë¥  ${dividendYield.toFixed(2)}%ëŠ” DDMì— ì í•©í•œ ìˆ˜ì¤€(2%+)ë³´ë‹¤ ë‚®ìŠµë‹ˆë‹¤.</div>
          </div>
        `;
        yieldWarningEl.classList.remove('hidden');
      } else {
        yieldWarningEl.classList.add('hidden');
      }

      // Display DPS data
      document.getElementById('ddmDPSData').innerHTML = dps.map((v, i) => `
        <div class="bg-white rounded p-2 border border-amber-100">
          <div class="text-xs text-gray-400">${years[i] || 'FY'}</div>
          <div class="font-bold text-amber-700 mono text-sm">$${formatNumber(v, 2)}</div>
        </div>
      `).join('');

      // DPS CAGR
      const dpsCAGR = calculateCAGR(dps[0], dps[dps.length - 1], dps.length - 1);
      document.getElementById('ddmDPSCAGR').textContent = `${formatNumber(dpsCAGR, 1)}%`;

      // Set initial growth rate from DPS CAGR
      const initialGrowth = Math.min(Math.max(dpsCAGR, 0), 15);
      document.getElementById('ddmGrowthSlider').value = initialGrowth.toFixed(1);
      document.getElementById('ddmGrowthValue').textContent = `${initialGrowth.toFixed(1)}%`;

      document.getElementById('ddmCurrentPrice').textContent = `$${formatNumber(stock.price, 2)}`;

      // #195 + v4.3: Update parameter hints with growth_consensus
      updateDDMHints(ticker, dpsCAGR, data.growth_consensus);

      updateDDMCalc();
    }

    function updateDDMCalc() {
      if (!currentDDMData) return;

      const { data, stock } = currentDDMData;
      const dps = data.dividend?.dps || [];

      const requiredReturn = parseFloat(document.getElementById('ddmRequiredSlider').value) / 100;
      const dividendGrowth = parseFloat(document.getElementById('ddmGrowthSlider').value) / 100;

      document.getElementById('ddmRequiredValue').textContent = `${(requiredReturn * 100).toFixed(1)}%`;
      document.getElementById('ddmGrowthValue').textContent = `${(dividendGrowth * 100).toFixed(1)}%`;

      // Validate r > g
      const warningEl = document.getElementById('ddmWarning');
      if (requiredReturn <= dividendGrowth) {
        warningEl.classList.remove('hidden');
        document.getElementById('ddmFairValue').textContent = 'N/A';
        document.getElementById('ddmGap').textContent = '-';
        document.getElementById('ddmVerdict').textContent = '-';
        return;
      }
      warningEl.classList.add('hidden');

      const lastDPS = dps[dps.length - 1];
      if (!lastDPS || lastDPS <= 0) return;

      // Gordon Growth Model: P = D1 / (r - g) = D0 * (1 + g) / (r - g)
      const nextDPS = lastDPS * (1 + dividendGrowth);
      const fairValue = nextDPS / (requiredReturn - dividendGrowth);

      const currentPrice = stock.price;
      const gap = ((fairValue - currentPrice) / currentPrice) * 100;

      document.getElementById('ddmFairValue').textContent = `$${formatNumber(fairValue, 2)}`;

      const gapEl = document.getElementById('ddmGap');
      gapEl.textContent = `${gap >= 0 ? '+' : ''}${formatNumber(gap, 1)}%`;
      gapEl.className = gap >= 0 ? 'text-xl font-bold mono positive' : 'text-xl font-bold mono negative';

      const verdictEl = document.getElementById('ddmVerdict');
      if (gap > 20) {
        verdictEl.textContent = 'ğŸŸ¢ ì €í‰ê°€';
        verdictEl.className = 'text-xl font-bold text-green-600';
      } else if (gap < -20) {
        verdictEl.textContent = 'ğŸ”´ ê³ í‰ê°€';
        verdictEl.className = 'text-xl font-bold text-red-600';
      } else {
        verdictEl.textContent = 'ğŸŸ¡ ì ì •';
        verdictEl.className = 'text-xl font-bold text-amber-600';
      }
    }

    // ================== PEER COMPARISON (#191) ==================

    let currentPeerData = null;

    function getPeersBySector(sector) {
      return state.stocksList.filter(s => s.sector === sector);
    }

    function calculatePercentile(value, values, ascending = true) {
      const sorted = [...values].sort((a, b) => a - b);
      const rank = sorted.findIndex(v => v >= value);
      const percentile = ((rank + 1) / sorted.length) * 100;
      return ascending ? percentile : (100 - percentile);
    }

    async function renderPeerTab() {
      // v4: Use global selected ticker or peerSelector
      const ticker = state.selectedTicker || document.getElementById('peerSelector')?.value;
      if (!ticker) {
        document.getElementById('peerEmptyState').style.display = 'flex';
        document.getElementById('peerResults').classList.add('hidden');
        return;
      }

      const stock = state.stocksList.find(s => s.ticker === ticker);
      if (!stock) return;

      const data = await loadDetailData(ticker);
      currentPeerData = { stock, data, ticker };

      const sector = stock.sector;

      // v4: Get peers based on mode
      let peers;
      if (state.peerMode === 'auto') {
        peers = getPeersBySector(sector);
      } else {
        // Manual mode: base stock + manual peers
        const allTickers = [ticker, ...state.manualPeers];
        peers = allTickers
          .map(t => state.stocksList.find(s => s.ticker === t))
          .filter(Boolean);
      }

      // v4: Different minimum requirements for Auto vs Manual mode
      const minPeers = state.peerMode === 'auto' ? 3 : 2;
      if (peers.length < minPeers) {
        const message = state.peerMode === 'auto'
          ? `${sector} ì„¹í„°ì— ${peers.length}ê°œ ì¢…ëª©ë§Œ ìˆìŠµë‹ˆë‹¤ (ìµœì†Œ 3ê°œ í•„ìš”)`
          : `ë¹„êµ ì¢…ëª©ì„ ì¶”ê°€í•˜ì„¸ìš” (í˜„ì¬ ${peers.length}ê°œ, ìµœì†Œ 2ê°œ í•„ìš”)`;
        document.getElementById('peerEmptyState').innerHTML = `
          <div class="text-center text-amber-500">
            <i class="fas fa-exclamation-triangle text-5xl mb-3"></i>
            <p class="text-lg font-medium">${state.peerMode === 'auto' ? 'Peer ë¶€ì¡±' : 'ë¹„êµ ì¢…ëª© ì¶”ê°€ í•„ìš”'}</p>
            <p class="text-sm mt-1">${message}</p>
          </div>`;
        document.getElementById('peerEmptyState').style.display = 'flex';
        document.getElementById('peerResults').classList.add('hidden');
        return;
      }

      document.getElementById('peerEmptyState').style.display = 'none';
      document.getElementById('peerResults').classList.remove('hidden');

      // Sector info
      const damodaranIndustry = SECTOR_MAPPING[sector] || 'Diversified';
      document.getElementById('peerSectorName').textContent = sector;
      document.getElementById('peerDamodaranName').textContent = `(${damodaranIndustry})`;
      document.getElementById('peerCount').textContent = peers.length;

      // Calculate percentiles
      const peValues = peers.map(p => p.pe).filter(v => v > 0);
      const pbValues = peers.map(p => p.pb).filter(v => v > 0);
      const mcValues = peers.map(p => p.mc).filter(v => v > 0);

      // Load ROE for all peers
      const roeValues = [];
      for (const peer of peers.slice(0, 50)) { // Limit for performance
        const peerData = state.detailCache[peer.ticker];
        if (peerData?.profitability?.roe) {
          const lastROE = peerData.profitability.roe[4];
          if (lastROE && lastROE > 0) roeValues.push(lastROE);
        }
      }
      const stockROE = data?.profitability?.roe?.[4] || 0;

      // P/E Percentile (lower is better for P/E)
      const pePct = stock.pe > 0 ? calculatePercentile(stock.pe, peValues, true) : 0;
      document.getElementById('peerPEBar').style.width = `${pePct}%`;
      document.getElementById('peerPEMarker').style.left = `${pePct}%`;
      document.getElementById('peerPEPct').textContent = formatNumber(pePct, 0);
      document.getElementById('peerPETop').textContent = formatNumber(100 - pePct, 0);

      // P/B Percentile
      const pbPct = stock.pb > 0 ? calculatePercentile(stock.pb, pbValues, true) : 0;
      document.getElementById('peerPBBar').style.width = `${pbPct}%`;
      document.getElementById('peerPBMarker').style.left = `${pbPct}%`;
      document.getElementById('peerPBPct').textContent = formatNumber(pbPct, 0);
      document.getElementById('peerPBTop').textContent = formatNumber(100 - pbPct, 0);

      // ROE Percentile (higher is better)
      const roePct = stockROE > 0 && roeValues.length > 0 ? calculatePercentile(stockROE, roeValues, true) : 0;
      document.getElementById('peerROEBar').style.width = `${roePct}%`;
      document.getElementById('peerROEMarker').style.left = `${roePct}%`;
      document.getElementById('peerROEPct').textContent = formatNumber(roePct, 0);
      document.getElementById('peerROETop').textContent = formatNumber(100 - roePct, 0);

      // Market Cap Percentile
      const mcPct = stock.mc > 0 ? calculatePercentile(stock.mc, mcValues, true) : 0;
      document.getElementById('peerMCBar').style.width = `${mcPct}%`;
      document.getElementById('peerMCMarker').style.left = `${mcPct}%`;
      document.getElementById('peerMCPct').textContent = formatNumber(mcPct, 0);
      document.getElementById('peerMCTop').textContent = formatNumber(100 - mcPct, 0);

      // Peer table (Top 15 by market cap)
      const topPeers = [...peers].sort((a, b) => b.mc - a.mc).slice(0, 15);
      document.getElementById('peerTableBody').innerHTML = topPeers.map(p => {
        const isSelected = p.ticker === ticker;
        const r12Value = p.r12 || 0;
        const r12Class = r12Value >= 0 ? 'text-green-600' : 'text-red-600';
        return `
          <tr class="${isSelected ? 'bg-teal-100 font-bold' : ''}">
            <td class="mono">${p.ticker}</td>
            <td>${p.name}</td>
            <td class="mono text-right">${formatNumber(p.pe, 1)}</td>
            <td class="mono text-right">${formatNumber(p.pb, 2)}</td>
            <td class="mono text-right">${formatNumber(p.dy, 2)}%</td>
            <td class="mono text-right ${r12Class}">${formatNumber(r12Value, 1)}%</td>
            <td class="mono text-right">${formatMarketCap(p.mc)}</td>
          </tr>
        `;
      }).join('');

      renderPeerChart();

      // v4: Render overlay comparison chart
      renderOverlayChart();
    }

    function setPeerChartType(type) {
      state.peerChartType = type;
      document.querySelectorAll('#section-peer [data-chart]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.chart === type);
      });
      renderPeerChart();
    }

    function setPeerMetric(metric) {
      state.peerMetric = metric;
      document.querySelectorAll('#section-peer [data-metric]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.metric === metric);
      });
      renderPeerChart();
    }

    function renderPeerChart() {
      if (!currentPeerData) return;

      const { stock, ticker } = currentPeerData;
      const sector = stock.sector;

      // v4: Get peers based on mode
      let peers;
      if (state.peerMode === 'auto') {
        peers = getPeersBySector(sector);
      } else {
        const allTickers = [ticker, ...state.manualPeers];
        peers = allTickers
          .map(t => state.stocksList.find(s => s.ticker === t))
          .filter(Boolean);
      }

      const ctx = document.getElementById('peerChart').getContext('2d');
      if (charts.peer) charts.peer.destroy();

      const metric = state.peerMetric;
      const metricLabels = { pe: 'P/E', pb: 'P/B', roe: 'ROE', mc: 'ì‹œì´' };
      const metricKey = metric === 'roe' ? null : metric;

      // Get metric values
      let peerData = [];
      if (metric === 'roe') {
        // Use cached ROE data
        peers.forEach(p => {
          const cached = state.detailCache[p.ticker];
          const roe = cached?.profitability?.roe?.[4];
          if (roe != null) {
            peerData.push({ ticker: p.ticker, value: roe, isSelected: p.ticker === stock.ticker });
          }
        });
      } else {
        peerData = peers
          .filter(p => p[metric] != null && p[metric] > 0)
          .map(p => ({ ticker: p.ticker, value: p[metric], isSelected: p.ticker === stock.ticker }));
      }

      if (state.peerChartType === 'bar') {
        // Bar chart: Top 15 + selected stock
        const sorted = [...peerData].sort((a, b) => b.value - a.value).slice(0, 15);
        if (!sorted.find(p => p.isSelected)) {
          const selectedData = peerData.find(p => p.isSelected);
          if (selectedData) sorted.push(selectedData);
        }

        charts.peer = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: sorted.map(p => p.ticker),
            datasets: [{
              label: metricLabels[metric],
              data: sorted.map(p => p.value),
              backgroundColor: sorted.map(p => p.isSelected ? '#14b8a6' : 'rgba(20, 184, 166, 0.4)'),
              borderColor: sorted.map(p => p.isSelected ? '#0d9488' : 'rgba(20, 184, 166, 0.6)'),
              borderWidth: sorted.map(p => p.isSelected ? 3 : 1)
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              y: {
                ticks: {
                  callback: v => metric === 'mc' ? formatMarketCap(v) : formatNumber(v, 1)
                }
              }
            }
          }
        });
      } else {
        // Box plot approximation
        const values = peerData.map(p => p.value).sort((a, b) => a - b);
        const min = values[0];
        const max = values[values.length - 1];
        const q1 = values[Math.floor(values.length * 0.25)];
        const q2 = values[Math.floor(values.length * 0.5)];
        const q3 = values[Math.floor(values.length * 0.75)];
        const selectedValue = peerData.find(p => p.isSelected)?.value || 0;

        charts.peer = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['Box Plot'],
            datasets: [
              {
                label: 'Min-Q1',
                data: [q1 - min],
                backgroundColor: 'rgba(229, 231, 235, 0.8)',
                stack: 'box'
              },
              {
                label: 'Q1-Median',
                data: [q2 - q1],
                backgroundColor: 'rgba(20, 184, 166, 0.4)',
                stack: 'box'
              },
              {
                label: 'Median-Q3',
                data: [q3 - q2],
                backgroundColor: 'rgba(20, 184, 166, 0.6)',
                stack: 'box'
              },
              {
                label: 'Q3-Max',
                data: [max - q3],
                backgroundColor: 'rgba(229, 231, 235, 0.8)',
                stack: 'box'
              }
            ]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: true, position: 'top' },
              tooltip: {
                callbacks: {
                  label: ctx => {
                    const labels = { 'Min-Q1': `Min: ${formatNumber(min, 1)}`, 'Q1-Median': `Q1: ${formatNumber(q1, 1)}`, 'Median-Q3': `Median: ${formatNumber(q2, 1)}`, 'Q3-Max': `Max: ${formatNumber(max, 1)}` };
                    return labels[ctx.dataset.label] || ctx.dataset.label;
                  }
                }
              },
              annotation: {
                annotations: {
                  selectedLine: {
                    type: 'line',
                    yMin: 0,
                    yMax: 0,
                    xMin: selectedValue,
                    xMax: selectedValue,
                    borderColor: '#ef4444',
                    borderWidth: 3,
                    label: {
                      display: true,
                      content: `${stock.ticker}: ${formatNumber(selectedValue, 1)}`,
                      position: 'end'
                    }
                  }
                }
              }
            },
            scales: {
              x: {
                stacked: true,
                ticks: {
                  callback: v => metric === 'mc' ? formatMarketCap(v + min) : formatNumber(v + min, 1)
                }
              },
              y: { stacked: true }
            }
          }
        });
      }
    }

    // ================== #196: MACRO ALERT SYSTEM ==================
    async function loadVIXData() {
      try {
        const resp = await fetch(`${BASE}/data/sentiment/vix.json`);
        if (!resp.ok) throw new Error('VIX data not found');
        const data = await resp.json();
        state.vixData = data;
        return data;
      } catch (err) {
        console.warn('Failed to load VIX data:', err);
        return null;
      }
    }

    function checkVIXAlert(vixValue) {
      if (vixValue >= 30) return { level: 'danger', title: 'VIX 30+ ê·¹ì‹¬í•œ ë³€ë™ì„±', msg: 'ì‹œì¥ ê³µí¬ ì§€ìˆ˜ê°€ ë§¤ìš° ë†’ìŠµë‹ˆë‹¤. ê¸‰ë½ ë˜ëŠ” ê¸‰ë“± ê°€ëŠ¥ì„±ì— ìœ ì˜í•˜ì„¸ìš”.', icon: 'exclamation-circle' };
      if (vixValue >= 25) return { level: 'warning', title: 'VIX 25+ ë†’ì€ ë³€ë™ì„±', msg: 'ë³€ë™ì„±ì´ í‰ì†Œë³´ë‹¤ ë†’ìŠµë‹ˆë‹¤. í¬ì§€ì…˜ ê´€ë¦¬ì— ì£¼ì˜í•˜ì„¸ìš”.', icon: 'exclamation-triangle' };
      if (vixValue <= 12) return { level: 'info', title: 'VIX <12 ë‚®ì€ ë³€ë™ì„±', msg: 'ì‹œì¥ ìë§Œ êµ¬ê°„ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê¸‰ë½ ì „ ì§•í›„ì¼ ìˆ˜ ìˆìœ¼ë‹ˆ ì£¼ì˜í•˜ì„¸ìš”.', icon: 'info-circle' };
      return null;
    }

    function checkYieldCurveAlert(spread) {
      if (spread == null) return null;
      if (spread < 0) return { level: 'danger', title: 'ìˆ˜ìµë¥ ê³¡ì„  ì—­ì „!', msg: '10Y-2Y ìŠ¤í”„ë ˆë“œê°€ ìŒìˆ˜ì…ë‹ˆë‹¤. ì—­ì‚¬ì ìœ¼ë¡œ ê²½ê¸°ì¹¨ì²´ ì„ í–‰ ì‹ í˜¸ì…ë‹ˆë‹¤.', icon: 'exclamation-circle' };
      if (spread < 0.25) return { level: 'warning', title: 'ìˆ˜ìµë¥ ê³¡ì„  í‰íƒ„í™”', msg: 'ìŠ¤í”„ë ˆë“œê°€ 25bp ë¯¸ë§Œìœ¼ë¡œ ì¢í˜€ì¡ŒìŠµë‹ˆë‹¤. ê²½ê¸°ë‘”í™” ê°€ëŠ¥ì„±ì„ ëª¨ë‹ˆí„°ë§í•˜ì„¸ìš”.', icon: 'exclamation-triangle' };
      return null;
    }

    function checkHYSpreadAlert(hysUS) {
      if (hysUS == null) return null;
      if (hysUS > 0.05) return { level: 'danger', title: 'HYìŠ¤í”„ë ˆë“œ 5%+ ì‹ ìš©ìœ„í—˜', msg: 'í•˜ì´ì¼ë“œ ìŠ¤í”„ë ˆë“œê°€ ê¸‰ë“±í–ˆìŠµë‹ˆë‹¤. ì‹ ìš©ì‹œì¥ ìŠ¤íŠ¸ë ˆìŠ¤ ì‹ í˜¸ì…ë‹ˆë‹¤.', icon: 'exclamation-circle' };
      if (hysUS > 0.04) return { level: 'warning', title: 'HYìŠ¤í”„ë ˆë“œ 4%+ ì£¼ì˜', msg: 'í•˜ì´ì¼ë“œ ìŠ¤í”„ë ˆë“œê°€ ìƒìŠ¹ ì¤‘ì…ë‹ˆë‹¤. ì‹ ìš©ìœ„í—˜ ëª¨ë‹ˆí„°ë§ì´ í•„ìš”í•©ë‹ˆë‹¤.', icon: 'exclamation-triangle' };
      return null;
    }

    function updateMacroAlerts() {
      const alerts = [];

      // VIX check (latest from vix.json - array is ascending, so last is latest)
      if (state.vixData?.length > 0) {
        const latestVIX = state.vixData[state.vixData.length - 1];
        const vixAlert = checkVIXAlert(latestVIX.value);
        if (vixAlert) {
          alerts.push({
            ...vixAlert,
            indicator: 'VIX',
            value: latestVIX.value.toFixed(2),
            date: latestVIX.date
          });
        }
      }

      // Yield curve & HY spread check (from economic.json - array is descending, first is latest)
      if (state.economic?.records?.length > 0) {
        const latest = state.economic.records[0];

        const ycAlert = checkYieldCurveAlert(latest.t10y_2y_spread);
        if (ycAlert) {
          alerts.push({
            ...ycAlert,
            indicator: '10Y-2Y Spread',
            value: (latest.t10y_2y_spread * 100).toFixed(0) + 'bp',
            threshold: '0bp',
            date: latest.date
          });
        }

        const hyAlert = checkHYSpreadAlert(latest.hys_us);
        if (hyAlert) {
          alerts.push({
            ...hyAlert,
            indicator: 'HY Spread (US)',
            value: (latest.hys_us * 100).toFixed(2) + '%',
            threshold: '4%/5%',
            date: latest.date
          });
        }
      }

      renderMacroAlerts(alerts);
    }

    function renderMacroAlerts(alerts) {
      const banner = document.getElementById('macroAlertBanner');
      if (!banner) return;

      if (alerts.length === 0) {
        banner.classList.add('hidden');
        return;
      }

      const html = alerts.map(alert => `
        <div class="macro-alert macro-alert-${alert.level}">
          <div class="macro-alert-header">
            <i class="fas fa-${alert.icon}"></i>
            <span>${alert.title}</span>
          </div>
          <p class="macro-alert-body">${alert.msg}</p>
          <p class="macro-alert-meta">
            ${alert.indicator}: ${alert.value}${alert.threshold ? ` (ê¸°ì¤€: ${alert.threshold})` : ''} â€¢ ${alert.date}
          </p>
        </div>
      `).join('');

      banner.innerHTML = html;
      banner.classList.remove('hidden');
    }

    // ================== UTILITIES ==================
    function formatNumber(val, decimals = 2) {
      if (val == null || isNaN(val)) return '-';
      return Number(val).toFixed(decimals);
    }

    function formatPercent(val) {
      if (val == null || isNaN(val)) return '-';
      return (val * 100).toFixed(2) + '%';
    }

    function formatMarketCap(val) {
      if (val == null || isNaN(val)) return '-';
      if (val >= 1000000) return (val / 1000000).toFixed(1) + 'T';
      if (val >= 1000) return (val / 1000).toFixed(1) + 'B';
      return val.toFixed(0) + 'M';
    }

    function formatB(val) {
      if (val == null || isNaN(val)) return '-';
      if (Math.abs(val) >= 1000000) return (val / 1000000).toFixed(1) + 'T';
      if (Math.abs(val) >= 1000) return (val / 1000).toFixed(1) + 'B';
      return val.toFixed(0) + 'M';
    }

    // ================== v4.3 NEW UTILITIES ==================

    // Growth Badge: ì¢…ëª© ë¶„ë¥˜ (growth_consensus.earnings_7y ê¸°ë°˜)
    function classifyStock(growthConsensus) {
      const earnings7y = growthConsensus?.earnings_7y || 0;
      if (earnings7y >= 20) return { badge: 'ğŸš€', label: 'ê³ ì„±ì¥ì£¼', color: 'text-emerald-600', bgColor: 'bg-emerald-100' };
      if (earnings7y >= 10) return { badge: 'ğŸ“ˆ', label: 'ì„±ì¥ì£¼', color: 'text-blue-600', bgColor: 'bg-blue-100' };
      if (earnings7y >= 5) return { badge: 'ğŸ¢', label: 'ì•ˆì •ì£¼', color: 'text-gray-600', bgColor: 'bg-gray-100' };
      return { badge: 'ğŸ’°', label: 'ê°€ì¹˜/ë°°ë‹¹ì£¼', color: 'text-amber-600', bgColor: 'bg-amber-100' };
    }

    // P/E Position: í˜„ì¬ ë°¸ë¥˜ì—ì´ì…˜ ìœ„ì¹˜ íŒë‹¨ (per_bands ê¸°ë°˜)
    function getPEPosition(perBands) {
      const { current, min_8y, avg_8y, max_8y } = perBands || {};
      if (current == null || min_8y == null || max_8y == null) return null;
      const range = max_8y - min_8y;
      if (range <= 0) return null;

      // Edge case handling: current outside historical range
      if (current < min_8y) {
        return { badge: 'ğŸŸ¢', label: 'ì—­ì‚¬ì  ìµœì €', color: 'text-green-600', bgColor: 'bg-green-100', position: 0 };
      }
      if (current > max_8y) {
        return { badge: 'ğŸ”´', label: 'ì—­ì‚¬ì  ìµœê³ ', color: 'text-red-600', bgColor: 'bg-red-100', position: 100 };
      }

      const position = ((current - min_8y) / range) * 100;
      if (position < 30) return { badge: 'ğŸŸ¢', label: 'ì €í‰ê°€ êµ¬ê°„', color: 'text-green-600', bgColor: 'bg-green-100', position };
      if (position < 70) return { badge: 'ğŸŸ¡', label: 'ì ì • êµ¬ê°„', color: 'text-amber-600', bgColor: 'bg-amber-100', position };
      return { badge: 'ğŸ”´', label: 'ê³ í‰ê°€ êµ¬ê°„', color: 'text-red-600', bgColor: 'bg-red-100', position };
    }

    // Fiscal Year ë¼ë²¨ ìƒì„± (fiscal_month ê¸°ë°˜)
    function getFiscalYearLabel(fiscalMonth, fyLabel) {
      if (!fiscalMonth) return fyLabel;
      const currentYear = new Date().getFullYear();
      // FY-4, FY-3, FY-2, FY-1, FY0 â†’ ì‹¤ì œ ì—°ë„ ê³„ì‚°
      const match = fyLabel?.match(/FY([-+]?\d+)?/);
      if (!match) return fyLabel;
      const offset = parseInt(match[1] || '0');
      const fyYear = currentYear + offset;
      return `FY${fyYear} (${fiscalMonth})`;
    }

    // ================== INIT ==================
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
