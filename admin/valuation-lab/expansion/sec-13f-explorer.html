<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEC 13F 기관 투자자 정보</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            background-image: linear-gradient(to bottom right, #f8f9fa, #e9ecef);
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            transition: all 0.2s ease-in-out;
        }
        .content-tab {
            cursor: pointer;
            padding: 0.75rem 1.25rem;
            color: #495057;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease-in-out;
        }
        .content-tab:hover {
            color: #000;
            background-color: #f1f3f5;
        }
        .content-tab.active {
            color: #0d6efd;
            border-bottom-color: #0d6efd;
        }
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
        .chart-container {
            position: relative;
            width: 100%;
            background-color: #fff;
            border-radius: 0.5rem;
            padding: 1rem;
        }
        .styled-table {
            width: 100%;
            border-collapse: collapse;
        }
        .styled-table thead th {
            background-color: #f8f9fa;
            font-weight: 600;
            padding: 0.75rem;
            text-align: left;
            border-bottom: 2px solid #dee2e6;
        }
        .styled-table tbody tr:nth-of-type(even) {
            background-color: #f8f9fa;
        }
        .styled-table tbody tr:hover {
            background-color: #e9ecef;
        }
        .styled-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #dee2e6;
        }
        .mono {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
        }
        #error-banner {
            display: none;
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10000;
        }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">

    <div id="loading-overlay">
        <div class="text-center">
            <i class="fas fa-spinner fa-spin fa-3x text-blue-600"></i>
            <p class="mt-4 text-lg font-semibold text-gray-700">데이터를 불러오는 중입니다...</p>
        </div>
    </div>

    <div id="error-banner" class="w-full max-w-xl bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg shadow-lg">
        <strong class="font-bold">오류 발생:</strong>
        <span class="block sm:inline" id="error-message">데이터를 가져오는 데 실패했습니다.</span>
    </div>

    <div class="max-w-7xl mx-auto">
        <!-- Header Card -->
        <div class="card mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">SEC 13F 기관 투자자 정보</h1>
                    <p class="text-gray-500 mt-1">기관 투자자의 13F 공시를 기반으로 포트폴리오를 탐색합니다.</p>
                </div>
                <a href="../" class="text-blue-600 hover:text-blue-800 transition-colors">
                    <i class="fas fa-arrow-left mr-2"></i>돌아가기
                </a>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="card mb-6 p-0">
            <div class="flex border-b border-gray-200" role="tablist" aria-label="13F 익스플로러 탭">
                <button role="tab" class="content-tab active" onclick="switchTab(event, 'overview')" aria-controls="overview" aria-selected="true">개요</button>
                <button role="tab" class="content-tab" onclick="switchTab(event, 'investor')" aria-controls="investor" aria-selected="false">기관별 분석</button>
                <button role="tab" class="content-tab" onclick="switchTab(event, 'stock')" aria-controls="stock" aria-selected="false">종목별 분석</button>
                <button role="tab" class="content-tab" onclick="switchTab(event, 'sector')" aria-controls="sector" aria-selected="false">섹터별 분석</button>
                <button role="tab" class="content-tab" onclick="switchTab(event, 'changes')" aria-controls="changes" aria-selected="false">주요 변동</button>
            </div>
        </div>

        <!-- Tab Content -->
        <div id="tab-content">
            <!-- Overview Tab -->
            <section id="overview" class="content-section active card" role="tabpanel" aria-labelledby="overview-tab">
                <h2 class="text-xl font-bold mb-4 text-gray-700">전체 개요</h2>
                <div id="overviewStats" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="p-4 bg-gray-50 rounded-lg text-center"><p class="text-sm text-gray-500">총 기관 수</p><p class="text-2xl font-bold">1,234</p></div>
                    <div class="p-4 bg-gray-50 rounded-lg text-center"><p class="text-sm text-gray-500">총 보유자산 (AUM)</p><p class="text-2xl font-bold">$12.3T</p></div>
                    <div class="p-4 bg-gray-50 rounded-lg text-center"><p class="text-sm text-gray-500">고유 종목 수</p><p class="text-2xl font-bold">5,678</p></div>
                    <div class="p-4 bg-gray-50 rounded-lg text-center"><p class="text-sm text-gray-500">최신 분기</p><p class="text-2xl font-bold">2023 Q4</p></div>
                </div>
                <div id="overviewInvestorGrid" class="mb-6">
                    <h3 class="text-lg font-semibold mb-3 text-gray-600">주요 기관 투자자</h3>
                    <div class="h-64 bg-gray-100 rounded-lg flex items-center justify-center text-gray-400">투자자 그리드 Placeholder</div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-3 text-gray-600">가장 많이 보유된 상위 종목</h3>
                    <table class="styled-table">
                        <thead><tr><th>순위</th><th>종목</th><th>티커</th><th>보유 기관 수</th><th>총 보유 가치</th><th>AUM 비중</th></tr></thead>
                        <tbody id="overviewTopStocksTableBody">
                            <tr><td colspan="6" class="text-center py-8">데이터 로딩 중...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Investor Portfolio Tab -->
            <section id="investor" class="content-section card" role="tabpanel" aria-labelledby="investor-tab">
                <div class="flex flex-wrap gap-4 items-center mb-6">
                    <div class="flex-grow">
                        <label for="investorSelect" class="block text-sm font-medium text-gray-700 mb-1">투자자 선택</label>
                        <select id="investorSelect" placeholder="기관 투자자 검색..."></select>
                    </div>
                    <div class="flex-grow sm:flex-grow-0">
                        <label for="investorQuarterSelect" class="block text-sm font-medium text-gray-700 mb-1">분기 선택</label>
                        <select id="investorQuarterSelect" class="block w-full rounded-md border-gray-300 shadow-sm"></select>
                    </div>
                    <button id="investorExportBtn" class="self-end bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition"><i class="fas fa-file-excel mr-2"></i>내보내기</button>
                </div>
                <div id="investorProfile" class="p-4 bg-blue-50 border border-blue-200 rounded-lg mb-6 h-32 flex items-center justify-center text-gray-500">투자자 프로필 Placeholder</div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <div class="lg:col-span-1">
                        <h3 class="text-lg font-semibold mb-3 text-gray-600">포트폴리오 구성</h3>
                        <div id="investorPieChartContainer" class="chart-container">
                            <canvas id="investorPieChart" height="250"></canvas>
                        </div>
                    </div>
                    <div class="lg:col-span-2">
                        <h3 class="text-lg font-semibold mb-3 text-gray-600">주요 보유 종목</h3>
                        <div class="overflow-auto max-h-80">
                            <table class="styled-table">
                                <thead><tr><th>종목</th><th>비중</th><th>수량</th><th>가치</th></tr></thead>
                                <tbody id="investorHoldingsTableBody"><tr><td colspan="4" class="text-center py-8">투자자를 선택하세요.</td></tr></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-3 text-gray-600">최근 주요 변경 내역</h3>
                    <div class="overflow-auto max-h-80">
                        <table class="styled-table">
                            <thead><tr><th>종목</th><th>변경 유형</th><th>변경 수량</th><th>변경 후 비중</th></tr></thead>
                            <tbody id="investorChangesTableBody"><tr><td colspan="4" class="text-center py-8">투자자를 선택하세요.</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Stock Lookup Tab -->
            <section id="stock" class="content-section card" role="tabpanel" aria-labelledby="stock-tab">
                 <div class="flex flex-wrap gap-4 items-center mb-6">
                    <div class="flex-grow">
                        <label for="tickerSelect" class="block text-sm font-medium text-gray-700 mb-1">종목 선택</label>
                        <select id="tickerSelect" placeholder="티커 또는 회사명 검색..."></select>
                    </div>
                     <div id="stockFilters" class="flex items-center gap-4 self-end">
                        <span class="text-sm font-medium text-gray-700">필터:</span>
                        <div class="h-8 bg-gray-100 rounded-md w-48 flex items-center justify-center text-gray-400">필터 Placeholder</div>
                     </div>
                </div>
                <div id="stockSummary" class="p-4 bg-indigo-50 border border-indigo-200 rounded-lg mb-6 h-24 flex items-center justify-center text-gray-500">종목 요약 정보 Placeholder</div>
                 <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                    <div class="lg:col-span-3">
                        <h3 class="text-lg font-semibold mb-3 text-gray-600">주요 기관 주주</h3>
                        <div class="overflow-auto max-h-96">
                            <table class="styled-table">
                                <thead><tr><th>기관명</th><th>보유 비중</th><th>보유 가치</th></tr></thead>
                                <tbody id="stockHoldersTableBody"><tr><td colspan="3" class="text-center py-8">종목을 선택하세요.</td></tr></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="lg:col-span-2">
                        <h3 class="text-lg font-semibold mb-3 text-gray-600">주주 그룹</h3>
                         <div id="stockGroupChartContainer" class="chart-container">
                            <canvas id="stockGroupChart" height="350"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sector Analysis Tab -->
            <section id="sector" class="content-section card" role="tabpanel" aria-labelledby="sector-tab">
                <h2 class="text-xl font-bold mb-4 text-gray-700">섹터 분석</h2>
                <div id="sectorSummary" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                     <div class="p-4 bg-gray-50 rounded-lg"><p class="text-sm text-gray-500">가장 많이 투자된 섹터</p><p class="text-xl font-bold">기술</p></div>
                    <div class="p-4 bg-gray-50 rounded-lg"><p class="text-sm text-gray-500">가장 적게 투자된 섹터</p><p class="text-xl font-bold">유틸리티</p></div>
                </div>
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-3 text-gray-600">섹터별 투자 비중 히트맵</h3>
                    <div id="sectorHeatmap" class="w-full h-96 bg-gray-100 rounded-lg flex items-center justify-center text-gray-400">히트맵 Placeholder</div>
                </div>
                <div>
                     <h3 class="text-lg font-semibold mb-3 text-gray-600">섹터 상세 정보</h3>
                     <div id="sectorDetail" class="h-64 bg-gray-100 rounded-lg flex items-center justify-center text-gray-400">섹터 상세 정보 Placeholder</div>
                </div>
            </section>

            <!-- Portfolio Changes Tab -->
            <section id="changes" class="content-section card" role="tabpanel" aria-labelledby="changes-tab">
                <div class="flex flex-wrap gap-4 items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-700">전체 포트폴리오 변경 내역</h2>
                    <div class="flex-grow"></div>
                    <div>
                        <label for="changesQuarterSelect" class="block text-sm font-medium text-gray-700 mb-1">분기 선택</label>
                        <select id="changesQuarterSelect" class="block w-full rounded-md border-gray-300 shadow-sm"></select>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div>
                         <h3 class="text-lg font-semibold mb-3 text-gray-600">신규 매수 상위 (Top Buys)</h3>
                         <div class="overflow-auto max-h-96">
                            <table class="styled-table">
                                <thead><tr><th>종목</th><th>매수 기관 수</th><th>총 매수 가치</th></tr></thead>
                                <tbody id="topBuysTableBody"><tr><td colspan="3" class="text-center py-8">데이터 로딩 중...</td></tr></tbody>
                            </table>
                        </div>
                    </div>
                     <div>
                         <h3 class="text-lg font-semibold mb-3 text-gray-600">전량 매도 상위 (Top Sells)</h3>
                         <div class="overflow-auto max-h-96">
                             <table class="styled-table">
                                <thead><tr><th>종목</th><th>매도 기관 수</th><th>총 매도 가치</th></tr></thead>
                                <tbody id="topSellsTableBody"><tr><td colspan="3" class="text-center py-8">데이터 로딩 중...</td></tr></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-3 text-gray-600">분기별 총 AUM 추이</h3>
                    <div id="aumTrendChartContainer" class="chart-container">
                        <canvas id="aumTrendChart" height="150"></canvas>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script>
        // ================== BASE & URLS ==================
        const buildBase = () => {
            const host = location.hostname;
            const isLocal = location.protocol === 'file:' || host === 'localhost' || host === '127.0.0.1' || host.startsWith('192.168.') || host.startsWith('10.');
            const isCloudflare = host.endsWith('pages.dev');
            return (isLocal || isCloudflare) ? '' : '/100xFenok';
        };

        const BASE = buildBase();
        const DATA_URLS = {
            summary: `${BASE}/data/sec-13f/summary.json`,
            bySector: `${BASE}/data/sec-13f/by_sector.json`,
            byTicker: `${BASE}/data/sec-13f/by_ticker.json`,
            investor: (key) => `${BASE}/data/sec-13f/investors/${key}.json`
        };

        // ================== STATE ==================
        const state = {
            summary: null,
            bySector: null,
            byTicker: null,
            investorCache: new Map(),
            investorsLoadedForChanges: false,

            selectedInvestor: null,
            selectedInvestorQuarter: null,
            selectedTicker: null,
            selectedChangesQuarter: null,
            currentTab: 'overview'
        };

        const ui = {
            loading: () => document.getElementById('loading-overlay'),
            errorBanner: () => document.getElementById('error-banner'),
            errorMessage: () => document.getElementById('error-message'),

            overviewStats: () => document.getElementById('overviewStats'),
            overviewInvestorGrid: () => document.getElementById('overviewInvestorGrid'),
            overviewTopStocksTableBody: () => document.getElementById('overviewTopStocksTableBody'),

            investorSelect: () => document.getElementById('investorSelect'),
            investorQuarterSelect: () => document.getElementById('investorQuarterSelect'),
            investorProfile: () => document.getElementById('investorProfile'),
            investorHoldingsTableBody: () => document.getElementById('investorHoldingsTableBody'),
            investorChangesTableBody: () => document.getElementById('investorChangesTableBody'),
            investorExportBtn: () => document.getElementById('investorExportBtn'),

            tickerSelect: () => document.getElementById('tickerSelect'),
            stockSummary: () => document.getElementById('stockSummary'),
            stockHoldersTableBody: () => document.getElementById('stockHoldersTableBody'),

            sectorSummary: () => document.getElementById('sectorSummary'),
            sectorHeatmap: () => document.getElementById('sectorHeatmap'),
            sectorDetail: () => document.getElementById('sectorDetail'),

            changesQuarterSelect: () => document.getElementById('changesQuarterSelect'),
            topBuysTableBody: () => document.getElementById('topBuysTableBody'),
            topSellsTableBody: () => document.getElementById('topSellsTableBody')
        };

        const tom = {
            investor: null,
            ticker: null
        };

        const charts = {
            investorPie: null,
            stockGroup: null,
            aumTrend: null
        };

        // ================== UTILITIES ==================
        function showLoading(label) {
            const el = ui.loading();
            if (!el) return;
            el.style.display = 'flex';
            const p = el.querySelector('p');
            if (p && label) p.textContent = label;
        }

        function hideLoading() {
            const el = ui.loading();
            if (!el) return;
            el.style.display = 'none';
        }

        function showError(message) {
            const banner = ui.errorBanner();
            const msg = ui.errorMessage();
            if (msg) msg.textContent = message || '데이터를 가져오는 데 실패했습니다.';
            if (banner) {
                banner.style.display = 'block';
                setTimeout(() => {
                    banner.style.display = 'none';
                }, 4500);
            }
        }

        async function fetchJson(url) {
            const res = await fetch(url, { cache: 'no-store' });
            if (!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
            return res.json();
        }

        function escapeHtml(s) {
            return String(s)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function formatInt(n) {
            const v = Number(n);
            if (!Number.isFinite(v)) return '-';
            return v.toLocaleString('en-US');
        }

        function formatPercent01(n) {
            const v = Number(n);
            if (!Number.isFinite(v)) return '-';
            return `${(v * 100).toFixed(2)}%`;
        }

        function formatMoney(n) {
            const v = Number(n);
            if (!Number.isFinite(v)) return '-';
            const abs = Math.abs(v);
            const sign = v < 0 ? '-' : '';
            if (abs >= 1e12) return `${sign}$${(abs / 1e12).toFixed(2)}T`;
            if (abs >= 1e9) return `${sign}$${(abs / 1e9).toFixed(2)}B`;
            if (abs >= 1e6) return `${sign}$${(abs / 1e6).toFixed(2)}M`;
            if (abs >= 1e3) return `${sign}$${(abs / 1e3).toFixed(2)}K`;
            return `${sign}$${abs.toFixed(0)}`;
        }

        function sum(arr) {
            return arr.reduce((a, b) => a + b, 0);
        }

        function normalizeFilings(investorJson) {
            const invObj = investorJson?.investor || {};
            const filings = investorJson?.filings || invObj?.filings || [];
            const metadata = investorJson?.metadata || {};
            return {
                metadata,
                investor: {
                    name: invObj?.name || investorJson?.investor?.name || investorJson?.investor || '',
                    entity: invObj?.entity || '',
                    cik: invObj?.cik || '',
                    group: invObj?.group || ''
                },
                filings
            };
        }

        function aggregateHoldings(holdings) {
            const map = new Map();
            for (const h of (holdings || [])) {
                const t = h?.ticker;
                if (!t) continue;
                const prev = map.get(t) || { ticker: t, name: h?.name || t, cusip: h?.cusip || '', shares: 0, market_value: 0, weight: 0 };
                prev.shares += Number(h?.shares || 0);
                prev.market_value += Number(h?.market_value || 0);
                prev.weight += Number(h?.weight || 0);
                map.set(t, prev);
            }
            return map;
        }

        function getQuarterFiling(filings, quarter) {
            if (!quarter) return null;
            return (filings || []).find(f => f?.quarter === quarter) || null;
        }

        function computeDiff(currMap, prevMap) {
            const tickers = new Set([...(currMap?.keys() || []), ...(prevMap?.keys() || [])]);
            const changes = [];
            for (const t of tickers) {
                const c = currMap?.get(t);
                const p = prevMap?.get(t);
                const cShares = Number(c?.shares || 0);
                const pShares = Number(p?.shares || 0);
                const cVal = Number(c?.market_value || 0);
                const pVal = Number(p?.market_value || 0);
                if (cShares === 0 && pShares === 0) continue;

                let action = 'UNCHANGED';
                if (pShares === 0 && cShares > 0) action = 'NEW';
                else if (pShares > 0 && cShares === 0) action = 'SOLD';
                else if (cShares > pShares) action = 'INCREASED';
                else if (cShares < pShares) action = 'DECREASED';

                if (action === 'UNCHANGED') continue;

                changes.push({
                    ticker: t,
                    name: c?.name || p?.name || t,
                    action,
                    deltaShares: cShares - pShares,
                    deltaValue: cVal - pVal,
                    weightAfter: Number(c?.weight || 0)
                });
            }
            return changes;
        }

        async function loadInvestor(key) {
            if (state.investorCache.has(key)) return state.investorCache.get(key);
            const json = await fetchJson(DATA_URLS.investor(key));
            const norm = normalizeFilings(json);
            state.investorCache.set(key, norm);
            return norm;
        }

        async function mapLimit(items, limit, fn) {
            const results = new Array(items.length);
            let idx = 0;
            const workers = new Array(Math.min(limit, items.length)).fill(0).map(async () => {
                while (idx < items.length) {
                    const myIdx = idx++;
                    results[myIdx] = await fn(items[myIdx], myIdx);
                }
            });
            await Promise.all(workers);
            return results;
        }

        function getInvestorDisplay(key) {
            const inv = state.summary?.investors?.[key];
            if (!inv) return key;
            return inv?.name || key;
        }

        function getInvestorGroup(key) {
            const inv = state.summary?.investors?.[key];
            return inv?.group || '-';
        }

        function selectInvestor(key) {
            state.selectedInvestor = key;
            if (tom.investor && key) tom.investor.setValue(key, true);
        }

        function selectTicker(ticker) {
            state.selectedTicker = ticker;
            if (tom.ticker && ticker) tom.ticker.setValue(ticker, true);
        }

        // ================== TABS ==================
        function switchTab(event, tabId) {
            const tabContainer = document.getElementById('tab-content');
            const tabButtonsContainer = event.target.parentElement;

            tabContainer.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
            tabButtonsContainer.querySelectorAll('.content-tab').forEach(tab => {
                tab.classList.remove('active');
                tab.setAttribute('aria-selected', 'false');
            });

            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
            event.target.setAttribute('aria-selected', 'true');

            state.currentTab = tabId;
            renderActiveTab();
        }

        function renderActiveTab() {
            if (!state.summary) return;
            if (state.currentTab === 'overview') return renderOverview();
            if (state.currentTab === 'investor') return renderInvestor();
            if (state.currentTab === 'stock') return renderStock();
            if (state.currentTab === 'sector') return renderSector();
            if (state.currentTab === 'changes') return renderChanges();
        }

        // ================== OVERVIEW ==================
        function renderOverview() {
            const investors = state.summary?.investors || {};
            const invEntries = Object.entries(investors);
            const quarters = state.summary?.metadata?.quarters_covered || [];
            const latestQuarter = quarters[0] || '-';
            const totalAum = sum(invEntries.map(([, v]) => Number(v?.aum || 0)));
            const stocksCount = Object.keys(state.byTicker || {}).length;

            ui.overviewStats().innerHTML = [
                { label: '총 기관 수', value: formatInt(state.summary?.metadata?.investor_count || invEntries.length) },
                { label: '총 보유자산 (AUM)', value: formatMoney(totalAum) },
                { label: '고유 종목 수', value: formatInt(stocksCount) },
                { label: '최신 분기', value: escapeHtml(latestQuarter) }
            ].map(x => `
                <div class="p-4 bg-gray-50 rounded-lg text-center">
                    <p class="text-sm text-gray-500">${escapeHtml(x.label)}</p>
                    <p class="text-2xl font-bold">${escapeHtml(x.value)}</p>
                </div>
            `).join('');

            // Investor cards
            const topInvestors = invEntries
                .map(([key, v]) => ({ key, ...v }))
                .sort((a, b) => Number(b.aum || 0) - Number(a.aum || 0))
                .slice(0, 17);

            ui.overviewInvestorGrid().innerHTML = `
                <h3 class="text-lg font-semibold mb-3 text-gray-600">주요 기관 투자자</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    ${topInvestors.map(inv => `
                        <button class="text-left p-4 bg-white border border-gray-200 rounded-lg hover:border-blue-300 hover:shadow transition" data-investor="${escapeHtml(inv.key)}">
                            <div class="flex items-start justify-between gap-3">
                                <div>
                                    <div class="text-sm text-gray-500">${escapeHtml(inv.group || '-')}</div>
                                    <div class="text-base font-bold text-gray-800">${escapeHtml(inv.name || inv.key)}</div>
                                </div>
                                <div class="text-sm font-semibold text-blue-700">${escapeHtml(formatMoney(inv.aum || 0))}</div>
                            </div>
                            <div class="mt-2 text-xs text-gray-500">보유 종목: ${escapeHtml(formatInt(inv.holdings_count || 0))} | 분기: ${escapeHtml(inv.quarter || latestQuarter)}</div>
                            <div class="mt-1 text-xs text-gray-500">Top5: <span class="mono">${escapeHtml((inv.top5 || []).slice(0,5).join(', ') || '-')}</span></div>
                        </button>
                    `).join('')}
                </div>
            `;

            ui.overviewInvestorGrid().querySelectorAll('button[data-investor]').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const key = btn.getAttribute('data-investor');
                    selectInvestor(key);
                    // Switch to investor tab programmatically
                    const investorTabBtn = document.querySelector('button.content-tab[aria-controls="investor"]');
                    if (investorTabBtn) investorTabBtn.click();
                });
            });

            // Top stocks table
            const topStocksObj = state.summary?.top_stocks || {};
            const topStocks = Object.entries(topStocksObj)
                .map(([ticker, v]) => ({ ticker, holders: Number(v?.holders || 0), total_value: Number(v?.total_value || 0) }))
                .sort((a, b) => b.total_value - a.total_value);

            ui.overviewTopStocksTableBody().innerHTML = topStocks.map((s, idx) => {
                const pct = totalAum > 0 ? (s.total_value / totalAum) : 0;
                return `
                    <tr class="cursor-pointer" data-ticker="${escapeHtml(s.ticker)}">
                        <td>${idx + 1}</td>
                        <td class="font-semibold">${escapeHtml(s.ticker)}</td>
                        <td class="mono">${escapeHtml(s.ticker)}</td>
                        <td>${escapeHtml(formatInt(s.holders))}</td>
                        <td class="mono">${escapeHtml(formatMoney(s.total_value))}</td>
                        <td>${escapeHtml(formatPercent01(pct))}</td>
                    </tr>
                `;
            }).join('');

            ui.overviewTopStocksTableBody().querySelectorAll('tr[data-ticker]').forEach(tr => {
                tr.addEventListener('click', () => {
                    const ticker = tr.getAttribute('data-ticker');
                    selectTicker(ticker);
                    const stockTabBtn = document.querySelector('button.content-tab[aria-controls="stock"]');
                    if (stockTabBtn) stockTabBtn.click();
                });
            });
        }

        // ================== INVESTOR ==================
        async function renderInvestor() {
            if (!state.selectedInvestor) {
                ui.investorProfile().textContent = '투자자를 선택하세요.';
                ui.investorHoldingsTableBody().innerHTML = '<tr><td colspan="4" class="text-center py-8">투자자를 선택하세요.</td></tr>';
                ui.investorChangesTableBody().innerHTML = '<tr><td colspan="4" class="text-center py-8">투자자를 선택하세요.</td></tr>';
                return;
            }

            try {
                showLoading('투자자 데이터를 불러오는 중입니다...');
                const key = state.selectedInvestor;
                const data = await loadInvestor(key);
                const filings = data.filings || [];
                const quarters = (data.metadata?.quarters_covered || state.summary?.metadata?.quarters_covered || [])
                    .slice();
                const defaultQuarter = quarters[0] || filings[0]?.quarter;
                if (!state.selectedInvestorQuarter) state.selectedInvestorQuarter = defaultQuarter;

                // Populate quarter select
                ui.investorQuarterSelect().innerHTML = quarters.map(q => `<option value="${escapeHtml(q)}">${escapeHtml(q)}</option>`).join('');
                ui.investorQuarterSelect().value = state.selectedInvestorQuarter;

                const currentQuarter = state.selectedInvestorQuarter;
                const qIndex = quarters.indexOf(currentQuarter);
                const prevQuarter = qIndex >= 0 ? quarters[qIndex + 1] : null;

                const filing = getQuarterFiling(filings, currentQuarter) || filings[0] || null;
                const prevFiling = prevQuarter ? getQuarterFiling(filings, prevQuarter) : null;

                const currMap = aggregateHoldings(filing?.holdings || []);
                const prevMap = aggregateHoldings(prevFiling?.holdings || []);
                const holdingsArr = [...currMap.values()].sort((a, b) => Number(b.market_value) - Number(a.market_value));

                // Profile card
                const profileHtml = `
                    <div class="w-full">
                        <div class="flex items-start justify-between gap-4">
                            <div>
                                <div class="text-sm text-gray-500">${escapeHtml(getInvestorGroup(key))}</div>
                                <div class="text-xl font-bold text-gray-800">${escapeHtml(data.investor?.name || getInvestorDisplay(key))}</div>
                                <div class="text-sm text-gray-600">${escapeHtml(data.investor?.entity || '')}</div>
                                <div class="text-xs text-gray-500 mt-1">CIK: <span class="mono">${escapeHtml(data.investor?.cik || '-')}</span></div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-gray-500">${escapeHtml(currentQuarter)}</div>
                                <div class="text-lg font-bold text-blue-700">${escapeHtml(formatMoney(filing?.aum_total || 0))}</div>
                                <div class="text-xs text-gray-500">보유 종목: ${escapeHtml(formatInt(filing?.holdings_count || holdingsArr.length))}</div>
                            </div>
                        </div>
                        <div class="mt-3 text-sm text-gray-600">
                            공시일: <span class="mono">${escapeHtml(filing?.filing_date || '-')}</span>
                            | Top10 비중: <span class="font-semibold">${escapeHtml(formatPercent01(filing?.top_10_weight || 0))}</span>
                        </div>
                        <div class="mt-2 text-xs text-gray-500">변동은 이전 분기 대비(가능한 경우) 계산합니다. (데이터에 change 필드가 없어 비교로 산출)</div>
                    </div>
                `;
                ui.investorProfile().className = 'p-4 bg-blue-50 border border-blue-200 rounded-lg mb-6';
                ui.investorProfile().innerHTML = profileHtml;

                // Holdings table
                ui.investorHoldingsTableBody().innerHTML = holdingsArr.slice(0, 200).map(h => `
                    <tr class="cursor-pointer" data-ticker="${escapeHtml(h.ticker)}">
                        <td><span class="font-semibold mono">${escapeHtml(h.ticker)}</span><div class="text-xs text-gray-500">${escapeHtml(h.name || '')}</div></td>
                        <td>${escapeHtml(formatPercent01(h.weight || 0))}</td>
                        <td class="mono">${escapeHtml(formatInt(h.shares || 0))}</td>
                        <td class="mono">${escapeHtml(formatMoney(h.market_value || 0))}</td>
                    </tr>
                `).join('') || '<tr><td colspan="4" class="text-center py-8">보유 종목이 없습니다.</td></tr>';

                ui.investorHoldingsTableBody().querySelectorAll('tr[data-ticker]').forEach(tr => {
                    tr.addEventListener('click', () => {
                        const ticker = tr.getAttribute('data-ticker');
                        selectTicker(ticker);
                        const stockTabBtn = document.querySelector('button.content-tab[aria-controls="stock"]');
                        if (stockTabBtn) stockTabBtn.click();
                    });
                });

                // Changes
                const changes = computeDiff(currMap, prevMap)
                    .sort((a, b) => Math.abs(b.deltaValue) - Math.abs(a.deltaValue))
                    .slice(0, 200);

                ui.investorChangesTableBody().innerHTML = changes.map(c => {
                    const badge = c.action;
                    const deltaShares = c.deltaShares;
                    const deltaVal = c.deltaValue;
                    const deltaSharesStr = `${deltaShares >= 0 ? '+' : ''}${formatInt(deltaShares)}`;
                    const deltaValStr = `${deltaVal >= 0 ? '+' : ''}${formatMoney(deltaVal)}`;
                    const badgeClass = c.action === 'NEW' ? 'bg-green-100 text-green-800' :
                        c.action === 'SOLD' ? 'bg-red-100 text-red-800' :
                        c.action === 'INCREASED' ? 'bg-blue-100 text-blue-800' :
                        'bg-amber-100 text-amber-800';
                    return `
                        <tr>
                            <td><span class="font-semibold mono">${escapeHtml(c.ticker)}</span><div class="text-xs text-gray-500">${escapeHtml(c.name || '')}</div></td>
                            <td><span class="inline-flex px-2 py-1 rounded text-xs font-semibold ${badgeClass}">${escapeHtml(badge)}</span></td>
                            <td class="mono">${escapeHtml(deltaSharesStr)}<div class="text-xs text-gray-500">${escapeHtml(deltaValStr)}</div></td>
                            <td>${escapeHtml(formatPercent01(c.weightAfter || 0))}</td>
                        </tr>
                    `;
                }).join('') || '<tr><td colspan="4" class="text-center py-8">이전 분기 데이터가 없어 변동을 계산할 수 없습니다.</td></tr>';

                // Pie chart (top 10 + Others)
                const top10 = holdingsArr.slice(0, 10);
                const labels = top10.map(h => h.ticker);
                const values = top10.map(h => Number(h.market_value || 0));
                const othersValue = sum(holdingsArr.slice(10).map(h => Number(h.market_value || 0)));
                if (othersValue > 0) {
                    labels.push('OTHERS');
                    values.push(othersValue);
                }

                initInvestorPieChart();
                charts.investorPie.data.labels = labels;
                charts.investorPie.data.datasets[0].data = values;
                charts.investorPie.update();

                hideLoading();
            } catch (e) {
                hideLoading();
                console.error(e);
                showError('투자자 데이터를 불러오는 데 실패했습니다.');
            }
        }

        function initInvestorPieChart() {
            if (charts.investorPie) return;
            const ctx = document.getElementById('investorPieChart')?.getContext('2d');
            if (!ctx) return;
            charts.investorPie = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: [], datasets: [{ data: [], backgroundColor: [
                    '#0d6efd','#6610f2','#6f42c1','#d63384','#dc3545','#fd7e14','#ffc107','#198754','#20c997','#0dcaf0','#adb5bd'
                ] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });
        }

        // ================== STOCK ==================
        async function renderStock() {
            if (!state.selectedTicker) {
                ui.stockSummary().textContent = '종목을 선택하세요.';
                ui.stockHoldersTableBody().innerHTML = '<tr><td colspan="3" class="text-center py-8">종목을 선택하세요.</td></tr>';
                initStockGroupChart();
                charts.stockGroup.data.labels = [];
                charts.stockGroup.data.datasets[0].data = [];
                charts.stockGroup.update();
                return;
            }

            const ticker = state.selectedTicker;
            const tickerObj = state.byTicker?.[ticker];
            if (!tickerObj) {
                ui.stockSummary().textContent = '해당 종목 데이터가 없습니다.';
                ui.stockHoldersTableBody().innerHTML = '<tr><td colspan="3" class="text-center py-8">데이터 없음</td></tr>';
                return;
            }

            // Deduplicate holder_details by investor
            const rawDetails = Array.isArray(tickerObj.holder_details) ? tickerObj.holder_details : [];
            const byInvestor = new Map();
            for (const d of rawDetails) {
                const k = d?.investor;
                if (!k) continue;
                const prev = byInvestor.get(k) || { investor: k, shares: 0, weight: 0 };
                prev.shares += Number(d?.shares || 0);
                prev.weight += Number(d?.weight || 0);
                byInvestor.set(k, prev);
            }

            const holders = [...byInvestor.values()].sort((a, b) => Number(b.weight) - Number(a.weight));
            const uniqueHolders = Array.isArray(tickerObj.holders) ? new Set(tickerObj.holders).size : holders.length;
            const topStockMeta = state.summary?.top_stocks?.[ticker];
            const groups = {};
            for (const h of holders) {
                const g = getInvestorGroup(h.investor);
                groups[g] = (groups[g] || 0) + 1;
            }

            // Summary
            ui.stockSummary().className = 'p-4 bg-indigo-50 border border-indigo-200 rounded-lg mb-6';
            ui.stockSummary().innerHTML = `
                <div class="flex items-start justify-between gap-4">
                    <div>
                        <div class="text-sm text-gray-500">종목</div>
                        <div class="text-xl font-bold text-gray-800 mono">${escapeHtml(ticker)}</div>
                        <div class="text-xs text-gray-500 mt-1">총 보유 기관: <span class="font-semibold">${escapeHtml(formatInt(uniqueHolders))}</span> | 총 주식수(합계): <span class="mono">${escapeHtml(formatInt(tickerObj.total_shares || 0))}</span></div>
                        <div class="text-xs text-gray-500 mt-1">Top20(요약) 총 보유 가치: <span class="mono">${escapeHtml(topStockMeta ? formatMoney(topStockMeta.total_value || 0) : '-')}</span></div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-gray-500">그룹 분포</div>
                        <div class="text-sm text-gray-700">${escapeHtml(Object.entries(groups).map(([k,v]) => `${k}:${v}`).join(' · ') || '-') }</div>
                    </div>
                </div>
                <div class="mt-2 text-xs text-gray-500">보유가치(Value)는 investor 파일의 해당 분기 market_value로 계산합니다(없으면 '-').</div>
            `;

            // Render group chart
            initStockGroupChart();
            const groupLabels = Object.keys(groups);
            charts.stockGroup.data.labels = groupLabels;
            charts.stockGroup.data.datasets[0].data = groupLabels.map(k => groups[k]);
            charts.stockGroup.update();

            // Holders table (async values)
            ui.stockHoldersTableBody().innerHTML = '<tr><td colspan="3" class="text-center py-8">보유 기관 정보를 계산 중...</td></tr>';

            const quarter = state.summary?.metadata?.quarters_covered?.[0] || null;
            const rows = await mapLimit(holders.slice(0, 80), 4, async (h) => {
                let value = null;
                try {
                    const inv = await loadInvestor(h.investor);
                    const filing = getQuarterFiling(inv.filings, quarter) || inv.filings?.[0] || null;
                    const agg = aggregateHoldings(filing?.holdings || []);
                    const entry = agg.get(ticker);
                    if (entry && Number.isFinite(Number(entry.market_value))) value = Number(entry.market_value);
                } catch (e) {
                    value = null;
                }
                return {
                    investorKey: h.investor,
                    investorName: getInvestorDisplay(h.investor),
                    group: getInvestorGroup(h.investor),
                    weight: h.weight,
                    value
                };
            });

            ui.stockHoldersTableBody().innerHTML = rows
                .sort((a, b) => Number(b.weight || 0) - Number(a.weight || 0))
                .map(r => `
                    <tr class="cursor-pointer" data-investor="${escapeHtml(r.investorKey)}">
                        <td>
                            <div class="font-semibold text-gray-800">${escapeHtml(r.investorName)}</div>
                            <div class="text-xs text-gray-500">${escapeHtml(r.group)} · ${escapeHtml(r.investorKey)}</div>
                        </td>
                        <td class="mono">${escapeHtml(formatPercent01(r.weight || 0))}</td>
                        <td class="mono">${escapeHtml(r.value == null ? '-' : formatMoney(r.value))}</td>
                    </tr>
                `).join('') || '<tr><td colspan="3" class="text-center py-8">보유 기관이 없습니다.</td></tr>';

            ui.stockHoldersTableBody().querySelectorAll('tr[data-investor]').forEach(tr => {
                tr.addEventListener('click', () => {
                    const key = tr.getAttribute('data-investor');
                    selectInvestor(key);
                    const investorTabBtn = document.querySelector('button.content-tab[aria-controls="investor"]');
                    if (investorTabBtn) investorTabBtn.click();
                });
            });
        }

        function initStockGroupChart() {
            if (charts.stockGroup) return;
            const ctx = document.getElementById('stockGroupChart')?.getContext('2d');
            if (!ctx) return;
            charts.stockGroup = new Chart(ctx, {
                type: 'bar',
                data: { labels: [], datasets: [{ label: '보유 기관 수', data: [], backgroundColor: '#0d6efd' }] },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } } }
            });
        }

        // ================== SECTOR ==================
        function renderSector() {
            const sectors = state.bySector || {};
            const sectorEntries = Object.entries(sectors)
                .map(([name, v]) => ({ name, investors: v?.investors || [], avg_weight: Number(v?.avg_weight || 0), top_holdings: v?.top_holdings || [] }))
                .sort((a, b) => b.avg_weight - a.avg_weight);

            if (sectorEntries.length === 0) {
                ui.sectorSummary().innerHTML = '<div class="p-4 bg-gray-50 rounded-lg">섹터 데이터가 없습니다.</div>';
                ui.sectorHeatmap().textContent = '데이터 없음';
                ui.sectorDetail().textContent = '데이터 없음';
                return;
            }

            const top = sectorEntries[0];
            const bottom = sectorEntries[sectorEntries.length - 1];

            ui.sectorSummary().innerHTML = `
                <div class="p-4 bg-gray-50 rounded-lg">
                    <p class="text-sm text-gray-500">가장 높은 평균 비중</p>
                    <p class="text-xl font-bold">${escapeHtml(top.name)}</p>
                    <p class="text-xs text-gray-500 mt-1">avg_weight: ${escapeHtml(formatPercent01(top.avg_weight))} · 기관: ${escapeHtml(formatInt(top.investors.length))}</p>
                </div>
                <div class="p-4 bg-gray-50 rounded-lg">
                    <p class="text-sm text-gray-500">가장 낮은 평균 비중</p>
                    <p class="text-xl font-bold">${escapeHtml(bottom.name)}</p>
                    <p class="text-xs text-gray-500 mt-1">avg_weight: ${escapeHtml(formatPercent01(bottom.avg_weight))} · 기관: ${escapeHtml(formatInt(bottom.investors.length))}</p>
                </div>
            `;

            // Heatmap: membership matrix (data does not include per-investor weights)
            const investorKeys = Object.keys(state.summary?.investors || {});
            const sectorNames = sectorEntries.map(s => s.name);
            const lookup = new Map(sectorEntries.map(s => [s.name, new Set(s.investors)]));
            const wLookup = new Map(sectorEntries.map(s => [s.name, s.avg_weight]));

            const heatmapHtml = `
                <div class="overflow-auto">
                    <table class="styled-table" style="min-width: 900px;">
                        <thead>
                            <tr>
                                <th>기관</th>
                                ${sectorNames.map(n => `<th class="cursor-pointer" data-sector="${escapeHtml(n)}">${escapeHtml(n)}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${investorKeys.map(k => {
                                const name = getInvestorDisplay(k);
                                return `
                                    <tr>
                                        <td>
                                            <div class="font-semibold">${escapeHtml(name)}</div>
                                            <div class="text-xs text-gray-500">${escapeHtml(getInvestorGroup(k))} · ${escapeHtml(k)}</div>
                                        </td>
                                        ${sectorNames.map(sn => {
                                            const present = lookup.get(sn)?.has(k);
                                            const intensity = Math.min(1, Math.max(0, Number(wLookup.get(sn) || 0) * 8));
                                            const bg = present ? `rgba(13,110,253,${0.15 + intensity * 0.55})` : 'transparent';
                                            return `<td style="background:${bg};" title="${escapeHtml(sn)}">${present ? '●' : ''}</td>`;
                                        }).join('')}
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                <div class="text-xs text-gray-500 mt-2">주의: 섹터별로 investor 목록과 avg_weight만 제공되어, 히트맵은 '해당 섹터 보유 여부' 기반으로 표시합니다.</div>
            `;

            ui.sectorHeatmap().innerHTML = heatmapHtml;
            ui.sectorHeatmap().classList.remove('flex', 'items-center', 'justify-center', 'text-gray-400');
            ui.sectorHeatmap().classList.add('text-gray-700');

            // Sector detail default
            renderSectorDetail(top.name);
            ui.sectorHeatmap().querySelectorAll('th[data-sector]').forEach(th => {
                th.addEventListener('click', () => renderSectorDetail(th.getAttribute('data-sector')));
            });
        }

        function renderSectorDetail(sectorName) {
            const s = state.bySector?.[sectorName];
            if (!s) {
                ui.sectorDetail().textContent = '섹터 데이터 없음';
                return;
            }
            const investorKeys = s?.investors || [];
            const investors = investorKeys.map(k => ({ key: k, name: getInvestorDisplay(k), group: getInvestorGroup(k) }));
            ui.sectorDetail().innerHTML = `
                <div class="p-4 bg-gray-50 rounded-lg">
                    <div class="flex items-start justify-between gap-4">
                        <div>
                            <div class="text-sm text-gray-500">섹터</div>
                            <div class="text-xl font-bold text-gray-800">${escapeHtml(sectorName)}</div>
                            <div class="text-xs text-gray-500 mt-1">avg_weight: ${escapeHtml(formatPercent01(s.avg_weight || 0))} · 기관 수: ${escapeHtml(formatInt(investorKeys.length))}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-gray-500">Top Holdings</div>
                            <div class="text-sm text-gray-700 mono">${escapeHtml((s.top_holdings || []).slice(0, 10).join(', ') || '-')}</div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <div class="text-sm font-semibold text-gray-700 mb-2">보유 기관</div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2">
                            ${investors.map(inv => `
                                <button class="text-left p-3 bg-white border border-gray-200 rounded hover:border-blue-300" data-investor="${escapeHtml(inv.key)}">
                                    <div class="font-semibold">${escapeHtml(inv.name)}</div>
                                    <div class="text-xs text-gray-500">${escapeHtml(inv.group)} · ${escapeHtml(inv.key)}</div>
                                </button>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            ui.sectorDetail().classList.remove('flex', 'items-center', 'justify-center', 'text-gray-400');
            ui.sectorDetail().style.overflow = 'auto';

            ui.sectorDetail().querySelectorAll('button[data-investor]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const key = btn.getAttribute('data-investor');
                    selectInvestor(key);
                    const investorTabBtn = document.querySelector('button.content-tab[aria-controls="investor"]');
                    if (investorTabBtn) investorTabBtn.click();
                });
            });
        }

        // ================== CHANGES (CROSS-INVESTOR) ==================
        async function renderChanges() {
            try {
                const quarters = state.summary?.metadata?.quarters_covered || [];
                if (!state.selectedChangesQuarter) state.selectedChangesQuarter = quarters[0] || null;
                ui.changesQuarterSelect().innerHTML = quarters.map(q => `<option value="${escapeHtml(q)}">${escapeHtml(q)}</option>`).join('');
                ui.changesQuarterSelect().value = state.selectedChangesQuarter;

                // Load all investors once for this tab
                if (!state.investorsLoadedForChanges) {
                    showLoading('전체 투자자 데이터를 불러오는 중입니다...');
                    const invKeys = Object.keys(state.summary?.investors || {});
                    await mapLimit(invKeys, 4, async (k) => loadInvestor(k));
                    state.investorsLoadedForChanges = true;
                    hideLoading();
                }

                const q = state.selectedChangesQuarter;
                const qIdx = quarters.indexOf(q);
                const prevQ = qIdx >= 0 ? quarters[qIdx + 1] : null;
                if (!prevQ) {
                    ui.topBuysTableBody().innerHTML = '<tr><td colspan="3" class="text-center py-8">이전 분기 데이터가 없어 비교할 수 없습니다.</td></tr>';
                    ui.topSellsTableBody().innerHTML = '<tr><td colspan="3" class="text-center py-8">이전 분기 데이터가 없어 비교할 수 없습니다.</td></tr>';
                }

                const invKeys = Object.keys(state.summary?.investors || {});
                const allChanges = [];
                for (const key of invKeys) {
                    const inv = state.investorCache.get(key);
                    if (!inv) continue;
                    const currF = getQuarterFiling(inv.filings, q);
                    const prevF = prevQ ? getQuarterFiling(inv.filings, prevQ) : null;
                    if (!currF || !prevF) continue;
                    const currMap = aggregateHoldings(currF.holdings || []);
                    const prevMap = aggregateHoldings(prevF.holdings || []);
                    const changes = computeDiff(currMap, prevMap);
                    for (const c of changes) {
                        allChanges.push({
                            investorKey: key,
                            investorName: getInvestorDisplay(key),
                            group: getInvestorGroup(key),
                            quarter: q,
                            prevQuarter: prevQ,
                            ...c
                        });
                    }
                }

                const buys = allChanges
                    .filter(c => c.action === 'NEW' || c.action === 'INCREASED')
                    .sort((a, b) => (b.deltaValue) - (a.deltaValue));

                const sells = allChanges
                    .filter(c => c.action === 'SOLD' || c.action === 'DECREASED')
                    .sort((a, b) => (a.deltaValue) - (b.deltaValue));

                // Aggregate by ticker
                function aggregateTicker(list) {
                    const m = new Map();
                    for (const x of list) {
                        const prev = m.get(x.ticker) || { ticker: x.ticker, count: 0, totalDelta: 0 };
                        prev.count += 1;
                        prev.totalDelta += Number(x.deltaValue || 0);
                        m.set(x.ticker, prev);
                    }
                    return [...m.values()];
                }

                const topBuys = aggregateTicker(buys)
                    .sort((a, b) => b.totalDelta - a.totalDelta)
                    .slice(0, 20);

                const topSells = aggregateTicker(sells)
                    .sort((a, b) => a.totalDelta - b.totalDelta)
                    .slice(0, 20);

                ui.topBuysTableBody().innerHTML = topBuys.map(r => `
                    <tr class="cursor-pointer" data-ticker="${escapeHtml(r.ticker)}">
                        <td class="mono font-semibold">${escapeHtml(r.ticker)}</td>
                        <td>${escapeHtml(formatInt(r.count))}</td>
                        <td class="mono">+${escapeHtml(formatMoney(r.totalDelta))}</td>
                    </tr>
                `).join('') || '<tr><td colspan="3" class="text-center py-8">데이터 없음</td></tr>';

                ui.topSellsTableBody().innerHTML = topSells.map(r => `
                    <tr class="cursor-pointer" data-ticker="${escapeHtml(r.ticker)}">
                        <td class="mono font-semibold">${escapeHtml(r.ticker)}</td>
                        <td>${escapeHtml(formatInt(r.count))}</td>
                        <td class="mono">${escapeHtml(formatMoney(r.totalDelta))}</td>
                    </tr>
                `).join('') || '<tr><td colspan="3" class="text-center py-8">데이터 없음</td></tr>';

                ui.topBuysTableBody().querySelectorAll('tr[data-ticker]').forEach(tr => {
                    tr.addEventListener('click', () => {
                        const t = tr.getAttribute('data-ticker');
                        selectTicker(t);
                        const stockTabBtn = document.querySelector('button.content-tab[aria-controls="stock"]');
                        if (stockTabBtn) stockTabBtn.click();
                    });
                });
                ui.topSellsTableBody().querySelectorAll('tr[data-ticker]').forEach(tr => {
                    tr.addEventListener('click', () => {
                        const t = tr.getAttribute('data-ticker');
                        selectTicker(t);
                        const stockTabBtn = document.querySelector('button.content-tab[aria-controls="stock"]');
                        if (stockTabBtn) stockTabBtn.click();
                    });
                });

                renderAumTrendChart();
            } catch (e) {
                console.error(e);
                showError('변동 탭 데이터를 불러오는 데 실패했습니다.');
            }
        }

        function renderAumTrendChart() {
            const quarters = state.summary?.metadata?.quarters_covered || [];
            const invKeys = Object.keys(state.summary?.investors || {});
            const datasets = invKeys.map((k, idx) => {
                const inv = state.investorCache.get(k);
                const filings = inv?.filings || [];
                const byQuarter = new Map(filings.map(f => [f.quarter, Number(f.aum_total || 0)]));
                const data = quarters.map(q => byQuarter.get(q) ?? null);
                const palette = [
                    '#0d6efd','#6610f2','#6f42c1','#d63384','#dc3545','#fd7e14','#ffc107','#198754','#20c997','#0dcaf0',
                    '#6c757d','#343a40','#0b7285','#5c940d','#e8590c','#a61e4d','#364fc7'
                ];
                return {
                    label: getInvestorDisplay(k),
                    data,
                    borderColor: palette[idx % palette.length],
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    pointRadius: 1,
                    tension: 0.15
                };
            });

            if (!charts.aumTrend) {
                const ctx = document.getElementById('aumTrendChart')?.getContext('2d');
                if (!ctx) return;
                charts.aumTrend = new Chart(ctx, {
                    type: 'line',
                    data: { labels: quarters.slice().reverse(), datasets: datasets.map(ds => ({ ...ds, data: ds.data.slice().reverse() })) },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom', labels: { boxWidth: 10 } }
                        },
                        scales: {
                            y: { ticks: { callback: (v) => formatMoney(v) } }
                        }
                    }
                });
                return;
            }

            charts.aumTrend.data.labels = quarters.slice().reverse();
            charts.aumTrend.data.datasets = datasets.map(ds => ({ ...ds, data: ds.data.slice().reverse() }));
            charts.aumTrend.update();
        }

        // ================== CSV EXPORT ==================
        function downloadCsv(filename, rows) {
            const csv = rows.map(r => r.map(x => {
                const s = String(x ?? '');
                if (/[\n",]/.test(s)) return `"${s.replace(/"/g, '""')}"`;
                return s;
            }).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ================== INIT ==================
        async function init() {
            try {
                showLoading('SEC 13F 데이터를 불러오는 중입니다...');
                const [summary, bySector, byTicker] = await Promise.all([
                    fetchJson(DATA_URLS.summary),
                    fetchJson(DATA_URLS.bySector),
                    fetchJson(DATA_URLS.byTicker)
                ]);
                state.summary = summary;
                state.bySector = bySector;
                state.byTicker = byTicker;

                // Select defaults
                const quarters = state.summary?.metadata?.quarters_covered || [];
                state.selectedChangesQuarter = quarters[0] || null;

                initializeSelectors();
                bindEvents();

                hideLoading();
                renderOverview();
            } catch (e) {
                console.error(e);
                hideLoading();
                showError('초기 데이터를 불러오는 데 실패했습니다. 경로를 확인하세요.');
            }
        }

        function initializeSelectors() {
            const investors = Object.entries(state.summary?.investors || {})
                .map(([key, v]) => ({ value: key, text: `${v?.name || key} (${v?.group || '-'})` }));

            tom.investor = new TomSelect('#investorSelect', {
                create: false,
                options: investors,
                sortField: { field: 'text', direction: 'asc' },
                placeholder: '기관 투자자 검색...'
            });

            const tickers = Object.keys(state.byTicker || {}).map(t => ({ value: t, text: t }));
            tom.ticker = new TomSelect('#tickerSelect', {
                create: false,
                options: tickers,
                sortField: { field: 'text', direction: 'asc' },
                placeholder: '티커 또는 회사명 검색...'
            });

            const quarters = state.summary?.metadata?.quarters_covered || [];
            ui.changesQuarterSelect().innerHTML = quarters.map(q => `<option value="${escapeHtml(q)}">${escapeHtml(q)}</option>`).join('');
            ui.changesQuarterSelect().value = state.selectedChangesQuarter;
        }

        function bindEvents() {
            tom.investor.on('change', async (val) => {
                state.selectedInvestor = val || null;
                state.selectedInvestorQuarter = null;
                if (state.currentTab === 'investor') await renderInvestor();
            });

            tom.ticker.on('change', async (val) => {
                state.selectedTicker = val || null;
                if (state.currentTab === 'stock') await renderStock();
            });

            ui.investorQuarterSelect().addEventListener('change', async (e) => {
                state.selectedInvestorQuarter = e.target.value;
                if (state.currentTab === 'investor') await renderInvestor();
            });

            ui.changesQuarterSelect().addEventListener('change', async (e) => {
                state.selectedChangesQuarter = e.target.value;
                if (state.currentTab === 'changes') await renderChanges();
            });

            ui.investorExportBtn().addEventListener('click', async () => {
                if (!state.selectedInvestor) return;
                try {
                    const inv = await loadInvestor(state.selectedInvestor);
                    const quarter = state.selectedInvestorQuarter || inv.metadata?.quarters_covered?.[0] || inv.filings?.[0]?.quarter;
                    const filing = getQuarterFiling(inv.filings, quarter) || inv.filings?.[0];
                    const agg = aggregateHoldings(filing?.holdings || []);
                    const rows = [['ticker','name','shares','market_value','weight']];
                    for (const h of [...agg.values()].sort((a,b) => Number(b.market_value)-Number(a.market_value))) {
                        rows.push([h.ticker, h.name, h.shares, h.market_value, h.weight]);
                    }
                    downloadCsv(`sec-13f_${state.selectedInvestor}_${quarter}.csv`, rows);
                } catch (e) {
                    console.error(e);
                    showError('CSV 내보내기에 실패했습니다.');
                }
            });
        }

        // Legacy function placeholder referenced by older code
        function bindEventsLegacy() {}

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
