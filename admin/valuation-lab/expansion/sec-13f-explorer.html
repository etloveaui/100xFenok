<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SEC-13F Guru Tracker Explorer - 100xFenok</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 20px;
    }

    /* Loading State */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #e5e7eb;
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Content Tabs */
    .content-tab {
      padding: 12px 20px;
      border-radius: 8px 8px 0 0;
      font-weight: 600;
      transition: all 0.2s;
      cursor: pointer;
      border: none;
      font-size: 14px;
      background: transparent;
      color: #64748b;
      border-bottom: 3px solid transparent;
    }
    .content-tab.active {
      background: white;
      color: #3b82f6;
      border-bottom-color: #3b82f6;
    }
    .content-tab:not(.active):hover {
      background: rgba(255,255,255,0.5);
      color: #475569;
    }
    .content-section {
      display: none;
    }
    .content-section.active {
      display: block;
    }

    /* Table */
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; }
    th { background: #f9fafb; font-weight: 600; font-size: 12px; text-transform: uppercase; color: #6b7280; cursor: pointer; }
    tbody tr { transition: all 0.2s; cursor: pointer; }
    tbody tr:hover { background: #eff6ff; }

    /* Badge */
    .badge { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 500; }
    .badge-value { background: #dbeafe; color: #1e40af; }
    .badge-macro { background: #fef3c7; color: #92400e; }
    .badge-hedge { background: #fce7f3; color: #9d174d; }
    .badge-quant { background: #e0e7ff; color: #3730a3; }
    .badge-growth { background: #d1fae5; color: #065f46; }
    .badge-activist { background: #fee2e2; color: #991b1b; }
    .badge-event { background: #f3e8ff; color: #6b21a8; }

    /* Investor Card */
    .investor-card {
      transition: all 0.3s;
      cursor: pointer;
      border: 2px solid transparent;
    }
    .investor-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      border-color: #3b82f6;
    }

    /* Chart Container */
    .chart-container { height: 400px; position: relative; }

    /* Value colors */
    .positive { color: #16a34a; }
    .negative { color: #dc2626; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }

    /* Heatmap */
    .heatmap-cell {
      padding: 8px;
      text-align: center;
      font-size: 11px;
      font-weight: 500;
      border-radius: 4px;
      min-width: 60px;
    }

    /* TomSelect Custom */
    .ts-wrapper { min-width: 280px; }
    .ts-control { border-radius: 8px !important; padding: 8px 12px !important; }
    .ts-dropdown { border-radius: 8px !important; }
    .ts-dropdown-content { max-height: 300px; }

    /* Filter Tabs */
    .filter-btn {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid #e5e7eb;
      background: white;
    }
    .filter-btn.active { background: #3b82f6; color: white; border-color: #3b82f6; }
    .filter-btn:not(.active):hover { background: #f8fafc; }

    /* Change indicators */
    .change-new { background: #dcfce7; color: #166534; }
    .change-increased { background: #dbeafe; color: #1e40af; }
    .change-decreased { background: #fef3c7; color: #92400e; }
    .change-sold { background: #fee2e2; color: #991b1b; }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="spinner"></div>
    <p class="text-gray-600 mt-4">SEC 13F 데이터 로딩 중...</p>
    <p class="text-gray-400 text-sm mt-2">17명 구루 • 500+ 종목 • 8분기 데이터</p>
  </div>

  <div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="card">
      <div class="flex items-center justify-between flex-wrap gap-3">
        <div>
          <h1 class="text-2xl font-bold text-gray-800">
            <i class="fas fa-user-tie text-blue-500 mr-2"></i>SEC-13F Guru Tracker Premium
          </h1>
          <p class="text-gray-500">17명 구루 포트폴리오 • 500+ 종목 • 8분기 • 정렬 & 필터 • 단축키</p>
          <p class="text-xs text-gray-400 mt-1">
            Shortcuts: 1-5 (tabs) • Ctrl+K (search) • Ctrl+E (export)
          </p>
        </div>
        <div class="flex items-center gap-2">
          <span id="dataInfo" class="text-xs text-gray-400"></span>
          <a href="../" class="text-blue-500 hover:underline ml-2">← 뒤로</a>
        </div>
      </div>
    </div>

    <!-- Content Tabs -->
    <div class="flex gap-1 bg-blue-100 rounded-t-lg p-1 mb-0 overflow-x-auto">
      <button class="content-tab active" data-tab="overview" onclick="setContentTab('overview')">
        <i class="fas fa-th-large mr-2"></i>Overview
      </button>
      <button class="content-tab" data-tab="investor" onclick="setContentTab('investor')">
        <i class="fas fa-user-tie mr-2"></i>Investor
      </button>
      <button class="content-tab" data-tab="stock" onclick="setContentTab('stock')">
        <i class="fas fa-search-dollar mr-2"></i>Stock Lookup
      </button>
      <button class="content-tab" data-tab="sector" onclick="setContentTab('sector')">
        <i class="fas fa-industry mr-2"></i>Sector
      </button>
      <button class="content-tab" data-tab="changes" onclick="setContentTab('changes')">
        <i class="fas fa-exchange-alt mr-2"></i>Changes
      </button>
    </div>

    <!-- ==================== TAB 1: OVERVIEW ==================== -->
    <div id="section-overview" class="content-section active">
      <div class="card" style="border-top-left-radius: 0; border-top-right-radius: 0;">
        <!-- Summary Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
          <div class="bg-blue-50 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-blue-600" id="totalAum">-</div>
            <div class="text-xs text-gray-500">Total AUM</div>
          </div>
          <div class="bg-green-50 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-green-600" id="investorCount">17</div>
            <div class="text-xs text-gray-500">Investors</div>
          </div>
          <div class="bg-purple-50 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-purple-600" id="quartersCovered">8</div>
            <div class="text-xs text-gray-500">Quarters</div>
          </div>
          <div class="bg-amber-50 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-amber-600" id="stockCount">-</div>
            <div class="text-xs text-gray-500">Stocks Tracked</div>
          </div>
        </div>

        <!-- Filter by Group -->
        <div class="flex flex-wrap gap-2 mb-4">
          <button class="filter-btn active" data-group="all" onclick="filterInvestors('all')">전체</button>
          <button class="filter-btn" data-group="value" onclick="filterInvestors('value')">Value</button>
          <button class="filter-btn" data-group="macro" onclick="filterInvestors('macro')">Macro</button>
          <button class="filter-btn" data-group="hedge" onclick="filterInvestors('hedge')">Hedge</button>
          <button class="filter-btn" data-group="quant" onclick="filterInvestors('quant')">Quant</button>
          <button class="filter-btn" data-group="growth" onclick="filterInvestors('growth')">Growth</button>
          <button class="filter-btn" data-group="activist" onclick="filterInvestors('activist')">Activist</button>
          <button class="filter-btn" data-group="event" onclick="filterInvestors('event')">Event</button>
        </div>

        <!-- Investor Cards Grid -->
        <h2 class="text-lg font-bold text-gray-800 mb-3">
          <i class="fas fa-users text-blue-500 mr-2"></i>Guru Portfolio Overview
        </h2>
        <div id="investorCardsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6"></div>

        <!-- Top 20 Stocks -->
        <h2 class="text-lg font-bold text-gray-800 mb-3">
          <i class="fas fa-star text-amber-500 mr-2"></i>Top 20 Most Popular Stocks
        </h2>
        <div style="overflow-x: auto;">
          <table id="topStocksTable">
            <thead>
              <tr>
                <th>Rank</th>
                <th>Ticker</th>
                <th>Holders</th>
                <th>Total Value</th>
              </tr>
            </thead>
            <tbody id="topStocksBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ==================== TAB 2: INVESTOR PORTFOLIO ==================== -->
    <div id="section-investor" class="content-section">
      <div class="card" style="border-top-left-radius: 0; border-top-right-radius: 0;">
        <div class="flex items-center justify-between mb-4 flex-wrap gap-3">
          <h2 class="text-lg font-bold text-gray-800">
            <i class="fas fa-briefcase text-blue-500 mr-2"></i>Investor Portfolio
          </h2>
          <div class="flex items-center gap-3">
            <label class="text-sm text-gray-600">Investor:</label>
            <select id="investorSelector" class="p-2 border rounded-lg text-sm"></select>
            <label class="text-sm text-gray-600 ml-4">Quarter:</label>
            <select id="quarterSelector" class="p-2 border rounded-lg text-sm"></select>
          </div>
        </div>

        <!-- Investor Profile -->
        <div id="investorProfile" class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4 mb-4 hidden">
          <div class="flex items-center gap-4 flex-wrap">
            <div class="text-4xl"><i class="fas fa-user-circle text-blue-400"></i></div>
            <div class="flex-1">
              <div class="flex items-center gap-2">
                <span id="profileName" class="text-xl font-bold text-gray-800"></span>
                <span id="profileBadge" class="badge"></span>
              </div>
              <div id="profileEntity" class="text-sm text-gray-500"></div>
            </div>
            <div class="grid grid-cols-3 gap-6 text-center">
              <div>
                <div id="profileAum" class="text-lg font-bold text-blue-600">-</div>
                <div class="text-xs text-gray-500">AUM</div>
              </div>
              <div>
                <div id="profileHoldings" class="text-lg font-bold text-green-600">-</div>
                <div class="text-xs text-gray-500">Holdings</div>
              </div>
              <div>
                <div id="profileTop10" class="text-lg font-bold text-purple-600">-</div>
                <div class="text-xs text-gray-500">Top 10 Weight</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Portfolio Pie Chart -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
          <div>
            <h3 class="text-sm font-bold text-gray-700 mb-2">Portfolio Composition (Top 10)</h3>
            <div class="chart-container" style="height: 300px;">
              <canvas id="portfolioChart"></canvas>
            </div>
          </div>
          <div>
            <h3 class="text-sm font-bold text-gray-700 mb-2">Quarterly Changes Summary</h3>
            <div id="changesSummary" class="space-y-2"></div>
          </div>
        </div>

        <!-- Holdings Table -->
        <h3 class="text-sm font-bold text-gray-700 mb-2">All Holdings</h3>
        <div class="flex flex-wrap gap-2 mb-3">
          <button class="filter-btn active" data-change="all" onclick="filterHoldings('all')">전체</button>
          <button class="filter-btn" data-change="NEW" onclick="filterHoldings('NEW')">NEW</button>
          <button class="filter-btn" data-change="INCREASED" onclick="filterHoldings('INCREASED')">INCREASED</button>
          <button class="filter-btn" data-change="DECREASED" onclick="filterHoldings('DECREASED')">DECREASED</button>
          <button class="filter-btn" data-change="SOLD" onclick="filterHoldings('SOLD')">SOLD</button>
        </div>
        <div style="overflow-x: auto; max-height: 400px;">
          <table>
            <thead>
              <tr>
                <th onclick="sortHoldings('ticker')">Ticker</th>
                <th onclick="sortHoldings('name')">Name</th>
                <th onclick="sortHoldings('shares')">Shares</th>
                <th onclick="sortHoldings('value')">Value</th>
                <th onclick="sortHoldings('weight')">Weight</th>
                <th>Change</th>
              </tr>
            </thead>
            <tbody id="holdingsBody"></tbody>
          </table>
        </div>
        <div id="holdingsPagination" class="mt-3"></div>
        <button onclick="exportHoldingsCSV()" class="mt-3 px-4 py-2 bg-blue-500 text-white rounded-lg text-sm hover:bg-blue-600">
          <i class="fas fa-download mr-1"></i>Export CSV
        </button>
      </div>
    </div>

    <!-- ==================== TAB 3: STOCK LOOKUP ==================== -->
    <div id="section-stock" class="content-section">
      <div class="card" style="border-top-left-radius: 0; border-top-right-radius: 0;">
        <div class="flex items-center justify-between mb-4 flex-wrap gap-3">
          <h2 class="text-lg font-bold text-gray-800">
            <i class="fas fa-search-dollar text-green-500 mr-2"></i>Stock Lookup - Who Owns This?
          </h2>
          <div class="flex items-center gap-3">
            <label class="text-sm text-gray-600">Stock:</label>
            <select id="stockSelector" class="p-2 border rounded-lg text-sm"></select>
          </div>
        </div>

        <!-- Stock Summary -->
        <div id="stockSummary" class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg p-4 mb-4 hidden">
          <div class="flex items-center gap-4 flex-wrap">
            <div class="text-4xl"><i class="fas fa-chart-line text-green-400"></i></div>
            <div class="flex-1">
              <span id="stockTicker" class="text-xl font-bold text-gray-800"></span>
            </div>
            <div class="grid grid-cols-2 gap-6 text-center">
              <div>
                <div id="stockHolders" class="text-lg font-bold text-green-600">-</div>
                <div class="text-xs text-gray-500">Holders</div>
              </div>
              <div>
                <div id="stockTotalShares" class="text-lg font-bold text-blue-600">-</div>
                <div class="text-xs text-gray-500">Total Shares</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Holders Chart -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
          <div>
            <h3 class="text-sm font-bold text-gray-700 mb-2">Holder Distribution by Group</h3>
            <div class="chart-container" style="height: 300px;">
              <canvas id="holderGroupChart"></canvas>
            </div>
          </div>
          <div>
            <h3 class="text-sm font-bold text-gray-700 mb-2">Top Holders by Weight</h3>
            <div class="chart-container" style="height: 300px;">
              <canvas id="holderWeightChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Holders Table -->
        <h3 class="text-sm font-bold text-gray-700 mb-2">All Holders</h3>
        <div class="flex flex-wrap gap-2 mb-3">
          <button class="filter-btn active" data-group="all" onclick="filterStockHolders('all')">전체</button>
          <button class="filter-btn" data-group="value" onclick="filterStockHolders('value')">Value</button>
          <button class="filter-btn" data-group="macro" onclick="filterStockHolders('macro')">Macro</button>
          <button class="filter-btn" data-group="hedge" onclick="filterStockHolders('hedge')">Hedge</button>
          <button class="filter-btn" data-group="quant" onclick="filterStockHolders('quant')">Quant</button>
        </div>
        <div class="flex flex-wrap gap-3 mb-3">
          <label class="text-sm text-gray-600">Min Weight:</label>
          <select id="stockMinWeight" class="p-1 border rounded text-sm" onchange="filterStockByWeight()">
            <option value="0">All</option>
            <option value="0.01">1%+</option>
            <option value="0.02">2%+</option>
            <option value="0.05">5%+</option>
            <option value="0.10">10%+</option>
          </select>
        </div>
        <div style="overflow-x: auto; max-height: 400px;">
          <table>
            <thead>
              <tr>
                <th>Rank</th>
                <th>Investor</th>
                <th>Group</th>
                <th>Shares</th>
                <th>Weight</th>
              </tr>
            </thead>
            <tbody id="stockHoldersBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ==================== TAB 4: SECTOR ANALYSIS ==================== -->
    <div id="section-sector" class="content-section">
      <div class="card" style="border-top-left-radius: 0; border-top-right-radius: 0;">
        <h2 class="text-lg font-bold text-gray-800 mb-4">
          <i class="fas fa-industry text-purple-500 mr-2"></i>Sector Analysis
        </h2>

        <!-- Sector Overview Cards -->
        <div id="sectorCards" class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6"></div>

        <!-- Investor-Sector Heatmap -->
        <h3 class="text-sm font-bold text-gray-700 mb-3">Investor-Sector Heatmap (Avg Weight)</h3>
        <div style="overflow-x: auto;">
          <div id="heatmapContainer" class="min-w-[800px]"></div>
        </div>

        <!-- Sector Detail -->
        <h3 class="text-sm font-bold text-gray-700 mt-6 mb-3">Sector Details</h3>
        <div id="sectorDetails" class="space-y-3"></div>
      </div>
    </div>

    <!-- ==================== TAB 5: PORTFOLIO CHANGES ==================== -->
    <div id="section-changes" class="content-section">
      <div class="card" style="border-top-left-radius: 0; border-top-right-radius: 0;">
        <div class="flex items-center justify-between mb-4 flex-wrap gap-3">
          <h2 class="text-lg font-bold text-gray-800">
            <i class="fas fa-exchange-alt text-orange-500 mr-2"></i>Portfolio Changes
          </h2>
          <div class="flex items-center gap-3">
            <label class="text-sm text-gray-600">Quarter:</label>
            <select id="changesQuarterSelector" class="p-2 border rounded-lg text-sm"></select>
          </div>
        </div>

        <!-- Top Buys/Sells -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
          <div>
            <h3 class="text-sm font-bold text-green-600 mb-2">
              <i class="fas fa-arrow-up mr-1"></i>Top Buys This Quarter
            </h3>
            <div id="topBuysTable" style="overflow-x: auto; max-height: 300px;"></div>
          </div>
          <div>
            <h3 class="text-sm font-bold text-red-600 mb-2">
              <i class="fas fa-arrow-down mr-1"></i>Top Sells This Quarter
            </h3>
            <div id="topSellsTable" style="overflow-x: auto; max-height: 300px;"></div>
          </div>
        </div>

        <!-- AUM Trend Chart -->
        <h3 class="text-sm font-bold text-gray-700 mb-2">AUM Trend (8 Quarters)</h3>
        <div class="flex flex-wrap gap-2 mb-3" id="aumToggleContainer"></div>
        <div class="chart-container">
          <canvas id="aumTrendChart"></canvas>
        </div>
      </div>
    </div>

  </div>

  <script>
    // ==================== GLOBAL STATE ====================
    const BASE_PATH = '/data/sec-13f';
    let summaryData = null;
    let bySectorData = null;
    let byTickerData = null;
    let investorCache = {};
    let currentTab = 'overview';
    let currentInvestor = null;
    let currentQuarter = null;
    let currentStock = null;

    // TomSelect instances
    let investorSelect = null;
    let stockSelect = null;

    // Chart instances
    let portfolioChart = null;
    let holderGroupChart = null;
    let holderWeightChart = null;
    let aumTrendChart = null;

    // ==================== UTILITY FUNCTIONS ====================
    async function mapLimit(items, limit, fn) {
      const results = new Array(items.length);
      let idx = 0;
      const workers = new Array(Math.min(limit, items.length)).fill(0).map(async () => {
        while (idx < items.length) {
          const myIdx = idx++;
          results[myIdx] = await fn(items[myIdx], myIdx);
        }
      });
      await Promise.all(workers);
      return results;
    }

    // Holdings table sorting and pagination state
    let holdingsSortKey = 'weight';
    let holdingsSortAsc = false;
    let holdingsPage = 1;
    const HOLDINGS_PER_PAGE = 50;

    function sortHoldings(key) {
      if (holdingsSortKey === key) {
        holdingsSortAsc = !holdingsSortAsc;
      } else {
        holdingsSortKey = key;
        holdingsSortAsc = false; // Default descending
      }

      holdingsPage = 1; // Reset page on sort

      // Re-render with current filter
      if (currentInvestor && investorCache[currentInvestor]) {
        const filing = investorCache[currentInvestor].investor.filings
          .find(f => f.quarter === currentQuarter);
        if (filing) {
          const currentFilter = document.querySelector('[data-change].active')?.dataset.change || 'all';
          renderHoldingsTable(filing.holdings, currentFilter);
        }
      }
    }

    function getSortIcon(key) {
      if (holdingsSortKey !== key) return '<i class="fas fa-sort text-gray-300 ml-1"></i>';
      return holdingsSortAsc
        ? '<i class="fas fa-sort-up text-blue-500 ml-1"></i>'
        : '<i class="fas fa-sort-down text-blue-500 ml-1"></i>';
    }
    function formatCurrency(value) {
      if (value >= 1e12) return `$${(value / 1e12).toFixed(2)}T`;
      if (value >= 1e9) return `$${(value / 1e9).toFixed(1)}B`;
      if (value >= 1e6) return `$${(value / 1e6).toFixed(1)}M`;
      return `$${value.toLocaleString()}`;
    }

    function formatNumber(value) {
      if (value >= 1e9) return `${(value / 1e9).toFixed(2)}B`;
      if (value >= 1e6) return `${(value / 1e6).toFixed(1)}M`;
      if (value >= 1e3) return `${(value / 1e3).toFixed(1)}K`;
      return value.toLocaleString();
    }

    function formatPercent(value) {
      return `${(value * 100).toFixed(2)}%`;
    }

    function getGroupBadge(group) {
      const classes = {
        'value': 'badge-value',
        'macro': 'badge-macro',
        'hedge': 'badge-hedge',
        'quant': 'badge-quant',
        'growth': 'badge-growth',
        'activist': 'badge-activist',
        'event': 'badge-event'
      };
      return `<span class="badge ${classes[group] || 'badge-value'}">${group.toUpperCase()}</span>`;
    }

    function getChangeClass(change) {
      const classes = {
        'NEW': 'change-new',
        'INCREASED': 'change-increased',
        'DECREASED': 'change-decreased',
        'SOLD': 'change-sold'
      };
      return classes[change] || '';
    }

    // ==================== DATA LOADING ====================
    async function loadAllData() {
      try {
        const [summary, bySector, byTicker] = await Promise.all([
          fetch(`${BASE_PATH}/summary.json`).then(r => r.json()),
          fetch(`${BASE_PATH}/by_sector.json`).then(r => r.json()),
          fetch(`${BASE_PATH}/by_ticker.json`).then(r => r.json())
        ]);
        
        summaryData = summary;
        bySectorData = bySector;
        byTickerData = byTicker;

        return true;
      } catch (error) {
        console.error('Failed to load data:', error);
        return false;
      }
    }

    async function loadInvestor(name) {
      if (investorCache[name]) return investorCache[name];
      
      try {
        const data = await fetch(`${BASE_PATH}/investors/${name}.json`).then(r => r.json());
        investorCache[name] = data;
        return data;
      } catch (error) {
        console.error(`Failed to load investor ${name}:`, error);
        return null;
      }
    }

    // ==================== TAB MANAGEMENT ====================
    function setContentTab(tab) {
      currentTab = tab;
      
      document.querySelectorAll('.content-tab').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tab);
      });
      
      document.querySelectorAll('.content-section').forEach(section => {
        section.classList.toggle('active', section.id === `section-${tab}`);
      });

      // Initialize tab-specific content
      if (tab === 'investor' && !currentInvestor) {
        const firstInvestor = Object.keys(summaryData.investors)[0];
        investorSelect?.setValue(firstInvestor);
      }
      if (tab === 'stock' && !currentStock) {
        const firstStock = Object.keys(byTickerData)[0];
        stockSelect?.setValue(firstStock);
      }
      if (tab === 'sector') {
        renderSectorAnalysis();
      }
      if (tab === 'changes') {
        renderChangesTab();
      }
    }

    // ==================== TAB 1: OVERVIEW ====================
    function renderOverview() {
      // Summary stats
      const totalAum = Object.values(summaryData.investors)
        .reduce((sum, inv) => sum + inv.aum, 0);
      document.getElementById('totalAum').textContent = formatCurrency(totalAum);
      document.getElementById('investorCount').textContent = summaryData.metadata.investor_count;
      document.getElementById('quartersCovered').textContent = summaryData.metadata.quarters_covered.length;
      document.getElementById('stockCount').textContent = Object.keys(byTickerData).length;
      document.getElementById('dataInfo').textContent = `Data: ${summaryData.metadata.quarters_covered[0]}`;

      // Investor cards
      renderInvestorCards('all');

      // Top stocks table
      renderTopStocksTable();
    }

    function renderInvestorCards(groupFilter) {
      const container = document.getElementById('investorCardsGrid');
      const investors = Object.entries(summaryData.investors);
      
      const filtered = groupFilter === 'all' 
        ? investors 
        : investors.filter(([_, inv]) => inv.group === groupFilter);

      container.innerHTML = filtered.map(([key, inv]) => `
        <div class="investor-card card p-4" onclick="viewInvestor('${key}')">
          <div class="flex items-center justify-between mb-2">
            <span class="font-bold text-gray-800">${inv.name}</span>
            ${getGroupBadge(inv.group)}
          </div>
          <div class="text-2xl font-bold text-blue-600 mb-1">${formatCurrency(inv.aum)}</div>
          <div class="text-xs text-gray-500 mb-2">${inv.holdings_count} holdings • ${inv.quarter}</div>
          <div class="text-xs text-gray-400">
            Top 5: ${inv.top5.slice(0, 5).join(', ')}
          </div>
        </div>
      `).join('');
    }

    function filterInvestors(group) {
      document.querySelectorAll('[data-group]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.group === group);
      });
      renderInvestorCards(group);
    }

    function renderTopStocksTable() {
      const tbody = document.getElementById('topStocksBody');
      const stocks = Object.entries(summaryData.top_stocks)
        .sort((a, b) => b[1].total_value - a[1].total_value);

      tbody.innerHTML = stocks.map(([ticker, data], idx) => `
        <tr onclick="viewStock('${ticker}')">
          <td class="font-bold text-gray-400">${idx + 1}</td>
          <td class="font-bold text-blue-600">${ticker}</td>
          <td>${data.holders}</td>
          <td class="mono">${formatCurrency(data.total_value)}</td>
        </tr>
      `).join('');
    }

    function viewInvestor(key) {
      setContentTab('investor');
      investorSelect?.setValue(key);
    }

    function viewStock(ticker) {
      setContentTab('stock');
      stockSelect?.setValue(ticker);
    }

    // ==================== TAB 2: INVESTOR PORTFOLIO ====================
    async function renderInvestorPortfolio(investorKey) {
      if (!investorKey) return;
      
      currentInvestor = investorKey;
      const investorData = await loadInvestor(investorKey);
      if (!investorData) return;

      const summaryInfo = summaryData.investors[investorKey];
      const profile = document.getElementById('investorProfile');
      profile.classList.remove('hidden');

      // Profile info
      document.getElementById('profileName').textContent = investorData.investor.name;
      document.getElementById('profileBadge').innerHTML = getGroupBadge(investorData.investor.group);
      document.getElementById('profileEntity').textContent = investorData.investor.entity;

      // Populate quarter selector
      const quarterSelector = document.getElementById('quarterSelector');
      quarterSelector.innerHTML = investorData.metadata.quarters_covered
        .map(q => `<option value="${q}">${q}</option>`).join('');
      
      currentQuarter = quarterSelector.value;
      quarterSelector.onchange = () => {
        currentQuarter = quarterSelector.value;
        renderQuarterData(investorData, currentQuarter);
      };

      renderQuarterData(investorData, currentQuarter);
    }

    function renderQuarterData(investorData, quarter) {
      const filing = investorData.investor.filings.find(f => f.quarter === quarter);
      if (!filing) return;

      // Profile stats
      document.getElementById('profileAum').textContent = formatCurrency(filing.aum_total);
      document.getElementById('profileHoldings').textContent = filing.holdings_count;
      document.getElementById('profileTop10').textContent = formatPercent(filing.top_10_weight);

      // Holdings table
      renderHoldingsTable(filing.holdings);

      // Portfolio chart
      renderPortfolioChart(filing.holdings);

      // Changes summary
      renderChangesSummary(filing.holdings);
    }

    function renderHoldingsTable(holdings, filter = 'all') {
      const tbody = document.getElementById('holdingsBody');
      const thead = tbody.parentElement.querySelector('thead tr');

      // Aggregate by ticker
      const aggregated = {};
      holdings.forEach(h => {
        if (!aggregated[h.ticker]) {
          aggregated[h.ticker] = { ...h, shares: 0, market_value: 0, weight: 0 };
        }
        aggregated[h.ticker].shares += h.shares;
        aggregated[h.ticker].market_value += h.market_value;
        aggregated[h.ticker].weight += h.weight;
      });

      let filtered = Object.values(aggregated);
      if (filter !== 'all') {
        filtered = filtered.filter(h => h.change === filter);
      }

      // Apply sorting
      filtered.sort((a, b) => {
        let valA = a[holdingsSortKey];
        let valB = b[holdingsSortKey];
        if (typeof valA === 'string') {
          return holdingsSortAsc ? valA.localeCompare(valB) : valB.localeCompare(valA);
        }
        return holdingsSortAsc ? valA - valB : valB - valA;
      });

      // Update table headers with sort icons
      thead.innerHTML = `
        <th onclick="sortHoldings('ticker')" class="cursor-pointer">Ticker ${getSortIcon('ticker')}</th>
        <th onclick="sortHoldings('name')" class="cursor-pointer">Name ${getSortIcon('name')}</th>
        <th onclick="sortHoldings('shares')" class="cursor-pointer">Shares ${getSortIcon('shares')}</th>
        <th onclick="sortHoldings('market_value')" class="cursor-pointer">Value ${getSortIcon('market_value')}</th>
        <th onclick="sortHoldings('weight')" class="cursor-pointer">Weight ${getSortIcon('weight')}</th>
        <th>Change</th>
      `;

      // Apply pagination
      const totalPages = Math.ceil(filtered.length / HOLDINGS_PER_PAGE);
      const startIdx = (holdingsPage - 1) * HOLDINGS_PER_PAGE;
      const endIdx = startIdx + HOLDINGS_PER_PAGE;
      const paged = filtered.slice(startIdx, endIdx);

      tbody.innerHTML = paged.map(h => `
        <tr onclick="viewStock('${h.ticker}')">
          <td class="font-bold text-blue-600">${h.ticker}</td>
          <td class="text-sm">${h.name}</td>
          <td class="mono">${formatNumber(h.shares)}</td>
          <td class="mono">${formatCurrency(h.market_value)}</td>
          <td class="mono">${formatPercent(h.weight)}</td>
          <td><span class="badge ${getChangeClass(h.change)}">${h.change || '-'}</span></td>
        </tr>
      `).join('');

      // Render pagination controls
      const paginationContainer = document.getElementById('holdingsPagination');
      if (paginationContainer) {
        paginationContainer.innerHTML = `
          <div class="flex items-center justify-between">
            <span class="text-sm text-gray-500">
              Showing ${startIdx + 1}-${Math.min(endIdx, filtered.length)} of ${filtered.length}
            </span>
            <div class="flex gap-2">
              <button onclick="prevHoldingsPage()" ${holdingsPage === 1 ? 'disabled' : ''}
                      class="px-3 py-1 border rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fas fa-chevron-left"></i>
              </button>
              <span class="px-3 py-1">${holdingsPage} / ${totalPages || 1}</span>
              <button onclick="nextHoldingsPage()" ${endIdx >= filtered.length ? 'disabled' : ''}
                      class="px-3 py-1 border rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          </div>
        `;
      }
    }

    function prevHoldingsPage() {
      if (holdingsPage > 1) {
        holdingsPage--;
        if (currentInvestor && investorCache[currentInvestor]) {
          const filing = investorCache[currentInvestor].investor.filings
            .find(f => f.quarter === currentQuarter);
          if (filing) {
            const currentFilter = document.querySelector('[data-change].active')?.dataset.change || 'all';
            renderHoldingsTable(filing.holdings, currentFilter);
          }
        }
      }
    }

    function nextHoldingsPage() {
      holdingsPage++;
      if (currentInvestor && investorCache[currentInvestor]) {
        const filing = investorCache[currentInvestor].investor.filings
          .find(f => f.quarter === currentQuarter);
        if (filing) {
          const currentFilter = document.querySelector('[data-change].active')?.dataset.change || 'all';
          renderHoldingsTable(filing.holdings, currentFilter);
        }
      }
    }

    function filterHoldings(filter) {
      document.querySelectorAll('[data-change]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.change === filter);
      });

      holdingsPage = 1; // Reset page on filter change

      if (currentInvestor && investorCache[currentInvestor]) {
        const filing = investorCache[currentInvestor].investor.filings
          .find(f => f.quarter === currentQuarter);
        if (filing) renderHoldingsTable(filing.holdings, filter);
      }
    }

    function renderPortfolioChart(holdings) {
      // Aggregate and get top 10
      const aggregated = {};
      holdings.forEach(h => {
        if (!aggregated[h.ticker]) aggregated[h.ticker] = 0;
        aggregated[h.ticker] += h.weight;
      });

      const sorted = Object.entries(aggregated)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);

      const ctx = document.getElementById('portfolioChart').getContext('2d');
      
      if (portfolioChart) portfolioChart.destroy();
      
      portfolioChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: sorted.map(([t]) => t),
          datasets: [{
            data: sorted.map(([_, w]) => w * 100),
            backgroundColor: [
              '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
              '#ec4899', '#06b6d4', '#84cc16', '#f97316', '#6366f1'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'right' },
            tooltip: {
              callbacks: {
                label: ctx => `${ctx.label}: ${ctx.parsed.toFixed(2)}%`
              }
            }
          }
        }
      });
    }

    function renderChangesSummary(holdings) {
      const container = document.getElementById('changesSummary');
      const counts = { NEW: 0, INCREASED: 0, DECREASED: 0, SOLD: 0 };
      
      holdings.forEach(h => {
        if (h.change && counts[h.change] !== undefined) {
          counts[h.change]++;
        }
      });

      container.innerHTML = `
        <div class="flex items-center justify-between p-2 bg-green-50 rounded">
          <span class="text-sm">NEW positions</span>
          <span class="font-bold text-green-600">${counts.NEW}</span>
        </div>
        <div class="flex items-center justify-between p-2 bg-blue-50 rounded">
          <span class="text-sm">INCREASED</span>
          <span class="font-bold text-blue-600">${counts.INCREASED}</span>
        </div>
        <div class="flex items-center justify-between p-2 bg-amber-50 rounded">
          <span class="text-sm">DECREASED</span>
          <span class="font-bold text-amber-600">${counts.DECREASED}</span>
        </div>
        <div class="flex items-center justify-between p-2 bg-red-50 rounded">
          <span class="text-sm">SOLD</span>
          <span class="font-bold text-red-600">${counts.SOLD}</span>
        </div>
      `;
    }

    function exportHoldingsCSV() {
      if (!currentInvestor || !investorCache[currentInvestor]) return;

      const filing = investorCache[currentInvestor].investor.filings
        .find(f => f.quarter === currentQuarter);
      if (!filing) return;

      const rows = [['Ticker', 'Name', 'Shares', 'Value', 'Weight', 'Change']];
      filing.holdings.forEach(h => {
        rows.push([h.ticker, h.name, h.shares, h.market_value, h.weight, h.change || '']);
      });

      const BOM = '\uFEFF'; // UTF-8 BOM for Korean support
      const csv = rows.map(r => r.map(cell => {
        const s = String(cell ?? '');
        if (/[\n",]/.test(s)) return `"${s.replace(/"/g, '""')}"`;
        return s;
      }).join(',')).join('\n');

      const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${currentInvestor}_${currentQuarter}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // ==================== TAB 3: STOCK LOOKUP ====================
    function renderStockLookup(ticker) {
      if (!ticker || !byTickerData[ticker]) return;
      
      currentStock = ticker;
      const stockData = byTickerData[ticker];

      // Show summary
      const summary = document.getElementById('stockSummary');
      summary.classList.remove('hidden');
      
      document.getElementById('stockTicker').textContent = ticker;
      document.getElementById('stockHolders').textContent = new Set(stockData.holders).size;
      document.getElementById('stockTotalShares').textContent = formatNumber(stockData.total_shares);

      // Render tables and charts (with minWeight filter)
      const minWeight = parseFloat(document.getElementById('stockMinWeight')?.value || 0);
      renderStockHoldersTable(stockData, 'all', minWeight);
      renderHolderGroupChart(stockData);
      renderHolderWeightChart(stockData);
    }

    function renderStockHoldersTable(stockData, groupFilter, minWeight = 0) {
      const tbody = document.getElementById('stockHoldersBody');

      // Aggregate by investor
      const aggregated = {};
      stockData.holder_details.forEach(h => {
        if (!aggregated[h.investor]) {
          aggregated[h.investor] = { shares: 0, weight: 0 };
        }
        aggregated[h.investor].shares += h.shares;
        aggregated[h.investor].weight += h.weight;
      });

      let holders = Object.entries(aggregated)
        .map(([inv, data]) => ({
          investor: inv,
          group: summaryData.investors[inv]?.group || 'unknown',
          name: summaryData.investors[inv]?.name || inv,
          ...data
        }))
        .sort((a, b) => b.shares - a.shares);

      if (groupFilter !== 'all') {
        holders = holders.filter(h => h.group === groupFilter);
      }

      if (minWeight > 0) {
        holders = holders.filter(h => h.weight >= minWeight);
      }

      tbody.innerHTML = holders.map((h, idx) => `
        <tr onclick="viewInvestor('${h.investor}')">
          <td class="font-bold text-gray-400">${idx + 1}</td>
          <td class="font-bold text-blue-600">${h.name}</td>
          <td>${getGroupBadge(h.group)}</td>
          <td class="mono">${formatNumber(h.shares)}</td>
          <td class="mono">${formatPercent(h.weight)}</td>
        </tr>
      `).join('');
    }

    function filterStockHolders(group) {
      document.querySelectorAll('#section-stock [data-group]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.group === group);
      });

      if (currentStock && byTickerData[currentStock]) {
        const minWeight = parseFloat(document.getElementById('stockMinWeight')?.value || 0);
        renderStockHoldersTable(byTickerData[currentStock], group, minWeight);
      }
    }

    function filterStockByWeight() {
      const minWeight = parseFloat(document.getElementById('stockMinWeight').value);
      const groupFilter = document.querySelector('#section-stock [data-group].active')?.dataset.group || 'all';

      if (currentStock && byTickerData[currentStock]) {
        renderStockHoldersTable(byTickerData[currentStock], groupFilter, minWeight);
      }
    }

    function renderHolderGroupChart(stockData) {
      // Count by group
      const groupCounts = {};
      const seen = new Set();
      
      stockData.holder_details.forEach(h => {
        if (seen.has(h.investor)) return;
        seen.add(h.investor);
        const group = summaryData.investors[h.investor]?.group || 'unknown';
        groupCounts[group] = (groupCounts[group] || 0) + 1;
      });

      const ctx = document.getElementById('holderGroupChart').getContext('2d');
      
      if (holderGroupChart) holderGroupChart.destroy();
      
      holderGroupChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: Object.keys(groupCounts),
          datasets: [{
            data: Object.values(groupCounts),
            backgroundColor: ['#3b82f6', '#f59e0b', '#ec4899', '#8b5cf6', '#10b981', '#ef4444', '#6366f1']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'right' } }
        }
      });
    }

    function renderHolderWeightChart(stockData) {
      // Aggregate and sort by weight
      const aggregated = {};
      stockData.holder_details.forEach(h => {
        if (!aggregated[h.investor]) aggregated[h.investor] = 0;
        aggregated[h.investor] += h.weight;
      });

      const sorted = Object.entries(aggregated)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);

      const ctx = document.getElementById('holderWeightChart').getContext('2d');
      
      if (holderWeightChart) holderWeightChart.destroy();
      
      holderWeightChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: sorted.map(([inv]) => summaryData.investors[inv]?.name || inv),
          datasets: [{
            label: 'Portfolio Weight (%)',
            data: sorted.map(([_, w]) => w * 100),
            backgroundColor: '#3b82f6'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: 'y',
          plugins: { legend: { display: false } },
          scales: {
            x: { 
              title: { display: true, text: 'Weight (%)' }
            }
          }
        }
      });
    }

    // ==================== TAB 4: SECTOR ANALYSIS ====================
    function renderSectorAnalysis() {
      renderSectorCards();
      renderHeatmap();
      renderSectorDetails();
    }

    function renderSectorCards() {
      const container = document.getElementById('sectorCards');
      const sectors = Object.entries(bySectorData);

      container.innerHTML = sectors.map(([sector, data]) => `
        <div class="bg-purple-50 rounded-lg p-3 text-center">
          <div class="font-bold text-gray-800 text-sm mb-1">${sector}</div>
          <div class="text-lg font-bold text-purple-600">${data.investors.length}</div>
          <div class="text-xs text-gray-500">investors</div>
          <div class="text-xs text-gray-400 mt-1">Avg: ${formatPercent(data.avg_weight)}</div>
        </div>
      `).join('');
    }

    function renderHeatmap() {
      const container = document.getElementById('heatmapContainer');
      const sectors = Object.keys(bySectorData);
      const investors = Object.keys(summaryData.investors);

      // Build heatmap data
      const heatmapData = {};
      sectors.forEach(sector => {
        heatmapData[sector] = {};
        const sectorInvestors = bySectorData[sector].investors;
        investors.forEach(inv => {
          heatmapData[sector][inv] = sectorInvestors.includes(inv) ? bySectorData[sector].avg_weight : 0;
        });
      });

      // Render as HTML table
      let html = '<table class="text-xs"><thead><tr><th></th>';
      sectors.forEach(s => { html += `<th class="text-center">${s.substring(0, 8)}</th>`; });
      html += '</tr></thead><tbody>';

      investors.forEach(inv => {
        const name = summaryData.investors[inv]?.name || inv;
        html += `<tr><td class="font-medium pr-2">${name.split(' ')[0]}</td>`;
        sectors.forEach(sector => {
          const weight = heatmapData[sector][inv];
          const intensity = Math.min(weight * 50, 1);
          const bgColor = weight > 0 ? `rgba(59, 130, 246, ${intensity})` : '#f8fafc';
          const textColor = intensity > 0.5 ? 'white' : '#64748b';
          html += `<td class="heatmap-cell" style="background: ${bgColor}; color: ${textColor}">
            ${weight > 0 ? formatPercent(weight) : '-'}
          </td>`;
        });
        html += '</tr>';
      });

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    function renderSectorDetails() {
      const container = document.getElementById('sectorDetails');
      const sectors = Object.entries(bySectorData);

      container.innerHTML = sectors.map(([sector, data]) => `
        <div class="bg-gray-50 rounded-lg p-3">
          <div class="font-bold text-gray-800 mb-2">${sector}</div>
          <div class="text-sm text-gray-600 mb-1">
            <strong>Top Holdings:</strong> ${data.top_holdings.join(', ')}
          </div>
          <div class="text-xs text-gray-400">
            <strong>Investors:</strong> ${data.investors.map(i => summaryData.investors[i]?.name || i).join(', ')}
          </div>
        </div>
      `).join('');
    }

    // ==================== TAB 5: PORTFOLIO CHANGES ====================
    async function renderChangesTab() {
      // Populate quarter selector
      const selector = document.getElementById('changesQuarterSelector');
      if (selector.options.length === 0) {
        selector.innerHTML = summaryData.metadata.quarters_covered
          .map(q => `<option value="${q}">${q}</option>`).join('');
        selector.onchange = () => renderChangesForQuarter(selector.value);
      }
      
      // Load all investors for comparison (use mapLimit to prevent browser freeze)
      await mapLimit(Object.keys(summaryData.investors), 3, loadInvestor);
      
      renderChangesForQuarter(selector.value);
      renderAumTrendChart();
    }

    function renderChangesForQuarter(quarter) {
      const buys = [];
      const sells = [];

      Object.keys(summaryData.investors).forEach(inv => {
        const data = investorCache[inv];
        if (!data) return;
        
        const filing = data.investor.filings.find(f => f.quarter === quarter);
        if (!filing) return;

        filing.holdings.forEach(h => {
          if (h.change === 'NEW' || h.change === 'INCREASED') {
            buys.push({ investor: inv, ...h });
          } else if (h.change === 'DECREASED' || h.change === 'SOLD') {
            sells.push({ investor: inv, ...h });
          }
        });
      });

      // Sort by value
      buys.sort((a, b) => b.market_value - a.market_value);
      sells.sort((a, b) => b.market_value - a.market_value);

      // Render tables
      document.getElementById('topBuysTable').innerHTML = renderChangesTable(buys.slice(0, 15), 'buy');
      document.getElementById('topSellsTable').innerHTML = renderChangesTable(sells.slice(0, 15), 'sell');
    }

    function renderChangesTable(items, type) {
      if (items.length === 0) return '<p class="text-gray-400 text-sm">No data</p>';
      
      return `
        <table class="text-sm">
          <thead>
            <tr>
              <th>Investor</th>
              <th>Ticker</th>
              <th>Value</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            ${items.map(item => `
              <tr>
                <td>${summaryData.investors[item.investor]?.name || item.investor}</td>
                <td class="font-bold text-blue-600">${item.ticker}</td>
                <td class="mono">${formatCurrency(item.market_value)}</td>
                <td><span class="badge ${getChangeClass(item.change)}">${item.change}</span></td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function renderAumTrendChart() {
      const quarters = summaryData.metadata.quarters_covered.slice().reverse();
      const datasets = [];
      const colors = [
        '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4',
        '#84cc16', '#f97316', '#6366f1', '#14b8a6', '#f43f5e', '#a855f7', '#22d3ee',
        '#facc15', '#fb923c', '#e879f9'
      ];

      let colorIdx = 0;
      Object.keys(summaryData.investors).forEach(inv => {
        const data = investorCache[inv];
        if (!data) return;

        const aumData = quarters.map(q => {
          const filing = data.investor.filings.find(f => f.quarter === q);
          return filing ? filing.aum_total / 1e9 : null;
        });

        datasets.push({
          label: summaryData.investors[inv].name,
          data: aumData,
          borderColor: colors[colorIdx % colors.length],
          tension: 0.3,
          fill: false
        });
        colorIdx++;
      });

      const ctx = document.getElementById('aumTrendChart').getContext('2d');
      
      if (aumTrendChart) aumTrendChart.destroy();
      
      aumTrendChart = new Chart(ctx, {
        type: 'line',
        data: { labels: quarters, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'top' },
            tooltip: {
              callbacks: {
                label: ctx => `${ctx.dataset.label}: $${ctx.parsed.y?.toFixed(1)}B`
              }
            }
          },
          scales: {
            y: {
              title: { display: true, text: 'AUM (Billions $)' }
            }
          }
        }
      });

      // Toggle buttons
      const toggleContainer = document.getElementById('aumToggleContainer');
      toggleContainer.innerHTML = Object.keys(summaryData.investors).map((inv, idx) => `
        <button class="filter-btn active" onclick="toggleAumLine(${idx})">${summaryData.investors[inv].name.split(' ')[0]}</button>
      `).join('');
    }

    function toggleAumLine(idx) {
      const meta = aumTrendChart.getDatasetMeta(idx);
      meta.hidden = !meta.hidden;
      aumTrendChart.update();
    }

    // ==================== INITIALIZATION ====================
    async function init() {
      const success = await loadAllData();
      
      if (!success) {
        document.getElementById('loadingOverlay').innerHTML = `
          <div class="text-red-500 text-center">
            <i class="fas fa-exclamation-triangle text-5xl mb-4"></i>
            <p class="text-xl font-bold">데이터 로딩 실패</p>
            <p class="text-sm mt-2">네트워크 연결을 확인하세요</p>
          </div>
        `;
        return;
      }

      // Initialize TomSelect for investors
      const investorOptions = Object.entries(summaryData.investors)
        .map(([key, inv]) => ({ value: key, text: `${inv.name} (${inv.group})` }));
      
      investorSelect = new TomSelect('#investorSelector', {
        options: investorOptions,
        onChange: value => renderInvestorPortfolio(value)
      });

      // Initialize TomSelect for stocks
      const stockOptions = Object.keys(byTickerData)
        .sort()
        .map(ticker => ({ value: ticker, text: ticker }));
      
      stockSelect = new TomSelect('#stockSelector', {
        options: stockOptions,
        onChange: value => renderStockLookup(value)
      });

      // Render initial view
      renderOverview();

      // Hide loading
      document.getElementById('loadingOverlay').style.display = 'none';
    }

    // ==================== KEYBOARD SHORTCUTS ====================
    document.addEventListener('keydown', (e) => {
      // Don't trigger if typing in input/select
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') {
        return;
      }

      // Tab navigation: 1-5
      if (e.key >= '1' && e.key <= '5' && !e.ctrlKey && !e.metaKey) {
        const tabs = ['overview', 'investor', 'stock', 'sector', 'changes'];
        const idx = parseInt(e.key) - 1;
        if (tabs[idx]) {
          setContentTab(tabs[idx]);
          e.preventDefault();
        }
      }

      // Ctrl+K: Focus search
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        if (currentTab === 'investor') investorSelect?.focus();
        if (currentTab === 'stock') stockSelect?.focus();
        e.preventDefault();
      }

      // Ctrl+E: Export CSV
      if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
        if (currentTab === 'investor' && currentInvestor) {
          exportHoldingsCSV();
          e.preventDefault();
        }
      }
    });

    // Start
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
