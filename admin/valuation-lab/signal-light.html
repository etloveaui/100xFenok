<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì‹ í˜¸ë“± ì»´í¬ë„ŒíŠ¸ - Valuation Lab</title>
  <meta name="robots" content="noindex, nofollow">
  <link rel="icon" type="image/x-icon" href="../../favicon.ico">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* ì‹ í˜¸ë“± CSS ì»´í¬ë„ŒíŠ¸ */
    .signal-light {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .signal-dot {
      width: 1rem;
      height: 1rem;
      border-radius: 50%;
      transition: all 0.3s ease;
    }

    .signal-dot.green {
      background: #16a34a;
      box-shadow: 0 0 8px rgba(22, 163, 74, 0.6);
    }

    .signal-dot.yellow {
      background: #ca8a04;
      box-shadow: 0 0 8px rgba(202, 138, 4, 0.6);
    }

    .signal-dot.red {
      background: #dc2626;
      box-shadow: 0 0 8px rgba(220, 38, 38, 0.6);
    }

    /* í„ìŠ¤ ì• ë‹ˆë©”ì´ì…˜ */
    .signal-dot.pulse {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
        opacity: 1;
      }
      50% {
        transform: scale(1.1);
        opacity: 0.8;
      }
    }

    /* ì‹ í˜¸ë“± ì¹´ë“œ */
    .signal-card {
      display: flex;
      align-items: center;
      padding: 0.75rem 1rem;
      border-radius: 0.75rem;
      background: white;
      border: 1px solid #e5e7eb;
      transition: all 0.2s ease;
    }

    .signal-card:hover {
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .signal-card.green { border-left: 4px solid #16a34a; }
    .signal-card.yellow { border-left: 4px solid #ca8a04; }
    .signal-card.red { border-left: 4px solid #dc2626; }

    /* ì‹ í˜¸ë“± ë°°ì§€ */
    .signal-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .signal-badge.green {
      background: #dcfce7;
      color: #166534;
    }

    .signal-badge.yellow {
      background: #fef9c3;
      color: #854d0e;
    }

    .signal-badge.red {
      background: #fee2e2;
      color: #991b1b;
    }

    /* 3ë‹¨ ì‹ í˜¸ë“± (ê°€ë¡œ) */
    .traffic-light-h {
      display: inline-flex;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      background: #1f2937;
      border-radius: 9999px;
    }

    .traffic-light-h .light {
      width: 1.25rem;
      height: 1.25rem;
      border-radius: 50%;
      background: #374151;
      transition: all 0.3s ease;
    }

    .traffic-light-h .light.active.green { background: #22c55e; box-shadow: 0 0 10px #22c55e; }
    .traffic-light-h .light.active.yellow { background: #eab308; box-shadow: 0 0 10px #eab308; }
    .traffic-light-h .light.active.red { background: #ef4444; box-shadow: 0 0 10px #ef4444; }

    /* 3ë‹¨ ì‹ í˜¸ë“± (ì„¸ë¡œ) */
    .traffic-light-v {
      display: inline-flex;
      flex-direction: column;
      gap: 0.375rem;
      padding: 0.75rem 0.5rem;
      background: #1f2937;
      border-radius: 0.75rem;
    }

    .traffic-light-v .light {
      width: 1.5rem;
      height: 1.5rem;
      border-radius: 50%;
      background: #374151;
      transition: all 0.3s ease;
    }

    .traffic-light-v .light.active.green { background: #22c55e; box-shadow: 0 0 12px #22c55e; }
    .traffic-light-v .light.active.yellow { background: #eab308; box-shadow: 0 0 12px #eab308; }
    .traffic-light-v .light.active.red { background: #ef4444; box-shadow: 0 0 12px #ef4444; }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-100 to-slate-200 min-h-screen">

  <!-- Shared Modules -->
  <script src="shared/constants.js"></script>
  <script src="shared/formatters.js"></script>
  <script src="shared/calculations.js"></script>
  <script src="shared/validator.js"></script>
  <script src="shared/security.js"></script>
  <script src="shared/cache-manager.js"></script>
  <script src="shared/data-manager.js"></script>
  <script src="shared/indicators.js"></script>

  <header class="py-6 border-b bg-white">
    <div class="container mx-auto px-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 bg-green-100 rounded-xl flex items-center justify-center">
            <i class="fas fa-traffic-light text-green-500"></i>
          </div>
          <div>
            <h1 class="text-xl font-bold">ì‹ í˜¸ë“± ì»´í¬ë„ŒíŠ¸</h1>
            <p class="text-gray-500 text-sm">Step 3.1 - UI ì»´í¬ë„ŒíŠ¸</p>
          </div>
        </div>
        <a href="./" class="text-gray-500 hover:text-blue-600">
          <i class="fas fa-arrow-left mr-1"></i> ì‹¤í—˜ì‹¤
        </a>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 py-8">

    <!-- ì»´í¬ë„ŒíŠ¸ ë°ëª¨ -->
    <section class="mb-8">
      <h2 class="text-lg font-semibold text-gray-700 mb-4">
        <i class="fas fa-palette text-purple-500 mr-2"></i>ì»´í¬ë„ŒíŠ¸ ìŠ¤íƒ€ì¼
      </h2>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

        <!-- ìŠ¤íƒ€ì¼ 1: ê¸°ë³¸ ì‹ í˜¸ë“± -->
        <div class="bg-white rounded-xl p-6 shadow">
          <h3 class="font-semibold mb-4 text-sm text-gray-600">1. ê¸°ë³¸ ì‹ í˜¸ë“± (Dot)</h3>
          <div class="space-y-3">
            <div class="signal-light">
              <span class="signal-dot green pulse"></span>
              <span class="text-sm">ì €í‰ê°€ (30% ì´í•˜)</span>
            </div>
            <div class="signal-light">
              <span class="signal-dot yellow pulse"></span>
              <span class="text-sm">ì ì • (30~70%)</span>
            </div>
            <div class="signal-light">
              <span class="signal-dot red pulse"></span>
              <span class="text-sm">ê³ í‰ê°€ (70% ì´ìƒ)</span>
            </div>
          </div>
        </div>

        <!-- ìŠ¤íƒ€ì¼ 2: ì‹ í˜¸ë“± ì¹´ë“œ -->
        <div class="bg-white rounded-xl p-6 shadow">
          <h3 class="font-semibold mb-4 text-sm text-gray-600">2. ì‹ í˜¸ë“± ì¹´ë“œ</h3>
          <div class="space-y-3">
            <div class="signal-card green">
              <span class="signal-dot green mr-3"></span>
              <div>
                <div class="font-semibold text-sm">P/E Percentile</div>
                <div class="text-xs text-gray-500">25% - ì €í‰ê°€</div>
              </div>
            </div>
            <div class="signal-card yellow">
              <span class="signal-dot yellow mr-3"></span>
              <div>
                <div class="font-semibold text-sm">P/B Percentile</div>
                <div class="text-xs text-gray-500">55% - ì ì •</div>
              </div>
            </div>
            <div class="signal-card red">
              <span class="signal-dot red mr-3"></span>
              <div>
                <div class="font-semibold text-sm">Z-Score</div>
                <div class="text-xs text-gray-500">+2.1Ïƒ - ê³ í‰ê°€</div>
              </div>
            </div>
          </div>
        </div>

        <!-- ìŠ¤íƒ€ì¼ 3: ë°°ì§€ -->
        <div class="bg-white rounded-xl p-6 shadow">
          <h3 class="font-semibold mb-4 text-sm text-gray-600">3. ì‹ í˜¸ë“± ë°°ì§€</h3>
          <div class="flex flex-wrap gap-2">
            <span class="signal-badge green">ğŸŸ¢ ì €í‰ê°€</span>
            <span class="signal-badge yellow">ğŸŸ¡ ì ì •</span>
            <span class="signal-badge red">ğŸ”´ ê³ í‰ê°€</span>
            <span class="signal-badge green">ğŸŸ¢ ìš°ìˆ˜</span>
            <span class="signal-badge yellow">ğŸŸ¡ ë³´í†µ</span>
            <span class="signal-badge red">ğŸ”´ ì €ì¡°</span>
          </div>
        </div>

        <!-- ìŠ¤íƒ€ì¼ 4: 3ë‹¨ ì‹ í˜¸ë“± -->
        <div class="bg-white rounded-xl p-6 shadow">
          <h3 class="font-semibold mb-4 text-sm text-gray-600">4. 3ë‹¨ ì‹ í˜¸ë“±</h3>
          <div class="flex items-center gap-8">
            <div>
              <div class="traffic-light-h mb-2">
                <span class="light active green"></span>
                <span class="light"></span>
                <span class="light"></span>
              </div>
              <p class="text-xs text-gray-500 text-center">ê°€ë¡œí˜•</p>
            </div>
            <div>
              <div class="traffic-light-v">
                <span class="light"></span>
                <span class="light active yellow"></span>
                <span class="light"></span>
              </div>
              <p class="text-xs text-gray-500 text-center mt-2">ì„¸ë¡œí˜•</p>
            </div>
            <div>
              <div class="traffic-light-v">
                <span class="light"></span>
                <span class="light"></span>
                <span class="light active red"></span>
              </div>
              <p class="text-xs text-gray-500 text-center mt-2">ê³ í‰ê°€</p>
            </div>
          </div>
        </div>

      </div>
    </section>

    <!-- ì‹¤ì‹œê°„ ë°ì´í„° ì—°ë™ -->
    <section class="mb-8">
      <h2 class="text-lg font-semibold text-gray-700 mb-4">
        <i class="fas fa-database text-blue-500 mr-2"></i>ì‹¤ì‹œê°„ ë°ì´í„° ì—°ë™
      </h2>

      <div class="bg-white rounded-xl p-6 shadow">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-2">
            <select id="benchmark-select" class="border rounded px-3 py-1.5 text-sm">
              <option value="US">US (ë¯¸êµ­)</option>
              <option value="SECTORS">ì„¹í„°</option>
              <option value="EMERGING">ì‹ í¥êµ­</option>
              <option value="DEVELOPED">ì„ ì§„êµ­</option>
            </select>
            <select id="section-select" class="border rounded px-3 py-1.5 text-sm">
              <option value="sp500">S&P 500</option>
            </select>
          </div>
          <button onclick="loadSignalData()" class="bg-blue-500 text-white px-4 py-1.5 rounded text-sm hover:bg-blue-600">
            <i class="fas fa-sync-alt mr-1"></i> ë¡œë“œ
          </button>
        </div>

        <div id="signal-display" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
          <div class="text-gray-400 text-sm col-span-full text-center py-8">
            ë²¤ì¹˜ë§ˆí¬ ì„ íƒ í›„ 'ë¡œë“œ' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”
          </div>
        </div>
      </div>
    </section>

    <!-- JavaScript API -->
    <section>
      <h2 class="text-lg font-semibold text-gray-700 mb-4">
        <i class="fas fa-code text-green-500 mr-2"></i>JavaScript API
      </h2>

      <div class="bg-white rounded-xl p-6 shadow">
        <pre class="bg-gray-900 text-green-400 p-4 rounded font-mono text-xs overflow-auto"><code>// SignalLight ì»´í¬ë„ŒíŠ¸ ì‚¬ìš©ë²•

// 1. ë‹¨ì¼ ì‹ í˜¸ë“± ìƒì„±
const signal = SignalLight.create({
  type: 'dot',        // dot | card | badge | traffic-h | traffic-v
  signal: 'green',    // green | yellow | red
  label: 'ì €í‰ê°€',
  value: '25%',
  pulse: true         // ì• ë‹ˆë©”ì´ì…˜ (ê¸°ë³¸: false)
});
container.appendChild(signal);

// 2. Indicators ê²°ê³¼ë¡œ ìë™ ìƒì„±
const peResult = Indicators.getPEPercentile(sectionData);
const signalEl = SignalLight.fromIndicator(peResult, {
  type: 'card',
  name: 'P/E Percentile'
});

// 3. ì¢…í•© ì‹ í˜¸ë“± íŒ¨ë„
const summary = await Indicators.getValuationSummary('US', 'sp500');
SignalLight.renderPanel(container, summary);</code></pre>
      </div>
    </section>

  </main>

  <script>
    /**
     * SignalLight - ì‹ í˜¸ë“± UI ì»´í¬ë„ŒíŠ¸
     * Step 3.1: Layer 1B UI
     */
    const SignalLight = (function() {

      /**
       * ì‹ í˜¸ ìƒ‰ìƒ ë§¤í•‘ (ì´ëª¨ì§€ â†’ CSS í´ë˜ìŠ¤)
       */
      function getColorClass(signal) {
        if (signal === 'ğŸŸ¢' || signal === 'green') return 'green';
        if (signal === 'ğŸŸ¡' || signal === 'yellow') return 'yellow';
        if (signal === 'ğŸ”´' || signal === 'red') return 'red';
        return 'gray';
      }

      /**
       * ê¸°ë³¸ ì‹ í˜¸ë“± ìƒì„±
       */
      function create(options) {
        const { type = 'dot', signal, label, value, pulse = false } = options;
        const color = getColorClass(signal);

        switch (type) {
          case 'dot':
            return createDot(color, label, pulse);
          case 'card':
            return createCard(color, label, value);
          case 'badge':
            return createBadge(color, label);
          case 'traffic-h':
            return createTrafficH(color);
          case 'traffic-v':
            return createTrafficV(color);
          default:
            return createDot(color, label, pulse);
        }
      }

      function createDot(color, label, pulse) {
        const wrapper = document.createElement('div');
        wrapper.className = 'signal-light';
        wrapper.innerHTML = `
          <span class="signal-dot ${color} ${pulse ? 'pulse' : ''}"></span>
          <span class="text-sm">${label || ''}</span>
        `;
        return wrapper;
      }

      function createCard(color, label, value) {
        const card = document.createElement('div');
        card.className = `signal-card ${color}`;
        card.innerHTML = `
          <span class="signal-dot ${color} mr-3"></span>
          <div>
            <div class="font-semibold text-sm">${label || ''}</div>
            <div class="text-xs text-gray-500">${value || ''}</div>
          </div>
        `;
        return card;
      }

      function createBadge(color, label) {
        const badge = document.createElement('span');
        badge.className = `signal-badge ${color}`;
        const emoji = color === 'green' ? 'ğŸŸ¢' : color === 'yellow' ? 'ğŸŸ¡' : 'ğŸ”´';
        badge.textContent = `${emoji} ${label || ''}`;
        return badge;
      }

      function createTrafficH(activeColor) {
        const wrapper = document.createElement('div');
        wrapper.className = 'traffic-light-h';
        wrapper.innerHTML = `
          <span class="light ${activeColor === 'green' ? 'active green' : ''}"></span>
          <span class="light ${activeColor === 'yellow' ? 'active yellow' : ''}"></span>
          <span class="light ${activeColor === 'red' ? 'active red' : ''}"></span>
        `;
        return wrapper;
      }

      function createTrafficV(activeColor) {
        const wrapper = document.createElement('div');
        wrapper.className = 'traffic-light-v';
        wrapper.innerHTML = `
          <span class="light ${activeColor === 'red' ? 'active red' : ''}"></span>
          <span class="light ${activeColor === 'yellow' ? 'active yellow' : ''}"></span>
          <span class="light ${activeColor === 'green' ? 'active green' : ''}"></span>
        `;
        return wrapper;
      }

      /**
       * Indicators ê²°ê³¼ë¡œ ì‹ í˜¸ë“± ìƒì„±
       */
      function fromIndicator(indicatorResult, options = {}) {
        const { type = 'card', name = '' } = options;
        const { signal, formatted, signalLabel } = indicatorResult;

        return create({
          type,
          signal,
          label: name,
          value: `${formatted} - ${signalLabel}`
        });
      }

      /**
       * ì¢…í•© íŒ¨ë„ ë Œë”ë§
       */
      function renderPanel(container, summary) {
        container.innerHTML = '';

        const indicators = [
          { key: 'pePercentile', name: 'P/E Percentile' },
          { key: 'pbPercentile', name: 'P/B Percentile' },
          { key: 'roePercentile', name: 'ROE Percentile' },
          { key: 'pegProxy', name: 'PEG Proxy' },
          { key: 'peZScore', name: 'P/E Z-Score' }
        ];

        indicators.forEach(({ key, name }) => {
          const data = summary[key];
          if (data && data.signal) {
            const card = fromIndicator(data, { type: 'card', name });
            container.appendChild(card);
          }
        });

        // ì¶”ê°€ ì •ë³´
        const infoDiv = document.createElement('div');
        infoDiv.className = 'col-span-full text-xs text-gray-500 mt-2';
        infoDiv.textContent = `ê¸°ì¤€ì¼: ${summary.date || 'N/A'}`;
        container.appendChild(infoDiv);
      }

      return {
        create,
        fromIndicator,
        renderPanel,
        getColorClass
      };

    })();

    // ========================================
    // UI ì—°ë™
    // ========================================

    const benchmarkSelect = document.getElementById('benchmark-select');
    const sectionSelect = document.getElementById('section-select');

    // ë²¤ì¹˜ë§ˆí¬ ì„ íƒ ì‹œ ì„¹ì…˜ ëª©ë¡ ì—…ë°ì´íŠ¸
    benchmarkSelect.addEventListener('change', async () => {
      const benchmark = benchmarkSelect.value;
      sectionSelect.innerHTML = '<option>ë¡œë”© ì¤‘...</option>';

      try {
        const data = await DataManager.loadBenchmark(benchmark);
        const sections = DataManager.getSectionKeys(data);

        sectionSelect.innerHTML = sections.map(s =>
          `<option value="${s}">${s}</option>`
        ).join('');
      } catch (e) {
        sectionSelect.innerHTML = '<option>ì˜¤ë¥˜</option>';
      }
    });

    // ë°ì´í„° ë¡œë“œ ë° ì‹ í˜¸ë“± í‘œì‹œ
    async function loadSignalData() {
      const benchmark = benchmarkSelect.value;
      const section = sectionSelect.value;
      const display = document.getElementById('signal-display');

      display.innerHTML = '<div class="col-span-full text-center py-4 text-gray-400">ë¡œë”© ì¤‘...</div>';

      try {
        const summary = await Indicators.getValuationSummary(benchmark, section);

        if (summary.error) {
          display.innerHTML = `<div class="col-span-full text-center py-4 text-red-500">ì˜¤ë¥˜: ${summary.error}</div>`;
          return;
        }

        SignalLight.renderPanel(display, summary);
      } catch (e) {
        display.innerHTML = `<div class="col-span-full text-center py-4 text-red-500">ì˜¤ë¥˜: ${e.message}</div>`;
      }
    }

    // ì´ˆê¸°í™”: US ì„¹ì…˜ ëª©ë¡ ë¡œë“œ
    (async () => {
      try {
        const data = await DataManager.loadBenchmark('US');
        const sections = DataManager.getSectionKeys(data);
        sectionSelect.innerHTML = sections.map(s =>
          `<option value="${s}">${s}</option>`
        ).join('');
      } catch (e) {
        console.error('ì´ˆê¸°í™” ì˜¤ë¥˜:', e);
      }
    })();
  </script>

</body>
</html>
