<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>1ë¬¸ì¥ í•´ì„ - Valuation Lab</title>
  <meta name="robots" content="noindex, nofollow">
  <link rel="icon" type="image/x-icon" href="../../favicon.ico">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* 1ë¬¸ì¥ í•´ì„ ìŠ¤íƒ€ì¼ */
    .one-liner {
      padding: 1rem 1.25rem;
      border-radius: 0.75rem;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border-left: 4px solid #94a3b8;
      font-size: 1rem;
      line-height: 1.6;
      color: #334155;
    }

    .one-liner.bullish {
      border-left-color: #16a34a;
      background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
    }

    .one-liner.neutral {
      border-left-color: #ca8a04;
      background: linear-gradient(135deg, #fefce8 0%, #fef9c3 100%);
    }

    .one-liner.bearish {
      border-left-color: #dc2626;
      background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
    }

    .one-liner .highlight {
      font-weight: 600;
      padding: 0.125rem 0.375rem;
      border-radius: 0.25rem;
      background: rgba(0, 0, 0, 0.05);
    }

    .one-liner .signal-emoji {
      font-size: 1.25rem;
      margin-right: 0.5rem;
    }

    /* ì¹´ë“œí˜• */
    .one-liner-card {
      background: white;
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .one-liner-card .header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .one-liner-card .icon {
      width: 3rem;
      height: 3rem;
      border-radius: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }

    .one-liner-card .icon.bullish { background: #dcfce7; }
    .one-liner-card .icon.neutral { background: #fef9c3; }
    .one-liner-card .icon.bearish { background: #fee2e2; }

    .one-liner-card .title {
      font-weight: 700;
      font-size: 1.125rem;
      color: #1e293b;
    }

    .one-liner-card .subtitle {
      font-size: 0.75rem;
      color: #64748b;
    }

    .one-liner-card .message {
      font-size: 1rem;
      line-height: 1.7;
      color: #475569;
    }

    /* ë¯¸ë‹ˆ ë°°ì§€ */
    .mini-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.125rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .mini-badge.green { background: #dcfce7; color: #166534; }
    .mini-badge.yellow { background: #fef9c3; color: #854d0e; }
    .mini-badge.red { background: #fee2e2; color: #991b1b; }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-100 to-slate-200 min-h-screen">

  <!-- Shared Modules -->
  <script src="shared/constants.js"></script>
  <script src="shared/formatters.js"></script>
  <script src="shared/calculations.js"></script>
  <script src="shared/validator.js"></script>
  <script src="shared/security.js"></script>
  <script src="shared/cache-manager.js"></script>
  <script src="shared/data-manager.js"></script>
  <script src="shared/indicators.js"></script>

  <header class="py-6 border-b bg-white">
    <div class="container mx-auto px-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center">
            <i class="fas fa-comment text-blue-500"></i>
          </div>
          <div>
            <h1 class="text-xl font-bold">1ë¬¸ì¥ í•´ì„</h1>
            <p class="text-gray-500 text-sm">Step 3.2 - UI ì»´í¬ë„ŒíŠ¸</p>
          </div>
        </div>
        <a href="./" class="text-gray-500 hover:text-blue-600">
          <i class="fas fa-arrow-left mr-1"></i> ì‹¤í—˜ì‹¤
        </a>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 py-8">

    <!-- ì»´í¬ë„ŒíŠ¸ ë°ëª¨ -->
    <section class="mb-8">
      <h2 class="text-lg font-semibold text-gray-700 mb-4">
        <i class="fas fa-palette text-purple-500 mr-2"></i>ì»´í¬ë„ŒíŠ¸ ìŠ¤íƒ€ì¼
      </h2>

      <div class="grid grid-cols-1 gap-6">

        <!-- ìŠ¤íƒ€ì¼ 1: ê¸°ë³¸ ë¼ì¸ -->
        <div class="bg-white rounded-xl p-6 shadow">
          <h3 class="font-semibold mb-4 text-sm text-gray-600">1. ê¸°ë³¸ ë¼ì¸ (ìƒíƒœë³„)</h3>
          <div class="space-y-4">
            <div class="one-liner bullish">
              <span class="signal-emoji">ğŸŸ¢</span>
              S&P 500ì€ í˜„ì¬ <span class="highlight">P/E 25%</span>, <span class="highlight">PEG 0.8x</span>ë¡œ
              <strong>ì €í‰ê°€</strong> êµ¬ê°„ì…ë‹ˆë‹¤. ROEë„ ìƒìœ„ <span class="highlight">80%</span>ë¡œ ìš°ìˆ˜í•©ë‹ˆë‹¤.
            </div>
            <div class="one-liner neutral">
              <span class="signal-emoji">ğŸŸ¡</span>
              NASDAQ 100ì€ í˜„ì¬ <span class="highlight">P/E 55%</span>ë¡œ
              <strong>ì ì •</strong> ìˆ˜ì¤€ì…ë‹ˆë‹¤. ì¶”ê°€ ëª¨ë‹ˆí„°ë§ì´ í•„ìš”í•©ë‹ˆë‹¤.
            </div>
            <div class="one-liner bearish">
              <span class="signal-emoji">ğŸ”´</span>
              S&P 500ì€ í˜„ì¬ <span class="highlight">P/E 98%</span>, <span class="highlight">P/B 99%</span>ë¡œ
              <strong>ê³ í‰ê°€</strong> êµ¬ê°„ì´ì§€ë§Œ, ROE <span class="highlight">100%</span>ë¡œ í€ë”ë©˜í„¸ì€ ìš°ìˆ˜í•©ë‹ˆë‹¤.
            </div>
          </div>
        </div>

        <!-- ìŠ¤íƒ€ì¼ 2: ì¹´ë“œí˜• -->
        <div class="bg-white rounded-xl p-6 shadow">
          <h3 class="font-semibold mb-4 text-sm text-gray-600">2. ì¹´ë“œí˜•</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="one-liner-card">
              <div class="header">
                <div class="icon bullish">ğŸŸ¢</div>
                <div>
                  <div class="title">ì €í‰ê°€ íŒì •</div>
                  <div class="subtitle">S&P 500 Â· 2025-12-05 ê¸°ì¤€</div>
                </div>
              </div>
              <div class="message">
                P/E <span class="mini-badge green">25%</span>ì™€
                PEG <span class="mini-badge green">0.8x</span>ê°€ ëª¨ë‘ ì €í‰ê°€ ìˆ˜ì¤€ì…ë‹ˆë‹¤.
                í˜„ì¬ ì§„ì… ì ê¸°ë¡œ íŒë‹¨ë©ë‹ˆë‹¤.
              </div>
            </div>
            <div class="one-liner-card">
              <div class="header">
                <div class="icon bearish">ğŸ”´</div>
                <div>
                  <div class="title">ê³ í‰ê°€ ì£¼ì˜</div>
                  <div class="subtitle">S&P 500 Â· 2025-12-05 ê¸°ì¤€</div>
                </div>
              </div>
              <div class="message">
                P/E <span class="mini-badge red">98%</span> ì—­ì‚¬ì  ê³ ì  ë¶€ê·¼ì…ë‹ˆë‹¤.
                ë‹¤ë§Œ ROE <span class="mini-badge green">100%</span>ë¡œ ìˆ˜ìµì„±ì€ ì–‘í˜¸í•©ë‹ˆë‹¤.
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>

    <!-- ì‹¤ì‹œê°„ ë°ì´í„° ì—°ë™ -->
    <section class="mb-8">
      <h2 class="text-lg font-semibold text-gray-700 mb-4">
        <i class="fas fa-database text-blue-500 mr-2"></i>ì‹¤ì‹œê°„ ë°ì´í„° ì—°ë™
      </h2>

      <div class="bg-white rounded-xl p-6 shadow">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-2">
            <select id="benchmark-select" class="border rounded px-3 py-1.5 text-sm">
              <option value="US">US (ë¯¸êµ­)</option>
              <option value="SECTORS">ì„¹í„°</option>
              <option value="EMERGING">ì‹ í¥êµ­</option>
              <option value="DEVELOPED">ì„ ì§„êµ­</option>
            </select>
            <select id="section-select" class="border rounded px-3 py-1.5 text-sm">
              <option value="sp500">S&P 500</option>
            </select>
          </div>
          <button onclick="generateOneLiner()" class="bg-blue-500 text-white px-4 py-1.5 rounded text-sm hover:bg-blue-600">
            <i class="fas fa-magic mr-1"></i> ìƒì„±
          </button>
        </div>

        <div id="one-liner-output" class="space-y-4">
          <div class="text-gray-400 text-sm text-center py-8">
            ë²¤ì¹˜ë§ˆí¬ ì„ íƒ í›„ 'ìƒì„±' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”
          </div>
        </div>
      </div>
    </section>

    <!-- JavaScript API -->
    <section>
      <h2 class="text-lg font-semibold text-gray-700 mb-4">
        <i class="fas fa-code text-green-500 mr-2"></i>JavaScript API
      </h2>

      <div class="bg-white rounded-xl p-6 shadow">
        <pre class="bg-gray-900 text-green-400 p-4 rounded font-mono text-xs overflow-auto"><code>// OneLiner ì»´í¬ë„ŒíŠ¸ ì‚¬ìš©ë²•

// 1. ì¢…í•© ë¶„ì„ ê²°ê³¼ë¡œ ë¬¸ì¥ ìƒì„±
const summary = await Indicators.getValuationSummary('US', 'sp500');
const sentence = OneLiner.generate(summary, {
  indexName: 'S&P 500',
  style: 'line'  // line | card
});

// 2. ì§ì ‘ ë Œë”ë§
const container = document.getElementById('output');
OneLiner.render(container, summary, {
  indexName: 'S&P 500',
  showCard: true
});

// 3. ë¬¸ì¥ë§Œ ê°€ì ¸ì˜¤ê¸°
const text = OneLiner.getText(summary, 'S&P 500');
console.log(text);
// â†’ "S&P 500ì€ í˜„ì¬ P/E 98%, P/B 99%ë¡œ ê³ í‰ê°€ êµ¬ê°„ì´ì§€ë§Œ..."</code></pre>
      </div>
    </section>

  </main>

  <script>
    /**
     * OneLiner - 1ë¬¸ì¥ í•´ì„ ì»´í¬ë„ŒíŠ¸
     * Step 3.2: Layer 1B UI
     */
    const OneLiner = (function() {

      /**
       * ì¢…í•© íŒì • (ë‹¤ìˆ˜ê²°)
       */
      function getOverallSignal(summary) {
        const signals = [
          summary.pePercentile?.signal,
          summary.pbPercentile?.signal,
          summary.roePercentile?.signal,
          summary.pegProxy?.signal,
          summary.peZScore?.signal
        ].filter(Boolean);

        const counts = { green: 0, yellow: 0, red: 0 };
        signals.forEach(s => {
          if (s === 'ğŸŸ¢') counts.green++;
          else if (s === 'ğŸŸ¡') counts.yellow++;
          else if (s === 'ğŸ”´') counts.red++;
        });

        // ë‹¤ìˆ˜ê²° íŒì •
        if (counts.green > counts.red && counts.green >= counts.yellow) {
          return { signal: 'ğŸŸ¢', class: 'bullish', label: 'ì €í‰ê°€' };
        } else if (counts.red > counts.green && counts.red >= counts.yellow) {
          return { signal: 'ğŸ”´', class: 'bearish', label: 'ê³ í‰ê°€' };
        } else {
          return { signal: 'ğŸŸ¡', class: 'neutral', label: 'ì ì •' };
        }
      }

      /**
       * í•µì‹¬ ì§€í‘œ ì„ íƒ (ìƒìœ„ 2-3ê°œ)
       */
      function getKeyIndicators(summary) {
        const indicators = [];

        // P/EëŠ” í•­ìƒ í¬í•¨
        if (summary.pePercentile?.value !== null) {
          indicators.push({
            name: 'P/E',
            value: summary.pePercentile.formatted,
            signal: summary.pePercentile.signal,
            label: summary.pePercentile.signalLabel
          });
        }

        // P/B ë˜ëŠ” PEG ì¤‘ ë” ê·¹ë‹¨ì ì¸ ê²ƒ
        const pbVal = summary.pbPercentile?.value;
        const pegVal = summary.pegProxy?.value;

        if (pegVal !== null && pegVal !== undefined) {
          indicators.push({
            name: 'PEG',
            value: summary.pegProxy.formatted,
            signal: summary.pegProxy.signal,
            label: summary.pegProxy.signalLabel
          });
        } else if (pbVal !== null) {
          indicators.push({
            name: 'P/B',
            value: summary.pbPercentile.formatted,
            signal: summary.pbPercentile.signal,
            label: summary.pbPercentile.signalLabel
          });
        }

        // ROEëŠ” í•­ìƒ ë§ˆì§€ë§‰ì— (í€ë”ë©˜í„¸)
        if (summary.roePercentile?.value !== null) {
          indicators.push({
            name: 'ROE',
            value: summary.roePercentile.formatted,
            signal: summary.roePercentile.signal,
            label: summary.roePercentile.signalLabel
          });
        }

        return indicators.slice(0, 3);
      }

      /**
       * ë¬¸ì¥ ìƒì„±
       */
      function getText(summary, indexName = 'ì§€ìˆ˜') {
        const overall = getOverallSignal(summary);
        const keyIndicators = getKeyIndicators(summary);

        if (keyIndicators.length === 0) {
          return `${indexName}ì˜ ë°¸ë¥˜ì—ì´ì…˜ ë°ì´í„°ë¥¼ ë¶„ì„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`;
        }

        // ë¬¸ì¥ ì¡°í•©
        let sentence = `${indexName}ì€ í˜„ì¬ `;

        // í•µì‹¬ ì§€í‘œ ë‚˜ì—´
        const indicatorParts = keyIndicators.slice(0, 2).map(ind =>
          `${ind.name} ${ind.value}`
        );
        sentence += indicatorParts.join(', ') + 'ë¡œ ';

        // íŒì •
        sentence += `<strong>${overall.label}</strong> `;

        // ì¶”ê°€ ì»¨í…ìŠ¤íŠ¸
        if (overall.class === 'bearish') {
          sentence += 'êµ¬ê°„ì…ë‹ˆë‹¤.';
          // ROEê°€ ì¢‹ìœ¼ë©´ ì–¸ê¸‰
          const roe = keyIndicators.find(i => i.name === 'ROE');
          if (roe && roe.signal === 'ğŸŸ¢') {
            sentence += ` ë‹¤ë§Œ ROE ${roe.value}ë¡œ í€ë”ë©˜í„¸ì€ ì–‘í˜¸í•©ë‹ˆë‹¤.`;
          }
        } else if (overall.class === 'bullish') {
          sentence += 'êµ¬ê°„ì…ë‹ˆë‹¤.';
          const roe = keyIndicators.find(i => i.name === 'ROE');
          if (roe && roe.signal === 'ğŸŸ¢') {
            sentence += ` ROEë„ ${roe.value}ë¡œ ìš°ìˆ˜í•©ë‹ˆë‹¤.`;
          }
        } else {
          sentence += 'ìˆ˜ì¤€ì…ë‹ˆë‹¤. ì¶”ê°€ ëª¨ë‹ˆí„°ë§ì´ í•„ìš”í•©ë‹ˆë‹¤.';
        }

        return sentence;
      }

      /**
       * ë¼ì¸ ìŠ¤íƒ€ì¼ ìƒì„±
       */
      function createLine(summary, indexName) {
        const overall = getOverallSignal(summary);
        const text = getText(summary, indexName);

        const div = document.createElement('div');
        div.className = `one-liner ${overall.class}`;
        div.innerHTML = `<span class="signal-emoji">${overall.signal}</span>${text}`;
        return div;
      }

      /**
       * ì¹´ë“œ ìŠ¤íƒ€ì¼ ìƒì„±
       */
      function createCard(summary, indexName) {
        const overall = getOverallSignal(summary);
        const keyIndicators = getKeyIndicators(summary);

        const labelMap = {
          bullish: 'ì €í‰ê°€ íŒì •',
          neutral: 'ì ì • ìˆ˜ì¤€',
          bearish: 'ê³ í‰ê°€ ì£¼ì˜'
        };

        const card = document.createElement('div');
        card.className = 'one-liner-card';

        // ë°°ì§€ HTML
        const badgeHtml = keyIndicators.map(ind => {
          const color = ind.signal === 'ğŸŸ¢' ? 'green' : ind.signal === 'ğŸ”´' ? 'red' : 'yellow';
          return `${ind.name} <span class="mini-badge ${color}">${ind.value}</span>`;
        }).join(', ');

        card.innerHTML = `
          <div class="header">
            <div class="icon ${overall.class}">${overall.signal}</div>
            <div>
              <div class="title">${labelMap[overall.class]}</div>
              <div class="subtitle">${indexName} Â· ${summary.date || 'N/A'} ê¸°ì¤€</div>
            </div>
          </div>
          <div class="message">
            ${badgeHtml}${overall.class === 'bearish' ? 'ë¡œ ì—­ì‚¬ì  ê³ ì  ë¶€ê·¼ì…ë‹ˆë‹¤.' : overall.class === 'bullish' ? 'ë¡œ ì–‘í˜¸í•œ ì§„ì… êµ¬ê°„ì…ë‹ˆë‹¤.' : 'ë¡œ ì¤‘ë¦½ ìˆ˜ì¤€ì…ë‹ˆë‹¤.'}
          </div>
        `;
        return card;
      }

      /**
       * ë Œë”ë§
       */
      function render(container, summary, options = {}) {
        const { indexName = 'ì§€ìˆ˜', showCard = true } = options;
        container.innerHTML = '';

        // ë¼ì¸ ìŠ¤íƒ€ì¼
        const line = createLine(summary, indexName);
        container.appendChild(line);

        // ì¹´ë“œ ìŠ¤íƒ€ì¼
        if (showCard) {
          const cardWrapper = document.createElement('div');
          cardWrapper.className = 'mt-4';
          const card = createCard(summary, indexName);
          cardWrapper.appendChild(card);
          container.appendChild(cardWrapper);
        }
      }

      return {
        getOverallSignal,
        getKeyIndicators,
        getText,
        createLine,
        createCard,
        render
      };

    })();

    // ========================================
    // UI ì—°ë™
    // ========================================

    const benchmarkSelect = document.getElementById('benchmark-select');
    const sectionSelect = document.getElementById('section-select');

    // ë²¤ì¹˜ë§ˆí¬ ì„ íƒ ì‹œ ì„¹ì…˜ ëª©ë¡ ì—…ë°ì´íŠ¸
    benchmarkSelect.addEventListener('change', async () => {
      const benchmark = benchmarkSelect.value;
      sectionSelect.innerHTML = '<option>ë¡œë”© ì¤‘...</option>';

      try {
        const data = await DataManager.loadBenchmark(benchmark);
        const sections = DataManager.getSectionKeys(data);
        sectionSelect.innerHTML = sections.map(s =>
          `<option value="${s}">${s}</option>`
        ).join('');
      } catch (e) {
        sectionSelect.innerHTML = '<option>ì˜¤ë¥˜</option>';
      }
    });

    // 1ë¬¸ì¥ í•´ì„ ìƒì„±
    async function generateOneLiner() {
      const benchmark = benchmarkSelect.value;
      const section = sectionSelect.value;
      const output = document.getElementById('one-liner-output');

      output.innerHTML = '<div class="text-center py-4 text-gray-400">ìƒì„± ì¤‘...</div>';

      try {
        const summary = await Indicators.getValuationSummary(benchmark, section);

        if (summary.error) {
          output.innerHTML = `<div class="text-center py-4 text-red-500">ì˜¤ë¥˜: ${summary.error}</div>`;
          return;
        }

        // ì¸ë±ìŠ¤ëª… ë§¤í•‘
        const indexNames = {
          sp500: 'S&P 500',
          nasdaq100: 'NASDAQ 100',
          russell2000: 'Russell 2000'
        };
        const indexName = indexNames[section] || section;

        OneLiner.render(output, summary, { indexName, showCard: true });
      } catch (e) {
        output.innerHTML = `<div class="text-center py-4 text-red-500">ì˜¤ë¥˜: ${e.message}</div>`;
      }
    }

    // ì´ˆê¸°í™”
    (async () => {
      try {
        const data = await DataManager.loadBenchmark('US');
        const sections = DataManager.getSectionKeys(data);
        sectionSelect.innerHTML = sections.map(s =>
          `<option value="${s}">${s}</option>`
        ).join('');
      } catch (e) {
        console.error('ì´ˆê¸°í™” ì˜¤ë¥˜:', e);
      }
    })();
  </script>

</body>
</html>
