<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë¶„ìœ„ìˆ˜ ì°¨íŠ¸ - Valuation Lab</title>
  <meta name="robots" content="noindex, nofollow">
  <link rel="icon" type="image/x-icon" href="../../favicon.ico">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* ë¶„ìœ„ìˆ˜ ê²Œì´ì§€ ë°” */
    .percentile-bar {
      position: relative;
      height: 1.5rem;
      border-radius: 9999px;
      background: linear-gradient(90deg,
        #16a34a 0%,
        #16a34a 30%,
        #ca8a04 30%,
        #ca8a04 70%,
        #dc2626 70%,
        #dc2626 100%
      );
      overflow: hidden;
    }

    .percentile-bar .marker {
      position: absolute;
      top: -0.25rem;
      width: 0.5rem;
      height: 2rem;
      background: #1e293b;
      border: 2px solid white;
      border-radius: 0.25rem;
      transform: translateX(-50%);
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      transition: left 0.5s ease-out;
    }

    .percentile-bar .labels {
      display: flex;
      justify-content: space-between;
      margin-top: 0.5rem;
      font-size: 0.75rem;
      color: #64748b;
    }

    /* ê²Œì´ì§€ ë¯¸í„° (ë°˜ì›í˜•) */
    .gauge-meter {
      position: relative;
      width: 200px;
      height: 100px;
      overflow: hidden;
    }

    .gauge-meter .background {
      position: absolute;
      width: 200px;
      height: 200px;
      border-radius: 50%;
      background: conic-gradient(
        from 180deg,
        #16a34a 0deg,
        #16a34a 54deg,
        #ca8a04 54deg,
        #ca8a04 126deg,
        #dc2626 126deg,
        #dc2626 180deg,
        transparent 180deg
      );
      clip-path: polygon(0 0, 100% 0, 100% 50%, 0 50%);
    }

    .gauge-meter .inner {
      position: absolute;
      top: 20px;
      left: 20px;
      width: 160px;
      height: 160px;
      border-radius: 50%;
      background: white;
      clip-path: polygon(0 0, 100% 0, 100% 50%, 0 50%);
    }

    .gauge-meter .needle {
      position: absolute;
      bottom: 0;
      left: 50%;
      width: 4px;
      height: 80px;
      background: #1e293b;
      transform-origin: bottom center;
      transition: transform 0.5s ease-out;
      border-radius: 2px;
    }

    .gauge-meter .center {
      position: absolute;
      bottom: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 20px;
      height: 20px;
      background: #1e293b;
      border-radius: 50%;
      border: 3px solid white;
    }

    .gauge-meter .value {
      position: absolute;
      bottom: 25px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 1.5rem;
      font-weight: 700;
      color: #1e293b;
    }

    /* ì„¸ê·¸ë¨¼íŠ¸ ë°” */
    .segment-bar {
      display: flex;
      height: 2rem;
      border-radius: 0.5rem;
      overflow: hidden;
    }

    .segment-bar .segment {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 500;
      color: white;
      opacity: 0.4;
      transition: opacity 0.3s;
    }

    .segment-bar .segment.active {
      opacity: 1;
    }

    .segment-bar .segment.green { background: #16a34a; }
    .segment-bar .segment.yellow { background: #ca8a04; }
    .segment-bar .segment.red { background: #dc2626; }

    /* ë¯¸ë‹ˆ ë°” */
    .mini-bar {
      height: 0.5rem;
      border-radius: 9999px;
      background: #e5e7eb;
      overflow: hidden;
    }

    .mini-bar .fill {
      height: 100%;
      border-radius: 9999px;
      transition: width 0.5s ease-out;
    }

    .mini-bar .fill.green { background: #16a34a; }
    .mini-bar .fill.yellow { background: #ca8a04; }
    .mini-bar .fill.red { background: #dc2626; }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-100 to-slate-200 min-h-screen">

  <!-- Shared Modules -->
  <!-- Shared Modules -->
  <script src="../shared/config/manifest-loader.js"></script>
  <script src="../shared/core/cache-manager.js"></script>
  <script src="../shared/core/data-manager.js"></script>
  <script src="../shared/core/formatters.js"></script>
  <script src="../shared/validators/freshness-checker.js"></script>

  <!-- Valuation Lab Specific -->
  <script src="shared/constants.js"></script>
  <script src="shared/calculations.js"></script>
  <script src="shared/indicators.js"></script>
  <script src="shared/security.js"></script>
  <script src="shared/validator.js"></script>

  <script>
    // Set prefix for Valuation Lab
    if (window.CacheManager) CacheManager.setPrefix('vlab_cache_');
  </script>

  <header class="py-6 border-b bg-white">
    <div class="container mx-auto px-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center">
            <i class="fas fa-chart-line text-indigo-500"></i>
          </div>
          <div>
            <h1 class="text-xl font-bold">ë¶„ìœ„ìˆ˜ ì°¨íŠ¸</h1>
            <p class="text-gray-500 text-sm">Step 3.3 - UI ì»´í¬ë„ŒíŠ¸</p>
          </div>
        </div>
        <a href="./" class="text-gray-500 hover:text-blue-600">
          <i class="fas fa-arrow-left mr-1"></i> ì‹¤í—˜ì‹¤
        </a>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 py-8">

    <!-- ì»´í¬ë„ŒíŠ¸ ë°ëª¨ -->
    <section class="mb-8">
      <h2 class="text-lg font-semibold text-gray-700 mb-4">
        <i class="fas fa-palette text-purple-500 mr-2"></i>ì»´í¬ë„ŒíŠ¸ ìŠ¤íƒ€ì¼
      </h2>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

        <!-- ìŠ¤íƒ€ì¼ 1: ê·¸ë¼ë°ì´ì…˜ ë°” -->
        <div class="bg-white rounded-xl p-6 shadow">
          <h3 class="font-semibold mb-4 text-sm text-gray-600">1. ê·¸ë¼ë°ì´ì…˜ ë°”</h3>
          <div class="space-y-6">
            <div>
              <div class="flex justify-between mb-2">
                <span class="text-sm font-medium">P/E Percentile</span>
                <span class="text-sm text-red-600 font-bold">98%</span>
              </div>
              <div class="percentile-bar">
                <div class="marker" style="left: 98%"></div>
              </div>
              <div class="labels">
                <span>0% (ì €í‰ê°€)</span>
                <span>50%</span>
                <span>100% (ê³ í‰ê°€)</span>
              </div>
            </div>
            <div>
              <div class="flex justify-between mb-2">
                <span class="text-sm font-medium">PEG Proxy</span>
                <span class="text-sm text-green-600 font-bold">25%</span>
              </div>
              <div class="percentile-bar">
                <div class="marker" style="left: 25%"></div>
              </div>
              <div class="labels">
                <span>0% (ì €í‰ê°€)</span>
                <span>50%</span>
                <span>100% (ê³ í‰ê°€)</span>
              </div>
            </div>
          </div>
        </div>

        <!-- ìŠ¤íƒ€ì¼ 2: ê²Œì´ì§€ ë¯¸í„° -->
        <div class="bg-white rounded-xl p-6 shadow">
          <h3 class="font-semibold mb-4 text-sm text-gray-600">2. ê²Œì´ì§€ ë¯¸í„°</h3>
          <div class="flex justify-around">
            <div class="text-center">
              <div class="gauge-meter">
                <div class="background"></div>
                <div class="inner"></div>
                <div class="needle" style="transform: rotate(-54deg)"></div>
                <div class="center"></div>
              </div>
              <p class="mt-2 text-sm text-gray-600">P/E: 25%</p>
            </div>
            <div class="text-center">
              <div class="gauge-meter">
                <div class="background"></div>
                <div class="inner"></div>
                <div class="needle" style="transform: rotate(76deg)"></div>
                <div class="center"></div>
              </div>
              <p class="mt-2 text-sm text-gray-600">P/E: 98%</p>
            </div>
          </div>
        </div>

        <!-- ìŠ¤íƒ€ì¼ 3: ì„¸ê·¸ë¨¼íŠ¸ ë°” -->
        <div class="bg-white rounded-xl p-6 shadow">
          <h3 class="font-semibold mb-4 text-sm text-gray-600">3. ì„¸ê·¸ë¨¼íŠ¸ ë°”</h3>
          <div class="space-y-4">
            <div>
              <div class="flex justify-between mb-2">
                <span class="text-sm font-medium">P/E Percentile</span>
                <span class="text-sm font-bold">98% ê³ í‰ê°€</span>
              </div>
              <div class="segment-bar">
                <div class="segment green">ì €í‰ê°€</div>
                <div class="segment yellow">ì ì •</div>
                <div class="segment red active">ê³ í‰ê°€</div>
              </div>
            </div>
            <div>
              <div class="flex justify-between mb-2">
                <span class="text-sm font-medium">ROE Percentile</span>
                <span class="text-sm font-bold">100% ìš°ìˆ˜</span>
              </div>
              <div class="segment-bar">
                <div class="segment green active">ìš°ìˆ˜</div>
                <div class="segment yellow">ë³´í†µ</div>
                <div class="segment red">ì €ì¡°</div>
              </div>
            </div>
          </div>
        </div>

        <!-- ìŠ¤íƒ€ì¼ 4: ë¯¸ë‹ˆ ë°” -->
        <div class="bg-white rounded-xl p-6 shadow">
          <h3 class="font-semibold mb-4 text-sm text-gray-600">4. ë¯¸ë‹ˆ ë°” (ë¦¬ìŠ¤íŠ¸ìš©)</h3>
          <div class="space-y-3">
            <div class="flex items-center gap-3">
              <span class="w-24 text-sm">P/E</span>
              <div class="flex-1 mini-bar">
                <div class="fill red" style="width: 98%"></div>
              </div>
              <span class="w-12 text-sm text-right text-red-600 font-medium">98%</span>
            </div>
            <div class="flex items-center gap-3">
              <span class="w-24 text-sm">P/B</span>
              <div class="flex-1 mini-bar">
                <div class="fill red" style="width: 99%"></div>
              </div>
              <span class="w-12 text-sm text-right text-red-600 font-medium">99%</span>
            </div>
            <div class="flex items-center gap-3">
              <span class="w-24 text-sm">ROE</span>
              <div class="flex-1 mini-bar">
                <div class="fill green" style="width: 100%"></div>
              </div>
              <span class="w-12 text-sm text-right text-green-600 font-medium">100%</span>
            </div>
            <div class="flex items-center gap-3">
              <span class="w-24 text-sm">PEG</span>
              <div class="flex-1 mini-bar">
                <div class="fill green" style="width: 30%"></div>
              </div>
              <span class="w-12 text-sm text-right text-green-600 font-medium">0.92x</span>
            </div>
          </div>
        </div>

      </div>
    </section>

    <!-- ì‹¤ì‹œê°„ ë°ì´í„° ì—°ë™ -->
    <section class="mb-8">
      <h2 class="text-lg font-semibold text-gray-700 mb-4">
        <i class="fas fa-database text-blue-500 mr-2"></i>ì‹¤ì‹œê°„ ë°ì´í„° ì—°ë™
      </h2>

      <div class="bg-white rounded-xl p-6 shadow">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-2">
            <select id="benchmark-select" class="border rounded px-3 py-1.5 text-sm">
              <option value="US">US (ë¯¸êµ­)</option>
              <option value="SECTORS">ì„¹í„°</option>
              <option value="EMERGING">ì‹ í¥êµ­</option>
              <option value="DEVELOPED">ì„ ì§„êµ­</option>
            </select>
            <select id="section-select" class="border rounded px-3 py-1.5 text-sm">
              <option value="sp500">S&P 500</option>
            </select>
          </div>
          <button onclick="loadPercentileData()" class="bg-indigo-500 text-white px-4 py-1.5 rounded text-sm hover:bg-indigo-600">
            <i class="fas fa-chart-bar mr-1"></i> ë¡œë“œ
          </button>
        </div>

        <div id="percentile-output" class="space-y-4">
          <div class="text-gray-400 text-sm text-center py-8">
            ë²¤ì¹˜ë§ˆí¬ ì„ íƒ í›„ 'ë¡œë“œ' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”
          </div>
        </div>
      </div>
    </section>

    <!-- JavaScript API -->
    <section>
      <h2 class="text-lg font-semibold text-gray-700 mb-4">
        <i class="fas fa-code text-green-500 mr-2"></i>JavaScript API
      </h2>

      <div class="bg-white rounded-xl p-6 shadow">
        <pre class="bg-gray-900 text-green-400 p-4 rounded font-mono text-xs overflow-auto"><code>// PercentileChart ì»´í¬ë„ŒíŠ¸ ì‚¬ìš©ë²•

// 1. ê·¸ë¼ë°ì´ì…˜ ë°” ìƒì„±
const bar = PercentileChart.createBar({
  label: 'P/E Percentile',
  value: 98,
  showLabels: true
});
container.appendChild(bar);

// 2. ê²Œì´ì§€ ë¯¸í„° ìƒì„±
const gauge = PercentileChart.createGauge({
  value: 98,
  label: 'P/E'
});

// 3. ì„¸ê·¸ë¨¼íŠ¸ ë°” ìƒì„±
const segment = PercentileChart.createSegment({
  label: 'P/E Percentile',
  value: 98,
  signal: 'ğŸ”´'
});

// 4. ë¯¸ë‹ˆ ë°” (ë¦¬ìŠ¤íŠ¸ìš©)
const mini = PercentileChart.createMini({
  label: 'P/E',
  value: 98,
  formatted: '98%'
});

// 5. ì¢…í•© íŒ¨ë„ ë Œë”ë§
const summary = await Indicators.getValuationSummary('US', 'sp500');
PercentileChart.renderPanel(container, summary);</code></pre>
      </div>
    </section>

  </main>

  <script>
    /**
     * PercentileChart - ë¶„ìœ„ìˆ˜ ì°¨íŠ¸ ì»´í¬ë„ŒíŠ¸
     * Step 3.3: Layer 1B UI
     */
    const PercentileChart = (function() {

      /**
       * ìƒ‰ìƒ í´ë˜ìŠ¤ ê²°ì •
       */
      function getColorClass(value, inverted = false) {
        if (inverted) {
          // ROE: ë†’ì„ìˆ˜ë¡ ì¢‹ìŒ
          if (value >= 70) return 'green';
          if (value >= 30) return 'yellow';
          return 'red';
        } else {
          // P/E, P/B: ë‚®ì„ìˆ˜ë¡ ì¢‹ìŒ
          if (value <= 30) return 'green';
          if (value <= 70) return 'yellow';
          return 'red';
        }
      }

      /**
       * ê·¸ë¼ë°ì´ì…˜ ë°” ìƒì„±
       */
      function createBar(options) {
        const { label, value, showLabels = true } = options;
        const color = getColorClass(value);
        const colorText = color === 'green' ? 'text-green-600' : color === 'yellow' ? 'text-yellow-600' : 'text-red-600';

        const wrapper = document.createElement('div');
        wrapper.innerHTML = `
          <div class="flex justify-between mb-2">
            <span class="text-sm font-medium">${label}</span>
            <span class="text-sm ${colorText} font-bold">${value}%</span>
          </div>
          <div class="percentile-bar">
            <div class="marker" style="left: ${value}%"></div>
          </div>
          ${showLabels ? `
          <div class="labels">
            <span>0% (ì €í‰ê°€)</span>
            <span>50%</span>
            <span>100% (ê³ í‰ê°€)</span>
          </div>
          ` : ''}
        `;
        return wrapper;
      }

      /**
       * ê²Œì´ì§€ ë¯¸í„° ìƒì„±
       */
      function createGauge(options) {
        const { value, label } = options;
        // 0% = -90deg, 100% = 90deg
        const angle = (value / 100) * 180 - 90;

        const wrapper = document.createElement('div');
        wrapper.className = 'text-center';
        wrapper.innerHTML = `
          <div class="gauge-meter">
            <div class="background"></div>
            <div class="inner"></div>
            <div class="needle" style="transform: rotate(${angle}deg)"></div>
            <div class="center"></div>
          </div>
          <p class="mt-2 text-sm text-gray-600">${label}: ${value}%</p>
        `;
        return wrapper;
      }

      /**
       * ì„¸ê·¸ë¨¼íŠ¸ ë°” ìƒì„±
       */
      function createSegment(options) {
        const { label, value, signal, inverted = false } = options;
        const color = getColorClass(value, inverted);

        const labelMap = inverted
          ? { green: 'ìš°ìˆ˜', yellow: 'ë³´í†µ', red: 'ì €ì¡°' }
          : { green: 'ì €í‰ê°€', yellow: 'ì ì •', red: 'ê³ í‰ê°€' };

        const wrapper = document.createElement('div');
        wrapper.innerHTML = `
          <div class="flex justify-between mb-2">
            <span class="text-sm font-medium">${label}</span>
            <span class="text-sm font-bold">${value}% ${labelMap[color]}</span>
          </div>
          <div class="segment-bar">
            <div class="segment green ${color === 'green' ? 'active' : ''}">${inverted ? 'ìš°ìˆ˜' : 'ì €í‰ê°€'}</div>
            <div class="segment yellow ${color === 'yellow' ? 'active' : ''}">${inverted ? 'ë³´í†µ' : 'ì ì •'}</div>
            <div class="segment red ${color === 'red' ? 'active' : ''}">${inverted ? 'ì €ì¡°' : 'ê³ í‰ê°€'}</div>
          </div>
        `;
        return wrapper;
      }

      /**
       * ë¯¸ë‹ˆ ë°” ìƒì„±
       */
      function createMini(options) {
        const { label, value, formatted, inverted = false } = options;
        const color = getColorClass(value, inverted);
        const colorText = color === 'green' ? 'text-green-600' : color === 'yellow' ? 'text-yellow-600' : 'text-red-600';

        const wrapper = document.createElement('div');
        wrapper.className = 'flex items-center gap-3';
        wrapper.innerHTML = `
          <span class="w-24 text-sm">${label}</span>
          <div class="flex-1 mini-bar">
            <div class="fill ${color}" style="width: ${Math.min(value, 100)}%"></div>
          </div>
          <span class="w-16 text-sm text-right ${colorText} font-medium">${formatted}</span>
        `;
        return wrapper;
      }

      /**
       * ì¢…í•© íŒ¨ë„ ë Œë”ë§
       */
      function renderPanel(container, summary) {
        container.innerHTML = '';

        // ìƒë‹¨: ê·¸ë¼ë°ì´ì…˜ ë°”
        const barSection = document.createElement('div');
        barSection.className = 'space-y-4 mb-6';

        if (summary.pePercentile?.value !== null) {
          barSection.appendChild(createBar({
            label: 'P/E Percentile',
            value: Math.round(summary.pePercentile.value),
            showLabels: true
          }));
        }

        if (summary.pbPercentile?.value !== null) {
          barSection.appendChild(createBar({
            label: 'P/B Percentile',
            value: Math.round(summary.pbPercentile.value),
            showLabels: false
          }));
        }

        container.appendChild(barSection);

        // í•˜ë‹¨: ë¯¸ë‹ˆ ë°” ë¦¬ìŠ¤íŠ¸
        const miniSection = document.createElement('div');
        miniSection.className = 'bg-gray-50 rounded-lg p-4 space-y-3';

        const indicators = [
          { key: 'pePercentile', label: 'P/E', inverted: false },
          { key: 'pbPercentile', label: 'P/B', inverted: false },
          { key: 'roePercentile', label: 'ROE', inverted: true },
          { key: 'pegProxy', label: 'PEG', inverted: false, isPeg: true }
        ];

        indicators.forEach(({ key, label, inverted, isPeg }) => {
          const data = summary[key];
          if (data && data.value !== null) {
            let value, formatted;
            if (isPeg) {
              // PEGëŠ” 0~3 â†’ 0~100 ë³€í™˜
              value = Math.min((data.value / 3) * 100, 100);
              formatted = data.formatted;
            } else {
              value = data.value;
              formatted = data.formatted;
            }
            miniSection.appendChild(createMini({ label, value, formatted, inverted }));
          }
        });

        container.appendChild(miniSection);

        // ë‚ ì§œ í‘œì‹œ
        const dateDiv = document.createElement('div');
        dateDiv.className = 'text-xs text-gray-500 mt-4 text-right';
        dateDiv.textContent = `ê¸°ì¤€ì¼: ${summary.date || 'N/A'}`;
        container.appendChild(dateDiv);
      }

      return {
        getColorClass,
        createBar,
        createGauge,
        createSegment,
        createMini,
        renderPanel
      };

    })();

    // ========================================
    // UI ì—°ë™
    // ========================================

    const benchmarkSelect = document.getElementById('benchmark-select');
    const sectionSelect = document.getElementById('section-select');

    benchmarkSelect.addEventListener('change', async () => {
      const benchmark = benchmarkSelect.value;
      sectionSelect.innerHTML = '<option>ë¡œë”© ì¤‘...</option>';

      try {
        const data = await DataManager.loadBenchmark(benchmark);
        const sections = DataManager.getSectionKeys(data);
        sectionSelect.innerHTML = sections.map(s =>
          `<option value="${s}">${s}</option>`
        ).join('');
      } catch (e) {
        sectionSelect.innerHTML = '<option>ì˜¤ë¥˜</option>';
      }
    });

    async function loadPercentileData() {
      const benchmark = benchmarkSelect.value;
      const section = sectionSelect.value;
      const output = document.getElementById('percentile-output');

      output.innerHTML = '<div class="text-center py-4 text-gray-400">ë¡œë”© ì¤‘...</div>';

      try {
        const summary = await Indicators.getValuationSummary(benchmark, section);

        if (summary.error) {
          output.innerHTML = `<div class="text-center py-4 text-red-500">ì˜¤ë¥˜: ${summary.error}</div>`;
          return;
        }

        PercentileChart.renderPanel(output, summary);
      } catch (e) {
        output.innerHTML = `<div class="text-center py-4 text-red-500">ì˜¤ë¥˜: ${e.message}</div>`;
      }
    }

    // ì´ˆê¸°í™”
    (async () => {
      try {
        const data = await DataManager.loadBenchmark('US');
        const sections = DataManager.getSectionKeys(data);
        sectionSelect.innerHTML = sections.map(s =>
          `<option value="${s}">${s}</option>`
        ).join('');
      } catch (e) {
        console.error('ì´ˆê¸°í™” ì˜¤ë¥˜:', e);
      }
    })();
  </script>

</body>
</html>
