<!DOCTYPE html>
<html lang="ko">
<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>v3: Swiss Functional - IB Calculator</title>
    <meta name="theme-color" content="#ffffff">
    <script type="module" src="../../../../initBaseHref.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #ffffff; color: #000; letter-spacing: -0.03em; }
        .app-container { max-width: 480px; margin: 0 auto; min-height: 100vh; padding: 2rem; position: relative; }
        
        /* Swiss Typography Inputs */
        .swiss-input-group { margin-bottom: 3rem; border-bottom: 2px solid #000; padding-bottom: 0.5rem; }
        .swiss-label { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: #666; margin-bottom: 0.5rem; display: block; }
        .swiss-input {
            width: 100%; font-size: 3rem; font-weight: 900; border: none; padding: 0; outline: none; background: transparent;
            color: #000; placeholder-color: #eee;
        }
        .swiss-input::placeholder { color: #e5e5e5; }
        
        /* Ticker Toggle - Minimal */
        .ticker-switch { display: flex; gap: 2rem; margin-bottom: 4rem; }
        .ticker-opt { font-size: 1.5rem; font-weight: 900; color: #e5e5e5; cursor: pointer; transition: color 0.3s; }
        .ticker-opt.active { color: #000; text-decoration: underline; text-decoration-thickness: 4px; text-decoration-color: #D5AD36; }

        /* Receipt Result */
        .receipt {
            background: #fff; border: 1px solid #000; padding: 1.5rem; margin-top: 2rem;
            box-shadow: 10px 10px 0 #000; display: none;
        }
        .receipt.show { display: block; animation: slideUp 0.5s ease; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .receipt-header { border-bottom: 1px dashed #000; padding-bottom: 1rem; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: baseline; }
        .receipt-row { display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-family: 'Inter', monospace; font-size: 0.875rem; }
        .receipt-total { border-top: 2px solid #000; padding-top: 1rem; margin-top: 1rem; font-weight: 900; font-size: 1.25rem; display: flex; justify-content: space-between; }
        
        .calc-btn {
            position: fixed; bottom: 2rem; right: 2rem; background: #000; color: #fff;
            width: 4rem; height: 4rem; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; cursor: pointer; transition: transform 0.2s; z-index: 50;
        }
        .calc-btn:hover { transform: scale(1.1); }
    </style>
</head>
<body>

    <div class="app-container">
        <header class="mb-8 flex justify-between items-start">
            <div>
                <h1 class="text-4xl font-black leading-none">IB<br>CALC.</h1>
            </div>
            <div class="text-right">
                <div class="text-xs font-bold uppercase tracking-widest text-slate-400">Live Price</div>
                <div id="live-price" class="text-xl font-bold">---</div>
            </div>
        </header>

        <div class="ticker-switch">
            <div class="ticker-opt active" data-ticker="TQQQ">TQQQ</div>
            <div class="ticker-opt" data-ticker="SOXL">SOXL</div>
        </div>

        <main>
            <div class="swiss-input-group">
                <label class="swiss-label">01 / Seed Money</label>
                <input type="number" id="virtualSeed" class="swiss-input" placeholder="0">
            </div>
            
            <div class="swiss-input-group">
                <label class="swiss-label">02 / Current Holding ($)</label>
                <input type="number" id="cumulativeBuy" class="swiss-input" placeholder="0">
            </div>

            <div class="grid grid-cols-2 gap-8">
                <div class="swiss-input-group">
                    <label class="swiss-label">03 / Qty</label>
                    <input type="number" id="totalQuantity" class="swiss-input" placeholder="0" style="font-size: 2rem;">
                </div>
                <div class="swiss-input-group">
                    <label class="swiss-label">04 / Avg</label>
                    <input type="number" id="avgPrice" class="swiss-input" placeholder="0" style="font-size: 2rem;">
                </div>
            </div>
        </main>

        <div id="receipt-area"></div>
        <div class="h-20"></div> 
    </div>

    <button id="calculateBtn" class="calc-btn">
        <i class="fas fa-arrow-right"></i>
    </button>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const state = { ticker: 'TQQQ', price: 0 };
            const config = {
                TQQQ: { split: 40, starFormula: t => 10 - (t / 2), sellProfit: 10 },
                SOXL: { split: 40, starFormula: t => 12 - (t * 0.6), sellProfit: 12 }
            };

            // Tabs
            document.querySelectorAll('.ticker-opt').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.ticker-opt').forEach(t => t.classList.remove('active'));
                    btn.classList.add('active');
                    state.ticker = btn.dataset.ticker;
                    updateLivePrice();
                });
            });

            async function updateLivePrice() {
                try {
                    const proxyUrl = 'https://api.allorigins.win/get?url=';
                    const targetUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${state.ticker}`;
                    const res = await fetch(proxyUrl + encodeURIComponent(targetUrl));
                    const data = await res.json();
                    const content = JSON.parse(data.contents);
                    const price = content?.chart?.result?.[0]?.meta?.regularMarketPrice;
                    if (price) {
                        state.price = price;
                        document.getElementById('live-price').textContent = price.toFixed(2);
                    }
                } catch (e) { console.error(e); }
            }
            updateLivePrice();

            document.getElementById('calculateBtn').addEventListener('click', () => {
                const virtualSeed = parseFloat(document.getElementById('virtualSeed').value) || 0;
                const cumulativeBuy = parseFloat(document.getElementById('cumulativeBuy').value) || 0;
                const totalQuantity = parseFloat(document.getElementById('totalQuantity').value) || 0;
                const avgPrice = parseFloat(document.getElementById('avgPrice').value) || 0;

                if (virtualSeed <= 0) return;

                const currentConfig = config[state.ticker];
                const oneTimeBuy = virtualSeed / currentConfig.split;
                
                let tValue = 0;
                if (oneTimeBuy > 0) tValue = Math.ceil((cumulativeBuy / oneTimeBuy) * 10) / 10;
                if (tValue === 0) tValue = 0;

                const starPercent = currentConfig.starFormula(tValue);
                const starPrice = avgPrice * (1 + starPercent / 100);
                const profitPrice = avgPrice * (1 + currentConfig.sellProfit / 100);

                // Generate Receipt
                const halfBuy = oneTimeBuy / 2;
                const qty1 = avgPrice > 0 ? Math.floor(halfBuy / avgPrice) : 0;
                const qty2 = starPrice > 0 ? Math.floor(halfBuy / starPrice) : 0;
                
                const sellQty1 = Math.floor(totalQuantity / 4);
                
                let receiptHtml = `
                    <div class="receipt show">
                        <div class="receipt-header">
                            <span class="font-bold">ORDER TICKET</span>
                            <span class="text-xs">${new Date().toLocaleDateString()}</span>
                        </div>
                        <div class="receipt-row">
                            <span>T-VALUE</span>
                            <span class="font-bold">T-${tValue}</span>
                        </div>
                        <div class="receipt-row">
                            <span>TARGET</span>
                            <span class="font-bold">${starPercent.toFixed(2)}% ($${starPrice.toFixed(2)})</span>
                        </div>
                        <div style="border-bottom: 1px dashed #000; margin: 1rem 0;"></div>
                        
                        <div class="receipt-row font-bold">BUY ORDERS (LOC)</div>
                        ${qty1 > 0 ? `<div class="receipt-row"><span>AVG ($${avgPrice.toFixed(2)})</span><span>x ${qty1}</span></div>` : ''}
                        ${qty2 > 0 ? `<div class="receipt-row"><span>STAR ($${starPrice.toFixed(2)})</span><span>x ${qty2}</span></div>` : ''}
                        
                        <div style="border-bottom: 1px dashed #000; margin: 1rem 0;"></div>
                        
                        <div class="receipt-row font-bold">SELL ORDERS</div>
                        ${sellQty1 > 0 ? `<div class="receipt-row"><span>LOC ($${starPrice.toFixed(2)})</span><span>x ${sellQty1}</span></div>` : ''}
                        <div class="receipt-row"><span>LIMIT ($${profitPrice.toFixed(2)})</span><span>REM</span></div>

                        <div class="receipt-total">
                            <span>EST. TOTAL</span>
                            <span>$${(oneTimeBuy).toFixed(2)}</span>
                        </div>
                    </div>
                `;
                
                document.getElementById('receipt-area').innerHTML = receiptHtml;
                window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
            });
        });
    </script>
</body>
</html>