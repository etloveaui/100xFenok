<!DOCTYPE html><html lang="ko"><head>
  <meta charset="utf-8">
  <title>Multichart v6 - OMEGA TERMINAL</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { brand: { navy: '#010079', gold: '#D5AD36', accent: '#3b82f6' } },
          boxShadow: {
            'omega': '0 20px 50px -12px rgba(0, 0, 0, 0.15)',
            'glass': 'inset 0 1px 0 0 rgba(255, 255, 255, 0.7), 0 4px 20px rgba(0,0,0,0.05)'
          },
          fontFamily: { mono: ['JetBrains Mono', 'monospace'], sans: ['Inter', 'sans-serif'] }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    body { background-color: #f0f2f5; color: #1e293b; font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
    
    /* Layout Grid */
    .omega-grid {
        flex: 1; display: grid; 
        grid-template-columns: 320px 1fr 320px; 
        grid-template-rows: 1fr 280px;
        gap: 16px; padding: 16px; overflow: hidden;
    }
    /* Responsive Adjustments */
    @media (max-width: 1400px) { .omega-grid { grid-template-columns: 280px 1fr; grid-template-rows: 1fr 280px; } .right-panel { display: none; } }
    @media (max-width: 1024px) { .omega-grid { grid-template-columns: 1fr; grid-template-rows: auto 1fr auto; overflow-y: auto; } .left-panel { display: none; } .right-panel { display: none; } }

    /* Glass Panels */
    .panel {
        background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.6); border-radius: 20px;
        box-shadow: var(--tw-shadow-glass); display: flex; flex-direction: column; overflow: hidden;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .panel:hover { box-shadow: var(--tw-shadow-omega); z-index: 10; border-color: white; }

    /* Areas */
    .area-sidebar { grid-column: 1; grid-row: 1 / span 2; }
    .area-main { grid-column: 2; grid-row: 1; }
    .area-underwater { grid-column: 2; grid-row: 2; }
    .area-metrics { grid-column: 3; grid-row: 1; }
    .area-correlation { grid-column: 3; grid-row: 2; }

    /* Nav */
    .omega-nav {
        height: 64px; background: white; border-bottom: 1px solid #e2e8f0;
        display: flex; justify-content: space-between; align-items: center; padding: 0 24px;
        z-index: 50; flex-shrink: 0;
    }

    /* Typography & UI */
    .label-xs { font-size: 10px; font-weight: 800; text-transform: uppercase; color: #94a3b8; letter-spacing: 0.05em; }
    .val-mono { font-family: 'JetBrains Mono', monospace; font-weight: 700; }
    
    .ticker-chip {
        display: flex; justify-content: space-between; align-items: center; padding: 12px;
        background: #f8fafc; border-radius: 12px; border: 1px solid transparent; margin-bottom: 8px;
        transition: all 0.2s; cursor: pointer;
    }
    .ticker-chip:hover { background: white; border-color: #cbd5e1; transform: translateX(4px); }
    .ticker-chip input { background: transparent; font-weight: 800; width: 60px; outline: none; text-transform: uppercase; }

    /* Heatmap Grid */
    .heatmap-grid { display: grid; gap: 4px; margin-top: 12px; }
    .heatmap-cell { 
        aspect-ratio: 1; display: flex; align-items: center; justify-content: center; 
        font-size: 10px; font-weight: 700; border-radius: 6px; color: white;
        transition: transform 0.2s; cursor: default;
    }
    .heatmap-cell:hover { transform: scale(1.1); z-index: 5; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }

  </style>

  <script defer="" src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
  <script defer="" src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script defer="" src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script defer="" src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script defer="" src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>

  <div id="root" class="h-full flex flex-col"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect, useMemo } = React;
    
    // --- Data Logic (Preserved & Enhanced) ---
    const STOOQ_PROXY = 'https://stooq-proxy.etloveaui.workers.dev';
    async function fetchStooq(symbol) {
        try {
            const res = await fetch(STOOQ_PROXY + encodeURIComponent(`https://stooq.com/q/d/l/?s=${symbol.toLowerCase()}.us&i=d`));
            if(!res.ok) return [];
            const txt = await res.text();
            return txt.trim().split('\n').slice(1).map(l=>{
                const f=l.split(',');
                return {date:f[0],price:+f[4]}
            }).sort((a,b)=>a.date.localeCompare(b.date));
        } catch(e) { return []; }
    }

    // --- Math Utils ---
    const calculateReturn = arr => (arr[arr.length-1]/arr[0]-1)*100;
    const calculateVol = arr => {
        if(arr.length<2) return 0;
        const r = []; for(let i=1;i<arr.length;i++) r.push(Math.log(arr[i]/arr[i-1]));
        const m = r.reduce((a,b)=>a+b,0)/r.length;
        return Math.sqrt(r.reduce((a,v)=>a+(v-m)**2,0)/(r.length-1))*Math.sqrt(252)*100;
    };
    const calculateMDD = arr => {
        let peak=-Infinity, maxDD=0; 
        arr.forEach(v=>{
            if(v>peak)peak=v;
            const dd=(v-peak)/peak;
            if(dd<maxDD)maxDD=dd;
        });
        return maxDD*100; // Negative value
    };
    const calculateCorrelation = (arr1, arr2) => {
        if(arr1.length !== arr2.length) return 0;
        const n = arr1.length;
        const sum1 = arr1.reduce((a,b)=>a+b,0);
        const sum2 = arr2.reduce((a,b)=>a+b,0);
        const sum1Sq = arr1.reduce((a,b)=>a+b*b,0);
        const sum2Sq = arr2.reduce((a,b)=>a+b*b,0);
        const pSum = arr1.map((x,i)=>x*arr2[i]).reduce((a,b)=>a+b,0);
        const num = pSum - (sum1*sum2/n);
        const den = Math.sqrt((sum1Sq - sum1*sum1/n) * (sum2Sq - sum2*sum2/n));
        return den === 0 ? 0 : num/den;
    };

    function App() {
        const [rows, setRows] = useState([{id:1, v:'TQQQ'}, {id:2, v:'SOXL'}, {id:3, v:'TLT'}, {id:4, v:'SPY'}]);
        const [period, setPeriod] = useState('1Y');
        const [isLoading, setIsLoading] = useState(false);
        const [chartData, setChartData] = useState(null);
        const [stats, setStats] = useState([]);
        const [correlations, setCorre] = useState([]);
        
        const mainChartRef = useRef(null);
        const uwChartRef = useRef(null);
        const mainCanvas = useRef(null);
        const uwCanvas = useRef(null);

        const addRow = () => rows.length < 5 && setRows([...rows, {id: Date.now(), v:''}]);
        const upd = (id,v) => setRows(rows.map(r=>r.id===id?{...r,v:v.toUpperCase()}:r));
        const del = id => setRows(rows.filter(r=>r.id!==id));

        const run = async () => {
            setIsLoading(true);
            const tickers = rows.map(r=>r.v.trim()).filter(Boolean);
            if(!tickers.length) { setIsLoading(false); return; }

            const map = {};
            for(const t of tickers) map[t] = await fetchStooq(t);

            // Period Filter
            const end = new Date(); const start = new Date();
            const m = {'1M':-1,'6M':-6,'1Y':-12,'YTD':0}[period]||-12;
            if(period==='YTD') start.setMonth(0,1); else start.setMonth(end.getMonth()+m);
            const sStr = start.toISOString().slice(0,10);
            
            // Align Dates (Intersection)
            const allDates = [...new Set(Object.values(map).flat().map(p=>p.date))].filter(d=>d>=sStr).sort();
            // Simple alignment: require price on date
            
            const datasets = [], uwDatasets = [], calculatedStats = [];
            const priceArrays = {}; // For correlation

            tickers.forEach((t,i) => {
                const raw = map[t]?.filter(p=>p.date>=sStr);
                if(!raw?.length) return;
                
                // Align data to allDates (fill gaps or null)
                const alignedPrices = allDates.map(dt => {
                    const f = raw.find(p=>p.date===dt);
                    return f ? f.price : null;
                });
                
                // Filter out leading nulls for normalization base
                const validIdx = alignedPrices.findIndex(v=>v!==null);
                if(validIdx === -1) return;
                const base = alignedPrices[validIdx];
                const normalized = alignedPrices.map(v => v ? (v/base-1)*100 : null);
                
                // Drawdown Calculation
                let peak = -Infinity;
                const drawdown = alignedPrices.map(v => {
                    if(v === null) return null;
                    if(v > peak) peak = v;
                    return ((v - peak) / peak) * 100;
                });

                // Stats
                const cleanPrices = alignedPrices.filter(v=>v!==null);
                priceArrays[t] = cleanPrices;
                
                const ret = calculateReturn(cleanPrices);
                const vol = calculateVol(cleanPrices);
                const mdd = calculateMDD(cleanPrices);
                const color = ["#010079", "#D5AD36", "#16a34a", "#ef4444", "#8b5cf6"][i%5];

                datasets.push({ label: t, data: normalized, borderColor: color, borderWidth: 2, pointRadius: 0, tension: 0.1 });
                uwDatasets.push({ label: t, data: drawdown, borderColor: color, backgroundColor: color+'10', borderWidth: 1, pointRadius: 0, fill: true });
                
                calculatedStats.push({ sym: t, ret, vol, mdd, eff: ret/Math.abs(mdd), color });
            });

            // Correlation Matrix
            const corrMatrix = [];
            const validTickers = calculatedStats.map(s=>s.sym);
            // Need common length for correlation - approximate by taking intersection of dates present in both
            // For simplicity in this demo, using the cleaned price arrays (assuming roughly same length/period)
            // Ideally should align by date strictly.
            
            for(let a of validTickers) {
                const row = [];
                for(let b of validTickers) {
                    // Re-align a and b strictly
                    // Skipping strict alignment for demo speed, using pre-calculated arrays (risk of mismatch)
                    // In prod: map both to common date index
                    const val = calculateCorrelation(priceArrays[a], priceArrays[b]);
                    row.push(val);
                }
                corrMatrix.push({ name: a, values: row });
            }

            setChartData({ labels: allDates, main: datasets, uw: uwDatasets });
            setStats(calculatedStats.sort((a,b)=>b.eff - a.eff)); // Rank by Efficiency
            setCorre(corrMatrix);
            setIsLoading(false);
        };

        // Chart Rendering
        useEffect(() => {
            if(!chartData) return;
            
            // Main Chart
            if(mainChartRef.current) mainChartRef.current.destroy();
            mainChartRef.current = new Chart(mainCanvas.current, {
                type: 'line', data: { labels: chartData.labels, datasets: chartData.main },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    interaction: { mode: 'index', intersect: false },
                    scales: { x: { display: false }, y: { grid: { color: '#e2e8f0' } } },
                    plugins: { legend: { display: false } }
                }
            });

            // Underwater Chart
            if(uwChartRef.current) uwChartRef.current.destroy();
            uwChartRef.current = new Chart(uwCanvas.current, {
                type: 'line', data: { labels: chartData.labels, datasets: chartData.uw },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    interaction: { mode: 'index', intersect: false },
                    scales: { x: { display: false, ticks: { maxTicksLimit: 6 } }, y: { min: -50, max: 0, grid: { color: '#e2e8f0' } } },
                    plugins: { legend: { display: false } }
                }
            });

        }, [chartData]);

        return (
            <div className="h-full flex flex-col">
                <nav className="omega-nav">
                    <div className="flex items-center gap-3">
                        <span className="font-[900] text-2xl tracking-tighter text-slate-900">OMEGA<span className="text-brand-interactive">.TERMINAL</span></span>
                        <span className="bg-slate-100 text-slate-500 px-2 py-1 rounded text-[10px] font-bold tracking-widest border border-slate-200">v6.0 PRO</span>
                    </div>
                    <div className="flex gap-4">
                        {['1M','3M','6M','YTD','1Y'].map(p=>(
                            <button key={p} onClick={()=>setPeriod(p)} className={`text-xs font-bold px-3 py-1 rounded-full transition-all ${period===p?'bg-brand-navy text-white shadow-lg':'text-slate-400 hover:text-slate-600'}`}>{p}</button>
                        ))}
                        <button onClick={run} className="bg-brand-interactive text-white px-6 py-1.5 rounded-full text-xs font-black shadow-lg hover:bg-blue-600 transition-transform active:scale-95 flex items-center gap-2">
                            {isLoading ? <i className="fas fa-spinner fa-spin"></i> : <i className="fas fa-bolt"></i>} EXECUTE
                        </button>
                    </div>
                </nav>

                <div className="omega-grid">
                    
                    {/* 1. Sidebar: Asset Config */} 
                    <div className="panel area-sidebar p-4 bg-white">
                        <div className="flex justify-between items-center mb-4">
                            <span className="label-xs">Asset Configuration</span>
                            <button onClick={addRow} className="text-blue-600 hover:text-blue-800"><i className="fas fa-plus-circle"></i></button>
                        </div>
                        <div className="flex-1 overflow-y-auto pr-2">
                            {rows.map(r=>(
                                <div key={r.id} className="ticker-chip group">
                                    <div className="flex items-center gap-3">
                                        <div className="w-8 h-8 rounded-lg bg-white border border-slate-200 flex items-center justify-center shadow-sm text-slate-400 group-hover:text-blue-600 group-hover:border-blue-200 transition-colors">
                                            <i className="fas fa-chart-line"></i>
                                        </div>
                                        <input value={r.v} onChange={e=>upd(r.id,e.target.value)} placeholder="SYM" />
                                    </div>
                                    <button onClick={()=>del(r.id)} className="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><i className="fas fa-trash-alt"></i></button>
                                </div>
                            ))}
                        </div>
                        <div className="mt-4 p-4 bg-slate-50 rounded-xl border border-slate-100">
                            <p className="label-xs mb-2">System Status</p>
                            <div className="flex items-center gap-2 text-xs font-bold text-green-600">
                                <span className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                                APIs Operational
                            </div>
                        </div>
                    </div>

                    {/* 2. Main Chart */} 
                    <div className="panel area-main p-4 bg-white relative">
                        <div className="absolute top-4 left-4 z-10 flex gap-4">
                            <div><p className="label-xs">Primary View</p><h2 className="font-bold text-slate-800">Performance (%)</h2></div>
                        </div>
                        <div className="flex-1 relative mt-4">
                            <canvas ref={mainCanvas}></canvas>
                        </div>
                    </div>

                    {/* 3. Underwater Chart */} 
                    <div className="panel area-underwater p-4 bg-slate-50 border-slate-200">
                        <div className="absolute top-4 left-4 z-10">
                            <p className="label-xs text-slate-500">Risk Analysis</p>
                            <h2 className="font-bold text-slate-700 text-sm">Drawdown (Underwater)</h2>
                        </div>
                        <div className="flex-1 relative mt-6">
                            <canvas ref={uwCanvas}></canvas>
                        </div>
                    </div>

                    {/* 4. Efficiency Metrics */} 
                    <div className="panel area-metrics p-4 bg-white">
                        <span className="label-xs mb-3 block">Efficiency Scorecard (Ret/MDD)</span>
                        <div className="space-y-3 overflow-y-auto flex-1 pr-1">
                            {stats.map((s, i)=>(
                                <div key={s.sym} className="flex items-center justify-between p-3 rounded-lg border border-slate-100 bg-slate-50">
                                    <div className="flex items-center gap-3">
                                        <span className={`text-xs font-black w-4 text-center ${i===0?'text-brand-gold':'text-slate-400'}`}>{i+1}</span>
                                        <div className="flex flex-col">
                                            <span className="font-bold text-sm text-slate-800 flex items-center gap-2">
                                                <span className="w-2 h-2 rounded-full" style={{background:s.color}}></span>
                                                {s.sym}
                                            </span>
                                            <span className="text-[10px] text-slate-400">Vol {Math.round(s.vol)}%</span>
                                        </div>
                                    </div>
                                    <div className="text-right">
                                        <div className="text-sm font-black text-brand-interactive">{s.eff.toFixed(2)}</div>
                                        <div className="text-[10px] text-red-500 font-bold">DD {Math.round(s.mdd)}%</div>
                                    </div>
                                </div>
                            ))}
                            {!stats.length && <div className="text-center text-xs text-slate-400 py-10">Run Analysis</div>}
                        </div>
                    </div>

                    {/* 5. Correlation Matrix */} 
                    <div className="panel area-correlation p-4 bg-white">
                        <span className="label-xs mb-2 block">Correlation Heatmap</span>
                        <div className="flex-1 flex items-center justify-center">
                            {!correlations.length ? (
                                <div className="text-slate-300 text-4xl"><i className="fas fa-th"></i></div>
                            ) : (
                                <div className="heatmap-grid" style={{gridTemplateColumns: `repeat(${correlations.length}, 1fr)`}}>
                                    {correlations.map(row => (
                                        row.values.map((val, idx) => (
                                            <div key={idx} className="heatmap-cell" 
                                                style={{backgroundColor: `rgba(27, 115, 211, ${Math.abs(val)})`}}
                                                title={`${row.name} vs ${correlations[idx].name}: ${val.toFixed(2)}`}>
                                                {val.toFixed(1)}
                                            </div>
                                        ))
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>

                </div>
            </div>
        );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>