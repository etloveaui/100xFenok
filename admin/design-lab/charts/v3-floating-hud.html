<!DOCTYPE html><html lang="ko"><head>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&amp;family=Noto+Sans+KR:wght@500;700&amp;display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { brand: { navy: '#010079', gold: '#D5AD36' } }
        }
      }
    }
  </script>
  <meta charset="utf-8">
  <title>Multichart v3 - Floating HUD</title>
  
  <style>
    body { font-family: 'Noto Sans KR', sans-serif; background-color: #ffffff; height: 100vh; overflow: hidden; position: relative; }
    
    /* Fullscreen Chart */
    .chart-fullscreen { position: absolute; inset: 0; padding: 60px 20px 20px 20px; z-index: 0; }
    
    /* Floating HUD */
    .hud-panel {
        position: absolute; top: 80px; left: 20px; width: 280px;
        background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.5); border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        z-index: 10; padding: 1.5rem;
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .hud-panel.collapsed { transform: translateX(-120%); }
    
    /* Toggle Button */
    .hud-toggle {
        position: absolute; top: 80px; left: 20px; z-index: 9;
        width: 40px; height: 40px; background: white; border-radius: 50%;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center;
        cursor: pointer; transition: opacity 0.3s;
    }
    .hud-panel:not(.collapsed) + .hud-toggle { opacity: 0; pointer-events: none; }

    /* Nav (Transparent) */
    .nav-glass {
        position: absolute; top: 0; left: 0; right: 0; height: 60px;
        display: flex; justify-content: space-between; align-items: center; padding: 0 1.5rem;
        z-index: 20; background: linear-gradient(to bottom, rgba(255,255,255,1) 0%, rgba(255,255,255,0) 100%);
    }

    /* Elements */
    .tag-input {
        background: rgba(255,255,255,0.5); border: 1px solid #cbd5e1; padding: 0.5rem; border-radius: 8px; width: 100%; font-weight: 700; text-transform: uppercase;
    }
    .btn-hud {
        width: 100%; padding: 0.75rem; background: #0f172a; color: white; border-radius: 12px; font-weight: 700;
        box-shadow: 0 4px 12px rgba(15, 23, 42, 0.2); transition: transform 0.1s;
    }
    .btn-hud:active { transform: scale(0.98); }

    /* Summary overlay */
    .summary-overlay {
        position: absolute; bottom: 20px; left: 20px; right: 20px;
        display: flex; gap: 1rem; overflow-x: auto; pointer-events: none;
    }
    .stat-pill {
        background: rgba(255,255,255,0.9); backdrop-filter: blur(4px); padding: 0.5rem 1rem; border-radius: 99px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05); pointer-events: auto; display: flex; align-items: center; gap: 0.5rem;
        border: 1px solid white; white-space: nowrap; font-size: 0.875rem;
    }
  </style>

  <script defer="" src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
  <script defer="" src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script defer="" src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script defer="" src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script defer="" src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>

  <div id="root" class="h-full"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect, useCallback } = React;
    
    /* [LOGIC COPY] Original logic included here... */
    const API_KEYS = ['QQHTQMTRUSFFD4UB','ZHWYM2BSS73UH9YI','SE3NG2WW0BDJY42J','QXJT87SAUPW50BM8','T6D38694XL3V6CGA','1GJ75NRCELNNYBPU','5Y3HTLFEA4WMKBNI'];
    const rotateKey = (() => { let idx = -1; return () => { idx = (idx + 1) % API_KEYS.length; return API_KEYS[idx]; }; })();
    const DELAY_MS = Math.ceil(60000 / (5 * API_KEYS.length));
    const PALETTE = ["#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd", "#8c564b", "#e377c2", "#7f7f7f", "#bcbd22", "#17becf"];
    const getColor = i => PALETTE[i % PALETTE.length];
    const STOOQ_PROXY = 'https://stooq-proxy.etloveaui.workers.dev';

    function toStooqSymbol(symbol) {
        if (symbol.startsWith('^')) return symbol.toLowerCase();
        if (/^[0-9]{6}\.KS$/i.test(symbol)) return symbol.slice(0,6).toLowerCase()+'.kr';
        return symbol.toLowerCase() + '.us';
    }

    async function fetchStooq(symbol) {
        const stoSym = toStooqSymbol(symbol);
        const cacheKey = `stooq_cache_${stoSym}`;
        const c = JSON.parse(localStorage.getItem(cacheKey)||'{}');
        if (c.ts && Date.now() - c.ts < 86400000) return c.data;
        
        const url = STOOQ_PROXY + encodeURIComponent(`https://stooq.com/q/d/l/?s=${stoSym}&i=d`);
        const res = await fetch(url);
        if (!res.ok) throw new Error('Proxy error');
        const txt = await res.text();
        if (!txt.startsWith('Date')) throw new Error('CSV format');
        const data = txt.trim().split('\n').slice(1).map(l => {
            const f = l.split(','); return { date: f[0], price: +f[4] };
        }).sort((a,b)=>a.date.localeCompare(b.date));
        
        localStorage.setItem(cacheKey, JSON.stringify({ts:Date.now(), data}));
        return data;
    }

    async function fetchPriceDataAlpha(symbol) { return []; } 
    async function fetchPriceData(symbol) {
        try { return await fetchStooq(symbol); } catch (e) { console.warn(e); return []; }
    }

    const calculateMDD = prices => {
        let peak = -Infinity, maxDD = 0;
        prices.forEach(p => { if (p > peak) peak = p; const dd = (p - peak) / peak; if (dd < maxDD) maxDD = dd; });
        return maxDD * -100;
    };
    const calculateVolatility = prices => {
        if (prices.length < 2) return 0;
        const rets = []; for (let i = 1; i < prices.length; i++) rets.push(Math.log(prices[i] / prices[i - 1]));
        const mean = rets.reduce((a, b) => a + b, 0) / rets.length;
        const variance = rets.reduce((a, v) => a + (v - mean) ** 2, 0) / (rets.length - 1);
        return Math.sqrt(variance) * Math.sqrt(252) * 100;
    };

    function App() {
        const [rows, setRows] = useState([{ id: 1, v: 'TQQQ' }, { id: 2, v: 'SOXL' }]);
        const [isCollapsed, setCollapsed] = useState(false);
        const [summary, setSummary] = useState([]);
        const [period, setPeriod] = useState('1Y');
        const canvasRef = useRef(null);
        const chartRef = useRef(null);

        const addRow = () => rows.length < 4 && setRows([...rows, { id: Date.now(), v: '' }]);
        const upd = (id, v) => setRows(rows.map(r => r.id === id ? { ...r, v: v.toUpperCase() } : r));
        const del = id => setRows(rows.filter(r => r.id !== id));

        const run = async () => {
            const tickers = rows.map(r => r.v.trim()).filter(Boolean);
            if(!tickers.length) return;
            
            const dataMap = {};
            for(const t of tickers) { try { dataMap[t] = await fetchStooq(t); } catch(e){} }
            
            // Period Logic
            const endDt = new Date(); const startDt = new Date();
            const m = { '1M': -1, '3M': -3, '6M': -6, '1Y': -12 }[period] || -12;
            startDt.setMonth(endDt.getMonth() + m);
            const sStr = startDt.toISOString().slice(0, 10);

            const allDates = [...new Set(Object.values(dataMap).flat().map(p=>p.date))].filter(d=>d>=sStr).sort();
            const datasets = [], sum = [];

            tickers.forEach((t, i) => {
                const full = dataMap[t]; if(!full) return;
                const filtered = full.filter(p=>p.date >= sStr);
                if(!filtered.length) return;
                const first = filtered[0].price;
                const color = getColor(i);
                
                datasets.push({
                    label: t,
                    data: allDates.map(dt => { const f=filtered.find(p=>p.date===dt); return f ? (f.price/first-1)*100 : null; }),
                    borderColor: color,
                    borderWidth: 2, pointRadius: 0, tension: 0.1
                });
                
                const lastPrice = filtered[filtered.length-1].price;
                sum.push({
                    sym: t, 
                    ret: ((lastPrice/first-1)*100).toFixed(2), 
                    mdd: calculateMDD(filtered.map(p=>p.price)).toFixed(2),
                    vol: calculateVolatility(filtered.map(p=>p.price)).toFixed(2),
                    color 
                });
            });

            setSummary(sum.sort((a,b)=>b.ret - a.ret));
            if(chartRef.current) chartRef.current.destroy();
            chartRef.current = new Chart(canvasRef.current, {
                type: 'line',
                data: { labels: allDates, datasets },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { display: false }, y: { grid: { display: false } } }, plugins: { legend: { display: false } } }
            });
        };

        return (
            <div className="h-full relative bg-gradient-to-br from-white to-blue-50">
                <nav className="nav-glass">
                    <span className="font-[900] orbitron text-slate-800 text-xl">100x HUD</span>
                    <button onClick={()=>setCollapsed(!isCollapsed)} className="text-slate-500 hover:text-slate-800"><i className={`fas fa-${isCollapsed?'bars':'times'}`}></i></button>
                </nav>

                <div className={`hud-panel ${isCollapsed?'collapsed':''}`}>
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="font-bold text-slate-400 text-xs uppercase">Assets</h3>
                        <button onClick={()=>setCollapsed(true)} className="text-slate-400"><i className="fas fa-chevron-left"></i></button>
                    </div>
                    {rows.map(r => (
                        <div key={r.id} className="flex gap-2 mb-2">
                            <input value={r.v} onChange={e=>upd(r.id, e.target.value)} className="tag-input" placeholder="SYM" />
                            <button onClick={()=>del(r.id)} className="text-slate-400 hover:text-red-500"><i className="fas fa-minus"></i></button>
                        </div>
                    ))}
                    <button onClick={addRow} className="text-xs font-bold text-blue-500 mb-6">+ Add</button>
                    
                    <h3 className="font-bold text-slate-400 text-xs uppercase mb-2">Period</h3>
                    <div className="flex gap-1 mb-6">
                        {['1M','3M','6M','1Y'].map(p=>(
                            <button key={p} onClick={()=>setPeriod(p)} className={`flex-1 py-1 text-xs rounded border ${period===p?'bg-blue-600 text-white border-blue-600':'bg-white text-slate-500'}`}>{p}</button>
                        ))}
                    </div>

                    <button onClick={run} className="btn-hud">UPDATE</button>
                </div>

                <div className="hud-toggle" onClick={()=>setCollapsed(false)}><i className="fas fa-sliders-h text-slate-600"></i></div>

                <div className="chart-fullscreen">
                    <canvas ref={canvasRef}></canvas>
                </div>

                <div className="summary-overlay custom-scrollbar">
                    {summary.map(s => (
                        <div key={s.sym} className="stat-pill">
                            <span className="w-2 h-2 rounded-full" style={{background:s.color}}></span>
                            <span className="font-bold text-slate-700">{s.sym}</span>
                            <span className={`font-bold ${s.ret>=0?'text-green-600':'text-red-500'}`}>{s.ret}%</span>
                            <span className="text-xs text-slate-400 border-l pl-2 ml-1">Vol {s.vol}%</span>
                        </div>
                    ))}
                </div>
            </div>
        );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>