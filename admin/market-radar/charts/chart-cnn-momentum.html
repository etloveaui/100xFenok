<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Market Momentum | Market Radar</title>
  <meta name="robots" content="noindex, nofollow">
  <link rel="icon" type="image/x-icon" href="../../../favicon.ico">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; }
    body { background: #f8fafc; }

    /* Stats Cards */
    .stats-card {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 12px 16px;
    }
    .stat-label { font-size: 11px; color: #64748b; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-value { font-size: 24px; font-weight: 700; color: #0f172a; }

    /* Smart Dropdown */
    .period-dropdown { position: relative; }
    .period-btn {
      display: flex; align-items: center; gap: 8px;
      padding: 10px 16px; border-radius: 12px;
      background: white; border: 2px solid #e2e8f0;
      font-weight: 600; color: #334155; cursor: pointer;
      transition: all 0.2s;
    }
    .period-btn:hover { border-color: #14b8a6; }
    .period-btn svg { width: 16px; height: 16px; transition: transform 0.2s; }
    .period-btn.open svg { transform: rotate(180deg); }

    .period-panel {
      display: none; position: absolute; top: calc(100% + 8px); right: 0;
      background: white; border: 2px solid #e2e8f0; border-radius: 16px;
      padding: 16px; min-width: 320px; z-index: 100;
      box-shadow: 0 20px 40px rgba(0,0,0,0.15);
    }
    .period-panel.open { display: block; }

    .period-section-title { font-size: 11px; font-weight: 600; color: #94a3b8; margin: 12px 0 8px; text-transform: uppercase; }
    .period-section-title:first-child { margin-top: 0; }

    .period-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
    .period-chip {
      padding: 8px 12px; border-radius: 8px; font-size: 13px; font-weight: 600;
      background: #f1f5f9; color: #64748b; cursor: pointer; text-align: center;
      transition: all 0.15s; border: 2px solid transparent;
    }
    .period-chip:hover { background: #ccfbf1; color: #14b8a6; }
    .period-chip.active { background: #14b8a6; color: white; }

    .custom-range { display: flex; gap: 8px; align-items: center; margin-top: 8px; }
    .custom-range input { flex: 1; padding: 8px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 13px; }
    .custom-range input:focus { outline: none; border-color: #14b8a6; }
    .apply-btn { padding: 8px 16px; background: #14b8a6; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
    .apply-btn:hover { background: #0d9488; }

    /* Mobile */
    .period-backdrop { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 99; }
    .period-backdrop.open { display: block; }

    @media (max-width: 640px) {
      .period-panel {
        position: fixed; left: 16px; right: 16px; top: auto; bottom: 16px;
        border-radius: 20px; max-height: 70vh; overflow-y: auto;
      }
      .period-grid { grid-template-columns: repeat(3, 1fr); }
    }
  </style>
</head>
<body class="p-4 sm:p-6">

  <!-- Header -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
    <div>
      <h1 class="text-xl font-bold text-slate-800 flex items-center gap-2">
        <span class="text-2xl">ðŸš€</span>
        Market Momentum
      </h1>
      <p class="text-sm text-slate-500 mt-1">S&P 500 vs 125-day MA - CNN Fear & Greed Sub-indicator</p>
    </div>

    <div class="flex items-center gap-3">
      <!-- Period Dropdown -->
      <div class="period-dropdown">
        <button class="period-btn" id="periodBtn">
          <span id="periodLabel">1Y</span>
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
        </button>
        <div class="period-panel" id="periodPanel">
          <div class="period-section-title">Recent</div>
          <div class="period-grid">
            <div class="period-chip" data-period="30" data-label="1M">1M</div>
            <div class="period-chip" data-period="90" data-label="3M">3M</div>
            <div class="period-chip" data-period="180" data-label="6M">6M</div>
            <div class="period-chip active" data-period="365" data-label="1Y">1Y</div>
          </div>
          <div class="period-section-title">Extended</div>
          <div class="period-grid">
            <div class="period-chip" data-period="730" data-label="2Y">2Y</div>
            <div class="period-chip" data-period="9999" data-label="MAX">MAX</div>
          </div>
          <div class="period-section-title">Historical</div>
          <div class="period-grid">
            <div class="period-chip" data-period="since_2024" data-label="2024~">2024~</div>
            <div class="period-chip" data-period="ytd" data-label="YTD">YTD</div>
          </div>
          <div class="period-section-title">Custom</div>
          <div class="custom-range">
            <input type="date" id="startDate" value="2024-01-01">
            <span class="text-slate-400">~</span>
            <input type="date" id="endDate">
            <button class="apply-btn" id="applyCustom">Apply</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Backdrop (Mobile) -->
  <div class="period-backdrop" id="periodBackdrop"></div>

  <!-- Stats Cards -->
  <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-6">
    <div class="stats-card">
      <div class="stat-label">S&P 500</div>
      <div id="priceValue" class="stat-value">--</div>
    </div>
    <div class="stats-card">
      <div class="stat-label">125-day MA</div>
      <div id="maValue" class="stat-value text-lg text-slate-600">--</div>
    </div>
    <div class="stats-card">
      <div class="stat-label">Status</div>
      <div id="statusValue" class="stat-value text-base">--</div>
    </div>
    <div class="stats-card">
      <div class="stat-label">Date</div>
      <div id="dateValue" class="stat-value text-base text-slate-600">--</div>
    </div>
  </div>

  <!-- Chart -->
  <div class="bg-white rounded-2xl border border-slate-200 p-4 shadow-sm">
    <canvas id="mainChart" height="360"></canvas>
  </div>

  <!-- Legend -->
  <div class="mt-4 flex flex-wrap gap-4 text-xs text-slate-600">
    <div class="flex items-center gap-2">
      <div class="w-3 h-3 rounded-full" style="background: #3b82f6;"></div>
      <span>S&P 500</span>
    </div>
    <div class="flex items-center gap-2">
      <div class="w-4 h-0.5 rounded" style="background: #f97316; border-style: dashed;"></div>
      <span>125-day MA</span>
    </div>
    <div class="flex items-center gap-2">
      <div class="w-4 h-3 bg-green-500 opacity-20 rounded"></div>
      <span>Above MA (Greed)</span>
    </div>
    <div class="flex items-center gap-2">
      <div class="w-4 h-3 bg-red-500 opacity-20 rounded"></div>
      <span>Below MA (Fear)</span>
    </div>
  </div>

  <script type="module">
    let allData = [];
    let chart = null;
    let currentPeriod = 365;
    const MA_PERIOD = 125;

    // Fetch data
    async function fetchData() {
      try {
        const response = await fetch('../../../data/sentiment/cnn-momentum.json');
        allData = await response.json();
        allData.sort((a, b) => new Date(a.date) - new Date(b.date));
      } catch (error) {
        console.error('Failed to fetch data:', error);
      }
    }

    // Calculate 125-day MA
    function calculateMA(data, period) {
      const result = [];
      for (let i = 0; i < data.length; i++) {
        if (i < period - 1) {
          result.push(null);
        } else {
          let sum = 0;
          for (let j = 0; j < period; j++) {
            sum += data[i - j].value;
          }
          result.push(sum / period);
        }
      }
      return result;
    }

    // Filter by period (extended)
    function filterByPeriod(data, period) {
      if (period === 'ytd') {
        const year = new Date().getFullYear();
        return data.filter(d => new Date(d.date).getFullYear() === year);
      }
      if (typeof period === 'string' && period.startsWith('since_')) {
        const year = parseInt(period.replace('since_', ''));
        return data.filter(d => new Date(d.date).getFullYear() >= year);
      }
      if (typeof period === 'object' && period.start && period.end) {
        const start = new Date(period.start);
        const end = new Date(period.end);
        return data.filter(d => {
          const date = new Date(d.date);
          return date >= start && date <= end;
        });
      }
      if (period >= 9999) return data;
      const cutoff = new Date();
      cutoff.setDate(cutoff.getDate() - period);
      return data.filter(d => new Date(d.date) >= cutoff);
    }

    // Update stats display
    function updateStats(data, maValues) {
      if (!data.length) return;
      const latestIdx = data.length - 1;
      const latest = data[latestIdx];
      const value = latest.value;
      const ma = maValues[latestIdx];

      document.getElementById('priceValue').textContent = value.toLocaleString('en-US', { maximumFractionDigits: 2 });
      document.getElementById('maValue').textContent = ma ? ma.toLocaleString('en-US', { maximumFractionDigits: 2 }) : '--';
      document.getElementById('dateValue').textContent = latest.date;

      const statusEl = document.getElementById('statusValue');
      if (ma && value > ma * 1.05) {
        statusEl.textContent = 'STRONG GREED';
        statusEl.className = 'stat-value text-base px-2 py-1 rounded bg-green-600 text-white';
      } else if (ma && value > ma) {
        statusEl.textContent = 'GREED';
        statusEl.className = 'stat-value text-base px-2 py-1 rounded bg-green-100 text-green-800';
      } else if (ma && value < ma * 0.95) {
        statusEl.textContent = 'STRONG FEAR';
        statusEl.className = 'stat-value text-base px-2 py-1 rounded bg-red-600 text-white';
      } else if (ma && value < ma) {
        statusEl.textContent = 'FEAR';
        statusEl.className = 'stat-value text-base px-2 py-1 rounded bg-red-100 text-red-800';
      } else {
        statusEl.textContent = 'NEUTRAL';
        statusEl.className = 'stat-value text-base px-2 py-1 rounded bg-yellow-100 text-yellow-800';
      }
    }

    // Render chart
    function renderChart(data) {
      const ctx = document.getElementById('mainChart').getContext('2d');
      const dates = data.map(d => d.date);
      const values = data.map(d => d.value);

      // Calculate MA for filtered data (need full data for accurate MA)
      const fullMA = calculateMA(allData, MA_PERIOD);
      const startIdx = allData.findIndex(d => d.date === data[0]?.date);
      const maValues = startIdx >= 0 ? fullMA.slice(startIdx, startIdx + data.length) : [];

      updateStats(data, maValues);

      // Find where price crosses MA for zone coloring
      const minVal = Math.min(...values);
      const maxVal = Math.max(...values);

      const config = {
        type: 'line',
        data: {
          labels: dates,
          datasets: [
            {
              label: 'S&P 500',
              data: values,
              borderColor: '#3b82f6',
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              fill: true,
              tension: 0.3,
              pointRadius: 0,
              pointHoverRadius: 5,
              borderWidth: 2.5,
              order: 1
            },
            {
              label: '125-day MA',
              data: maValues,
              borderColor: '#f97316',
              backgroundColor: 'transparent',
              fill: false,
              tension: 0.3,
              pointRadius: 0,
              pointHoverRadius: 4,
              borderWidth: 2.5,
              borderDash: [6, 4],
              order: 0
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          scales: {
            x: {
              type: 'time',
              time: {
                unit: typeof currentPeriod === 'number' && currentPeriod <= 365 ? 'month' : 'quarter',
                displayFormats: { month: 'MMM yyyy', quarter: 'QQQ yyyy', year: 'yyyy' }
              },
              grid: { display: false },
              ticks: { maxTicksLimit: 8, color: '#94a3b8', font: { size: 11 } }
            },
            y: {
              grid: { color: '#f1f5f9' },
              ticks: {
                color: '#64748b',
                font: { size: 11 },
                callback: (v) => v.toLocaleString()
              }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(15, 23, 42, 0.9)',
              titleColor: '#fff',
              bodyColor: '#fff',
              cornerRadius: 10,
              padding: 12,
              callbacks: {
                title: (items) => items[0].label,
                label: (context) => {
                  const v = context.parsed.y;
                  if (context.datasetIndex === 0) {
                    return `S&P 500: ${v?.toLocaleString('en-US', { maximumFractionDigits: 2 }) || '--'}`;
                  } else {
                    return `125-day MA: ${v?.toLocaleString('en-US', { maximumFractionDigits: 2 }) || '--'}`;
                  }
                }
              }
            }
          }
        }
      };

      if (chart) chart.destroy();
      chart = new Chart(ctx, config);
    }

    // Setup dropdown
    function setupDropdown() {
      const btn = document.getElementById('periodBtn');
      const panel = document.getElementById('periodPanel');
      const backdrop = document.getElementById('periodBackdrop');
      const label = document.getElementById('periodLabel');

      btn.addEventListener('click', () => {
        btn.classList.toggle('open');
        panel.classList.toggle('open');
        backdrop.classList.toggle('open');
      });

      backdrop.addEventListener('click', () => {
        btn.classList.remove('open');
        panel.classList.remove('open');
        backdrop.classList.remove('open');
      });

      document.querySelectorAll('.period-chip').forEach(chip => {
        chip.addEventListener('click', () => {
          document.querySelectorAll('.period-chip').forEach(c => c.classList.remove('active'));
          chip.classList.add('active');
          currentPeriod = chip.dataset.period.startsWith('since_') || chip.dataset.period === 'ytd'
            ? chip.dataset.period
            : parseInt(chip.dataset.period);
          label.textContent = chip.dataset.label;
          btn.classList.remove('open');
          panel.classList.remove('open');
          backdrop.classList.remove('open');
          updateChart();
        });
      });

      document.getElementById('applyCustom').addEventListener('click', () => {
        const start = document.getElementById('startDate').value;
        const end = document.getElementById('endDate').value || new Date().toISOString().split('T')[0];
        if (start) {
          currentPeriod = { start, end };
          label.textContent = 'Custom';
          btn.classList.remove('open');
          panel.classList.remove('open');
          backdrop.classList.remove('open');
          updateChart();
        }
      });
    }

    // Update chart with current settings
    function updateChart() {
      const filtered = filterByPeriod(allData, currentPeriod);
      renderChart(filtered);
    }

    // Initialize
    async function init() {
      await fetchData();
      document.getElementById('endDate').value = new Date().toISOString().split('T')[0];
      updateChart();
      setupDropdown();
    }

    init();
  </script>

</body>
</html>
