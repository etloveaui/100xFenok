<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VIX & MOVE Dual Chart | Market Radar</title>
  <meta name="robots" content="noindex, nofollow">
  <link rel="icon" type="image/x-icon" href="../../../favicon.ico">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1"></script>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: #ffffff;
    }
    .orbitron { font-family: 'Orbitron', monospace; }
    .period-btn {
      padding: 6px 14px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.2s;
      border: 1px solid #e5e7eb;
      background: white;
      color: #6b7280;
    }
    .period-btn:hover {
      border-color: #6366f1;
      color: #6366f1;
    }
    .period-btn.active {
      background: #6366f1;
      color: white;
      border-color: #6366f1;
    }
    .stress-alert {
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
  </style>
</head>
<body class="p-4 sm:p-6">

  <!-- Header -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
    <div>
      <h1 class="text-xl font-bold text-gray-800 flex items-center gap-2">
        <span class="text-2xl">‚ö°üìà</span>
        VIX & MOVE Volatility
      </h1>
      <p class="text-sm text-gray-500 mt-1">Stock (VIX 1990~) + Bond (MOVE 2020~) Volatility Dual Axis</p>
    </div>

    <!-- Period Selector -->
    <div class="flex gap-2 flex-wrap">
      <button class="period-btn active" data-period="365">1Y</button>
      <button class="period-btn" data-period="1825">5Y</button>
      <button class="period-btn" data-period="3650">10Y</button>
      <button class="period-btn" data-period="7300">20Y</button>
      <button class="period-btn" data-period="9999">MAX</button>
    </div>
  </div>

  <!-- Current Values Display -->
  <div class="flex flex-wrap items-center gap-6 mb-6 p-4 bg-gray-50 rounded-xl">
    <!-- VIX -->
    <div class="flex items-center gap-3">
      <div class="w-3 h-3 rounded-full bg-red-500"></div>
      <div>
        <div class="text-xs text-gray-500 mb-1">VIX (Stock)</div>
        <div id="vixValue" class="text-2xl font-bold text-red-600">--</div>
      </div>
    </div>
    <!-- MOVE -->
    <div class="flex items-center gap-3">
      <div class="w-3 h-3 rounded-full bg-teal-500"></div>
      <div>
        <div class="text-xs text-gray-500 mb-1">MOVE (Bond)</div>
        <div id="moveValue" class="text-2xl font-bold text-teal-600">--</div>
      </div>
    </div>
    <!-- Date -->
    <div>
      <div class="text-xs text-gray-500 mb-1">Date</div>
      <div id="currentDate" class="text-lg font-medium text-gray-600">--</div>
    </div>
    <!-- Status Badge -->
    <div id="statusBadge" class="ml-auto px-4 py-2 rounded-lg text-sm font-bold">
      --
    </div>
  </div>

  <!-- Stress Alert (hidden by default) -->
  <div id="stressAlert" class="hidden mb-4 p-4 bg-red-50 border-2 border-red-400 rounded-xl stress-alert">
    <div class="flex items-center gap-3">
      <span class="text-2xl">üö®</span>
      <div>
        <div class="font-bold text-red-800">DUAL STRESS ALERT</div>
        <div class="text-sm text-red-600">VIX ‚â•30 AND MOVE ‚â•120: Both stock and bond markets showing elevated volatility</div>
      </div>
    </div>
  </div>

  <!-- Chart -->
  <div class="bg-white rounded-2xl border border-gray-200 p-4">
    <canvas id="dualChart" height="360"></canvas>
  </div>

  <!-- Legend -->
  <div class="mt-4 flex flex-wrap gap-4 text-xs text-gray-600">
    <div class="flex items-center gap-2">
      <div class="w-4 h-1 bg-red-500 rounded"></div>
      <span>VIX (Left Axis)</span>
    </div>
    <div class="flex items-center gap-2">
      <div class="w-4 h-1 bg-teal-500 rounded"></div>
      <span>MOVE (Right Axis)</span>
    </div>
    <div class="flex items-center gap-2">
      <div class="w-4 h-3 bg-red-500 opacity-20 rounded"></div>
      <span>VIX Fear Zone (‚â•30)</span>
    </div>
    <div class="flex items-center gap-2">
      <div class="w-4 h-3 bg-teal-500 opacity-20 rounded"></div>
      <span>MOVE Stress Zone (‚â•120)</span>
    </div>
    <div class="flex items-center gap-2">
      <div class="w-4 h-3 bg-gray-500 opacity-10 rounded"></div>
      <span>Recession</span>
    </div>
  </div>

  <!-- Note -->
  <div class="mt-4 p-3 bg-indigo-50 rounded-lg text-xs text-indigo-800">
    <strong>üìä Dual Volatility:</strong> VIX = Ï£ºÏãùÏãúÏû• Î≥ÄÎèôÏÑ± (1990~) | MOVE = Ï±ÑÍ∂åÏãúÏû• Î≥ÄÎèôÏÑ± (2020~) | Îëò Îã§ ÎÜíÏúºÎ©¥ ÏãúÏû• Ï†ÑÎ∞ò Î∂àÏïà | 5Y Ïù¥ÏÉÅ Í∏∞Í∞ÑÏóêÏÑú MOVEÎäî 2020ÎÖÑ Ïù¥ÌõÑÎßå ÌëúÏãú
  </div>

  <script type="module">
    import { getRecessionAnnotations } from '../../../tools/macro-monitor/shared/chart-annotations.js';

    // Data & Chart State
    let vixData = [];
    let moveData = [];
    let mergedData = [];
    let chart = null;
    let currentPeriod = 365;

    // Thresholds
    const THRESHOLDS = {
      VIX_FEAR: 30,
      VIX_EXTREME: 40,
      MOVE_STRESS: 120,
      MOVE_EXTREME: 150
    };

    // Fetch both datasets
    async function fetchData() {
      try {
        const [vixRes, moveRes] = await Promise.all([
          fetch('../../../data/sentiment/vix.json'),
          fetch('../../../data/sentiment/move.json')
        ]);

        vixData = await vixRes.json();
        moveData = await moveRes.json();

        // Sort by date
        vixData.sort((a, b) => new Date(a.date) - new Date(b.date));
        moveData.sort((a, b) => new Date(a.date) - new Date(b.date));

        // Merge data - use VIX date range as base (longer history)
        // MOVE data will be null for dates before 2020
        const moveMap = new Map(moveData.map(d => [d.date, d.close]));

        mergedData = vixData.map(d => ({
          date: d.date,
          vix: d.value,
          move: moveMap.get(d.date) || null  // null if no MOVE data
        }));

        return mergedData;
      } catch (error) {
        console.error('Failed to fetch data:', error);
        return [];
      }
    }

    // Filter data by period
    function filterByPeriod(data, days) {
      if (days >= 9999) return data;

      const cutoff = new Date();
      cutoff.setDate(cutoff.getDate() - days);
      return data.filter(d => new Date(d.date) >= cutoff);
    }

    // Update current value display
    function updateCurrentDisplay(data) {
      if (!data.length) return;

      const latest = data[data.length - 1];

      document.getElementById('vixValue').textContent = latest.vix.toFixed(2);
      document.getElementById('moveValue').textContent = latest.move !== null ? latest.move.toFixed(2) : 'N/A';
      document.getElementById('currentDate').textContent = latest.date;

      // Check for dual stress (only if MOVE data exists)
      const hasMoveData = latest.move !== null;
      const isDualStress = hasMoveData && latest.vix >= THRESHOLDS.VIX_FEAR && latest.move >= THRESHOLDS.MOVE_STRESS;
      const stressAlert = document.getElementById('stressAlert');

      if (isDualStress) {
        stressAlert.classList.remove('hidden');
      } else {
        stressAlert.classList.add('hidden');
      }

      // Determine overall status
      const badge = document.getElementById('statusBadge');

      if (hasMoveData && latest.vix >= THRESHOLDS.VIX_EXTREME && latest.move >= THRESHOLDS.MOVE_EXTREME) {
        badge.textContent = 'EXTREME STRESS';
        badge.className = 'ml-auto px-4 py-2 rounded-lg text-sm font-bold bg-red-800 text-white';
      } else if (isDualStress) {
        badge.textContent = 'DUAL STRESS';
        badge.className = 'ml-auto px-4 py-2 rounded-lg text-sm font-bold bg-red-100 text-red-800';
      } else if (latest.vix >= THRESHOLDS.VIX_FEAR || (hasMoveData && latest.move >= THRESHOLDS.MOVE_STRESS)) {
        badge.textContent = 'ELEVATED';
        badge.className = 'ml-auto px-4 py-2 rounded-lg text-sm font-bold bg-orange-100 text-orange-800';
      } else if (latest.vix < 15 && (!hasMoveData || latest.move < 80)) {
        badge.textContent = 'CALM';
        badge.className = 'ml-auto px-4 py-2 rounded-lg text-sm font-bold bg-green-100 text-green-800';
      } else {
        badge.textContent = 'NORMAL';
        badge.className = 'ml-auto px-4 py-2 rounded-lg text-sm font-bold bg-gray-100 text-gray-700';
      }
    }

    // Create/Update Chart
    function renderChart(data) {
      const ctx = document.getElementById('dualChart').getContext('2d');

      const dates = data.map(d => d.date);
      const vixValues = data.map(d => d.vix);
      const moveValues = data.map(d => d.move);

      // Get recession annotations
      const recessionAnnotations = dates.length > 0
        ? getRecessionAnnotations(dates[0], dates[dates.length - 1])
        : {};

      // Zone annotations
      const zoneAnnotations = {
        // VIX Fear Zone (left axis)
        zone_vix_fear: {
          type: 'box',
          yScaleID: 'y',
          yMin: THRESHOLDS.VIX_FEAR,
          yMax: 80,
          backgroundColor: 'rgba(239, 68, 68, 0.05)',
          borderWidth: 0
        },
        line_vix_fear: {
          type: 'line',
          yScaleID: 'y',
          yMin: THRESHOLDS.VIX_FEAR,
          yMax: THRESHOLDS.VIX_FEAR,
          borderColor: '#ef4444',
          borderWidth: 1,
          borderDash: [5, 5],
          label: {
            display: true,
            content: 'VIX 30',
            position: 'start',
            backgroundColor: 'transparent',
            color: '#ef4444',
            font: { size: 10 }
          }
        },
        // MOVE Stress Zone (right axis)
        zone_move_stress: {
          type: 'box',
          yScaleID: 'y1',
          yMin: THRESHOLDS.MOVE_STRESS,
          yMax: 200,
          backgroundColor: 'rgba(20, 184, 166, 0.05)',
          borderWidth: 0
        },
        line_move_stress: {
          type: 'line',
          yScaleID: 'y1',
          yMin: THRESHOLDS.MOVE_STRESS,
          yMax: THRESHOLDS.MOVE_STRESS,
          borderColor: '#14b8a6',
          borderWidth: 1,
          borderDash: [5, 5],
          label: {
            display: true,
            content: 'MOVE 120',
            position: 'end',
            backgroundColor: 'transparent',
            color: '#14b8a6',
            font: { size: 10 }
          }
        }
      };

      const config = {
        type: 'line',
        data: {
          labels: dates,
          datasets: [
            {
              label: 'VIX',
              data: vixValues,
              borderColor: '#ef4444',
              backgroundColor: 'rgba(239, 68, 68, 0.1)',
              fill: false,
              tension: 0.3,
              pointRadius: 0,
              borderWidth: 2,
              yAxisID: 'y'
            },
            {
              label: 'MOVE',
              data: moveValues,
              borderColor: '#14b8a6',
              backgroundColor: 'rgba(20, 184, 166, 0.1)',
              fill: false,
              tension: 0.3,
              pointRadius: 0,
              borderWidth: 2,
              yAxisID: 'y1',
              spanGaps: true
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false
          },
          scales: {
            x: {
              type: 'time',
              time: {
                unit: currentPeriod <= 365 ? 'month' : 'year',
                displayFormats: {
                  month: 'MMM yyyy',
                  year: 'yyyy'
                }
              },
              grid: { display: false },
              ticks: {
                maxTicksLimit: 8,
                color: '#9ca3af'
              }
            },
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              min: 0,
              suggestedMax: Math.max(50, Math.max(...vixValues) * 1.1),
              title: {
                display: true,
                text: 'VIX',
                color: '#ef4444',
                font: { weight: 'bold' }
              },
              grid: { color: '#f3f4f6' },
              ticks: { color: '#ef4444' }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              min: 0,
              suggestedMax: Math.max(180, Math.max(...moveValues) * 1.1),
              title: {
                display: true,
                text: 'MOVE',
                color: '#14b8a6',
                font: { weight: 'bold' }
              },
              grid: { drawOnChartArea: false },
              ticks: { color: '#14b8a6' }
            }
          },
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: {
                usePointStyle: true,
                padding: 20
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#fff',
              bodyColor: '#fff',
              cornerRadius: 8,
              callbacks: {
                title: (items) => items[0].label,
                label: (context) => {
                  const label = context.dataset.label;
                  const value = context.parsed.y.toFixed(2);
                  return `${label}: ${value}`;
                }
              }
            },
            annotation: {
              annotations: { ...recessionAnnotations, ...zoneAnnotations }
            }
          }
        }
      };

      if (chart) {
        chart.destroy();
      }
      chart = new Chart(ctx, config);
    }

    // Period button handlers
    function setupPeriodButtons() {
      document.querySelectorAll('.period-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');

          currentPeriod = parseInt(btn.dataset.period);
          const filtered = filterByPeriod(mergedData, currentPeriod);
          updateCurrentDisplay(filtered);
          renderChart(filtered);
        });
      });
    }

    // Initialize
    async function init() {
      await fetchData();
      const filtered = filterByPeriod(mergedData, currentPeriod);
      updateCurrentDisplay(filtered);
      renderChart(filtered);
      setupPeriodButtons();
    }

    init();
  </script>

</body>
</html>
