<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Data Lab - 100x FenoK</title>
  <meta name="robots" content="noindex, nofollow">
  <link rel="icon" type="image/x-icon" href="../../favicon.ico">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gradient-to-br from-slate-100 to-slate-200 min-h-screen text-gray-800">

  <script src="shared/data-lab-config.js?v=2.1"></script>
  <script src="shared/validators.js?v=2.0"></script>

  <header class="py-6 border-b bg-white">
    <div class="container mx-auto px-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 bg-emerald-100 rounded-xl flex items-center justify-center">
            <i class="fas fa-database text-emerald-500"></i>
          </div>
          <div>
            <h1 class="text-xl font-bold">Data Lab</h1>
            <p class="text-gray-500 text-sm">데이터 상태 및 스키마 검증</p>
          </div>
        </div>
        <a href="../" class="text-gray-500 hover:text-blue-600">
          <i class="fas fa-arrow-left mr-1"></i> Admin
        </a>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 py-8">

    <section class="mb-8">
      <h2 class="text-lg font-semibold text-gray-600 mb-4">
        <i class="fas fa-signal text-emerald-500 mr-2"></i>데이터 상태
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">

        <div class="bg-white rounded-xl p-5 shadow">
          <div class="flex items-center justify-between mb-3">
            <div>
              <h3 class="font-semibold">Damodaran ERP</h3>
              <p class="text-xs text-gray-500">Country Risk Premium</p>
            </div>
            <span id="erp-status" class="text-xs px-2 py-1 rounded bg-gray-100 text-gray-600">로딩중</span>
          </div>
          <div class="text-sm text-gray-600 space-y-1">
            <p>레코드: <span id="erp-count">-</span> <span class="text-xs text-gray-400">(1개 파일)</span></p>
            <p>갱신일: <span id="erp-date">-</span></p>
          </div>
          <div class="mt-3 text-xs text-gray-500">
            샘플: <span id="erp-sample">-</span>
          </div>
        </div>

        <div class="bg-white rounded-xl p-5 shadow">
          <div class="flex items-center justify-between mb-3">
            <div>
              <h3 class="font-semibold">Damodaran EV/Sales</h3>
              <p class="text-xs text-gray-500">Sector Multiples</p>
            </div>
            <span id="evsales-status" class="text-xs px-2 py-1 rounded bg-gray-100 text-gray-600">로딩중</span>
          </div>
          <div class="text-sm text-gray-600 space-y-1">
            <p>레코드: <span id="evsales-count">-</span> <span class="text-xs text-gray-400">(1개 파일)</span></p>
            <p>갱신일: <span id="evsales-date">-</span></p>
          </div>
          <div class="mt-3 text-xs text-gray-500">
            샘플: <span id="evsales-sample">-</span>
          </div>
        </div>

        <div class="bg-white rounded-xl p-5 shadow">
          <div class="flex items-center justify-between mb-3">
            <div>
              <h3 class="font-semibold">Global Scouter</h3>
              <p class="text-xs text-gray-500">Stocks Master</p>
            </div>
            <span id="scouter-status" class="text-xs px-2 py-1 rounded bg-gray-100 text-gray-600">로딩중</span>
          </div>
          <div class="text-sm text-gray-600 space-y-1">
            <p>레코드: <span id="scouter-count">-</span> <span class="text-xs text-gray-400">(core 3개 파일)</span></p>
            <p>갱신일: <span id="scouter-date">-</span></p>
          </div>
          <div class="mt-3 text-xs text-gray-500">
            샘플: <span id="scouter-sample">-</span>
          </div>
        </div>

        <div class="bg-white rounded-xl p-5 shadow">
          <div class="flex items-center justify-between mb-3">
            <div>
              <h3 class="font-semibold">Benchmarks</h3>
              <p class="text-xs text-gray-500">Market Benchmarks</p>
            </div>
            <span id="benchmarks-status" class="text-xs px-2 py-1 rounded bg-gray-100 text-gray-600">로딩중</span>
          </div>
          <div class="text-sm text-gray-600 space-y-1">
            <p>레코드: <span id="benchmarks-sections">-</span> <span class="text-xs text-gray-400">(6개 파일)</span></p>
            <p>갱신일: <span id="benchmarks-date">-</span></p>
          </div>
          <div class="mt-3 text-xs text-gray-500">
            샘플: <span id="benchmarks-sample">-</span>
          </div>
        </div>

        <div class="bg-white rounded-xl p-5 shadow">
          <div class="flex items-center justify-between mb-3">
            <div>
              <h3 class="font-semibold">SEC 13F</h3>
              <p class="text-xs text-gray-500">Investor Holdings</p>
            </div>
            <span id="sec13f-status" class="text-xs px-2 py-1 rounded bg-gray-100 text-gray-600">준비 중</span>
          </div>
          <div class="text-sm text-gray-600 space-y-1">
            <p>레코드: <span id="sec13f-count">-</span> <span class="text-xs text-gray-400">(3개 파일 + 17 투자자)</span></p>
            <p>갱신일: <span id="sec13f-date">-</span></p>
          </div>
          <div class="mt-3 text-xs text-gray-500">
            샘플: <span id="sec13f-sample">Warren Buffett, Michael Burry...</span>
          </div>
        </div>

      </div>
    </section>

    <section class="mb-8">
      <h2 class="text-lg font-semibold text-gray-600 mb-4">
        <i class="fas fa-bell text-amber-500 mr-2"></i>업데이트 신호
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
        <div class="bg-white rounded-xl p-5 shadow">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-semibold text-sm">Benchmarks</h3>
            <span id="update-bench-status" class="text-xs px-2 py-1 rounded bg-gray-100 text-gray-600">로딩중</span>
          </div>
          <div class="text-xs text-gray-500">주간 갱신</div>
          <div class="mono text-sm" id="update-bench-date">-</div>
          <button data-revalidate="benchmarks" class="mt-3 text-xs text-sky-600 hover:underline">재검증</button>
        </div>
        <div class="bg-white rounded-xl p-5 shadow">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-semibold text-sm">Global Scouter</h3>
            <span id="update-scouter-status" class="text-xs px-2 py-1 rounded bg-gray-100 text-gray-600">로딩중</span>
          </div>
          <div class="text-xs text-gray-500">주간 갱신</div>
          <div class="mono text-sm" id="update-scouter-date">-</div>
          <button data-revalidate="scouter" class="mt-3 text-xs text-sky-600 hover:underline">재검증</button>
        </div>
        <div class="bg-white rounded-xl p-5 shadow">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-semibold text-sm">Damodaran ERP</h3>
            <span id="update-erp-status" class="text-xs px-2 py-1 rounded bg-gray-100 text-gray-600">로딩중</span>
          </div>
          <div class="text-xs text-gray-500">연간 갱신</div>
          <div class="mono text-sm" id="update-erp-date">-</div>
          <button data-revalidate="damodaran" class="mt-3 text-xs text-sky-600 hover:underline">재검증</button>
        </div>
        <div class="bg-white rounded-xl p-5 shadow">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-semibold text-sm">Damodaran EV/Sales</h3>
            <span id="update-ev-status" class="text-xs px-2 py-1 rounded bg-gray-100 text-gray-600">로딩중</span>
          </div>
          <div class="text-xs text-gray-500">연간 갱신</div>
          <div class="mono text-sm" id="update-ev-date">-</div>
          <button data-revalidate="damodaran" class="mt-3 text-xs text-sky-600 hover:underline">재검증</button>
        </div>
        <div class="bg-white rounded-xl p-5 shadow">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-semibold text-sm">SEC 13F</h3>
            <span id="update-13f-status" class="text-xs px-2 py-1 rounded bg-gray-100 text-gray-600">로딩중</span>
          </div>
          <div class="text-xs text-gray-500">분기 갱신</div>
          <div class="mono text-sm" id="update-13f-date">-</div>
          <button data-revalidate="sec13f" class="mt-3 text-xs text-sky-600 hover:underline">재검증</button>
        </div>
      </div>
    </section>

    <section class="mb-8">
      <h2 class="text-lg font-semibold text-gray-600 mb-4">
        <i class="fas fa-terminal text-sky-500 mr-2"></i>통합 콘솔
      </h2>
      <div class="bg-white rounded-xl p-5 shadow">
        <div class="flex flex-wrap gap-2 mb-4 text-sm">
          <button class="tab-btn px-3 py-2 rounded-lg border bg-sky-50 text-sky-700" data-tab="bench-console">Benchmarks</button>
          <button class="tab-btn px-3 py-2 rounded-lg border text-gray-600" data-tab="scouter-console">Global Scouter</button>
          <button class="tab-btn px-3 py-2 rounded-lg border text-gray-600" data-tab="damodaran-console">Damodaran</button>
          <button class="tab-btn px-3 py-2 rounded-lg border text-gray-600" data-tab="sec13f-console">SEC 13F</button>
        </div>

        <div id="bench-console" class="console-panel space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm text-gray-600">
            <div>
              <span class="font-semibold text-gray-700">파일 수</span>
              <div class="mono" id="bench-console-files">-</div>
            </div>
            <div>
              <span class="font-semibold text-gray-700">섹션 수</span>
              <div class="mono" id="bench-console-sections">-</div>
            </div>
            <div>
              <span class="font-semibold text-gray-700">최신 데이터</span>
              <div class="mono" id="bench-console-latest">-</div>
            </div>
            <div>
              <span class="font-semibold text-gray-700">샘플 섹션</span>
              <div class="mono" id="bench-console-sample">-</div>
            </div>
          </div>
          <pre id="bench-console-preview" class="bg-gray-900 text-emerald-300 text-xs p-4 rounded-lg overflow-auto h-48">로딩중...</pre>
        </div>

        <div id="scouter-console" class="console-panel space-y-4 hidden">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm text-gray-600">
            <div>
              <span class="font-semibold text-gray-700">종목 수</span>
              <div class="mono" id="scouter-console-count">-</div>
            </div>
            <div>
              <span class="font-semibold text-gray-700">기준일</span>
              <div class="mono" id="scouter-console-date">-</div>
            </div>
            <div>
              <span class="font-semibold text-gray-700">생성일</span>
              <div class="mono" id="scouter-console-generated">-</div>
            </div>
            <div>
              <span class="font-semibold text-gray-700">샘플 티커</span>
              <div class="mono" id="scouter-console-sample">-</div>
            </div>
          </div>
          <pre id="scouter-console-preview" class="bg-gray-900 text-emerald-300 text-xs p-4 rounded-lg overflow-auto h-48">로딩중...</pre>
        </div>

        <div id="damodaran-console" class="console-panel space-y-4 hidden">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm text-gray-600">
            <div>
              <span class="font-semibold text-gray-700">ERP 국가</span>
              <div class="mono" id="damodaran-console-erp">-</div>
            </div>
            <div>
              <span class="font-semibold text-gray-700">EV/Sales 섹터</span>
              <div class="mono" id="damodaran-console-ev">-</div>
            </div>
            <div>
              <span class="font-semibold text-gray-700">최신 생성일</span>
              <div class="mono" id="damodaran-console-date">-</div>
            </div>
            <div>
              <span class="font-semibold text-gray-700">샘플 키</span>
              <div class="mono" id="damodaran-console-sample">-</div>
            </div>
          </div>
          <pre id="damodaran-console-preview" class="bg-gray-900 text-emerald-300 text-xs p-4 rounded-lg overflow-auto h-48">로딩중...</pre>
        </div>

        <div id="sec13f-console" class="console-panel space-y-4 hidden">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm text-gray-600">
            <div>
              <span class="font-semibold text-gray-700">투자자 수</span>
              <div class="mono" id="sec13f-console-investors">-</div>
            </div>
            <div>
              <span class="font-semibold text-gray-700">Top 종목</span>
              <div class="mono" id="sec13f-console-stocks">-</div>
            </div>
            <div>
              <span class="font-semibold text-gray-700">분기</span>
              <div class="mono" id="sec13f-console-quarter">-</div>
            </div>
            <div>
              <span class="font-semibold text-gray-700">주요 투자자</span>
              <div class="mono" id="sec13f-console-sample">-</div>
            </div>
          </div>
          <pre id="sec13f-console-preview" class="bg-gray-900 text-emerald-300 text-xs p-4 rounded-lg overflow-auto h-48">로딩중...</pre>
        </div>
      </div>
    </section>

    <section>
      <h2 class="text-lg font-semibold text-gray-600 mb-4">
        <i class="fas fa-shield-check text-indigo-500 mr-2"></i>검증 결과
      </h2>
      <div class="bg-white rounded-xl p-5 shadow">
        <ul id="validation-log" class="text-sm text-gray-700 space-y-2">
          <li class="text-gray-500">// 데이터 로딩 후 자동 검증</li>
        </ul>
      </div>
    </section>

  </main>

  <script>
    const logEl = document.getElementById('validation-log');
    function addLog(message, ok = true) {
      const li = document.createElement('li');
      li.textContent = message;
      li.className = ok ? 'text-emerald-600' : 'text-rose-600';
      logEl.appendChild(li);
    }

    function setStatus(elId, ok, label) {
      const el = document.getElementById(elId);
      if (!el) return;
      if (ok) {
        el.textContent = label || '정상';
        el.className = 'text-xs px-2 py-1 rounded bg-emerald-100 text-emerald-700';
      } else {
        el.textContent = label || '오류';
        el.className = 'text-xs px-2 py-1 rounded bg-rose-100 text-rose-700';
      }
    }

    function getMetaDate(data) {
      return data?.metadata?.generated_at || data?.metadata?.date || '-';
    }

    function setText(id, value) {
      const el = document.getElementById(id);
      if (el) el.textContent = value;
    }

    function sampleKeys(obj, limit) {
      return Object.keys(obj || {}).slice(0, limit).join(', ');
    }

    function daysSince(dateStr) {
      if (!dateStr) return null;
      const date = new Date(dateStr);
      if (Number.isNaN(date.getTime())) return null;
      const diff = Date.now() - date.getTime();
      return Math.floor(diff / (1000 * 60 * 60 * 24));
    }

    function setUpdateStatus(id, days, warn, danger) {
      const el = document.getElementById(id);
      if (!el) return;
      if (days === null) {
        el.textContent = '알 수 없음';
        el.className = 'text-xs px-2 py-1 rounded bg-gray-100 text-gray-600';
        return;
      }
      if (days >= danger) {
        el.textContent = `갱신 필요 (${days}일)`;
        el.className = 'text-xs px-2 py-1 rounded bg-rose-100 text-rose-700';
        return;
      }
      if (days >= warn) {
        el.textContent = `주의 (${days}일)`;
        el.className = 'text-xs px-2 py-1 rounded bg-amber-100 text-amber-700';
        return;
      }
      el.textContent = `정상 (${days}일)`;
      el.className = 'text-xs px-2 py-1 rounded bg-emerald-100 text-emerald-700';
    }
    function setTab(activeId) {
      document.querySelectorAll('.console-panel').forEach(panel => {
        panel.classList.toggle('hidden', panel.id !== activeId);
      });
      document.querySelectorAll('.tab-btn').forEach(btn => {
        const isActive = btn.dataset.tab === activeId;
        btn.className = `tab-btn px-3 py-2 rounded-lg border ${isActive ? 'bg-sky-50 text-sky-700' : 'text-gray-600'}`;
      });
    }

    function formatDate(value) {
      if (!value) return '-';
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return '-';
      return date.toISOString().slice(0, 10);
    }

    function safeStringify(value, limit = 900) {
      const raw = JSON.stringify(value, null, 2) || '';
      return raw.length > limit ? `${raw.slice(0, limit)}\n...` : raw;
    }

    function pickSample(obj) {
      const keys = Object.keys(obj || {});
      if (!keys.length) return null;
      return { key: keys[0], value: obj[keys[0]] };
    }

    async function loadDamodaranErp() {
      try {
        const data = await fetchDataLabFile('DAMODARAN_ERP');
        const result = validateDamodaranErp(data);
        setStatus('erp-status', result.ok);
        setText('erp-count', result.stats.actualCount);
        setText('erp-date', formatDate(data?.metadata?.generated_at));
        setText('erp-sample', sampleKeys(data.countries, 5));
        setText('update-erp-date', formatDate(data?.metadata?.generated_at));
        setUpdateStatus('update-erp-status', daysSince(data?.metadata?.generated_at), 400, 500);
        addLog(`Damodaran ERP: ${result.ok ? 'OK' : result.issues.join(' / ')}`, result.ok);
      } catch (err) {
        setStatus('erp-status', false, '로드 실패');
        addLog(`Damodaran ERP: ${err.message}`, false);
      }
    }

    async function loadDamodaranEvSales() {
      try {
        const data = await fetchDataLabFile('DAMODARAN_EVSALES');
        const result = validateDamodaranEvSales(data);
        setStatus('evsales-status', result.ok);
        setText('evsales-count', result.stats.actualCount);
        setText('evsales-date', formatDate(data?.metadata?.generated_at));
        setText('evsales-sample', sampleKeys(data.sectors, 5));
        setText('update-ev-date', formatDate(data?.metadata?.generated_at));
        setUpdateStatus('update-ev-status', daysSince(data?.metadata?.generated_at), 250, 400);
        addLog(`Damodaran EV/Sales: ${result.ok ? 'OK' : result.issues.join(' / ')}`, result.ok);
      } catch (err) {
        setStatus('evsales-status', false, '로드 실패');
        addLog(`Damodaran EV/Sales: ${err.message}`, false);
      }
    }

    async function loadGlobalScouter() {
      try {
        const [meta, indexData, dashboard] = await Promise.all([
          fetchDataLabFile('SCOUTER_METADATA'),
          fetchDataLabFile('SCOUTER_INDEX'),
          fetchDataLabFile('SCOUTER_DASHBOARD')
        ]);
        const result = validateGlobalScouter(meta, indexData, dashboard);
        setStatus('scouter-status', result.ok, result.ok ? '정상' : '오류');
        setText('scouter-count', result.stats.metaCount || '-');
        setText('scouter-date', formatDate(meta?.source_date));
        setText('scouter-sample', sampleKeys(indexData?.stocks, 5));
        const scouterDate = meta?.source_date || meta?.generated_at;
        setText('update-scouter-date', formatDate(scouterDate));
        setUpdateStatus('update-scouter-status', daysSince(scouterDate), 10, 21);
        const warnText = result.warnings.length ? ` (경고: ${result.warnings.join(' / ')})` : '';
        addLog(`Global Scouter: ${result.ok ? 'OK' : result.issues.join(' / ')}${warnText}`, result.ok);
      } catch (err) {
        setStatus('scouter-status', false, '로드 실패');
        addLog(`Global Scouter: ${err.message}`, false);
      }
    }

    async function loadSec13F() {
      try {
        const summary = await fetchDataLabFile('SEC13F_SUMMARY');
        // summary.json은 Object 구조 (Array 아님)
        const investorCount = Object.keys(summary?.investors || {}).length;
        const stockCount = Object.keys(summary?.top_stocks || {}).length;
        const latestDate = summary?.metadata?.quarter || summary?.metadata?.generated_at;

        setStatus('sec13f-status', true, '정상');
        setText('sec13f-count', `${investorCount} 투자자`);
        setText('sec13f-date', formatDate(latestDate));
        setText('update-13f-date', formatDate(latestDate));
        setUpdateStatus('update-13f-status', daysSince(latestDate), 100, 180);
        addLog(`SEC 13F: OK (${investorCount} investors, ${stockCount} stocks)`, true);
      } catch (err) {
        setStatus('sec13f-status', false, '로드 실패');
        setText('sec13f-count', '-');
        setText('sec13f-date', '-');
        addLog(`SEC 13F: ${err.message}`, false);
      }
    }

    async function loadSec13FConsole() {
      try {
        const summary = await fetchDataLabFile('SEC13F_SUMMARY');
        // summary.json은 Object 구조 → Object.values로 배열 변환
        const investors = Object.values(summary?.investors || {});
        const topStocks = Object.values(summary?.top_stocks || {});

        setText('sec13f-console-investors', investors.length || '-');
        setText('sec13f-console-stocks', topStocks.length || '-');
        setText('sec13f-console-quarter', summary?.metadata?.quarter || '-');
        setText('sec13f-console-sample', investors.slice(0, 3).map(i => i.name).join(', ') || '-');
        document.getElementById('sec13f-console-preview').textContent = safeStringify({
          top_investors: investors.slice(0, 3),
          top_stocks: topStocks.slice(0, 5)
        });
      } catch (err) {
        document.getElementById('sec13f-console-preview').textContent = `Error: ${err.message}`;
      }
    }

    async function loadBenchmarks() {
      const files = DATA_LAB_CONFIG.BENCHMARKS || [];
      let okCount = 0;
      let totalSections = 0;
      const samples = [];
      let latestGenerated = null;
      let latestData = null;

      for (const file of files) {
        try {
          const data = await fetchDataLabPath(file.path);
          const result = validateBenchmarkFile(data);
          totalSections += result.stats.sectionCount || 0;
          const sampleKeys = Object.keys(data.sections || {}).slice(0, 2).join(', ');
          samples.push(`${file.key}: ${sampleKeys}`);
          const generated = data?.metadata?.generated;
          if (generated && (!latestGenerated || new Date(generated) > new Date(latestGenerated))) {
            latestGenerated = generated;
          }
          const sectionEntries = Object.entries(data?.sections || {});
          for (const [, section] of sectionEntries) {
            const rows = section?.data || [];
            if (rows.length) {
              const lastDate = rows[rows.length - 1]?.date;
              if (lastDate && (!latestData || new Date(lastDate) > new Date(latestData))) {
                latestData = lastDate;
              }
            }
          }
          addLog(`Benchmarks(${file.key}): ${result.ok ? 'OK' : result.issues.join(' / ')}`, result.ok);
          if (result.ok) okCount += 1;
        } catch (err) {
          addLog(`Benchmarks(${file.key}): ${err.message}`, false);
        }
      }

      const allOk = okCount === files.length;
      setStatus('benchmarks-status', allOk, allOk ? '정상' : `${okCount}/${files.length}`);
      setText('benchmarks-sections', totalSections);
      const updateDate = latestData || latestGenerated;
      setText('benchmarks-date', formatDate(updateDate));
      setText('benchmarks-sample', samples.slice(0, 2).join(' | ') || '-');
      setText('update-bench-date', formatDate(updateDate));
      setUpdateStatus('update-bench-status', daysSince(updateDate), 10, 21);
    }

    async function loadBenchConsole() {
      const files = DATA_LAB_CONFIG.BENCHMARKS || [];
      let totalSections = 0;
      let latestGenerated = null;
      let latestData = null;
      let sampleSection = null;
      let preview = null;

      for (const file of files) {
        const data = await fetchDataLabPath(file.path);
        const generated = data?.metadata?.generated;
        if (generated && (!latestGenerated || new Date(generated) > new Date(latestGenerated))) {
          latestGenerated = generated;
        }
        const sections = Object.entries(data?.sections || {});
        totalSections += sections.length;
        if (!sampleSection && sections.length) {
          sampleSection = sections[0][0];
          const rows = sections[0][1]?.data || [];
          preview = rows.length ? rows[0] : sections[0][1];
        }
        for (const [, section] of sections) {
          const rows = section?.data || [];
          if (rows.length) {
            const lastDate = rows[rows.length - 1]?.date;
            if (lastDate && (!latestData || new Date(lastDate) > new Date(latestData))) {
              latestData = lastDate;
            }
          }
        }
      }

      setText('bench-console-files', files.length);
      setText('bench-console-sections', totalSections);
      setText('bench-console-latest', formatDate(latestData || latestGenerated));
      setText('bench-console-sample', sampleSection || '-');
      document.getElementById('bench-console-preview').textContent = preview ? safeStringify(preview) : '샘플 없음';
    }

    async function loadScouterConsole() {
      const [meta, indexData] = await Promise.all([
        fetchDataLabFile('SCOUTER_METADATA'),
        fetchDataLabFile('SCOUTER_INDEX')
      ]);
      const sample = pickSample(indexData?.stocks || {});
      setText('scouter-console-count', meta?.counts?.stocks || indexData?.count || '-');
      setText('scouter-console-date', formatDate(meta?.source_date || meta?.generated_at));
      setText('scouter-console-generated', formatDate(meta?.generated_at));
      setText('scouter-console-sample', sample ? sample.key : '-');
      document.getElementById('scouter-console-preview').textContent = sample ? safeStringify(sample.value) : '샘플 없음';
    }

    async function loadDamodaranConsole() {
      const erp = await fetchDataLabFile('DAMODARAN_ERP');
      const ev = await fetchDataLabFile('DAMODARAN_EVSALES');
      const erpSample = pickSample(erp?.countries || {});
      const evSample = pickSample(ev?.sectors || {});
      const latest = [erp?.metadata?.generated_at, ev?.metadata?.generated_at].filter(Boolean).sort().reverse()[0];
      setText('damodaran-console-erp', Object.keys(erp?.countries || {}).length || '-');
      setText('damodaran-console-ev', Object.keys(ev?.sectors || {}).length || '-');
      setText('damodaran-console-date', formatDate(latest));
      setText('damodaran-console-sample', [erpSample?.key, evSample?.key].filter(Boolean).join(' / ') || '-');
      document.getElementById('damodaran-console-preview').textContent = safeStringify({ erp: erpSample, ev_sales: evSample });
    }

    (async function init() {
      logEl.innerHTML = '';
      await Promise.all([loadDamodaranErp(), loadDamodaranEvSales(), loadGlobalScouter(), loadBenchmarks(), loadSec13F()]);
      await Promise.all([loadBenchConsole(), loadScouterConsole(), loadDamodaranConsole(), loadSec13FConsole()]);
    })();

    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => setTab(btn.dataset.tab));
    });
    setTab('bench-console');

    async function revalidate(kind) {
      addLog(`재검증 시작: ${kind}`, true);
      if (kind === 'benchmarks') {
        await loadBenchmarks();
        await loadBenchConsole();
      }
      if (kind === 'scouter') {
        await loadGlobalScouter();
        await loadScouterConsole();
      }
      if (kind === 'damodaran') {
        await Promise.all([loadDamodaranErp(), loadDamodaranEvSales()]);
        await loadDamodaranConsole();
      }
      addLog(`재검증 완료: ${kind}`, true);
    }

    document.querySelectorAll('[data-revalidate]').forEach(btn => {
      btn.addEventListener('click', () => revalidate(btn.dataset.revalidate));
    });
  </script>
</body>
</html>
