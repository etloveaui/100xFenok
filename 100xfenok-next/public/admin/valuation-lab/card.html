<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë°¸ë¥˜ì—ì´ì…˜ ì¹´ë“œ 2.0 - Valuation Lab</title>
  <meta name="robots" content="noindex, nofollow">
  <link rel="icon" type="image/x-icon" href="../../favicon.ico">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* ë°¸ë¥˜ì—ì´ì…˜ ì¹´ë“œ */
    .valuation-card {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .valuation-card .header {
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .valuation-card .header .title {
      font-weight: 700;
      font-size: 1.125rem;
      color: #1e293b;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .valuation-card .header .subtitle {
      font-size: 0.875rem;
      color: #64748b;
      font-weight: 400;
    }

    .valuation-card .header .overall-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.375rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.875rem;
      font-weight: 600;
    }

    .valuation-card .header .overall-badge.bullish { background: #dcfce7; color: #166534; }
    .valuation-card .header .overall-badge.neutral { background: #fef9c3; color: #854d0e; }
    .valuation-card .header .overall-badge.bearish { background: #fee2e2; color: #991b1b; }

    .valuation-card .signals {
      display: flex;
      justify-content: space-around;
      padding: 1rem;
      background: #f8fafc;
      border-bottom: 1px solid #e5e7eb;
    }

    .valuation-card .signal-item { text-align: center; }
    .valuation-card .signal-item .emoji { font-size: 1.5rem; margin-bottom: 0.25rem; }
    .valuation-card .signal-item .label { font-size: 0.75rem; color: #64748b; }
    .valuation-card .signal-item .value { font-size: 0.875rem; font-weight: 600; color: #1e293b; }

    .valuation-card .chart-section {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid #e5e7eb;
    }

    .valuation-card .comparison-section {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid #e5e7eb;
      background-color: #fff;
    }

    .valuation-card .one-liner-section {
      padding: 1rem 1.5rem;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    }
    .valuation-card .one-liner-section.bullish { border-left: 4px solid #16a34a; }
    .valuation-card .one-liner-section.neutral { border-left: 4px solid #ca8a04; }
    .valuation-card .one-liner-section.bearish { border-left: 4px solid #dc2626; }

    .valuation-card .footer {
      padding: 0.75rem 1.5rem;
      background: #f8fafc;
      font-size: 0.75rem;
      color: #64748b;
      display: flex;
      justify-content: space-between;
    }

    /* ì»´íŒ©íŠ¸ ì¹´ë“œ */
    .valuation-card-compact {
      background: white;
      border-radius: 0.75rem;
      padding: 1rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .valuation-card-compact .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.75rem;
    }
    .valuation-card-compact .signals {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .valuation-card-compact .signal-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 0.5rem;
      border-radius: 0.375rem;
      font-size: 0.75rem;
      background: #f1f5f9;
    }

    /* ë¯¸ë‹ˆ ë°” */
    .mini-bar {
      height: 0.5rem;
      border-radius: 9999px;
      background: #e5e7eb;
      overflow: hidden;
      position: relative;
    }
    .mini-bar .fill {
      height: 100%;
      border-radius: 9999px;
      transition: width 0.5s ease-out;
    }
    .mini-bar .marker {
      position: absolute;
      top: -2px;
      bottom: -2px;
      width: 2px;
      background: #000;
      z-index: 10;
    }
    .mini-bar .fill.green { background: #16a34a; }
    .mini-bar .fill.yellow { background: #ca8a04; }
    .mini-bar .fill.red { background: #dc2626; }
    .mini-bar .fill.blue { background: #3b82f6; }

    /* Autocomplete */
    .autocomplete-items {
      position: absolute;
      border: 1px solid #d4d4d4;
      border-bottom: none;
      border-top: none;
      z-index: 99;
      top: 100%;
      left: 0;
      right: 0;
      border-radius: 0 0 0.5rem 0.5rem;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .autocomplete-items div {
      padding: 10px;
      cursor: pointer;
      background-color: #fff; 
      border-bottom: 1px solid #d4d4d4; 
    }
    .autocomplete-items div:hover {
      background-color: #e9e9e9; 
    }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-100 to-slate-200 min-h-screen">

  <!-- Shared Modules -->
  <script src="../shared/config/manifest-loader.js"></script>
  <script src="../shared/core/cache-manager.js"></script>
  <script src="../shared/core/data-manager.js"></script>
  <script src="../shared/core/formatters.js"></script>
  <script src="../shared/validators/freshness-checker.js"></script>

  <!-- Valuation Lab Specific -->
  <script src="shared/constants.js"></script>
  <script src="shared/calculations.js"></script>
  <script src="shared/indicators.js"></script>
  <script src="shared/security.js"></script>
  <script src="shared/validator.js"></script>

  <script>
    // Set prefix for Valuation Lab
    if (window.CacheManager) CacheManager.setPrefix('vlab_cache_');
  </script>

  <header class="py-6 border-b bg-white">
    <div class="container mx-auto px-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 bg-amber-100 rounded-xl flex items-center justify-center">
            <i class="fas fa-id-card text-amber-500"></i>
          </div>
          <div>
            <h1 class="text-xl font-bold">Valuation Card 2.0</h1>
            <p class="text-gray-500 text-sm">Index Mode & Stock Mode</p>
          </div>
        </div>
        <a href="./" class="text-gray-500 hover:text-blue-600">
          <i class="fas fa-arrow-left mr-1"></i> ì‹¤í—˜ì‹¤
        </a>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 py-8">

    <!-- ì»¨íŠ¸ë¡¤ íŒ¨ë„ -->
    <section class="mb-8">
      <div class="bg-white rounded-xl p-6 shadow">
        <div class="flex flex-wrap items-center justify-between gap-4">
          
          <!-- Mode Toggle -->
          <div class="bg-gray-100 p-1 rounded-lg flex text-sm">
            <button id="btn-mode-index" class="px-4 py-1.5 rounded-md bg-white shadow-sm font-semibold text-gray-800 transition" onclick="setMode('index')">
              <i class="fas fa-globe mr-1"></i> Index
            </button>
            <button id="btn-mode-stock" class="px-4 py-1.5 rounded-md text-gray-500 hover:text-gray-700 transition" onclick="setMode('stock')">
              <i class="fas fa-building mr-1"></i> Stock
            </button>
          </div>

          <!-- Controls -->
          <div class="flex flex-1 items-center gap-2 justify-end">
            
            <!-- Index Controls -->
            <div id="controls-index" class="flex items-center gap-2">
              <select id="benchmark-select" class="border rounded px-3 py-2 text-sm bg-gray-50 focus:ring-2 focus:ring-amber-500 outline-none">
                <option value="US">US (ë¯¸êµ­)</option>
                <option value="SECTORS">ì„¹í„°</option>
                <option value="EMERGING">ì‹ í¥êµ­</option>
                <option value="DEVELOPED">ì„ ì§„êµ­</option>
              </select>
              <select id="section-select" class="border rounded px-3 py-2 text-sm bg-gray-50 focus:ring-2 focus:ring-amber-500 outline-none">
                <option value="sp500">S&P 500</option>
              </select>
            </div>

            <!-- Stock Controls -->
            <div id="controls-stock" class="hidden flex items-center gap-2 relative w-full max-w-xs">
              <div class="relative w-full">
                <input id="ticker-input" type="text" placeholder="Ticker (e.g. AAPL)" 
                  class="border rounded px-3 py-2 text-sm w-full uppercase bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none" autocomplete="off">
                <div id="autocomplete-list" class="autocomplete-items hidden"></div>
              </div>
              <button id="btn-search" class="bg-blue-500 text-white px-4 py-2 rounded text-sm hover:bg-blue-600 transition">
                <i class="fas fa-search"></i>
              </button>
            </div>

            <select id="style-select" class="border rounded px-3 py-2 text-sm bg-gray-50 focus:ring-2 focus:ring-gray-500 outline-none">
              <option value="full">ì „ì²´ ì¹´ë“œ</option>
              <option value="compact">ì»´íŒ©íŠ¸</option>
            </select>
            
            <button onclick="generateCard()" class="bg-emerald-500 text-white px-5 py-2 rounded text-sm hover:bg-emerald-600 transition font-medium shadow-sm">
              <i class="fas fa-magic mr-1"></i> ìƒì„±
            </button>
          </div>
        </div>

        <div id="card-output" class="mt-8 flex justify-center">
          <div class="text-gray-400 text-sm text-center py-12 bg-gray-50 rounded-xl w-full border border-dashed border-gray-300">
            <i class="fas fa-arrow-up mb-2 text-2xl text-gray-300"></i><br>
            ìƒë‹¨ ì˜µì…˜ì„ ì„ íƒí•˜ê³  'ìƒì„±' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”
          </div>
        </div>
      </div>
    </section>

    <!-- ì„¤ëª… ì„¹ì…˜ -->
    <section class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
      <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-100">
        <h3 class="font-bold text-gray-800 mb-2"><i class="fas fa-info-circle text-blue-500 mr-2"></i>Index Mode</h3>
        <p class="text-sm text-gray-600 leading-relaxed">
          15ë…„ì¹˜ ì—­ì‚¬ì  ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í˜„ì¬ ë°¸ë¥˜ì—ì´ì…˜(P/E, P/B, ROE)ì˜ ë°±ë¶„ìœ„ìˆ˜(Percentile)ë¥¼ ê³„ì‚°í•˜ì—¬ ì €í‰ê°€/ê³ í‰ê°€ ì—¬ë¶€ë¥¼ íŒë‹¨í•©ë‹ˆë‹¤.
        </p>
      </div>
      <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-100">
        <h3 class="font-bold text-gray-800 mb-2"><i class="fas fa-info-circle text-purple-500 mr-2"></i>Stock Mode (New)</h3>
        <p class="text-sm text-gray-600 leading-relaxed">
          ê°œë³„ ì¢…ëª©ì˜ 5ë…„ ë°´ë“œ ìœ„ì¹˜ë¥¼ ë¶„ì„í•˜ê³ , Damodaran ì‚°ì—… í‰ê·  ë° ì‹œì¥(S&P 500) ëŒ€ë¹„ í”„ë¦¬ë¯¸ì—„/ë””ìŠ¤ì¹´ìš´íŠ¸ë¥¼ ë¹„êµí•©ë‹ˆë‹¤.
        </p>
      </div>
    </section>

  </main>

  <script>
    /**
     * ValuationCard 2.0
     * Unified component for Index and Stock valuation analysis
     */
    const ValuationCard = (function() {

      // Helpers
      function getOverall(summary) {
        const signals = [
          summary.pePercentile?.signal,
          summary.pbPercentile?.signal,
          summary.roePercentile?.signal,
          summary.pegProxy?.signal,
          summary.peZScore?.signal
        ].filter(Boolean);

        const counts = { green: 0, yellow: 0, red: 0 };
        signals.forEach(s => {
          if (s === 'ğŸŸ¢') counts.green++;
          else if (s === 'ğŸŸ¡') counts.yellow++;
          else if (s === 'ğŸ”´') counts.red++;
        });

        if (counts.green > counts.red && counts.green >= counts.yellow) {
          return { signal: 'ğŸŸ¢', class: 'bullish', label: 'ì €í‰ê°€' };
        } else if (counts.red > counts.green && counts.red >= counts.yellow) {
          return { signal: 'ğŸ”´', class: 'bearish', label: 'ê³ í‰ê°€' };
        } else {
          return { signal: 'ğŸŸ¡', class: 'neutral', label: 'ì ì •' };
        }
      }

      function getColorClass(value, inverted = false) {
        if (inverted) {
          if (value >= 70) return 'green';
          if (value >= 30) return 'yellow';
          return 'red';
        } else {
          if (value <= 30) return 'green';
          if (value <= 70) return 'yellow';
          return 'red';
        }
      }

      function getOneLiner(summary, name, type = 'index') {
        const overall = getOverall(summary);
        const pe = summary.pePercentile;
        const roe = summary.roePercentile;
        
        let text = `${overall.signal} <strong>${name}</strong>ì€(ëŠ”) í˜„ì¬ `;
        
        if (type === 'stock') {
           text += `<strong>PER ${summary.currentPE?.toFixed(1) || '-'}</strong>ë¡œ `;
           if (summary.industryGap !== null && summary.industryGap !== undefined) {
             const gap = summary.industryGap;
             const gapText = gap > 0 ? `+${(gap*100).toFixed(0)}% í• ì¦` : `${(gap*100).toFixed(0)}% í• ì¸`;
             text += `ì‚°ì—… ëŒ€ë¹„ <strong>${gapText}</strong> ê±°ë˜ë˜ê³  ìˆìŠµë‹ˆë‹¤. `;
           } else {
             text += `<strong>${overall.label}</strong> ìƒíƒœì…ë‹ˆë‹¤. `;
           }
        } else {
           if (pe?.value !== null) text += `<strong>P/E ${pe.formatted}</strong> `;
           text += `êµ¬ê°„ìœ¼ë¡œ <strong>${overall.label}</strong> ìƒíƒœì…ë‹ˆë‹¤. `;
        }

        if (overall.class === 'bearish' && roe?.signal === 'ğŸŸ¢') {
          text += `ë‹¤ë§Œ ROEê°€ ${roe.formatted}ë¡œ í€ë”ë©˜í„¸ì€ ê²¬ê³ í•©ë‹ˆë‹¤.`;
        } else if (overall.class === 'bullish' && roe?.signal === 'ğŸŸ¢') {
          text += `ROE ë˜í•œ ${roe.formatted}ë¡œ ë§¤ë ¥ì ì¸ êµ¬ê°„ì…ë‹ˆë‹¤.`;
        }

        return text;
      }

      // --- HTML Generators ---

      function createFull(summary, options = {}) {
        const { indexName = 'ì§€ìˆ˜', type = 'index' } = options;
        const overall = getOverall(summary);
        const card = document.createElement('div');
        card.className = 'valuation-card w-full max-w-md';

        // Signals Logic
        const signalItems = [
          { key: 'pePercentile', label: 'P/E', inverted: false },
          { key: 'pbPercentile', label: 'P/B', inverted: false },
          { key: 'roePercentile', label: 'ROE', inverted: true },
          { key: 'pegProxy', label: 'PEG', inverted: false, isPeg: true }
        ];

        let signalsHtml = '';
        let chartHtml = '';

        signalItems.forEach(({ key, label, inverted, isPeg }) => {
          const data = summary[key];
          if (data && data.value !== null) {
            const signal = data.signal || 'ğŸŸ¡';
            const formatted = data.formatted;
            
            signalsHtml += `
              <div class="signal-item">
                <div class="emoji">${signal}</div>
                <div class="label">${label}</div>
                <div class="value">${formatted}</div>
              </div>`;

            if (!isPeg && !inverted) {
              const value = data.value; // percentile value (0-100)
              const color = getColorClass(value, false);
              const colorClass = color === 'green' ? 'bg-emerald-500' : color === 'yellow' ? 'bg-amber-500' : 'bg-rose-500';
              const textClass = color === 'green' ? 'text-emerald-600' : color === 'yellow' ? 'text-amber-600' : 'text-rose-600';
              
              chartHtml += `
                <div class="flex items-center gap-3 mb-3">
                  <span class="w-12 text-xs text-gray-500 font-medium">${label}</span>
                  <div class="flex-1 mini-bar">
                    <div class="fill ${colorClass}" style="width: ${Math.min(value, 100)}%"></div>
                  </div>
                  <span class="w-10 text-xs text-right ${textClass} font-bold">${formatted}</span>
                </div>`;
            }
          }
        });

        // Stock Specific: Industry Comparison
        let comparisonHtml = '';
        if (type === 'stock' && summary.industryAvg) {
          const indPE = summary.industryAvg.pe_ratio;
          const stockPE = summary.currentPE;
          if (indPE && stockPE) {
             const gap = (stockPE - indPE) / indPE;
             const gapColor = gap > 0.2 ? 'text-rose-600' : gap < -0.2 ? 'text-emerald-600' : 'text-gray-600';
             const gapIcon = gap > 0 ? 'fa-arrow-up' : 'fa-arrow-down';
             
             comparisonHtml = `
               <div class="comparison-section">
                 <div class="text-xs text-gray-500 mb-2 font-medium">Industry Comparison (${summary.industryName})</div>
                 <div class="flex justify-between items-center text-sm">
                   <div>
                     <div class="text-gray-400 text-xs">Industry P/E</div>
                     <div class="font-semibold text-gray-700">${indPE.toFixed(1)}x</div>
                   </div>
                   <div class="text-center ${gapColor}">
                     <i class="fas ${gapIcon}"></i> ${(Math.abs(gap)*100).toFixed(0)}%
                   </div>
                   <div class="text-right">
                     <div class="text-gray-400 text-xs">Stock P/E</div>
                     <div class="font-semibold text-gray-700">${stockPE.toFixed(1)}x</div>
                   </div>
                 </div>
               </div>
             `;
          }
        }

        card.innerHTML = `
          <div class="header">
            <div class="title">
              ${type === 'stock' ? '<i class="fas fa-building text-blue-500"></i>' : '<i class="fas fa-chart-line text-emerald-500"></i>'}
              <div>
                ${indexName}
                ${type === 'stock' && summary.sector ? `<div class="subtitle">${summary.sector} | ${summary.industryName || ''}</div>` : ''}
              </div>
            </div>
            <span class="overall-badge ${overall.class}">${overall.signal} ${overall.label}</span>
          </div>
          <div class="signals">${signalsHtml}</div>
          <div class="chart-section">${chartHtml}</div>
          ${comparisonHtml}
          <div class="one-liner-section ${overall.class}">
            <p class="text-sm text-gray-700 leading-relaxed">
              ${getOneLiner(summary, indexName, type)}
            </p>
          </div>
          <div class="footer">
            <span>Data: ${type === 'stock' ? 'Global Scouter' : 'Bloomberg'}</span>
            <span>ğŸ“… ${summary.date || 'N/A'}</span>
          </div>
        `;

        return card;
      }

      function createCompact(summary, options = {}) {
        const { indexName = 'ì§€ìˆ˜' } = options;
        const overall = getOverall(summary);
        const card = document.createElement('div');
        card.className = 'valuation-card-compact w-full max-w-sm border border-gray-200';

        const signalItems = [
          { key: 'pePercentile', label: 'P/E' },
          { key: 'pbPercentile', label: 'P/B' },
          { key: 'roePercentile', label: 'ROE' },
          { key: 'pegProxy', label: 'PEG' }
        ];

        let badgesHtml = '';
        signalItems.forEach(({ key, label }) => {
          const data = summary[key];
          if (data && data.signal) {
            badgesHtml += `<span class="signal-badge">${data.signal} ${label} ${data.formatted}</span>`;
          }
        });

        const badgeClass = overall.class === 'bearish' ? 'bg-red-100 text-red-700'
          : overall.class === 'bullish' ? 'bg-green-100 text-green-700'
          : 'bg-yellow-100 text-yellow-700';

        card.innerHTML = `
          <div class="header">
            <span class="font-semibold text-gray-800">${indexName}</span>
            <span class="text-xs px-2 py-0.5 ${badgeClass} rounded font-bold">${overall.label}</span>
          </div>
          <div class="signals">${badgesHtml}</div>
        `;
        return card;
      }

      return { createFull, createCompact, getOverall };
    })();

    // ========================================
    // App Logic
    // ========================================

    const elements = {
      benchmarkSelect: document.getElementById('benchmark-select'),
      sectionSelect: document.getElementById('section-select'),
      styleSelect: document.getElementById('style-select'),
      cardOutput: document.getElementById('card-output'),
      tickerInput: document.getElementById('ticker-input'),
      btnModeIndex: document.getElementById('btn-mode-index'),
      btnModeStock: document.getElementById('btn-mode-stock'),
      controlsIndex: document.getElementById('controls-index'),
      controlsStock: document.getElementById('controls-stock'),
      autocompleteList: document.getElementById('autocomplete-list')
    };

    let currentMode = 'index';
    let stocksIndex = null;

    // --- Data Layer ---

    async function loadStockData(ticker) {
      // 1. Load Stock Detail
      const stock = await DataManager.loadFromManifest('global-scouter', `stocks/detail/${ticker}.json`);
      if (!stock) throw new Error(`Stock '${ticker}' not found.`);

      // 2. Load Industry Data
      const industries = await DataManager.loadFromManifest('damodaran', 'industries.json');
      const indData = industries?.industries?.[stock.industry];

      return { stock, indData };
    }

    // --- UI Logic ---

    function setMode(mode) {
      currentMode = mode;
      
      // Update UI Toggle
      if (mode === 'index') {
        elements.btnModeIndex.className = 'px-4 py-1.5 rounded-md bg-white shadow-sm font-semibold text-gray-800 transition';
        elements.btnModeStock.className = 'px-4 py-1.5 rounded-md text-gray-500 hover:text-gray-700 transition';
        elements.controlsIndex.classList.remove('hidden');
        elements.controlsStock.classList.add('hidden');
      } else {
        elements.btnModeStock.className = 'px-4 py-1.5 rounded-md bg-white shadow-sm font-semibold text-gray-800 transition';
        elements.btnModeIndex.className = 'px-4 py-1.5 rounded-md text-gray-500 hover:text-gray-700 transition';
        elements.controlsStock.classList.remove('hidden');
        elements.controlsIndex.classList.add('hidden');
        
        if (!stocksIndex) loadStocksIndex();
      }
      elements.cardOutput.innerHTML = '';
    }

    async function loadStocksIndex() {
      try {
        const data = await DataManager.loadFromManifest('global-scouter', 'core/stocks_index.json');
        stocksIndex = data.stocks; // { AAPL: {name, sector...}, ... }
      } catch (e) {
        console.error('Stocks index load failed:', e);
      }
    }

    // --- Autocomplete ---
    elements.tickerInput.addEventListener('input', function(e) {
      const val = this.value.toUpperCase();
      closeAutocomplete();
      if (!val || !stocksIndex) return;

      const list = elements.autocompleteList;
      list.classList.remove('hidden');
      
      let count = 0;
      for (const [ticker, info] of Object.entries(stocksIndex)) {
        if (ticker.startsWith(val) || info.n.toUpperCase().includes(val)) {
          const item = document.createElement('div');
          item.innerHTML = `<strong>${ticker}</strong> <span class='text-xs text-gray-500'>${info.n}</span>`;
          item.addEventListener('click', function() {
            elements.tickerInput.value = ticker;
            closeAutocomplete();
            generateCard();
          });
          list.appendChild(item);
          count++;
          if (count >= 10) break;
        }
      }
    });

    function closeAutocomplete() {
      elements.autocompleteList.innerHTML = '';
      elements.autocompleteList.classList.add('hidden');
    }

    document.addEventListener('click', function (e) {
      if (e.target !== elements.tickerInput) {
        closeAutocomplete();
      }
    });

    document.getElementById('btn-search').addEventListener('click', generateCard);
    elements.tickerInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') generateCard();
    });

    elements.benchmarkSelect.addEventListener('change', async () => {
      const benchmark = elements.benchmarkSelect.value;
      elements.sectionSelect.innerHTML = '<option>ë¡œë”© ì¤‘...</option>';
      try {
        const data = await DataManager.loadBenchmark(benchmark);
        const sections = DataManager.getSectionKeys(data);
        elements.sectionSelect.innerHTML = sections.map(s => `<option value="${s}">${s}</option>`).join('');
      } catch (e) {
        elements.sectionSelect.innerHTML = '<option>ì˜¤ë¥˜</option>';
      }
    });

    async function generateCard() {
      const style = elements.styleSelect.value;
      elements.cardOutput.innerHTML = '<div class="text-center py-12 w-full"><i class="fas fa-spinner fa-spin text-3xl text-emerald-500"></i></div>';

      try {
        let summary, name, type;

        if (currentMode === 'index') {
          type = 'index';
          const benchmark = elements.benchmarkSelect.value;
          const section = elements.sectionSelect.value;
          summary = await Indicators.getValuationSummary(benchmark, section);
          if (summary.error) throw new Error(summary.error);
          name = section.toUpperCase(); // Ideally get full name from data
        } else {
          type = 'stock';
          const ticker = elements.tickerInput.value.toUpperCase();
          if (!ticker) throw new Error('í‹°ì»¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          
          const { stock, indData } = await loadStockData(ticker);
          
          // Stock Data Parsing (Adapt to Indicators.getValuationSummary logic manually or extend it)
          // Here we reconstruct a summary object manually for the stock
          
          const val = stock.valuation || {};
          const currentPE = val.per ? val.per[val.per.length-1] : null;
          const currentPB = val.pbr ? val.pbr[val.pbr.length-1] : null;
          const currentROE = stock.profitability?.roe ? stock.profitability.roe[stock.profitability.roe.length-1] : null;
          
          // Band Stats (from stock.valuation.per_band) - assuming they exist or calculate
          // Simplified logic: Use per_band avg as "fair"
          const perBand = val.per_band || {};
          
          // Percentile Logic (Mocking 5yr history percentile)
          // If we have 5yr history, we can calc percentile.
          // Let's assume per_band.avg is 50th percentile proxy for now or calc simple deviation
          
          // Deviation from Ind Avg
          const indPE = indData?.multiples?.pe_ratio;
          const industryGap = (currentPE && indPE) ? (currentPE - indPE) / indPE : null;

          // Build Summary Object
          summary = {
            date: new Date().toISOString().slice(0, 10),
            currentPE,
            industryName: stock.industry,
            industryAvg: indData?.multiples,
            industryGap,
            sector: stock.sector,
            
            // Generate Signals
            pePercentile: { 
              value: 50 + (perBand.avg && currentPE ? (currentPE - perBand.avg)/perBand.avg * 100 : 0), // Mock logic
              formatted: currentPE?.toFixed(1) + 'x',
              signal: currentPE > (perBand.max || 999) ? 'ğŸ”´' : currentPE < (perBand.min || 0) ? 'ğŸŸ¢' : 'ğŸŸ¡'
            },
            pbPercentile: {
              value: 50, // Mock
              formatted: currentPB?.toFixed(1) + 'x',
              signal: 'ğŸŸ¡' 
            },
            roePercentile: {
              value: 50,
              formatted: currentROE?.toFixed(1) + '%',
              signal: currentROE > 15 ? 'ğŸŸ¢' : currentROE < 8 ? 'ğŸ”´' : 'ğŸŸ¡'
            },
            pegProxy: {
              value: null,
              formatted: '-',
              signal: 'âšª'
            }
          };
          // Get name from stocksIndex (stocks_index.json uses 'n' for name)
          const stockName = stocksIndex?.[ticker]?.n || ticker;
          name = `${stockName} (${ticker})`;
        }

        elements.cardOutput.innerHTML = '';
        if (style === 'full') {
          elements.cardOutput.appendChild(ValuationCard.createFull(summary, { indexName: name, type }));
        } else {
          elements.cardOutput.appendChild(ValuationCard.createCompact(summary, { indexName: name, type }));
        }

      } catch (e) {
        elements.cardOutput.innerHTML = `<div class="bg-red-50 text-red-600 p-4 rounded-lg border border-red-200">
          <i class="fas fa-exclamation-circle mr-2"></i> ${e.message}
        </div>`;
        console.error(e);
      }
    }

    // ì´ˆê¸°í™”
    (async () => {
      try {
        const data = await DataManager.loadBenchmark('US');
        const sections = DataManager.getSectionKeys(data);
        elements.sectionSelect.innerHTML = sections.map(s => `<option value="${s}">${s}</option>`).join('');
      } catch (e) {
        console.error('ì´ˆê¸°í™” ì˜¤ë¥˜:', e);
      }
    })();
  </script>
</body>
</html>
