<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Overlay Utils - TDD Test</title>
  <meta name="robots" content="noindex, nofollow">
  <style>
    body { font-family: system-ui, sans-serif; padding: 20px; background: #f8fafc; }
    .test-suite { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .test-case { padding: 8px 12px; margin: 4px 0; border-radius: 6px; font-family: monospace; font-size: 14px; }
    .pass { background: #dcfce7; color: #166534; }
    .fail { background: #fee2e2; color: #991b1b; }
    h1 { color: #1f2937; }
    h2 { color: #4b5563; border-bottom: 1px solid #e5e7eb; padding-bottom: 8px; }
    .summary { font-size: 18px; font-weight: bold; margin-top: 20px; }
  </style>
</head>
<body>
  <h1>üß™ Overlay Utils - TDD Test</h1>

  <div class="test-suite" id="testResults">
    <h2>Test Results</h2>
    <div id="tests"></div>
    <div class="summary" id="summary"></div>
  </div>

  <script>
    // ============================================
    // ÌÖåÏä§Ìä∏ ÎåÄÏÉÅ: Overlay Utility Functions
    // ============================================

    /**
     * % Î≥ÄÌôîÏú® Ï†ïÍ∑úÌôî
     * @param {Array} data - [{date, value}, ...]
     * @param {number} baseIndex - Í∏∞Ï§ÄÏ†ê Ïù∏Îç±Ïä§ (Í∏∞Î≥∏: 0 = Ï≤´ Îç∞Ïù¥ÌÑ∞)
     * @returns {Array} - [{date, value: %Î≥ÄÌôîÏú®}, ...]
     */
    function normalizeToPercent(data, baseIndex = 0) {
      if (!data || data.length === 0) return [];

      const baseValue = data[baseIndex].value;
      if (baseValue === 0) return data.map(d => ({ date: d.date, value: 0 }));

      return data.map(d => ({
        date: d.date,
        value: ((d.value - baseValue) / baseValue) * 100
      }));
    }

    /**
     * ÎÇ†Ïßú Í∏∞Ï§Ä Îç∞Ïù¥ÌÑ∞ Î≥ëÌï© (Î©îÏù∏ Îç∞Ïù¥ÌÑ∞ ÎÇ†Ïßú Í∏∞Ï§Ä)
     * @param {Array} mainData - Í∏∞Ï§Ä Îç∞Ïù¥ÌÑ∞ [{date, value}, ...]
     * @param {Array} overlayData - Ïò§Î≤ÑÎ†àÏù¥ Îç∞Ïù¥ÌÑ∞ [{date, value}, ...]
     * @returns {Array} - [{date, mainValue, overlayValue}, ...]
     */
    function mergeByDate(mainData, overlayData) {
      if (!mainData || mainData.length === 0) return [];

      const overlayMap = new Map(overlayData.map(d => [d.date, d.value]));

      return mainData.map(d => ({
        date: d.date,
        mainValue: d.value,
        overlayValue: overlayMap.get(d.date) || null
      }));
    }

    /**
     * Í∏∞Í∞Ñ Î≥ÄÌôîÏú® Í≥ÑÏÇ∞
     * @param {Array} data - [{date, value}, ...]
     * @returns {number} - %Î≥ÄÌôîÏú®
     */
    function calculatePeriodChange(data) {
      if (!data || data.length < 2) return 0;

      const first = data[0].value;
      const last = data[data.length - 1].value;

      if (first === 0) return 0;
      return ((last - first) / first) * 100;
    }

    // ============================================
    // ÌÖåÏä§Ìä∏ ÌîÑÎ†àÏûÑÏõåÌÅ¨
    // ============================================

    let passed = 0;
    let failed = 0;

    function test(name, condition) {
      const testsDiv = document.getElementById('tests');
      const result = condition ? 'pass' : 'fail';

      if (condition) passed++;
      else failed++;

      testsDiv.innerHTML += `
        <div class="test-case ${result}">
          ${condition ? '‚úÖ' : '‚ùå'} ${name}
        </div>
      `;
    }

    function assertEquals(actual, expected, name) {
      const isEqual = JSON.stringify(actual) === JSON.stringify(expected);
      test(name, isEqual);
      if (!isEqual) {
        console.log(`FAIL: ${name}`);
        console.log('  Expected:', expected);
        console.log('  Actual:', actual);
      }
    }

    function assertClose(actual, expected, tolerance, name) {
      const isClose = Math.abs(actual - expected) < tolerance;
      test(name, isClose);
      if (!isClose) {
        console.log(`FAIL: ${name}`);
        console.log(`  Expected: ~${expected} (¬±${tolerance})`);
        console.log(`  Actual: ${actual}`);
      }
    }

    // ============================================
    // ÌÖåÏä§Ìä∏ ÏºÄÏù¥Ïä§
    // ============================================

    // Test 1: normalizeToPercent - Í∏∞Ï§ÄÏ†ê = 0%
    const testData1 = [
      { date: '2024-01-01', value: 100 },
      { date: '2024-01-02', value: 110 },
      { date: '2024-01-03', value: 90 }
    ];
    const normalized1 = normalizeToPercent(testData1);
    assertClose(normalized1[0].value, 0, 0.01, 'normalizeToPercent: Í∏∞Ï§ÄÏ†ê(Ï≤´Ïß∏) = 0%');
    assertClose(normalized1[1].value, 10, 0.01, 'normalizeToPercent: 10% ÏÉÅÏäπ = +10');
    assertClose(normalized1[2].value, -10, 0.01, 'normalizeToPercent: 10% ÌïòÎùΩ = -10');

    // Test 2: normalizeToPercent - Îπà Î∞∞Ïó¥
    const normalized2 = normalizeToPercent([]);
    assertEquals(normalized2, [], 'normalizeToPercent: Îπà Î∞∞Ïó¥ ‚Üí Îπà Î∞∞Ïó¥');

    // Test 3: normalizeToPercent - Í∏∞Ï§ÄÍ∞í 0 Ï≤òÎ¶¨
    const testData3 = [
      { date: '2024-01-01', value: 0 },
      { date: '2024-01-02', value: 100 }
    ];
    const normalized3 = normalizeToPercent(testData3);
    assertEquals(normalized3[0].value, 0, 'normalizeToPercent: Í∏∞Ï§ÄÍ∞í 0 ‚Üí 0% Î∞òÌôò');

    // Test 4: mergeByDate - Ï†ïÏÉÅ Î≥ëÌï©
    const mainData = [
      { date: '2024-01-01', value: 15 },
      { date: '2024-01-02', value: 20 },
      { date: '2024-01-03', value: 18 }
    ];
    const overlayData = [
      { date: '2024-01-01', value: 4500 },
      { date: '2024-01-03', value: 4600 }
    ];
    const merged = mergeByDate(mainData, overlayData);
    assertEquals(merged[0].overlayValue, 4500, 'mergeByDate: Ï≤´Ïß∏ ÎÇ† Îß§Ïπ≠');
    assertEquals(merged[1].overlayValue, null, 'mergeByDate: Îß§Ïπ≠ ÏóÜÏùå ‚Üí null');
    assertEquals(merged[2].overlayValue, 4600, 'mergeByDate: ÏÖãÏß∏ ÎÇ† Îß§Ïπ≠');

    // Test 5: mergeByDate - Îπà Ïò§Î≤ÑÎ†àÏù¥
    const merged2 = mergeByDate(mainData, []);
    assertEquals(merged2[0].overlayValue, null, 'mergeByDate: Îπà Ïò§Î≤ÑÎ†àÏù¥ ‚Üí Î™®Îëê null');

    // Test 6: calculatePeriodChange - Ï†ïÏÉÅ Í≥ÑÏÇ∞
    const changeData = [
      { date: '2024-01-01', value: 100 },
      { date: '2024-01-10', value: 120 }
    ];
    assertClose(calculatePeriodChange(changeData), 20, 0.01, 'calculatePeriodChange: 100‚Üí120 = +20%');

    // Test 7: calculatePeriodChange - ÌïòÎùΩ
    const changeData2 = [
      { date: '2024-01-01', value: 100 },
      { date: '2024-01-10', value: 80 }
    ];
    assertClose(calculatePeriodChange(changeData2), -20, 0.01, 'calculatePeriodChange: 100‚Üí80 = -20%');

    // Test 8: calculatePeriodChange - Îç∞Ïù¥ÌÑ∞ Î∂ÄÏ°±
    assertEquals(calculatePeriodChange([{ date: '2024-01-01', value: 100 }]), 0, 'calculatePeriodChange: 1Í∞ú Îç∞Ïù¥ÌÑ∞ ‚Üí 0');

    // Test 9: Ïã§Ï†ú ÏãúÎÇòÎ¶¨Ïò§ - VIX + S&P 500 Ï†ïÍ∑úÌôî ÎπÑÍµê
    const vixSample = [
      { date: '2024-01-01', value: 13 },
      { date: '2024-06-01', value: 15 },
      { date: '2024-12-01', value: 18 }
    ];
    const sp500Sample = [
      { date: '2024-01-01', value: 4700 },
      { date: '2024-06-01', value: 5200 },
      { date: '2024-12-01', value: 5800 }
    ];
    const vixNorm = normalizeToPercent(vixSample);
    const sp500Norm = normalizeToPercent(sp500Sample);

    // Îëò Îã§ Ï≤´ Í∞í = 0%, Ïù¥ÌõÑ %Î°ú ÎπÑÍµê Í∞ÄÎä•Ìï¥Ïïº Ìï®
    assertClose(vixNorm[0].value, 0, 0.01, 'Ïã§Ï†ú ÏãúÎÇòÎ¶¨Ïò§: VIX Ï†ïÍ∑úÌôî Í∏∞Ï§ÄÏ†ê = 0%');
    assertClose(sp500Norm[0].value, 0, 0.01, 'Ïã§Ï†ú ÏãúÎÇòÎ¶¨Ïò§: S&P 500 Ï†ïÍ∑úÌôî Í∏∞Ï§ÄÏ†ê = 0%');

    // VIX: 13‚Üí18 = +38.46%
    assertClose(vixNorm[2].value, 38.46, 0.1, 'Ïã§Ï†ú ÏãúÎÇòÎ¶¨Ïò§: VIX 13‚Üí18 = ~38.5%');

    // S&P 500: 4700‚Üí5800 = +23.40%
    assertClose(sp500Norm[2].value, 23.40, 0.1, 'Ïã§Ï†ú ÏãúÎÇòÎ¶¨Ïò§: S&P 500 4700‚Üí5800 = ~23.4%');

    // ============================================
    // Í≤∞Í≥º ÏöîÏïΩ
    // ============================================

    const summaryDiv = document.getElementById('summary');
    const total = passed + failed;
    const allPassed = failed === 0;

    summaryDiv.innerHTML = `
      <span style="color: ${allPassed ? '#166534' : '#991b1b'}">
        ${allPassed ? '‚úÖ ALL PASSED' : '‚ùå SOME FAILED'}: ${passed}/${total} tests
      </span>
    `;

    console.log(`\n=== TEST SUMMARY ===`);
    console.log(`Passed: ${passed}/${total}`);
    console.log(`Failed: ${failed}/${total}`);
  </script>
</body>
</html>
