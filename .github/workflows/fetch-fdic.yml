# FDIC Tier1 Capital Ratio 데이터 수집
# 분기별 자동 실행 + 수동 실행 가능
# 결과: data/fdic-tier1.json

name: Fetch FDIC Tier1 Data

on:
  schedule:
    # 분기 첫째 주 월요일 06:00 UTC (한국 15:00)
    # 1월, 4월, 7월, 10월
    - cron: '0 6 1-7 1,4,7,10 1'
  workflow_dispatch:  # 수동 실행 버튼

jobs:
  fetch-fdic:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Create data directory
        run: mkdir -p data

      - name: Fetch FDIC Tier1 Data
        run: |
          echo "Fetching FDIC Tier1 Capital Ratio data..."

          # 2009년부터 현재까지 모든 분기 데이터 수집
          # API: https://api.fdic.gov/banks/financials (banking-health.html과 동일)

          node << 'EOF'
          const https = require('https');
          const fs = require('fs');

          // 2009 Q1 ~ 현재까지 분기 목록 생성 (YYYYMMDD 형식)
          function generateQuarters() {
            const quarterEnds = ['0331', '0630', '0930', '1231'];
            const quarters = [];
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();

            for (let year = 2009; year <= currentYear; year++) {
              for (let q = 0; q < 4; q++) {
                const qMonth = q * 3 + 2; // 2, 5, 8, 11 (0-indexed)
                // 현재 연도면 2개월 지연 고려
                if (year < currentYear || (year === currentYear && qMonth <= currentMonth - 2)) {
                  quarters.push(`${year}${quarterEnds[q]}`);
                }
              }
            }
            return quarters;
          }

          // FDIC API 호출 (banking-health.html과 동일한 형식)
          function fetchQuarter(quarterStr) {
            return new Promise((resolve) => {
              // 동일 API: https://api.fdic.gov/banks/financials
              const url = `https://api.fdic.gov/banks/financials?limit=10000&fields=RBC1AAJ,RISDATE&filters=RISDATE:${quarterStr}`;

              https.get(url, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => {
                  try {
                    const json = JSON.parse(data);
                    const ratios = json.data?.map(r => r.data?.RBC1AAJ).filter(v => v != null && !isNaN(v)) || [];

                    if (ratios.length > 0) {
                      const avg = (ratios.reduce((a, b) => a + b, 0) / ratios.length).toFixed(2);
                      const date = `${quarterStr.slice(0,4)}-${quarterStr.slice(4,6)}-${quarterStr.slice(6,8)}`;
                      resolve({
                        date: date,
                        value: parseFloat(avg),
                        banks: ratios.length
                      });
                      return;
                    }
                    resolve(null);
                  } catch (e) {
                    resolve(null);
                  }
                });
              }).on('error', () => resolve(null));
            });
          }

          async function main() {
            const quarters = generateQuarters();
            console.log(`Fetching ${quarters.length} quarters...`);

            const results = [];
            for (const q of quarters) {
              const result = await fetchQuarter(q);
              if (result) {
                results.push(result);
                console.log(`${q}: ${result.value}% (${result.banks} banks)`);
              } else {
                console.log(`${q}: No data`);
              }
              // Rate limiting
              await new Promise(r => setTimeout(r, 300));
            }

            // 날짜순 정렬
            results.sort((a, b) => a.date.localeCompare(b.date));

            // JSON 저장
            const output = {
              updated: new Date().toISOString(),
              source: 'FDIC',
              description: 'Average Tier 1 Capital Ratio (RBC1AAJ)',
              data: results
            };

            fs.writeFileSync('data/fdic-tier1.json', JSON.stringify(output, null, 2));
            console.log(`\nSaved ${results.length} quarters to data/fdic-tier1.json`);
          }

          main().catch(console.error);
          EOF

      - name: Verify output
        run: |
          echo "=== Generated JSON ==="
          head -20 data/fdic-tier1.json
          echo "..."
          echo "Total lines: $(wc -l < data/fdic-tier1.json)"

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/fdic-tier1.json
          git diff --staged --quiet || git commit -m "chore: update FDIC Tier1 data [skip ci]"
          git push
