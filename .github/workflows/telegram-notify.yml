name: Telegram Notification on New Report

on:
  push:
    paths:
      - '100x/daily-wrap/*.html'
      - '100x Briefing/Briefing/*.html'
      - 'alpha-scout/reports/*.html'
    branches:
      - main
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # push ê¶Œí•œ ì¶”ê°€
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        # tj-actions/changed-filesê°€ ì „ì²´ git íˆìŠ¤í† ë¦¬ì— ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •
        fetch-depth: 0

    - name: ğŸ“‚ ë³€ê²½ëœ íŒŒì¼ ê°ì§€
      id: changed_files
      uses: tj-actions/changed-files@v44
      with:
        files: |
          100x/daily-wrap/*.html
          100x Briefing/Briefing/*.html
          alpha-scout/reports/*.html
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        pip install requests python-dateutil

    - name: ğŸ”’ ë³´ì•ˆ í™•ì¸ (í”„ë¡ì‹œ ë°©ì‹)
      run: |
        echo "=== ë³´ì•ˆ í™•ì¸ ==="
        echo "ì›¹ íŒ¨ë„ì€ Apps Script í”„ë¡ì‹œ ë°©ì‹ì„ ì‚¬ìš©í•©ë‹ˆë‹¤."
        echo "í† í°: Apps Script Script Propertiesì— ì €ì¥"
        echo "Chat IDs: Google Sheetsì—ì„œ ë™ì  ë¡œë“œ"
        # í† í°ì´ ì½”ë“œì— ì—†ëŠ”ì§€ í™•ì¸
        if grep -q "AAEI9fI3x30mVwau" notification-control-panel-web.html 2>/dev/null; then
          echo "âŒ ê²½ê³ : ì›¹ íŒ¨ë„ì— í† í°ì´ ë°œê²¬ë¨!"
          exit 1
        else
          echo "âœ… ì›¹ íŒ¨ë„ì— í† í° ì—†ìŒ (ì•ˆì „)"
        fi

    - name: ğŸ¤– ë˜‘ë˜‘í•œ ì•Œë¦¼ ì‹œìŠ¤í…œ ì‹¤í–‰ (í”„ë¡ì‹œ ë°©ì‹)
      if: steps.changed_files.outputs.any_changed == 'true'
      run: |
        echo "=== 100xFenok ë˜‘ë˜‘í•œ ì•Œë¦¼ ì‹œìŠ¤í…œ ==="
        echo "í”„ë¡ì‹œ ë°©ì‹: í† í°/Chat IDsëŠ” Apps Scriptì—ì„œ ê´€ë¦¬"
        echo "ë‹¤ìŒ íŒŒì¼ì— ëŒ€í•´ ì•Œë¦¼ì„ ë°œì†¡í•©ë‹ˆë‹¤: ${{ steps.changed_files.outputs.all_changed_files }}"
        python smart_notification_system.py --github-action --changed-files "${{ steps.changed_files.outputs.all_changed_files }}"
