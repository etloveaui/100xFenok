name: Telegram Notification on New Report

on:
  push:
    paths:
      - '100x/daily-wrap/*.html'
      - '100x Briefing/Briefing/*.html'
      - 'alpha-scout/reports/*.html'
    branches:
      - main
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # push ê¶Œí•œ ì¶”ê°€
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        # tj-actions/changed-filesê°€ ì „ì²´ git íˆìŠ¤í† ë¦¬ì— ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •
        fetch-depth: 0

    - name: ğŸ“‚ ë³€ê²½ëœ íŒŒì¼ ê°ì§€
      id: changed_files
      uses: tj-actions/changed-files@v44
      with:
        files: |
          100x/daily-wrap/*.html
          100x Briefing/Briefing/*.html
          alpha-scout/reports/*.html
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        pip install requests python-dateutil
        
    - name: ğŸ”’ ì›¹ íŒ¨ë„ ë³´ì•ˆ ë¹Œë“œ (í† í° ì¹˜í™˜)
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      run: |
        echo "=== ì›¹ íŒ¨ë„ ë³´ì•ˆ ë¹Œë“œ ==="
        echo "í† í°ì„ ì•ˆì „í•˜ê²Œ ì¹˜í™˜í•˜ì—¬ ë°°í¬ìš© ì›¹ íŒ¨ë„ì„ ìƒì„±í•©ë‹ˆë‹¤..."
        # ë°±ì—… ìƒì„±
        cp notification-control-panel-web.html notification-control-panel-web-template.html
        # í† í° ì¹˜í™˜
        sed -i "s/\${TELEGRAM_BOT_TOKEN}/$TELEGRAM_BOT_TOKEN/g" notification-control-panel-web.html
        # ì¹˜í™˜ í™•ì¸
        echo "í† í° ì¹˜í™˜ ì™„ë£Œ í™•ì¸:"
        grep -c "7524488237" notification-control-panel-web.html || echo "í† í° ì¹˜í™˜ ì‹¤íŒ¨"
        echo "âœ… ì›¹ íŒ¨ë„ ë¹Œë“œ ì™„ë£Œ"

    - name: ğŸ¤– ë˜‘ë˜‘í•œ ì•Œë¦¼ ì‹œìŠ¤í…œ ì‹¤í–‰
      if: steps.changed_files.outputs.any_changed == 'true'
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        GITHUB_ACTIONS: true
      run: |
        echo "=== 100xFenok ë˜‘ë˜‘í•œ ì•Œë¦¼ ì‹œìŠ¤í…œ ==="
        echo "ë‹¤ìŒ íŒŒì¼ì— ëŒ€í•´ ì•Œë¦¼ì„ ë°œì†¡í•©ë‹ˆë‹¤: ${{ steps.changed_files.outputs.all_changed_files }}"
        python smart_notification_system.py --github-action --changed-files "${{ steps.changed_files.outputs.all_changed_files }}"

    - name: ğŸ“¤ ì—…ë°ì´íŠ¸ëœ ì›¹ íŒ¨ë„ ë°°í¬
      if: success()
      run: |
        echo "=== ì›¹ íŒ¨ë„ ìë™ ë°°í¬ ==="
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add notification-control-panel-web.html
        if git diff --staged --quiet; then
          echo "ë³€ê²½ì‚¬í•­ ì—†ìŒ - ë°°í¬ ê±´ë„ˆëœ€"
        else
          git commit -m "ğŸ¤– Auto-update web panel with secure token - Updated by GitHub Actions $(date '+%Y-%m-%d %H:%M:%S')"
          git push
          echo "âœ… ì›¹ íŒ¨ë„ ë°°í¬ ì™„ë£Œ"
        fi
