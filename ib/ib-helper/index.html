<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IB Helper - ë¬´í•œë§¤ìˆ˜ ë„ìš°ë¯¸</title>

  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="../../favicon.ico">
  <link rel="icon" type="image/svg+xml" href="../../favicon.svg">

  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Custom Styles for Mobile -->
  <style>
    /* Mobile-first: Large touch targets */
    .touch-target {
      min-height: 44px;
      min-width: 44px;
    }

    /* Large number display */
    .number-display {
      font-size: 1.5rem;
      font-weight: 600;
      font-variant-numeric: tabular-nums;
    }

    /* Input number styling */
    input[type="number"] {
      font-size: 1.125rem;
      font-variant-numeric: tabular-nums;
    }

    /* Order card styling */
    .order-card {
      border-left: 4px solid;
    }
    .order-card.buy {
      border-left-color: #10b981;
    }
    .order-card.sell {
      border-left-color: #ef4444;
    }

    /* Phase indicator */
    .phase-first { background: linear-gradient(135deg, #10b981, #059669); }
    .phase-second { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .phase-stop { background: linear-gradient(135deg, #ef4444, #dc2626); }

    /* Sticky header */
    .sticky-header {
      position: sticky;
      top: 0;
      z-index: 10;
      background: white;
      border-bottom: 1px solid #e5e7eb;
    }

    /* Balance Section (Phase 3) */
    .balance-input {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }
    .balance-input input {
      flex: 1;
      font-size: 1.125rem;
    }
    .status-box {
      background: #f8fafc;
      padding: 0.75rem;
      border-radius: 0.5rem;
      margin-top: 0.75rem;
    }
    .status-row {
      display: flex;
      justify-content: space-between;
      padding: 0.25rem 0;
      font-size: 0.875rem;
    }
    .status-ok { color: #10b981; font-weight: 600; }
    .status-warning { color: #ef4444; font-weight: 600; }

    /* Alert Banner */
    .alert-banner {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #fef2f2;
      border-bottom: 2px solid #ef4444;
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      z-index: 1000;
    }
    .alert-banner.hidden { display: none; }
    .alert-icon { font-size: 1.25rem; }

    /* Breakdown Table */
    .breakdown-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8125rem;
      margin-top: 0.75rem;
    }
    .breakdown-table th,
    .breakdown-table td {
      padding: 0.375rem 0.5rem;
      text-align: right;
      border-bottom: 1px solid #e2e8f0;
    }
    .breakdown-table th:first-child,
    .breakdown-table td:first-child {
      text-align: left;
    }
    .breakdown-table th {
      background: #f8fafc;
      font-weight: 500;
      color: #64748b;
    }
    .bar-cell {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    .bar {
      height: 6px;
      background: #3b82f6;
      border-radius: 3px;
    }

    /* Order Type Badge */
    .order-badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.625rem;
      font-weight: 700;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }
    .badge-loc {
      background: #dbeafe;
      color: #1d4ed8;
    }
    .badge-limit {
      background: #fef3c7;
      color: #d97706;
    }

    /* Quick Add Buttons */
    .quick-add-btn {
      min-width: 42px;
      min-height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.875rem;
      transition: all 0.15s;
    }
    .quick-add-btn:active {
      transform: scale(0.95);
    }

    /* Copy Button Animation */
    .copy-btn {
      opacity: 0.6;
      transition: all 0.15s;
    }
    .copy-btn:hover {
      opacity: 1;
    }
    .copy-btn.copied {
      color: #10b981;
    }

    /* Order Card Enhanced */
    .order-card-enhanced {
      position: relative;
      border-radius: 12px;
      padding: 1rem;
      border-left: 4px solid;
      transition: all 0.15s;
    }
    .order-card-enhanced:active {
      transform: scale(0.99);
    }
    .order-card-enhanced.buy {
      background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
      border-left-color: #10b981;
    }
    .order-card-enhanced.sell {
      background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
      border-left-color: #ef4444;
    }
    .order-card-enhanced.decline {
      background: linear-gradient(135deg, #f0f9ff 0%, #dbeafe 100%);
      border-left-color: #3b82f6;
    }

    /* Main Value Display */
    .main-value {
      font-size: 1.75rem;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
      line-height: 1;
    }
    .sub-value {
      font-size: 1rem;
      font-weight: 600;
      color: #6b7280;
    }

    /* Section Header */
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.75rem;
    }

    /* Toast Notification */
    .toast {
      background: #1f2937;
      color: white;
      padding: 0.75rem 1rem;
      border-radius: 0.75rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      animation: toast-in 0.3s ease-out;
      pointer-events: auto;
    }
    .toast.success { background: #059669; }
    .toast.error { background: #dc2626; }
    .toast.warning { background: #d97706; }
    @keyframes toast-in {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes toast-out {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(-20px); }
    }

    /* Formula Details (v4.23.0) */
    .formula-details {
      background: rgba(255,255,255,0.95);
      border-radius: 0.5rem;
      padding: 0.75rem;
      margin-top: 0.75rem;
      font-size: 0.75rem;
      color: #374151;
      border: 1px solid rgba(255,255,255,0.3);
    }
    .formula-row {
      display: flex;
      justify-content: space-between;
      padding: 0.25rem 0;
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }
    .formula-row:last-child {
      border-bottom: none;
    }
    .formula-label {
      color: #9ca3af;
    }
    .formula-value {
      font-family: 'Monaco', 'Courier New', monospace;
      color: #e5e7eb;
    }
    .formula-toggle {
      cursor: pointer;
      transition: transform 0.2s;
    }
    .formula-toggle:hover {
      transform: scale(1.1);
    }

    /* Focus Ring for Accessibility */
    input:focus, button:focus, select:focus {
      outline: none;
      box-shadow: 0 0 0 2px #3b82f6;
    }

    /* v4.28.0: Ticker Checkbox + Multi-Results Accordion */
    .ticker-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .ticker-checkbox:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    /* Accordion Styles */
    .accordion-item {
      border: 1px solid #e5e7eb;
      border-radius: 0.75rem;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .accordion-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1rem;
      background: linear-gradient(135deg, #1e293b, #0f172a);
      color: white;
      cursor: pointer;
      user-select: none;
    }
    .accordion-header:hover {
      background: linear-gradient(135deg, #334155, #1e293b);
    }
    .accordion-chevron {
      transition: transform 0.2s;
    }
    .accordion-item.open .accordion-chevron {
      transform: rotate(180deg);
    }
    .accordion-content {
      display: none;
      padding: 1rem;
      background: #f8fafc;
    }
    .accordion-item.open .accordion-content {
      display: block;
    }
    .accordion-badge {
      display: inline-block;
      padding: 0.125rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.625rem;
      font-weight: 600;
      margin-left: 0.5rem;
    }
    .accordion-badge-first { background: rgba(16, 185, 129, 0.2); color: #10b981; }
    .accordion-badge-second { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
    .accordion-badge-stop { background: rgba(239, 68, 68, 0.2); color: #ef4444; }

    /* Order Section in Accordion */
    .order-section {
      margin-bottom: 1rem;
    }
    .order-section:last-child {
      margin-bottom: 0;
    }
    .order-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.5rem 0;
      border-bottom: 1px solid #e5e7eb;
      margin-bottom: 0.5rem;
    }
    .order-section-title {
      font-weight: 600;
      font-size: 0.875rem;
      color: #374151;
    }
    .section-copy-btn {
      padding: 0.25rem 0.5rem;
      background: #e5e7eb;
      border-radius: 0.375rem;
      font-size: 0.75rem;
      color: #4b5563;
      transition: all 0.15s;
    }
    .section-copy-btn:hover {
      background: #d1d5db;
      color: #1f2937;
    }
    .order-copy-btn {
      background: transparent;
      color: #9ca3af;
      border: none;
      padding: 0.15rem 0.35rem;
      border-radius: 0.375rem;
      transition: color 0.15s;
    }
    .order-copy-btn:hover {
      color: #2563eb;
    }
    .order-copy-btn.copied {
      color: #10b981;
    }
    .qty-copy-btn {
      color: #6b7280;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">

  <!-- Alert Banner (Phase 3) -->
  <div id="alert-banner" class="alert-banner hidden" role="alert" aria-live="assertive">
    <span class="alert-icon">ğŸš¨</span>
    <span id="alert-message" class="flex-1 text-sm text-red-700 font-medium"></span>
    <button onclick="dismissAlert()" class="touch-target text-red-400 hover:text-red-600">
      <i class="fas fa-times"></i>
    </button>
  </div>

  <!-- Header (v4.21.0: Mobile simplified) -->
  <header class="sticky-header px-3 py-2 lg:px-4 lg:py-3">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-2 lg:gap-3">
        <a href="../" class="text-gray-500 hover:text-gray-700 touch-target flex items-center justify-center" aria-label="ë’¤ë¡œê°€ê¸°">
          <i class="fas fa-arrow-left"></i>
        </a>
        <h1 class="text-base lg:text-lg font-bold">
          <span class="bg-gradient-to-r from-rose-500 to-amber-500 bg-clip-text text-transparent">IB</span>
          <span class="text-gray-800 hidden sm:inline"> Helper</span>
        </h1>
        <div class="flex items-center gap-1" id="header-sync-controls">
          <!-- ğŸ”´ v4.31.0 (B5-10): ë™ê¸°í™” ìƒíƒœ í‘œì‹œ -->
          <span id="header-sync-status" class="text-xs px-2 py-0.5 rounded-full bg-gray-200 text-gray-500">
            <i class="fas fa-check-circle text-[8px] mr-1"></i><span>ë¡œì»¬ ì €ì¥ë¨</span>
          </span>
          <!-- ğŸ”´ v4.31.0 (B5-06): ë©”ì¸ ë™ê¸°í™” ë²„íŠ¼ -->
          <button id="header-sync-btn" onclick="quickSyncToCloud()" class="hidden text-gray-400 hover:text-blue-500 touch-target flex items-center justify-center" title="í´ë¼ìš°ë“œ ë™ê¸°í™”">
            <i class="fas fa-cloud-upload-alt"></i>
          </button>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <span id="today-date" class="text-xs text-gray-500"></span>
      </div>
    </div>
  </header>

  <!-- Empty State (í”„ë¡œí•„ ì—†ì„ ë•Œ) - Light Theme -->
  <div id="empty-state" class="hidden px-4 py-12 max-w-lg mx-auto">
    <div class="bg-white rounded-2xl p-8 shadow-lg border border-gray-100 text-center">
      <!-- Logo -->
      <div class="w-24 h-24 bg-gradient-to-br from-rose-500 to-amber-500 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg">
        <span class="text-white text-3xl font-black">100x</span>
      </div>

      <!-- Title -->
      <h1 class="text-2xl font-black mb-1">
        <span class="bg-gradient-to-r from-rose-500 to-amber-500 bg-clip-text text-transparent">100x</span>
        <span class="text-gray-800"> IB Helper</span>
      </h1>
      <p class="text-gray-500 text-sm mb-8">ë¬´í•œë§¤ìˆ˜ V2.2 ì•Œê³ ë¦¬ì¦˜</p>

      <!-- Google Login Button -->
      <button onclick="quickStart()" class="w-full py-4 bg-gradient-to-r from-rose-500 to-amber-500 text-white rounded-xl font-semibold text-lg hover:from-rose-600 hover:to-amber-600 transition-all shadow-md flex items-center justify-center gap-3">
        <svg class="w-5 h-5" viewBox="0 0 24 24"><path fill="#fff" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#fff" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#fff" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#fff" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
        Googleë¡œ ì‹œì‘í•˜ê¸°
      </button>

      <p class="mt-3 text-xs text-gray-400">
        ğŸ“Š Google Sheets ìë™ ë™ê¸°í™” (1ì‹œê°„ ì„¸ì…˜)
      </p>

      <button onclick="quickStartOffline()" class="mt-4 text-xs text-gray-400 hover:text-gray-600 underline underline-offset-2">
        ë¡œê·¸ì¸ ì—†ì´ ì‹œì‘
      </button>

      <!-- Powered by -->
      <div class="mt-8 pt-6 border-t border-gray-100">
        <p class="text-xs text-gray-400">Powered by <span class="font-bold text-rose-500">FENOK</span></p>
      </div>
    </div>
  </div>

  <!-- Main Content: PC 2-column / Mobile single column (hidden until profile exists) -->
  <main id="main-content" style="display: none;" class="px-4 py-4 max-w-6xl mx-auto md:flex md:gap-6">

    <!-- LEFT COLUMN: Input Sections -->
    <div id="input-column" class="space-y-4 md:w-96 md:flex-shrink-0">

    <!-- Profile Selector (moved from header) -->
    <div class="bg-white rounded-xl p-3 shadow-sm flex items-center gap-2">
      <select id="profile-selector" onchange="switchProfile(this.value)" class="flex-1 px-3 py-2 border border-gray-200 rounded-lg text-sm font-medium bg-white">
        <!-- Dynamic options -->
      </select>
      <button onclick="showProfileSettings()" class="touch-target px-3 py-2 bg-gray-100 rounded-lg text-gray-600 hover:bg-gray-200" aria-label="í”„ë¡œí•„ ì„¤ì •">
        <i class="fas fa-user-cog"></i>
      </button>
    </div>

    <!-- Ticker Selection -->
    <div class="bg-white rounded-xl p-4 shadow-sm">
      <label class="block text-sm font-medium text-gray-700 mb-2">ì¢…ëª© ì„ íƒ</label>
      <div id="ticker-buttons" class="grid grid-cols-2 gap-2">
        <button onclick="selectTicker('TQQQ')" class="ticker-btn touch-target py-3 rounded-lg text-center font-semibold transition-all bg-gray-100 text-gray-600 hover:bg-blue-100" data-ticker="TQQQ">TQQQ</button>
        <button onclick="selectTicker('SOXL')" class="ticker-btn touch-target py-3 rounded-lg text-center font-semibold transition-all bg-gray-100 text-gray-600 hover:bg-blue-100" data-ticker="SOXL">SOXL</button>
      </div>
    </div>

    <!-- Settings (Collapsible) -->
    <details class="bg-white rounded-xl shadow-sm">
      <summary class="px-4 py-3 cursor-pointer font-medium text-gray-700 flex items-center justify-between">
        <span><i class="fas fa-cog mr-2 text-gray-400"></i>ì„¤ì •</span>
        <i class="fas fa-chevron-down text-gray-400 transition-transform"></i>
      </summary>
      <div class="px-4 pb-4 space-y-3 border-t border-gray-100 pt-3">
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-xs text-gray-500 mb-1">ì„¸íŒ…ì›ê¸ˆ ($)</label>
            <input type="number" id="input-principal" class="w-full px-3 py-2 border rounded-lg" placeholder="0" inputmode="numeric" onchange="saveCurrentInputs()">
          </div>
          <div>
            <label class="block text-xs text-gray-500 mb-1">ë¶„í•  ìˆ˜</label>
            <input type="number" id="input-divisions" class="w-full px-3 py-2 border rounded-lg" value="40" inputmode="numeric" onchange="saveCurrentInputs()">
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-xs text-gray-500 mb-1">AFTER% (TQQQ=10)</label>
            <input type="number" id="input-sellPercent" class="w-full px-3 py-2 border rounded-lg" value="12" step="0.5" inputmode="decimal" onchange="saveCurrentInputs()">
          </div>
          <div>
            <label class="block text-xs text-gray-500 mb-1">LOC% (TQQQ=5)</label>
            <input type="number" id="input-locSellPercent" class="w-full px-3 py-2 border rounded-lg" value="6" step="0.5" inputmode="decimal" onchange="saveCurrentInputs()">
          </div>
        </div>
        <!-- ğŸ”´ v4.46.0: ë²„ì „ í‘œì‹œ -->
        <div class="text-right text-[10px] text-gray-300 mt-2">v4.49.3 (02-11)</div>
      </div>
    </details>

    <!-- Daily Input -->
    <div class="bg-white rounded-xl p-4 shadow-sm space-y-3">
      <h3 class="font-medium text-gray-700"><i class="fas fa-edit mr-2 text-blue-500"></i>ì˜¤ëŠ˜ ì…ë ¥</h3>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <div>
          <label class="block text-xs text-gray-500 mb-1">í‰ë‹¨ê°€ ($)</label>
          <input type="number"
                 id="input-avgPrice"
                 class="w-full px-3 py-2 border rounded-lg text-lg bg-gray-50 cursor-not-allowed"
                 placeholder="0.00"
                 step="0.01"
                 inputmode="decimal"
                 readonly>
          <p class="text-sm text-gray-400 mt-1">ì´ ë§¤ì…ê¸ˆ Â· ë³´ìœ  ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ë©´ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤</p>
        </div>
        <div>
          <label class="block text-xs text-gray-500 mb-1">í˜„ì¬ê°€</label>
          <div id="current-price-display"
               class="w-full px-3 py-2 border-2 border-blue-100 rounded-lg bg-blue-50 text-xl font-semibold text-blue-700 flex items-center justify-center gap-2 min-h-[52px]"
               role="status"
               aria-live="polite">
            <span id="price-value">--</span>
            <span id="price-source-badge" class="hidden text-xs font-medium px-1.5 py-0.5 rounded"></span>
          </div>
          <p class="text-sm text-gray-400 mt-1">ìµœì‹  ì‹œì„¸ APIì—ì„œ ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤</p>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="block text-xs text-gray-500 mb-1">ì´ ë§¤ì…ê¸ˆ ($)</label>
          <input type="number" id="input-totalInvested" class="w-full px-3 py-2 border rounded-lg" placeholder="0.00" step="0.01" inputmode="decimal" onchange="autoCalcAvgPrice(); saveCurrentInputs()">
        </div>
        <div>
          <label class="block text-xs text-gray-500 mb-1">ë³´ìœ  ìˆ˜ëŸ‰</label>
          <div class="flex gap-1">
            <input type="number" id="input-holdings" class="flex-1 min-w-0 px-3 py-2 border rounded-lg" placeholder="0" inputmode="numeric" onchange="autoCalcAvgPrice(); saveCurrentInputs()">
            <button onclick="adjustHoldings(1)" class="quick-add-btn bg-green-100 text-green-700 hover:bg-green-200">+1</button>
            <button onclick="adjustHoldings(3)" class="quick-add-btn bg-green-100 text-green-700 hover:bg-green-200">+3</button>
          </div>
        </div>
      </div>

      <!-- ì˜¤ëŠ˜ ë§¤ìˆ˜ëŸ‰ ì¶”ê°€ -->
      <div id="today-buy-helper" class="hidden bg-blue-50 rounded-lg p-3">
        <div class="flex items-center justify-between">
          <span class="text-sm text-blue-700">
            <i class="fas fa-lightbulb mr-1"></i>ì˜¤ëŠ˜ <span id="today-buy-qty">0</span>ì£¼ ë§¤ìˆ˜?
          </span>
          <button onclick="applyTodayBuy()" class="px-3 py-1 bg-blue-500 text-white rounded-lg text-sm font-medium hover:bg-blue-600">
            <i class="fas fa-plus mr-1"></i>ìˆ˜ëŸ‰ ì¶”ê°€
          </button>
        </div>
        <div id="yesterday-buy-compare" class="hidden text-sm text-gray-500 mt-1"></div>
      </div>

      <!-- Calculate Buttons (v4.28.0: ë‹¤ì¤‘ ê³„ì‚° #217) -->
      <div class="space-y-2">
        <!-- ì „ì²´ ê³„ì‚° (ì²´í¬ëœ ì¢…ëª© ëª¨ë‘) -->
        <button onclick="calculateAllOrders()" class="w-full touch-target py-4 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl font-semibold text-lg hover:from-blue-600 hover:to-blue-700 transition-all shadow-md">
          <i class="fas fa-calculator mr-2"></i>ì „ì²´ ê³„ì‚°
        </button>
        <!-- ì„ íƒ ì¢…ëª©ë§Œ (ê¸°ì¡´ ë™ì‘ ìœ ì§€) -->
        <button onclick="calculateOrders()" class="w-full touch-target py-2 bg-gray-100 text-gray-600 rounded-lg font-medium text-sm hover:bg-gray-200 transition-all">
          <i class="fas fa-check-circle mr-1"></i>ì„ íƒ ì¢…ëª©ë§Œ ê³„ì‚°
        </button>
      </div>
    </div>

    <!-- Cash Management (Phase 3) - moved into left column -->
    <div class="bg-white rounded-xl p-4 shadow-sm">
      <h3 class="font-medium text-gray-700 mb-3">
        <i class="fas fa-wallet mr-2 text-amber-500"></i>ì˜ˆìˆ˜ê¸ˆ ê´€ë¦¬
      </h3>
      <div class="balance-input">
        <div class="flex-1">
          <label class="block text-xs text-gray-500 mb-1">ì£¼ë¬¸ê°€ëŠ¥ê¸ˆì•¡ (USD)</label>
          <input type="number" id="input-balance" class="w-full px-3 py-2 border rounded-lg" placeholder="0.00" step="0.01" inputmode="decimal">
        </div>
        <div class="w-24">
          <label class="block text-xs text-gray-500 mb-1">ìˆ˜ìˆ˜ë£Œ(%)</label>
          <input type="number" id="input-commission" class="w-full px-3 py-2 border rounded-lg" value="0.07" step="0.01" inputmode="decimal">
        </div>
        <button onclick="recalculateBalance()" class="touch-target mt-5 px-3 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600">
          <i class="fas fa-sync-alt"></i>
        </button>
      </div>
      <div id="order-status" class="status-box hidden"></div>
      <div id="stock-breakdown" class="hidden"></div>
    </div>

    <!-- Cash Reserve (P4: SGOV/BIL/BILS) -->
    <div id="cash-reserve-section" class="bg-white rounded-xl p-4 shadow-sm hidden">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-medium text-gray-700">
          <i class="fas fa-coins mr-2 text-emerald-500"></i>í˜„ê¸ˆì„± ìì‚°
        </h3>
        <button onclick="saveCashReserveData()" class="px-3 py-1 text-xs font-semibold text-emerald-600 bg-emerald-50 rounded-full hover:bg-emerald-100">
          <i class="fas fa-save mr-1"></i>ì €ì¥
        </button>
      </div>
      <p class="text-sm text-gray-400 mb-2">SGOV/BIL/BILS ë³´ìœ ëŸ‰Â·í‰ë‹¨ ìˆ˜ë™ ì…ë ¥</p>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="text-gray-400">
            <tr>
              <th class="text-left py-1">ì¢…ëª©</th>
              <th class="text-right py-1">ìˆ˜ëŸ‰</th>
              <th class="text-right py-1">í‰ë‹¨</th>
              <th class="text-right py-1">í˜„ì¬ê°€</th>
              <th class="text-right py-1">í‰ê°€ê¸ˆ</th>
            </tr>
          </thead>
          <tbody id="cash-reserve-rows" class="text-gray-700"></tbody>
        </table>
      </div>
      <div class="mt-2 flex items-center justify-between text-xs text-gray-600">
        <span>ì´ í˜„ê¸ˆì„± ìì‚°</span>
        <span id="cash-reserve-total">$0</span>
      </div>
      <div id="cash-reserve-reco" class="mt-2 text-xs font-semibold text-emerald-600 hidden"></div>
    </div>

    </div><!-- END LEFT COLUMN (input-column) -->

    <!-- RIGHT COLUMN: Results (PC: inline, Mobile: overlay) -->
    <div id="results-column" class="hidden md:block md:flex-1 md:min-w-0">
      <!-- PC Results Container -->
      <div id="results-pc" class="hidden md:block sticky top-4 space-y-4">
        <div class="text-center text-gray-400 py-8">
          <i class="fas fa-calculator text-4xl mb-2"></i>
          <p>ì£¼ë¬¸ ê³„ì‚° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</p>
        </div>
      </div>
    </div>

    <!-- Mobile Results Overlay -->
    <div id="results-overlay" class="fixed inset-0 bg-black/50 z-50 hidden md:hidden" onclick="closeResultsOverlay()">
      <div class="absolute inset-x-0 bottom-0 top-16 bg-gray-100 rounded-t-2xl overflow-y-auto" onclick="event.stopPropagation()">
        <div class="sticky top-0 bg-white px-4 py-3 border-b flex items-center justify-between shadow-sm">
          <h2 class="font-bold text-gray-800"><i class="fas fa-receipt mr-2"></i>ì£¼ë¬¸ ê²°ê³¼</h2>
          <button onclick="closeResultsOverlay()" class="touch-target text-gray-400 hover:text-gray-600">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
        <div id="results-mobile" class="p-4 space-y-4">
          <!-- Mobile results content -->
        </div>
      </div>
    </div>

    <!-- Results Section (Original - now hidden, used as template) -->
    <div id="results-section" class="hidden space-y-4">

      <!-- Summary Card -->
      <div id="summary-card" class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-xl p-4 text-white">
        <div class="flex items-center justify-between mb-3">
          <div>
            <span id="result-ticker" class="text-2xl font-bold">SOXL</span>
            <span id="result-phase" class="ml-2 px-2 py-0.5 text-xs rounded bg-green-500/30 text-green-300">ì „ë°˜ì „</span>
          </div>
          <div class="text-right">
            <div class="text-xs text-slate-400">Tê°’</div>
            <div id="result-T" class="text-2xl font-bold">15.4</div>
          </div>
        </div>

        <div class="grid grid-cols-3 gap-3 text-center">
          <div class="bg-white/10 rounded-lg p-2">
            <div class="text-xs text-slate-400">ë³„%</div>
            <div id="result-starPercent" class="text-lg font-semibold">2.8%</div>
          </div>
          <div class="bg-white/10 rounded-lg p-2">
            <div class="text-xs text-slate-400">1íšŒë§¤ìˆ˜</div>
            <div id="result-oneTimeBuy" class="text-lg font-semibold">$325</div>
          </div>
          <div class="bg-white/10 rounded-lg p-2">
            <div class="text-xs text-slate-400">LOCê°€</div>
            <div id="result-locPrice" class="text-lg font-semibold">$54.52</div>
          </div>
        </div>

        <div id="result-locReason" class="mt-2 text-xs text-slate-400 text-center">
          ë³„%ê°€ ì„ íƒ (í˜„ì¬ê°€+15% = $57.68)
        </div>

        <!-- v4.23.0: Formula Details Toggle -->
        <div class="mt-3 text-center">
          <button onclick="toggleFormulaDetails()" class="formula-toggle text-xs text-slate-400 hover:text-white">
            <i id="formula-toggle-icon" class="fas fa-chevron-down mr-1"></i>
            <span id="formula-toggle-text">ê³µì‹ ìƒì„¸</span>
          </button>
        </div>

        <!-- Formula Details Panel (hidden by default) -->
        <div id="formula-details" class="hidden formula-details">
          <div class="space-y-2 text-xs">
            <div>
              <div class="text-slate-400 mb-1">ğŸ“ Tê°’ ê³„ì‚°</div>
              <div id="formula-T" class="font-mono text-slate-200 bg-slate-800/50 px-2 py-1 rounded">
                T = ceil((ì´ë§¤ì…ê¸ˆ / 1íšŒë§¤ìˆ˜) Ã— 10) / 10
              </div>
            </div>
            <div>
              <div class="text-slate-400 mb-1">â­ ë³„% ê³„ì‚°</div>
              <div id="formula-star" class="font-mono text-slate-200 bg-slate-800/50 px-2 py-1 rounded">
                ë³„% = sellPercent Ã— (1 - T / 20)
              </div>
            </div>
            <div>
              <div class="text-slate-400 mb-1">ğŸ“Š LOC ë§¤ë„ê°€</div>
              <div id="formula-locSell" class="font-mono text-slate-200 bg-slate-800/50 px-2 py-1 rounded">
                LOC ë§¤ë„ê°€ = ë³„%ê°€ + (í‰ë‹¨ê°€ Ã— 0.5%)
              </div>
            </div>
            <div>
              <div class="text-slate-400 mb-1">ğŸ’° ì§€ì •ê°€ ë§¤ë„</div>
              <div id="formula-limitSell" class="font-mono text-slate-200 bg-slate-800/50 px-2 py-1 rounded">
                ì§€ì •ê°€ = í‰ë‹¨ê°€ Ã— (1 + AFTER%)
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- #219: ì „ì²´ ë³µì‚¬ ë²„íŠ¼ -->
      <div class="flex justify-end mb-2">
        <button onclick="copyAllOrdersTotal()" class="px-3 py-1.5 bg-slate-700 text-white rounded-lg text-sm hover:bg-slate-800 transition-colors">
          <i class="fas fa-clipboard-list mr-1"></i>ì „ì²´ ë³µì‚¬
        </button>
      </div>

      <!-- Buy Orders (v4.22.0: ì¶•ì†Œëœ ì¹´ë“œ) -->
      <div class="bg-white rounded-xl p-3 shadow-sm">
        <div class="section-header">
          <h3 class="font-medium text-green-600 text-sm">
            <i class="fas fa-arrow-down mr-1"></i>ë§¤ìˆ˜ <span class="order-badge badge-loc ml-1">LOC</span>
          </h3>
          <button onclick="copyAllOrders('buy')" class="copy-btn text-gray-400 hover:text-gray-600">
            <i class="fas fa-copy"></i>
          </button>
        </div>
        <div id="buy-orders" class="space-y-2">
          <!-- Dynamic content -->
        </div>
      </div>

      <!-- Sell Orders (v4.22.0: ì¶•ì†Œëœ ì¹´ë“œ) -->
      <div class="bg-white rounded-xl p-3 shadow-sm">
        <div class="section-header">
          <h3 class="font-medium text-red-600 text-sm">
            <i class="fas fa-arrow-up mr-1"></i>ë§¤ë„
          </h3>
          <button onclick="copyAllOrders('sell')" class="copy-btn text-gray-400 hover:text-gray-600">
            <i class="fas fa-copy"></i>
          </button>
        </div>
        <div id="sell-orders" class="space-y-2">
          <!-- Dynamic content -->
        </div>
      </div>

      <!-- Quarter Stop Loss Warning (#216: ì²´í¬ë°•ìŠ¤ ì¶”ê°€) -->
      <div id="quarter-stop-loss" class="hidden bg-red-50 border border-red-200 rounded-xl p-4">
        <div class="flex items-start gap-3 mb-3">
          <input type="checkbox" id="quarter-stop-checkbox" class="mt-1 w-5 h-5 text-red-600 rounded focus:ring-red-500" onchange="handleQuarterStopChange()">
          <label for="quarter-stop-checkbox" class="flex-1">
            <h3 class="font-bold text-red-700">
              <i class="fas fa-exclamation-triangle mr-2"></i>ì¿¼í„°ì†ì ˆ ì‹¤í–‰í•˜ê¸°
            </h3>
            <p class="text-xs text-red-500 mt-1">T>40 ë„ë‹¬ - ì²´í¬í•˜ë©´ MOC ì£¼ë¬¸ ì•ˆë‚´ê°€ í‘œì‹œë©ë‹ˆë‹¤</p>
          </label>
        </div>
        <div id="quarter-stop-loss-content" class="text-sm text-red-600 space-y-1 hidden">
          <!-- Dynamic content -->
        </div>
        <div id="quarter-stop-moc-order" class="hidden mt-3 p-3 bg-red-100 rounded-lg">
          <div class="flex items-center justify-between">
            <div>
              <span class="font-bold text-red-800">MOC ë§¤ë„</span>
              <span id="quarter-moc-qty" class="ml-2 text-lg font-bold text-red-700">0ì£¼</span>
            </div>
            <button onclick="copyMocOrder()" class="px-3 py-1 bg-red-600 text-white rounded text-sm hover:bg-red-700">
              <i class="fas fa-copy mr-1"></i>ë³µì‚¬
            </button>
          </div>
          <p class="text-xs text-red-600 mt-2">
            <i class="fas fa-info-circle mr-1"></i>ì¥ ë§ˆê° ì „ MOC(Market on Close) ì£¼ë¬¸ìœ¼ë¡œ 1/4 ë§¤ë„
          </p>
        </div>
      </div>

    </div>

    <!-- v4.28.0: ë‹¤ì¤‘ ì¢…ëª© ê²°ê³¼ ì„¹ì…˜ (#217) -->
    <div id="multi-results-section" class="hidden space-y-3 mt-4">
      <div class="flex items-center justify-between">
        <h2 class="font-bold text-gray-800"><i class="fas fa-list-check mr-2 text-blue-500"></i>ì „ì²´ ì¢…ëª© ê²°ê³¼</h2>
        <button onclick="copyAllTickersOrders()" class="px-3 py-1.5 bg-blue-500 text-white rounded-lg text-sm font-medium hover:bg-blue-600">
          <i class="fas fa-copy mr-1"></i>ì „ì²´ ë³µì‚¬
        </button>
      </div>
      <div id="results-accordion" class="grid gap-3 md:grid-cols-2">
        <!-- ì•„ì½”ë””ì–¸ ì•„ì´í…œë“¤ì´ ì—¬ê¸°ì— ë™ì  ìƒì„± -->
      </div>
    </div>

  </main>

  <!-- Profile Settings Modal -->
  <div id="profile-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-end sm:items-center justify-center" onclick="handleModalBackdrop(event)" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="bg-white w-full sm:w-96 sm:rounded-xl rounded-t-xl max-h-[80vh] overflow-y-auto" onclick="event.stopPropagation()">
      <div class="sticky top-0 bg-white px-4 py-3 border-b flex items-center justify-between">
        <h2 id="modal-title" class="font-bold text-gray-800">í”„ë¡œí•„ ì„¤ì •</h2>
        <button onclick="closeProfileModal()" class="touch-target text-gray-400 hover:text-gray-600" aria-label="ë‹«ê¸°">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="p-4 space-y-4">
        <!-- ğŸ”´ v4.31.0 (B5-02): í”„ë¡œí•„ ì „í™˜ ë“œë¡­ë‹¤ìš´ -->
        <div>
          <label class="block text-xs text-gray-500 mb-1">í˜„ì¬ í”„ë¡œí•„</label>
          <select id="modal-profile-selector" onchange="switchProfileFromModal(this.value)" class="w-full px-3 py-2 border rounded-lg bg-white focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm font-medium">
            <!-- Dynamic options -->
          </select>
        </div>

        <!-- Profile Info + New Profile Button (v4.22.0: í•œ ì¤„ ë°°ì¹˜) -->
        <div class="flex gap-2 items-end">
          <div class="flex-1">
            <label class="block text-xs text-gray-500 mb-1">í”„ë¡œí•„ ì´ë¦„</label>
            <input type="text" id="modal-profile-name" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="ì´ë¦„" onchange="saveProfileName()">
          </div>
          <button onclick="createNewProfile()" class="px-3 py-2 bg-green-500 text-white rounded-lg text-sm hover:bg-green-600 whitespace-nowrap">
            <i class="fas fa-plus mr-1"></i>ìƒˆ í”„ë¡œí•„
          </button>
        </div>

        <!-- Profile Stocks -->
        <div>
          <label class="block text-xs text-gray-500 mb-2">ë“±ë¡ ì¢…ëª©</label>
          <div id="modal-stocks-list" class="space-y-2">
            <!-- Dynamic content -->
          </div>
          <button onclick="showAddStockForm()" class="mt-2 w-full py-2 border-2 border-dashed border-gray-200 rounded-lg text-gray-400 text-sm hover:border-blue-300 hover:text-blue-500 focus:ring-2 focus:ring-blue-500 focus:outline-none">
            <i class="fas fa-plus mr-1"></i>ì¢…ëª© ì¶”ê°€
          </button>
        </div>

        <!-- Add Stock Form (hidden by default) -->
        <div id="add-stock-form" class="hidden bg-gray-50 rounded-lg p-3 space-y-2">
          <div class="grid grid-cols-2 gap-2">
            <input type="text" id="new-stock-symbol" class="px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="ì¢…ëª©ì½”ë“œ (ì˜ˆ: TQQQ)">
            <input type="number" id="new-stock-principal" class="px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="ì„¸íŒ…ì›ê¸ˆ ($)">
          </div>
          <div class="flex gap-2">
            <button onclick="addNewStock()" class="flex-1 py-2 bg-blue-500 text-white rounded-lg text-sm">ì¶”ê°€</button>
            <button onclick="hideAddStockForm()" class="px-4 py-2 bg-gray-200 rounded-lg text-sm">ì·¨ì†Œ</button>
          </div>
        </div>

        <!-- Additional Buy Strategy (#246 í™•ì¥) -->
        <div class="bg-amber-50 border border-amber-100 rounded-lg p-3 space-y-3">
          <div class="flex items-center justify-between">
            <label for="modal-additional-enabled" class="text-sm font-medium text-gray-700">í•˜ë½ëŒ€ë¹„ ì‚¬ìš©</label>
            <input id="modal-additional-enabled" type="checkbox" class="w-4 h-4 accent-amber-500" onchange="saveAdditionalBuySettings()">
          </div>
          <div>
            <label for="modal-additional-mode" class="block text-xs text-gray-500 mb-1">í•˜ë½ëŒ€ë¹„ ëª¨ë“œ</label>
            <select id="modal-additional-mode"
                    class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-amber-400 focus:outline-none bg-white"
                    onchange="saveAdditionalBuySettings()">
              <option value="budget_ratio">ì˜ˆì‚°ë¹„ìœ¨ (ê¸°ë³¸)</option>
              <option value="fixed">ê³ ì • ê°œìˆ˜</option>
            </select>
          </div>
          <div>
            <label for="modal-additional-budget-ratio" class="block text-xs text-gray-500 mb-1">ì˜ˆì‚°ë¹„ìœ¨ (%)</label>
            <input id="modal-additional-budget-ratio"
                   type="number"
                   min="0"
                   max="100"
                   step="1"
                   class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-amber-400 focus:outline-none"
                   onchange="saveAdditionalBuySettings()">
          </div>
          <div class="flex items-center justify-between">
            <label for="modal-additional-allow-over" class="text-xs text-gray-600">ëª©í‘œ ì´ˆê³¼ 1ê°œ í—ˆìš©</label>
            <input id="modal-additional-allow-over" type="checkbox" class="w-4 h-4 accent-amber-500" onchange="saveAdditionalBuySettings()">
          </div>
          <div>
            <label for="modal-additional-order-count" class="block text-xs text-gray-500 mb-1">í•˜ë½ëŒ€ë¹„ ì£¼ë¬¸ ê°œìˆ˜ (0~8)</label>
            <input id="modal-additional-order-count"
                   type="number"
                   min="0"
                   max="8"
                   step="1"
                   class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-amber-400 focus:outline-none"
                   onchange="saveAdditionalBuySettings()">
            <p class="mt-1 text-[11px] text-gray-500">ê¸°ë³¸: ì˜ˆì‚°ë¹„ìœ¨ 25% + ëª©í‘œ ì´ˆê³¼ 1ê°œ í—ˆìš©. ê³ ì • ê°œìˆ˜ ëª¨ë“œë¡œë„ ì „í™˜ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
          </div>
        </div>

        <!-- Google Sync Status (ìƒë‹¨ ë°°ì¹˜) ğŸ”´ v4.29.1: ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ì¶”ê°€ -->
        <div id="google-sync-section" class="bg-gradient-to-r from-blue-50 to-green-50 rounded-lg p-3 border border-blue-100">
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-2">
              <i class="fab fa-google text-blue-500"></i>
              <span id="sheets-user" class="text-sm font-medium text-gray-700 truncate">ë¯¸ì—°ê²°</span>
            </div>
            <div class="flex items-center gap-2">
              <span id="sheets-status" class="text-xs px-2 py-0.5 rounded-full bg-gray-200 text-gray-600">ì˜¤í”„ë¼ì¸</span>
              <button id="logout-btn" onclick="handleSignOut()" class="hidden text-xs px-2 py-0.5 rounded-full bg-red-100 text-red-600 hover:bg-red-200" title="ë¡œê·¸ì•„ì›ƒ">
                <i class="fas fa-sign-out-alt"></i>
              </button>
            </div>
          </div>
          <button onclick="handleSheetsPull()" class="w-full py-2 bg-white border border-gray-200 rounded-lg text-sm text-gray-600 hover:bg-gray-50">
            <i class="fas fa-cloud-download-alt mr-1"></i>ì‹œíŠ¸ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
          </button>
        </div>

        <!-- Main Actions (v4.22.0: ìƒˆ í”„ë¡œí•„ ë²„íŠ¼ ìƒë‹¨ ì´ë™) -->
        <div class="pt-3 space-y-2">
          <button onclick="syncToCloud()" class="w-full py-3 bg-blue-500 text-white rounded-lg font-medium focus:ring-2 focus:ring-blue-300 focus:outline-none">
            <i class="fas fa-cloud-upload-alt mr-2"></i>í´ë¼ìš°ë“œ ë™ê¸°í™”
          </button>
          <button onclick="importDatFile()" class="w-full py-2 border border-purple-500 text-purple-600 rounded-lg text-sm hover:bg-purple-50">
            <i class="fas fa-file-import mr-1"></i>Genie RPA ë°ì´í„° (.dat) ê°€ì ¸ì˜¤ê¸°
          </button>
        </div>

        <!-- Advanced Options (Collapsible) -->
        <details class="pt-2">
          <summary class="cursor-pointer text-xs text-gray-400 hover:text-gray-600 py-2">
            <i class="fas fa-cog mr-1"></i>ê³ ê¸‰ ì˜µì…˜
          </summary>
          <div class="pt-2 space-y-2">
            <div class="grid grid-cols-2 gap-2">
              <button onclick="exportCurrentProfile()" class="py-2 border rounded-lg text-xs text-gray-500 hover:bg-gray-50">
                <i class="fas fa-download mr-1"></i>ë‚´ë³´ë‚´ê¸°
              </button>
              <button onclick="importProfile()" class="py-2 border rounded-lg text-xs text-gray-500 hover:bg-gray-50">
                <i class="fas fa-upload mr-1"></i>ê°€ì ¸ì˜¤ê¸°
              </button>
            </div>
            <button onclick="deleteCurrentProfile()" class="w-full py-2 border border-red-300 text-red-500 rounded-lg text-xs hover:bg-red-50">
              <i class="fas fa-trash mr-1"></i>í”„ë¡œí•„ ì‚­ì œ
            </button>
          </div>
        </details>
      </div>
    </div>
  </div>

  <!-- App Dialog (confirm/prompt replacement) -->
  <div id="app-dialog" class="fixed inset-0 bg-black/50 z-[60] hidden items-center justify-center px-4" role="dialog" aria-modal="true" aria-labelledby="app-dialog-title">
    <div class="w-full max-w-md bg-white rounded-xl shadow-xl p-4" onclick="event.stopPropagation()">
      <h3 id="app-dialog-title" class="text-base font-semibold text-gray-800"></h3>
      <p id="app-dialog-message" class="mt-2 text-sm text-gray-600 whitespace-pre-line"></p>
      <div id="app-dialog-input-wrap" class="mt-3 hidden">
        <input id="app-dialog-input" type="text" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" />
      </div>
      <div id="app-dialog-extra" class="mt-3 text-xs text-gray-500 space-y-1"></div>
      <div class="mt-4 flex justify-end gap-2">
        <button id="app-dialog-cancel" type="button" class="px-3 py-2 text-sm rounded-lg border border-gray-200 text-gray-600 hover:bg-gray-50">ì·¨ì†Œ</button>
        <button id="app-dialog-confirm" type="button" class="px-3 py-2 text-sm rounded-lg bg-blue-500 text-white hover:bg-blue-600">í™•ì¸</button>
      </div>
    </div>
  </div>

  <!-- Toast Notification Container -->
  <div id="toast-container" class="fixed bottom-4 left-4 right-4 z-50 flex flex-col gap-2 pointer-events-none"></div>

  <!-- Footer (v4.21.0: Hidden on mobile, shown on desktop only) -->
  <footer class="hidden lg:block px-4 py-4 text-center">
    <p class="text-xs text-gray-400">IB Helper v4.49.3 | Powered by <span class="font-semibold text-rose-500">FENOK</span></p>
  </footer>

  <!-- Scripts -->
  <script src="js/calculator.js"></script>
  <script src="js/profile-manager.js"></script>
  <script src="js/balance-manager.js"></script>
  <script src="js/sheets-sync.js"></script>
  <script>
    // =====================================================
    // State
    // =====================================================

    // ğŸ”´ v4.15.0: nullë¡œ ì´ˆê¸°í™” (Bug 7 ìˆ˜ì •)
    // 'SOXL' ì´ˆê¸°ê°’ â†’ ì²« ë¡œë“œ ì‹œ ë¹ˆ ë°ì´í„°ë¡œ ê¸°ì¡´ ë°ì´í„° ë®ì–´ì”Œì›€ ë°©ì§€
    let selectedTicker = null;
    let currentProfile = null;

    // ğŸ”´ v4.28.0: ë‹¤ì¤‘ ì¢…ëª© ê³„ì‚° (#217, #218)
    let enabledTickers = new Set();     // ê³„ì‚° ëŒ€ìƒ ì¢…ëª© (ì²´í¬ëœ ì¢…ëª©)
    let calculationResults = {};        // Map<ticker, result> - ë‹¤ì¤‘ ê³„ì‚° ê²°ê³¼

    // P4: CashReserve (SGOV/BIL/BILS)
    const CASH_ETFS = ['SGOV', 'BIL', 'BILS'];
    let cashReserveEntries = [];
    let cashReservePrices = {};
    let cashReserveAction = null;

    // =====================================================
    // Auto-Save to Sheets (v4.20.0)
    // =====================================================

    /**
     * Debounce utility - prevents rapid-fire API calls
     * @param {Function} fn - Function to debounce
     * @param {number} delay - Delay in ms
     */
    function debounce(fn, delay) {
      let timeoutId;
      return function(...args) {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => fn.apply(this, args), delay);
      };
    }

    /**
     * Auto-sync to Google Sheets (5ì´ˆ debounce)
     * - ë¡œê·¸ì¸ ìƒíƒœì¼ ë•Œë§Œ ì‹¤í–‰
     * - ì—°ì† ì…ë ¥ ì‹œ ë§ˆì§€ë§‰ ì…ë ¥ í›„ 5ì´ˆ ë’¤ ë™ê¸°í™”
     */
    const debouncedSheetSync = debounce(async function() {
      // Check if SheetsSync is available and authenticated
      if (typeof SheetsSync === 'undefined' || !SheetsSync.isAuthenticated()) {
        console.log('Auto-sync: Skipped (not logged in)');
        updateSyncStatus('local');
        return;
      }

      if (!currentProfile) {
        console.log('Auto-sync: Skipped (no profile)');
        return;
      }

      try {
        updateSyncStatus('syncing');

        // Set current profile for sync
        SheetsSync.setCurrentProfile(currentProfile.id);

        // Push to sheets
        await SheetsSync.push();

        // Visual feedback (subtle)
        const status = document.getElementById('sheets-status');
        if (status) {
          status.textContent = 'âœ“ ë™ê¸°í™”ë¨';
          status.className = 'text-xs text-green-600';
          setTimeout(() => {
            if (status.textContent === 'âœ“ ë™ê¸°í™”ë¨') {
              status.textContent = 'ì—°ê²°ë¨';
            }
          }, 2000);
        }

        updateSyncStatus('synced');
        console.log('Auto-sync: Success');
      } catch (error) {
        console.error('Auto-sync: Failed', error);
        updateSyncStatus('failed');
        // Silent failure - ì‚¬ìš©ì ì‘ì—… ë°©í•´ ì•ˆí•¨
      }
    }, 5000); // 5ì´ˆ debounce

    /**
     * Trigger auto-sync after local save
     * Called from saveCurrentInputs()
     */
    function triggerAutoSync() {
      if (!currentProfile) return;
      if (typeof SheetsSync !== 'undefined' && SheetsSync.isAuthenticated()) {
        updateSyncStatus('pending');
        debouncedSheetSync();
      } else {
        updateSyncStatus('local');
      }
    }

    // =====================================================
    // Toast Notification System
    // =====================================================

    function escapeHtml(value) {
      return String(value ?? '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function sanitizeProfileName(name) {
      return String(name ?? '').replace(/[\u0000-\u001F\u007F]/g, '').trim().slice(0, 40);
    }

    function sanitizeTickerSymbol(symbol) {
      return String(symbol ?? '').toUpperCase().trim().replace(/[^A-Z0-9._-]/g, '').slice(0, 16);
    }

    function showToast(message, type = 'info', duration = 3000) {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;

      const icon = type === 'success' ? 'fa-check-circle' :
                   type === 'error' ? 'fa-exclamation-circle' :
                   type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle';
      const iconEl = document.createElement('i');
      iconEl.className = `fas ${icon}`;
      const textEl = document.createElement('span');
      textEl.textContent = String(message ?? '');
      toast.appendChild(iconEl);
      toast.appendChild(textEl);
      container.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = 'toast-out 0.3s ease-out forwards';
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }

    function showAppDialog({
      title = 'í™•ì¸',
      message = '',
      confirmText = 'í™•ì¸',
      cancelText = 'ì·¨ì†Œ',
      showCancel = true,
      input = null,
      extraLines = []
    } = {}) {
      return new Promise((resolve) => {
        const modal = document.getElementById('app-dialog');
        const titleEl = document.getElementById('app-dialog-title');
        const msgEl = document.getElementById('app-dialog-message');
        const inputWrap = document.getElementById('app-dialog-input-wrap');
        const inputEl = document.getElementById('app-dialog-input');
        const extraEl = document.getElementById('app-dialog-extra');
        const cancelBtn = document.getElementById('app-dialog-cancel');
        const confirmBtn = document.getElementById('app-dialog-confirm');

        titleEl.textContent = title;
        msgEl.textContent = message;
        confirmBtn.textContent = confirmText;
        cancelBtn.textContent = cancelText;
        cancelBtn.classList.toggle('hidden', !showCancel);

        extraEl.textContent = '';
        (extraLines || []).forEach((line) => {
          const p = document.createElement('p');
          p.textContent = String(line ?? '');
          extraEl.appendChild(p);
        });

        if (input) {
          inputWrap.classList.remove('hidden');
          inputEl.value = input.value || '';
          inputEl.placeholder = input.placeholder || '';
        } else {
          inputWrap.classList.add('hidden');
          inputEl.value = '';
          inputEl.placeholder = '';
        }

        function close(result) {
          modal.classList.add('hidden');
          modal.classList.remove('flex');
          modal.onclick = null;
          cancelBtn.onclick = null;
          confirmBtn.onclick = null;
          resolve(result);
        }

        modal.onclick = (e) => {
          if (e.target.id === 'app-dialog') {
            close({ confirmed: false, value: null });
          }
        };
        cancelBtn.onclick = () => close({ confirmed: false, value: null });
        confirmBtn.onclick = () => {
          const value = input ? inputEl.value : null;
          close({ confirmed: true, value });
        };

        modal.classList.remove('hidden');
        modal.classList.add('flex');
        if (input) {
          setTimeout(() => inputEl.focus(), 0);
        } else {
          setTimeout(() => confirmBtn.focus(), 0);
        }
      });
    }

    // =====================================================
    // Clipboard Helper (C-08: HTTPS fallback)
    // =====================================================

    /**
     * ğŸ”´ v4.29.4 (C-08): í´ë¦½ë³´ë“œ ë³µì‚¬ í—¬í¼ (HTTPS fallback)
     * navigator.clipboard APIëŠ” HTTPS ë˜ëŠ” localhostì—ì„œë§Œ ì‘ë™
     * HTTP í™˜ê²½ì—ì„œëŠ” execCommand fallback ì‚¬ìš©
     * @param {string} text - ë³µì‚¬í•  í…ìŠ¤íŠ¸
     * @returns {Promise<boolean>} ì„±ê³µ ì—¬ë¶€
     */
    async function copyToClipboard(text) {
      // 1. ë¨¼ì € Clipboard API ì‹œë„ (HTTPS/localhost)
      if (navigator.clipboard && window.isSecureContext) {
        try {
          await navigator.clipboard.writeText(text);
          return true;
        } catch (err) {
          console.warn('Clipboard API failed, trying fallback:', err);
        }
      }

      // 2. Fallback: execCommand (HTTP í™˜ê²½)
      try {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.left = '-9999px';
        textarea.style.top = '-9999px';
        document.body.appendChild(textarea);
        textarea.focus();
        textarea.select();

        const success = document.execCommand('copy');
        document.body.removeChild(textarea);

        if (!success) {
          throw new Error('execCommand copy failed');
        }
        return true;
      } catch (err) {
        console.error('Clipboard fallback failed:', err);
        return false;
      }
    }

    // =====================================================
    // Modal Helpers
    // =====================================================

    function handleModalBackdrop(event) {
      // Close modal when clicking backdrop
      if (event.target.id === 'profile-modal') {
        closeProfileModal();
      }
    }

    // =====================================================
    // Profile Delete
    // =====================================================

    async function deleteCurrentProfile() {
      if (!currentProfile) return;

      const profiles = ProfileManager.getAllProfiles();
      if (profiles.length <= 1) {
        showToast('ë§ˆì§€ë§‰ í”„ë¡œí•„ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'warning');
        return;
      }

      const { confirmed } = await showAppDialog({
        title: 'í”„ë¡œí•„ ì‚­ì œ',
        message: `"${currentProfile.name}" í”„ë¡œí•„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`,
        confirmText: 'ì‚­ì œ',
        cancelText: 'ì·¨ì†Œ',
        showCancel: true
      });
      if (!confirmed) return;

      // Save ID to delete
      const profileToDelete = currentProfile.id;

      // ğŸ”´ v4.15.0: selectedTicker ì´ˆê¸°í™” (Bug 6 ìˆ˜ì •)
      selectedTicker = null;

      // First switch to another profile (ProfileManager.delete requires non-active profile)
      const remaining = profiles.filter(p => p.id !== profileToDelete);
      if (remaining.length > 0) {
        ProfileManager.setActive(remaining[0].id);
        currentProfile = ProfileManager.getActive();
        SheetsSync.setCurrentProfile(remaining[0].id);
      }

      // Now delete the profile
      ProfileManager.delete(profileToDelete);

      // Update UI
      updateProfileSelector();
      loadProfileData();
      loadBalanceData();
      closeProfileModal();

      showToast('í”„ë¡œí•„ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    }

    // =====================================================
    // Initialization
    // =====================================================

    document.addEventListener('DOMContentLoaded', () => {
      // ğŸ”´ v4.29.0: ë¡œê·¸ì¸ ê¸°ë°˜ ì´ˆê¸°í™” (ë…¼ë¦¬ì  íë¦„ ê°œì„ )
      // - ì•± ì‹œì‘ ì‹œ í•­ìƒ ë¹ˆ ìƒíƒœ (ë¡œê·¸ì¸ í™”ë©´)
      // - ë¡œì»¬ ë°ì´í„°ëŠ” ë¡œê·¸ì¸ í›„ì—ë§Œ ë¡œë“œ
      // - ì‚¬ìš©ì í˜¼ë€ ë°©ì§€: "ë¡œê·¸ì¸ ì „ì— ë°ì´í„°ê°€ ìˆëŠ” ì´ìœ ?"

      // Show today's date
      const today = new Date();
      document.getElementById('today-date').textContent = today.toLocaleDateString('ko-KR', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      });

      // ğŸ”´ v4.29.0: ì‹œì‘ ì‹œ í•­ìƒ ë¹ˆ ìƒíƒœ í‘œì‹œ (ë¡œê·¸ì¸/ì‹œì‘ ë²„íŠ¼)
      // ê¸°ì¡´ ë¡œì»¬ ë°ì´í„°ê°€ ìˆì–´ë„ ìˆ¨ê¹€ - ì‚¬ìš©ìê°€ ëª…ì‹œì ìœ¼ë¡œ ì‹œì‘í•´ì•¼ í•¨
      showStartScreen();

      // Balance input debounce setup
      // ğŸ”´ v4.29.6 (#33): debounce 500ms â†’ 200ms (UX ê°œì„ )
      const balanceInput = document.getElementById('input-balance');
      if (balanceInput) {
        balanceInput.addEventListener('input', () => {
          clearTimeout(window.balanceDebounce);
          window.balanceDebounce = setTimeout(() => {
            handleBalanceChange(balanceInput.value);
          }, 200);
        });
      }

      const commissionInput = document.getElementById('input-commission');
      if (commissionInput) {
        commissionInput.addEventListener('input', () => {
          clearTimeout(window.commissionDebounce);
          window.commissionDebounce = setTimeout(() => {
            handleCommissionChange(commissionInput.value);
          }, 200);
        });
      }
    });

    /**
     * ğŸ”´ v4.29.0: ì‹œì‘ í™”ë©´ í‘œì‹œ (ë¡œê·¸ì¸ ì „ ìƒíƒœ)
     * - í•­ìƒ ë¹ˆ ìƒíƒœë¡œ ì‹œì‘
     * - Google ë¡œê·¸ì¸ ë˜ëŠ” ì˜¤í”„ë¼ì¸ ì‹œì‘ ì„ íƒ
     */
    function showStartScreen() {
      const emptyState = document.getElementById('empty-state');
      const mainContent = document.getElementById('main-content');

      // ë©”ì¸ ì½˜í…ì¸  ìˆ¨ê¹€
      emptyState.classList.remove('hidden');
      mainContent.style.display = 'none';

      // í”„ë¡œí•„ ì´ˆê¸°í™” (UIë§Œ - ë°ì´í„°ëŠ” ë¡œê·¸ì¸ í›„ ë¡œë“œ)
      ProfileManager.init();

      // ëª¨ë‹¬/ì˜¤ë²„ë ˆì´ ì •ë¦¬
      document.getElementById('profile-modal')?.classList.add('hidden');
      document.getElementById('add-stock-form')?.classList.add('hidden');
      closeResultsOverlay();
    }

    /**
     * ğŸ”´ v4.29.0: ì•± ì´ˆê¸°í™” (ë¡œê·¸ì¸ ë˜ëŠ” ì˜¤í”„ë¼ì¸ ì‹œì‘ í›„ í˜¸ì¶œ)
     */
    function initializeApp() {
      currentProfile = ProfileManager.getActive();

      // Set current profile for SheetsSync
      if (currentProfile) {
        SheetsSync.setCurrentProfile(currentProfile.id);
      }

      // Load UI
      updateProfileSelector();
      loadProfileData();
      loadBalanceData();
    }

    // =====================================================
    // Profile Management
    // =====================================================

    function updateProfileSelector() {
      const selector = document.getElementById('profile-selector');
      const profiles = ProfileManager.getAllProfiles();
      const activeId = ProfileManager.getActiveId();
      const emptyState = document.getElementById('empty-state');
      const mainContent = document.getElementById('main-content');

      if (profiles.length === 0) {
        // No profiles - show empty state
        selector.innerHTML = '';
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'â• í”„ë¡œí•„ì„ ì¶”ê°€í•˜ì„¸ìš”';
        selector.appendChild(option);
        emptyState.classList.remove('hidden');
        mainContent.style.display = 'none';  // inline style override
      } else {
        // Has profiles - show main content
        emptyState.classList.add('hidden');
        mainContent.style.display = '';  // restore default (lg:flex takes over)
        selector.innerHTML = '';
        profiles.forEach((p) => {
          const option = document.createElement('option');
          option.value = p.id;
          option.selected = p.id === activeId;
          option.textContent = `ğŸ‘¤ ${p.name}`;
          selector.appendChild(option);
        });
      }
    }

    function switchProfile(profileId) {
      // ğŸ”´ v4.14.0: í”„ë¡œí•„ ì „í™˜ ì „ í˜„ì¬ ì…ë ¥ê°’ ì €ì¥ (ë²„ê·¸ ìˆ˜ì •)
      if (currentProfile && selectedTicker) {
        saveCurrentInputs(true);  // silent=true: í† ìŠ¤íŠ¸ ìŠ¤íŒ¸ ë°©ì§€
      }

      // ğŸ”´ v4.15.0: selectedTicker ì´ˆê¸°í™” (Bug 6 ìˆ˜ì •)
      // ì´ì „ ì¢…ëª© ë°ì´í„°ê°€ ìƒˆ í”„ë¡œí•„ì— ì €ì¥ë˜ëŠ” ê²ƒ ë°©ì§€
      selectedTicker = null;

      // ğŸ”´ v4.30.0 (B5-04): í”„ë¡œí•„ ì „í™˜ ì‹œ ì…ë ¥ í•„ë“œ ëª…ì‹œì  ì´ˆê¸°í™”
      document.getElementById('input-principal').value = '';
      document.getElementById('input-avgPrice').value = '';
      document.getElementById('input-totalInvested').value = '';
      document.getElementById('input-holdings').value = '';
      document.getElementById('input-sellPercent').value = '10';
      document.getElementById('input-locSellPercent').value = '5';
      // ğŸ”´ v4.30.0 (B5-14): ì˜ˆìˆ˜ê¸ˆë„ ì´ˆê¸°í™” (í”„ë¡œí•„ ê°„ ëˆ„ìˆ˜ ë°©ì§€)
      document.getElementById('input-balance').value = '';
      document.getElementById('input-commission').value = '';

      ProfileManager.setActive(profileId);
      currentProfile = ProfileManager.getActive();

      // Update SheetsSync to use this profile's Sheet
      SheetsSync.setCurrentProfile(profileId);

      loadProfileData();
      loadBalanceData();
      document.getElementById('results-section').classList.add('hidden');
      // í”„ë¡œí•„ ë³€ê²½ ì‹œ ì´ì „ ê³„ì‚° ìƒíƒœ/ê²°ê³¼ ì œê±°
      calculationResults = {};
      lastCalculation = null;
      const multiResults = document.getElementById('multi-results-section');
      const accordion = document.getElementById('results-accordion');
      if (multiResults) multiResults.classList.add('hidden');
      if (accordion) accordion.innerHTML = '';
      if (typeof closeResultsOverlay === 'function') {
        closeResultsOverlay();
      }

      // ğŸ”´ v4.29.6 (#32): í”„ë¡œí•„ ì „í™˜ ì‹œ ì˜ˆìˆ˜ê¸ˆ ìƒíƒœ í‘œì‹œ (balance > 0ì´ë©´)
      // ê¸°ì¡´: í•­ìƒ ìˆ¨ê¹€ â†’ ê°œì„ : balanceê°€ ìˆìœ¼ë©´ ìƒíƒœ í‘œì‹œ
      recalculateBalance();
    }

    function loadProfileData() {
      currentProfile = ProfileManager.getActive();
      if (!currentProfile) return;

      // Update ticker buttons based on profile stocks
      updateTickerButtons();

      // Select first stock (ğŸ”´ v4.16.0: í”„ë¡œí•„ì— ì¢…ëª©ì´ ì—†ìœ¼ë©´ ì„ íƒí•˜ì§€ ì•ŠìŒ - Bug 11 ìˆ˜ì •)
      const firstStock = currentProfile.stocks[0];
      if (firstStock) {
        selectTicker(firstStock.symbol);
      }
      // else: selectedTicker = null ìœ ì§€ (ê¸°ë³¸ ì¢…ëª© ìë™ ì €ì¥ ë°©ì§€)

      // P4: CashReserve ë¡œë“œ (ìˆìœ¼ë©´ í‘œì‹œ)
      loadCashReserveData();
    }

    function updateTickerButtons() {
      const container = document.getElementById('ticker-buttons');
      if (!container) return;

      // Get profile stocks or use defaults (TQQQ, SOXL only - no BITU)
      const stocks = currentProfile?.stocks?.length > 0
        ? currentProfile.stocks
        : [{ symbol: 'TQQQ' }, { symbol: 'SOXL' }];

      // ğŸ”´ v4.28.0: í”„ë¡œí•„ ë³€ê²½ ì‹œ enabledTickers ë¦¬ì…‹
      enabledTickers.clear();

      container.innerHTML = stocks.map(s => {
        const symbol = sanitizeTickerSymbol(s.symbol);
        if (!symbol) return '';
        // ğŸ”´ v4.28.1: í•„ìˆ˜ê°’ ì²´í¬ - AND ì¡°ê±´ìœ¼ë¡œ ë³€ê²½ (ê³„ì‚° ë¡œì§ê³¼ ì¼ì¹˜)
        // ğŸ”´ #236 (DEC-175): avgPriceë¥¼ íŒŒìƒê°’ìœ¼ë¡œ ê³„ì‚°
        const dailyData = ProfileManager.loadDailyData(currentProfile?.id, symbol) || {};
        const avgPrice = computeAvgPrice(dailyData.totalInvested || 0, dailyData.holdings || 0);
        const principal = s.principal || 0;
        const hasRequired = (avgPrice > 0 && principal > 0);
        const isDisabled = !hasRequired;
        const isEnabled = ProfileManager.isStockEnabled(symbol);
        const isChecked = isEnabled && !isDisabled;

        if (isChecked) {
          enabledTickers.add(symbol);
        }

        return `
          <div class="ticker-item flex items-center gap-2">
            <input type="checkbox"
                   id="ticker-check-${symbol}"
                   class="ticker-checkbox w-5 h-5 accent-blue-500"
                   ${isChecked ? 'checked' : ''}
                   ${isDisabled ? 'disabled' : ''}
                   onchange="toggleTicker('${symbol}', this.checked)"
                   title="${isDisabled ? 'í‰ë‹¨ê°€ ë˜ëŠ” ì„¸íŒ…ì›ê¸ˆ ì…ë ¥ í•„ìš”' : 'ê³„ì‚° ëŒ€ìƒ'}">
            <button onclick="selectTicker('${symbol}')"
                    class="ticker-btn flex-1 touch-target py-3 rounded-lg text-center font-semibold transition-all bg-gray-100 text-gray-600 hover:bg-blue-100 ${isDisabled ? 'opacity-50' : ''}"
                    data-ticker="${symbol}">
              ${escapeHtml(symbol)}
            </button>
          </div>
        `;
      }).join('');
    }

    /**
     * ğŸ”´ v4.28.0: ì¢…ëª© ì²´í¬ë°•ìŠ¤ í† ê¸€ (#218)
     */
    function toggleTicker(symbol, checked) {
      ProfileManager.setStockEnabled(symbol, checked);
      currentProfile = ProfileManager.getActive();
      if (checked) {
        enabledTickers.add(symbol);
      } else {
        enabledTickers.delete(symbol);
      }
      console.log('enabledTickers:', [...enabledTickers]);
    }

    // =====================================================
    // Profile Modal
    // =====================================================

    function getNormalizedAdditionalBuySettings(profile) {
      const additionalBuy = profile?.settings?.additionalBuy || {};
      const mode = additionalBuy.mode === 'fixed' ? 'fixed' : 'budget_ratio';
      const parsedOrderCount = parseInt(additionalBuy.orderCount, 10);
      const parsedBudgetRatio = parseFloat(additionalBuy.budgetRatio);
      // v4.49.2: ê¸°ì¡´ 25% â†’ 20% ë§ˆì´ê·¸ë ˆì´ì…˜ (DEC-184)
      const migratedRatio = (parsedBudgetRatio === 25) ? 20 : parsedBudgetRatio;
      const parsedMaxDecline = parseFloat(additionalBuy.maxDecline);
      const parsedQuantity = parseInt(additionalBuy.quantity, 10);
      return {
        enabled: additionalBuy.enabled !== false,
        mode: mode,
        budgetRatio: Number.isFinite(migratedRatio) ? Math.max(0, Math.min(100, migratedRatio)) : 20,
        allowOneOver: additionalBuy.allowOneOver !== false,
        orderCount: Number.isFinite(parsedOrderCount) ? Math.max(0, Math.min(8, parsedOrderCount)) : 8,
        maxDecline: Number.isFinite(parsedMaxDecline) ? parsedMaxDecline : 15,
        quantity: Number.isFinite(parsedQuantity) && parsedQuantity > 0 ? parsedQuantity : 1
      };
    }

    function applyAdditionalBuySettingsToModal(settings) {
      const enabledInput = document.getElementById('modal-additional-enabled');
      const modeInput = document.getElementById('modal-additional-mode');
      const budgetRatioInput = document.getElementById('modal-additional-budget-ratio');
      const allowOverInput = document.getElementById('modal-additional-allow-over');
      const orderCountInput = document.getElementById('modal-additional-order-count');
      if (!enabledInput || !modeInput || !budgetRatioInput || !allowOverInput || !orderCountInput) return;
      enabledInput.checked = settings.enabled;
      modeInput.value = settings.mode;
      budgetRatioInput.value = settings.budgetRatio;
      allowOverInput.checked = settings.allowOneOver;
      orderCountInput.value = settings.orderCount;

      const disabledAll = !settings.enabled;
      modeInput.disabled = disabledAll;
      modeInput.classList.toggle('opacity-50', disabledAll);

      const useBudgetMode = settings.mode === 'budget_ratio';
      budgetRatioInput.disabled = disabledAll || !useBudgetMode;
      budgetRatioInput.classList.toggle('opacity-50', disabledAll || !useBudgetMode);
      allowOverInput.disabled = disabledAll || !useBudgetMode;

      orderCountInput.disabled = disabledAll || useBudgetMode;
      orderCountInput.classList.toggle('opacity-50', disabledAll || useBudgetMode);
    }

    function loadAdditionalBuySettings() {
      const profile = ProfileManager.getActive();
      const settings = getNormalizedAdditionalBuySettings(profile);
      applyAdditionalBuySettingsToModal(settings);
    }

    function saveAdditionalBuySettings() {
      if (!currentProfile) return;
      const enabledInput = document.getElementById('modal-additional-enabled');
      const modeInput = document.getElementById('modal-additional-mode');
      const budgetRatioInput = document.getElementById('modal-additional-budget-ratio');
      const allowOverInput = document.getElementById('modal-additional-allow-over');
      const orderCountInput = document.getElementById('modal-additional-order-count');
      if (!enabledInput || !modeInput || !budgetRatioInput || !allowOverInput || !orderCountInput) return;

      const mode = modeInput.value === 'fixed' ? 'fixed' : 'budget_ratio';
      const parsedBudgetRatio = parseFloat(budgetRatioInput.value);
      const budgetRatio = Number.isFinite(parsedBudgetRatio) ? Math.max(0, Math.min(100, parsedBudgetRatio)) : 20;
      budgetRatioInput.value = budgetRatio;
      const parsedOrderCount = parseInt(orderCountInput.value, 10);
      const orderCount = Number.isFinite(parsedOrderCount) ? Math.max(0, Math.min(8, parsedOrderCount)) : 8;
      orderCountInput.value = orderCount;

      const currentSettings = getNormalizedAdditionalBuySettings(currentProfile);
      const nextAdditionalBuy = {
        ...currentSettings,
        enabled: enabledInput.checked,
        mode: mode,
        budgetRatio: budgetRatio,
        allowOneOver: allowOverInput.checked,
        orderCount
      };

      ProfileManager.update(currentProfile.id, {
        settings: {
          additionalBuy: nextAdditionalBuy
        }
      });
      currentProfile = ProfileManager.getActive();
      applyAdditionalBuySettingsToModal(nextAdditionalBuy);
      showToast('í•˜ë½ëŒ€ë¹„ ì„¤ì • ì €ì¥ë¨', 'success', 1000);
      triggerAutoSync();
    }

    function showProfileSettings() {
      const modal = document.getElementById('profile-modal');
      modal.classList.remove('hidden');

      // Load current profile data
      currentProfile = ProfileManager.getActive();
      document.getElementById('modal-profile-name').value = currentProfile?.name || '';

      // ğŸ”´ v4.31.0 (B5-02): ëª¨ë‹¬ í”„ë¡œí•„ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
      updateModalProfileSelector();

      // Load stocks list
      updateModalStocksList();
      loadAdditionalBuySettings();
    }

    /**
     * ğŸ”´ v4.31.0 (B5-02): ëª¨ë‹¬ ë‚´ í”„ë¡œí•„ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
     */
    function updateModalProfileSelector() {
      const selector = document.getElementById('modal-profile-selector');
      if (!selector) return;

      const profiles = ProfileManager.getAllProfiles();
      const activeId = ProfileManager.getActiveId();

      selector.innerHTML = '';
      profiles.forEach((p) => {
        const option = document.createElement('option');
        option.value = p.id;
        option.selected = p.id === activeId;
        option.textContent = `${p.name}${p.id === activeId ? ' âœ“' : ''}`;
        selector.appendChild(option);
      });
    }

    /**
     * ğŸ”´ v4.31.0 (B5-02): ëª¨ë‹¬ ë‚´ì—ì„œ í”„ë¡œí•„ ì „í™˜
     */
    function switchProfileFromModal(profileId) {
      if (!profileId || profileId === currentProfile?.id) return;

      switchProfile(profileId);

      // Update modal content
      document.getElementById('modal-profile-name').value = currentProfile?.name || '';
      updateModalStocksList();
      updateModalProfileSelector();
      loadAdditionalBuySettings();

      showToast(`í”„ë¡œí•„ '${currentProfile?.name}' ë¡œ ì „í™˜ë¨`, 'success', 1500);
    }

    /**
     * ğŸ”´ v4.31.0 (B5-06): ë©”ì¸ì—ì„œ ë¹ ë¥¸ ë™ê¸°í™”
     */
    async function quickSyncToCloud() {
      if (!SheetsSync.isAuthenticated()) {
        showToast('ë¨¼ì € Google ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤', 'warning');
        return;
      }

      // ë™ê¸°í™” ë²„íŠ¼ ë¹„í™œì„±í™” (ì¤‘ë³µ í´ë¦­ ë°©ì§€)
      const btn = document.getElementById('header-sync-btn');
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
      }

      try {
        await syncToCloud();
      } catch (e) {
        console.error('quickSyncToCloud error:', e);
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i>';
        }
      }
    }

    /**
     * ğŸ”´ v4.31.0 (B5-10): ë™ê¸°í™” ìƒíƒœ ì—…ë°ì´íŠ¸
     * @param {'saving'|'local'|'pending'|'syncing'|'synced'|'failed'} status
     */
    function updateSyncStatus(status) {
      const statusEl = document.getElementById('header-sync-status');
      if (!statusEl) return;

      statusEl.classList.remove('hidden');

      const statusConfig = {
        saving: { icon: 'spinner', color: 'bg-gray-100 text-gray-500', text: 'ì €ì¥ ì¤‘...' },
        local: { icon: 'check-circle', color: 'bg-gray-200 text-gray-600', text: 'ë¡œì»¬ ì €ì¥ë¨' },
        pending: { icon: 'clock', color: 'bg-yellow-100 text-yellow-700', text: 'í´ë¼ìš°ë“œ ë™ê¸°í™” ëŒ€ê¸°' },
        syncing: { icon: 'sync-alt', color: 'bg-blue-100 text-blue-700', text: 'í´ë¼ìš°ë“œ ë™ê¸°í™” ì¤‘...' },
        synced: { icon: 'check-circle', color: 'bg-green-100 text-green-600', text: 'í´ë¼ìš°ë“œ ë™ê¸°í™” ì™„ë£Œ' },
        failed: { icon: 'exclamation-circle', color: 'bg-red-100 text-red-600', text: 'ë™ê¸°í™” ì‹¤íŒ¨' }
      };

      const cfg = statusConfig[status] || statusConfig.local;
      statusEl.className = `text-xs px-2 py-0.5 rounded-full ${cfg.color}`;
      statusEl.innerHTML = `<i class="fas fa-${cfg.icon} text-[8px] mr-1"></i><span>${cfg.text}</span>`;
    }

    /**
     * ğŸ”´ v4.30.0 (B5-01): í”„ë¡œí•„ ì´ë¦„ ë³€ê²½ ì¦‰ì‹œ ì €ì¥
     */
    function saveProfileName() {
      if (!currentProfile) return;

      const newName = sanitizeProfileName(document.getElementById('modal-profile-name').value);
      if (!newName) return;

      ProfileManager.update(currentProfile.id, { name: newName });
      currentProfile = ProfileManager.getActive();

      // Update UI
      updateProfileSelector();
      showToast('í”„ë¡œí•„ ì´ë¦„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success', 1000);

      // Sync to cloud
      triggerAutoSync();
    }

    function closeProfileModal() {
      document.getElementById('profile-modal').classList.add('hidden');
      document.getElementById('add-stock-form').classList.add('hidden');
    }

    function updateModalStocksList() {
      const container = document.getElementById('modal-stocks-list');
      const stocks = currentProfile?.stocks || [];

      if (stocks.length === 0) {
        container.innerHTML = '<p class="text-sm text-gray-400 text-center py-2">ë“±ë¡ëœ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤</p>';
        return;
      }

      container.innerHTML = stocks.map(s => `
        <div class="flex items-center justify-between bg-gray-50 rounded-lg px-3 py-2">
          <div>
            <span class="font-medium">${escapeHtml(sanitizeTickerSymbol(s.symbol))}</span>
            <span class="text-xs text-gray-500 ml-2">$${(s.principal || 0).toLocaleString()}</span>
          </div>
          <button onclick="removeStockFromProfile('${sanitizeTickerSymbol(s.symbol)}')" class="text-red-400 hover:text-red-600">
            <i class="fas fa-trash-alt"></i>
          </button>
        </div>
      `).join('');
    }

    function showAddStockForm() {
      document.getElementById('add-stock-form').classList.remove('hidden');
    }

    function hideAddStockForm() {
      document.getElementById('add-stock-form').classList.add('hidden');
      document.getElementById('new-stock-symbol').value = '';
      document.getElementById('new-stock-principal').value = '';
    }

    function addNewStock() {
      // ğŸ”´ v4.29.0: null guard ì¶”ê°€
      if (!currentProfile) {
        showToast('í”„ë¡œí•„ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”', 'warning');
        return;
      }

      const symbol = sanitizeTickerSymbol(document.getElementById('new-stock-symbol').value);
      const principal = parseFloat(document.getElementById('new-stock-principal').value) || 0;

      if (!symbol) {
        showToast('ì¢…ëª©ì½”ë“œë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš” (A-Z,0-9,.,_,-)', 'warning');
        return;
      }

      // ğŸ”´ v4.29.6: ë¼ì˜¤ì–´ ê°€ì´ë“œ ê¸°ì¤€ ê¸°ë³¸ê°’ (#29)
      // - TQQQ: 10%, 5%  / SOXL: 12%, 5%  / ê¸°íƒ€: 10%, 5%
      const sellPercent = symbol === 'SOXL' ? 12 : 10;
      const locSellPercent = 5;
      ProfileManager.addStock(currentProfile.id, { symbol, principal, sellPercent, locSellPercent });
      currentProfile = ProfileManager.getActive();

      hideAddStockForm();
      updateModalStocksList();

      // ğŸ”´ v4.29.5: ë©”ì¸ í™”ë©´ í‹°ì»¤ ë²„íŠ¼ ì—…ë°ì´íŠ¸
      updateTickerButtons();
      showToast(`${symbol} ì¢…ëª© ì¶”ê°€ë¨`, 'success');

      // ğŸ”´ v4.29.5: ì‹œíŠ¸ ë™ê¸°í™” íŠ¸ë¦¬ê±°
      triggerAutoSync();
    }

    async function removeStockFromProfile(symbol) {
      // ğŸ”´ v4.29.0: null guard ì¶”ê°€
      if (!currentProfile) {
        showToast('í”„ë¡œí•„ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”', 'warning');
        return;
      }

      const safeSymbol = sanitizeTickerSymbol(symbol);
      const { confirmed } = await showAppDialog({
        title: 'ì¢…ëª© ì‚­ì œ',
        message: `${safeSymbol} ì¢…ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`,
        confirmText: 'ì‚­ì œ',
        cancelText: 'ì·¨ì†Œ',
        showCancel: true
      });

      if (confirmed) {
        ProfileManager.removeStock(currentProfile.id, safeSymbol);
        currentProfile = ProfileManager.getActive();
        updateModalStocksList();

        // ğŸ”´ v4.29.5: ë©”ì¸ í™”ë©´ í‹°ì»¤ ë²„íŠ¼ ì—…ë°ì´íŠ¸
        updateTickerButtons();

        // ì‚­ì œëœ ì¢…ëª©ì´ í˜„ì¬ ì„ íƒëœ ì¢…ëª©ì´ë©´ ì²« ë²ˆì§¸ ì¢…ëª© ì„ íƒ
        if (selectedTicker === safeSymbol) {
          const firstStock = currentProfile.stocks[0];
          if (firstStock) {
            selectTicker(firstStock.symbol);
          } else {
            selectedTicker = null;
          }
        }

        showToast(`${safeSymbol} ì¢…ëª© ì‚­ì œë¨`, 'success');
        triggerAutoSync();
      }
    }

    /**
     * ğŸ”´ í´ë¼ìš°ë“œ ë™ê¸°í™” (v4.12.0)
     * - ë¡œì»¬ ì €ì¥ì€ onchangeì—ì„œ ìë™ ì²˜ë¦¬ë¨
     * - ì´ ë²„íŠ¼ì€ í´ë¼ìš°ë“œ(Google Sheets) ë™ê¸°í™”ë§Œ ë‹´ë‹¹
     * ğŸ”´ v4.29.0: null guard ì¶”ê°€
     */
    async function syncToCloud() {
      // ğŸ”´ v4.29.0: null guard
      if (!currentProfile) {
        showToast('í”„ë¡œí•„ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”', 'warning');
        return;
      }

      // 1. í˜„ì¬ ì…ë ¥ê°’ ìµœì¢… ì €ì¥ (í˜¹ì‹œ ëª¨ë¥¼ ë¯¸ì €ì¥ ë°ì´í„°)
      saveCurrentInputs();

      // ğŸ”´ v4.30.0 (#3): ë™ê¸°í™” ì „ í•„ìˆ˜ê°’ ì²´í¬
      const stocks = currentProfile?.stocks || [];
      const hasValidStock = stocks.some(s => s.principal > 0);
      if (!hasValidStock) {
        showToast('âš ï¸ ì„¸íŒ…ì›ê¸ˆì´ ì…ë ¥ëœ ì¢…ëª©ì´ ì—†ì–´ ë™ê¸°í™”ë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤', 'warning', 3000);
        updateSyncStatus('pending');
        return;
      }

      // 2. í”„ë¡œí•„ ì´ë¦„ ì—…ë°ì´íŠ¸
      const name = document.getElementById('modal-profile-name').value.trim();
      if (name) {
        ProfileManager.update(currentProfile.id, { name });
        currentProfile = ProfileManager.getActive();
      }

      // 3. Google Sheets ë™ê¸°í™”
      if (!SheetsSync.isAuthenticated()) {
        showToast('Google ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤', 'warning');
        // ë¡œê·¸ì¸ ì‹œë„
        try {
          await initSheets();
          if (!SheetsSync.isAuthenticated()) {
            return;
          }
        } catch (e) {
          return;
        }
      }

      try {
        showToast('ì‹œíŠ¸ ë™ê¸°í™” ì¤‘...', 'info', 2000);
        updateSyncStatus('syncing');
        await SheetsSync.push();
        showToast('í´ë¼ìš°ë“œ ë™ê¸°í™” ì™„ë£Œ!', 'success');
        // ğŸ”´ v4.31.0 (B5-10): ë™ê¸°í™” ìƒíƒœ ì—…ë°ì´íŠ¸
        updateSyncStatus('synced');
      } catch (error) {
        console.error('Sync error:', error);
        showToast('ë™ê¸°í™” ì‹¤íŒ¨: ' + error.message, 'error');
        updateSyncStatus('failed');
      }

      updateProfileSelector();
      closeProfileModal();
    }

    /**
     * í”„ë¡œí•„ ì„¤ì • ì €ì¥ (ì´ë¦„ë§Œ - ë ˆê±°ì‹œ í˜¸í™˜)
     */
    async function saveProfileSettings() {
      const name = document.getElementById('modal-profile-name').value.trim();
      if (!name) {
        showToast('í”„ë¡œí•„ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”', 'warning');
        return;
      }
      ProfileManager.update(currentProfile.id, { name });
      currentProfile = ProfileManager.getActive();
      showToast('í”„ë¡œí•„ ì´ë¦„ ì €ì¥ë¨', 'success');
      updateProfileSelector();
    }

    /**
     * Quick Start - Google ë¡œê·¸ì¸ â†’ ì‹œíŠ¸ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
     */
    /**
     * ğŸ”´ v4.29.0: Google ë¡œê·¸ì¸ìœ¼ë¡œ ì‹œì‘
     * - ì‹œíŠ¸ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
     * - ì‹œíŠ¸ = SSOT (Single Source of Truth)
     */
    async function quickStart() {
      try {
        // 1. Google ë¡œê·¸ì¸
        showToast('Google ë¡œê·¸ì¸ ì¤‘...', 'info');
        await initSheets();

        const userEmail = SheetsSync.getUserEmail();
        if (!userEmail) {
          showToast('ë¡œê·¸ì¸ ì‹¤íŒ¨', 'error');
          return;
        }

        showToast(`${userEmail} ë¡œê·¸ì¸ ì™„ë£Œ`, 'success');

        // ğŸ”´ #242: ì²´í¬ë°•ìŠ¤ enabled ìƒíƒœ ë³´ì¡´ (resetToDefaultsë¡œ í”„ë¡œí•„ ì‚­ì œ ì „)
        const savedEnabledStates = _collectEnabledStates();

        // ğŸ”´ v4.29.0: ê¸°ì¡´ ë¡œì»¬ ë°ì´í„° í´ë¦¬ì–´ (ë‹¤ë¥¸ ê³„ì • ë°ì´í„° ì¶©ëŒ ë°©ì§€)
        ProfileManager.resetToDefaults();
        selectedTicker = null;

        // 2. ì‹œíŠ¸ì—ì„œ í”„ë¡œí•„ ê°€ì ¸ì˜¤ê¸° (í•µì‹¬ ë³€ê²½)
        const sheetProfiles = await SheetsSync.getMyProfilesFromSheet();

        if (sheetProfiles.length === 0) {
          // ì‹œíŠ¸ì— ë°ì´í„° ì—†ìŒ â†’ ìƒˆ í”„ë¡œí•„ ìƒì„±
          showToast('ìƒˆ ì‚¬ìš©ì - í”„ë¡œí•„ì„ ìƒì„±í•©ë‹ˆë‹¤', 'info');
          const profileName = userEmail.split('@')[0];
          const profileId = ProfileManager.create(profileName, '');
          ProfileManager.setActive(profileId);
          currentProfile = ProfileManager.getActive();
          SheetsSync.setCurrentProfile(profileId);
        } else {
          // ì‹œíŠ¸ì—ì„œ í”„ë¡œí•„ ë¡œë“œ
          await pullAllProfiles(sheetProfiles, savedEnabledStates);
          showToast(`${sheetProfiles.length}ê°œ í”„ë¡œí•„ ë¶ˆëŸ¬ì˜´`, 'success');
        }

        // 3. UI ì—…ë°ì´íŠ¸ (initializeApp í˜¸ì¶œ)
        initializeApp();

        // 4. Sheets ìƒíƒœ í‘œì‹œ
        const userEl = document.getElementById('sheets-user');
        const statusEl = document.getElementById('sheets-status');
        if (userEl) {
          userEl.textContent = userEmail;
          userEl.classList.remove('hidden');
        }
        if (statusEl) {
          statusEl.textContent = 'ì—°ê²°ë¨';
          statusEl.className = 'text-xs text-green-600';
        }
        // ğŸ”´ v4.29.1: ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ í‘œì‹œ
        const logoutBtn = document.getElementById('logout-btn');
        if (logoutBtn) logoutBtn.classList.remove('hidden');

        // ğŸ”´ v4.31.0 (B5-06, B5-10): í—¤ë” ë™ê¸°í™” ë²„íŠ¼ + ìƒíƒœ í‘œì‹œ
        const headerSyncBtn = document.getElementById('header-sync-btn');
        if (headerSyncBtn) headerSyncBtn.classList.remove('hidden');
        updateSyncStatus('synced');

      } catch (error) {
        console.error('Quick start error:', error);
        showToast('ì‹œì‘ ì‹¤íŒ¨: ' + error.message, 'error');

        // í´ë°±: ì˜¤í”„ë¼ì¸ ëª¨ë“œ ì œì•ˆ
        const { confirmed } = await showAppDialog({
          title: 'ì˜¤í”„ë¼ì¸ ëª¨ë“œ ì „í™˜',
          message: 'Google ì—°ë™ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\nì˜¤í”„ë¼ì¸ ëª¨ë“œë¡œ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
          confirmText: 'ì˜¤í”„ë¼ì¸ ì‹œì‘',
          cancelText: 'ì·¨ì†Œ',
          showCancel: true
        });
        if (confirmed) {
          await quickStartOffline();
        }
      }
    }

    /**
     * ğŸ”´ v4.29.0: ì˜¤í”„ë¼ì¸ ëª¨ë“œë¡œ ì‹œì‘ (ë¡œì»¬ ì „ìš©)
     * - Google ë™ê¸°í™” ì—†ìŒ
     * - ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ë§Œ ì €ì¥
     */
    async function quickStartOffline() {
      const { confirmed, value } = await showAppDialog({
        title: 'ì˜¤í”„ë¼ì¸ í”„ë¡œí•„ ìƒì„±',
        message: 'Google ë™ê¸°í™” ì—†ì´ ì‚¬ìš©í•  í”„ë¡œí•„ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.',
        confirmText: 'ìƒì„±',
        cancelText: 'ì·¨ì†Œ',
        showCancel: true,
        input: {
          value: 'ë‚´ í”„ë¡œí•„',
          placeholder: 'í”„ë¡œí•„ ì´ë¦„'
        }
      });
      if (!confirmed) return;
      const name = sanitizeProfileName(value);
      if (!name) {
        showToast('í”„ë¡œí•„ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”', 'warning');
        return;
      }

      // ğŸ”´ v4.29.0: ê¸°ì¡´ ë¡œì»¬ ë°ì´í„° í´ë¦¬ì–´ (ê¹¨ë—í•œ ì‹œì‘)
      ProfileManager.resetToDefaults();
      selectedTicker = null;

      const newId = ProfileManager.create(name, '');
      ProfileManager.setActive(newId);
      currentProfile = ProfileManager.getActive();

      initializeApp();
      showToast('âš ï¸ ì˜¤í”„ë¼ì¸ ëª¨ë“œ - Google ë™ê¸°í™” ì—†ìŒ', 'warning');
    }


    function createNewProfile() {
      // ğŸ”´ v4.22.0: ìë™ ì´ë¦„ ìƒì„± (ì‚¬ìš©ì1, ì‚¬ìš©ì2...)
      const allProfiles = ProfileManager.getAllProfiles();
      let maxNum = 0;
      allProfiles.forEach(p => {
        const match = p.name.match(/^ì‚¬ìš©ì(\d+)$/);
        if (match) maxNum = Math.max(maxNum, parseInt(match[1]));
      });
      const name = `ì‚¬ìš©ì${maxNum + 1}`;

      // ğŸ”´ v4.15.0: í˜„ì¬ ì…ë ¥ê°’ ì €ì¥ í›„ selectedTicker ì´ˆê¸°í™” (Bug 6 ìˆ˜ì •)
      if (currentProfile && selectedTicker) {
        saveCurrentInputs(true);
      }
      selectedTicker = null;

      const newId = ProfileManager.create(name, '');
      ProfileManager.setActive(newId);
      currentProfile = ProfileManager.getActive();

      // Update SheetsSync to use new profile's Sheet
      SheetsSync.setCurrentProfile(newId);

      updateProfileSelector();
      loadProfileData();
      loadBalanceData();
      // ğŸ”´ v4.22.0: ëª¨ë‹¬ ìœ ì§€ (closeProfileModal ì œê±°)
      document.getElementById('modal-profile-name').value = name;
      showToast(`âœ… ${name} ìƒì„±ë¨`, 'success');
    }

    function exportCurrentProfile() {
      const json = ProfileManager.exportProfile(currentProfile.id);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = `ib-profile-${currentProfile.id}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function importProfile() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (ev) => {
          const newId = ProfileManager.importProfile(ev.target.result);
          if (newId) {
            ProfileManager.setActive(newId);
            updateProfileSelector();
            loadProfileData();
            closeProfileModal();
            showToast('í”„ë¡œí•„ì„ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤', 'success');
          } else {
            showToast('í”„ë¡œí•„ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨', 'error');
          }
        };
        reader.readAsText(file);
      };
      input.click();
    }

    // =====================================================
    // Genie RPA .dat File Import
    // =====================================================

    /**
     * Parse Genie RPA .dat file format
     * Format: 0|SYMBOL|PRINCIPAL|STAR%|T%|VERSION|DIVISIONS|QTY|?|?
     * Example: 0|SOXL|16000|12%|6%|V2.2|40||0|0
     */
    function parseDatFile(content) {
      const lines = content.split(/\r?\n/).filter(line => line.trim());
      const stocks = [];

      for (const line of lines) {
        const parts = line.split('|');
        if (parts.length < 7) continue;

        const symbol = sanitizeTickerSymbol(parts[1]?.trim());
        if (!symbol) continue;

        const principal = parseFloat(parts[2]) || 0;
        const starPercent = parseFloat(parts[3]?.replace('%', '')) || 0;
        const tPercent = parseFloat(parts[4]?.replace('%', '')) || 0;
        const divisions = parseInt(parts[6]) || 40;

        // ğŸ”´ v4.29.6: ë¼ì˜¤ì–´ ê°€ì´ë“œ ê¸°ì¤€ ê¸°ë³¸ê°’ (#29)
        const sellPercent = symbol === 'SOXL' ? 12 : 10;
        const locSellPercent = 5;

        stocks.push({
          symbol,
          principal,
          sellPercent,
          locSellPercent,
          starPercent,  // For reference
          tPercent,     // For reference
          divisions
        });
      }

      return stocks;
    }

    function importDatFile() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.dat,.txt';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async (ev) => {
          try {
            const content = ev.target.result;
            const stocks = parseDatFile(content);

            if (stocks.length === 0) {
              showToast('íŒŒì¼ì—ì„œ ì¢…ëª© ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'warning');
              return;
            }

            // Ask user what to do
            const stockSummary = stocks.map(s => `â€¢ ${s.symbol}: $${s.principal.toLocaleString()}`);
            const { confirmed: replaceCurrent } = await showAppDialog({
              title: 'DAT ê°€ì ¸ì˜¤ê¸°',
              message: `${stocks.length}ê°œ ì¢…ëª©ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤.`,
              confirmText: 'í˜„ì¬ í”„ë¡œí•„ êµì²´',
              cancelText: 'ìƒˆ í”„ë¡œí•„ ìƒì„±',
              showCancel: true,
              extraLines: stockSummary
            });

            if (replaceCurrent && currentProfile) {
              // Replace current profile stocks (ê¸°ì¡´ ì¢…ëª© ì‚­ì œ í›„ ìƒˆ ì¢…ëª©ìœ¼ë¡œ êµì²´)
              // 1. ê¸°ì¡´ ì¢…ëª© ëª¨ë‘ ì‚­ì œ
              const existingStocks = [...(currentProfile.stocks || [])];
              existingStocks.forEach(s => {
                ProfileManager.removeStock(currentProfile.id, s.symbol);
              });
              // 2. ìƒˆ ì¢…ëª© ì¶”ê°€
              stocks.forEach(stock => {
                ProfileManager.addStock(currentProfile.id, stock);
              });
              currentProfile = ProfileManager.getActive();
              updateModalStocksList();
              updateTickerButtons();
              showToast(`${stocks.length}ê°œ ì¢…ëª©ìœ¼ë¡œ êµì²´ë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
            } else {
              // Create new profile
              const { confirmed, value } = await showAppDialog({
                title: 'ìƒˆ í”„ë¡œí•„ ìƒì„±',
                message: 'ê°€ì ¸ì˜¨ ì¢…ëª©ì„ ì €ì¥í•  ìƒˆ í”„ë¡œí•„ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.',
                confirmText: 'ìƒì„±',
                cancelText: 'ì·¨ì†Œ',
                showCancel: true,
                input: {
                  value: file.name.replace('.dat', ''),
                  placeholder: 'í”„ë¡œí•„ ì´ë¦„'
                }
              });
              if (!confirmed) return;
              const name = sanitizeProfileName(value);
              if (!name) {
                showToast('í”„ë¡œí•„ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”', 'warning');
                return;
              }

              // ğŸ”´ v4.15.0: selectedTicker ì´ˆê¸°í™” (Bug 6 ìˆ˜ì •)
              if (currentProfile && selectedTicker) {
                saveCurrentInputs(true);
              }
              selectedTicker = null;

              const newId = ProfileManager.create(name, '');
              stocks.forEach(stock => {
                ProfileManager.addStock(newId, stock);
              });
              ProfileManager.setActive(newId);
              currentProfile = ProfileManager.getActive();
              SheetsSync.setCurrentProfile(newId);

              updateProfileSelector();
              loadProfileData();
              closeProfileModal();
              showToast(`ìƒˆ í”„ë¡œí•„ "${name}" ìƒì„± ì™„ë£Œ`, 'success');
            }
          } catch (error) {
            console.error('DAT file parse error:', error);
            showToast('íŒŒì¼ íŒŒì‹± ì˜¤ë¥˜: ' + error.message, 'error');
          }
        };
        reader.readAsText(file);
      };
      input.click();
    }

    // =====================================================
    // Daily Data Persistence
    // =====================================================

    /**
     * ğŸ”´ ëª¨ë“  í˜„ì¬ ì…ë ¥ê°’ ì €ì¥ (v4.14.0)
     * - dailyData (í‰ë‹¨ê°€, ì´ë§¤ì…ê¸ˆ, ìˆ˜ëŸ‰)
     * - stock settings (ì„¸íŒ…ì›ê¸ˆ, ë§¤ë„%)
     * @param {boolean} silent - trueë©´ í† ìŠ¤íŠ¸ ì•ˆë³´ì—¬ì¤Œ (ì¢…ëª©/í”„ë¡œí•„ ì „í™˜ ì‹œ)
     */
    function saveCurrentInputs(silent = false) {
      if (!currentProfile || !selectedTicker) return;

      // 2. Stock settings ì €ì¥ (ì„¸íŒ…ì›ê¸ˆ, ë¶„í•  ìˆ˜, AFTER%, LOC%)
      // ğŸ”´ v4.29.6: ë¼ì˜¤ì–´ ê°€ì´ë“œ ê¸°ì¤€ ê¸°ë³¸ê°’ (#29)
      const principal = parseFloat(document.getElementById('input-principal').value) || 0;
      const divisions = parseInt(document.getElementById('input-divisions').value) || 40;
      const sellPercent = parseFloat(document.getElementById('input-sellPercent').value) || (selectedTicker === 'SOXL' ? 12 : 10);
      const locSellPercent = parseFloat(document.getElementById('input-locSellPercent').value) || 5;

      // ğŸ”´ v4.16.0: í”„ë¡œí•„ì— ì—†ëŠ” ì¢…ëª© + principalì´ 0ì´ë©´ ì €ì¥í•˜ì§€ ì•ŠìŒ (Bug 11 ìˆ˜ì •)
      // ê¸°ë³¸ ë²„íŠ¼ í´ë¦­ë§Œìœ¼ë¡œ ë¹ˆ ì¢…ëª©ì´ ì¶”ê°€ë˜ëŠ” ê²ƒ ë°©ì§€
      const existingStock = ProfileManager.getStock(selectedTicker);
      if (!existingStock && principal <= 0) {
        console.log(`saveCurrentInputs: SKIP ${selectedTicker} (not in profile, principal=0)`);
        return;
      }

      // 1. Daily data ì €ì¥ (ì¢…ëª©ì´ ì €ì¥ë  ë•Œë§Œ)
      saveDailyInputs();

      ProfileManager.addStock(currentProfile.id, {
        symbol: selectedTicker,
        principal: principal,
        divisions: divisions,
        sellPercent: sellPercent,
        locSellPercent: locSellPercent
      });

      // 3. ìë™ ì €ì¥ í”¼ë“œë°± (silent ëª¨ë“œì—ì„  ì•ˆë³´ì—¬ì¤Œ)
      if (!silent) {
        showToast('âœ“ ìë™ ì €ì¥ë¨', 'success', 800);
      }

      console.log(`saveCurrentInputs: ${selectedTicker} principal=${principal}, divisions=${divisions}, sellPercent=${sellPercent}, locSellPercent=${locSellPercent}`);

      // ğŸ”´ v4.20.0: Auto-sync to Google Sheets (debounced)
      triggerAutoSync();

      // ğŸ”´ v4.30.0 (B5-05/B5-12): ì²´í¬ë°•ìŠ¤ ìƒíƒœ ê°±ì‹  (ì…ë ¥ê°’ ì €ì¥ í›„)
      // ìµœì‹  Profile ë°ì´í„°ë¥¼ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¨ ë’¤ ë²„íŠ¼ì„ ê°±ì‹ í•´ì•¼ ë°©ê¸ˆ ì…ë ¥ê°’ì´ ë°˜ì˜ë¨
      currentProfile = ProfileManager.getActive();
      updateTickerButtons();

      // ë²„íŠ¼ DOMì´ ì¬ìƒì„±ë˜ë¯€ë¡œ ê¸°ì¡´ ì„ íƒ ì¢…ëª©ì˜ ìƒíƒœë¥¼ ë³µì›
      if (selectedTicker) {
        selectTicker(selectedTicker);
      }
    }

    function saveDailyInputs() {
      if (!currentProfile || !selectedTicker) return;

      // ğŸ”´ #236 (DEC-175): avgPrice ì €ì¥ ì œê±° - íŒŒìƒê°’ìœ¼ë¡œ ì „í™˜
      const data = {
        totalInvested: parseFloat(document.getElementById('input-totalInvested').value) || 0,
        holdings: parseInt(document.getElementById('input-holdings').value) || 0
      };

      ProfileManager.saveDailyData(currentProfile.id, selectedTicker, data);
      console.log(`saveDailyInputs: ${selectedTicker}`, data);
    }

    /**
     * ğŸ”´ v4.30.0 (#10): í˜„ì¬ê°€ í‘œì‹œ (í‰ë‹¨ê°€ ì˜†)
     */
    async function updateCurrentPriceDisplay(ticker) {
      const priceValue = document.getElementById('price-value');
      const priceBadge = document.getElementById('price-source-badge');
      if (!priceValue) return;

      priceValue.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦';
      if (priceBadge) {
        priceBadge.classList.add('hidden');
      }

      try {
        const priceData = await SheetsSync.getCurrentPriceWithSource(ticker);

        if (priceData && priceData.price > 0) {
          priceValue.textContent = `$${formatPrice(priceData.price)}`;

          if (priceBadge && priceData.source) {
            if (priceData.source === 'PRE') {
              priceBadge.textContent = '(Pre)';
              priceBadge.className = 'text-xs font-medium px-1.5 py-0.5 rounded bg-amber-100 text-amber-700';
              priceBadge.classList.remove('hidden');
            } else if (priceData.source === 'POST') {
              priceBadge.textContent = '(After)';
              priceBadge.className = 'text-xs font-medium px-1.5 py-0.5 rounded bg-purple-100 text-purple-700';
              priceBadge.classList.remove('hidden');
            } else {
              priceBadge.classList.add('hidden');
            }
          }
        } else {
          priceValue.textContent = 'ë°ì´í„° ì—†ìŒ';
        }
      } catch (e) {
        console.warn('í˜„ì¬ê°€ ì¡°íšŒ ì‹¤íŒ¨:', e.message);
        priceValue.textContent = 'ì¡°íšŒ ì‹¤íŒ¨';
      }
    }

    /**
     * ğŸ”´ #236 (DEC-175): avgPrice íŒŒìƒê°’ ê³„ì‚° ìœ í‹¸ë¦¬í‹°
     * avgPrice = totalInvested / holdings (4ìë¦¬ ê³ ì •)
     * ì €ì¥í•˜ì§€ ì•Šê³  í•­ìƒ ê³„ì‚°í•´ì„œ ì‚¬ìš©
     */
    function computeAvgPrice(totalInvested, holdings) {
      if (totalInvested > 0 && holdings > 0) {
        return parseFloat(formatPrice(totalInvested / holdings));
      }
      return 0;
    }

    /**
     * ğŸ”´ v4.30.0 (B5-11): í‰ë‹¨ê°€ ìë™ ê³„ì‚° â†’ UI í•„ë“œ ì—…ë°ì´íŠ¸
     * ğŸ”´ #236 (DEC-175): computeAvgPrice() ì‚¬ìš©
     */
    function autoCalcAvgPrice() {
      const totalInvested = parseFloat(document.getElementById('input-totalInvested').value) || 0;
      const holdings = parseInt(document.getElementById('input-holdings').value) || 0;
      const avgInput = document.getElementById('input-avgPrice');
      const avgPrice = computeAvgPrice(totalInvested, holdings);

      if (avgPrice > 0) {
        avgInput.value = avgPrice.toFixed(4);  // ğŸ”´ FIX: í‰ë‹¨ê°€ 4ìë¦¬ ì œí•œ
        console.log(`autoCalcAvgPrice: ${totalInvested} / ${holdings} = ${avgPrice}`);
      } else {
        avgInput.value = '';
      }
    }

    function loadDailyInputs() {
      if (!currentProfile) return;

      // ğŸ”´ v4.14.0: ë¨¼ì € í•„ë“œ ì´ˆê¸°í™” (ì¢…ëª© ê°„ ë°ì´í„° ê³µìœ  ë²„ê·¸ ìˆ˜ì •)
      document.getElementById('input-avgPrice').value = '';
      document.getElementById('input-totalInvested').value = '';
      document.getElementById('input-holdings').value = '';

      const data = ProfileManager.loadDailyData(currentProfile.id, selectedTicker);
      if (data) {
        // ğŸ”´ #236 (DEC-175): avgPrice ë¡œë“œ ì œê±° - totalInvested/holdingsë§Œ ë¡œë“œ
        // ğŸ”´ FIX: ì†Œìˆ˜ì  ì œí•œ - ì´ë§¤ì…ê¸ˆ 2ìë¦¬, ë³´ìœ ìˆ˜ëŸ‰ ì •ìˆ˜
        if (data.totalInvested) document.getElementById('input-totalInvested').value = parseFloat(data.totalInvested).toFixed(2);
        if (data.holdings) document.getElementById('input-holdings').value = parseInt(data.holdings) || 0;
      }
      // ğŸ”´ #236 (DEC-175): avgPriceëŠ” í•­ìƒ íŒŒìƒê°’ìœ¼ë¡œ ê³„ì‚°
      autoCalcAvgPrice();
    }

    // =====================================================
    // Ticker Selection
    // =====================================================

    function selectTicker(ticker) {
      // ğŸ”´ ì¢…ëª© ì „í™˜ ì „ì— í˜„ì¬ ì…ë ¥ê°’ ì €ì¥ (v4.11.0 ë²„ê·¸ ìˆ˜ì •)
      // ğŸ”´ v4.15.0: silent=true ì¶”ê°€ (í† ìŠ¤íŠ¸ ìŠ¤íŒ¸ ë°©ì§€)
      if (selectedTicker && selectedTicker !== ticker) {
        saveCurrentInputs(true);
      }

      selectedTicker = ticker;

      // Update UI
      document.querySelectorAll('.ticker-btn').forEach(btn => {
        const isSelected = btn.dataset.ticker === ticker;
        btn.classList.toggle('bg-blue-500', isSelected);
        btn.classList.toggle('text-white', isSelected);
        btn.classList.toggle('bg-gray-100', !isSelected);
        btn.classList.toggle('text-gray-600', !isSelected);
      });

      // Load stock settings from profile (v4.21.1: AFTER% + LOC%)
      // ğŸ”´ v4.29.5: principal ê¸°ë³¸ê°’ 13000 ë²„ê·¸ ìˆ˜ì • - ì—†ìœ¼ë©´ ë¹ˆê°’
      // ğŸ”´ v4.29.6: ë¼ì˜¤ì–´ ê°€ì´ë“œ ê¸°ì¤€ ê¸°ë³¸ê°’ (#29)
      const stock = ProfileManager.getStock(ticker);
      const defaultDivisions = 40;
      const defaultSellPercent = ticker === 'SOXL' ? 12 : 10;
      const defaultLocPercent = 5;
      if (stock) {
        document.getElementById('input-principal').value = stock.principal || '';
        document.getElementById('input-divisions').value = stock.divisions || defaultDivisions;
        document.getElementById('input-sellPercent').value = stock.sellPercent || defaultSellPercent;
        document.getElementById('input-locSellPercent').value = stock.locSellPercent || defaultLocPercent;
      } else {
        // ğŸ”´ v4.16.0: ì¢…ëª©ì´ í”„ë¡œí•„ì— ì—†ìœ¼ë©´ input-principalë„ ì´ˆê¸°í™” (Bug 11 ìˆ˜ì •)
        // ì´ì „ í”„ë¡œí•„ì˜ ê°’ì´ ìƒˆ í”„ë¡œí•„ì— ì €ì¥ë˜ëŠ” ê²ƒ ë°©ì§€
        document.getElementById('input-principal').value = '';
        document.getElementById('input-divisions').value = defaultDivisions;
        document.getElementById('input-sellPercent').value = defaultSellPercent;
        document.getElementById('input-locSellPercent').value = defaultLocPercent;
      }

      // Load saved daily inputs
      loadDailyInputs();

      // ğŸ”´ v4.30.0 (#10): í˜„ì¬ê°€ í‘œì‹œ (í‰ë‹¨ê°€ ì˜†)
      updateCurrentPriceDisplay(ticker);

      // ğŸ”´ v4.17.0: ì¢…ëª© ì „í™˜ ì‹œ ëª¨ë“  ê²°ê³¼ ì˜ì—­ ì´ˆê¸°í™” (Bug 12 ìˆ˜ì •)
      document.getElementById('results-section').classList.add('hidden');
      // PC ê²°ê³¼ ì˜ì—­ë„ ì´ˆê¸°í™”
      const resultsPC = document.getElementById('results-pc');
      if (resultsPC) {
        resultsPC.innerHTML = `
          <div class="text-center text-gray-400 py-8">
            <i class="fas fa-calculator text-4xl mb-2"></i>
            <p>ì£¼ë¬¸ ê³„ì‚° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</p>
          </div>
        `;
      }
      // ëª¨ë°”ì¼ ì˜¤ë²„ë ˆì´ ë‹«ê¸°
      document.getElementById('results-overlay')?.classList.add('hidden');
      document.body.style.overflow = '';
      // lastCalculation ì´ˆê¸°í™”
      lastCalculation = null;
    }

    // =====================================================
    // Current Price Fetch (100xFenok Ticker API)
    // =====================================================

    /**
     * ì¬ê³„ì‚° ë²„íŠ¼
     */
    function recalculate() {
      if (hasRequiredInputs()) {
        calculateOrders();
        showToast('ê³„ì‚° ì™„ë£Œ', 'success', 1500);
      } else {
        showToast('í‰ë‹¨ê°€ì™€ ì„¸íŒ…ì›ê¸ˆì„ ì…ë ¥í•˜ì„¸ìš”', 'warning');
      }
    }

    // =====================================================
    // Holdings Quick Adjust (UX Enhancement)
    // =====================================================

    /**
     * ë³´ìœ  ìˆ˜ëŸ‰ ë¹ ë¥¸ ì¡°ì • (+ë²„íŠ¼)
     */
    function adjustHoldings(amount) {
      const input = document.getElementById('input-holdings');
      const current = parseInt(input.value) || 0;
      input.value = current + amount;

      // ğŸ”´ #236 (DEC-175): holdings ë³€ê²½ ì‹œ avgPrice ì¬ê³„ì‚°
      autoCalcAvgPrice();
      saveDailyInputs();
      if (hasRequiredInputs()) {
        calculateOrders();
      }

      // Visual feedback
      input.classList.add('ring-2', 'ring-green-400');
      setTimeout(() => input.classList.remove('ring-2', 'ring-green-400'), 300);
    }

    /**
     * ì˜¤ëŠ˜ ë§¤ìˆ˜ëŸ‰ í—¬í¼ í‘œì‹œ
     */
    function showTodayBuyHelper(quantity, ticker) {
      const helper = document.getElementById('today-buy-helper');
      const qtySpan = document.getElementById('today-buy-qty');
      const compareEl = document.getElementById('yesterday-buy-compare');

      if (quantity > 0) {
        helper.classList.remove('hidden');
        qtySpan.textContent = quantity;
        if (compareEl) {
          compareEl.classList.add('hidden');
          compareEl.textContent = '';
        }
        updateYesterdayBuyCompare(ticker);
      } else {
        helper.classList.add('hidden');
        if (compareEl) {
          compareEl.classList.add('hidden');
          compareEl.textContent = '';
        }
      }
    }

    async function updateYesterdayBuyCompare(ticker) {
      const compareEl = document.getElementById('yesterday-buy-compare');
      if (!compareEl) return;
      if (!ticker || typeof SheetsSync === 'undefined' || !SheetsSync.isAuthenticated() || !currentProfile) {
        compareEl.classList.add('hidden');
        compareEl.textContent = '';
        return;
      }

      try {
        const qty = await SheetsSync.getYesterdayBuyQuantity(currentProfile.id, ticker);
        if (qty > 0) {
          compareEl.textContent = `(ì–´ì œ: ${qty}ì£¼ ë§¤ìˆ˜í•¨)`;
          compareEl.classList.remove('hidden');
        } else {
          compareEl.classList.add('hidden');
          compareEl.textContent = '';
        }
      } catch (error) {
        console.warn('Yesterday buy compare error:', error);
        compareEl.classList.add('hidden');
        compareEl.textContent = '';
      }
    }

    /**
     * ì˜¤ëŠ˜ ë§¤ìˆ˜ëŸ‰ì„ ìˆ˜ëŸ‰ì— ì¶”ê°€
     */
    function applyTodayBuy() {
      if (!lastCalculation) return;

      const allBuyOrders = lastCalculation.buyOrders || [];
      const totalBuyQty = allBuyOrders.reduce((sum, o) => sum + o.quantity, 0);

      // 1. ìˆ˜ëŸ‰ ì¶”ê°€ (adjustHoldings ë‚´ë¶€ì—ì„œ saveDailyInputs í˜¸ì¶œ)
      adjustHoldings(totalBuyQty);

      // 2. ì´ë§¤ì…ê¸ˆ ì—…ë°ì´íŠ¸ (ğŸ”´ v4.47.2: ìˆ˜ìˆ˜ë£Œ í¬í•¨ - balance consistency fix)
      const commPercent = (typeof BalanceManager !== 'undefined')
        ? BalanceManager.getCommissionRate(currentProfile.id)
        : 0.07;
      const commRate = (Number.isFinite(commPercent) ? commPercent : 0.07) / 100;
      const totalAmount = allBuyOrders.reduce((sum, o) => sum + (o.price * o.quantity * (1 + commRate)), 0);
      const investedInput = document.getElementById('input-totalInvested');
      const currentInvested = parseFloat(investedInput.value) || 0;
      investedInput.value = (currentInvested + totalAmount).toFixed(2);

      // ğŸ”´ #236 (DEC-175): totalInvested+holdings ëª¨ë‘ ë³€ê²½ í›„ avgPrice ì¬ê³„ì‚°
      autoCalcAvgPrice();
      saveDailyInputs();

      // Hide helper
      document.getElementById('today-buy-helper').classList.add('hidden');

      // Show feedback
      showToast(`ìˆ˜ëŸ‰ +${totalBuyQty}ì£¼, ë§¤ì…ê¸ˆ +$${totalAmount.toFixed(2)} ë°˜ì˜ë¨`, 'success', 2500);
    }

    // =====================================================
    // Copy Functions (UX Enhancement)
    // =====================================================

    /**
     * ê°œë³„ ì£¼ë¬¸ ë³µì‚¬ (v4.22.0: ê°€ê²©ë§Œ, ë‹¬ëŸ¬í‘œì‹œ ì œê±°)
     */
    async function copyOrder(btn, price, quantity) {
      // ğŸ”´ v4.29.4 (C-08): copyToClipboard ì‚¬ìš©
      const text = formatPrice(price);
      const success = await copyToClipboard(text);
      if (success) {
        btn.innerHTML = '<i class="fas fa-check"></i>';
        btn.classList.add('copied');
        setTimeout(() => {
          btn.innerHTML = '<i class="fas fa-copy"></i>';
          btn.classList.remove('copied');
        }, 1500);
      } else {
        console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨');
        showToast('ë³µì‚¬ ì‹¤íŒ¨', 'error');
      }
    }

    /**
     * ë‹¤ì¤‘ ê²°ê³¼ìš© ê¸ˆì•¡ ë‹¨ì¼ ë³µì‚¬
     */
    async function copyPriceValue(btn, price) {
      const numeric = formatPrice(price);
      const success = await copyToClipboard(numeric);
      if (success && btn) {
        btn.classList.add('copied');
        btn.innerHTML = '<i class="fas fa-check"></i>';
        setTimeout(() => {
          btn.classList.remove('copied');
          btn.innerHTML = numeric;
        }, 1200);
      }
      if (!success) {
        showToast('ë³µì‚¬ ì‹¤íŒ¨', 'error');
      }
    }

    async function copyQuantityValue(btn, quantity) {
      const numeric = `${parseInt(quantity, 10) || 0}`;
      const success = await copyToClipboard(numeric);
      if (success && btn) {
        btn.classList.add('copied');
        btn.innerHTML = '<i class="fas fa-check"></i>';
        setTimeout(() => {
          btn.classList.remove('copied');
          btn.innerHTML = `${numeric}ì£¼`;
        }, 1200);
      }
      if (!success) {
        showToast('ë³µì‚¬ ì‹¤íŒ¨', 'error');
      }
    }

    /**
     * ì „ì²´ ì£¼ë¬¸ ë³µì‚¬ (ì„¹ì…˜ë³„)
     * ğŸ”´ v4.29.4 (C-08): copyToClipboard ì‚¬ìš©
     */
    async function copyAllOrders(type) {
      if (!lastCalculation) return;

      let orders = [];
      let sectionLabel = '';

      if (type === 'buy') {
        orders = lastCalculation.buyOrders;
        sectionLabel = 'ë§¤ìˆ˜';
      } else if (type === 'sell') {
        orders = lastCalculation.sellOrders;
        sectionLabel = 'ë§¤ë„';
      } else if (type === 'decline') {
        orders = lastCalculation.buyOrders.filter(o => o.type.includes('í•˜ë½ëŒ€ë¹„'));
        sectionLabel = 'í•˜ë½ëŒ€ë¹„';
      }

      if (orders.length === 0) {
        showToast('ë³µì‚¬í•  ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤', 'warning');
        return;
      }

      const priceLines = orders.map(o => formatPrice(o.price));
      const text = priceLines.join('\n');
      const success = await copyToClipboard(text);
      if (success) {
        const message = sectionLabel ? `${sectionLabel} ê¸ˆì•¡ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤` : 'ê¸ˆì•¡ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤';
        showToast(message, 'success');
      } else {
        showToast('ë³µì‚¬ ì‹¤íŒ¨', 'error');
      }
    }

    /**
     * #219: ì „ì²´ ì£¼ë¬¸ ë³µì‚¬ (ë§¤ìˆ˜(í•˜ë½ëŒ€ë¹„ í¬í•¨)+ë§¤ë„ ì „ì²´)
     * ğŸ”´ v4.29.4 (C-08): copyToClipboard ì‚¬ìš©
     */
    const ORDER_COPY_DIVIDER = 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”';

    function formatDollarShort(value) {
      const numeric = Number(value || 0);
      if (!Number.isFinite(numeric)) return '$0';
      const formatted = IBCalculator.formatDollar(numeric, 2);
      return formatted.replace(/\\.00$/, '');
    }

    function formatOrderLine(order) {
      const label = formatOrderLabel(order);
      return `  ${label}: ${order.quantity}ì£¼ x $${formatOrderPrice(order.price)}`;
    }

    function formatAdditionalBuyPolicy(input, oneTimeBuy) {
      if (!input || input.additionalBuyEnabled === false) {
        return 'í•˜ë½ëŒ€ë¹„: OFF';
      }
      const mode = input.additionalBuyMode === 'fixed' ? 'fixed' : 'budget_ratio';
      if (mode === 'fixed') {
        const count = Math.max(0, Math.min(8, parseInt(input.additionalBuyOrderCount, 10) || 0));
        return `í•˜ë½ëŒ€ë¹„: ê³ ì • ${count}ê°œ`;
      }
      const ratio = Number.isFinite(parseFloat(input.additionalBuyBudgetRatio))
        ? Math.max(0, Math.min(100, parseFloat(input.additionalBuyBudgetRatio)))
        : 20;
      const budget = (Number.isFinite(oneTimeBuy) ? oneTimeBuy : 0) * (ratio / 100);
      const allowOneOver = input.additionalBuyAllowOneOver !== false;
      return `í•˜ë½ëŒ€ë¹„: ì˜ˆì‚° ${ratio}% (${IBCalculator.formatDollar(budget, 2)}) + ${allowOneOver ? 'ì´ˆê³¼ 1ê°œ' : 'ì—„ê²© ì˜ˆì‚°'}`;
    }

    async function copyAllOrdersTotal() {
      if (!lastCalculation) {
        showToast('ë¨¼ì € ê³„ì‚°ì„ ì‹¤í–‰í•˜ì„¸ìš”', 'warning');
        return;
      }

      await ensureCashReservePrices();

      const { buyOrders, sellOrders, quarterStopLoss, calculation, input } = lastCalculation;
      const avgPrice = computeAvgPrice(input?.totalInvested || 0, input?.holdings || 0);
      const headerLine = `ã€${lastCalculation.ticker}ã€‘ í‰ë‹¨ $${formatOrderPrice(avgPrice)} | T=${calculation.T.toFixed(1)} | íˆ¬ìê¸ˆ ${formatDollarShort(input?.principal)}`;

      const lines = [
        `ğŸ“Š ${lastCalculation.ticker} ì˜¤ëŠ˜ì˜ ì£¼ë¬¸`,
        ORDER_COPY_DIVIDER,
        headerLine,
        formatAdditionalBuyPolicy(input, calculation.oneTimeBuy)
      ];

      const cashAction = buildCashReserveAction();
      if (cashAction) {
        const verb = cashAction.side === 'BUY' ? 'ë§¤ìˆ˜' : 'ë§¤ë„';
        const orderType = cashAction.side === 'BUY' ? 'ì¦‰ì‹œ' : 'MOC';
        lines.push('', 'ğŸ’µ í˜„ê¸ˆì„± ìì‚°');
        lines.push(`  ${cashAction.symbol} ${verb} (${orderType}): ${cashAction.quantity}ì£¼`);
      }

      // B: ë§¤ìˆ˜ ê°€ê²© ë‚´ë¦¼ì°¨ìˆœ
      const sortedBuy = [...buyOrders].sort((a, b) => b.price - a.price);
      lines.push('', 'ğŸŸ¢ BUY (LOC)', ...sortedBuy.map(o => formatOrderLine(o)));

      if (quarterStopLoss && quarterStopLoss.active) {
        lines.push('', 'ğŸ”´ ì¿¼í„°ì†ì ˆ (MOC)');
        lines.push(`  MOC ë§¤ë„: ${quarterStopLoss.mocQuantity}ì£¼`);
      } else {
        // C: ë§¤ë„ ì§€ì •ê°€ ë¨¼ì €, ê·¸ë£¹ ë‚´ ê°€ê²© ë‚´ë¦¼ì°¨ìˆœ
        const sortedSell = [...sellOrders].sort((a, b) => {
          const aIsLimit = (a.type || '').includes('ì§€ì •ê°€');
          const bIsLimit = (b.type || '').includes('ì§€ì •ê°€');
          if (aIsLimit !== bIsLimit) return aIsLimit ? -1 : 1;
          return b.price - a.price;
        });
        lines.push('', 'ğŸ”´ SELL');
        lines.push(...sortedSell.map(o => formatOrderLine(o)));
      }

      lines.push('', ORDER_COPY_DIVIDER);

      const text = lines.join('\n');
      const success = await copyToClipboard(text);
      if (success) {
        showToast('ì „ì²´ ì£¼ë¬¸ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
      } else {
        showToast('ë³µì‚¬ ì‹¤íŒ¨', 'error');
      }
    }

    /**
     * #216: ì¿¼í„°ì†ì ˆ ì²´í¬ë°•ìŠ¤ í•¸ë“¤ëŸ¬
     */
    function handleQuarterStopChange() {
      const checkbox = document.getElementById('quarter-stop-checkbox');
      const contentEl = document.getElementById('quarter-stop-loss-content');
      const mocOrderEl = document.getElementById('quarter-stop-moc-order');

      if (checkbox.checked) {
        contentEl.classList.remove('hidden');
        mocOrderEl.classList.remove('hidden');
      } else {
        contentEl.classList.add('hidden');
        mocOrderEl.classList.add('hidden');
      }
    }

    /**
     * #216: MOC ì£¼ë¬¸ ë³µì‚¬
     * ğŸ”´ v4.29.4 (C-08): copyToClipboard ì‚¬ìš©
     */
    async function copyMocOrder() {
      if (!lastCalculation || !lastCalculation.quarterStopLoss) return;

      const { quarterStopLoss } = lastCalculation;
      const text = `ğŸ”´ ${selectedTicker} MOC ë§¤ë„: ${quarterStopLoss.mocQuantity}ì£¼\n(ì¿¼í„°ì†ì ˆ - ì¢…ê°€ ì£¼ë¬¸)`;

      const success = await copyToClipboard(text);
      if (success) {
        showToast('MOC ì£¼ë¬¸ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
      } else {
        showToast('ë³µì‚¬ ì‹¤íŒ¨', 'error');
      }
    }

    // =====================================================
    // Calculate Orders
    // =====================================================

    function hasRequiredInputs() {
      // ğŸ”´ #236 (DEC-175): avgPriceë¥¼ input í•„ë“œê°€ ì•„ë‹Œ íŒŒìƒê°’ìœ¼ë¡œ ê²€ì¦
      const totalInvested = parseFloat(document.getElementById('input-totalInvested').value) || 0;
      const holdings = parseInt(document.getElementById('input-holdings').value) || 0;
      const avgPrice = computeAvgPrice(totalInvested, holdings);
      const principal = parseFloat(document.getElementById('input-principal').value);
      // í˜„ì¬ê°€ëŠ” ì„ íƒ - ì—†ìœ¼ë©´ ë³„%ê°€ë§Œ ì‚¬ìš©
      return avgPrice > 0 && principal > 0;
    }

    function getAdditionalBuyInputForCalculation() {
      const latestProfile = ProfileManager.getById(currentProfile?.id) || currentProfile;
      const normalized = getNormalizedAdditionalBuySettings(latestProfile);
      if (!normalized.enabled) {
        return {
          additionalBuyEnabled: false,
          additionalBuyMode: normalized.mode,
          additionalBuyOrderCount: 0,
          additionalBuyBudgetRatio: 0,
          additionalBuyAllowOneOver: normalized.allowOneOver,
          additionalBuyMaxDecline: normalized.maxDecline,
          additionalBuyQuantity: normalized.quantity
        };
      }
      return {
        additionalBuyEnabled: true,
        additionalBuyMode: normalized.mode,
        additionalBuyOrderCount: normalized.orderCount,
        additionalBuyBudgetRatio: normalized.budgetRatio,
        additionalBuyAllowOneOver: normalized.allowOneOver,
        additionalBuyMaxDecline: normalized.maxDecline,
        additionalBuyQuantity: normalized.quantity
      };
    }

    async function calculateOrders() {
      // ğŸ”´ v4.29.0: selectedTicker null guard
      if (!selectedTicker) {
        showToast('ì¢…ëª©ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”', 'warning');
        return;
      }

      // Gather inputs
      // ğŸ”´ v4.21.2: sellPercent ì „ë‹¬ (Ralph Loop ë°œê²¬)
      // Note: locSellPercentëŠ” í‘œì‹œìš© - LOC ê°€ê²©ì€ ë³„%ê°€ë¡œ ìë™ ê³„ì‚°
      // ğŸ”´ v4.29.6: ë¼ì˜¤ì–´ ê°€ì´ë“œ ê¸°ì¤€ ê¸°ë³¸ê°’ (#29)
      const defaultSellPercent = selectedTicker === 'SOXL' ? 12 : 10;

      // ğŸ”´ #211: í˜„ì¬ê°€ ìë™ ì¡°íšŒ (Prices ì‹œíŠ¸ì—ì„œ)
      let currentPrice = 0;
      try {
        if (SheetsSync.isAuthenticated()) {
          currentPrice = await SheetsSync.getCurrentPrice(selectedTicker);
          if (currentPrice > 0) {
            console.log(`ğŸ“Š ${selectedTicker} í˜„ì¬ê°€: $${currentPrice} (ê°€ê²©ìº¡ í™œì„±í™”)`);
          }
        }
      } catch (e) {
        // ğŸ”´ v4.29.0: ì‚¬ìš©ìì—ê²Œ í”¼ë“œë°± ì¶”ê°€
        console.warn('í˜„ì¬ê°€ ì¡°íšŒ ì‹¤íŒ¨, ë³„%ê°€ë§Œ ì‚¬ìš©:', e.message);
        showToast('âš ï¸ í˜„ì¬ê°€ ì¡°íšŒ ì‹¤íŒ¨ - ë³„%ê°€ë§Œ ì‚¬ìš©', 'warning', 2000);
      }

      // ğŸ”´ #236 (DEC-175): avgPriceë¥¼ íŒŒìƒê°’ìœ¼ë¡œ ê³„ì‚°
      const totalInvested = parseFloat(document.getElementById('input-totalInvested').value) || 0;
      const holdings = parseInt(document.getElementById('input-holdings').value) || 0;

      const input = {
        ticker: selectedTicker,
        principal: parseFloat(document.getElementById('input-principal').value) || 0,
        divisions: parseInt(document.getElementById('input-divisions').value) || 40,
        avgPrice: computeAvgPrice(totalInvested, holdings),
        totalInvested: totalInvested,
        holdings: holdings,
        currentPrice: currentPrice,  // ğŸ”´ #211: Prices ì‹œíŠ¸ì—ì„œ ìë™ ì¡°íšŒ
        sellPercent: parseFloat(document.getElementById('input-sellPercent').value) || defaultSellPercent,
        locSellPercent: parseFloat(document.getElementById('input-locSellPercent').value) || 5,  // ğŸ”´ #234: LOC% ì—°ë™
        ...getAdditionalBuyInputForCalculation()
      };

      // Validate - í•„ìˆ˜ ì…ë ¥ê°’ ì²´í¬ (í˜„ì¬ê°€ëŠ” ì„ íƒ - LOC ìº¡ì—ë§Œ ì‚¬ìš©)
      const missing = [];
      if (!input.principal) missing.push('ì„¸íŒ…ì›ê¸ˆ');
      if (!input.avgPrice) missing.push('í‰ë‹¨ê°€');

      if (missing.length > 0) {
        showToast(`í•„ìˆ˜ ì…ë ¥ê°’: ${missing.join(', ')}`, 'warning');
        return;
      }

      // Calculate
      const result = IBCalculator.calculate(input);

      if (result.error) {
        showToast(result.error, 'error');
        return;
      }

      // ğŸ”´ v4.28.1: ë‹¤ì¤‘ ê²°ê³¼ UI ìˆ¨ê¸°ê¸° (ë‹¨ì¼ ê³„ì‚° ì‹œ)
      document.getElementById('multi-results-section')?.classList.add('hidden');

      // Display results
      displayResults(result);
      updateCashReserveRecommendation();

      // ğŸ”´ v4.21.0: Auto-save orders to Google Sheets (DEC-153)
      saveOrdersToSheet(result);
    }

    /**
     * ğŸ”´ v4.28.0: ë‹¤ì¤‘ ì¢…ëª© ì „ì²´ ê³„ì‚° (#217)
     * enabledTickersì— ìˆëŠ” ëª¨ë“  ì¢…ëª©ì„ ìˆœíšŒí•˜ë©° ê³„ì‚°
     */
    async function calculateAllOrders() {
      // ê³„ì‚°í•  ì¢…ëª© ì²´í¬
      if (enabledTickers.size === 0) {
        showToast('ê³„ì‚°í•  ì¢…ëª©ì„ ì„ íƒí•˜ì„¸ìš”', 'warning');
        return;
      }

      // í”„ë¡œí•„ í•„ìˆ˜ ì²´í¬
      if (!currentProfile || !currentProfile.stocks?.length) {
        showToast('í”„ë¡œí•„ì— ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤', 'warning');
        return;
      }

      // ê²°ê³¼ ì´ˆê¸°í™”
      calculationResults = {};
      const tickerList = [...enabledTickers];
      const additionalBuyInput = getAdditionalBuyInputForCalculation();

      // ğŸ”´ v4.28.1: í˜„ì¬ê°€ ì¼ê´„ ì¡°íšŒ (Promise.allë¡œ ë³‘ë ¬ ì²˜ë¦¬)
      let priceMap = {};
      try {
        if (SheetsSync.isAuthenticated()) {
          // fetchCurrentPrices() í•œ ë²ˆ í˜¸ì¶œë¡œ ëª¨ë“  ì¢…ëª© ê°€ê²© ê°€ì ¸ì˜¤ê¸°
          const allPrices = await SheetsSync.fetchCurrentPrices();
          tickerList.forEach(ticker => {
            if (allPrices[ticker]?.current > 0) {
              priceMap[ticker] = allPrices[ticker].current;
            }
          });
          console.log('ğŸ“Š í˜„ì¬ê°€ ì¡°íšŒ ì™„ë£Œ:', priceMap);
        }
      } catch (e) {
        console.warn('í˜„ì¬ê°€ ì¡°íšŒ ì‹¤íŒ¨:', e.message);
      }

      // ê° ì¢…ëª©ë³„ ê³„ì‚°
      const successResults = [];
      const failedTickers = [];

      for (const ticker of tickerList) {
        // í”„ë¡œí•„ì—ì„œ ì¢…ëª© ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const stockData = currentProfile.stocks.find(s => s.symbol === ticker);
        if (!stockData) {
          failedTickers.push({ ticker, reason: 'ì¢…ëª© ë°ì´í„° ì—†ìŒ' });
          continue;
        }

        // ğŸ”´ v4.28.1: dailyDataì—ì„œ ìˆ˜ëŸ‰/ì´ë§¤ì…ê¸ˆ ê°€ì ¸ì˜¤ê¸°
        // ğŸ”´ #236 (DEC-175): avgPriceë¥¼ íŒŒìƒê°’ìœ¼ë¡œ ê³„ì‚°
        const dailyData = ProfileManager.loadDailyData(currentProfile.id, ticker) || {};
        const totalInvested = dailyData.totalInvested || 0;
        const holdings = dailyData.holdings || 0;
        const avgPrice = computeAvgPrice(totalInvested, holdings);
        const principal = stockData.principal || 0;

        if (!avgPrice || !principal) {
          failedTickers.push({ ticker, reason: 'í‰ë‹¨ê°€/ì„¸íŒ…ì›ê¸ˆ ì—†ìŒ' });
          continue;
        }

        // ì…ë ¥ê°’ êµ¬ì„±
        // ğŸ”´ v4.29.6: ë¼ì˜¤ì–´ ê°€ì´ë“œ ê¸°ì¤€ ê¸°ë³¸ê°’ (#29)
        const defaultSellPercent = ticker === 'SOXL' ? 12 : 10;
        const input = {
          ticker: ticker,
          principal: principal,
          divisions: stockData.divisions || 40,
          avgPrice: avgPrice,
          totalInvested: totalInvested,
          holdings: holdings,
          currentPrice: priceMap[ticker] || 0,
          sellPercent: stockData.sellPercent || defaultSellPercent,
          locSellPercent: stockData.locSellPercent || 5,  // ğŸ”´ #234: LOC% ì—°ë™
          ...additionalBuyInput
        };

        // ê³„ì‚°
        const result = IBCalculator.calculate(input);

        if (result.error) {
          failedTickers.push({ ticker, reason: result.error });
          continue;
        }

        calculationResults[ticker] = result;
        successResults.push(result);

        // ì‹œíŠ¸ì— ì €ì¥ (ë¹„ë™ê¸°)
        saveOrdersToSheet(result);
      }

      // ê²°ê³¼ í‘œì‹œ
      if (successResults.length === 0) {
        showToast('ê³„ì‚°ëœ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤', 'warning');
        return;
      }

      // ì‹¤íŒ¨ ì¢…ëª© ê²½ê³ 
      if (failedTickers.length > 0) {
        console.warn('ê³„ì‚° ì‹¤íŒ¨ ì¢…ëª©:', failedTickers);
        showToast(`${failedTickers.length}ê°œ ì¢…ëª© ê³„ì‚° ì‹¤íŒ¨`, 'warning');
      }

      // ë‹¤ì¤‘ ê²°ê³¼ í‘œì‹œ (ì•„ì½”ë””ì–¸)
      displayMultipleResults(successResults);

      // ğŸ”´ v4.29.6 (#31): ë³µìˆ˜ ì¢…ëª© ê³„ì‚° í›„ ì˜ˆìˆ˜ê¸ˆ ìƒíƒœ ê°±ì‹ 
      recalculateBalance();

      showToast(`${successResults.length}ê°œ ì¢…ëª© ê³„ì‚° ì™„ë£Œ`, 'success');
    }

    /**
     * Save orders to Google Sheets (Orders sheet)
     * Silently saves in background, non-blocking
     * @param {Object} result - Calculation result
     */
    // ğŸ”´ v4.31.0 (B5-15): ì¤‘ë³µ ì €ì¥ ë°©ì§€ìš© Set
    const _savedOrderKeys = new Set();

    async function saveOrdersToSheet(result) {
      // Only if logged in
      if (typeof SheetsSync === 'undefined' || !SheetsSync.isAuthenticated()) {
        console.log('saveOrdersToSheet: Skipped (not logged in)');
        return;
      }

      // ğŸ”´ v4.31.0 (B5-14): ticker ìœ íš¨ì„± ê²€ì‚¬
      if (!result.ticker || result.ticker === 'null' || result.ticker === 'undefined') {
        console.warn('saveOrdersToSheet: Skipped (invalid ticker)', result.ticker);
        return;
      }

      // ğŸ”´ v4.36.x: ì¤‘ë³µ ì €ì¥ ë°©ì§€ í‚¤ ë‹¨ìˆœí™” (date+googleId+profile+ticker+type+side+executionBasis)
      // KST ê¸°ì¤€ ë‚ ì§œ (UTC+9) - ì¤‘ë³µí‚¤ ë‚ ì§œ ì¼ì¹˜
      const today = new Date(Date.now() + 9 * 60 * 60 * 1000).toISOString().slice(0, 10);
      const profileId = currentProfile?.id || 'unknown';
      const googleId = (typeof SheetsSync !== 'undefined' && SheetsSync.getUserEmail)
        ? (SheetsSync.getUserEmail() || 'unknown')
        : 'unknown';
      const buildOrderKey = (order, side) => {
        const orderType = order?.type || 'UNKNOWN';
        const executionBasis = side === 'BUY'
          ? 'CLOSE'
          : (String(orderType).includes('LOC') ? 'CLOSE' : 'HIGH');
        const ticker = String(result.ticker || '').trim().toUpperCase();
        return `${today}|${googleId}|${profileId}|${ticker}|${orderType}|${side}|${executionBasis}`;
      };

      const newBuyOrders = [];
      const newSellOrders = [];
      const newKeys = [];

      (result.buyOrders || []).forEach((order) => {
        const key = buildOrderKey(order, 'BUY');
        if (_savedOrderKeys.has(key)) return;
        newBuyOrders.push(order);
        newKeys.push(key);
      });

      (result.sellOrders || []).forEach((order) => {
        const key = buildOrderKey(order, 'SELL');
        if (_savedOrderKeys.has(key)) return;
        newSellOrders.push(order);
        newKeys.push(key);
      });

      if (newBuyOrders.length === 0 && newSellOrders.length === 0) {
        console.log('saveOrdersToSheet: Skipped (all orders already saved)', result.ticker);
        return;
      }

      try {
        const count = await SheetsSync.saveOrders({
          ticker: result.ticker,
          buyOrders: newBuyOrders,
          sellOrders: newSellOrders
        });
        if (count > 0) {
          newKeys.forEach(key => _savedOrderKeys.add(key)); // ì„±ê³µ ì‹œì—ë§Œ ê¸°ë¡
          showToast(`ğŸ“Š ${count}ê±´ ì£¼ë¬¸ ì €ì¥ë¨`, 'success', 1500);
        }
      } catch (error) {
        console.error('saveOrdersToSheet error:', error);
        // Silent failure - don't interrupt user
      }
    }

    // =====================================================
    // Display Results
    // =====================================================

    // Store last calculation for copy/helper features
    let lastCalculation = null;

    function displayResults(result) {
      // ğŸ”´ v4.49.3: ë°©ì–´ì  í”„ë¡œê·¸ë˜ë° - null/undefined ì²´í¬
      if (!result || !result.calculation) {
        console.error('displayResults: Invalid result', result);
        showToast('ê³„ì‚° ê²°ê³¼ ì˜¤ë¥˜', 'error');
        return;
      }
      const { calculation, buyOrders, sellOrders, quarterStopLoss } = result;
      lastCalculation = result;

      // ğŸ”´ v4.22.0: results-sectionì€ í•­ìƒ hidden (ë³µì‚¬ìš© í…œí”Œë¦¿)
      // ì‹¤ì œ í‘œì‹œëŠ” PCâ†’results-pc, Mobileâ†’results-mobileì—ì„œ
      const resultsSection = document.getElementById('results-section');

      // Summary card
      document.getElementById('result-ticker').textContent = result.ticker;
      document.getElementById('result-T').textContent = calculation.T.toFixed(1);
      document.getElementById('result-starPercent').textContent = calculation.starPercent.toFixed(1) + '%';
      document.getElementById('result-oneTimeBuy').textContent = IBCalculator.formatDollar(calculation.oneTimeBuy);
      document.getElementById('result-locPrice').textContent = IBCalculator.formatDollar(calculation.locInfo.locPrice);

      // Phase badge
      const phaseBadge = document.getElementById('result-phase');
      phaseBadge.textContent = calculation.phase;
      phaseBadge.className = 'ml-2 px-2 py-0.5 text-xs rounded';
      if (calculation.phase === 'ì „ë°˜ì „') {
        phaseBadge.classList.add('bg-green-500/30', 'text-green-300');
      } else if (calculation.phase === 'í›„ë°˜ì „') {
        phaseBadge.classList.add('bg-yellow-500/30', 'text-yellow-300');
      } else {
        phaseBadge.classList.add('bg-red-500/30', 'text-red-300');
      }

      // LOC reason
      const locReason = document.getElementById('result-locReason');
      if (calculation.locInfo.currentPriceCap > 0) {
        locReason.textContent = `${calculation.locInfo.reason} (ë³„%ê°€ = ${IBCalculator.formatDollar(calculation.locInfo.starPrice)}, í˜„ì¬ê°€Ã—1.15 = ${IBCalculator.formatDollar(calculation.locInfo.currentPriceCap)})`;
      } else {
        locReason.textContent = `${calculation.locInfo.reason}`;
      }

      // v4.23.0: Update formula details with actual values
      updateFormulaDetails(result);

      // Separate main buy orders and decline orders (merged for display)
      const mainBuyOrders = buyOrders.filter(o => !o.type.includes('í•˜ë½ëŒ€ë¹„'));
      const declineOrders = buyOrders.filter(o => o.type.includes('í•˜ë½ëŒ€ë¹„'));
      // ğŸ”´ FIX: ë§¤ìˆ˜ ì£¼ë¬¸ ê°€ê²© ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ (ë†’ì€ ê°€ê²© â†’ ë‚®ì€ ê°€ê²©)
      const mergedBuyOrders = [...mainBuyOrders, ...declineOrders].sort((a, b) => b.price - a.price);

      // Buy orders (main + decline merged, sorted by price desc)
      const buyOrdersEl = document.getElementById('buy-orders');
      buyOrdersEl.innerHTML = mergedBuyOrders.map(order => renderOrderCard(order, 'buy')).join('');

      // Sell orders
      const sellOrdersEl = document.getElementById('sell-orders');
      if (quarterStopLoss.active) {
        sellOrdersEl.innerHTML = '<p class="text-gray-500 text-sm">ì¿¼í„°ì†ì ˆ ëª¨ë“œ - ì•„ë˜ ì•ˆë‚´ ì°¸ì¡°</p>';
      } else {
        // ğŸ”´ FIX: ë§¤ë„ ì£¼ë¬¸ ê°€ê²© ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ (ì§€ì •ê°€ ë§¤ë„ â†’ LOC ë§¤ë„)
        const sortedSellOrders = [...sellOrders].sort((a, b) => b.price - a.price);
        sellOrdersEl.innerHTML = sortedSellOrders.map(order => renderOrderCard(order, 'sell')).join('');
      }

      // Quarter stop loss warning (#216: ì²´í¬ë°•ìŠ¤ ì—°ë™)
      const qslSection = document.getElementById('quarter-stop-loss');
      const qslCheckbox = document.getElementById('quarter-stop-checkbox');
      const qslMocQty = document.getElementById('quarter-moc-qty');

      if (quarterStopLoss.active) {
        qslSection.classList.remove('hidden');
        qslCheckbox.checked = false;  // ê¸°ë³¸ê°’: ì²´í¬ í•´ì œ (ì‚¬ìš©ìê°€ ì§ì ‘ ì²´í¬í•´ì•¼ MOC ì•ˆë‚´ í‘œì‹œ)
        qslMocQty.textContent = `${quarterStopLoss.mocQuantity}ì£¼`;
        document.getElementById('quarter-stop-loss-content').innerHTML = `
          <p><strong>MOC ë§¤ë„ ìˆ˜ëŸ‰:</strong> ${quarterStopLoss.mocQuantity}ì£¼</p>
          <ul class="list-disc pl-5 mt-2">
            ${quarterStopLoss.instructions.map(i => `<li>${i}</li>`).join('')}
          </ul>
        `;
        // ì²´í¬ë°•ìŠ¤ ìƒíƒœì— ë”°ë¼ ë‚´ìš© ìˆ¨ê¹€/í‘œì‹œ
        handleQuarterStopChange();
      } else {
        qslSection.classList.add('hidden');
      }

      // Show today buy helper
      const totalBuyQty = mergedBuyOrders.reduce((sum, o) => sum + o.quantity, 0);
      showTodayBuyHelper(totalBuyQty, result.ticker);

      // Display results based on screen size (PC vs Mobile)
      showResultsResponsive();
    }

    /**
     * ğŸ”´ v4.28.0: ë‹¤ì¤‘ ì¢…ëª© ê²°ê³¼ í‘œì‹œ (#217)
     * @param {Array} results - ê³„ì‚° ê²°ê³¼ ë°°ì—´
     */
    function displayMultipleResults(results) {
      const section = document.getElementById('multi-results-section');
      const accordion = document.getElementById('results-accordion');
      const resultsColumn = document.getElementById('results-column');
      const resultsPC = document.getElementById('results-pc');
      closeResultsOverlay();

      if (!results || results.length === 0) {
        section.classList.add('hidden');
        if (resultsColumn) {
          resultsColumn.classList.add('hidden');
          resultsColumn.style.display = 'none';
        }
        return;
      }

      // ë‹¨ì¼ ê²°ê³¼ì¼ ë•ŒëŠ” ê¸°ì¡´ UI ì‚¬ìš©
      if (results.length === 1) {
        section.classList.add('hidden');
        if (resultsColumn) {
          resultsColumn.classList.remove('hidden');
          resultsColumn.style.display = '';
        }
        displayResults(results[0]);
        return;
      }

      // ë‹¤ì¤‘ ê²°ê³¼: ì•„ì½”ë””ì–¸ í‘œì‹œ
      section.classList.remove('hidden');
      if (resultsColumn) {
        resultsColumn.classList.add('hidden');
        resultsColumn.style.display = 'none';
      }
      if (resultsPC) {
        resultsPC.innerHTML = '';
      }

      // ê¸°ì¡´ ë‹¨ì¼ ê²°ê³¼ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
      document.getElementById('results-section').classList.add('hidden');

      // ğŸ”´ FIX: ì¢…ëª© ì •ë ¬ â€” TQQQ(1) â†’ SOXL(2) â†’ ë‚˜ë¨¸ì§€ ì•ŒíŒŒë²³
      const sortedResults = [...results].sort((a, b) => {
        const priority = { 'TQQQ': 0, 'SOXL': 1 };
        const aP = priority[a.ticker] ?? 2;
        const bP = priority[b.ticker] ?? 2;
        if (aP !== bP) return aP - bP;
        return a.ticker.localeCompare(b.ticker);
      });

      // ğŸ”´ v4.49.2 FIX: sortedResults ì„ ì–¸ í›„ lastCalculation í• ë‹¹ (TDZ ë²„ê·¸ ìˆ˜ì •)
      lastCalculation = sortedResults[0];

      // ì•„ì½”ë””ì–¸ ì•„ì´í…œ ìƒì„±
      accordion.innerHTML = sortedResults.map((result) => {
        const { ticker, calculation, buyOrders, sellOrders, quarterStopLoss, input } = result;
        const { T, phase, starPercent, locInfo } = calculation;
        const avgPrice = input?.avgPrice || 0;
        const totalInvested = input?.totalInvested || 0;
        const oneTimeBuy = calculation.oneTimeBuy || 0;
        const parsedSellPercent = parseFloat(input?.sellPercent);
        const effectiveSellPercent = Number.isFinite(parsedSellPercent)
          ? parsedSellPercent
          : IBCalculator.getSellPercent(ticker);
        const starPrice = locInfo.starPrice || 0;
        const locSellPrice = IBCalculator.getSellLOCPrice(locInfo.locPrice || 0, avgPrice);
        const limitPrice = avgPrice * (1 + effectiveSellPercent / 100);

        // Phase badge í´ë˜ìŠ¤
        let phaseBadgeClass = 'accordion-badge-first';
        if (phase === 'í›„ë°˜ì „') phaseBadgeClass = 'accordion-badge-second';
        else if (phase === 'ì†ì ˆ') phaseBadgeClass = 'accordion-badge-stop';

        // ì£¼ë¬¸ ë¶„ë¦¬ ë° ì •ë ¬ (ë†’ì€ ê°€ê²© â†’ ë‚®ì€ ê°€ê²©)
        const mainBuyOrders = buyOrders.filter(o => !o.type.includes('í•˜ë½ëŒ€ë¹„'));
        const declineOrders = buyOrders.filter(o => o.type.includes('í•˜ë½ëŒ€ë¹„'));
        // ğŸ”´ FIX: ë§¤ìˆ˜ ì£¼ë¬¸ ê°€ê²© ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
        const mergedBuyOrders = [...mainBuyOrders, ...declineOrders].sort((a, b) => b.price - a.price);

        // ì•„ì½”ë””ì–¸ ì•„ì´í…œ HTML
        return `
          <div class="accordion-item open" data-ticker="${ticker}">
            <div class="accordion-header" onclick="toggleAccordion('${ticker}')">
              <div class="flex items-center gap-2">
                <span class="font-bold text-lg">${ticker}</span>
                <span class="accordion-badge ${phaseBadgeClass}">${phase}</span>
              </div>
              <div class="flex items-center gap-4">
                <span class="text-sm text-slate-300">T=${T.toFixed(1)}</span>
                <i class="fas fa-chevron-down accordion-chevron"></i>
              </div>
            </div>
            <div class="accordion-content">
              <!-- Summary -->
              <div class="grid grid-cols-3 gap-2 mb-3 text-center">
                <div class="bg-white rounded-lg p-2 shadow-sm">
                  <div class="text-xs text-gray-500">ë³„%</div>
                  <div class="font-semibold">${starPercent.toFixed(1)}%</div>
                </div>
                <div class="bg-white rounded-lg p-2 shadow-sm">
                  <div class="text-xs text-gray-500">1íšŒë§¤ìˆ˜</div>
                  <div class="font-semibold">${IBCalculator.formatDollar(calculation.oneTimeBuy)}</div>
                </div>
                <div class="bg-white rounded-lg p-2 shadow-sm">
                  <div class="text-xs text-gray-500">LOCê°€</div>
                  <div class="font-semibold">${IBCalculator.formatDollar(locInfo.locPrice)}</div>
                </div>
              </div>

              <!-- Buy Orders -->
              <div class="order-section">
                <div class="order-section-header">
                  <span class="order-section-title"><i class="fas fa-arrow-down text-green-500 mr-1"></i>ë§¤ìˆ˜ (LOC)</span>
                </div>
                <div class="space-y-1 text-sm">
                  ${mergedBuyOrders.map(o => `
                    <div class="flex justify-between bg-white rounded px-2 py-1 items-center">
                      <span class="text-gray-600">${formatOrderLabel(o)}</span>
                      <div class="flex items-center gap-2">
                        <button class="order-copy-btn qty-copy-btn" onclick="copyQuantityValue(this, ${o.quantity})">
                          ${o.quantity}ì£¼
                        </button>
                        <span class="text-gray-400 text-xs">x</span>
                        <button class="order-copy-btn" onclick="copyPriceValue(this, ${Number(o.price || 0)})">
                          ${formatOrderPrice(o.price)}
                        </button>
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>

              <!-- Sell Orders -->
              <div class="order-section">
                <div class="order-section-header">
                  <span class="order-section-title"><i class="fas fa-arrow-up text-red-500 mr-1"></i>ë§¤ë„</span>
                </div>
                ${quarterStopLoss.active ? `
                <div class="bg-red-50 border border-red-200 rounded p-2 text-sm text-red-700">
                  <i class="fas fa-exclamation-triangle mr-1"></i>ì¿¼í„°ì†ì ˆ: MOC ${quarterStopLoss.mocQuantity}ì£¼ ë§¤ë„
                </div>
                ` : `
                <div class="space-y-1 text-sm">
                  ${/* ğŸ”´ FIX: ë§¤ë„ ì£¼ë¬¸ ê°€ê²© ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ (ì§€ì •ê°€ ë§¤ë„ â†’ LOC ë§¤ë„) */ [...sellOrders].sort((a, b) => b.price - a.price).map(o => `
                    <div class="flex justify-between bg-white rounded px-2 py-1 items-center">
                      <span class="text-gray-600">${formatOrderLabel(o)}</span>
                      <div class="flex items-center gap-2">
                        <button class="order-copy-btn qty-copy-btn" onclick="copyQuantityValue(this, ${o.quantity})">
                          ${o.quantity}ì£¼
                        </button>
                        <span class="text-gray-400 text-xs">x</span>
                        <button class="order-copy-btn" onclick="copyPriceValue(this, ${Number(o.price || 0)})">
                          ${formatOrderPrice(o.price)}
                        </button>
                      </div>
                    </div>
                  `).join('')}
                </div>
                `}
              </div>
              <div class="flex justify-end mt-3">
                <button class="px-3 py-1 text-xs font-semibold text-blue-600 bg-blue-50 rounded-full hover:bg-blue-100"
                        onclick="toggleMultiFormula('${ticker}', this)">
                  <i class="fas fa-microscope mr-1"></i>ìƒì„¸ ë³´ê¸°
                </button>
              </div>
              <div id="formula-detail-${ticker}" class="hidden mt-2 bg-white rounded-lg border border-gray-100 p-2 text-sm text-gray-600 space-y-1">
                <div class="font-semibold text-gray-500">ê³µì‹ ìš”ì•½</div>
                <div>T = ceil((ì´ë§¤ì…ê¸ˆ / 1íšŒë§¤ìˆ˜) Ã— 10) / 10 = ceil((${IBCalculator.formatDollar(totalInvested)} / ${IBCalculator.formatDollar(oneTimeBuy)}) Ã— 10) / 10 â†’ ${T.toFixed(1)}</div>
                <div>ë³„% = ${effectiveSellPercent}% Ã— (1 - T / 20) = ${effectiveSellPercent}% Ã— (1 - ${T.toFixed(1)} / 20) â†’ ${starPercent.toFixed(1)}%</div>
                <div>LOC ë§¤ë„ê°€ = ë³„%ê°€ + (í‰ë‹¨ê°€ Ã— 0.5%) = ${IBCalculator.formatDollar(starPrice)} + (${IBCalculator.formatDollar(avgPrice)} Ã— 0.005) â†’ ${IBCalculator.formatDollar(locSellPrice)}</div>
                <div>ì§€ì •ê°€ = í‰ë‹¨ê°€ Ã— (1 + AFTER%) = ${IBCalculator.formatDollar(avgPrice)} Ã— (1 + ${effectiveSellPercent}%) â†’ ${IBCalculator.formatDollar(limitPrice)}</div>
              </div>
            </div>
          </div>
        `;
      }).join('');

      // Mobile: ê²°ê³¼ ì„¹ì…˜ìœ¼ë¡œ ìë™ ìŠ¤í¬ë¡¤
      if (window.innerWidth < 768) {
        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      // ğŸ”´ Bug 2 ìˆ˜ì •: ë‹¤ì¤‘ ì¢…ëª© ê³„ì‚° ì‹œ ì˜¤ëŠ˜ ë§¤ìˆ˜ í—¬í¼ í‘œì‹œ
      // ì „ì²´ ì¢…ëª©ì˜ ì´ ë§¤ìˆ˜ëŸ‰ í•©ì‚°
      const totalBuyQty = sortedResults.reduce((sum, r) =>
        sum + (r.buyOrders || []).reduce((s, o) => s + o.quantity, 0), 0);
      // ì²« ë²ˆì§¸ ì¢…ëª© tickerë¡œ ì–´ì œ ë§¤ìˆ˜ ë¹„êµ í‘œì‹œ (ì •ë ¬ëœ ì²« ë²ˆì§¸ = TQQQ ë˜ëŠ” ìš°ì„ ìˆœìœ„ 1ìœ„)
      showTodayBuyHelper(totalBuyQty, sortedResults[0]?.ticker);
    }

    /**
     * ğŸ”´ v4.28.0: ì•„ì½”ë””ì–¸ í† ê¸€ (#217)
     */
    function toggleAccordion(ticker) {
      const item = document.querySelector(`.accordion-item[data-ticker="${ticker}"]`);
      if (item) {
        item.classList.toggle('open');
      }
    }

    function toggleMultiFormula(ticker, button) {
      const detail = document.getElementById(`formula-detail-${ticker}`);
      if (!detail) return;

      const isHidden = detail.classList.contains('hidden');
      detail.classList.toggle('hidden');
      if (button) {
        button.innerHTML = isHidden
          ? '<i class="fas fa-chevron-up mr-1"></i>ì ‘ê¸°'
          : '<i class="fas fa-microscope mr-1"></i>ìƒì„¸ ë³´ê¸°';
      }
    }

    /**
     * ì•„ì½”ë””ì–¸ì—ì„œ ìƒì„¸ ë³´ê¸° â†’ ë‹¨ì¼ ìƒì„¸ íŒ¨ë„ í‘œì‹œ
     */
    // ë‹¤ì¤‘ ì¹´ë“œ ë‚´ ê³µì‹ ìš”ì•½ í† ê¸€

    /**
     * ğŸ”´ v4.28.0: ì „ì²´ ì¢…ëª© ì£¼ë¬¸ ë³µì‚¬ (#217)
     * ğŸ”´ v4.29.4 (C-08): copyToClipboard ì‚¬ìš©
     */
    async function copyAllTickersOrders() {
      if (Object.keys(calculationResults).length === 0) {
        showToast('ë¨¼ì € ì „ì²´ ê³„ì‚°ì„ ì‹¤í–‰í•˜ì„¸ìš”', 'warning');
        return;
      }

      await ensureCashReservePrices();

      const profileName = currentProfile?.name || 'í”„ë¡œí•„';
      // ğŸ”´ v4.41.1: í•œêµ­ì‹œê°„ ë‚ ì§œ ì¶”ê°€
      const kstDate = new Date().toLocaleDateString('ko-KR', {
        timeZone: 'Asia/Seoul',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      }).replace(/\. /g, '-').replace('.', '');  // "2026. 02. 05." â†’ "2026-02-05"
      const lines = [
        `ğŸ“Š ${profileName} ì˜¤ëŠ˜ì˜ ì£¼ë¬¸ (${kstDate})`,
        ORDER_COPY_DIVIDER
      ];

      const balanceInfo = (typeof BalanceManager !== 'undefined' && currentProfile)
        ? BalanceManager.getBalance(currentProfile.id)
        : { available: 0 };
      const balanceValue = parseFloat(balanceInfo?.available) || 0;

      let dailyBuyTotal = 0;
      Object.values(calculationResults).forEach(result => {
        const buyOrders = result?.buyOrders || [];
        buyOrders.forEach(order => {
          if (!order || !order.type) return;
          const price = parseFloat(order.price) || 0;
          const qty = parseFloat(order.quantity) || 0;
          dailyBuyTotal += price * qty;
        });
      });

      if (dailyBuyTotal > 0) {
        if (balanceValue < dailyBuyTotal) {
          lines.push(`âš ï¸ ì˜¤ëŠ˜ ë§¤ìˆ˜ ë¶€ì¡±! í•„ìš” $${dailyBuyTotal.toFixed(3)}, í˜„ì¬ $${balanceValue.toFixed(3)}`);
        } else {
          const days = Math.floor(balanceValue / dailyBuyTotal);
          lines.push(`ğŸ’° ì˜ˆìˆ˜ê¸ˆ: $${balanceValue.toFixed(3)} | ì•½ ${days}ì¼ ê°€ëŠ¥`);
          // v4.49.3: Tomorrow shortage check
          const remainingAfterToday = balanceValue - dailyBuyTotal;
          if (remainingAfterToday < dailyBuyTotal) {
            const tomorrowShortfall = dailyBuyTotal - remainingAfterToday;
            lines.push(`âš ï¸ ë‚´ì¼ ë§¤ìˆ˜ ë¶€ì¡±! ë¶€ì¡±ê¸ˆì•¡: $${tomorrowShortfall.toFixed(3)}`);
          }
        }
      }

      const cashAction = buildCashReserveAction({ balanceValue, dailyBuyTotal });
      if (cashAction) {
        const verb = cashAction.side === 'BUY' ? 'ë§¤ìˆ˜' : 'ë§¤ë„';
        const orderType = cashAction.side === 'BUY' ? 'ì¦‰ì‹œ' : 'MOC';
        lines.push('', 'ğŸ’µ í˜„ê¸ˆì„± ìì‚°');
        lines.push(`  ${cashAction.symbol} ${verb} (${orderType}): ${cashAction.quantity}ì£¼`);
      }

      lines.push('');

      // D: ì¢…ëª© ìˆœì„œ â€” TQQQ(1) â†’ SOXL(2) â†’ ë‚˜ë¨¸ì§€ ì•ŒíŒŒë²³
      const sortedTickers = Object.entries(calculationResults).sort(([a], [b]) => {
        const priority = { 'TQQQ': 0, 'SOXL': 1 };
        const aP = priority[a] ?? 2;
        const bP = priority[b] ?? 2;
        if (aP !== bP) return aP - bP;
        return a.localeCompare(b);
      });

      for (const [ticker, result] of sortedTickers) {
        const { buyOrders, sellOrders, quarterStopLoss, calculation, input } = result;
        // A: í‰ë‹¨ ì¶”ê°€
        const avgPrice = computeAvgPrice(input?.totalInvested || 0, input?.holdings || 0);
        const headerLine = `ã€${ticker}ã€‘ í‰ë‹¨ $${formatOrderPrice(avgPrice)} | T=${calculation.T.toFixed(1)} | íˆ¬ìê¸ˆ ${formatDollarShort(input?.principal)}`;

        lines.push(headerLine);
        lines.push(`  ${formatAdditionalBuyPolicy(input, calculation.oneTimeBuy)}`);
        // B: ë§¤ìˆ˜ ê°€ê²© ë‚´ë¦¼ì°¨ìˆœ
        const sortedBuy = [...buyOrders].sort((a, b) => b.price - a.price);
        lines.push('ğŸŸ¢ BUY (LOC)');
        lines.push(...sortedBuy.map(o => formatOrderLine(o)));

        if (quarterStopLoss && quarterStopLoss.active) {
          lines.push('ğŸ”´ ì¿¼í„°ì†ì ˆ (MOC)');
          lines.push(`  MOC ë§¤ë„: ${quarterStopLoss.mocQuantity}ì£¼`);
        } else {
          // C: ë§¤ë„ ì§€ì •ê°€ ë¨¼ì €, ê·¸ë£¹ ë‚´ ê°€ê²© ë‚´ë¦¼ì°¨ìˆœ
          const sortedSell = [...sellOrders].sort((a, b) => {
            const aIsLimit = (a.type || '').includes('ì§€ì •ê°€');
            const bIsLimit = (b.type || '').includes('ì§€ì •ê°€');
            if (aIsLimit !== bIsLimit) return aIsLimit ? -1 : 1;
            return b.price - a.price;
          });
          lines.push('ğŸ”´ SELL');
          lines.push(...sortedSell.map(o => formatOrderLine(o)));
        }

        lines.push('');
      }

      lines.push(ORDER_COPY_DIVIDER);

      const text = lines.join('\n');
      const success = await copyToClipboard(text);
      if (success) {
        showToast('ì „ì²´ ì¢…ëª© ì£¼ë¬¸ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
      } else {
        showToast('ë³µì‚¬ ì‹¤íŒ¨', 'error');
      }
    }

    /**
     * v4.23.0: ê³µì‹ ìƒì„¸ í† ê¸€
     */
    function toggleFormulaDetails() {
      const detailsEl = document.getElementById('formula-details');
      const iconEl = document.getElementById('formula-toggle-icon');
      const textEl = document.getElementById('formula-toggle-text');

      if (detailsEl.classList.contains('hidden')) {
        detailsEl.classList.remove('hidden');
        iconEl.className = 'fas fa-chevron-up mr-1';
        textEl.textContent = 'ì ‘ê¸°';
      } else {
        detailsEl.classList.add('hidden');
        iconEl.className = 'fas fa-chevron-down mr-1';
        textEl.textContent = 'ê³µì‹ ìƒì„¸';
      }
    }

    /**
     * v4.23.0: ê³µì‹ ìƒì„¸ ì—…ë°ì´íŠ¸ (ì‹¤ì œ ê³„ì‚°ê°’ í‘œì‹œ)
     * @param {Object} result - ê³„ì‚° ê²°ê³¼
     */
    function updateFormulaDetails(result) {
      const { input, calculation } = result;
      const { T, starPercent, oneTimeBuy, locInfo } = calculation;

      // ì‹¤ì œ ì…ë ¥ê°’ìœ¼ë¡œ ê³µì‹ í‘œì‹œ
      const totalInvested = input.totalInvested || 0;
      const avgPrice = input.avgPrice;
      const parsedSellPercent = parseFloat(document.getElementById('input-sellPercent')?.value);
      const effectiveSellPercent = Number.isFinite(parsedSellPercent) ? parsedSellPercent : 10;

      // Tê°’ ê³µì‹
      const tFormulaEl = document.getElementById('formula-T');
      if (tFormulaEl) {
        const rawT = totalInvested / oneTimeBuy;
        tFormulaEl.innerHTML = `T = ceil((${totalInvested.toFixed(0)} / ${oneTimeBuy.toFixed(0)}) Ã— 10) / 10<br>
          <span class="text-green-400">= ceil(${(rawT * 10).toFixed(1)}) / 10 = ${T.toFixed(1)}</span>`;
      }

      // ë³„% ê³µì‹
      const starFormulaEl = document.getElementById('formula-star');
      if (starFormulaEl) {
        starFormulaEl.innerHTML = `ë³„% = ${effectiveSellPercent}% Ã— (1 - T / 20) = ${effectiveSellPercent}% Ã— (1 - ${T.toFixed(1)} / 20)<br>
          <span class="text-yellow-400">= ${starPercent.toFixed(1)}%</span>`;
      }

      // LOC ë§¤ë„ê°€ ê³µì‹
      const locSellEl = document.getElementById('formula-locSell');
      if (locSellEl) {
        const starPrice = locInfo.starPrice;
        const locSellPrice = starPrice + (avgPrice * 0.005);
        locSellEl.innerHTML = `LOC ë§¤ë„ = ë³„%ê°€ + (í‰ë‹¨ Ã— 0.5%)<br>
          = $${formatPrice(starPrice)} + ($${formatPrice(avgPrice)} Ã— 0.005)<br>
          <span class="text-blue-400">= $${formatPrice(locSellPrice)}</span>`;
      }

      // ì§€ì •ê°€ ë§¤ë„ ê³µì‹
      const limitSellEl = document.getElementById('formula-limitSell');
      if (limitSellEl) {
        const limitPrice = avgPrice * (1 + effectiveSellPercent / 100);
        limitSellEl.innerHTML = `ì§€ì •ê°€ = í‰ë‹¨ê°€ Ã— (1 + AFTER%)<br>
          = $${formatPrice(avgPrice)} Ã— (1 + ${effectiveSellPercent}%)<br>
          <span class="text-red-400">= $${formatPrice(limitPrice)}</span>`;
      }
    }

    /**
     * PC/Mobile ë°˜ì‘í˜• ê²°ê³¼ í‘œì‹œ
     * ğŸ”´ v4.22.0: results-sectionì€ í•­ìƒ hidden (ë³µì‚¬ìš© í…œí”Œë¦¿)
     */
    function showResultsResponsive() {
      const resultsSection = document.getElementById('results-section');
      const resultsPC = document.getElementById('results-pc');
      const resultsMobile = document.getElementById('results-mobile');
      const resultsOverlay = document.getElementById('results-overlay');
      const resultsColumn = document.getElementById('results-column');

      // ğŸ”´ v4.49.3: null ì²´í¬
      if (!resultsSection || !resultsPC || !resultsMobile || !resultsOverlay || !resultsColumn) {
        console.error('showResultsResponsive: Missing DOM elements');
        return;
      }

      // ğŸ”´ v4.22.0: results-sectionì€ í•­ìƒ ìˆ¨ê¹€ (ë³µì‚¬ìš© í…œí”Œë¦¿)
      resultsSection.classList.add('hidden');

      // Check if PC (md breakpoint = 768px)
      const isPC = window.innerWidth >= 768;

      if (isPC) {
        // PC: Show in right column, HIDE mobile overlay
        resultsPC.innerHTML = resultsSection.innerHTML;
        resultsColumn.classList.remove('hidden');
        resultsColumn.style.display = '';
        resultsPC.querySelector('.text-center.text-gray-400')?.remove();
        // Mobile ê²°ê³¼ ìˆ¨ê¸°ê¸°
        resultsOverlay.classList.add('hidden');
        document.body.style.overflow = '';
      } else {
        // Mobile: Show in overlay, HIDE PC column
        resultsMobile.innerHTML = resultsSection.innerHTML;
        resultsOverlay.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        // PC ê²°ê³¼ ì´ˆê¸°í™”
        resultsPC.innerHTML = `
          <div class="text-center text-gray-400 py-8">
            <i class="fas fa-calculator text-4xl mb-2"></i>
            <p>ì£¼ë¬¸ ê³„ì‚° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</p>
          </div>
        `;
        resultsColumn.classList.add('hidden');
        resultsColumn.style.display = 'none';
      }
    }

    /**
     * ëª¨ë°”ì¼ ê²°ê³¼ ì˜¤ë²„ë ˆì´ ë‹«ê¸°
     */
    function closeResultsOverlay() {
      document.getElementById('results-overlay').classList.add('hidden');
      document.body.style.overflow = ''; // Restore scroll
    }

    function formatPrice(value, digits = 4) {
      const numeric = Number(value);
      if (!Number.isFinite(numeric)) return (0).toFixed(digits);
      return numeric.toFixed(digits);
    }

    function formatOrderLabel(order) {
      const rawType = String(order?.type || '').trim();
      if (rawType.startsWith('í•˜ë½ëŒ€ë¹„ ì¶”ê°€ë§¤ìˆ˜')) {
        const match = rawType.match(/(\d+)$/);
        return match ? `ì¶”ê°€-í•˜ë½LOC #${match[1]}` : 'ì¶”ê°€-í•˜ë½LOC';
      }
      if (rawType === 'í‰ë‹¨LOC ë§¤ìˆ˜') {
        return 'ê¸°ë³¸-í‰ë‹¨LOC';
      }
      if (rawType === 'í°ìˆ˜LOC ë§¤ìˆ˜') {
        return 'ê¸°ë³¸-í°ìˆ˜LOC';
      }
      if (rawType.startsWith('ì§€ì •ê°€ ë§¤ë„')) {
        return 'ì§€ì •ê°€ ë§¤ë„';
      }
      return rawType || order?.description || '';
    }

    function formatOrderPrice(price) {
      return formatPrice(price, 2);  // ì£¼ë¬¸ ê°€ê²©ì€ 2ìë¦¬ë¡œ í‘œì‹œ
    }

    function renderOrderCard(order, type) {
      const isLOC = order.orderType === 'LOC';
      const badgeClass = isLOC ? 'badge-loc' : 'badge-limit';
      const badgeText = isLOC ? 'LOC' : 'ì§€ì •ê°€';
      const label = formatOrderLabel(order);
      const qtyText = `${order.quantity}ì£¼`;
      const priceText = `$${formatOrderPrice(order.price)}`;

      // v4.22.0: ì¶•ì†Œëœ ì¹´ë“œ (í•œ ì¤„)
      return `
        <div class="order-card-compact flex items-center justify-between py-2 px-3 bg-gray-50 rounded-lg" data-price="${order.price}" data-qty="${order.quantity}">
          <div class="flex items-center gap-2">
            <span class="order-badge ${badgeClass} text-xs">${badgeText}</span>
            <span class="text-xs text-gray-600">${label}</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-gray-500 text-sm">${qtyText}</span>
            <span class="text-gray-400 text-xs">x</span>
            <span class="font-bold text-gray-800">${priceText}</span>
            <button onclick="copyOrder(this, '${order.price}', ${order.quantity})" class="copy-btn text-gray-400 hover:text-gray-600">
              <i class="fas fa-copy"></i>
            </button>
          </div>
        </div>
      `;
    }

    // =====================================================
    // Balance Management (Phase 3)
    // =====================================================

    function loadBalanceData() {
      if (!currentProfile) return;

      const balance = BalanceManager.getBalance(currentProfile.id);
      const balanceInput = document.getElementById('input-balance');
      const commissionInput = document.getElementById('input-commission');
      const commissionRate = BalanceManager.getCommissionRate(currentProfile.id);

      // ğŸ”´ v4.30.0 (B5-14): í•­ìƒ ê°’ ì„¤ì • (ì´ì „ í”„ë¡œí•„ ê°’ ëˆ„ìˆ˜ ë°©ì§€)
      // ê¸°ì¡´: balance > 0ì¼ ë•Œë§Œ ì„¤ì • â†’ ì´ì „ ê°’ ìœ ì§€ë¨
      // ğŸ”´ FIX: ì˜ˆìˆ˜ê¸ˆ 3ìë¦¬, ìˆ˜ìˆ˜ë£Œ 2ìë¦¬ ì œí•œ
      balanceInput.value = Number.isFinite(balance.available) ? parseFloat(balance.available).toFixed(3) : '';

      if (commissionInput) {
        const effectiveRate = (commissionRate !== null && commissionRate !== undefined)
          ? commissionRate
          : 0.07;
        commissionInput.value = effectiveRate.toFixed(2);  // ğŸ”´ FIX: ìˆ˜ìˆ˜ë£Œ 2ìë¦¬
        if (commissionRate === null || commissionRate === undefined) {
          BalanceManager.updateCommissionRate(currentProfile.id, effectiveRate);
        }
      }

      // 0/ìŒìˆ˜ë„ ë™ê¸°í™” ëŒ€ìƒì´ë¯€ë¡œ ìˆ«ìë©´ ìƒíƒœë¥¼ ì¬ê³„ì‚°í•œë‹¤.
      if (Number.isFinite(balance.available)) {
        recalculateBalance();
      }
    }

    function handleBalanceChange(value) {
      if (!currentProfile) return;

      // ğŸ”´ v4.29.6 (#30): ì…ë ¥ê°’ ë²”ìœ„ ê²€ì¦
      let numValue = parseFloat(value) || 0;
      if (!Number.isFinite(numValue)) numValue = 0;
      if (numValue < -10000000) numValue = -10000000;
      if (numValue > 10000000) numValue = 10000000;  // ìµœëŒ€ $10M

      BalanceManager.updateBalance(currentProfile.id, numValue);
      recalculateBalance();
    }

    function handleCommissionChange(value) {
      if (!currentProfile) return;

      let numValue = parseFloat(value);
      if (!Number.isFinite(numValue)) numValue = 0;
      if (numValue < 0) numValue = 0;

      BalanceManager.updateCommissionRate(currentProfile.id, numValue);
    }

    function buildCalculatedOrderStatus(resultsMap, balanceValue) {
      const details = [];
      let required = 0;

      Object.values(resultsMap).forEach(result => {
        const mainBuyOrders = result.buyOrders.filter(o => !o.type.includes('í•˜ë½ëŒ€ë¹„'));
        const declineOrders = result.buyOrders.filter(o => o.type.includes('í•˜ë½ëŒ€ë¹„'));
        const mainAmount = mainBuyOrders.reduce((sum, o) => sum + (o.price * o.quantity), 0);
        const declineAmount = declineOrders.reduce((sum, o) => sum + (o.price * o.quantity), 0);
        const total = mainAmount + declineAmount;
        required += total;

        details.push({
          symbol: result.ticker,
          oneTimeBuy: mainAmount,
          additionalAmount: declineAmount,
          total: total,
          percentage: 0
        });
      });

      details.forEach(d => {
        d.percentage = required > 0 ? parseFloat((d.total / required * 100).toFixed(1)) : 0;
      });

      const diff = balanceValue - required;

      // v4.49.3: Tomorrow check â€” after today's buy, can tomorrow be covered?
      const remainingAfterToday = Math.max(0, balanceValue - required);
      const tomorrowDiff = remainingAfterToday - required;

      return {
        available: balanceValue,
        required: required,
        diff: diff,
        status: diff >= 0 ? 'OK' : 'INSUFFICIENT',
        statusKo: diff >= 0 ? 'ì—¬ìœ ' : 'ë¶€ì¡±',
        remainingAfterToday: remainingAfterToday,
        tomorrowDiff: tomorrowDiff,
        tomorrowStatus: tomorrowDiff >= 0 ? 'OK' : 'INSUFFICIENT',
        tomorrowShortfall: tomorrowDiff < 0 ? Math.abs(tomorrowDiff) : 0,
        details
      };
    }

    function recalculateBalance() {
      if (!currentProfile) return;

      // Save current balance value
      const rawBalanceValue = parseFloat(document.getElementById('input-balance').value);
      const balanceValue = Number.isFinite(rawBalanceValue) ? rawBalanceValue : 0;
      BalanceManager.updateBalance(currentProfile.id, balanceValue);

      const commissionInput = document.getElementById('input-commission');
      if (commissionInput) {
        const commissionValue = parseFloat(commissionInput.value);
        if (Number.isFinite(commissionValue)) {
          BalanceManager.updateCommissionRate(currentProfile.id, commissionValue);
        }
      }

      // ğŸ”´ v4.18.0: ìµœì‹  í”„ë¡œí•„ ë°ì´í„°ë¡œ ê³„ì‚° (Bug 13 - ë©”ëª¨ë¦¬ ìºì‹œ ë¬¸ì œ ìˆ˜ì •)
      // currentProfileì€ ë©”ëª¨ë¦¬ì— ìºì‹œëœ old ë°ì´í„°ì´ë¯€ë¡œ localStorageì—ì„œ ìµœì‹  ë°ì´í„° ê°€ì ¸ì˜´
      let status = null;
      if (Object.keys(calculationResults).length > 0) {
        status = buildCalculatedOrderStatus(calculationResults, balanceValue);
      } else {
        const freshProfile = ProfileManager.getAll().profiles[currentProfile.id];
        status = BalanceManager.calcOrderStatus(freshProfile);
      }
      renderOrderStatus(status);
      updateCashReserveRecommendation(status);
      checkAndShowAlert(status);
    }

    function renderOrderStatus(status) {
      const statusBox = document.getElementById('order-status');
      const breakdownBox = document.getElementById('stock-breakdown');

      // Only show if balance is set
      if (status.available === 0 && status.required <= 0) {
        statusBox.classList.add('hidden');
        breakdownBox.classList.add('hidden');
        return;
      }

      statusBox.classList.remove('hidden');
      const statusClass = status.status === 'OK' ? 'status-ok' : 'status-warning';
      const statusIcon = status.status === 'OK' ? 'âœ…' : 'âš ï¸';

      // ğŸ”´ v4.22.0: íˆ¬ì ê°€ëŠ¥ ì¼ìˆ˜ ê³„ì‚°
      const daysRemaining = status.required > 0 ? Math.floor(status.available / status.required) : 0;
      const daysText = daysRemaining > 0 ? `ì•½ ${daysRemaining}ì¼ íˆ¬ì ê°€ëŠ¥` : '';

      statusBox.innerHTML = `
        <div class="status-row">
          <span class="text-gray-600">ì¼ë§¤ìˆ˜ì‹œë„ê¸ˆì•¡</span>
          <span class="font-medium">$${status.required.toFixed(2)}</span>
        </div>
        <div class="status-row">
          <span class="text-gray-600">ì£¼ë¬¸ê°€ëŠ¥ê¸ˆì•¡</span>
          <span class="font-medium">$${status.available.toFixed(3)}</span>
        </div>
        <hr class="my-1 border-gray-200">
        <div class="status-row ${statusClass}">
          <span>ì°¨ì•¡</span>
          <span>${status.diff >= 0 ? '+' : ''}$${status.diff.toFixed(3)} ${statusIcon} ${status.statusKo}</span>
        </div>
        ${daysText ? `<div class="text-xs text-center text-blue-600 mt-2 font-medium">ğŸ“… ${daysText}</div>` : ''}
        ${status.tomorrowStatus === 'INSUFFICIENT' && status.status === 'OK'
          ? `<div class="text-xs text-center text-orange-600 mt-1 font-medium">âš ï¸ ë‚´ì¼ ë§¤ìˆ˜ ë¶€ì¡± $${status.tomorrowShortfall.toFixed(2)}</div>`
          : ''}
      `;

      // Stock breakdown
      if (status.details && status.details.length > 0) {
        breakdownBox.classList.remove('hidden');
        renderStockBreakdown(status.details, status.required);
      } else {
        breakdownBox.classList.add('hidden');
      }
    }

    // =====================================================
    // Cash Reserve (P4: SGOV/BIL/BILS)
    // =====================================================

    function buildCashReserveEntryMap(entries = cashReserveEntries) {
      const map = {};
      (entries || []).forEach(entry => {
        const symbol = String(entry?.symbol || '').trim().toUpperCase();
        if (!symbol) return;
        map[symbol] = {
          symbol,
          holdings: parseFloat(entry.holdings) || 0,
          avgCost: parseFloat(entry.avgCost) || 0,
          updatedAt: entry.updatedAt || ''
        };
      });
      return map;
    }

    function getCashReserveInputs(includeEmpty = false, baseSymbols = []) {
      const baseSet = new Set(baseSymbols || []);
      return CASH_ETFS.map(symbol => {
        const holdingsEl = document.getElementById(`cash-holdings-${symbol}`);
        const avgEl = document.getElementById(`cash-avg-${symbol}`);
        return {
          symbol,
          holdings: parseFloat(holdingsEl?.value) || 0,
          avgCost: parseFloat(avgEl?.value) || 0
        };
      }).filter(entry =>
        entry.holdings > 0 ||
        entry.avgCost > 0 ||
        (includeEmpty && baseSet.has(entry.symbol))
      );
    }

    function renderCashReserveTable(entries) {
      const tbody = document.getElementById('cash-reserve-rows');
      if (!tbody) return;

      const entryMap = buildCashReserveEntryMap(entries);
      tbody.innerHTML = CASH_ETFS.map(symbol => {
        const entry = entryMap[symbol] || {};
        const holdingsValue = entry.holdings > 0 ? entry.holdings : '';
        const avgValue = entry.avgCost > 0 ? entry.avgCost : '';
        return `
          <tr>
            <td class="py-1 font-semibold">${symbol}</td>
            <td class="py-1 text-right">
              <input type="number" id="cash-holdings-${symbol}" class="w-16 text-right border rounded px-1 py-0.5 text-sm" placeholder="0" inputmode="numeric" value="${holdingsValue}">
            </td>
            <td class="py-1 text-right">
              <input type="number" id="cash-avg-${symbol}" class="w-20 text-right border rounded px-1 py-0.5 text-sm" placeholder="0.00" step="0.01" inputmode="decimal" value="${avgValue}">
            </td>
            <td class="py-1 text-right" id="cash-price-${symbol}">-</td>
            <td class="py-1 text-right" id="cash-total-${symbol}">-</td>
          </tr>
        `;
      }).join('');

      CASH_ETFS.forEach(symbol => {
        const holdingsEl = document.getElementById(`cash-holdings-${symbol}`);
        const avgEl = document.getElementById(`cash-avg-${symbol}`);
        [holdingsEl, avgEl].forEach(el => {
          if (!el) return;
          el.addEventListener('input', () => {
            updateCashReserveTotals();
            updateCashReserveRecommendation();
          });
        });
      });

      updateCashReserveTotals();
    }

    function updateCashReserveTotals() {
      let totalValue = 0;

      CASH_ETFS.forEach(symbol => {
        const holdingsEl = document.getElementById(`cash-holdings-${symbol}`);
        const priceEl = document.getElementById(`cash-price-${symbol}`);
        const totalEl = document.getElementById(`cash-total-${symbol}`);

        const holdings = parseFloat(holdingsEl?.value) || 0;
        const price = parseFloat(cashReservePrices[symbol]) || 0;
        const value = price > 0 ? price * holdings : 0;

        if (priceEl) {
          priceEl.textContent = price > 0 ? `$${formatPrice(price)}` : '-';
        }
        if (totalEl) {
          totalEl.textContent = value > 0 ? formatDollarShort(value) : '-';
        }

        totalValue += value;
      });

      const totalEl = document.getElementById('cash-reserve-total');
      if (totalEl) {
        totalEl.textContent = totalValue > 0 ? formatDollarShort(totalValue) : '$0';
      }
    }

    async function loadCashReservePrices(entries) {
      // #227: 60ì´ˆ ìºì‹œ(ë¡œì»¬) - ìµœê·¼ ì¡°íšŒë©´ ìŠ¤í‚µ
      const cacheKey = 'cashReserve_lastPriceFetch';
      const now = Date.now();
      const lastFetch = parseInt(localStorage.getItem(cacheKey) || '0', 10);
      const hasCachedPrices = CASH_ETFS.some(symbol => (cashReservePrices?.[symbol] || 0) > 0);
      if (lastFetch && (now - lastFetch) < 60000 && hasCachedPrices) {
        console.log('CashReserve prices: using cached (< 60s)');
        updateCashReserveTotals();
        return;
      }

      // DEC-165 Fix: entriesê°€ ì—†ì–´ë„ CASH_ETFS ì „ì²´ ê°€ê²© ë¡œë”©
      const symbols = (entries && entries.length > 0)
        ? [...new Set(entries.map(entry => String(entry.symbol || '').toUpperCase()))]
            .filter(symbol => CASH_ETFS.includes(symbol))
        : CASH_ETFS;

      if (symbols.length === 0) return;

      const priceUpdates = {};
      await Promise.all(symbols.map(async symbol => {
        try {
          const price = await SheetsSync.getCurrentPrice(symbol);
          if (price > 0) {
            priceUpdates[symbol] = price;
          }
        } catch (e) {
          console.warn(`CashReserve price fetch failed: ${symbol}`, e.message);
        }
      }));

      cashReservePrices = { ...cashReservePrices, ...priceUpdates };
      if (Object.keys(priceUpdates).length > 0) {
        localStorage.setItem(cacheKey, now.toString());
      }
      updateCashReserveTotals();
    }

    async function ensureCashReservePrices() {
      if (!cashReserveEntries || cashReserveEntries.length === 0) return;
      const baseSymbols = cashReserveEntries.map(entry => entry.symbol);
      const inputEntries = getCashReserveInputs(true, baseSymbols);
      const entryMap = buildCashReserveEntryMap(inputEntries.length > 0 ? inputEntries : cashReserveEntries);
      const missing = CASH_ETFS.filter(symbol => entryMap[symbol] && !(cashReservePrices[symbol] > 0));
      if (missing.length === 0) return;

      const priceUpdates = {};
      await Promise.all(missing.map(async symbol => {
        try {
          const price = await SheetsSync.getCurrentPrice(symbol);
          if (price > 0) {
            priceUpdates[symbol] = price;
          }
        } catch (e) {
          console.warn(`CashReserve price fetch failed: ${symbol}`, e.message);
        }
      }));

      cashReservePrices = { ...cashReservePrices, ...priceUpdates };
      updateCashReserveTotals();
    }

    async function loadCashReserveData() {
      const section = document.getElementById('cash-reserve-section');
      if (!section) return;

      // DEC-165: ì¸ì¦ ì•ˆ ëìœ¼ë©´ ì„¹ì…˜ ìˆ¨ê¹€ (ë¡œê·¸ì¸ í•„ìš”)
      if (typeof SheetsSync === 'undefined' || !SheetsSync.isAuthenticated() || !currentProfile) {
        section.classList.add('hidden');
        cashReserveEntries = [];
        cashReservePrices = {};
        cashReserveAction = null;
        return;
      }

      // DEC-165 Fix: ì¸ì¦ ì™„ë£Œ í›„ í•­ìƒ ì„¹ì…˜ í‘œì‹œ (Catch-22 í•´ê²°)
      section.classList.remove('hidden');

      try {
        const entries = await SheetsSync.loadCashReserve(currentProfile.id);
        if (!entries || entries.length === 0) {
          // DEC-165 Fix: ë°ì´í„° ì—†ì–´ë„ ë¹ˆ í…Œì´ë¸” ë Œë”ë§ (SGOV/BIL/BILS)
          cashReserveEntries = [];
          cashReserveAction = null;
          renderCashReserveTable([]);
          await loadCashReservePrices([]);
          return;
        }

        cashReserveEntries = entries;
        renderCashReserveTable(entries);
        await loadCashReservePrices(entries);
        updateCashReserveRecommendation();
      } catch (error) {
        console.warn('CashReserve load error:', error);
        // DEC-165 Fix: ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ ë¹ˆ í…Œì´ë¸” í‘œì‹œ (ì„¹ì…˜ ìœ ì§€)
        cashReserveEntries = [];
        cashReserveAction = null;
        renderCashReserveTable([]);
        await loadCashReservePrices([]);
      }
    }

    async function saveCashReserveData() {
      if (typeof SheetsSync === 'undefined' || !SheetsSync.isAuthenticated()) {
        showToast('Google ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤', 'warning');
        return;
      }

      try {
        const entries = getCashReserveInputs();
        await SheetsSync.saveCashReserve(entries);
        showToast('í˜„ê¸ˆì„± ìì‚° ì €ì¥ë¨', 'success', 1500);
        await loadCashReserveData();
      } catch (error) {
        console.error('CashReserve save error:', error);
        showToast('í˜„ê¸ˆì„± ìì‚° ì €ì¥ ì‹¤íŒ¨', 'error');
      }
    }

    function getDailyBuyTotalFromResults(resultsMap) {
      let total = 0;
      Object.values(resultsMap || {}).forEach(result => {
        const buyOrders = result?.buyOrders || [];
        buyOrders.forEach(order => {
          if (!order || !order.type) return;
          const price = parseFloat(order.price) || 0;
          const qty = parseFloat(order.quantity) || 0;
          total += price * qty;
        });
      });
      return total;
    }

    function getDailyBuyTotal() {
      if (Object.keys(calculationResults).length > 0) {
        return getDailyBuyTotalFromResults(calculationResults);
      }
      if (lastCalculation) {
        return getDailyBuyTotalFromResults({ [lastCalculation.ticker]: lastCalculation });
      }
      if (typeof BalanceManager !== 'undefined' && currentProfile) {
        const freshProfile = ProfileManager.getAll().profiles[currentProfile.id];
        return BalanceManager.calcDailyBuyAttempt(freshProfile).total || 0;
      }
      return 0;
    }

    function getCurrentBalanceValue() {
      const balanceInput = document.getElementById('input-balance');
      const inputValue = parseFloat(balanceInput?.value);
      if (Number.isFinite(inputValue) && inputValue > 0) return inputValue;
      const balanceInfo = (typeof BalanceManager !== 'undefined' && currentProfile)
        ? BalanceManager.getBalance(currentProfile.id)
        : { available: 0 };
      return parseFloat(balanceInfo?.available) || 0;
    }

    function pickCashReserveSymbol(entryMap, forSell) {
      const available = CASH_ETFS.filter(symbol => entryMap[symbol]);
      if (available.length === 0) return null;

      if (forSell) {
        const withHoldings = available.find(symbol => (entryMap[symbol]?.holdings || 0) > 0);
        return withHoldings || available[0];
      }

      return available[0];
    }

    /**
     * CashReserve ë§¤ìˆ˜/ë§¤ë„ ì¶”ì²œ ê³„ì‚°
     * ğŸ”´ v4.43.0 (#233): ìˆ˜ìˆ˜ë£Œìœ¨ ë°˜ì˜ (UI ì„¤ì •ê°’ ì—°ë™)
     *   - ë§¤ìˆ˜: ìˆ˜ìˆ˜ë£Œ í¬í•¨ ê°€ê²©ìœ¼ë¡œ ìˆ˜ëŸ‰ ê³„ì‚°
     *   - ë§¤ë„: ìˆ˜ìˆ˜ë£Œ ì°¨ê° í›„ ì‹¤ìˆ˜ë ¹ì•¡ìœ¼ë¡œ ìˆ˜ëŸ‰ ê³„ì‚°
     */
    function buildCashReserveAction({ balanceValue, dailyBuyTotal } = {}) {
      if (!cashReserveEntries || cashReserveEntries.length === 0 || !currentProfile) return null;

      const baseSymbols = cashReserveEntries.map(entry => entry.symbol);
      const inputEntries = getCashReserveInputs(true, baseSymbols);
      const entryMap = buildCashReserveEntryMap(inputEntries.length > 0 ? inputEntries : cashReserveEntries);
      const balance = Number.isFinite(balanceValue) ? balanceValue : getCurrentBalanceValue();
      const daily = Number.isFinite(dailyBuyTotal) ? dailyBuyTotal : getDailyBuyTotal();

      if (balance <= 0 || daily <= 0) return null;

      // ğŸ”´ v4.43.0: ìˆ˜ìˆ˜ë£Œìœ¨ ê°€ì ¸ì˜¤ê¸° (UI ì„¤ì •ê°’, ê¸°ë³¸ 0.07%)
      const commissionPercent = (typeof BalanceManager !== 'undefined')
        ? BalanceManager.getCommissionRate(currentProfile.id)
        : 0.07;
      const commissionRate = (Number.isFinite(commissionPercent) ? commissionPercent : 0.07) / 100;

      const buyThreshold = daily * 6;

      // ë§¤ìˆ˜: ì˜ˆìˆ˜ê¸ˆ > 6ì¼ì¹˜ â†’ ì´ˆê³¼ë¶„ìœ¼ë¡œ SGOV ë§¤ìˆ˜
      if (balance > buyThreshold) {
        const symbol = pickCashReserveSymbol(entryMap, false);
        if (!symbol) return null;
        const price = parseFloat(cashReservePrices[symbol]) || 0;
        if (price <= 0) return null;
        const excess = balance - buyThreshold;
        // ğŸ”´ v4.43.0: ìˆ˜ìˆ˜ë£Œ í¬í•¨ ê°€ê²©ìœ¼ë¡œ ìˆ˜ëŸ‰ ê³„ì‚°
        const priceWithCommission = price * (1 + commissionRate);
        const quantity = Math.floor(excess / priceWithCommission);
        if (quantity <= 0) return null;
        return {
          side: 'BUY',
          symbol,
          quantity,
          price,
          priceWithCommission,
          commissionRate,
          excess
        };
      }

      // ë§¤ë„: ì˜ˆìˆ˜ê¸ˆ < 1ì¼ì¹˜ â†’ SGOV ë§¤ë„í•´ì„œ í˜„ê¸ˆ í™•ë³´
      if (balance < daily) {
        const symbol = pickCashReserveSymbol(entryMap, true);
        if (!symbol) return null;
        const price = parseFloat(cashReservePrices[symbol]) || 0;
        if (price <= 0) return null;
        const shortage = daily - balance;
        // ğŸ”´ v4.43.0: ìˆ˜ìˆ˜ë£Œ ì°¨ê° í›„ ì‹¤ìˆ˜ë ¹ì•¡ìœ¼ë¡œ ìˆ˜ëŸ‰ ê³„ì‚°
        const netPriceAfterCommission = price * (1 - commissionRate);
        let quantity = Math.ceil(shortage / netPriceAfterCommission);
        if (quantity > 0) quantity += 1; // ì—¬ìœ ë¶„ 1ì£¼
        const holdings = entryMap[symbol]?.holdings || 0;
        if (holdings > 0) {
          quantity = Math.min(quantity, Math.floor(holdings));
        }
        if (quantity <= 0) return null;
        return {
          side: 'SELL',
          symbol,
          quantity,
          price,
          netPriceAfterCommission,
          commissionRate,
          shortage
        };
      }

      return null;
    }

    function updateCashReserveRecommendation(statusOverride) {
      const section = document.getElementById('cash-reserve-section');
      const recoEl = document.getElementById('cash-reserve-reco');
      if (!section || section.classList.contains('hidden')) return;

      const balanceValue = statusOverride?.available;
      const dailyBuyTotal = statusOverride?.required;
      const action = buildCashReserveAction({ balanceValue, dailyBuyTotal });
      cashReserveAction = action;

      if (!recoEl) return;
      if (!action) {
        recoEl.classList.add('hidden');
        recoEl.textContent = '';
        return;
      }

      const verb = action.side === 'BUY' ? 'ë§¤ìˆ˜' : 'ë§¤ë„';
      const orderType = action.side === 'BUY' ? 'ì¦‰ì‹œ' : 'MOC';
      recoEl.textContent = `${action.symbol} ${verb} (${orderType}): ${action.quantity}ì£¼`;
      recoEl.classList.remove('hidden');
    }

    function renderStockBreakdown(details, total) {
      const container = document.getElementById('stock-breakdown');

      let html = '<table class="breakdown-table">';
      html += '<thead><tr><th>ì¢…ëª©</th><th>1íšŒë§¤ìˆ˜</th><th>í•˜ë½ëŒ€ë¹„</th><th>í•©ê³„</th><th>ë¹„ìœ¨</th></tr></thead>';
      html += '<tbody>';

      details.forEach(d => {
        const barWidth = Math.min(d.percentage, 100);
        html += `
          <tr>
            <td class="font-medium">${d.symbol}</td>
            <td>$${d.oneTimeBuy.toFixed(0)}</td>
            <td>$${d.additionalAmount.toFixed(0)}</td>
            <td class="font-medium">$${d.total.toFixed(0)}</td>
            <td>
              <div class="bar-cell">
                <div class="bar" style="width: ${barWidth}px;"></div>
                <span class="text-gray-500">${d.percentage}%</span>
              </div>
            </td>
          </tr>
        `;
      });

      html += `
        <tr class="font-medium bg-gray-50">
          <td>í•©ê³„</td>
          <td></td>
          <td></td>
          <td>$${total.toFixed(0)}</td>
          <td>100%</td>
        </tr>
      `;
      html += '</tbody></table>';

      container.innerHTML = html;
    }

    function checkAndShowAlert(statusOverride = null) {
      if (!currentProfile) return;

      // ğŸ”´ v4.30.0 (B5-07): ì˜ˆìˆ˜ê¸ˆ 0ì´ë©´ ê²½ê³  ìˆ¨ê¹€ (ë¯¸ì…ë ¥ ìƒíƒœ)
      const balanceInfo = BalanceManager.getBalance(currentProfile.id);
      const balanceAvailable = statusOverride?.available ?? (balanceInfo?.available || 0);
      if (balanceAvailable <= 0) {
        const banner = document.getElementById('alert-banner');
        if (banner) {
          banner.classList.add('hidden');
          document.body.style.paddingTop = '0';
        }
        return;
      }

      // v4.49.3: Today insufficient = urgent, tomorrow insufficient = warning
      const alert = statusOverride
        ? (() => {
          if (statusOverride.status === 'INSUFFICIENT') {
            return {
              show: true,
              message: `ì˜¤ëŠ˜ ë§¤ìˆ˜ ë¶€ì¡±! ë¶€ì¡±ê¸ˆì•¡: $${Math.abs(statusOverride.diff).toFixed(2)}`
            };
          }
          if (statusOverride.tomorrowStatus === 'INSUFFICIENT') {
            return {
              show: true,
              message: `ë‚´ì¼ ë§¤ìˆ˜ ë¶€ì¡±! ë¶€ì¡±ê¸ˆì•¡: $${statusOverride.tomorrowShortfall.toFixed(2)}`
            };
          }
          return { show: false };
        })()
        : BalanceManager.checkAlert(currentProfile.id);
      const banner = document.getElementById('alert-banner');

      if (alert.show) {
        document.getElementById('alert-message').textContent = alert.message;
        banner.classList.remove('hidden');
        document.body.style.paddingTop = '52px'; // Offset for fixed banner
      } else {
        banner.classList.add('hidden');
        document.body.style.paddingTop = '0';
      }
    }

    function dismissAlert() {
      document.getElementById('alert-banner').classList.add('hidden');
      document.body.style.paddingTop = '0';
    }

    // =====================================================
    // Google Sheets Sync (Phase 2B)
    // =====================================================

    // =====================================================
    // Google Sheets Sync (Simplified - Hardcoded Sheet)
    // =====================================================

    let sheetsInitialized = false;
    let sheetsInitPromise = null;  // ğŸ”´ v4.29.3: Race condition ë°©ì§€ (C-02)

    /**
     * Google Sheets ì´ˆê¸°í™” ë° ë¡œê·¸ì¸
     * ğŸ”´ v4.29.1: try/catch ì¶”ê°€ (C-01)
     * ğŸ”´ v4.29.3: Race condition ë°©ì§€ - ë™ì‹œ í˜¸ì¶œ ì‹œ ë™ì¼ Promise ë°˜í™˜ (C-02)
     * @returns {Promise<boolean>} ì„±ê³µ ì—¬ë¶€
     */
    async function initSheets() {
      // ì´ë¯¸ ì´ˆê¸°í™” ì™„ë£Œ
      if (sheetsInitialized && SheetsSync.getUserEmail()) {
        return true;
      }

      // ğŸ”´ v4.29.3: ì´ˆê¸°í™” ì§„í–‰ ì¤‘ì´ë©´ ê¸°ì¡´ Promise ë°˜í™˜ (ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€)
      if (sheetsInitPromise) {
        return sheetsInitPromise;
      }

      sheetsInitPromise = (async () => {
        try {
          await SheetsSync.init();
          await SheetsSync.signIn();
          sheetsInitialized = true;

          // ë¡œê·¸ì¸í•œ ì´ë©”ì¼ í‘œì‹œ
          const userEmail = SheetsSync.getUserEmail();
          const userEl = document.getElementById('sheets-user');
          if (userEmail && userEl) {
            userEl.textContent = userEmail;
            userEl.classList.remove('hidden');
          }

          return true;
        } catch (error) {
          console.error('initSheets error:', error);
          sheetsInitialized = false;
          showToast('Google ì—°ê²° ì‹¤íŒ¨: ' + (error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), 'error');
          throw error;
        } finally {
          sheetsInitPromise = null;  // ì™„ë£Œ í›„ ì´ˆê¸°í™”
        }
      })();

      return sheetsInitPromise;
    }

    /**
     * ì‹œíŠ¸ì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (v4.22.0: ì „ì²´ í”„ë¡œí•„ ê°€ì ¸ì˜¤ê¸°ë¡œ ë³€ê²½)
     * - ì‹œíŠ¸ì˜ ëª¨ë“  í”„ë¡œí•„ì„ ë¡œì»¬ë¡œ ê°€ì ¸ì˜´
     * - ê¸°ì¡´ ë¡œì»¬ ë°ì´í„° ë®ì–´ì“°ê¸°
     */
    async function handleSheetsPull() {
      const status = document.getElementById('sheets-status');

      try {
        status.textContent = 'í™•ì¸ ì¤‘...';
        status.className = 'text-xs text-amber-600';

        // Initialize and sign in
        await initSheets();

        // Get all my profiles from sheet
        const sheetProfiles = await SheetsSync.getMyProfilesFromSheet();

        if (sheetProfiles.length === 0) {
          showToast('ì‹œíŠ¸ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'warning');
          status.textContent = 'ë°ì´í„° ì—†ìŒ';
          status.className = 'text-xs text-gray-600';
          return;
        }

        // ğŸ”´ v4.29.4 (#22): í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ ì¶”ê°€
        const existingCount = ProfileManager.getAllProfiles().length;
        const confirmMsg = existingCount > 0
          ? `ì‹œíŠ¸ì—ì„œ ${sheetProfiles.length}ê°œ í”„ë¡œí•„ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.\n\nâš ï¸ í˜„ì¬ ë¡œì»¬ì— ${existingCount}ê°œ í”„ë¡œí•„ì´ ìˆìŠµë‹ˆë‹¤.\nì‹œíŠ¸ ë°ì´í„°ë¡œ ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?`
          : `ì‹œíŠ¸ì—ì„œ ${sheetProfiles.length}ê°œ í”„ë¡œí•„ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;

        const { confirmed } = await showAppDialog({
          title: 'ì‹œíŠ¸ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°',
          message: confirmMsg,
          confirmText: 'ë¶ˆëŸ¬ì˜¤ê¸°',
          cancelText: 'ì·¨ì†Œ',
          showCancel: true
        });

        if (!confirmed) {
          status.textContent = 'ì·¨ì†Œë¨';
          status.className = 'text-xs text-gray-600';
          return;
        }

        // ğŸ”´ v4.22.0: ëª¨ë“  í”„ë¡œí•„ ìˆœì°¨ì ìœ¼ë¡œ ê°€ì ¸ì˜¤ê¸°
        await pullAllProfiles(sheetProfiles);

      } catch (error) {
        console.error('Sheets pull error:', error);
        status.textContent = 'ì˜¤ë¥˜';
        status.className = 'text-xs text-red-600';
        showToast('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + error.message, 'error');
      }
    }

    /**
     * ğŸ”´ #242: ì²´í¬ë°•ìŠ¤ enabled ìƒíƒœ ìˆ˜ì§‘ (í”„ë¡œí•„ ì‚­ì œ ì „ í˜¸ì¶œ)
     * @returns {Object} { profileId: { symbol: false } } - disabled ì¢…ëª©ë§Œ ê¸°ë¡
     */
    function _collectEnabledStates() {
      const states = {};
      ProfileManager.getAllProfiles().forEach(p => {
        (p.stocks || []).forEach(s => {
          if (s.enabled === false) {
            if (!states[p.id]) states[p.id] = {};
            states[p.id][s.symbol] = false;
          }
        });
      });
      return states;
    }

    /**
     * ëª¨ë“  ì‹œíŠ¸ í”„ë¡œí•„ ê°€ì ¸ì˜¤ê¸° (v4.22.0)
     * - ê¸°ì¡´ ë¡œì»¬ í”„ë¡œí•„ ëª¨ë‘ ì‚­ì œ (quickStartì—ì„œ ì´ë¯¸ ì²˜ë¦¬ë¨ - ì¤‘ë³µ ë°©ì§€ìš©)
     * - ì‹œíŠ¸ í”„ë¡œí•„ì„ ìˆœì°¨ì ìœ¼ë¡œ ë¡œì»¬ì— ìƒì„±
     * - ì˜ˆìˆ˜ê¸ˆ í¬í•¨ (v3.2)
     * ğŸ”´ v4.28.2: ì‹œíŠ¸ ì›ë³¸ í”„ë¡œí•„ ID ìœ ì§€ (ID mismatch í•´ê²°)
     * ğŸ”´ v4.29.0: ê¸°ì¡´ ë°ì´í„° ì‚­ì œ í™•ì¸ ì¶”ê°€
     * ğŸ”´ #242: savedEnabledStates íŒŒë¼ë¯¸í„°ë¡œ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë³µì›
     */
    async function pullAllProfiles(sheetProfiles, savedEnabledStates) {
      const status = document.getElementById('sheets-status');
      status.textContent = 'ê°€ì ¸ì˜¤ëŠ” ì¤‘...';
      status.className = 'text-xs text-amber-600';

      // 1. ê¸°ì¡´ ë¡œì»¬ í”„ë¡œí•„ í™•ì¸ ë° ì‚­ì œ
      const existingProfiles = ProfileManager.getAllProfiles();

      // ğŸ”´ #242: ì²´í¬ë°•ìŠ¤ ìƒíƒœ ìˆ˜ì§‘ (quickStartì—ì„œ ë¯¸ë¦¬ ì „ë‹¬ë°›ì§€ ëª»í•œ ê²½ìš°)
      if (!savedEnabledStates) {
        savedEnabledStates = _collectEnabledStates();
      }

      if (existingProfiles.length > 0) {
        // #242 follow-up: deleteProfile ì œì•½(active/last profile)ìœ¼ë¡œ ì”ì¡´ ê°€ëŠ¥ì„±ì´ ìˆì–´
        // ìˆ˜ë™ pullì—ì„œë„ resetToDefaults()ë¡œ ì™„ì „ ì´ˆê¸°í™” í›„ ì‹œíŠ¸ ê¸°ì¤€ìœ¼ë¡œ ì¬ìƒì„±í•œë‹¤.
        console.log(`pullAllProfiles: Resetting ${existingProfiles.length} existing profiles`);
        ProfileManager.resetToDefaults();
      }

      // 2. ì‹œíŠ¸ í”„ë¡œí•„ì„ ìˆœì°¨ì ìœ¼ë¡œ ìƒì„±
      let firstProfileId = null;
      for (const sp of sheetProfiles) {
        // ğŸ”´ v4.28.2: ì‹œíŠ¸ì˜ ì›ë³¸ í”„ë¡œí•„ IDë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš© (createWithId)
        const newId = ProfileManager.createWithId(sp.profileId, sp.profileName, '');

        // ğŸ”´ v4.22.0: ì˜ˆìˆ˜ê¸ˆ ì €ì¥
        if (Number.isFinite(sp.balance)) {
          BalanceManager.updateBalance(newId, sp.balance);
        }

        if (sp.commissionRate !== null && sp.commissionRate !== undefined) {
          BalanceManager.updateCommissionRate(newId, sp.commissionRate);
        }

        // ì¢…ëª© ë°ì´í„° ì¶”ê°€
        // ğŸ”´ #242: ì´ì „ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë³µì›ì„ ìœ„í•´ savedEnabledStates ì°¸ì¡°
        const profileStates = savedEnabledStates[sp.profileId] || {};
        for (const stock of sp.stocks) {
          const enabled = profileStates[stock.symbol] ?? true;
          ProfileManager.addStock(newId, {
            symbol: stock.symbol,
            principal: stock.principal,
            divisions: stock.divisions || 40,
            sellPercent: stock.sellPercent,
            locSellPercent: stock.locSellPercent,
            enabled  // ğŸ”´ #242: disabled ì¢…ëª© ìƒíƒœ ë³µì›
          });

          // Daily data ì €ì¥
          // ğŸ”´ #236 (DEC-175): avgPrice ì €ì¥ ì œê±° - íŒŒìƒê°’ìœ¼ë¡œ ì „í™˜
          ProfileManager.saveDailyData(newId, stock.symbol, {
            holdings: stock.holdings,
            totalInvested: stock.totalInvested,
            currentPrice: 0
          });
        }

        const latestRevision = (sp.stocks || []).reduce((latest, stock) => {
          const rev = String(stock.revision || '');
          return rev > latest ? rev : latest;
        }, '');
        if (latestRevision && typeof SheetsSync.setRevisionCheckpoint === 'function') {
          SheetsSync.setRevisionCheckpoint(newId, latestRevision);
        }

        if (!firstProfileId) firstProfileId = newId;
      }

      // 3. ì²« ë²ˆì§¸ í”„ë¡œí•„ì„ í™œì„±í™”
      if (firstProfileId) {
        ProfileManager.setActive(firstProfileId);
        currentProfile = ProfileManager.getActive();
        SheetsSync.setCurrentProfile(firstProfileId);
      }

      // 4. UI ê°±ì‹ 
      selectedTicker = null;
      loadProfileData();
      loadBalanceData();
      updateProfileSelector();

      status.textContent = 'ì—°ê²°ë¨';
      status.className = 'text-xs text-green-600';
      showToast(`âœ… ${sheetProfiles.length}ê°œ í”„ë¡œí•„ ê°€ì ¸ì˜´`, 'success');
    }

    /**
     * íŠ¹ì • ì‹œíŠ¸ í”„ë¡œí•„ì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (v4.19.0)
     * @param {string} sheetProfileId - ì‹œíŠ¸ì— ì €ì¥ëœ í”„ë¡œí•„ ID
     */
    async function pullFromSheetProfile(sheetProfileId) {
      const status = document.getElementById('sheets-status');

      try {
        status.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
        status.className = 'text-xs text-amber-600';

        const pulled = await SheetsSync.pullFromSheetProfile(sheetProfileId);

        // ğŸ”´ selectedTicker ì´ˆê¸°í™” (ì‹œíŠ¸ ë°ì´í„°ë¡œ ë®ì–´ì”Œì›Œì§€ë¯€ë¡œ)
        selectedTicker = null;

        // Refresh UI
        currentProfile = ProfileManager.getActive();
        loadProfileData();
        loadBalanceData();
        updateProfileSelector();

        status.textContent = 'ì—°ê²°ë¨';
        status.className = 'text-xs text-green-600';
        showToast(`${pulled.length}ê°œ ì¢…ëª© ë¶ˆëŸ¬ì˜´ (from: ${sheetProfileId.split('_')[0]})`, 'success');

      } catch (error) {
        console.error('Pull from sheet profile error:', error);
        status.textContent = 'ì˜¤ë¥˜';
        status.className = 'text-xs text-red-600';
        showToast('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + error.message, 'error');
      }
    }

    /**
     * ì‹œíŠ¸ì— ë°ì´í„° ì €ì¥í•˜ê¸° (DEC-150: Dual-Key)
     */
    async function handleSheetsPush() {
      const status = document.getElementById('sheets-status');

      // ğŸ”´ v4.29.0: null guard ì¶”ê°€
      if (!currentProfile) {
        showToast('í”„ë¡œí•„ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”', 'warning');
        return;
      }

      try {
        status.textContent = 'ì €ì¥í•˜ëŠ” ì¤‘...';
        status.className = 'text-xs text-amber-600';

        // Initialize and sign in
        await initSheets();

        // Set current profile for filtering
        SheetsSync.setCurrentProfile(currentProfile.id);

        // Push data to sheet (ë‚´ êµ¬ê¸€ID + ë‚´ í”„ë¡œí•„ë§Œ ì—…ë°ì´íŠ¸)
        await SheetsSync.push();

        status.textContent = 'ì—°ê²°ë¨';
        status.className = 'text-xs text-green-600';
        // ğŸ”´ v4.29.0: ID ëŒ€ì‹  name í‘œì‹œ
        showToast(`âœ… ${currentProfile.name || 'í”„ë¡œí•„'} ì €ì¥ ì™„ë£Œ`, 'success');

      } catch (error) {
        console.error('Sheets push error:', error);
        status.textContent = 'ì˜¤ë¥˜';
        status.className = 'text-xs text-red-600';
        showToast('ì €ì¥ ì‹¤íŒ¨: ' + error.message, 'error');
      }
    }

    /**
     * ğŸ”´ v4.29.1: ë¡œê·¸ì•„ì›ƒ ê¸°ëŠ¥ ì¶”ê°€ (#20)
     * - Google ë¡œê·¸ì•„ì›ƒ
     * - UI ì´ˆê¸°í™”
     * - ì‹œì‘ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°
     */
    async function handleSignOut() {
      // ğŸ”´ v4.29.2: Sheet = SSOT â†’ ë¡œê·¸ì•„ì›ƒ ì‹œ ë¡œì»¬ ë°ì´í„°ë„ ì‚­ì œ
      const { confirmed } = await showAppDialog({
        title: 'ë¡œê·¸ì•„ì›ƒ',
        message: 'ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\në¡œì»¬ ë°ì´í„°ê°€ ì‚­ì œë˜ë©°, ë‹¤ìŒ ë¡œê·¸ì¸ ì‹œ ì‹œíŠ¸ì—ì„œ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.',
        confirmText: 'ë¡œê·¸ì•„ì›ƒ',
        cancelText: 'ì·¨ì†Œ',
        showCancel: true
      });
      if (!confirmed) {
        return;
      }

      try {
        // 1. Google ë¡œê·¸ì•„ì›ƒ
        SheetsSync.signOut();
        sheetsInitialized = false;
        sheetsInitPromise = null;

        // 2. ğŸ”´ v4.29.2: ë¡œì»¬ ë°ì´í„° í´ë¦¬ì–´ (SSOT ì›ì¹™)
        ProfileManager.resetToDefaults();
        currentProfile = null;
        selectedTicker = null;
        enabledTickers.clear();
        calculationResults = {};
        lastCalculation = null;

        // 3. UI ì´ˆê¸°í™”
        const userEl = document.getElementById('sheets-user');
        const statusEl = document.getElementById('sheets-status');
        const logoutBtn = document.getElementById('logout-btn');

        if (userEl) userEl.textContent = 'ë¯¸ì—°ê²°';
        if (statusEl) {
          statusEl.textContent = 'ì˜¤í”„ë¼ì¸';
          statusEl.className = 'text-xs px-2 py-0.5 rounded-full bg-gray-200 text-gray-600';
        }
        if (logoutBtn) logoutBtn.classList.add('hidden');

        // 4. ì‹œì‘ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°
        showStartScreen();
        showToast('ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ', 'success');

      } catch (error) {
        console.error('Sign out error:', error);
        showToast('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨', 'error');
      }
    }
  </script>

</body>
</html>
