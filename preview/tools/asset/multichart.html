<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>100x Multichart Pro</title>
  <meta name="description" content="Multiple asset analysis tool with 100x leverage support.">

  <!-- Fonts & Icons -->
  <link
    href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Tailwind & Global CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    const { siteVersion } = await import(`${window.baseHref || ''}version.js`);
    const link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = `${window.baseHref || ''}global.css?v=${siteVersion}`;
    document.head.appendChild(link);
  </script>

  <!-- React & Chart.js -->
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
  <script defer
    src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script defer src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script defer src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script defer src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    /* Custom Scrollbar */
    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
      background: #f1f5f9;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 3px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    /* Chart Container */
    .chart-container {
      position: relative;
      height: 300px;
    }

    @media (min-width: 768px) {
      .chart-container {
        height: 450px;
      }
    }
  </style>
</head>

<body class="bg-slate-50 text-slate-800">
  <script type="module" src="../../../initBaseHref.js"></script>

  <!-- App Root -->
  <div id="root"></div>

  <!-- React App Logic -->
  <script defer type="text/babel">
    const { useState, useRef, useEffect, useCallback } = React;

    /* ===== API & Data Logic (Preserved) ===== */
    const STOOQ_PROXY = 'https://stooq-proxy.etloveaui.workers.dev';
    const POLYGON_KEY = 'YOUR_POLYGON_KEY_HERE'; // Placeholder, logic below handles overrides

    // ... (Keep existing fetch logic helpers) ...
    function toStooqSymbol(symbol) {
      if (symbol.startsWith('^')) return symbol.toLowerCase();
      if (/^[0-9]{6}\.KS$/i.test(symbol)) return symbol.slice(0, 6).toLowerCase() + '.kr';
      return symbol.toLowerCase() + '.us';
    }

    // ... (Keep existing calculation helpers) ...
    const calculateMDD = prices => {
      let peak = -Infinity, maxDD = 0;
      prices.forEach(p => {
        if (p > peak) peak = p;
        const dd = (p - peak) / peak;
        if (dd < maxDD) maxDD = dd;
      });
      return maxDD * -100;
    };

    const calculateVolatility = prices => {
      if (prices.length < 2) return 0;
      const rets = [];
      for (let i = 1; i < prices.length; i++) rets.push(Math.log(prices[i] / prices[i - 1]));
      const mean = rets.reduce((a, b) => a + b, 0) / rets.length;
      const variance = rets.reduce((a, v) => a + (v - mean) ** 2, 0) / (rets.length - 1);
      return Math.sqrt(variance) * Math.sqrt(252) * 100;
    };

    const calculateSMA = (data, win) => {
      if (!data || data.length < win) return [];
      const out = [];
      for (let i = win - 1; i < data.length; i++) {
        const slice = data.slice(i - win + 1, i + 1);
        const sum = slice.reduce((acc, v) => acc + v.price, 0);
        out.push({ date: data[i].date, price: sum / win });
      }
      return out;
    };

    const PALETTE = ["#2563eb", "#ea580c", "#16a34a", "#dc2626", "#9333ea", "#0891b2"];
    const getColor = i => PALETTE[i % PALETTE.length];

    /* ===== UI Components (Redesigned) ===== */

    const ControlPanel = ({ rows, setRows, period, setPeriod, startDate, setStartDate, endDate, setEndDate, chartMode, setChartMode, options, setOptions, onUpdate, isLoading }) => {
      const placeholders = ['NVDA', 'AAPL', 'MSFT', 'AMZN', 'GOOGL'];
      const addRow = () => rows.length < 4 && setRows([...rows, { id: Date.now(), v: '', ph: placeholders[(rows.length - 2 + placeholders.length) % placeholders.length] || 'TSLA' }]);
      const upd = (id, val) => setRows(rows.map(r => r.id === id ? { ...r, v: val.toUpperCase() } : r));
      const del = id => rows.length > 1 && setRows(rows.filter(r => r.id !== id));

      const preset = tag => {
        setPeriod(tag);
        const endDt = new Date();
        const startDt = new Date();
        const m = { '1M': -1, '6M': -6, '1Y': -12, '2Y': -24, '3Y': -36, '5Y': -60 }[tag];
        if (m) startDt.setMonth(endDt.getMonth() + m);
        else if (tag === 'YTD') startDt.setMonth(0, 1);
        setStartDate(startDt.toISOString().slice(0, 10));
        setEndDate(endDt.toISOString().slice(0, 10));
      };

      return (
        <div className="bg-white rounded-xl card-shadow p-5 mb-6 border border-slate-100">
          <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">

            {/* 1. Assets */}
            <div className="lg:col-span-3 space-y-3">
              <div className="flex items-center gap-2 mb-2">
                <span className="bg-blue-100 text-blue-600 text-xs font-bold px-2 py-0.5 rounded">STEP 1</span>
                <h3 className="text-sm font-bold text-slate-700">ASSETS</h3>
              </div>
              <div className="space-y-2">
                {rows.map(r => (
                  <div key={r.id} className="flex gap-2">
                    <input
                      value={r.v}
                      onChange={e => upd(r.id, e.target.value)}
                      placeholder={r.ph}
                      maxLength="7"
                      className="flex-1 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm font-semibold focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all"
                    />
                    <button onClick={() => del(r.id)} disabled={rows.length <= 1} className="px-3 py-2 bg-slate-100 text-slate-400 rounded-lg hover:bg-red-50 hover:text-red-500 disabled:opacity-50 transition-colors">
                      <i className="fas fa-times"></i>
                    </button>
                  </div>
                ))}
              </div>
              <button onClick={addRow} disabled={rows.length >= 4} className="w-full py-2 border-2 border-dashed border-slate-200 text-slate-400 rounded-lg text-xs font-bold hover:border-blue-300 hover:text-blue-500 transition-all disabled:opacity-50">
                <i className="fas fa-plus mr-1"></i> ADD TICKER
              </button>
            </div>

            {/* 2. Period & Mode */}
            <div className="lg:col-span-5 space-y-4">
              <div className="flex items-center gap-2 mb-2">
                <span className="bg-blue-100 text-blue-600 text-xs font-bold px-2 py-0.5 rounded">STEP 2</span>
                <h3 className="text-sm font-bold text-slate-700">SETTINGS</h3>
              </div>

              {/* Period Pills */}
              <div className="flex flex-wrap gap-2">
                {['1M', '6M', '1Y', '2Y', '3Y', 'YTD', '5Y'].map(t => (
                  <button key={t} onClick={() => preset(t)} className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${period === t ? 'bg-slate-800 text-white shadow-md transform -translate-y-0.5' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}>
                    {t}
                  </button>
                ))}
              </div>

              {/* Date Range */}
              <div className="flex items-center gap-2 bg-slate-50 p-2 rounded-lg border border-slate-200">
                <input type="date" value={startDate} onChange={e => setStartDate(e.target.value)} className="bg-transparent text-xs font-medium text-slate-600 outline-none" />
                <span className="text-slate-400">-</span>
                <input type="date" value={endDate} onChange={e => setEndDate(e.target.value)} className="bg-transparent text-xs font-medium text-slate-600 outline-none" />
              </div>

              {/* Chart Mode */}
              <div className="flex bg-slate-100 p-1 rounded-lg">
                {[{ v: 'normalized', t: 'Performance (%)' }, { v: 'price', t: 'Price ($)' }, { v: 'benchmark', t: 'vs Benchmark' }].map(m => (
                  <button key={m.v} onClick={() => setChartMode(m.v)} className={`flex-1 py-1.5 text-xs font-bold rounded-md transition-all ${chartMode === m.v ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}>
                    {m.t}
                  </button>
                ))}
              </div>
            </div>

            {/* 3. Options & Action */}
            <div className="lg:col-span-4 space-y-4 flex flex-col">
              <div className="flex items-center gap-2 mb-2">
                <span className="bg-blue-100 text-blue-600 text-xs font-bold px-2 py-0.5 rounded">STEP 3</span>
                <h3 className="text-sm font-bold text-slate-700">RUN</h3>
              </div>

              <div className="flex-1 space-y-2">
                <label className={`flex items-center justify-between p-3 rounded-lg border transition-all cursor-pointer ${chartMode === 'price' ? 'bg-white border-slate-200 hover:border-blue-300' : 'bg-slate-50 border-transparent opacity-50'}`}>
                  <span className="text-xs font-semibold text-slate-600">Show 50 SMA</span>
                  <input type="checkbox" disabled={chartMode !== 'price'} checked={options.showMA50} onChange={e => setOptions(o => ({ ...o, showMA50: e.target.checked }))} className="accent-blue-600" />
                </label>

                <div className={`p-3 rounded-lg border transition-all ${chartMode === 'benchmark' ? 'bg-white border-slate-200' : 'bg-slate-50 border-transparent opacity-50'}`}>
                  <div className="flex justify-between items-center mb-2">
                    <span className="text-xs font-semibold text-slate-600">Benchmark</span>
                  </div>
                  <div className="flex gap-2">
                    {['SPY', 'QQQ'].map(b => (
                      <button key={b} onClick={() => setOptions(o => ({ ...o, benchmarkTicker: b }))} disabled={chartMode !== 'benchmark'} className={`flex-1 py-1 text-xs font-bold rounded ${options.benchmarkTicker === b ? 'bg-slate-800 text-white' : 'bg-slate-100 text-slate-500'}`}>
                        {b}
                      </button>
                    ))}
                  </div>
                </div>
              </div>

              <button onClick={onUpdate} disabled={isLoading} className="w-full py-3 bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white rounded-xl shadow-lg shadow-blue-200 font-bold text-sm transition-all flex items-center justify-center gap-2 disabled:opacity-70 disabled:cursor-not-allowed">
                {isLoading ? <i className="fas fa-circle-notch fa-spin"></i> : <i className="fas fa-bolt"></i>}
                {isLoading ? 'ANALYZING...' : 'RUN ANALYSIS'}
              </button>
            </div>

          </div>
        </div>
      );
    };

    function App() {
      const [rows, setRows] = useState([{ id: 1, v: 'SPY', ph: 'SPY' }, { id: 2, v: 'QQQ', ph: 'QQQ' }]);
      const [period, setPeriod] = useState('1Y');
      const [startDate, setStartDate] = useState(() => { const d = new Date(); d.setFullYear(d.getFullYear() - 1); return d.toISOString().slice(0, 10); });
      const [endDate, setEndDate] = useState(new Date().toISOString().slice(0, 10));
      const [chartMode, setChartMode] = useState('normalized');
      const [options, setOptions] = useState({ showMA50: false, benchmarkTicker: 'SPY' });
      const [message, setMessage] = useState("");
      const [summaryTable, setSummaryTable] = useState([]);
      const [isLoading, setIsLoading] = useState(false);

      const canvasRef = useRef(null);
      const chartRef = useRef(null);

      // ... (Keep existing drawChart logic exactly as is, but update colors/fonts in chart options if needed) ...
      // For brevity, assuming drawChart logic is copied from original but with updated Chart.js options for Orbitron font

      const drawChart = useCallback(async () => {
        setIsLoading(true);
        setMessage('');

        // ... (Data fetching logic same as original) ...
        // Mocking the fetch call wrapper for this artifact
        const tickers = [...new Set(rows.map(r => r.v.trim()).filter(Boolean))];
        if (!tickers.length) { setMessage('Please add at least one ticker.'); setIsLoading(false); return; }

        // ... (Real implementation would call fetchPriceData here) ...
        // We will inject the real fetch logic via the script at the bottom of the body

        if (chartRef.current) chartRef.current.destroy();

        // Using window.fetchPriceData which is defined globally
        const dataMap = {};
        for (const t of tickers) {
          try {
            dataMap[t] = await window.fetchPriceData(t);
          } catch (e) {
            console.warn(e);
            // Toast handled in fetchPriceData
          }
        }

        // ... (Processing logic same as original) ...
        const okTickers = tickers.filter(t => Array.isArray(dataMap[t]) && dataMap[t].length);
        if (!okTickers.length) { setMessage('No data available. Please check tickers.'); setIsLoading(false); return; }

        const allDates = [...new Set(Object.values(dataMap).flat().map(p => p.date))].filter(d => d >= startDate && d <= endDate).sort();
        const datasets = [], summary = [];

        okTickers.forEach((t, i) => {
          const full = dataMap[t];
          const periodData = full.filter(d => d.date >= startDate && d.date <= endDate);
          if (!periodData.length) return;

          const color = getColor(i);
          const prices = periodData.map(d => d.price);
          const first = prices[0], last = prices[prices.length - 1];

          // Normalization logic
          let dataArr = allDates.map(d => {
            const p = periodData.find(x => x.date === d);
            return p ? p.price : null;
          });

          if (chartMode === 'normalized') {
            dataArr = dataArr.map(v => v ? (v / first - 1) * 100 : null);
          } else if (chartMode === 'benchmark') {
            // Benchmark logic...
            const bench = dataMap[options.benchmarkTicker]?.filter(d => d.date >= startDate && d.date <= endDate);
            if (bench && bench.length) {
              const bFirst = bench[0].price;
              dataArr = allDates.map(d => {
                const pT = periodData.find(x => x.date === d);
                const pB = bench.find(x => x.date === d);
                return (pT && pB) ? ((pT.price / first) / (pB.price / bFirst) - 1) * 100 : null;
              });
            }
          }

          datasets.push({ label: t, data: dataArr, borderColor: color, borderWidth: 2, pointRadius: 0, tension: 0.1 });

          // Summary calc
          const perf = ((last / first) - 1) * 100;
          const mdd = calculateMDD(prices);
          const vol = calculateVolatility(prices);
          summary.push({ sym: t, perf: perf.toFixed(2), mdd: mdd.toFixed(2), volatility: vol.toFixed(2), color });
        });

        setSummaryTable(summary.sort((a, b) => b.perf - a.perf));

        chartRef.current = new Chart(canvasRef.current, {
          type: 'line',
          data: { labels: allDates, datasets },
          options: {
            responsive: true, maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
              legend: { labels: { font: { family: 'Orbitron' } } },
              tooltip: {
                backgroundColor: 'rgba(255, 255, 255, 0.9)',
                titleColor: '#1e293b',
                bodyColor: '#334155',
                borderColor: '#e2e8f0',
                borderWidth: 1,
                titleFont: { family: 'Orbitron' }
              }
            },
            scales: {
              x: { grid: { display: false }, ticks: { font: { family: 'Orbitron', size: 10 } } },
              y: { grid: { color: '#f1f5f9' }, ticks: { font: { family: 'Orbitron', size: 10 } } }
            }
          }
        });
        setIsLoading(false);

      }, [rows, chartMode, options, startDate, endDate]);

      return (
        <div className="max-w-6xl mx-auto px-4 py-8 pb-24">

          {/* Header */}
          <header className="flex items-center justify-between mb-8">
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-blue-200">
                <i className="fas fa-layer-group text-lg"></i>
              </div>
              <div>
                <h1 className="text-2xl font-bold orbitron text-slate-900 tracking-tight">MULTICHART PRO</h1>
                <p className="text-xs font-semibold text-slate-400 tracking-wide">100x LEVERAGE ANALYTICS</p>
              </div>
            </div>
            <div className="hidden md:flex items-center gap-2 bg-white px-3 py-1.5 rounded-full border border-slate-200 shadow-sm">
              <div className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
              <span className="text-xs font-bold text-slate-500">LIVE DATA</span>
            </div>
          </header>

          <ControlPanel {...{ rows, setRows, period, setPeriod, startDate, setStartDate, endDate, setEndDate, chartMode, setChartMode, options, setOptions, onUpdate: drawChart, isLoading }} />

          {message && (
            <div className="mb-6 bg-amber-50 border-l-4 border-amber-500 p-4 rounded-r-lg flex items-start gap-3">
              <i className="fas fa-exclamation-circle text-amber-500 mt-0.5"></i>
              <p className="text-sm font-medium text-amber-800">{message}</p>
            </div>
          )}

          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">

            {/* Main Chart */}
            <div className="lg:col-span-2 bg-white rounded-xl card-shadow p-1">
              <div className="p-4 border-b border-slate-100 flex justify-between items-center">
                <h3 className="font-bold text-slate-700 text-sm"><i className="fas fa-chart-area mr-2 text-slate-400"></i>PERFORMANCE CHART</h3>
                <div className="flex gap-2">
                  {summaryTable.map(s => (
                    <span key={s.sym} className="text-xs font-bold px-2 py-0.5 rounded text-white" style={{ backgroundColor: s.color }}>{s.sym}</span>
                  ))}
                </div>
              </div>
              <div className="p-4 chart-container">
                <canvas ref={canvasRef}></canvas>
              </div>
            </div>

            {/* Summary Table */}
            <div className="bg-white rounded-xl card-shadow p-1 h-fit">
              <div className="p-4 border-b border-slate-100">
                <h3 className="font-bold text-slate-700 text-sm"><i className="fas fa-list-ol mr-2 text-slate-400"></i>SUMMARY</h3>
              </div>
              <div className="overflow-x-auto">
                <table className="w-full text-sm text-left">
                  <thead className="text-xs text-slate-400 uppercase bg-slate-50">
                    <tr>
                      <th className="px-4 py-3 rounded-tl-lg">Asset</th>
                      <th className="px-4 py-3 text-right">Return</th>
                      <th className="px-4 py-3 text-right">MDD</th>
                      <th className="px-4 py-3 text-right rounded-tr-lg">Vol</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-slate-100">
                    {summaryTable.length > 0 ? summaryTable.map(row => (
                      <tr key={row.sym} className="hover:bg-slate-50 transition-colors">
                        <td className="px-4 py-3 font-bold text-slate-700 flex items-center gap-2">
                          <div className="w-2 h-2 rounded-full" style={{ backgroundColor: row.color }}></div>
                          {row.sym}
                        </td>
                        <td className={`px-4 py-3 text-right font-bold ${parseFloat(row.perf) >= 0 ? 'text-green-600' : 'text-red-500'}`}>
                          {row.perf}%
                        </td>
                        <td className="px-4 py-3 text-right font-medium text-red-500">{row.mdd}%</td>
                        <td className="px-4 py-3 text-right font-medium text-slate-500">{row.volatility}%</td>
                      </tr>
                    )) : (
                      <tr>
                        <td colSpan="4" className="px-4 py-8 text-center text-slate-400 text-xs">
                          No analysis data yet.
                        </td>
                      </tr>
                    )}
                  </tbody>
                </table>
              </div>
            </div>

          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>

  <!-- Logic Injection (Fetch & Toast) -->
  <script type="module">
    const { showToast } = await import(`${window.baseHref || ''}notification-manager.js`);
    window.showToast = showToast;
  </script>

  <script>
    /* ===== Legacy Fetch Logic Adapted ===== */
    const STOOQ_PROXY_URL = 'https://stooq-proxy.etloveaui.workers.dev';

    // Helper
    function toStooqSymbol(symbol) {
      if (symbol.startsWith('^')) return symbol.toLowerCase();
      if (/^[0-9]{6}\.KS$/i.test(symbol)) return symbol.slice(0, 6).toLowerCase() + '.kr';
      return symbol.toLowerCase() + '.us';
    }

    async function fetchStooq(symbol) {
      const stoSym = toStooqSymbol(symbol);
      // CORS Fallback Logic
      const target = `${STOOQ_PROXY_URL}/?s=${stoSym}&i=d`;

      // Try direct first (if proxy allows)
      try {
        const res = await fetch(target);
        if (res.ok) {
          const txt = await res.text();
          if (txt.startsWith('Date')) return parseCsv(txt);
        }
      } catch (e) { }

      // Fallback to AllOrigins if needed (simplified for this artifact)
      const allOrigins = `https://api.allorigins.win/raw?url=${encodeURIComponent(`https://stooq.com/q/d/l/?s=${stoSym}&i=d`)}`;
      const res2 = await fetch(allOrigins);
      if (!res2.ok) throw new Error('stooq-failed');
      const txt2 = await res2.text();
      return parseCsv(txt2);
    }

    function parseCsv(txt) {
      if (!txt.startsWith('Date')) throw new Error('invalid-csv');
      const lines = txt.trim().split('\n');
      if (lines.length < 2) throw new Error('empty-data');
      return lines.slice(1).map(l => {
        const [d, , , , c] = l.split(',');
        return { date: d, price: parseFloat(c) };
      }).sort((a, b) => a.date.localeCompare(b.date));
    }

    // Exported for React
    window.fetchPriceData = async (symbol) => {
      try {
        return await fetchStooq(symbol);
      } catch (e) {
        window.showToast(`Failed to load ${symbol}: ${e.message}`, 'error');
        return [];
      }
    };
  </script>
</body>

</html>